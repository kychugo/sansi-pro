<!DOCTYPE html>
<html lang="zh">
<head>

<meta http-equiv="Content-Security-Policy" content="
default-src 'self';
script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://cubism.live2d.com https://*.streamable.com https://cdn.heapanalytics.com https://www.gstatic.com https://apis.google.com https://cdn.onesignal.com https://onesignal.com https://api.onesignal.com https://*.firebaseio.com https://cdn.jsdelivr.net;
style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com https://onesignal.com;
font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com;
img-src 'self' https: data: blob: https://*.streamable.com https://heapanalytics.com https://*.googleusercontent.com;
media-src 'self' https://youfulca.com https://*.streamable.com https://assets.mixkit.co https://taira-komori.net;
connect-src 'self' https://script.google.com https://script.googleusercontent.com https://sansi.vercel.app https://sansi.kenchan20151.workers.dev https://corsproxy.io https://docs.google.com https://*.googleusercontent.com https://v1.hitokoto.cn https://chatapi.akash.network https://text.pollinations.ai https://gen.pollinations.ai https://router.huggingface.co https://api.llm7.io https://*.streamable.com https://cdn.jsdelivr.net https://api-fawn-chi.vercel.app https://heapanalytics.com https://*.firebaseio.com wss://*.firebaseio.com https://www.gstatic.com https://www.googleapis.com https://securetoken.googleapis.com https://identitytoolkit.googleapis.com https://cdn.onesignal.com https://onesignal.com https://onesignal.com/api/v1/notifications https://api.onesignal.com https://cdnjs.cloudflare.com data: blob: https://huggingface.co https://*.huggingface.co https://*.supabase.co https://cdn-lfs.huggingface.co https://*.hf.co;
worker-src 'self' blob:;
frame-src 'self' https://streamable.com https://kenchan20141.pyscriptapps.com https://kenchan20141.github.io https://sansi.vercel.app https://lyricschi.vercel.app https://penpalchi.vercel.app https://litstudy.vercel.app https://621d05f47d591.site123.me https://script.google.com https://www.i2ocr.com https://*.firebaseapp.com https://onesignal.com;
object-src 'none';
base-uri 'self';
form-action 'self';
">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¥æ€</title>

<!-- æ·»åŠ åˆ°ä¸»ç•«é¢è¨­å®š -->
<meta name="application-name" content="ç¥æ€">
<meta name="apple-mobile-web-app-title" content="ç¥æ€">
<link rel="manifest" href="manifest.json">


<link rel="apple-touch-icon" href="ç¥æ€åœ–æ¨™.png">


<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">


<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">


<!-- Android åœ–ç¤º -->
<link rel="icon" sizes="192x192" href="ç¥æ€åœ–æ¨™.png">

<link rel="icon" sizes="144x144" href="ç¥æ€åœ–æ¨™.png">

<link rel="icon" sizes="96x96" href="ç¥æ€åœ–æ¨™.png">


<!-- iOS åœ–ç¤º -->
<link rel="apple-touch-icon" sizes="180x180" href="ç¥æ€åœ–æ¨™.png">

<link rel="apple-touch-icon" sizes="152x152" href="ç¥æ€åœ–æ¨™.png">

<link rel="apple-touch-icon" sizes="120x120" href="ç¥æ€åœ–æ¨™.png">




	
<!-- å¼•å…¥ Chart.js ä»¥ç¹ªè£½é›·é”åœ– -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<!-- æ–°å¢é€™è¡Œï¼šFirebase Authentication -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<!-- 1. PixiJS (æ¸²æŸ“å¼•æ“) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.8/browser/pixi.min.js"></script>

<!-- 2. Live2D Cubism Core (å®˜æ–¹æ ¸å¿ƒåº« - é€™æ˜¯é—œéµ) -->
<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>

<!-- 3. Pixi Live2D Plugin (Cubism 4 å°ˆç”¨ç‰ˆ - é€™æ˜¯é—œéµ) -->
<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>






	<script>



		
// ==========================================
// === å…¨åŸŸè®Šæ•¸å®£å‘Š (è«‹åŠ åœ¨ script æœ€ä¸Šæ–¹) ===
// ==========================================
let lastGeneratedTimestamp = null; // ç”¨æ–¼è¿½è¹¤ç•¶å‰æ­£åœ¨æ“ä½œçš„ç´€éŒ„æ™‚é–“æˆ³

		
// =======================================================
// === [å®‰å…¨ç‰ˆ] å…¨åŸŸå®‰å…¨ç¶²ï¼šæ””æˆªæ¬Šé™éŒ¯èª¤ä¸¦ä¿è­·ç´€éŒ„ ===
// =======================================================
window.addEventListener('unhandledrejection', function(event) {
    // åµæ¸¬éŒ¯èª¤è¨Šæ¯ä¸­æ˜¯å¦åŒ…å«é—œéµå­—
    if (event.reason && (
        (event.reason.code === 'PERMISSION_DENIED') || 
        (event.reason.message && event.reason.message.includes('permission_denied'))
    )) {
        console.warn("ğŸš¨ åµæ¸¬åˆ°æš«æ™‚æ€§æ¬Šé™è¨Šè™Ÿ (å·²å¿½ç•¥ï¼Œç­‰å¾…ç³»çµ±è‡ªå‹•åˆ·æ–° Token)"); // å°‡ error æ”¹ç‚º warnï¼Œä¸¦ä¿®æ”¹æ–‡å­—
        event.preventDefault(); // é˜»æ­¢éŒ¯èª¤ç¹¼çºŒæ“´æ•£
        
        // â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šè¨»è§£æ‰ä¸‹é¢é€™ä¸€è¡Œï¼Œé˜²æ­¢é›»è…¦å–šé†’æ™‚è‡ªå‹•ç™»å‡º â˜…â˜…â˜…
        // forceLogoutAndKeepHistory();  
    }
});

// å°ˆé–€è™•ç†å¼·åˆ¶ç™»å‡ºçš„å‡½å¼
function forceLogoutAndKeepHistory() {
    // 1. é˜²æ­¢çŸ­æ™‚é–“å…§é‡è¤‡è§¸ç™¼
    if (sessionStorage.getItem('is_force_logging_out')) return;
    sessionStorage.setItem('is_force_logging_out', 'true');

    // 2. åœæ­¢æ‰€æœ‰ Firebase ç›£è½ (åœæ­¢å ±éŒ¯)
    if (typeof database !== 'undefined') {
        try { database.ref().off(); } catch(e){}
    }

    // 3. â˜…â˜…â˜… é—œéµï¼šåªæ¸…é™¤èº«ä»½è³‡æ–™ï¼Œä¸ç¢°æ­·å²ç´€éŒ„ â˜…â˜…â˜…
    // åˆªé™¤å£æ‰çš„èº«ä»½æª”
    localStorage.removeItem('studentProfile'); 
    // åˆªé™¤é€šçŸ¥ç·©å­˜ (é¿å…ç´…é»é¡¯ç¤ºéŒ¯èª¤)
    localStorage.removeItem('sansi_read_notifications'); 
    
    // æ³¨æ„ï¼šæˆ‘å€‘ã€æ²’æœ‰ã€‘åŸ·è¡Œ indexedDB.deleteDatabase()
    // æ‰€ä»¥ç”Ÿæˆç´€éŒ„ (IndexedDB) æœƒå®Œæ•´ä¿ç•™åœ¨ç€è¦½å™¨ä¸­

    // 4. å¼·åˆ¶ Firebase ç™»å‡º
    if (typeof auth !== 'undefined') auth.signOut();

    // 5. æç¤ºä½¿ç”¨è€…ä¸¦é‡æ•´
    alert("âš ï¸ é€£ç·šæ†‘è­‰å·²éæœŸã€‚\n\nç³»çµ±å·²è‡ªå‹•ç‚ºæ‚¨ç™»å‡ºä»¥ä¿®å¾©é€£ç·šã€‚\næ‚¨çš„æ­·å²ç´€éŒ„å·²å®‰å…¨ä¿ç•™ï¼Œè«‹é‡æ–°ç™»å…¥å³å¯ã€‚");
    
    // 6. é‡‹æ”¾é–å®šä¸¦é‡æ•´é é¢ (é€™æ˜¯åœæ­¢æ­»å¾ªç’°æœ€æœ‰æ•ˆçš„æ–¹æ³•)
    sessionStorage.removeItem('is_force_logging_out');
    window.location.reload();
}

		
// === 1. Firebase åˆå§‹åŒ– (å¿…é ˆæ”¾åœ¨æœ€é ‚éƒ¨) ===
const firebaseConfig = {
  apiKey: "AIzaSyBgwrgn2m343mRJb0WjzUhteiospegXhvI",
  authDomain: "sansidata.firebaseapp.com",
  projectId: "sansidata",
  storageBucket: "sansidata.firebasestorage.app",
  messagingSenderId: "580288358575",
  appId: "1:580288358575:web:35dcf4e79bcef530de4c5a",
  databaseURL: "https://sansidata-default-rtdb.firebaseio.com" 
};

// å®£å‘Šå…¨åŸŸè®Šæ•¸
let database, auth;

// ç¢ºä¿åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¸¦ç«‹å³è³¦å€¼
if (typeof firebase !== 'undefined' && !firebase.apps.length) {
    try {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase åˆå§‹åŒ–æˆåŠŸï¼");
        database = firebase.database();
        auth = firebase.auth();
    } catch (e) {
        console.error("Firebase åˆå§‹åŒ–å¤±æ•—ï¼š", e);
    }
} else if (typeof firebase !== 'undefined' && firebase.apps.length) {
    database = firebase.database();
    auth = firebase.auth();
}
</script>






	<!-- Supabase å®¢æˆ¶ç«¯ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Transformers.js (ç”¨æ–¼åœ¨ç€è¦½å™¨ç”¢ç”Ÿå‘é‡ï¼Œç„¡éœ€ API è²»ç”¨) -->
<script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0';
    // å°‡ pipeline æ›è¼‰åˆ° window ä»¥ä¾¿å…¨åŸŸä½¿ç”¨
    window.pipeline = pipeline;
</script>

	<script>
		
// === Supabase è¨­å®š ===
// è«‹åœ¨ Supabase å¾Œå° Settings -> API æ‰¾åˆ°é€™å…©å€‹å€¼
const SUPABASE_URL = 'https://vgoisaswgjpdwsikvipx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnb2lzYXN3Z2pwZHdzaWt2aXB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4Mzg0ODMsImV4cCI6MjA4NTQxNDQ4M30._sMGcMMApSyzdCaXzAlF9hCc8mkgxz_28IbTrXpFnyA'; // æ³¨æ„æ˜¯ anon keyï¼Œä¸æ˜¯ service_role
  // â˜… æ”¹åç‚º supabaseClient ä»¥å…è¡çª
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // åˆå§‹åŒ–å‘é‡æ¨¡å‹
  let embeddingExtractor = null;
 // åˆå§‹åŒ–å‘é‡æ¨¡å‹
  async function initEmbeddingModel() {
      if (!window.pipeline) {
          console.log("ç­‰å¾… Transformers åº«è¼‰å…¥...");
          await new Promise(r => setTimeout(r, 500));
      }

      if (!embeddingExtractor) {
          console.log("ğŸ“¥ [RAG] æ­£åœ¨ä¸‹è¼‰/è¼‰å…¥å‘é‡æ¨¡å‹...");
          
          // â˜…â˜…â˜… æ–°å¢é€™å…©è¡Œï¼šå¼·åˆ¶è¨­å®šä¸ä½¿ç”¨æœ¬åœ°å¿«å–è·¯å¾‘ï¼Œæ”¹ç”¨ CDN â˜…â˜…â˜…
          window.pipeline.env.allowLocalModels = false;
          window.pipeline.env.useBrowserCache = true;

          // ä½¿ç”¨ pipeline å»ºç«‹ç‰¹å¾µæå–å™¨
          embeddingExtractor = await window.pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');
          console.log("âœ… [RAG] å‘é‡æ¨¡å‹å°±ç·’");
      }
  }

  // å°‡æ–‡å­—è½‰ç‚ºå‘é‡çš„å‡½å¼
  async function getEmbedding(text) {
      await initEmbeddingModel();
      const output = await embeddingExtractor(text, { pooling: 'mean', normalize: true });
      return Array.from(output.data);
  }
  
  // æœå°‹ç›¸ä¼¼ç¯„æ–‡çš„å‡½å¼
// === RAG æœå°‹æ ¸å¿ƒå‡½æ•¸ (æ”¯æ´é¡å‹éæ¿¾ç‰ˆ) ===
// targetType: 'narrative' (æ•˜äº‹) æˆ– 'argument' (è­°è«–)
// === RAG æœå°‹æ ¸å¿ƒå‡½æ•¸ (å‡ç´šç‰ˆï¼šæŠ“å– 3 ç¯‡ + æ ¼å¼åŒ–) ===
// === RAG æœå°‹æ ¸å¿ƒå‡½æ•¸ (å‡ç´šç‰ˆï¼šè©³ç´° Log + æŠ“å– 3 ç¯‡ + æ ¼å¼åŒ–) ===
async function searchSimilarEssays(studentText, targetType) {
    console.log(`%cğŸ” [RAG] æ­£åœ¨å•Ÿå‹•å‘é‡æœå°‹ (é¡å‹: ${targetType})...`, "color: yellow");
    
    try {
        if (typeof supabaseClient === 'undefined') {
            console.error("âŒ [RAG] Supabase Client æœªå®šç¾©ï¼Œç„¡æ³•æœå°‹ã€‚");
            return "";
        }

        // 1. å‹•æ…‹åŒ¯å…¥ Transformers.js
        const { pipeline, env } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0');
        
        // è¨­å®šå¿«å–ç­–ç•¥ï¼Œç¢ºä¿ä¸‹è¼‰ä¸€æ¬¡å¾Œä¸ç”¨å†ä¸‹è¼‰
        env.allowLocalModels = false;
        env.useBrowserCache = true;

        // 2. åˆå§‹åŒ–/è¼‰å…¥æ¨¡å‹ (åŠ å…¥é€²åº¦ç›£è½)
        // é€™è£¡æœƒæª¢æŸ¥å¿«å–ï¼Œå¦‚æœæ²’æœ‰å¿«å–ï¼Œå°±æœƒé–‹å§‹ä¸‹è¼‰ä¸¦è§¸ç™¼ callback
        const extractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', {
            progress_callback: (data) => {
                // åªåœ¨ä¸‹è¼‰é€²è¡Œä¸­é¡¯ç¤ºï¼Œé¿å…æ´—ç‰ˆ
                if (data.status === 'initiate') {
                    console.log(`â¬‡ï¸ [RAG] æ­£åœ¨ä¸‹è¼‰æ¨¡å‹çµ„ä»¶: ${data.file}`);
                } else if (data.status === 'progress') {
                    // ç‚ºäº†ä¸è®“ Console å¤ªå¤šè¨Šæ¯ï¼Œæˆ‘å€‘å¯ä»¥åªé¡¯ç¤ºæ•´æ•¸é€²åº¦
                    const percent = Math.round(data.progress);
                    if (percent % 10 === 0) { 
                        console.log(`ğŸ“¦ [RAG] ä¸‹è¼‰ä¸­... ${percent}%`);
                    }
                } else if (data.status === 'done') {
                    console.log(`âœ… [RAG] çµ„ä»¶ä¸‹è¼‰å®Œæˆ: ${data.file}`);
                }
            }
        });
        
        console.log("âœ… [RAG] å‘é‡æ¨¡å‹å·²å°±ç·’ï¼Œé–‹å§‹è¨ˆç®—ç‰¹å¾µ...");

        // 3. è¨ˆç®—å‘é‡ (æ“·å–å‰ 500 å­—)
        const output = await extractor(studentText.substring(0, 500), { pooling: 'mean', normalize: true });
        const vector = Array.from(output.data);

        // 4. å‘¼å« Supabase é€²è¡Œæ¯”å°
        const { data, error } = await supabaseClient.rpc('match_documents', {
            query_embedding: vector,
            match_threshold: 0.3, // ç›¸ä¼¼åº¦é–€æª»
            match_count: 3,       // æŠ“å– 3 ç¯‡
            filter_type: targetType
        });

        if (error) {
            console.error("âŒ [RAG] Supabase RPC Error:", error);
            return "";
        }

        if (data && data.length > 0) {
            // è©³ç´°åˆ—å°å‘½ä¸­è³‡æ–™ï¼Œæ–¹ä¾¿æ‚¨æª¢æŸ¥
            console.group(`ğŸ¯ [RAG] å‘½ä¸­ ${data.length} ç¯‡ç¯„æ–‡`);
            data.forEach((match, idx) => {
                const similarityScore = (match.similarity * 100).toFixed(2) + '%';
                const docTitle = match.metadata ? match.metadata.title : 'ç„¡æ¨™é¡Œ';
                // é è¦½å‰ 50 å€‹å­—
                const preview = match.content ? match.content.substring(0, 50).replace(/\n/g, ' ') + '...' : '';
                
                console.log(`%c[${idx + 1}] ${docTitle}`, "font-weight: bold; color: #4caf50;");
                console.log(`    ç›¸ä¼¼åº¦: ${similarityScore}`);
                console.log(`    å…§å®¹é è¦½: ${preview}`);
            });
            console.groupEnd();
            
            // 5. æ ¼å¼åŒ–è¼¸å‡ºçµ¦ LLM
            let ragContent = "=== âš¡ ç³»çµ±æª¢ç´¢ï¼š5** é«˜åˆ†ç¯„æ–‡åº«åƒè€ƒè³‡æ–™ âš¡ ===\n";
            ragContent += "(æ³¨æ„ï¼šä»¥ä¸‹å…§å®¹åƒ…ä¾›è©•åˆ†æ¨™æº–åƒè€ƒï¼Œä¸¦éå­¸ç”Ÿæ‰€å¯«ï¼Œè«‹å‹¿å°æ­¤é€²è¡Œè©•æ”¹)\n\n";

            data.forEach((match, index) => {
                ragContent += `ã€åƒè€ƒç¯„æ–‡ ${index + 1}ã€‘ï¼š${match.metadata.title || 'ç„¡é¡Œ'}\n`;
                ragContent += `${match.content}\n`;
                ragContent += `--------------------------------------------------\n`;
            });
            
            return ragContent;
        } else {
            console.warn(`ğŸ¤·â€â™‚ï¸ [RAG] æ‰¾ä¸åˆ°ç›¸ä¼¼æ–‡ç«  (ç›¸ä¼¼åº¦ä½æ–¼ 0.3)`);
            return "";
        }

    } catch (err) {
        console.error("âŒ [RAG] åŸ·è¡Œéç¨‹ç™¼ç”ŸéŒ¯èª¤:", err);
        return ""; 
    }
}
	</script>


<!-- === æ–°å¢ï¼šé é¢å³ç·£å¡æ‰£æŒ‰éˆ• === -->
<button id="sideMenuToggle" title="å±•é–‹é¸å–®">
    <i class="fas fa-bars"></i>
</button>

<div id="sideMenu" class="side-menu-overlay">
    <div class="side-menu-content">
        <button class="side-menu-close" id="sideMenuClose">&times;</button>
        
      <div class="side-menu-items">
    <!-- 1. é›²ç«¯åŒæ­¥ -->
    <button class="side-menu-item" id="sideMenuCloudBtn" onclick="openStudentLoginModal()">
        <i class="fas fa-cloud-upload-alt"></i>
        <span>é›²ç«¯åŒæ­¥</span>
        <div id="notifBadge" class="notification-badge"></div>
    </button>
		   
    <!-- 2. æ­·å²ç´€éŒ„ -->
    <button class="side-menu-item" onclick="openHistoryContainer()">
        <i class="fas fa-history"></i>
        <span>æ­·å²ç´€éŒ„</span>
    </button>

    <!-- 3. å·¥å…·ä¸€è¦½ (å·²ç§»è‡³æ­·å²ç´€éŒ„ä¸‹æ–¹) -->
    <button class="side-menu-item" id="sideMenuToolsBtn" onclick="openToolsFromSideMenu()">
        <i class="fas fa-toolbox"></i>
        <span>å·¥å…·ä¸€è¦½</span>
    </button>

    <!-- 4. è¿”å›ä¸»é  -->
    <button class="side-menu-item" id="sideMenuHomeBtn" onclick="returnToHome()" style="display: none;">
        <i class="fas fa-home"></i>
        <span>è¿”å›ä¸»é </span>
    </button>

<!-- ç²¾é¸æ–‡ç« æŒ‰éˆ• -->
<!-- ä¿®æ”¹åŸæœ¬çš„æ–‡èƒæŒ‰éˆ• -->
<button class="side-menu-item" onclick="openBookResourceMenu()">
    <i class="fas fa-book"></i> <!-- åœ–ç¤ºæ”¹ç‚ºé€šç”¨æ›¸ç± -->
    <span>é–±è®€è³‡æº</span>      <!-- æ–‡å­—æ”¹ç‚ºçµ±ç¨± -->
</button>

		  
    <!-- 5. éŸ³æ¨‚æ’­æ”¾å™¨ -->
    <button class="side-menu-item" onclick="toggleMusicPlayer()">
        <i class="fas fa-music"></i>
        <span>éŸ³æ¨‚æ’­æ”¾å™¨</span>
    </button>


<!-- å´é‚Šé¸å–®åº•éƒ¨ï¼šè²“å’ªæŒ‰éˆ• -->
<div style="height: 1px; background: rgba(255,255,255,0.1); margin: 5px 10px;"></div>
<button class="side-menu-item" onclick="openCatMenu()" title="å‘¼å–šè²“å’ª">
    <i class="fas fa-cat" style="font-size: 24px;"></i>
    <span>Live2D</span>
</button>


		  
</div>
    </div>
</div>



<!-- === æ–°å¢ï¼šè¿”å›ä¸»é æŒ‰éˆ• === -->
<button id="homeBtn" onclick="returnToHome()" title="è¿”å›ä¸»é ">
    <i class="fas fa-home"></i>
</button>


<!-- OneSignal SDK -->
<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];

  window.addEventListener('load', async function() {
    OneSignalDeferred.push(async function(OneSignal) {
      try {
        await OneSignal.init({
          appId: "f85da4b8-abae-4c5e-8db9-c9f463fc9815",
          
          // === é—œéµä¿®æ­£ï¼šç§»é™¤å‹•æ…‹æ™‚é–“æˆ³ï¼Œé¿å…æ¯æ¬¡ç”¢ç”Ÿæ–°çš„ Worker ===
          serviceWorkerPath: "OneSignalSDKWorker.js",
          
          // ç¢ºä¿ Scope æ­£ç¢º
          serviceWorkerParam: { scope: "/AIChinese/" },

          allowLocalhostAsSecureOrigin: true,
          notifyButton: { enable: false } 
        });
        
        console.log("OneSignal åˆå§‹åŒ–æˆåŠŸ (ä¿®æ­£ç‰ˆ)ï¼");

        // === æ¨™ç±¤è¨­å®š (ä¿ç•™ä½ çš„é‚è¼¯) ===
        const s = JSON.parse(localStorage.getItem('studentProfile'));
        if (s) {
            // å»¶é²ä¸€é»é»ç¢ºä¿ User ID å·²å»ºç«‹
            setTimeout(() => {
                OneSignal.User.addTags({ 
                    grade: String(s.grade), 
                    class: String(s.class), 
                    userType: 'student' 
                });
                console.log("æ¨™ç±¤å·²æ›´æ–°");
            }, 1000);
        }

      } catch (err) {
        console.error("OneSignal åˆå§‹åŒ–å¤±æ•—:", err);
      }
    });
  });
</script>
	
<style>
/* === å…¨å±€åŸºç¤è¨­å®š === */
body {
    font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background: url('èƒŒæ™¯.png') center/cover fixed;
    padding-bottom: 60px; /* ç‚ºé é¢å…§å®¹è¨­ç½®åº•éƒ¨å…§é‚Šè·ï¼Œé¿å…è¢«éŸ³æ¨‚æ’­æ”¾å™¨é®æ“‹ */
    transition: background-image 0.6s ease-in-out, background-color 0.6s ease-in-out;
}

h1 {
    text-align: center;
    color: #333;
}

/* === è¿”å›ä¸»é æŒ‰éˆ•æ¨£å¼ === */
#homeBtn {
    position: fixed;
    top: 20px;
    left: 20px; /* å·¦ä¸Šè§’ */
    z-index: 9999;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.6); /* åŠé€æ˜é»‘åº• */
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.5);
    font-size: 24px;
    cursor: pointer;
    display: none; /* é è¨­éš±è— */
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
}

#homeBtn:hover {
    background-color: rgba(0, 0, 0, 0.8);
    transform: scale(1.1);
    border-color: #fff;
}

/* === é€šç”¨å®¹å™¨èˆ‡ä½ˆå±€ === */
.box {
    background: rgba(220, 220, 220, 0.96);
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin: 15px 0;
}

.category {
    margin-bottom: 20px;
}

.category h3 {
    font-size: 18px;
    margin-bottom: 10px;
    color: #fff; /* ç™½è‰²æ–‡å­—ï¼Œé©é…æ·±è‰²èƒŒæ™¯ */
    text-align: left;
}

/* æ‰‹æ©Ÿè¨­å‚™èª¿æ•´ */
@media (max-width: 600px) {
    .category {
        padding-left: 25px; /* å¢åŠ å·¦å…§é‚Šè·ï¼Œè®“æŒ‰éµé é›¢å·¦é‚Šç·£ */
    }

    #toolsList button {
        width: auto; /* å¯¬åº¦è‡ªé©æ‡‰æ–‡å­—å…§å®¹ */
        display: inline-block; /* æŒ‰éˆ•ä»¥è¡Œå…§å¡Šå…ƒç´ é¡¯ç¤ºï¼Œé…åˆç½®ä¸­ */
        margin: 10px 0; /* èª¿æ•´ç‚ºä¸Šä¸‹ 10pxï¼Œå·¦å³ 0pxï¼Œé¿å…é¡å¤–æ°´å¹³é–“è· */
        font-size: 14px; /* ä¿ç•™å­—é«”å¤§å° */
        padding: 8px 16px; /* ä¿ç•™å…§é‚Šè·ï¼Œæä¾›é©ç•¶ç©ºé–“ */
    }

    .category h3 {
        font-size: 16px; /* ä¿ç•™æ¨™é¡Œå­—é«”å¤§å° */
    }
}

.copyright-footer {
    position: fixed;
    bottom: 0;
    right: 0;
    padding: 5px 10px;
    background-color: #f1f1f1;
}

.copyright-footer p {
    margin: 0;
    font-size: 14px;
}

@media (max-width: 600px) {
    .copyright-footer p {
        font-size: 12px;
    }
}

/* === èƒŒæ™¯å‹•ç•«æ•ˆæœ === */
/* æ™´å¤©æ•ˆæœï¼šå¤ªé™½ */
.sun {
    position: absolute;
    top: 10%;
    left: 5%; /* èª¿æ•´ç‚ºé å·¦ */
    width: 100px;
    height: 100px;
    background-color: yellow;
    border-radius: 50%;
    box-shadow: 0 0 20px yellow;
    animation: sunGlow 2s infinite alternate;
    z-index: -1; /* ç¢ºä¿å¤ªé™½åœ¨å…¶ä»–å…ƒç´ ä¸‹æ–¹ï¼Œé¿å…é®æ“‹æŒ‰éµ */
}

/* å¹³æ¿è¨­å‚™èª¿æ•´ */
@media (max-width: 768px) {
    .sun {
        left: 5%;
        top: 5%;
        width: 100px;
        height: 100px;
    }
}

/* æ‰‹æ©Ÿè¨­å‚™èª¿æ•´ */
@media (max-width: 480px) {
    .sun {
        left: 2%;
        top: 2%;
        width: 80px;
        height: 80px;
    }
}

/* å¤ªé™½å…‰èŠ’å‹•ç•« */
@keyframes sunGlow {
    0% { box-shadow: 0 0 20px yellow; }
    100% { box-shadow: 0 0 40px yellow; }
}

/* å¤šé›²æ•ˆæœï¼šé›²æœµ */
.cloud {
    position: absolute;
    background-color: white;
    border-radius: 50%;
    opacity: 0.8;
    animation: cloudMove linear infinite;
}

@keyframes cloudMove {
    0% { transform: translateX(-100vw); }
    100% { transform: translateX(100vw); }
}

/* ä¸‹é›¨æ•ˆæœï¼šé›¨æ»´ */
.raindrop {
    position: absolute;
    width: 2px;
    height: 10px;
    background-color: #ADD8E6; /* æ·ºè—è‰²ï¼Œæ›´è‡ªç„¶ */
    opacity: 0.7; /* å¢åŠ é€æ˜åº¦ */
    animation: rainFall linear infinite;
}

@keyframes rainFall {
    0% { transform: translateY(-10px); }
    100% { transform: translateY(100vh); }
}

/* ä¸‹é›ªæ•ˆæœï¼šé›ªèŠ± */
.snowflake {
    position: absolute;
    background-color: #e0f7fa;
    border-radius: 50%;
    opacity: 0.7;
    animation: snowfall linear infinite;
}

@keyframes snowfall {
    0% { top: -10px; transform: translateX(0); }
    50% { transform: translateX(20px); }
    100% { top: 100vh; transform: translateX(0); }
}

/* === æ¨™é¡Œæ¨£å¼ === */
.title-container {
    background: none;
    padding: 0;
    position: relative;
    margin-bottom: 3rem;
    text-align: center;
}

.title-text {
    display: block;
    font-size: 3rem;
    color: #d1f2eb;
    text-shadow: 3px 3px 0 #7f8c8d;
    letter-spacing: 4px;
    animation: titleFloat 3s ease-in-out infinite;
}

/* === æŒ‰éˆ•åŸºç¤æ¨£å¼ === */
button {
    background: #007bff;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
    margin: 5px;
}

button:hover {
    background: #0056b3;
}

.save-btn { background: #28a745; }
.save-btn:hover { background: #218838; }
.clear-btn { background: #dc3545; }
.clear-btn:hover { background: #c82333; }

/* === è¡¨å–®è¼¸å…¥æ¡†ç¾åŒ– === */
/* === è¡¨å–®è¼¸å…¥æ¡†ç¾åŒ– (å·²åŠ å…¥ password æ”¯æ´) === */
select, textarea, input[type="text"], input[type="password"] {
    width: 100%;
    padding: 12px 15px;
    margin: 10px 0;
    border: 1px solid #dcdfe6;
    border-radius: 8px;
    box-sizing: border-box;
    background-color: #fcfdfd;
    font-size: 1.3em;
    color: #333;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    font-family: 'Noto Serif TC', serif; /* ç¢ºä¿å­—é«”ä¸€è‡´ */
}

select:focus, textarea:focus, input[type="text"]:focus, input[type="password"]:focus {
    outline: none;
    border-color: #4A90E2;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
}

textarea {
    resize: vertical;
    min-height: 80px; /* è¨­å®šæœ€å°é«˜åº¦ */
}

/* === è¡¨æ ¼æ¨£å¼ === */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
}

th, td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: left;
    vertical-align: top;
    word-break: break-word;
}

th {
    background: #f0f0f0;
}

.table-container {
    overflow-x: auto;
    width: 100%;
}

.table-container table {
    width: 100%;
    border-collapse: collapse;
}

.table-container th, .table-container td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: left;
    vertical-align: top;
    word-break: break-word;
}

.table-container th:first-child, .table-container td:first-child { width: 60px; }
.table-container th:nth-child(2), .table-container td:nth-child(2),
.table-container th:nth-child(3), .table-container td:nth-child(3) { min-width: 100px; }
.table-container th:nth-child(4), .table-container td:nth-child(4),
.table-container th:nth-child(5), .table-container td:nth-child(5) { min-width: 150px; }

/* === å‹•ç•« === */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.tool-btn {
    animation: fadeIn 0.2s ease-in-out forwards;
    opacity: 0;
}

/* === ç¯„ç–‡æŒ‰éµæ¨£å¼ === */
.category-buttons-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center; /* è®“æŒ‰éˆ•åœ¨å®¹å™¨å…§å±…ä¸­ */
}

.btn-category {
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    background-color: rgba(142, 142, 147, 0.7); /* åŠé€æ˜ç°è‰² */
    color: white;
    backdrop-filter: blur(5px);
    margin: 0; /* é‡ç½® margin */
}

.btn-category:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    filter: brightness(115%);
}

.btn-category.active {
    filter: brightness(115%);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.7), 0 4px 12px rgba(0,0,0,0.25);
    transform: translateY(-2px);
}

/* Specific active colors */
#readingBtn.active { background-color: #28a745; }
#writingBtn.active { background-color: #007bff; }
#argumentBtn.active { background-color: #800080; }
#expandBtn.active { background-color: #dc3545; }
#booksBtn.active { background-color: #ffc107; }

/* Apply to the expand button as well */
#expandToolsBtn2 {
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    color: white;
    background-color: rgba(54, 187, 167, 0.8);
    backdrop-filter: blur(5px);
display: none; /* æ–°å¢é€™è¡Œ */
}

#expandToolsBtn2:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    filter: brightness(110%);
}

/* === å·¥å…·åˆ—è¡¨ === */
#toolsContainer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    overflow: hidden; /* éš±è—é é¢æ»¾å‹•æ¢ */
}

#toolsList {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    max-height: 80vh; /* è¨­ç½®æœ€å¤§é«˜åº¦ */
    overflow-y: auto; /* å•Ÿç”¨å‚ç›´æ»¾å‹•æ¢ */
    position: relative; /* ä¿æŒç›¸å°å®šä½æ–¼å®¹å™¨å…§ */
}

#toolsList button {
    opacity: 0;
    margin: 10px 0;
    padding: 10px 20px;
    font-size: 16px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

#closeToolsBtn {
    position: absolute;
    top: 20px;
    right: 20px;
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
}

#commentResult {
    width: 100%;
    overflow-wrap: break-word;
}

#toggleOverviewBtn {
    background-color: #A9A9A9; /* ç°è‰²èƒŒæ™¯ */
    color: white; /* ç™½è‰²æ–‡å­— */
}

#toggleOverviewBtn:hover {
    background-color: #808080; /* æ‡¸åœæ™‚æ·±ç°è‰² */
}

#manuscriptPaperBtn {
    background-color: #17a2b8;
}
#manuscriptPaperBtn:hover {
    background-color: #138496;
}

#writingContainer, #readingContainer, #booksContainer, #expandContainer, #argumentContainer {
    display: none;
}
#argumentTopicSelectionArea, #argumentCustomTopicArea, #argumentWritingArea, #argumentGuideArea {
    margin-top: 10px;
}

/* === éŸ³æ¨‚æ’­æ”¾å™¨æ¨£å¼å„ªåŒ– === */
#music-player {
    position: fixed;
    bottom: 0px;
    left: 0;
    width: 100%;
    background-color: rgba(40, 40, 40, 0.95); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
    backdrop-filter: blur(5px);
    color: white;
    padding: 10px 15px;
    display: none; /* é è¨­éš±è— */
    align-items: center;
    justify-content: space-between;
    z-index: 1002;
    box-sizing: border-box;
    font-size: 14px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
}

#music-player .controls { 
    display: flex; 
    align-items: center; 
    flex-shrink: 0; 
    gap: 10px;
}

/* æ’­æ”¾æŒ‰éˆ•æ¨£å¼ */
#music-player .controls button#play-pause {
    background: none;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    color: white;
    font-size: 14px;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    margin: 0; /* é‡ç½® margin */
}

#music-player .controls button#play-pause:hover {
    background-color: white;
    color: #333;
    border-color: white;
    transform: scale(1.1);
}

#music-player .controls select { 
    background: #555; 
    color: white; 
    border: none; 
    padding: 6px 10px; 
    border-radius: 4px; 
    max-width: 150px; 
    cursor: pointer;
}

#music-player .progress { 
    flex: 1; 
    margin: 0 15px; 
    display: flex; 
    align-items: center; 
}
#music-player .progress input[type="range"] { 
    width: 100%; 
    cursor: pointer;
}

#music-player .mode { 
    margin-left: 10px; 
    flex-shrink: 0; 
}
#music-player .mode select { 
    background: #555; 
    color: white; 
    border: none; 
    padding: 6px 10px; 
    border-radius: 4px; 
    cursor: pointer;
}

/* éš±è— (ç®­é ­) æŒ‰éˆ•æ¨£å¼ */
#music-player .hide-btn { 
    background: none; 
    border: none; 
    color: #aaa; 
    font-size: 18px; 
    cursor: pointer; 
    margin-left: 15px; 
    transition: color 0.3s;
    padding: 5px;
}
#music-player .hide-btn:hover {
    color: white;
    transform: translateY(2px);
}

/* æ‡¸æµ®é¡¯ç¤ºæŒ‰éˆ• (æ›¿ä»£åŸæœ¬çš„é‹¼ç´ Emoji) */
#show-player {
    position: fixed;
    bottom: 25px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: rgba(30, 30, 30, 0.9);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
    z-index: 1003;
    font-size: 20px;
    display: none; /* JS æœƒæ§åˆ¶é¡¯ç¤º */
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    backdrop-filter: blur(5px);
    padding: 0;
}

#show-player:hover {
    transform: scale(1.15) rotate(15deg);
    background-color: #007bff; /* æ‡¸åœè®Šè—è‰² */
    border-color: white;
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
}

@media (max-width: 600px) {
    #music-player { flex-wrap: wrap; padding: 5px; }
    #music-player .controls select { max-width: 100px; font-size: 12px; }
    #music-player .mode select { font-size: 12px; }
    #progress-bar-music {
        height: 10px;
        -webkit-appearance: none;
        appearance: none;
        background: #ddd;
        border-radius: 5px;
    }
    #progress-bar-music::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
    }
    #progress-bar-music::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
    }
    #music-player .controls select, #music-player .mode select { max-width: 80px; padding: 3px; font-size: 12px; }
    #music-player .controls button, #music-player .hide-btn { padding: 5px; font-size: 16px; }
}

/* --- Styles for Tool 2 (èªè–ˆ) --- */
:root {
    --bg-color: #f5f5f3;
    --text-color: #333;
    --primary-color: #6a7a7d;
    --secondary-color: #8f8f8f;
    --accent-color: #8c9ea1;
    --line-color: #c5c5c5;
    --shadow-color: rgba(0, 0, 0, 0.05);
    --highlight-bg-writing: rgba(230, 240, 245, 0.6);
    --highlight-bg-reading: rgba(245, 240, 230, 0.6);
    --font-main: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
}

#toolsContainer2 {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--bg-color);
    z-index: 1005;
    overflow-y: auto;
    display: none;
    padding: 2rem 1rem;
    box-sizing: border-box;
    justify-content: center;
}

#closeToolsBtn2 {
    position: fixed;
    top: 15px;
    right: 25px;
    background-color: transparent;
    border: none;
    font-size: 2.5rem;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    z-index: 1006;
    line-height: 1;
    padding: 5px 10px;
}

#closeToolsBtn2:hover { color: #d32f2f; }

.main-container {
    max-width: 1200px;
    width: 100%;
    position: relative;
    opacity: 0;
    transition: opacity 0.5s ease-in;
}

.main-container.loaded { opacity: 1; }

.floating-header {
    position: fixed;
    top: 15px;
    left: 20px;
    background-color: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(8px);
    padding: 5px 15px;
    border-radius: 30px;
    border: 1px solid #e0e0e0;
    z-index: 1000;
    box-shadow: 0 2px 10px var(--shadow-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

#video-tour-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
}

#video-tour-btn .icon {
    width: 24px;
    height: 24px;
    fill: var(--primary-color);
    transition: fill 0.3s;
}

#video-tour-btn:hover .icon { fill: var(--accent-color); }

.floating-header h1 {
    font-size: 1.2rem;
    margin: 0;
    font-weight: 700;
    color: var(--primary-color);
}

.mind-map-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto auto 1fr auto;
    grid-template-areas:
    "core-ai core-ai"
    "foundations foundations"
    "writing reading"
    "assignments support";
    gap: 50px 20px;
    width: 100%;
    margin-top: 80px;
    padding-bottom: 50px;
    position: relative;
}

.node {
    display: flex;
    align-items: center;
    text-align: center;
    padding: 8px 12px;
    background-color: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 3px 12px var(--shadow-color);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
}

.node:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    border-color: var(--accent-color);
}

.node a {
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 0.95rem;
    gap: 8px;
    width: 100%;
}

.node .icon {
    width: 24px;
    height: 24px;
    margin-right: 0;
    fill: var(--primary-color);
}

#toolsContainer2 .category {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin-bottom: 0; /* Reset margin for this context */
}

#writing, #reading {
    padding: 20px;
    border-radius: 12px;
}
#writing { background-color: var(--highlight-bg-writing); }
#reading { background-color: var(--highlight-bg-reading); }

.category-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary-color);
    padding-bottom: 5px;
    border-bottom: 2px solid var(--accent-color);
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.category-title .icon {
    width: 24px;
    height: 24px;
    margin-right: 8px;
    fill: var(--primary-color);
}

.sub-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 100%;
}

.sub-group-title {
    font-weight: bold;
    color: var(--secondary-color);
    font-size: 0.9rem;
    position: relative;
    padding-bottom: 5px;
    margin-bottom: 5px;
}
.sub-group-title::after{
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 30px;
    height: 1px;
    background-color: var(--line-color);
}

.node.level-2 { font-size: 0.9rem; }
.node.level-3 { font-size: 0.85rem; padding: 6px 10px; }
.node.level-3 a { font-weight: 400; flex-direction: row; }

/* Grid Area Assignments */
#core-ai { grid-area: core-ai; }
#foundations {
    grid-area: foundations;
    display: flex;
    flex-direction: row;
    justify-content: center;
    gap: 500px;
    align-items: flex-start;
}
#writing { grid-area: writing; }
#reading { grid-area: reading; }
#assignments { grid-area: assignments; }
#support { grid-area: support; }

.connector-svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
}

.connector-svg line {
    stroke: var(--line-color);
    stroke-width: 1.5;
    stroke-dasharray: 4;
    animation: dash 1s linear infinite;
}

@keyframes dash {
    to { stroke-dashoffset: -20; }
}

#yuyilu-toggle { cursor: pointer; }
.yuyilu-grades {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
    max-height: 500px;
    overflow: hidden;
    transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
    opacity: 1;
}
.yuyilu-grades.collapsed {
    max-height: 0;
    opacity: 0;
    pointer-events: none;
}

.foundation-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

@media (max-width: 768px) {
    #toolsContainer2 { padding: 1rem 0.5rem; }
    .floating-header { top: 10px; left: 10px; }

    .mind-map-container {
        margin-top: 70px;
        grid-template-columns: 1fr;
        grid-template-rows: auto;
        grid-template-areas:
        "core-ai"
        "foundations"
        "writing"
        "reading"
        "assignments"
        "support";
        gap: 40px;
    }

    #foundations {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
        width: 90%;
        margin: 0 auto;
        gap: 10px;
    }

    #writing, #reading { padding: 15px; }
}

/* --- Preview Modal Styles --- */
.preview-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: none; /* é è¨­éš±è— */
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 1rem;
    box-sizing: border-box;
}

.preview-modal-content {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.2);
    width: 90%;
    height: 90%;
    max-width: 1000px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
}

.preview-close-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(255, 255, 255, 0.7);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s, color 0.3s;
    z-index: 2010;
}
.preview-close-btn:hover {
    color: #fff;
    background-color: #d32f2f;
}

.preview-modal-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
}

#previewIframe {
    width: 100%;
    flex-grow: 1; /* ä½”æ“šå¤§éƒ¨åˆ†ç©ºé–“ */
    border: none;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    min-height: 60%; /* ç¢ºä¿é è¦½ç•«é¢æœ‰è¶³å¤ é«˜åº¦ */
}

.preview-modal-footer {
    padding: 16px;
    background-color: #f7f9fa;
    border-top: 1px solid #e0e0e0;
    display: flex;
    align-items: flex-start;
    gap: 16px;
    overflow-y: auto;
    max-height: 40%;
    flex-shrink: 0;
}

.preview-description {
    font-size: 0.95rem;
    color: #333;
    line-height: 1.6;
    text-align: left;
    flex-grow: 1;
}

.preview-goto-btn {
    background: #007bff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='18px' height='18px'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z'/%3E%3C/svg%3E") no-repeat 15px center;
    background-size: 18px 18px;
    color: white;
    padding: 10px 20px 10px 40px;
    border: none;
    border-radius: 20px;
    text-decoration: none;
    font-size: 1rem;
    font-weight: bold;
    transition: background-color 0.3s;
    cursor: pointer;
    flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•ç¸®å° */
}
.preview-goto-btn:hover {
    background-color: #0056b3;
    color: white;
}

@media (max-width: 600px) {
    .preview-modal-footer {
        flex-direction: column;
        align-items: stretch;
    }
    .preview-goto-btn {
        align-self: flex-end; /* åœ¨å †ç–Šæ™‚ä»å°‡æŒ‰éˆ•é å³ */
    }
}

/* --- Video Modal Styles --- */
.video-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: none; /* é è¨­éš±è— */
    justify-content: center;
    align-items: center;
    z-index: 2100;
    cursor: pointer;
}

.video-modal-content {
    position: relative;
    width: 90%;
    max-width: 960px;
    padding-top: 56.25%; /* 16:9 Aspect Ratio */
    height: 0;
    cursor: default;
}

.video-modal-content iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}

/* --- åŠŸèƒ½é¸æ“‡èˆ‡é–“è· --- */
.function-selector-wrapper {
    padding: 20px; /* å¢åŠ å…§é‚Šè·ï¼Œè®“å…§éƒ¨å…ƒç´ æœ‰æ›´å¤šå‘¼å¸ç©ºé–“ */
    background-color: rgba(59, 184, 219, 0.2);
    border-left: 5px solid #0288d1;
    margin-top: 30px;
    margin-bottom: 35px; /* æ˜é¡¯å¢åŠ èˆ‡ä¸‹æ–¹å…§å®¹çš„é–“è· */
    border-radius: 8px; /* åœ“è§’ç¨å¤§ï¼Œè¦–è¦ºä¸Šæ›´æŸ”å’Œ */
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.function-selector-wrapper label {
    font-size: 1.1em; /* æ¨™é¡Œå­—é«”ç¨å¤§ï¼Œæ›´çªå‡º */
    font-weight: bold;
    color: #01579b;
    display: block;
    margin-bottom: 15px; /* å¢åŠ èˆ‡ä¸‹æ‹‰é¸å–®çš„é–“è· */
}
.function-selector-wrapper select {
    font-size: 1em; /* çµ±ä¸€ä¸‹æ‹‰é¸å–®å­—é«”å¤§å° */
    padding: 8px; /* é©åº¦å¢åŠ ä¸‹æ‹‰é¸å–®çš„å…§é‚Šè· */
}

/* ç‚ºå„å€‹åŠŸèƒ½å®¹å™¨å…§çš„ä¸»è¦å€å¡Šï¼ˆdivï¼‰å¢åŠ çµ±ä¸€çš„ä¸‹é–“è· */
#writingContentContainer > div,
#expandContentContainer > div,
#argumentContentContainer > div {
    margin-bottom: 30px;
}

/* æ¸…é™¤æœ€å¾Œä¸€å€‹å…ƒç´ çš„ä¸‹é‚Šè· */
#writingContentContainer > div:last-child,
#expandContentContainer > div:last-child,
#argumentContentContainer > div:last-child {
    margin-bottom: 0;
}

/* é‡å°é–±è®€å€å¡Šï¼Œå…¶å…§éƒ¨çµæ§‹ä¸åŒï¼Œå–®ç¨èª¿æ•´å…¶å­å…ƒç´ çš„é–“è· */
#readingInputArea > *:not(div#readingResult) {
    margin-bottom: 20px;
}

/* --- æ”¹å¯«èªªæ˜ UI --- */
.rewrite-explanation-container { margin-top: 20px; }
.rewrite-explanation-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.rewrite-explanation-card h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #343a40;
    font-size: 1.2em;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 10px;
}
.explanation-point {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
}
.explanation-point:last-child { margin-bottom: 0; }
.explanation-number {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
     background-color: #6996b8 !important; 
box-shadow: 0 2px 5px rgba(0,0,0,0.15) !important;
    color: white;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin-right: 15px;
    font-size: 1em;
}
.explanation-text {
    font-size: 1em;
    line-height: 1.6;
    color: #495057;
}

/* --- é»è©•èªæ°£æ¨™ç±¤ --- */
.tone-selector-label {
    display: block; /* ç¢ºä¿æ¨™ç±¤ç¨ä½”ä¸€è¡Œ */
    margin-top: 25px; /* å¢åŠ èˆ‡ä¸Šæ–¹å…ƒç´ çš„è·é›¢ */
}

/* --- é¡Œç›®é¡¯ç¤ºå€å¡Šæ¨£å¼ --- */
#topicResult, #argumentTopicResult, #expandTopicResult {
    position: relative;
    padding: 12px 15px;
    margin-bottom: 20px;
    border-left: 5px solid #2A9689;
    border-radius: 4px;
    font-size: 1em;
    display: none;
    background-color: transparent !important; /* å¼·åˆ¶å®¹å™¨æœ¬èº«é€æ˜ */
    z-index: 0;
}

#topicResult::before,
#argumentTopicResult::before,
#expandTopicResult::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(54, 187, 167, 0.5); /* åŠé€æ˜èƒŒæ™¯ */
    border-radius: inherit;
    z-index: -1;
}

#topicResult td, #argumentTopicResult td, #expandTopicResult td { background-color: #ffffff !important; }
#topicResult th, #argumentTopicResult th, #expandTopicResult th { background-color: #f0f0f0 !important; }
#topicResult:not(:empty), #argumentTopicResult:not(:empty), #expandTopicResult:not(:empty) { display: block; }

#topicSelectionArea > label,
#argumentTopicSelectionArea > label,
#expandTopicSelectionArea > label {
    display: block;
    margin-bottom: 10px;
}

/* --- æŒ‰éµç¾åŒ–ä¿®è¨‚ --- */
.topic-buttons-container {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-top: 10px;
}

.btn {
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    color: white;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    border: 3px solid transparent;
    background-color: #8E8E93; /* ä¸­æ€§ç° */
}

.btn:not(.active):hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    filter: brightness(110%);
}

.btn-generate.active { background-color: #4A90E2; }
.btn-custom.active { background-color: #7B68EE; }

.btn.active {
    filter: brightness(115%);
    border: 3px solid white;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
    transform: translateY(-2px);
}

.btn .fas { font-size: 15px; }

/* --- å‰©é¤˜å­—æ•¸è¨ˆæ•¸å™¨ --- */
#charCount {
    margin-top: 0px;
    margin-bottom: 20px;
    text-align: right;
    font-size: 0.9em;
    color: #666;
}

/* --- ç¦ç”¨æŒ‰éˆ•æ¨£å¼ --- */
button:disabled, .btn:disabled, .btn-icon-confirm:disabled, .btn-action:disabled {
    background-color: #cccccc !important;
    border-color: #cccccc !important;
    color: #666666;
    cursor: not-allowed;
    opacity: 0.6;
    box-shadow: none;
    transform: none;
}

/* --- å„²å­˜/æ¸…é™¤åœ–ç¤ºæŒ‰éµ --- */
.action-buttons-container {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 10px;
    align-items: center;
}

.btn-add-icon { background-color: rgba(0, 123, 255, 0.8); }

.btn-icon-action {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    color: white;
    font-size: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    transition: all 0.2s ease-in-out;
    margin: 0;
}

.btn-icon-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    filter: brightness(110%);
}

.btn-icon-action:active { transform: translateY(0); }
.btn-save-icon { background-color: rgba(26, 117, 149, 0.8); }
.btn-clear-icon { background-color: rgba(220, 53, 69, 0.8); }

/* --- ç¢ºèªåœ–ç¤ºæŒ‰éµ --- */
.btn-icon-confirm {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background-color: #28a745;
    border: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease-in-out;
}

.btn-icon-confirm:hover {
    transform: scale(1.1);
    filter: brightness(110%);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

.btn-icon-confirm:active { transform: scale(1.15); }

/* ========================================= */
/* === [ä¿®è¨‚ V2] æ›¸ç±è¨è«–è³‡è¨Šå¡ç‰‡å„ªåŒ– === */
/* ========================================= */
.discussion-info {
    text-align: left;
    background-color: #fdfcf8;
    border: 2px solid #e0ddd7;
    color: #495057;
    padding: 20px;
    border-radius: 12px;
    margin: 10px auto 30px auto;
    
    /* [é›»è…¦ç«¯ä¿®æ­£] è¡Œè·ç”± 2.0 æ¸›ç‚º 1.5ï¼Œè®“è¦–è¦ºæ›´ç·Šæ¹Š */
    line-height: 1.5; 
    
    width: 100%;
    box-sizing: border-box;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    font-family: 'Noto Serif TC', serif;
}

/* è¡¨æ ¼ä½ˆå±€ */
.discussion-info table {
    width: 100%;
    border-collapse: collapse;
    /* ç§»é™¤ table-layout: fixedï¼Œè®“æ¬„ä½å¯¬åº¦æ ¹æ“šå…§å®¹è‡ªç„¶èª¿æ•´ï¼Œé¿å…æµªè²»ç©ºé–“ */
    table-layout: auto; 
}

.discussion-info td {
    border: none;
    
    /* [é›»è…¦ç«¯ä¿®æ­£] ä¸Šä¸‹å…§è·ç”± 10px æ¸›åŠç‚º 5px */
    padding: 5px 8px; 
    
    vertical-align: top; /* ä¿æŒé ä¸Šå°é½Š */
    word-wrap: break-word;
    overflow-wrap: break-word;
    font-size: 1.1rem;
}

/* æ¨™ç±¤æ¬„ä½ (å·¦å´ï¼šæ›¸åã€ä½œè€…...) */
.discussion-info td:first-child {
    width: 60px; /* ç¨å¾®ç¸®çª„æ¨™ç±¤æ¬„å¯¬åº¦ */
    font-weight: bold;
    color: #2A9689;
    white-space: nowrap;
    
    /* [é›»è…¦ç«¯ä¿æŒ] è®“ã€Œæ›¸åã€äºŒå­—å·¦å³å°é½Šï¼Œæ¯”è¼ƒç¾è§€ */
    text-align: justify;
    text-align-last: justify; 
}

/* ========================================= */
/* === [æ‰‹æ©Ÿç‰ˆå°ˆç”¨ä¿®å¾©] === */
/* ========================================= */
@media (max-width: 600px) {
    .discussion-info {
        padding: 15px; /* æ‰‹æ©Ÿç‰ˆå…§è·ç¸®å° */
    }

    .discussion-info table, 
    .discussion-info tbody, 
    .discussion-info tr, 
    .discussion-info td {
        display: block; /* å¼·åˆ¶è®Šæˆå‚ç›´æ’åˆ— */
        width: 100% !important;
        box-sizing: border-box;
    }

    /* 1. ä¿®å¾©æ‰‹æ©Ÿæ¨™ç±¤æ–‡å­—è¢«æ‹‰å¯¬çš„å•é¡Œ */
    .discussion-info td:first-child {
        text-align: left !important;      /* [é—œéµä¿®æ­£] å¼·åˆ¶é å·¦ï¼Œå–æ¶ˆå·¦å³å°é½Š */
        text-align-last: auto !important; /* [é—œéµä¿®æ­£] é‡ç½®æœ«è¡Œå°é½Š */
        
        color: #007bff; /* è—è‰²æ¨™ç±¤ */
        font-size: 0.95rem;
        
        /* è®“æ¨™ç±¤å’Œå…§å®¹é å¾—æ›´è¿‘ */
        padding-bottom: 2px; 
        padding-top: 10px;
        margin-bottom: 0;
        border-bottom: none; /* ç§»é™¤åˆ†éš”ç·šï¼Œè®“è¦–è¦ºæ›´é€£è²« */
    }

    /* 2. å…§å®¹éƒ¨åˆ† (æ›¸åæœ¬é«”) */
    .discussion-info td:last-child {
        padding-top: 0;
        padding-bottom: 10px; /* æ¯å€‹æ¬„ä½ä¹‹é–“çš„è·é›¢ */
        padding-left: 0;
        border-bottom: 1px dashed #eee; /* åœ¨å…§å®¹ä¸‹æ–¹åŠ åˆ†éš”ç·š */
    }

    /* æœ€å¾Œä¸€å€‹æ¬„ä½ä¸éœ€è¦åº•ç·š */
    .discussion-info tr:last-child td:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
}

/* ========================================= */
/* === [ä¿®è¨‚] èŠå¤©æ°£æ³¡æ’ç‰ˆå„ªåŒ– === */
/* ========================================= */

/* èŠå¤©æ­·å²å®¹å™¨ */
#chatHistory, #writingChatHistory, #argumentChatHistory, #writingGuideChatHistory {
    background-color: #f4f6f9; /* æ›´æŸ”å’Œçš„èƒŒæ™¯è‰² */
    border: 1px solid #e1e4e8;
    border-radius: 15px;
    padding: 25px 20px; /* å¢åŠ å…§éƒ¨ç©ºé–“ */
    margin-top: 15px;
    margin-bottom: 15px;
    max-height: 500px; /* å¢åŠ é«˜åº¦ */
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 20px; /* é—œéµï¼šæ°£æ³¡ä¹‹é–“çš„é–“è· */
}

/* å–®å€‹æ°£æ³¡ */
.message-bubble {
    padding: 18px 22px; /* å¢åŠ æ°£æ³¡å…§ç™½ï¼Œæ–‡å­—ä¸è²¼é‚Š */
    border-radius: 18px;
    line-height: 1.8; /* é—œéµï¼šå¢åŠ è¡Œè·ï¼Œæ–‡å­—ä¸å†ç·Šæ¹Š */
    font-size: 1.05rem; /* å­—é«”å¾®èª¿å¤§ */
    word-wrap: break-word;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    max-width: 88%; /* ç¨å¾®æ”¾å¯¬æœ€å¤§å¯¬åº¦ */
    animation: fadeIn 0.3s ease-in-out;
    position: relative;
}

/* AI æ°£æ³¡ (å·¦å´) */
.message-bubble.ai-message {
    background-color: #ffffff;
    color: #333;
    align-self: flex-start;
    border-top-left-radius: 4px;
    border: 1px solid #e0e0e0;
}

/* ç”¨æˆ¶æ°£æ³¡ (å³å´) */
.message-bubble.user-message {
    background-color: #2A9689; /* ä¸»é¡Œç¶  */
    color: white;
    align-self: flex-end;
    border-top-right-radius: 4px;
    box-shadow: 0 4px 10px rgba(42, 150, 137, 0.2);
}

/* æ‰‹æ©Ÿç‰ˆæ°£æ³¡å¾®èª¿ */
@media (max-width: 600px) {
    .message-bubble {
        padding: 15px;
        font-size: 1rem;
        max-width: 92%; /* æ‰‹æ©Ÿä¸Šæ°£æ³¡å¯ä»¥æ›´å¯¬ä¸€é» */
    }
}

#chatInputContainer, #writingChatInputContainer, #argumentChatInputContainer, #writingGuideChatInputContainer {
    display: none;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
}

#chatInputContainer textarea, #writingChatInputContainer textarea, #argumentChatInputContainer textarea, #writingGuideChatInputContainer textarea {
    flex-grow: 1;
    margin: 0;
}

#initialDiscussionForm { display: block; }

.books-modal {
    display: none;
    position: fixed;
    z-index: 1010;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
}

.books-modal .modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 25px;
    border: 1px solid #888;
    width: 90%;
    max-width: 500px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    position: relative;
    animation: fadeIn 0.4s;
}

.books-modal .close-modal-btn {
    color: #aaa;
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}
.books-modal .close-modal-btn:hover { color: black; }
#discussionControlButtons { margin-bottom: 20px; }
#booksButtons { display: none; }

/* --- åŸ·è¡Œå‹•ä½œæŒ‰éˆ• --- */
.btn-action {
    display: inline-block;
    padding: 10px 20px;
    margin: 15px 0 5px 0;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
    transition: all 0.3s ease;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    color: white;
    background-color: rgba(31, 122, 85, 0.8);
    backdrop-filter: blur(5px);
    text-align: center;
    text-decoration: none;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    filter: brightness(110%);
}

/* --- æ‡¸æµ®è¦–çª—ç·¨è¼¯å™¨ --- */
textarea:not(.no-modal-editor), input[type="text"]:not(.no-modal-editor) {
    cursor: pointer;
    background-color: #f0f8ff;
    transition: background-color 0.2s;
}

textarea:not(.no-modal-editor):hover, input[type="text"]:not(.no-modal-editor):hover {
    background-color: #e6f2ff;
}

.outline-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.65);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    padding: 1rem;
    box-sizing: border-box;
}

/* === æ‡¸æµ®è¦–çª—å®¹å™¨è¨­å®š (ä¿®è¨‚ç‰ˆï¼šé™åˆ¶é«˜åº¦é˜²æ­¢çˆ†ç‰ˆ) === */
.outline-modal-content {
    background-color: #fdfdfd;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 900px;       /* ç¨å¾®åŠ å¯¬ï¼Œè®“é›»è…¦ç‰ˆè¦–é‡æ›´å¥½ */
    max-height: 90vh;       /* é—œéµï¼šé™åˆ¶é«˜åº¦æœ€å¤šä½”è¢å¹• 90% */
    position: relative;
    animation: fadeIn 0.3s;
    display: flex;          /* ä½¿ç”¨ Flexbox æ’ç‰ˆ */
    flex-direction: column; /* å‚ç›´æ’åˆ—å­å…ƒç´  */
    box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’å¤§å¯¬åº¦ */
}

.outline-modal-content h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #2A9689;
    font-size: 1.2em;
    font-weight: 700;
    border-bottom: 2px dashed #a8dad5;
    padding-bottom: 12px;
    text-align: center;
    letter-spacing: 2px;
    flex-shrink: 0;         /* é˜²æ­¢æ¨™é¡Œè¢«å£“ç¸® */
}

/* === æ‡¸æµ®è¦–çª—è¼¸å…¥æ¡†è¨­å®š (ä¿®è¨‚ç‰ˆï¼šè‡ªå‹•å¡«æ»¿ç©ºé–“) === */
#modal-textarea {
    width: 100%;
    box-sizing: border-box !important;
    
    /* å­—é«”èˆ‡åŸç¨¿ç´™è¨­å®š (ä¿æŒä¸è®Š) */
    font-family: 'Noto Serif TC', 'Songti TC', serif !important;
    font-size: 20px !important;       
    line-height: 40px !important;     
    color: #2c3e50;                   
    letter-spacing: 2px;              
    background-color: #fffcf6;        
    background-image: 
        linear-gradient(transparent 39px, rgba(42, 150, 137, 0.3) 39px, rgba(42, 150, 137, 0.3) 40px, transparent 40px),
        linear-gradient(90deg, transparent 39px, rgba(0,0,0,0.03) 39px, rgba(0,0,0,0.03) 40px, transparent 40px);
    background-size: 40px 40px;       
    background-attachment: local;     
    border: 2px solid #8baea8;        
    border-radius: 8px;               
    padding: 0 18px !important;       
    box-shadow: inset 0 0 40px rgba(0,0,0,0.02);

    /* === é—œéµä¿®è¨‚ï¼šé«˜åº¦æ§åˆ¶ === */
    flex-grow: 1;           /* è‡ªå‹•å¡«æ»¿è¦–çª—å‰©é¤˜é«˜åº¦ */
    height: auto;           /* è®“ flex æ§åˆ¶é«˜åº¦ */
    min-height: 200px;      /* è¨­å®šæœ€å°é«˜åº¦ */
    resize: none;           /* ç¦æ­¢æ‰‹å‹•æ‹‰ä¼¸ï¼Œé¿å…ç ´å£ä½ˆå±€ */
    overflow-y: auto;       /* å…§å®¹éå¤šæ™‚ï¼Œåªæœ‰è¼¸å…¥æ¡†å…§éƒ¨æœƒæ»¾å‹• */
    margin-bottom: 10px;
}

/* æ‰‹æ©Ÿç‰ˆé©é… (ä¿æŒä¸è®Šï¼Œä½†éœ€ç¢ºä¿å„ªå…ˆç´š) */
@media (max-width: 600px) {
    #modal-textarea {
        font-size: 16px !important;
        line-height: 32px !important;
        background-image: 
            linear-gradient(transparent 31px, rgba(42, 150, 137, 0.3) 31px, rgba(42, 150, 137, 0.3) 32px, transparent 32px),
            linear-gradient(90deg, transparent 31px, rgba(0,0,0,0.03) 31px, rgba(0,0,0,0.03) 32px, transparent 32px);
        background-size: 32px 32px !important;
        padding: 0 10px !important;
    }
}

.outline-modal-content .modal-buttons { 
    text-align: right; 
    margin-top: 5px; 
    flex-shrink: 0;         /* é˜²æ­¢æŒ‰éˆ•è¢«å£“ç¸® */
}

.outline-modal-content .modal-buttons { text-align: right; margin-top: 15px; }
.outline-modal-content .preview-close-btn { position: absolute; top: 10px; right: 10px; }

#structure, #writingTone, #writingReviewer, #readingTone, #booksTone, #expandTone, #argumentOutlineTone, #argumentWritingTone, #argumentReviewer {
    font-size: 1.05em;
    padding: 6px 10px;
}

#booksContainer #initialDiscussionForm input[type="text"],
#booksContainer #initialDiscussionForm textarea {
    font-size: 1rem !important;
    padding: 10px 12px;
}

/* --- ç­”é¡Œæ­¥é©Ÿå¡ç‰‡ --- */
.steps-container {
    margin-top: 20px;
    padding-left: 15px;
    border-left: 4px solid #4A90E2;
}

.step-card {
    background-color: #f7f9fc;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.step-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}

.step-card:last-child { margin-bottom: 0; }
.step-title {
    font-weight: bold;
    font-size: 1.1em;
    color: #0056b3;
    margin-bottom: 10px;
}
.step-content {
    font-size: 1em;
    line-height: 1.7;
    color: #333;
}

#customTopicArea input[type="text"], #customTopicArea textarea, #argumentCustomTopicArea input[type="text"], #expandCustomTopicInputArea input[type="text"], #expandCustomTopicInputArea textarea, #expandGuideArea input[type="text"], #expandGuideArea textarea {
    font-size: 1rem !important;
    padding: 10px 12px;
}

/* --- è©•ç­‰ç³»çµ± --- */
.grading-container {
    margin-top: 25px;
    border-top: 2px dashed #aeb6bf;
    padding-top: 20px;
    max-width: 100%;
    overflow-x: hidden;
}

.grading-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: flex-start;
}

.grading-scores, .grading-radar {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    max-width: 100%;
    box-sizing: border-box;
    width: 90%;
    margin: 0 auto;
}

.grading-scores h3, .grading-radar h3 {
    margin-top: 0;
    color: #343a40;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.score-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    gap: 10px;
}

.score-item label {
    font-weight: bold;
    color: #495057;
    flex-shrink: 0;
    margin-right: 10px;
}

.score-item .slider-container {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    max-width: 160px;
}

.score-item .progress-bar-container {
    width: 120px;
    height: 12px;
    background-color: #e9ecef;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid #ced4da;
}

.score-item .progress-bar-fill {
    height: 100%;
    width: 0%;
    background-color: #007bff;
    border-radius: 6px;
    transition: width 0.4s ease-in-out;
}

.score-item .score-display {
    font-weight: bold;
    width: 25px;
    text-align: center;
    color: #0056b3;
}

.total-score-container {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    flex-wrap: wrap;
}

#finalGrade, [id$="FinalGrade"] {
    font-size: 2.5em;
    font-weight: bold;
    color: #d9534f;
    line-height: 1;
}

#totalScoreDisplay, [id$="TotalScoreDisplay"] {
    font-size: 1.2em;
    font-weight: bold;
    color: #333;
}

.radar-chart-container {
    position: relative;
    aspect-ratio: 4 / 3;
    max-height: 350px;
    width: 100%;
}

@media (max-width: 768px) {
    .grading-grid {
        grid-template-columns: 1fr;
        width: 95%;
        margin: 0 auto;
        justify-items: center;
    }
    .grading-scores, .grading-radar {
        padding: 15px;
        width: 95%;
        max-width: 95%;
    }
    .radar-chart-container {
        aspect-ratio: 1 / 1;
        max-height: 400px;
    }
    .score-item { flex-wrap: wrap; }
    .score-item label { width: 100%; margin-bottom: 5px; }
    .score-item .slider-container { max-width: 100%; }
}

/* --- å„²å­˜HTMLæŒ‰éˆ• --- */
.result-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.btn-save-html {
    position: static;
    margin-top: 20px;
    width: 40px;
    height: 40px;
    background-color: rgba(106, 122, 138, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    color: white;
    display: none;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    z-index: 10;
    opacity: 0.85;
    transition: all 0.2s ease-in-out;
    padding: 0;
    margin-left: auto;
    margin-right: auto;
}

.btn-save-html:hover {
    opacity: 1;
    transform: scale(1.1);
    background-color: rgba(90, 105, 120, 0.9);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.btn-save-html svg { width: 20px; height: 20px; }
#booksButtons #save-books-html-btn { background-color: rgba(74, 144, 226, 0.8); }

#writingReviewResultContainer, #argumentReviewResultContainer {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
}

/* --- é»è©•ç¯„ç–‡ UI --- */
.scope-selector-container {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 10px;
    padding: 15px;
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(0, 0, 0, 0.08);
}

.scope-label input[type="checkbox"] { display: none; }

.scope-label {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    user-select: none;
    border: 1px solid transparent;
    background-color: #f0f0f0;
    color: #555;
}

.scope-label:not(.disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-color: #007bff;
}

.scope-label.active {
    background-color: #007bff;
    color: white;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
}

.scope-label.disabled {
    background-color: #e9ecef;
    color: #adb5bd;
    cursor: not-allowed;
    opacity: 0.7;
}

.scope-label.all-scope.active {
    background-color: #4F5B93;
    color: white;
    box-shadow: 0 2px 5px rgba(79, 91, 147, 0.3);
}

/* --- è§£é¡ŒæŒ‡å¼•è¼¸å…¥æ¡† --- */
#writingGuideTopicInput {
    padding: 15px;
    border: 2px solid #4A90E2;
    border-radius: 8px;
    width: 100%;
    margin-bottom: 15px;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    background-color: #fcfdfd;
}
#writingGuideTopicInput:focus {
    border-color: #28a745;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.2);
    outline: none;
}

/* 2. æ¨™é¡Œå€å¡Š */
.guide-section-header {
    padding: 10px 15px;
    margin-bottom: 15px;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 0 8px 8px 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.guide-section-header h3 {
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* 3. ä»‹ç´¹å¡ç‰‡ (Intro) */
.guide-intro-card {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    margin-bottom: 25px;
    line-height: 1.8;
    color: #444;
    font-size: 1.05rem;
    border: 1px solid #eee;
}

/* === å‹•æ¼«é¢¨æ ¼è§’è‰²é¸æ“‡å¡ç‰‡ === */
.category-cards-wrapper {
    width: 100%;
    display: flex;
    justify-content: center;
    perspective: 1000px;
    padding: 10px 0 30px 0;
}

.category-cards-container {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    padding: 10px 20px;
    scrollbar-width: none;
    -ms-overflow-style: none;
    justify-content: center;
}

.category-cards-container::-webkit-scrollbar { display: none; }

.anime-card {
    position: relative;
    width: 120px;
    height: 180px;
    border-radius: 15px;
    background-image: var(--bg-img);
    background-size: cover;
    background-position: center;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    overflow: hidden;
    flex-shrink: 0;
    border: 1px solid rgba(255,255,255,0.2);
    filter: grayscale(30%);
}

.card-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.2) 60%, rgba(0,0,0,0) 100%);
    transition: all 0.3s ease;
}

.card-border-effect {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 15px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    z-index: 5;
    box-sizing: border-box;
}

.card-content {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    padding-bottom: 20px;
    z-index: 10;
}

.card-icon-container {
    font-size: 28px;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: auto;
    margin-top: 40px;
    transform: translateY(10px);
    transition: all 0.4s ease;
    opacity: 0.8;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

.card-text {
    text-align: center;
    transform: translateY(0);
    transition: transform 0.3s ease;
}

.card-zh {
    display: block;
    font-size: 18px;
    font-weight: bold;
    color: #fff;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    letter-spacing: 1px;
white-space: nowrap !important; /* æ ¸å¿ƒæŒ‡ä»¤ï¼šå¼·åˆ¶æ–‡å­—ä¸æ›è¡Œ */
    width: 100%;                    /* ç¢ºä¿æ–‡å­—å®¹å™¨å¯¬åº¦è¶³å¤  */
    text-align: center;             /* ç¢ºä¿æ–‡å­—æ°´å¹³ç½®ä¸­ */
    display: block;                 /* ç¢ºä¿å®ƒæ˜¯å€å¡Šå…ƒç´  */
}

.card-en {
    display: block;
    font-size: 10px;
    font-weight: 700;
    color: rgba(255,255,255,0.6);
    letter-spacing: 2px;
    margin-top: 4px;
    text-transform: uppercase;
    font-family: 'Arial', sans-serif;
white-space: nowrap !important; /* æ ¸å¿ƒæŒ‡ä»¤ï¼šå¼·åˆ¶æ–‡å­—ä¸æ›è¡Œ */
}

.anime-card:hover {
    transform: translateY(-15px) scale(1.05);
    filter: grayscale(0%);
    box-shadow: 0 15px 30px rgba(0,0,0,0.5), 0 0 20px rgba(0, 191, 255, 0.6);
    z-index: 20;
}

.anime-card:hover .card-border-effect { border-color: rgba(255, 255, 255, 0.9); }
.anime-card:hover .card-overlay { background: linear-gradient(to top, rgba(0,86,179,0.8) 0%, rgba(0,0,0,0) 100%); }
.anime-card:hover .card-icon-container {
    transform: translateY(-5px) scale(1.2);
    color: #fff;
    text-shadow: 0 0 10px #00bfff;
}

.anime-card.active {
    /* --- æ ¸å¿ƒä¿®æ­£ --- */
    /* å°‡åŸæœ¬çš„ -8px æ”¹ç‚º -15px (èˆ‡ hover ç‹€æ…‹ä¸€è‡´) */
    /* å°‡åŸæœ¬çš„ 1.02 æ”¹ç‚º 1.05 (èˆ‡ hover ç‹€æ…‹ä¸€è‡´) */
    transform: translateY(-15px) scale(1.05) !important;
    
    /* --- ä»¥ä¸‹å®Œå…¨ä¿ç•™æ‚¨åŸæœ¬çš„æ¨£å¼ï¼Œä¸ä½œä»»ä½•æ›´å‹• --- */
    filter: grayscale(0%);
    box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 50px rgba(255, 215, 0, 0.4);
    z-index: 15;
}

.anime-card.active .card-border-effect {
    border: 3px solid #FFD700;
    box-shadow: inset 0 0 15px rgba(255, 215, 0, 0.5);
}

.anime-card.active .card-overlay { background: linear-gradient(to top, rgba(184, 134, 11, 0.8) 0%, rgba(0,0,0,0.1) 100%); }
.anime-card.active .card-zh { color: #fff; text-shadow: 0 0 10px #FFD700; }
.anime-card.active .card-en { color: #FFD700; }
.anime-card.active .card-icon-container { color: #FFD700; transform: translateY(-5px) scale(1.1); }

@media (max-width: 600px) {
    .category-cards-container {
        justify-content: flex-start;
        padding-bottom: 20px;
    }
    .anime-card { width: 100px; height: 150px; }
    .card-zh { font-size: 16px; }
    .card-en { font-size: 8px; }
    .card-icon-container { font-size: 24px; margin-top: 30px; }
}

/* ========================================= */
/* === å¡ç‰‡æ’ç‰ˆçµ‚æ¥µä¿®å¾© (Fix Layout V2) === */
/* ========================================= */

/* 1. å¤–å±¤ç¶²æ ¼ï¼šç¢ºä¿æ¯å¼µå¡ç‰‡å¯¬åº¦è¢«é™åˆ¶ */
.guide-grid-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* å¼·åˆ¶ä¸‰æ¬„å‡åˆ† */
    gap: 25px;            /* å¡ç‰‡ä¹‹é–“çš„é–“è· */
    width: 100%;
    box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’çˆ†å¯¬åº¦ */
}

/* 2. å¡ç‰‡æœ¬é«”ï¼šå‚ç›´æ’åˆ— (æ¨™é¡Œåœ¨ä¸Šï¼Œå…§å®¹åœ¨ä¸‹) */
.guide-card {
    display: flex !important;
    flex-direction: column !important;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    height: 100%;         /* è®“å¡ç‰‡æ’æ»¿ç¶²æ ¼é«˜åº¦ */
    overflow: hidden;     /* é—œéµï¼šé˜²æ­¢å…§å®¹æº¢å‡ºåœ“è§’ */
    position: relative;
    box-sizing: border-box; /* é—œéµï¼šè®“å¯¬åº¦åŒ…å«é‚Šæ¡†èˆ‡å…§è· */
}

/* 3. æ¨™é¡Œå€åŸŸï¼šè—è‰²éƒ¨åˆ† */
.card-title, .seed-header {
    flex-shrink: 0;       /* ç¦æ­¢æ¨™é¡Œè¢«å£“ç¸® */
    width: 100%;
    padding: 15px;
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
    box-sizing: border-box; /* é˜²æ­¢æ¨™é¡Œæ–‡å­—æ’çˆ† */
}

/* 4. å…§å®¹å€åŸŸï¼šç™½è‰²æ–‡å­—éƒ¨åˆ† (ä¿®å¾©é‡é») */
.card-content, .seed-body {
    flex-grow: 1;         /* å¡«æ»¿å‰©é¤˜é«˜åº¦ */
    padding: 20px;        /* å…§é‚Šè· */
    
    /* === æ–‡å­—æ’ç‰ˆæ ¸å¿ƒä¿®å¾© === */
    font-size: 1rem;
    line-height: 1.8;     /* å¢åŠ è¡Œé«˜ï¼Œè®“æ–‡å­—ä¸æ“  */
    color: #444;
    text-align: justify;  /* å·¦å³å°é½Šï¼Œè®“æ–¹å¡Šæ›´æ•´é½Š */
    
    /* å¼·åˆ¶æ›è¡Œè¨­å®š */
    white-space: normal !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    word-break: break-word; /* é‡å°ä¸­è‹±æ–‡æ··æ’å„ªåŒ– */
    
    width: 100%;          /* ç¢ºä¿ä¸è¶…éå¡ç‰‡å¯¬åº¦ */
    box-sizing: border-box; /* é—œéµï¼šè®“ padding åŒ…å«åœ¨å¯¬åº¦å…§ */
}

/* 5. æ‰‹æ©Ÿç‰ˆé©é…ï¼šè®Šæˆå–®æ¬„ */
@media (max-width: 768px) {
    .guide-grid-3 {
        grid-template-columns: 1fr !important; /* æ‰‹æ©Ÿå¼·åˆ¶ä¸€æ¬„ */
    }
    .guide-card {
        margin-bottom: 20px;
        height: auto !important; /* æ‰‹æ©Ÿç‰ˆé«˜åº¦è‡ªå‹• */
    }
}

/* 5. é‡å°ä¸åŒé¡å‹çš„å¡ç‰‡é…è‰² */
/* è—è‰²å¡ç‰‡ (å¿ƒæƒ…/é¡Œçœ¼) */
.emotion-card {
    border-top: 5px solid #4A90E2;
}
.emotion-card .card-title {
    background-color: #f0f7ff;
    color: #0056b3;
}

/* ç¶ è‰²å¡ç‰‡ (ç¨®å­/å¯«ä½œæ–¹å‘) */
.seed-card {
    border-top: 5px solid #28a745;
}
.seed-card .seed-header {
    background-color: #f0fff4;
    color: #155724;
}

/* 6. ç¨®å­å¡ç‰‡å…§çš„æ®µè½æ¨™é¡Œ */
.seed-body p {
    margin-bottom: 12px;
}
.seed-body p:last-child {
    margin-bottom: 0;
}
.seed-body strong {
    color: #155724 !important; /* æ”¹ç‚ºæ·±ç¶ è‰² */
    display: inline-block;
    margin-bottom: 5px;
    font-size: 1.05rem;
    border-bottom: 2px solid rgba(40, 167, 69, 0.4) !important; /* æ”¹ç‚ºæ·ºç¶ è‰²åº•ç·š */
}

/* 7. æ‰‹æ©Ÿç‰ˆé©é…ï¼šå¼·åˆ¶å–®æ¬„ */
@media (max-width: 768px) {
    .guide-grid-3 {
        grid-template-columns: 1fr !important; /* å¼·åˆ¶è®Šç‚ºå–®æ¬„ */
        gap: 30px; /* å¢åŠ æ‰‹æ©Ÿç‰ˆå¡ç‰‡é–“è· */
        margin-bottom: 30px;
    }
    
    .guide-card {
        height: auto !important; /* æ‰‹æ©Ÿç‰ˆé«˜åº¦å®Œå…¨è‡ªå‹• */
        margin-bottom: 0; 
    }
}

/* 8. ä¸‹è¼‰æŒ‰éˆ•å®¹å™¨é˜²é‡ç–Šä¿®æ­£ */
.result-wrapper {
    margin-top: 40px; /* ç¢ºä¿æŒ‰éˆ•èˆ‡ä¸Šæ–¹å…§å®¹æœ‰è¶³å¤ è·é›¢ */
    padding-top: 20px;
    border-top: 1px dashed #ddd; /* å¢åŠ åˆ†éš”ç·šï¼Œè¦–è¦ºä¸Šå€éš” */
    width: 100%;
    clear: both; /* æ¸…é™¤æµ®å‹• */
}

#sideMenuToggle {
    position: fixed;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    z-index: 9998;
    width: 20px;
    height: 60px;
    border-radius: 8px 0 0 8px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-right: none;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
}

#sideMenuToggle:hover {
    background-color: rgba(0, 0, 0, 0.8);
    width: 24px;
}

.side-menu-overlay {
    position: fixed;
    top: 50%;
    right: -80px;
    transform: translateY(-50%);
    width: 60px;
    height: auto;
    background-color: rgba(30, 30, 30, 0.95);
    backdrop-filter: blur(10px);
    z-index: 9999;
    transition: right 0.3s ease;
    box-shadow: -4px 0 15px rgba(0, 0, 0, 0.5);
    border-radius: 12px 0 0 12px;
    padding: 10px 0;
}

.side-menu-overlay.active {
    right: 0;
}

.side-menu-content {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 0;
}

.side-menu-close {
    display: none; /* ç§»é™¤ç¨ç«‹é—œé–‰éµ */
}

.side-menu-items {
    margin-top: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 5px;
}

.side-menu-item {
    width: 100%;
    padding: 12px 0;
    background-color: transparent;
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.side-menu-item span {
    display: none; /* éš±è—æ–‡å­— */
}

.side-menu-item:hover {
    background-color: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

.side-menu-item i {
    font-size: 24px;
    width: 100%;
    text-align: center;
}

/* è®“å¡æ‰£æœ¬èº«ä¹Ÿèƒ½é—œé–‰é¸å–® */
#sideMenuToggle.active {
    background-color: rgba(255, 100, 100, 0.8);
}



/* === æ°¸é éš±è—ä¸»é çš„ã€Œå·¥å…·ä¸€è¦½ã€containerï¼ˆä½†ä¿ç•™ä»£ç¢¼ï¼‰=== */
#mainMenuBox ~ #toolsBox,
#toolsBox {
    display: none !important;
}

/* === æ‰‹æ©Ÿç‰ˆï¼šæ¯è¡Œ 2 å¼µå¡ç‰‡ï¼Œæœ€å¾Œä¸€å¼µæ”¾å¤§åˆ°å…©å¼µå¡ç‰‡å¯¬ === */
@media (max-width: 600px) {
    .category-cards-wrapper {
        padding: 20px 0 50px 0;
    }

    .category-cards-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        justify-items: center;
        padding: 10px 20px;
        overflow: hidden;
    }

    /* æ­£å¸¸å¡ç‰‡å¤§å°ï¼ˆå‰å››å¼µï¼‰ */
    .anime-card {
        width: 120px !important;
        height: 180px !important;
        flex-shrink: 0;
    }

    /* ç¬¬ 5 å¼µå¡ç‰‡ï¼šæ”¾å¤§åˆ°å…©å¼µå¡ç‰‡çš„ç¸½å¯¬åº¦ä¸¦å±…ä¸­ */
    .category-cards-container .anime-card:nth-child(5) {
        grid-column: 1 / -1;
        width: calc(120px * 2 + 24px) !important;  /* å…©å¼µå¯¬ + gap */
        height: 130px !important;
        max-width: none;
    }

    /* ç¬¬ 5 å¼µå¡ç‰‡å…§æ–‡å­—åœ–æ¨™å¾®èª¿ï¼ˆå¯é¸ï¼Œè¦–è¦ºæ›´çªå‡ºï¼‰ */
    .category-cards-container .anime-card:nth-child(5) .card-zh {
        font-size: 22px;
    }
    .category-cards-container .anime-card:nth-child(5) .card-en {
        font-size: 13px;
    }
    .category-cards-container .anime-card:nth-child(5) .card-icon-container {
        font-size: 34px;
        margin-top: 45px;
    }

    .card-zh {
        font-size: 18px;
    }
    .card-icon-container {
        font-size: 28px;
        margin-top: 40px;
    }
}

/* === ç…™èŠ±ç‰¹æ•ˆç•«å¸ƒ === */
#fireworksCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 99999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    pointer-events: none; /* è®“æ»‘é¼ é»æ“Šå¯ä»¥ç©¿é€ç…™èŠ±ï¼Œä¸å½±éŸ¿æŒ‰éˆ•æ“ä½œ */
    display: none; /* é è¨­éš±è— */
}

/* ========================================= */
/* === ç¥æ€å°ˆç”¨ï¼šæ–‡è—é¢¨åŸç¨¿ç´™ UI è¨­è¨ˆ (RWD çµ‚æ¥µç‰ˆ) === */
/* ========================================= */

/* --- 1. é›»è…¦ç‰ˆé è¨­æ¨£å¼ (å¤§æ ¼ã€å¤§å­—) --- */
/* --- 1. é›»è…¦ç‰ˆé è¨­æ¨£å¼ (å¤§æ ¼ã€å¤§å­—) --- */
/* å°‡åŸæœ¬é•·ä¸²çš„ ID é¸æ“‡å™¨æ”¹æˆå–®ç´”çš„ textareaï¼Œé€™æ¨£æ‰€æœ‰å¤šè¡Œè¼¸å…¥æ¡†éƒ½æœƒç”Ÿæ•ˆ */
/* --- 1. é›»è…¦ç‰ˆé è¨­æ¨£å¼ (å¤§æ ¼ã€å¤§å­—) --- */
/* åŠ å…¥ input[type="text"] è®“å–®è¡Œè¼¸å…¥æ¡†ï¼ˆå¦‚æ›¸åã€ä½œè€…ï¼‰ä¹Ÿç”Ÿæ•ˆ */
textarea, input[type="text"] {
    /* é˜²æ­¢çˆ†ç‰ˆæ ¸å¿ƒè¨­å®š */
    box-sizing: border-box !important;
    width: 100% !important;
    max-width: 100% !important;
    
    /* å­—é«”èˆ‡è¡Œé«˜ (é…åˆ 40px æ ¼å­) */
    font-family: 'Noto Serif TC', 'Songti TC', serif !important;
    font-size: 20px !important;       
    line-height: 40px !important;     
    color: #2c3e50;                   
    letter-spacing: 2px;              
    
    /* åŸç¨¿ç´™èƒŒæ™¯ (40px é«˜) */
    background-color: #fffcf6 !important;        
    background-image: 
        linear-gradient(transparent 39px, rgba(42, 150, 137, 0.3) 39px, rgba(42, 150, 137, 0.3) 40px, transparent 40px),
        linear-gradient(90deg, transparent 39px, rgba(0,0,0,0.03) 39px, rgba(0,0,0,0.03) 40px, transparent 40px) !important;
    background-size: 40px 40px !important;       
    background-attachment: local;     
    
    /* é‚Šæ¡†èˆ‡é™°å½± */
    border: 2px solid #8baea8 !important;        
    border-radius: 8px !important;               
    padding: 0 18px !important;       
    box-shadow: 
        inset 0 0 40px rgba(0,0,0,0.02),  
        5px 5px 0px rgba(42, 150, 137, 0.15); 
        
    transition: all 0.3s ease;
    resize: vertical;                 
}

/* äº’å‹•æ•ˆæœ - é»æ“Šæ™‚åŠ æ·±é™°å½± */
textarea:focus, input[type="text"]:focus {
    background-color: #fff !important;           
    border-color: #2A9689 !important;            
    outline: none;
    box-shadow: 
        inset 0 0 10px rgba(42, 150, 137, 0.1), 
        8px 8px 0px rgba(42, 150, 137, 0.25); 
    transform: translateY(-2px);      
}

/* Placeholder æ¨£å¼ */
textarea::placeholder, input[type="text"]::placeholder {
    color: rgba(42, 150, 137, 0.4);   
    font-style: italic;               
    font-size: 16px;
    letter-spacing: 1px;
}

/* --- 2. æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼èª¿æ•´ (è¢å¹•å¯¬åº¦å°æ–¼ 600px) --- */
/* --- 2. æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼èª¿æ•´ (è¢å¹•å¯¬åº¦å°æ–¼ 600px) --- */
@media (max-width: 600px) {
    /* åŒæ¨£åŠ å…¥ input[type="text"] */
    textarea, input[type="text"] {
        /* å­—é«”ç¸®å°ï¼Œé©é…çª„è¢å¹• */
        font-size: 16px !important;
        letter-spacing: 1px !important;
        
        /* è¡Œé«˜ç¸®å°è‡³ 32px (æ›´ç·Šæ¹Š) */
        line-height: 32px !important;
        
        /* é‡æ–°ç¹ªè£½èƒŒæ™¯æ ¼ç·š (é…åˆ 32px é«˜åº¦) */
        background-image: 
            /* 31px é€æ˜ + 1px ç·šæ¢ = 32px */
            linear-gradient(transparent 31px, rgba(42, 150, 137, 0.3) 31px, rgba(42, 150, 137, 0.3) 32px, transparent 32px),
            linear-gradient(90deg, transparent 31px, rgba(0,0,0,0.03) 31px, rgba(0,0,0,0.03) 32px, transparent 32px) !important;
        background-size: 32px 32px !important;
        
        /* æ¸›å°‘å…§é‚Šè·ï¼Œçˆ­å–æ›¸å¯«ç©ºé–“ */
        padding: 0 10px !important;
        
        /* ç¸®å°é™°å½± */
        box-shadow: 
            inset 0 0 20px rgba(0,0,0,0.02),  
            3px 3px 0px rgba(42, 150, 137, 0.15) !important;
    }
    
    /* æ‰‹æ©Ÿç‰ˆèšç„¦æ•ˆæœå¾®èª¿ */
    textarea:focus, input[type="text"]:focus {
        box-shadow: 
            inset 0 0 10px rgba(42, 150, 137, 0.1), 
            4px 4px 0px rgba(42, 150, 137, 0.25) !important;
        transform: translateY(-1px); 
    }
}
/* æ‡¸æµ®è¦–çª—æ¨™é¡Œç¾åŒ– (é€šç”¨) */
.outline-modal-content h3 {
    color: #2A9689;
    font-family: 'Noto Serif TC', serif;
    border-bottom: 2px dashed #a8dad5;
    padding-bottom: 12px;
    margin-bottom: 20px;
    text-align: center;
    letter-spacing: 2px;
}

	/* ========================================= */
/* === ç°è—è‰²åŸç¨¿ç´™é¢¨æ ¼ï¼šä¸‹æ‹‰é¸å–®å°ˆç”¨æ¨£å¼ === */
/* ========================================= */

select {
    /* 1. åŸºç¤å­—é«”èˆ‡æ’ç‰ˆ */
    font-family: 'Noto Serif TC', 'Songti TC', serif !important;
    font-size: 18px !important;
    font-weight: bold !important;
    line-height: 40px !important; /* é…åˆæ ¼ç·šé«˜åº¦ */
    color: #455A64 !important;    /* æ·±ç°è—æ–‡å­— (Blue Grey 700) */
    letter-spacing: 1px;
    padding: 0 40px 0 15px !important; /* å³é‚Šé ç•™ç®­é ­ç©ºé–“ */
    height: 44px !important;      /* å›ºå®šé«˜åº¦ç¢ºä¿æ ¼ç·šå°é½Š */
    width: 100%;
    margin: 10px 0;
    box-sizing: border-box;

    /* 2. èƒŒæ™¯è¨­å®š - ç°è—è‰²åŸç¨¿ç´™ */
    background-color: #ECEFF1 !important; /* æ·ºç°è—åº•è‰² (Blue Grey 50) */
    
    /* ç¹ªè£½åº•ç·šï¼šé€æ˜ -> ç°è—ç·šæ¢ -> é€æ˜ + è‡ªå®šç¾©ç®­é ­ */
    background-image:
        /* æ ¼ç·šï¼š38pxé€æ˜ + 2px ç·šæ¢ = 40px */
        linear-gradient(transparent 38px, rgba(120, 144, 156, 0.4) 38px, rgba(120, 144, 156, 0.4) 40px, transparent 40px),
        /* ä¸‹æ‹‰ç®­é ­åœ–ç¤º (æ·±ç°è—è‰²) */
        url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23455A64%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") !important;
    
    background-repeat: no-repeat, no-repeat;
    background-position: center, right 15px center; /* æ ¼ç·šç½®ä¸­ï¼Œç®­é ­é å³ */
    background-size: 40px 40px, 12px 12px;          /* æ ¼ç·šå¤§å°ï¼Œç®­é ­å¤§å° */
    background-attachment: local, scroll;           /* è®“èƒŒæ™¯éš¨å…§å®¹æ»¾å‹•(é›–ç„¶selectå¾ˆå°‘æ»¾å‹•) */

    /* 3. é‚Šæ¡†èˆ‡å¤–è§€ */
    border: 2px solid #90A4AE !important; /* ä¸­ç°è—é‚Šæ¡† (Blue Grey 300) */
    border-radius: 8px !important;
    
    /* å¢åŠ ä¸€é»ç´™å¼µåšåº¦æ„Ÿ */
    box-shadow: 
        inset 0 0 20px rgba(255,255,255,0.5), /* å…§éƒ¨å¾®å…‰ */
        3px 3px 0px rgba(144, 164, 174, 0.3) !important; /* å³ä¸‹è§’é™°å½± */
        
    /* ç§»é™¤ç€è¦½å™¨é è¨­å¤–è§€ */
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* äº’å‹•æ•ˆæœï¼šæ»‘é¼ æ‡¸åœæˆ–é»æ“Šæ™‚ */
select:focus, select:hover {
    background-color: #FFFFFF !important; /* è®Šäº® */
    border-color: #607D8B !important;     /* é‚Šæ¡†è®Šæ·± (Blue Grey 500) */
    outline: none;
    transform: translateY(-2px);          /* è¼•å¾®æµ®èµ· */
    box-shadow: 
        inset 0 0 10px rgba(84, 110, 122, 0.1),
        5px 5px 0px rgba(84, 110, 122, 0.3) !important;
}

/* é‡å°éŸ³æ¨‚æ’­æ”¾å™¨å…§çš„å°é¸å–®é€²è¡Œå¾®èª¿ (é¿å…è®Šå¾—å¤ªå¤§) */
#music-player .controls select, 
#music-player .mode select {
    height: 30px !important;
    line-height: 26px !important;
    font-size: 14px !important;
    padding: 0 25px 0 10px !important;
    background-size: 30px 30px, 10px 10px !important; /* ç¸®å°æ ¼ç·šå’Œç®­é ­ */
    background-image:
        linear-gradient(transparent 28px, rgba(120, 144, 156, 0.4) 28px, rgba(120, 144, 156, 0.4) 30px, transparent 30px),
        url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23455A64%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") !important;
}

/* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼èª¿æ•´ */
@media (max-width: 600px) {
    select {
        font-size: 16px !important;
        height: 36px !important;
        line-height: 32px !important; /* æ‰‹æ©Ÿç‰ˆæ ¼ç·šé«˜åº¦ç¸®å° */
        background-position: center, right 10px center;
        
        /* é‡æ–°ç¹ªè£½ 32px é«˜åº¦çš„æ ¼ç·š */
        background-image:
            linear-gradient(transparent 30px, rgba(120, 144, 156, 0.4) 30px, rgba(120, 144, 156, 0.4) 32px, transparent 32px),
            url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23455A64%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") !important;
        background-size: 32px 32px, 10px 10px !important;
        
        box-shadow: 
            inset 0 0 10px rgba(255,255,255,0.5),
            2px 2px 0px rgba(144, 164, 174, 0.3) !important;
    }
}

/* ==========================================
   === æ–‡è—é¢¨æ­·å²ç´€éŒ„å¡ç‰‡ (è«è˜­è¿ªè‰²ç³») ===
   ========================================== */

/* å®šç¾©è«è˜­è¿ªè‰²è®Šæ•¸ */
:root {
    --morandi-bg: #fdfcf8;          /* ç±³ç™½ç´™å¼µåº•è‰² */
    --morandi-text: #5e5e5e;        /* æ·±ç°æ–‡å­— */
    --morandi-green: #8fa398;       /* é–±è®€ - ç°ç¶  */
    --morandi-blue: #94a7b5;        /* æ•˜äº‹ - éœ§éœ¾è— */
    --morandi-purple: #b6a6ca;      /* è­°è«– - é¦™èŠ‹ç´« */
    --morandi-red: #d69a92;         /* æ‹“å±• - è±†æ²™ç´… */
    --morandi-border: #e0ddd7;      /* æ·ºå¡å…¶é‚Šæ¡† */
    --morandi-shadow: rgba(149, 157, 165, 0.1);
}

/* åˆ—è¡¨å®¹å™¨èª¿æ•´ */
.history-list-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* æ”¹ç‚ºç¶²æ ¼æ’åˆ— */
    gap: 20px;
    padding: 10px;
    max-height: 70vh;
    overflow-y: auto;
}

/* ==========================================
   === æ­·å²ç´€éŒ„å¡ç‰‡ï¼šNote Card æ‰“æ´é¢¨æ ¼ ===
   ========================================== */

.history-card {
    /* 1. åŸºç¤å¡ç‰‡è¨­å®š */
    background-color: var(--morandi-bg);
    border: 1px solid var(--morandi-border); /* çµ±ä¸€ä½¿ç”¨ç´°é‚Šæ¡† */
    border-radius: 8px; 
    padding: 20px;
    position: relative;
    box-shadow: 4px 4px 0px rgba(0,0,0,0.03);
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    overflow: hidden;

    /* 2. Note Card é—œéµæ¨£å¼ï¼šæ‰“æ´èˆ‡åˆ†éš”ç·š */
    padding-left: 55px !important; /* å·¦å´ç•™ç™½çµ¦æ‰“æ´å€ */
    
    background-image: 
        /* A. å‚ç›´åˆ†éš”ç·š (æ¨¡æ“¬ç´…ç·šæˆ–ç°ç·šï¼Œé€™è£¡ç”¨è«è˜­è¿ªç° #e0ddd7) */
        linear-gradient(to right, transparent 39px, #e0ddd7 40px, transparent 41px),
        /* B. æ‰“æ´æ•ˆæœ (æ¨¡æ“¬å­”æ´ï¼Œä½¿ç”¨æ·±ç°è‰²åœ“å½¢ #d1cdc5) */
        radial-gradient(circle at 20px 50%, #d1cdc5 6px, transparent 7px);
    
    /* è¨­å®šèƒŒæ™¯åœ–å±¤å¤§å° */
    background-size: 
        100% 100%, /* åˆ†éš”ç·šï¼šæ’æ»¿æ•´å¼µå¡ç‰‡ */
        100% 35px; /* æ‰“æ´ï¼šæ¯ 35px é‡è¤‡ä¸€é¡† */
    
    /* è¨­å®šèƒŒæ™¯é‡è¤‡æ–¹å¼ */
    background-repeat: 
        no-repeat, /* åˆ†éš”ç·šä¸é‡è¤‡ */
        repeat-y;  /* æ‰“æ´åœ¨å‚ç›´æ–¹å‘é‡è¤‡ */
        
    /* è¨­å®šèµ·å§‹ä½ç½® */
    background-position: 
        0 0,       /* åˆ†éš”ç·šä½ç½® */
        0 12px;    /* æ‰“æ´èµ·å§‹ä½ç½®å‘ä¸‹å¾®èª¿ï¼Œé¿å…åˆ‡åˆ°é ‚éƒ¨è‰²æ¢ */
}

/* 3. é ‚éƒ¨è£é£¾æ¢ (ä¿ç•™æ‚¨è¦æ±‚çš„é ‚éƒ¨è‰²æ¢) */
.history-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px; /* é ‚éƒ¨è‰²æ¢é«˜åº¦ */
    background-color: #ccc; /* é è¨­é¡è‰²ï¼Œæœƒè¢«ä¸‹æ–¹ Theme è¦†è“‹ */
    opacity: 0.8;
    z-index: 1;
}

/* 4. æ‡¸åœæ•ˆæœ */
.history-card:hover {
    transform: translateY(-3px);
    box-shadow: 6px 6px 0px rgba(0,0,0,0.05);
    border-color: #d1cdc5;
    /* ç¢ºä¿ Hover æ™‚ä¸æœƒå‡ºç¾å·¦å´ç²—è‰²æ¢ï¼Œä¿æŒæ‰“æ´é¢¨æ ¼ */
    border-left-width: 1px;
    border-left-style: solid;
}

/* 5. é¡è‰²ä¸»é¡Œè¨­å®š (åªæ”¹è®Šé ‚éƒ¨è‰²æ¢èˆ‡æ¨™ç±¤é¡è‰²) */

/* Theme 1 (ç°ç¶ ) */
.history-card.history-theme-1::before { background-color: var(--m-color-1); }
.history-card.history-theme-1 .history-tag { background-color: var(--m-color-1); }
.history-card.history-theme-1:hover { border-left-color: var(--morandi-border); }

/* Theme 2 (éœ§éœ¾è—) */
.history-card.history-theme-2::before { background-color: var(--m-color-2); }
.history-card.history-theme-2 .history-tag { background-color: var(--m-color-2); }
.history-card.history-theme-2:hover { border-left-color: var(--morandi-border); }

/* Theme 3 (é¦™èŠ‹ç´«) */
.history-card.history-theme-3::before { background-color: var(--m-color-3); }
.history-card.history-theme-3 .history-tag { background-color: var(--m-color-3); }
.history-card.history-theme-3:hover { border-left-color: var(--morandi-border); }

/* Theme 4 (è±†æ²™ç´…) */
.history-card.history-theme-4::before { background-color: var(--m-color-4); }
.history-card.history-theme-4 .history-tag { background-color: var(--m-color-4); }
.history-card.history-theme-4:hover { border-left-color: var(--morandi-border); }

/* Theme 5 (å¥¶èŒ¶æ£•) */
.history-card.history-theme-5::before { background-color: var(--m-color-5); }
.history-card.history-theme-5 .history-tag { background-color: var(--m-color-5); }
.history-card.history-theme-5:hover { border-left-color: var(--morandi-border); }
/* ä¸åŒç¯„ç–‡çš„é¡è‰²æ¨™è¨˜ */
.history-card.type-reading { border-left-color: #28a745; }   /* é–±è®€-ç¶  */
.history-card.type-narrative { border-left-color: #007bff; } /* æ•˜äº‹-è— */
.history-card.type-argument { border-left-color: #800080; }  /* è­°è«–-ç´« */
.history-card.type-expand { border-left-color: #dc3545; }    /* æ‹“å±•-ç´… */



.history-meta {
    font-size: 0.85em;
    color: #888;
    margin-bottom: 5px;
}

.history-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    background-color: #eee;
    color: #555;
    font-size: 0.8em;
    margin-right: 8px;
    font-weight: bold;
}

.history-title {
    font-size: 1.1em;
    font-weight: bold;
    color: #333;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* æ“ä½œå€ (åˆªé™¤æŒ‰éˆ•) */
.history-actions {
    margin-top: 15px;
    display: flex;
    justify-content: flex-end;
    opacity: 0.6;
    transition: opacity 0.3s;
}

.history-card:hover .history-actions {
    opacity: 1;
}


.btn-delete-history {
    background-color: transparent;
    border: 1px solid #dc3545;
    color: #dc3545;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-delete-history:hover {
    background-color: #dc3545;
    color: white;
}

/* 3. æ¨¡æ…‹è¦–çª—å…§å®¹ç¾åŒ– */
#historyModalContent {
    line-height: 1.6;
    font-size: 1.1em;
}

#historyModalContent h3 {
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
    margin-top: 20px;
    color: #0056b3;
}

/* 4. æ–°å¢ï¼šå±¤ç´šé¸å–® (Grid Menu) æ¨£å¼ (Level 1 & 2) */
.history-grid-menu {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* è‡ªå‹•é©æ‡‰å¯¬åº¦ */
    gap: 15px;
    padding: 10px 0;
}

.history-folder-btn {
    background-color: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #555;
    min-height: 100px; /* ç¢ºä¿æŒ‰éˆ•æœ‰è¶³å¤ é«˜åº¦ */
}

.history-folder-btn:hover {
    background-color: #fff;
    border-color: #007bff;
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.15);
    color: #007bff;
}

.history-folder-btn i {
    font-size: 2em;
    margin-bottom: 10px;
    color: #6c757d;
    transition: color 0.3s ease;
}

.history-folder-btn:hover i {
    color: #007bff;
}

.history-folder-btn span {
    font-weight: bold;
    font-size: 1.1em;
}

/* 5. æ–°å¢ï¼šéºµåŒ…å±‘å°èˆªæ¨£å¼ */
.history-breadcrumb span:hover {
    text-decoration: underline;
}

/* 6. æ–°å¢ï¼šé›·é”åœ–åœ–ç‰‡åŒ–æ¨£å¼ (ç¢ºä¿ Canvas è½‰åœ–å¾Œåœ¨æ­·å²ç´€éŒ„ä¸­æ­£ç¢ºé¡¯ç¤º) */
.radar-chart-history-img {
    width: 100% !important;
    max-width: 500px;
    height: auto !important;
    margin: 0 auto;
    display: block;
    border: 1px solid #eee; /* é¸ç”¨ï¼šå¢åŠ é‚Šæ¡†è®“åœ–è¡¨æ›´æ¸…æ™° */
    border-radius: 8px;
    padding: 10px;
    background-color: #fff;
}

	/* ç¢ºä¿æ­·å²ç´€éŒ„å…§çš„å¡ç‰‡å®¹å™¨ä¸æœƒæœ‰éå¤šçš„ä¸Šä¸‹ç•™ç™½ */
#historyContainer .category-cards-wrapper {
    margin-top: 0;
    margin-bottom: 0;
}

/* è®“éºµåŒ…å±‘å°èˆªæ›´æ˜é¡¯ */
.history-breadcrumb {
    transition: all 0.3s ease;
}
.history-breadcrumb span:hover {
    opacity: 0.8;
}

/* === æ–°å¢ï¼šæ¨™é ­çš„ä½èª¿æ¸…ç©ºæŒ‰éˆ• === */
.history-clear-btn {
    background: transparent;
    border: 1px solid transparent; /* é è¨­ç„¡é‚Šæ¡† */
    color: #aaa; /* æ·ºç°è‰²ï¼Œéå¸¸ä½èª¿ */
    font-size: 1.2rem;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.history-clear-btn:hover {
    color: #d9534f; /* æ‡¸åœæ™‚æ‰è®Šç´… */
    background-color: rgba(217, 83, 79, 0.1); /* æ·¡æ·¡çš„ç´…è‰²èƒŒæ™¯ */
    transform: rotate(15deg); /* å¢åŠ ä¸€é»é»äº’å‹•è¶£å‘³ */
}


/* å…§å®¹ä½ˆå±€ */
.history-info {
    flex-grow: 1;
}

/* æ¨™é¡Œæ¨£å¼ï¼šè¥¯ç·šå­—é«”ï¼Œæ–‡è—æ„Ÿ */
.history-title {
    font-family: 'Noto Serif TC', serif;
    font-size: 1.15em;
    font-weight: 600;
    color: #4a4a4a;
    margin: 10px 0;
    line-height: 1.5;
    
    /* å¤šè¡Œçœç•¥ */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* æ—¥æœŸèˆ‡æ¨™ç±¤å€åŸŸ */
.history-meta {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px dashed var(--morandi-border); /* è™›ç·šåˆ†éš” */
}

.history-date {
    font-family: 'Courier New', monospace; /* æ‰“å­—æ©Ÿå­—é«” */
    font-size: 0.85em;
    color: #999;
    letter-spacing: 1px;
}

/* ç¯„ç–‡æ¨™ç±¤ (åƒè²¼ç´™) */
.history-tag {
    font-size: 0.75em;
    padding: 2px 8px;
    border-radius: 4px;
    margin-right: auto; /* å°‡æ—¥æœŸæ¨åˆ°å³é‚Š */
    color: #fff;
    font-weight: normal;
    letter-spacing: 1px;
}



	
/* åˆªé™¤æŒ‰éˆ•ç¾åŒ– */
.btn-delete-history {
    background: transparent;
    border: none;
    color: #bfaea8; /* æ·ºç´…æ£•è‰² */
    font-size: 1.1em;
    cursor: pointer;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 50%;
}

.btn-delete-history:hover {
    color: #d69a92;
    background-color: rgba(214, 154, 146, 0.1);
    transform: scale(1.1);
}

/* ==========================================
   === æ­·å²ç´€éŒ„æ¨£å¼ä¿®è¨‚ (å¤šè‰²å¡ç‰‡ & å°èˆªç¾åŒ–) ===
   ========================================== */

/* 1. å®šç¾© 5 ç¨®è«è˜­è¿ªè¼ªæ›¿è‰² (ç”¨æ–¼åŒä¸€åˆ—è¡¨ä¸­çš„ä¸åŒå¡ç‰‡) */
/* è®“åŒä¸€å€‹åˆ—è¡¨ä¸­çš„å¡ç‰‡æ“æœ‰ä¸åŒé¡è‰²ï¼Œä»¥ä½œå€åˆ† */
.history-card.accent-1::before { background-color: #8fa398; } /* ç°ç¶  */
.history-card.accent-1 .history-tag { background-color: #8fa398; }
.history-card.accent-1:hover { border-color: #8fa398; }

.history-card.accent-2::before { background-color: #94a7b5; } /* éœ§éœ¾è— */
.history-card.accent-2 .history-tag { background-color: #94a7b5; }
.history-card.accent-2:hover { border-color: #94a7b5; }

.history-card.accent-3::before { background-color: #b6a6ca; } /* é¦™èŠ‹ç´« */
.history-card.accent-3 .history-tag { background-color: #b6a6ca; }
.history-card.accent-3:hover { border-color: #b6a6ca; }

.history-card.accent-4::before { background-color: #d69a92; } /* è±†æ²™ç´… */
.history-card.accent-4 .history-tag { background-color: #d69a92; }
.history-card.accent-4:hover { border-color: #d69a92; }

.history-card.accent-5::before { background-color: #c7b299; } /* å¥¶èŒ¶æ£• */
.history-card.accent-5 .history-tag { background-color: #c7b299; }
.history-card.accent-5:hover { border-color: #c7b299; }

/* 2. éºµåŒ…å±‘å°èˆª (é¡è‰²å€åˆ†ä¿®è¨‚) */
.history-breadcrumb {
    background-color: transparent !important;
    border: none !important;
    border-bottom: 1px dashed #d1cdc5 !important;
    padding: 10px 5px !important;
    margin-bottom: 25px;
    font-size: 1rem;
    color: #999; /* åˆ†éš”ç¬¦é¡è‰² */
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ç¬¬ä¸€å±¤ï¼šä¸»ç¯„ç–‡ (è—è‰²ï¼Œå¯é»æ“Š) */
.history-breadcrumb span[onclick*="renderHistoryCategories"] {
    color: #007bff !important; 
    font-weight: 900;
    cursor: pointer;
}

/* ç¬¬äºŒå±¤ï¼šå­åŠŸèƒ½åˆ†é¡ (æ·±ç°è‰²ï¼Œå¯é»æ“Š) */
.history-breadcrumb span[onclick*="enterHistoryCategory"] {
    color: #555 !important; 
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
}
.history-breadcrumb span[onclick*="enterHistoryCategory"]:hover {
    color: #007bff !important;
    text-decoration: underline;
}

/* ç¬¬ä¸‰å±¤ï¼šç•¶å‰é é¢ (éœ§éœ¾è—ï¼Œä¸å¯é»æ“Š) */
.history-breadcrumb span#breadcrumb-sub {
    color: #94a7b5 !important; 
    font-weight: bold;
    padding: 2px 4px;
    background-color: rgba(148, 167, 181, 0.1);
    border-radius: 4px;
}

/* åˆ†éš”ç¬¦è™Ÿ */
.history-breadcrumb span[id^="breadcrumb-sep"] {
    color: #ccc !important;
    font-weight: normal;
}

/* 3. å¡ç‰‡ç´°ç¯€å¾®èª¿ (ç¢ºä¿æ—¥æœŸèˆ‡æ¨™ç±¤æ’ç‰ˆ) */
.history-meta {
    border-bottom: 1px dashed #e0ddd7;
    padding-bottom: 8px;
    margin-bottom: 10px;
    display: flex; /* ç¢ºä¿å·¦å³å°é½Š */
    justify-content: space-between; /* æ¨™ç±¤é å·¦ï¼Œæ—¥æœŸé å³ */
    align-items: center;
}

.history-date {
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    color: #aaa;
    letter-spacing: 0px;
    margin-left: auto; /* å¼·åˆ¶é å³ */
}

.history-tag {
    color: white;
    font-size: 0.75em;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: normal;
    letter-spacing: 1px;
}

/* æ‰‹æ©Ÿç‰ˆé©é… */
@media (max-width: 600px) {
    .history-list-container {
        grid-template-columns: 1fr; /* æ‰‹æ©Ÿå–®æ¬„ */
    }
}

	/* æœå°‹åˆ°çš„å¡ç‰‡é«˜äº®å‹•ç•« */
@keyframes highlight-card {
    0% { transform: scale(1); box-shadow: 0 0 0 rgba(40, 167, 69, 0); }
    50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(40, 167, 69, 0.5); border-left-color: #28a745; }
    100% { transform: scale(1); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
}

.history-card.highlighted {
    animation: highlight-card 1.5s ease-in-out;
    background-color: #f0fff4; /* æ·¡æ·¡çš„ç¶ è‰²èƒŒæ™¯ */
}

	/* === å®šç¾©è«è˜­è¿ªè‰²ç³»è®Šæ•¸ === */
:root {
    --m-color-1: #8fa398; /* ç°ç¶  */
    --m-color-2: #94a7b5; /* éœ§éœ¾è— */
    --m-color-3: #b6a6ca; /* é¦™èŠ‹ç´« */
    --m-color-4: #d69a92; /* è±†æ²™ç´… */
    --m-color-5: #c7b299; /* å¥¶èŒ¶æ£• */
}

/* === ä¿®æ”¹ï¼šæ­·å²ç´€éŒ„å°èˆªåˆ— (éºµåŒ…å±‘) === */
/* éœ€æ±‚ä¸‰ï¼šä¸»ç¯„ç–‡è¦è«è¿ªè˜­è‰²ï¼Œä¸è¦è—è‰² */
.history-breadcrumb span[onclick*="renderHistoryCategories"] {
    color: #6a7a7d !important; /* è«è˜­è¿ªæ·±ç°è— */
    font-weight: 900;
    cursor: pointer;
    transition: color 0.3s;
}
.history-breadcrumb span[onclick*="renderHistoryCategories"]:hover {
    color: #8c9ea1 !important;
}

/* === ä¿®æ”¹ï¼šå­åŠŸèƒ½æŒ‰éˆ• (Level 2) çš„é¡è‰²é‚è¼¯ === */
/* éœ€æ±‚ä¸€ï¼šå­åŠŸèƒ½å¡ç‰‡è¦ä¸åŒé¡è‰² */
.history-folder-btn.history-theme-1 { border-color: var(--m-color-1); color: var(--m-color-1); }
.history-folder-btn.history-theme-1 i { color: var(--m-color-1); }
.history-folder-btn.history-theme-1:hover { background-color: var(--m-color-1); color: white; }
.history-folder-btn.history-theme-1:hover i { color: white; }

.history-folder-btn.history-theme-2 { border-color: var(--m-color-2); color: var(--m-color-2); }
.history-folder-btn.history-theme-2 i { color: var(--m-color-2); }
.history-folder-btn.history-theme-2:hover { background-color: var(--m-color-2); color: white; }
.history-folder-btn.history-theme-2:hover i { color: white; }

.history-folder-btn.history-theme-3 { border-color: var(--m-color-3); color: var(--m-color-3); }
.history-folder-btn.history-theme-3 i { color: var(--m-color-3); }
.history-folder-btn.history-theme-3:hover { background-color: var(--m-color-3); color: white; }
.history-folder-btn.history-theme-3:hover i { color: white; }

.history-folder-btn.history-theme-4 { border-color: var(--m-color-4); color: var(--m-color-4); }
.history-folder-btn.history-theme-4 i { color: var(--m-color-4); }
.history-folder-btn.history-theme-4:hover { background-color: var(--m-color-4); color: white; }
.history-folder-btn.history-theme-4:hover i { color: white; }

.history-folder-btn.history-theme-5 { border-color: var(--m-color-5); color: var(--m-color-5); }
.history-folder-btn.history-theme-5 i { color: var(--m-color-5); }
.history-folder-btn.history-theme-5:hover { background-color: var(--m-color-5); color: white; }
.history-folder-btn.history-theme-5:hover i { color: white; }

/* === ä¿®æ”¹ï¼šç´€éŒ„å¡ç‰‡ (Level 3) çš„é¡è‰²é‚è¼¯ === */
/* éœ€æ±‚ï¼šå¡ç‰‡å·¦å´ä¸è¦æœ‰è‰²æ¢ï¼Œä¿ç•™é ‚éƒ¨è‰²æ¢(::before)èˆ‡æ¨™ç±¤é¡è‰² */

/* ç¢ºä¿æ‰€æœ‰ä¸»é¡Œå¡ç‰‡çš„å·¦é‚Šæ¡†å›æ­¸é è¨­æ¨£å¼ (ç„¡ç²—è‰²æ¢) */
.history-card {
    border-left: 1px solid var(--morandi-border) !important;
}

/* Theme 1 (ç°ç¶ ) */
.history-card.history-theme-1::before { background-color: var(--m-color-1); }
.history-card.history-theme-1 .history-tag { background-color: var(--m-color-1); }
/* ç¢ºä¿ hover æ™‚ä¹Ÿä¸æœƒå‡ºç¾å·¦å´è‰²æ¢ï¼ŒåªåŠ æ·±é™°å½± */
.history-card.history-theme-1:hover { border-left-color: var(--morandi-border); }

/* Theme 2 (éœ§éœ¾è—) */
.history-card.history-theme-2::before { background-color: var(--m-color-2); }
.history-card.history-theme-2 .history-tag { background-color: var(--m-color-2); }
.history-card.history-theme-2:hover { border-left-color: var(--morandi-border); }

/* Theme 3 (é¦™èŠ‹ç´«) */
.history-card.history-theme-3::before { background-color: var(--m-color-3); }
.history-card.history-theme-3 .history-tag { background-color: var(--m-color-3); }
.history-card.history-theme-3:hover { border-left-color: var(--morandi-border); }

/* Theme 4 (è±†æ²™ç´…) */
.history-card.history-theme-4::before { background-color: var(--m-color-4); }
.history-card.history-theme-4 .history-tag { background-color: var(--m-color-4); }
.history-card.history-theme-4:hover { border-left-color: var(--morandi-border); }

/* Theme 5 (å¥¶èŒ¶æ£•) */
.history-card.history-theme-5::before { background-color: var(--m-color-5); }
.history-card.history-theme-5 .history-tag { background-color: var(--m-color-5); }
.history-card.history-theme-5:hover { border-left-color: var(--morandi-border); }

/* === æ­·å²ç´€éŒ„ï¼šè¼¸å…¥å…§å®¹å„ªåŒ–æ¨£å¼ === */
.history-input-card {
    background-color: #fdfdfd;
    border: 1px solid #e0e0e0;
    border-left: 5px solid #6a7a7d; /* è«è˜­è¿ªæ·±ç°è—è£é£¾ç·š */
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.history-input-header {
    margin-top: 0;
    margin-bottom: 15px;
    color: #4a4a4a;
    font-size: 1.1em;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px dashed #ddd;
    padding-bottom: 10px;
}

.history-input-body {
    font-family: 'Noto Serif TC', serif; /* ä¿æŒæ–‡è—å­—é«” */
    font-size: 1rem;
    line-height: 1.8; /* å¢åŠ è¡Œé«˜ï¼Œé¿å…æ–‡å­—æ“ åœ¨ä¸€èµ· */
    color: #333;
    white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
    word-wrap: break-word;
}

/* è‡ªå‹•å°‡ã€Œæ¨™ç±¤ã€åŠ ç²—çš„æ¨£å¼ (é…åˆ JS ä½¿ç”¨) */
.history-label-bold {
    font-weight: 700;
    color: #2c3e50;
    background-color: rgba(0,0,0,0.03);
    padding: 2px 6px;
    border-radius: 4px;
    margin-right: 5px;
}

	/* === æ­·å²ç´€éŒ„ï¼šçµæ§‹åŒ–é¡¯ç¤ºå„ªåŒ– === */
.history-parsed-container {
    display: flex;
    flex-direction: column;
    gap: 15px; /* å€å¡Šé–“è· */
}

.history-item-block {
    background-color: transparent;
}

.history-item-label {
    display: block;
    font-size: 0.95em;
    font-weight: bold;
    color: #2A9689; /* ä½¿ç”¨ä½ çš„ä¸»é¡Œç¶ è‰² */
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* æ¨™é¡Œå‰çš„å°è£é£¾ */
.history-item-label::before {
    content: '';
    display: block;
    width: 4px;
    height: 14px;
    background-color: #2A9689;
    border-radius: 2px;
}

.history-item-content {
    background-color: #f7f9fa; /* æ·ºç°èƒŒæ™¯ï¼Œå€åˆ†å…§å®¹ */
    border: 1px solid #e1e4e8;
    border-radius: 8px;
    padding: 12px 15px;
    font-size: 1rem;
    line-height: 1.8;
    color: #333;
    font-family: 'Noto Serif TC', serif;
    white-space: pre-wrap; /* é—œéµï¼šä¿ç•™è©©è©çš„æ›è¡Œ */
    word-break: break-word;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); /* å…§é™°å½±å¢åŠ å±¤æ¬¡æ„Ÿ */
}

	/* === æ­·å²ç´€éŒ„ï¼šçµæ§‹åŒ–é¡¯ç¤ºå„ªåŒ– (è«è˜­è¿ªè‰²ç³»ç‰ˆ) === */

/* å®šç¾©é¡è‰²å°æ‡‰é¡åˆ¥ */
.history-theme-context-1 { --current-theme-color: var(--m-color-1); } /* ç°ç¶  */
.history-theme-context-2 { --current-theme-color: var(--m-color-2); } /* éœ§éœ¾è— */
.history-theme-context-3 { --current-theme-color: var(--m-color-3); } /* é¦™èŠ‹ç´« */
.history-theme-context-4 { --current-theme-color: var(--m-color-4); } /* è±†æ²™ç´… */
.history-theme-context-5 { --current-theme-color: var(--m-color-5); } /* å¥¶èŒ¶æ£• */

/* é è¨­é¡è‰² (é˜²å‘†) */
.history-parsed-container {
    --current-theme-color: #6a7a7d; 
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.history-item-block {
    background-color: transparent;
}

/* æ¨™é¡Œæ¨£å¼ï¼šä½¿ç”¨å‹•æ…‹è®Šæ•¸ */
.history-item-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1em;
    font-weight: bold;
    color: var(--current-theme-color); /* è·Ÿéš¨ä¸»é¡Œè‰² */
    margin-bottom: 8px;
    padding-left: 2px;
}

/* æ¨™é¡Œå‰çš„è£é£¾å°åœ“é» */
.history-item-label::before {
    content: '';
    display: block;
    width: 8px;
    height: 8px;
    background-color: var(--current-theme-color); /* è·Ÿéš¨ä¸»é¡Œè‰² */
    border-radius: 50%;
    opacity: 0.8;
}

/* å…§å®¹å€å¡Šæ¨£å¼ */
.history-item-content {
    background-color: #fcfcfc;
    border: 1px solid #e1e4e8;
    /* å·¦å´åŠ ä¸Šç²—é‚Šæ¡†ï¼Œé¡è‰²è·Ÿéš¨ä¸»é¡Œï¼Œå¢å¼·è­˜åˆ¥åº¦ */
    border-left: 4px solid var(--current-theme-color); 
    border-radius: 4px; /* ç¨å¾®æ–¹ä¸€é»ï¼Œæ›´æœ‰æ–‡ä»¶æ„Ÿ */
    padding: 12px 16px;
    font-size: 1rem;
    line-height: 1.8;
    color: #444;
    font-family: 'Noto Serif TC', serif;
    white-space: pre-wrap;
    word-break: break-word;
}

	/* === æ­·å²ç´€éŒ„ï¼šæ¨™é¡ŒåŸåœ°ç·¨è¼¯æ¨£å¼ === */
.history-title {
    cursor: text; /* æç¤ºç”¨æˆ¶é€™æ˜¯æ–‡å­— */
    transition: background-color 0.2s;
    border-radius: 4px;
    padding: 2px 4px;
    margin: -2px -4px; /* æŠµæ¶ˆ paddingï¼Œä¿æŒä½ç½®ä¸è®Š */
}

.history-title:hover {
    background-color: rgba(0, 0, 0, 0.05); /* æ‡¸åœæ™‚çµ¦ä¸€é»æç¤º */
}

/* ç·¨è¼¯æ¨¡å¼ä¸‹çš„è¼¸å…¥æ¡†æ¨£å¼ */
.history-title-input {
    font-family: 'Noto Serif TC', serif; /* ä¿æŒåŸæœ‰å­—é«” */
    font-size: 1em; /* ä¿æŒåŸæœ‰å¤§å° */
    font-weight: bold;
    color: #333;
    width: 100%;
    border: 1px solid #2A9689; /* ç·¨è¼¯æ™‚é¡¯ç¤ºç¶ è‰²é‚Šæ¡† */
    border-radius: 4px;
    padding: 2px 4px;
    background-color: #fff;
    outline: none;
    box-shadow: 0 0 5px rgba(42, 150, 137, 0.3);
    margin: 0;
}

	/* === æ–°å¢ï¼šé€šç”¨éæ¸¡å‹•ç•« === */
.fade-in-up {
    /* ä½¿ç”¨ cubic-bezier è®“å‹•ç•«æ›´æœ‰è³ªæ„Ÿï¼Œä¸æ˜¯ç·šæ€§çš„æ­»æ¿ç§»å‹• */
    animation: fadeUpEnter 0.5s cubic-bezier(0.19, 1, 0.22, 1) forwards;
    opacity: 0; /* é è¨­éš±è—ï¼Œç”±å‹•ç•«æ§åˆ¶è®Šç‚ºå¯è¦‹ */
}

@keyframes fadeUpEnter {
    0% {
        opacity: 0;
        transform: translateY(15px) scale(0.98); /* ç¨å¾®ç¸®å°ä¸¦å‘ä¸‹åç§» */
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1); /* å›å¾©åŸç‹€ */
    }
}

	/* === æ–°å¢ï¼šé é¢æ”¶ç¸®é€€å ´å‹•ç•« === */
.page-exit-shrink {
    /* 0.4ç§’å®Œæˆï¼Œä½¿ç”¨ ease-in è®“é–‹å§‹æ…¢çµæŸå¿«ï¼Œæ„Ÿè¦ºåƒè¢«å¸èµ° */
    animation: shrinkFadeOut 0.4s cubic-bezier(0.32, 0, 0.67, 0) forwards;
    transform-origin: center 20vh; /* è¨­å®šç¸®æ”¾ä¸­å¿ƒé»åœ¨è¦–çª—ä¸Šæ–¹åä¸­ï¼Œè¦–è¦ºæ›´è‡ªç„¶ */
    pointer-events: none; /* å‹•ç•«æ’­æ”¾æ™‚ç¦æ­¢é»æ“Šï¼Œé˜²æ­¢èª¤è§¸ */
}

@keyframes shrinkFadeOut {
    0% {
        opacity: 1;
        transform: scale(1);
    }
    100% {
        opacity: 0;
        transform: scale(0.92) translateY(20px); /* ç¸®å°ä¸¦ç¨å¾®å¾€ä¸‹æ²‰ */
    }
}

/* === æ–°å¢ï¼šä¸»é é¸å–®é€²å ´ç‰¹æ•ˆ (é…åˆé€€å ´) === */
.home-enter-pop {
    animation: popIn 0.5s cubic-bezier(0.19, 1, 0.22, 1) forwards;
    opacity: 0;
}

@keyframes popIn {
    0% {
        opacity: 0;
        transform: scale(1.05); /* ä¸»é å¾ç¨å¾®æ”¾å¤§çš„ç‹€æ…‹å›å¾©ï¼Œç”¢ç”Ÿæ™¯æ·±æ„Ÿ */
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

	/* é‡å°éŸ³æ¨‚æ’­æ”¾å™¨å…§çš„å°é¸å–®é€²è¡Œå¾®èª¿ (æ”¹ç‚ºç°¡ç´„ç´”æ·¨é¢¨æ ¼) */
#music-player .controls select, 
#music-player .mode select {
    height: 30px !important;
    line-height: 26px !important;
    font-size: 14px !important;
    padding: 0 30px 0 10px !important; /* å³å´ç•™ç©ºé–“çµ¦ç®­é ­ */
    
    /* === æ¨£å¼é‡ç½®ï¼šå»é™¤åŸç¨¿ç´™èƒŒæ™¯ === */
    background-color: rgba(255, 255, 255, 0.1) !important; /* ä½èª¿çš„åŠé€æ˜èƒŒæ™¯ */
    color: #fff !important; /* ç™½è‰²æ–‡å­— */
    border: 1px solid rgba(255, 255, 255, 0.2) !important; /* æ¥µç´°çš„åŠé€æ˜é‚Šæ¡† */
    border-radius: 20px !important; /* åœ“æ½¤çš„è† å›Šç‹€ */
    box-shadow: none !important; /* å»é™¤åŸæœ¬çš„ç´™å¼µåšåº¦é™°å½± */
    
    /* === åƒ…ä¿ç•™ç™½è‰²ç®­é ­ === */
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
    background-repeat: no-repeat !important;
    background-position: right 8px center !important;
    background-size: 14px 14px !important;
    
    transition: all 0.3s ease;
}

/* äº’å‹•æ•ˆæœï¼šæ»‘é¼ æ‡¸åœæ™‚ */
#music-player .controls select:hover, 
#music-player .mode select:hover {
    background-color: rgba(255, 255, 255, 0.2) !important; /* ç¨å¾®è®Šäº® */
    border-color: rgba(255, 255, 255, 0.5) !important;
    transform: translateY(0) !important; /* å–æ¶ˆåŸæœ‰çš„æµ®èµ·æ•ˆæœï¼Œä¿æŒç©©å®š */
}

/* ç¢ºä¿ä¸‹æ‹‰å¾Œçš„é¸é …æ˜¯æ·±è‰²åº• (é¿å…åœ¨æŸäº›ç€è¦½å™¨è®Šç™½åº•é»‘å­—) */
#music-player select option {
    background-color: #333;
    color: white;
    padding: 5px;
}

/* === å­¸ç”Ÿé›²ç«¯ä¸­å¿ƒï¼šå…¨æ–°èª²æ¥­åˆ—è¡¨æ¨£å¼ === */

/* =======================================================
   === é›²ç«¯ä¸­å¿ƒï¼šNote Card æ‰“æ´é¢¨æ ¼ (è«è˜­è¿ªè‰²ç³» V3) ===
   ======================================================= */

/* 1. åŸºç¤å¡ç‰‡æ§‹é€  (Note Card) */
.task-card {
    /* åŸºç¤ç´™å¼µè¨­å®š */
    background-color: #fdfcf8;      /* ç±³ç™½ç´™å¼µåº•è‰² */
    border: 1px solid #e0ddd7;      /* æ·ºå¡å…¶ç´°é‚Šæ¡† */
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    padding: 20px 15px 20px 55px;   /* å·¦å´ç•™ç™½çµ¦æ‰“æ´å€ */
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 4px 4px 0px rgba(0,0,0,0.03); /* å¾©å¤ç¡¬é™°å½± */

    /* é—œéµï¼šæ‰“æ´èˆ‡åˆ†éš”ç·šèƒŒæ™¯ */
    background-image: 
        /* A. å‚ç›´åˆ†éš”ç·š */
        linear-gradient(to right, transparent 39px, #e0ddd7 40px, transparent 41px),
        /* B. æ‰“æ´æ•ˆæœ (æ¨¡æ“¬å­”æ´) */
        radial-gradient(circle at 20px 50%, #d1cdc5 6px, transparent 7px);
    
    background-size: 
        100% 100%, /* åˆ†éš”ç·šæ’æ»¿ */
        100% 35px; /* æ‰“æ´é‡è¤‡é–“è· */
    
    background-repeat: 
        no-repeat,
        repeat-y;
        
    background-position: 
        0 0,
        0 12px;
}

/* 2. é ‚éƒ¨é¡è‰²æ¢ (ç”¨ä¾†å€åˆ†ç‹€æ…‹) */
.task-card::before {
    content: '';
    position: absolute;
	background-color: var(--theme-color) !important;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px; /* é ‚éƒ¨è‰²æ¢é«˜åº¦ */
    z-index: 1;
}



/* 3. æ‡¸åœæ•ˆæœ */
.task-card:hover {
    transform: translateY(-3px);
    box-shadow: 6px 6px 0px rgba(0,0,0,0.05);
    background-color: #fff; /* ç¨å¾®è®Šäº® */
}

/* 4. å·¦å´æ–‡å­—å€å¡Šå„ªåŒ– */
.task-info {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex-grow: 1;
    padding-right: 15px;
    z-index: 2; /* ç¢ºä¿åœ¨èƒŒæ™¯ä¹‹ä¸Š */
}

.task-topic {
    font-family: 'Noto Serif TC', serif; /* æ–‡è—å­—é«” */
    font-weight: bold;
    font-size: 1.1rem;
    color: #4a4a4a;
}

.task-meta {
    font-family: 'Courier New', monospace; /* æ‰“å­—æ©Ÿå­—é«”æ—¥æœŸ */
    font-size: 0.85rem;
    color: #999;
    display: flex;
    align-items: center;
    gap: 10px;
}

.task-type-tag {
    font-family: sans-serif;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 4px;
    background: #eee;
    color: #666;
    font-weight: normal;
    letter-spacing: 1px;
}

/* 5. å³å´ç‹€æ…‹è† å›Š (Pill) å„ªåŒ– */
.task-status {
    flex-shrink: 0;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    z-index: 2;
}

/* =========================================
   === ç‹€æ…‹é…è‰²å®šç¾© (è«è˜­è¿ªè‰²ç³») ===
   ========================================= */

/* A. æœªç¹³äº¤ (è±†æ²™ç´…) */
.status-pending::before {
    background-color: #d69a92; /* é ‚éƒ¨è‰²æ¢ */
}
.status-pending .task-status {
    background-color: #f7ebea; /* æ·ºè±†æ²™åº• */
    color: #a67069;            /* æ·±è±†æ²™å­— */
}
.status-pending .task-topic {
    color: #a67069;            /* é¡Œç›®è®Šè‰²ä»¥ç¤ºæé†’ */
}

/* B. å¾…æ‰¹æ”¹ (ç°ç¶ ) */
.status-submitted::before {
    background-color: #8fa398; /* é ‚éƒ¨è‰²æ¢ */
}
.status-submitted .task-status {
    background-color: #e8edea; /* æ·ºç°ç¶ åº• */
    color: #5e7067;            /* æ·±ç°ç¶ å­— */
}
.status-submitted .task-topic {
    color: #888;               /* é¡Œç›®è®Šç° */
}

/* C. å·²ç™¼é‚„ (é¦™èŠ‹ç´«) */
.status-returned::before {
    background-color: #b6a6ca; /* é ‚éƒ¨è‰²æ¢ */
}
.status-returned .task-status {
    background-color: #f0ebf5; /* æ·ºç´«åº• */
    color: #7e6f8f;            /* æ·±ç´«å­— */
}
.status-returned .task-topic {
    color: #333;               /* é¡Œç›®æ·±ç° */
}

/* === ä¸‰ç¨®ç‹€æ…‹çš„é…è‰² === */


/* === è€å¸«è©•èªå°ˆç”¨æ¨£å¼ (åµŒå…¥åœ¨æ­·å²ç´€éŒ„ UI ä¸­) === */
.teacher-feedback-section {
    background-color: #fffaf5; /* æ¥µæ·¡çš„ç±³æš–è‰²èƒŒæ™¯ */
    border: 2px solid #e6dace; /* æ·ºå¡å…¶/å¥¶èŒ¶è‰²é‚Šæ¡† */
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    position: relative;
    box-shadow: 0 4px 15px rgba(141, 110, 99, 0.08); /* æš–è‰²ç³»å¾®é™°å½± */
    animation: slideDown 0.5s ease-out;
}

.teacher-feedback-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px dashed #d7ccc8; /* æ·ºè¤è‰²è™›ç·š */
    padding-bottom: 10px;
    margin-bottom: 15px;
}

/* æ¨™é¡Œæ–‡å­—é¡è‰² */
.teacher-feedback-title {
    font-weight: bold; 
    font-size: 1.2rem; 
    color: #8d6e63; /* è«è˜­è¿ªæ·±è¤è‰²æ–‡å­— */
    display: flex;
    align-items: center;
    gap: 8px;
}

.teacher-score-badge {
    background-color: #d9534f; /* ä¿ç•™ç´…è‰²åˆ†æ•¸ç‰Œï¼Œçªé¡¯é‡é» */
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
    padding: 5px 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    transform: rotate(-2deg);
}

.teacher-comment-content {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #4e342e; /* æ·±å’–å•¡è‰²æ–‡å­— */
    white-space: pre-wrap;
    word-break: break-word;
    margin: 0;
    padding: 0;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.teacher-feedback-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px dashed #ffb74d;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.teacher-score-badge {
    background-color: #d9534f;
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
    padding: 5px 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transform: rotate(-2deg); /* è“‹ç« æ•ˆæœ */
}

.teacher-comment-content {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #5d4037;
    white-space: pre-wrap; /* ä¿ç•™è€å¸«è©•èªçš„æ›è¡Œ */
}



	/* === æ–°å¢ï¼šè©•èªè©³æƒ…å½ˆçª—æ¨£å¼ === */
.feedback-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.75);
    z-index: 10000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
    backdrop-filter: blur(5px);
}

.feedback-modal-content {
    background-color: #fff;
    width: 100%;
    max-width: 700px;
    max-height: 90vh;
    border-radius: 12px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    animation: fadeIn 0.3s ease-out;
}

.feedback-header {
    padding: 15px 20px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.feedback-header h3 {
    margin: 0;
    color: #2A9689;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.feedback-close-btn {
    background: #e9ecef; /* æ˜é¡¯çš„æŒ‰éˆ•èƒŒæ™¯ */
    border: none;
    color: #555;
    font-size: 1.5rem;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.feedback-close-btn:hover {
    background-color: #d9534f;
    color: white;
    transform: rotate(90deg);
}

.feedback-body {
    padding: 20px;
    overflow-y: auto;
    flex-grow: 1;
}

/* è€å¸«è©•èªå€å¡Š */
.teacher-comment-box {
    background-color: #fff8e1;
    border: 1px solid #ffe0b2;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    line-height: 1.6;
    color: #5d4037;
    position: relative;
}

.teacher-comment-box::before {
    content: 'è€å¸«å›é¥‹';
    position: absolute;
    top: -10px;
    left: 15px;
    background: #ff9800;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
}

/* å­¸ç”ŸåŸç¨¿å€å¡Š */
.original-work-box {
    background-color: #fdfdfd;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-top: 10px;
}

.original-work-summary {
    padding: 12px 15px;
    cursor: pointer;
    font-weight: bold;
    color: #555;
    background-color: #f1f1f1;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: background 0.2s;
}

.original-work-summary:hover {
    background-color: #e2e6ea;
}

.original-work-content {
    padding: 15px;
    white-space: pre-wrap;
    font-family: 'Noto Serif TC', serif;
    color: #333;
    line-height: 1.8;
    border-top: 1px solid #eee;
}

@keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
}

	/* ============================================
   === å­¸ç”Ÿé›²ç«¯ä¸­å¿ƒï¼šå…¨è¢å¹•æ¨¡å¼ (App é¢¨æ ¼) ===
   ============================================ */

/* 1. å¼·åˆ¶è®“å…§å®¹å®¹å™¨å¡«æ»¿æ•´å€‹è¦–çª— */
#studentCloudModal .modal-content {
    width: 100% !important;
    height: 100% !important;
    max-width: none !important;  /* ç§»é™¤åŸæœ¬çš„å¯¬åº¦é™åˆ¶ */
    max-height: none !important; /* ç§»é™¤é«˜åº¦é™åˆ¶ */
    margin: 0 !important;        /* ç§»é™¤ç½®ä¸­é‚Šè· */
    border-radius: 0 !important; /* ç§»é™¤åœ“è§’ï¼Œæ›´åƒåŸç”Ÿé é¢ */
    border: none !important;     /* ç§»é™¤é‚Šæ¡† */
    display: flex;               /* ä½¿ç”¨ Flexbox ä½ˆå±€ */
    flex-direction: column;      /* å‚ç›´æ’åˆ—å…§å®¹ */
    box-sizing: border-box;
    padding: 20px;               /* ä¿æŒå…§è· */
}

/* 2. èª¿æ•´é—œé–‰æŒ‰éˆ•çš„ä½ç½®ï¼Œè®“å®ƒæ›´å¤§ã€æ›´é¡¯çœ¼ */
#studentCloudModal .close-modal-btn {
    top: 15px;
    right: 20px;
    font-size: 36px; /* åŠ å¤§æŒ‰éˆ• */
    z-index: 10;
}

/* 3. èª¿æ•´ç™»å…¥å¾Œçš„é¢æ¿ï¼Œè®“å®ƒä½”æ»¿å‰©é¤˜ç©ºé–“ */
/* === ä¿®æ­£ï¼šå­¸ç”Ÿé›²ç«¯é¢æ¿ (ç¬¬ 2054 è¡Œé™„è¿‘) === */
#studentCloudPanel {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    margin-top: 10px !important;
    /* åŸæœ¬æ˜¯ overflow: hidden; é€™å°è‡´äº†ç„¡æ³•æ»¾å‹•ï¼Œå¿…é ˆæ”¹ç‚º visible */
    overflow: visible !important; 
    height: auto !important; /* ç¢ºä¿é«˜åº¦è‡ªå‹•æ’é–‹ */
}

/* 4. é—œéµå„ªåŒ–ï¼šè®“èª²æ¥­åˆ—è¡¨è‡ªå‹•å»¶ä¼¸ï¼Œä¸¦åœ¨å…§éƒ¨æ»¾å‹• */
/* åŸæœ¬è¨­å®šäº† max-height: 250pxï¼Œå…¨è¢å¹•æ¨¡å¼ä¸‹é€™æœƒå¤ªçŸ­ï¼Œæ‰€ä»¥è¦ç§»é™¤é™åˆ¶ */
#studentCloudModal #assignmentList {
    max-height: none !important;  /* ç§»é™¤ä»»ä½•é«˜åº¦é™åˆ¶ */
    height: auto !important;      /* é«˜åº¦éš¨å…§å®¹è‡ªå‹•è®Šé•· */
    overflow-y: visible !important; /* å…§éƒ¨ä¸éœ€è¦æ»¾å‹•æ¢ï¼Œç›´æ¥æ’é–‹ */
    flex-grow: 0 !important;      /* ä¸è¦è‡ªå‹•å¡«æ»¿ï¼Œé¿å…è¨ˆç®—éŒ¯èª¤ */
    padding-bottom: 120px !important; /* â˜…é—œéµï¼šå¢åŠ å¤§é‡åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢æ‰‹æ©Ÿç‰ˆè¢«åº•éƒ¨å°èˆªåˆ—æˆ–é‚Šç·£é®æ“‹ */
    border: none !important;
}

/* 5. é‡å°æ‰‹æ©Ÿç‰ˆçš„å¾®èª¿ */
@media (max-width: 600px) {
    #studentCloudModal .modal-content {
        padding: 15px;
    }
}

	/* === å€å¡Šåˆ†éš”ç·š (è€å¸«å›é¥‹ vs å­¸ç”Ÿä½œæ¥­) === */
.feedback-separator {
    position: relative;
    height: 1px;
    margin: 40px 0; /* ä¸Šä¸‹å¤§å¹…ç•™ç™½ï¼Œå€éš”å…©è€… */
    border: none;
    border-top: 2px dashed #d7ccc8; /* æ·ºè¤è‰²è™›ç·š */
    text-align: center;
    overflow: visible;
}

.feedback-separator::after {
    content: 'â–¼ æäº¤å…§å®¹'; /* ä¸­å¤®æç¤ºæ–‡å­— */
    position: absolute;
    top: -12px; /* å‚ç›´ç½®ä¸­ */
    left: 50%;
    transform: translateX(-50%);
    background-color: #fff; /* ç™½åº•è“‹ä½è™›ç·š */
    padding: 0 15px;
    color: #a1887f; /* è«è˜­è¿ªæ·ºè¤æ–‡å­— */
    font-size: 0.85rem;
    font-weight: bold;
    letter-spacing: 1px;
}

	/* =======================================================
   === å­¸ç”Ÿé›²ç«¯ä¸­å¿ƒï¼šå…¨è¢å¹•é–å®šæ¨£å¼ (App é¢¨æ ¼ä¿®æ­£ç‰ˆ) ===
   ======================================================= */

/* 1. å¤–å±¤å®¹å™¨ï¼šè®Šæˆå…¨è¢å¹•è¦–çª—ï¼Œè² è²¬è™•ç†æ»¾å‹• */
#studentCloudModal {
    position: fixed !important;
    top: 0;
    left: 0;
    width: 100% !important;
    height: 100% !important;
    background-color: #fdfcf8 !important; /* è¨­å®šèƒŒæ™¯è‰²ï¼Œé¿å…é€æ˜ */
    z-index: 10050 !important; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    padding: 0 !important;
    
    /* é—œéµï¼šè®“å®¹å™¨è‡ªå·±ç”¢ç”Ÿæ»¾å‹•æ¢ï¼Œè€Œä¸æ˜¯å…§å®¹ */
    overflow-y: auto !important; 
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch; /* è®“ iOS æ»¾å‹•æ›´é †æ»‘ */
    
    /* ä½ˆå±€é‡ç½®ï¼šç§»é™¤ç½®ä¸­ï¼Œæ”¹ç‚ºè‡ªç„¶æµå‹• */
    display: none; /* é è¨­éš±è—ï¼Œç”± JS æ§åˆ¶ */
    align-items: flex-start !important;
    justify-content: flex-start !important;
}

/* 2. å…§å®¹å€åŸŸï¼šæ’æ»¿å¯¬åº¦ï¼Œç§»é™¤åœ“è§’ */
#studentCloudModal .modal-content {
    width: 100% !important;
    max-width: 100% !important;
    min-height: 100% !important; /* ç¢ºä¿é«˜åº¦è‡³å°‘å¡«æ»¿è¢å¹• */
    margin: 0 !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    background-color: transparent !important; /* èƒŒæ™¯ç”±å¤–å±¤æ±ºå®š */
    padding: 20px 20px 80px 20px !important; /* åº•éƒ¨ç•™ç™½ï¼Œæ–¹ä¾¿æ‰‹æ©Ÿæ“ä½œ */
    box-sizing: border-box;
    
    /* ç¢ºä¿å…§éƒ¨å…ƒç´ æ’åˆ— */
    display: flex;
    flex-direction: column;
}

/* 3. èª¿æ•´é—œé–‰æŒ‰éˆ•ä½ç½® (å›ºå®šåœ¨å³ä¸Šè§’ï¼Œä¸æœƒéš¨é é¢æ»¾å‹•æ¶ˆå¤±) */
#studentCloudModal .close-modal-btn {
    position: fixed !important; /* å›ºå®šå®šä½ */
    top: 20px;
    right: 20px;
    background-color: rgba(255, 255, 255, 0.8);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 10060;
}

	/* ==========================================
   === ç¢ºä¿å´é‚Šé¸å–®åœ¨å…¨è¢å¹•æ¨¡å¼ä¸‹ä¾ç„¶å¯è¦‹ ===
   ========================================== */

/* 1. æé«˜æ¼¢å ¡æŒ‰éˆ•çš„å±¤ç´š (åŸç‚º 9998ï¼Œå…¨è¢å¹•è¦–çª—ç‚º 10050) */
#sideMenuToggle {
    z-index: 20000 !important; 
}

/* 2. æé«˜é¸å–®å±•é–‹å¾Œçš„å±¤ç´š */
.side-menu-overlay {
    z-index: 20001 !important;
}

/* 3. ç¢ºä¿è¿”å›ä¸»é æŒ‰éˆ•çš„å±¤ç´šä¹Ÿè¶³å¤ é«˜ (ä»¥é˜²è¬ä¸€) */
#homeBtn, #sideMenuHomeBtn {
    z-index: 20000 !important;
}

	/* === ä¿®è¨‚ï¼šè©•èªè¦–çª—å±¤ç´šæå‡ (è§£æ±ºè¢«èª²æ¥­ç‹€æ…‹é®æ“‹çš„å•é¡Œ) === */
#historyModal, 
.preview-modal-overlay,
.feedback-modal-overlay {
    z-index: 20000 !important; /* ç¢ºä¿é«˜æ–¼ studentCloudModal çš„ 10050 */
}

/* === ä¿®è¨‚ï¼šå­¸ç”Ÿé›²ç«¯ä¸­å¿ƒ å…¨å±è¨­è¨ˆèˆ‡æ’ç‰ˆå„ªåŒ– (ä»¿ç…§èªè–ˆé¢¨æ ¼) === */
#studentCloudModal {
    background-color: #f5f5f3 !important; /* èªè–ˆçš„ç±³è‰²èƒŒæ™¯ */
    padding: 0 !important;
}

#studentCloudModal .modal-content {
    background-color: transparent !important;
    width: 100% !important;
    max-width: 800px !important; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…é›»è…¦ç‰ˆå¤ªå¯¬ */
    margin: 0 auto !important;
    height: 100% !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    padding: 80px 20px 20px 20px !important; /* é—œéµï¼šé ‚éƒ¨ç•™ 80px ç©ºé–“çµ¦é—œé–‰éµï¼Œé˜²æ­¢é‡ç–Š */
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* å…§å®¹å¾ä¸Šæ–¹é–‹å§‹ */
}

/* é—œé–‰æŒ‰éˆ•æ¨£å¼å„ªåŒ– (èˆ‡èªè–ˆä¸€è‡´) */
#studentCloudModal .close-modal-btn {
    position: fixed !important;
    top: 25px !important;
    right: 25px !important;
    background-color: transparent !important;
    border: none !important;
    color: #333 !important;
    font-size: 2.5rem !important;
    width: auto !important;
    height: auto !important;
    line-height: 1 !important;
    z-index: 10060 !important;
    box-shadow: none !important;
    cursor: pointer;
    transition: color 0.3s;
}

#studentCloudModal .close-modal-btn:hover {
    color: #d32f2f !important;
    background-color: transparent !important;
}

	/* === ä¿®å¾©ï¼šç¹³äº¤èª²æ¥­é¸æ“‡è¦–çª— (å±¤ç´šèˆ‡éŸ¿æ‡‰å¼å„ªåŒ–) === */
#submitAssignmentModal {
    z-index: 25000 !important; /* ç¢ºä¿é«˜æ–¼æ­·å²ç´€éŒ„ (20000) å’Œå…¶ä»–å…ƒç´  */
    padding: 0 20px; /* é—œéµï¼šå·¦å³ç•™ç™½ï¼Œç¢ºä¿æ‰‹æ©Ÿç‰ˆä¸è²¼é‚Š */
    box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’å¤§å¯¬åº¦ */
    display: none; /* é è¨­éš±è— */
    justify-content: center; /* å‚ç›´å±…ä¸­ */
    align-items: center;     /* æ°´å¹³å±…ä¸­ */
}

#submitAssignmentModal .modal-content {
    width: 100%;
    max-width: 450px; /* é™åˆ¶é›»è…¦ç‰ˆæœ€å¤§å¯¬åº¦ï¼Œæ¯”è¼ƒç²¾ç·» */
    margin: auto; /* ç¢ºä¿åœ¨ Flex å®¹å™¨ä¸­å±…ä¸­ */
    max-height: 85vh; /* é˜²æ­¢é«˜åº¦æº¢å‡º */
    display: flex;
    flex-direction: column;
    border-radius: 12px; /* åœ“è§’æ›´æŸ”å’Œ */
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); /* å¢åŠ ç«‹é«”æ„Ÿ */
}

/* === æ–°å¢ï¼šè«è˜­è¿ªè‰²ç³»æŒ‰éˆ•æ¨£å¼ === */
.btn-morandi {
    /* è«è˜­è¿ªæš–æ£•è‰²/é™¶åœŸè‰²ï¼Œä½é£½å’Œåº¦ï¼Œçœ‹èµ·ä¾†èˆ’æœé«˜ç´š */
    background-color: #a1887f !important; 
    background-image: linear-gradient(135deg, #bcaaa4 0%, #8d6e63 100%) !important;
    color: #fff !important;
    border: none !important;
    padding: 10px 20px !important;
    font-size: 1rem !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 10px rgba(141, 110, 99, 0.3) !important;
    transition: all 0.3s ease !important;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-family: 'Noto Serif TC', serif;
}

.btn-morandi:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(141, 110, 99, 0.4) !important;
    filter: brightness(105%);
}

.btn-morandi:active {
    transform: translateY(0);
}

	/* ========================================= */
/* === å¤§ç¶±çµæœè¡¨æ ¼ç¾åŒ– (åŸç¨¿ç´™é¢¨æ ¼) === */
/* ========================================= */

/* é‡å° æ•˜äº‹æŠ’æƒ…(rewriteTable) å’Œ è­°è«–(argumentRewriteTable) çš„æ”¹å¯«è¡¨æ ¼ */
/* åŒæ™‚ä¹Ÿç¾åŒ–é»è©•è¡¨æ ¼ (commentTable, argumentCommentTable) ä»¥ä¿æŒä¸€è‡´ */
#rewriteTable td, #commentTable td,
#argumentRewriteTable td, #argumentCommentTable td {
    /* 1. åŸºç¤å­—é«”èˆ‡æ’ç‰ˆ (èˆ‡è¼¸å…¥æ¡†ä¸€è‡´) */
    font-family: 'Noto Serif TC', 'Songti TC', serif !important;
    font-size: 18px !important;       
    line-height: 40px !important;     /* é—œéµï¼šé…åˆæ ¼ç·šé«˜åº¦ */
    color: #2c3e50;                   
    letter-spacing: 1px;              
    
    /* 2. åŸç¨¿ç´™èƒŒæ™¯ (40px é«˜) */
    background-color: #fffcf6 !important;        
    background-image: 
        linear-gradient(transparent 39px, rgba(42, 150, 137, 0.2) 39px, rgba(42, 150, 137, 0.2) 40px, transparent 40px),
        linear-gradient(90deg, transparent 39px, rgba(0,0,0,0.02) 39px, rgba(0,0,0,0.02) 40px, transparent 40px) !important;
    background-size: 40px 40px !important;       
    background-attachment: local;     
    
    /* 3. é‚Šæ¡†èˆ‡é–“è· */
    border: 1px solid #8baea8 !important;        
    padding: 0 15px !important;       
    vertical-align: top; /* æ–‡å­—é ä¸Šå°é½Š */
    
    /* ç¢ºä¿æ–‡å­—å°é½Šæ ¼ç·š */
    white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
}

/* è¡¨é ­æ¨£å¼ç¾åŒ– */
#rewriteTable th, #commentTable th,
#argumentRewriteTable th, #argumentCommentTable th {
    background-color: #2A9689 !important;
    color: white !important;
    font-weight: bold;
    border: 1px solid #1e7e72 !important;
    padding: 10px;
    font-size: 1.1em;
}

/* === æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼èª¿æ•´ (æ ¼ç·šç¸®å°) === */
@media (max-width: 600px) {
    #rewriteTable td, #commentTable td,
    #argumentRewriteTable td, #argumentCommentTable td {
        font-size: 16px !important;
        line-height: 32px !important; /* æ‰‹æ©Ÿç‰ˆè¡Œé«˜ */
        
        /* æ‰‹æ©Ÿç‰ˆèƒŒæ™¯æ ¼ç·š (32px) */
        background-image: 
            linear-gradient(transparent 31px, rgba(42, 150, 137, 0.2) 31px, rgba(42, 150, 137, 0.2) 32px, transparent 32px),
            linear-gradient(90deg, transparent 31px, rgba(0,0,0,0.02) 31px, rgba(0,0,0,0.02) 32px, transparent 32px) !important;
        background-size: 32px 32px !important;
        
        padding: 0 8px !important;
    }
}

/* ========================================= */
/* === å¤§ç¶±è¡¨æ ¼å¯¬åº¦å„ªåŒ– (V3 - å¹³è¡¡ç‰ˆ) === */
/* ========================================= */

/* 1. çµ±ä¸€ã€Œçµæ§‹æ®µé‡é»/è«–é»ã€(ç¬¬äºŒæ¬„) çš„å¯¬åº¦è¨­å®š */
/* è¨­å®šç‚º 150pxï¼Œèˆ‡é»è©•è¡¨æ ¼ä¿æŒä¸€è‡´ */
#commentTable th:nth-child(2), #commentTable td:nth-child(2),
#argumentCommentTable th:nth-child(2), #argumentCommentTable td:nth-child(2),
#rewriteTable th:nth-child(2), #rewriteTable td:nth-child(2),
#argumentRewriteTable th:nth-child(2), #argumentRewriteTable td:nth-child(2) {
    min-width: 150px !important; 
    max-width: 300px !important; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…å¤ªå¯¬ */
    width: auto !important;
}

/* 2. çµ±ä¸€ã€Œæƒ…ç¯€å¤§è¦/è«–æ“šåŠè«–è­‰ã€(ç¬¬ä¸‰æ¬„) çš„å¯¬åº¦è¨­å®š */
/* è¨­å®šç‚º 280pxï¼Œæ—¢èƒ½æ©«å‘ä¼¸å±•æ¸›å°‘é«˜åº¦ï¼Œåˆä¸æœƒéå¯¬ */
#commentTable th:nth-child(3), #commentTable td:nth-child(3),
#argumentCommentTable th:nth-child(3), #argumentCommentTable td:nth-child(3),
#rewriteTable th:nth-child(3), #rewriteTable td:nth-child(3),
#argumentRewriteTable th:nth-child(3), #argumentRewriteTable td:nth-child(3) {
    min-width: 180px !important; /* <--- ä¿®æ”¹é€™è£¡ï¼Œå¾ 280px æ”¹å° */
    width: auto !important;
}

/* 3. ç¢ºä¿åŸç¨¿ç´™èƒŒæ™¯æ¨£å¼ (é€šç”¨) */
#rewriteTable td, #commentTable td,
#argumentRewriteTable td, #argumentCommentTable td {
    background-attachment: local !important; 
    font-family: 'Noto Serif TC', 'Songti TC', serif !important;
    font-size: 18px !important;       
    line-height: 40px !important;     
    color: #2c3e50;                   
    letter-spacing: 1px;              
    
    /* åŸç¨¿ç´™èƒŒæ™¯ (40px é«˜) */
    background-color: #fffcf6 !important;        
    background-image: 
        linear-gradient(transparent 39px, rgba(42, 150, 137, 0.2) 39px, rgba(42, 150, 137, 0.2) 40px, transparent 40px),
        linear-gradient(90deg, transparent 39px, rgba(0,0,0,0.02) 39px, rgba(0,0,0,0.02) 40px, transparent 40px) !important;
    background-size: 40px 40px !important;       
    
    border: 1px solid #8baea8 !important;        
    padding: 0 15px !important;       
    vertical-align: top;
    white-space: pre-wrap; 
}

/* è¡¨é ­æ¨£å¼ */
#rewriteTable th, #commentTable th,
#argumentRewriteTable th, #argumentCommentTable th {
    background-color: #2A9689 !important;
    color: white !important;
    font-weight: bold;
    border: 1px solid #1e7e72 !important;
    padding: 10px;
    font-size: 1.1em;
    white-space: nowrap; 
}

/* æ‰‹æ©Ÿç‰ˆå¾®èª¿ */
@media (max-width: 600px) {
    #rewriteTable td, #commentTable td,
    #argumentRewriteTable td, #argumentCommentTable td {
        font-size: 16px !important;
        line-height: 32px !important;
        background-image: 
            linear-gradient(transparent 31px, rgba(42, 150, 137, 0.2) 31px, rgba(42, 150, 137, 0.2) 32px, transparent 32px),
            linear-gradient(90deg, transparent 31px, rgba(0,0,0,0.02) 31px, rgba(0,0,0,0.02) 32px, transparent 32px) !important;
        background-size: 32px 32px !important;
    }
}


/* === åŠ è¼‰å‹•ç•«è¦†è“‹å±¤æ¨£å¼ === */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 252, 245, 0.92); /* ç±³ç™½è‰²åŠé€æ˜èƒŒæ™¯ */
    backdrop-filter: blur(5px); /* æ¯›ç»ç’ƒæ•ˆæœ */
    z-index: 99999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    display: none; /* é è¨­éš±è— */
    justify-content: center;
    align-items: center;
    flex-direction: column;
    animation: fadeIn 0.3s ease-in-out;
}

.loading-content {
    text-align: center;
    transform: translateY(-50px);
    width: 100%;          /* ç¢ºä¿å®¹å™¨æ’æ»¿ */
    padding: 0 20px;      /* å·¦å³ä¿ç•™ 20px çš„å®‰å…¨é‚Šè·ï¼Œä¸è®“æ–‡å­—æ’ç‰† */
    box-sizing: border-box; 
    display: flex;
    flex-direction: column;
    align-items: center;
}

.loading-gif {
    width: 280px; /* æ ¹æ“šä½ çš„ GIF å¤§å°èª¿æ•´ */
    height: auto;
    margin-bottom: 25px;
    opacity: 0.8;
}

.loading-text {
    font-family: 'Noto Serif TC', serif;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šè‡ªå‹•ç¸®æ”¾å­—é«”å¤§å° */
    font-size: clamp(1.2rem, 5vw, 2.2rem); 
    font-weight: 700;
    color: #2A9689;
    
    /* æ ¸å¿ƒä¿®æ”¹ï¼šä¸åˆ†è¡Œ */
    white-space: nowrap; 
    
    /* æ ¸å¿ƒä¿®æ”¹ï¼šå­—è·ä¹Ÿæ”¹ç‚ºå‹•æ…‹ï¼Œé¿å…åœ¨å°è¢å¹•å¤ªæ’ */
    letter-spacing: clamp(2px, 1vw, 6px); 
    
    text-shadow: 0 2px 10px rgba(42, 150, 137, 0.2);
    animation: pulseText 2s infinite ease-in-out;
}
@keyframes pulseText {
    0% { opacity: 0.6; transform: scale(0.98); }
    50% { opacity: 1; transform: scale(1); }
    100% { opacity: 0.6; transform: scale(0.98); }
}


	/* === ç”Ÿæˆçµæœç•«å¸ƒå°ˆç”¨æ¨£å¼ === */
.result-canvas-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(245, 245, 243, 0.98); /* æ¥è¿‘èªè–ˆçš„ç±³è‰²åº• */
    z-index: 30000; /* ç¢ºä¿åœ¨æœ€é ‚å±¤ */
    display: none; /* é è¨­éš±è— */
    overflow-y: auto;
    animation: fadeIn 0.4s ease-out;
}

.result-canvas-content {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.result-canvas-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 2px solid #2A9689;
    margin-bottom: 20px;
    position: sticky;
    top: 0;
    background: rgba(245, 245, 243, 0.95);
    z-index: 10;
}

#resultCanvasTitle {
    font-size: 1.4rem;
    font-weight: bold;
    color: #2A9689;
    font-family: 'Noto Serif TC', serif;
}

.result-canvas-close {
    background-color: #d9534f;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.result-canvas-close:hover {
    background-color: #c9302c;
    transform: scale(1.05);
}

.result-canvas-body {
    flex-grow: 1;
    /* é€™è£¡æœƒç¹¼æ‰¿åŸæœ¬çš„çµæœæ¨£å¼ï¼Œå¦‚è¡¨æ ¼ã€é»è©•å¡ç‰‡ç­‰ */
}

/* ç¢ºä¿ç•«å¸ƒå…§çš„é›·é”åœ–å®¹å™¨é«˜åº¦æ­£ç¢º */
.result-canvas-body .radar-chart-container {
    height: 350px;
    margin-bottom: 20px;
}

@media (max-width: 600px) {
    .result-canvas-content { padding: 15px; }
    #resultCanvasTitle { font-size: 1.1rem; }
}

	/* === æ–°å¢ï¼šå­¸ç”Ÿç™»å‡ºæŒ‰éˆ•æ¨£å¼ === */
.logout-icon-btn {
    background-color: #ef9a9a; /* è«è˜­è¿ªæ·¡ç´…è‰² */
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px; /* èˆ‡æ­¡è¿æ–‡å­—ä¿æŒè·é›¢ */
    font-size: 14px;
    vertical-align: middle;
}

.logout-icon-btn:hover {
    background-color: #e53935; /* æ‡¸åœæ™‚è®Šæ·±ç´… */
    transform: scale(1.15) rotate(90deg); /* æ‡¸åœæ™‚ç¨å¾®æ—‹è½‰æ”¾å¤§ */
    box-shadow: 0 4px 8px rgba(229, 57, 53, 0.3);
}

	/* === é€šçŸ¥ç³»çµ± UI === */
/* === æŒä¹…æ€§é€šçŸ¥ç³»çµ± - ç²¾ç·»æ’ç‰ˆç‰ˆ === */
.sansi-notification-container {
    position: fixed;
    top: 25px;
    right: 20px;
    z-index: 100005;
    display: flex;
    flex-direction: column;
    gap: 18px;
    pointer-events: none;
}

.sansi-notification {
    pointer-events: auto;
    width: 300px;
    background-color: #fdfcf8;
    border: 1px solid #e0ddd7;
    border-radius: 12px;
    padding: 15px 15px 15px 50px; /* å¢åŠ å·¦é‚Šè·çµ¦æ‰“æ´å€ */
    box-shadow: 0 15px 35px rgba(0,0,0,0.12);
    position: relative;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    animation: notifIn 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    
    /* å¼·åŒ–åŸç¨¿ç´™æ‰“æ´é¢¨æ ¼ */
    background-image: radial-gradient(circle at 22px 50%, #d1cdc5 6px, transparent 7px);
    background-size: 100% 35px;
    background-repeat: repeat-y;
}

@keyframes notifIn {
    from { opacity: 0; transform: translateX(80px) scale(0.9); }
    to { opacity: 1; transform: translateX(0) scale(1); }
}

.sansi-notification:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.18);
    background-color: #fff;
}

/* é ‚éƒ¨å½©è‰²è£é£¾ç·šæ¢ */
.sansi-notification::before {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 6px;
    border-radius: 12px 12px 0 0;
}

/* æ€§è³ªæ¨™ç±¤æ¨£å¼ */
.notif-badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
    letter-spacing: 1px;
    margin-bottom: 8px;
}

/* è«è˜­è¿ªæ€§è³ªåˆ†é¡ - ä¿®æ”¹ç‰ˆ */
/* ä¸Šæ–¹è‰²æ¢æ”¹ç‚ºè®€å–è®Šæ•¸ï¼Œä»¥ä¾¿èˆ‡èª²æ¥­åˆ—è¡¨çš„è«è˜­è¿ªè‰²ç³»ä¸€è‡´ */
.sansi-notification::before { background-color: var(--theme-color) !important; }

/* æ¨™ç±¤èˆ‡åœ–ç¤ºé¡è‰²ä¿æŒåŸæœ‰çš„æ€§è³ªå€åˆ† (ç´…è‰²ä»£è¡¨æ–°ï¼Œç´«è‰²ä»£è¡¨ç™¼é‚„)ï¼Œä¸åšè®Šå‹• */
.notif-new .notif-badge { background-color: #f7ebea; color: #a67069; }
.notif-new .notif-icon { color: #d69a92; }

.notif-returned .notif-badge { background-color: #f0ebf5; color: #7e6f8f; }
.notif-returned .notif-icon { color: #b6a6ca; }

/* å…§å®¹æ’ç‰ˆ */
.notif-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.notif-topic {
    font-family: 'Noto Serif TC', serif;
    font-weight: 700;
    font-size: 1.1rem;
    color: #333;
    line-height: 1.4;
    margin: 4px 0 8px 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.notif-desc {
    font-size: 0.88rem;
    color: #777;
    line-height: 1.6;
    border-top: 1px dashed #eee;
    padding-top: 8px;
}

.notif-footer {
    margin-top: 10px;
    font-size: 0.75rem;
    color: #aaa;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 5px;
}

.notif-icon {
    font-size: 0.9rem;
}

/* === é›²ç«¯æŒ‰éˆ•èˆ‡ç´…é»æ¨£å¼ä¿®æ­£ === */

/* 1. ç¢ºä¿æŒ‰éˆ•æœ¬èº«æ˜¯ç›¸å°å®šä½ï¼Œè®“ç´…é»å¯ä»¥ä¾é™„åœ¨å®ƒå³ä¸Šè§’ */
#sideMenuCloudBtn {
    position: relative !important; 
    overflow: visible !important; /* ç¢ºä¿ç´…é»ä¸æœƒè¢«åˆ‡æ‰ */
}

/* 2. ç´…é»æ¨£å¼ (å‘¼å¸ç‡ˆæ•ˆæœ) */
.notification-badge {
    display: none; /* é è¨­éš±è—ï¼Œç”± JS æ§åˆ¶é¡¯ç¤º */
    position: absolute;
    top: 5px;          /* è·é›¢é ‚éƒ¨ */
    right: 5px;        /* è·é›¢å³é‚Š */
    width: 10px;
    height: 10px;
    background-color: #ff4444; /* é®®è±”ç´… */
    border-radius: 50%;
    border: 2px solid #333;    /* èˆ‡æ·±è‰²èƒŒæ™¯å€éš”çš„é‚Šæ¡† */
    box-shadow: 0 0 5px rgba(255, 68, 68, 0.8);
    z-index: 100;
    pointer-events: none;      /* è®“ç´…é»ä¸å½±éŸ¿é»æ“Š */
    animation: badgePulse 2s infinite;
}

/* ç´…é»å‘¼å¸å‹•ç•« */
@keyframes badgePulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
    70% { transform: scale(1.2); box-shadow: 0 0 0 4px rgba(255, 68, 68, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
}


/* === å­¸ç¿’å ±å‘Šå°ˆç”¨æ¨£å¼ (è«è˜­è¿ªç°¡ç´„é¢¨) === */
.report-section {
    margin-bottom: 40px;
    animation: fadeIn 0.5s ease;
}

.report-header {
    border-left: 5px solid #8fa398; /* è«è˜­è¿ªç°ç¶  */
    padding-left: 15px;
    margin-bottom: 20px;
}

.report-header h3 {
    margin: 0;
    color: #5e7067;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* æ–‡å­—åˆ†æå¡ç‰‡ (ç„¡æ¨™é¡Œã€ç„¡é†œé™‹åœ–ç¤º) */
.report-text-card {
    background-color: #fdfcf8;
    border: 1px solid #e0ddd7;
    border-radius: 8px;
    padding: 20px;
    margin-top: 15px;
    line-height: 1.8;
    color: #555;
    font-size: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    text-align: justify;
}

/* å¼·èª¿æ–‡å­—æ¨£å¼ */
.report-highlight {
    font-weight: bold;
    color: #94a7b5; /* è«è˜­è¿ªéœ§éœ¾è— */
    border-bottom: 1px dashed #94a7b5;
}

/* é‡‘å¥æ¨£å¼ (é å·¦) */
.report-quote {
    margin-top: 30px;
    padding: 15px 20px;
    background-color: rgba(143, 163, 152, 0.1);
    border-radius: 8px;
    color: #5e7067;
    font-style: italic;
    font-weight: bold;
    text-align: left; /* é å·¦å°é½Š */
    border-left: 4px solid #8fa398;
}

/* ç¢ºä¿é›·é”åœ–å®¹å™¨é«˜åº¦è¶³å¤  */
.report-radar-wrapper {
    margin-top: 20px;
    margin-bottom: 30px;
}


	/* ==========================================
   === å­¸ç¿’å ±å‘Šå°ˆç”¨æ¨£å¼ (V2 - è¦–è¦ºåˆ†å±¤ç‰ˆ) ===
   ========================================== */

.report-section {
    margin-bottom: 50px; /* å¢åŠ é–“è·ï¼Œè®“å„ç¯„ç–‡å€éš”æ›´æ˜é¡¯ */
    animation: fadeIn 0.5s ease;
}

/* 1. ç¯„ç–‡æ¨™é¡Œ (è† å›Šå‹æ¨™ç±¤ï¼Œè¦–è¦ºä¸Šæ˜ç¢ºå€åˆ†å±¤ç´š) */
.report-category-badge {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 25px;
    border-radius: 50px;
    color: white;
    font-weight: bold;
    font-size: 1.3rem;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    letter-spacing: 1px;
}

/* å„ç¯„ç–‡å°ˆå±¬é¡è‰² (è«è˜­è¿ªè‰²ç³»åŠ æ·±ç‰ˆï¼Œç¢ºä¿ç™½å­—æ¸…æ™°) */
.badge-narrative { background-color: #7da3c0; /* è— */ }
.badge-argument  { background-color: #a692c2; /* ç´« */ }
.badge-reading   { background-color: #8da399; /* ç¶  */ }
.badge-expand    { background-color: #d69a92; /* ç´… */ }
.badge-general   { background-color: #5e7067; /* æ·±ç°ç¶  */ }

/* 2. æ–‡å­—åˆ†æå¡ç‰‡ (ç°¡ç´„ç±³è‰²) */
.report-text-card {
    background-color: #fdfcf8;
    border: 1px solid #e0ddd7;
    border-radius: 12px;
    padding: 25px;
    line-height: 1.9;
    color: #4a4a4a;
    font-size: 1.05rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    text-align: justify;
    margin-top: 10px;
}

/* 3. é‡‘å¥å°ˆç”¨å®¹å™¨ (Note Card æ‰“å­”é¢¨æ ¼) */
.report-quote-card {
    position: relative;
    background-color: #fffefb;
    border: 1px solid #e0ddd7;
    border-radius: 8px;
    padding: 30px 30px 30px 65px; /* å·¦å´ç•™ç™½çµ¦æ‰“å­” */
    margin-top: 40px;
    box-shadow: 4px 4px 0px rgba(0,0,0,0.05);
    text-align: left; /* é å·¦å°é½Š */
    
    /* æ‰“å­”èˆ‡ç´…ç·šç‰¹æ•ˆ */
    background-image: 
        /* å‚ç›´ç´…ç·š */
        linear-gradient(to right, transparent 49px, #eebdbd 50px, transparent 51px),
        /* åœ“å½¢æ‰“å­” */
        radial-gradient(circle at 25px 50%, #d1cdc5 8px, transparent 9px);
        
    background-size: 
        100% 100%,  /* ç·šæ¢ */
        100% 40px;  /* æ‰“å­”é‡è¤‡é–“è· */
        
    background-repeat: 
        no-repeat,
        repeat-y;
        
    background-position: 
        0 0,
        0 15px; /* æ‰“å­”èµ·å§‹ä½ç½® */
}

/* é‡‘å¥æ–‡å­—æ¨£å¼ */
.report-quote-content {
    font-family: 'Noto Serif TC', serif;
    font-size: 1.2rem;
    font-weight: bold;
    color: #5d4037; /* æ·±å’–å•¡è‰² */
    font-style: italic;
    line-height: 1.6;
}

.report-quote-author {
    margin-top: 10px;
    font-size: 0.9rem;
    color: #888;
    text-align: right;
    font-style: normal;
}

/* é›·é”åœ–å®¹å™¨ä¿®æ­£ */
.report-radar-wrapper {
    margin-bottom: 30px;
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #eee;
}


	/* === å­¸ç¿’å ±å‘Šå°ˆç”¨æ¨£å¼ (V3 - æœ€çµ‚ä¿®æ­£ç‰ˆ) === */

/* 1. æ•´é«”æ¦‚æ³ (æœ€é«˜å±¤ç´šï¼šå…¨å¯¬ã€ç½®ä¸­ã€æ·±è‰²èƒŒæ™¯) */
.badge-general {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px 10px;
    margin-bottom: 10px;

    /* === ä¿®æ”¹é‡é»é–‹å§‹ï¼šç„¡å°é¢¨ï¼æš–éº»ç±³è‰² (Muji Linen) === */
    /* é€™ç¨®æ¼¸å±¤æ¨¡æ“¬äº†ç„¡å°è‰¯å“å¸¸è¦‹çš„æœªæ¼‚ç™½æ£‰éº»æˆ–å†ç”Ÿç´™çš„è³ªæ„Ÿ */
    background: linear-gradient(135deg, #C5B4A1 0%, #A99885 100%) !important; 
    
    /* é™°å½±èª¿æ•´ç‚ºæ·¡æ·¡çš„æš–æ£•è‰²ï¼Œè®“å¡ç‰‡æµ®èµ·å¾—æ›´è‡ªç„¶ */
    box-shadow: 0 8px 20px rgba(169, 152, 133, 0.35) !important; 
    
    border-bottom: none !important; 
    /* === ä¿®æ”¹é‡é»çµæŸ === */

    color: white; /* ç™½è‰²æ–‡å­—åœ¨é€™å€‹åº•è‰²ä¸Šä¾ç„¶æ¸…æ™° */
    border-radius: 12px;
    position: relative;
    overflow: hidden;
}

/* 2. å…¶ä»–ä¸»ç¯„ç–‡ (è† å›Šå‹ï¼Œé å·¦) */
.report-category-badge {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 25px;
    border-radius: 50px;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    letter-spacing: 1px;
}
/* ç¯„ç–‡é¡è‰² */
.badge-narrative { background-color: #7da3c0; } /* æ•˜äº‹-è— */
.badge-argument  { background-color: #a692c2; } /* è­°è«–-ç´« */
.badge-reading   { background-color: #8da399; } /* é–±è®€-ç¶  */
.badge-expand    { background-color: #d69a92; } /* æ‹“å±•-ç´… */

/* 3. ç¢ºä¿é›·é”åœ–å®¹å™¨èˆ‡æ–‡ç« é»è©•ä¸€è‡´ */
.report-radar-wrapper .grading-container {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
}

	/* === 1. ä¿®å¾©æ‰‹æ©Ÿç‰ˆæ•´é«”æ¦‚æ³å¯¬åº¦æº¢å‡º === */
.badge-general {
    /* ç¢ºä¿å¯¬åº¦ä¸è¶…éçˆ¶å®¹å™¨ï¼Œä¸¦é ç•™å…§è· */
    width: 100%;
    max-width: 100%; 
    box-sizing: border-box; /* é—œéµï¼šè®“ padding åŒ…å«åœ¨å¯¬åº¦å…§ */
    
    display: flex;
    justify-content: center;
    padding: 15px 10px; /* å·¦å³å…§è·ç¨å¾®ç¸®å° */
    margin-bottom: 30px;
    background-color: #5e7067;
    color: white;
    font-size: 1.6rem;
    font-weight: bold;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    letter-spacing: 2px;
    border-bottom: 4px solid #46544d;
    
    /* å¼·åˆ¶æ–‡å­—æ›è¡Œï¼Œé˜²æ­¢é•·æ¨™é¡Œæ’é–‹ */
    white-space: normal; 
    text-align: center;
}

/* æ‰‹æ©Ÿç‰ˆå­—é«”å¾®èª¿ */
@media (max-width: 600px) {
    .badge-general {
        font-size: 1.3rem; /* æ‰‹æ©Ÿä¸Šå­—é«”ç¨å¾®ç¸®å° */
        padding: 12px 5px;
    }
}

/* === 2. å ±å‘Šæ“ä½œé¸æ“‡è¦–çª— (åŠå± Bottom Sheet é¢¨æ ¼) === */
.report-menu-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: none;
    align-items: flex-end; /* é åº•å°é½Š */
    justify-content: center;
    backdrop-filter: blur(3px);
}

.report-menu-content {
    background: #fdfcf8;
    width: 100%;
    max-width: 600px; /* é›»è…¦ç‰ˆé™åˆ¶å¯¬åº¦ */
    border-radius: 20px 20px 0 0; /* ä¸Šæ–¹åœ“è§’ */
    padding: 30px 20px 50px 20px;
    box-shadow: 0 -5px 25px rgba(0,0,0,0.15);
    animation: slideUp 0.3s ease-out;
    border-top: 5px solid #8fa398;
}

@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.report-menu-title {
    text-align: center;
    color: #5e7067;
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 25px;
    border-bottom: 1px dashed #ccc;
    padding-bottom: 10px;
}

.report-options-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.report-option-card {
    background: white;
    border: 2px solid #e0ddd7;
    border-radius: 12px;
    padding: 25px 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    color: #666;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.report-option-card:hover {
    transform: translateY(-5px);
    border-color: #8fa398;
    color: #8fa398;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.report-option-icon {
    font-size: 2rem;
    margin-bottom: 5px;
}

.report-option-text {
    font-weight: bold;
    font-size: 1.1rem;
}


/* ==========================================
   === å­¸ç¿’å ±å‘Šå°ˆç”¨æ¨£å¼ (V4 - æœ€çµ‚å„ªåŒ–ç‰ˆ) ===
   ========================================== */

/* 1. æ•´é«”æ¦‚æ³æ¨™é¡Œå®¹å™¨ (å¢å¼·ç‰ˆ) */
.badge-general {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    display: flex;
    flex-direction: column; /* æ”¹ç‚ºå‚ç›´æ’åˆ— */
    align-items: center;
    justify-content: center;
    padding: 20px 10px;
    margin-bottom: 10px; /* æ¸›å°‘ä¸‹æ–¹é–“è·ï¼Œå› ç‚ºæœ‰åˆ†éš”ç·š */
    background: linear-gradient(135deg, #5e7067 0%, #4b5e56 100%); /* æ¼¸å±¤èƒŒæ™¯ */
    color: white;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(94, 112, 103, 0.3);
    position: relative;
    overflow: hidden;
}

/* æ¨™é¡Œæ–‡å­— */
.badge-general-title {
    font-size: 1.6rem;
    font-weight: bold;
    letter-spacing: 2px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* 2. ç¶œåˆè©•ç´š (çªå‡ºçš„è¦–è¦ºè¨­è¨ˆ) */
.overall-grade-tag {
    background-color: #fff;
    color: #d9534f; /* é†’ç›®çš„ç­‰ç´šç´… */
    padding: 5px 25px;
    border-radius: 50px;
    font-size: 1.4rem;
    font-weight: 900;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transform: scale(1);
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 2px solid #d69a92; /* è«è˜­è¿ªç´…é‚Šæ¡† */
    display: flex;
    align-items: center;
    gap: 8px;
}

.overall-grade-tag:hover {
    transform: scale(1.1);
}

.overall-grade-label {
    font-size: 0.8rem;
    color: #888;
    font-weight: normal;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* 3. è«è˜­è¿ªè‰²è™›ç·šåˆ†éš” */
.report-separator {
    position: relative;
    height: 1px;
    border: 0;
    border-top: 3px dashed #b6a6ca; /* è«è˜­è¿ªç´« */
    margin: 40px 0 50px 0; /* ä¸Šä¸‹å¤§å¹…ç•™ç™½ */
    opacity: 0.6;
}

/* è£é£¾ä¸­é–“çš„å°å‰ªåˆ€æˆ–åœ–ç¤º (é¸ç”¨) */
.report-separator::after {
    content: 'â–¼';
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    background: #fdfcf8; /* èƒŒæ™¯è‰²é®æ“‹ */
    padding: 0 10px;
    color: #b6a6ca;
    font-size: 12px;
}

/* 4. ä¿®å¾©åœ–è¡¨ä½ˆå±€ (æ‰‹æ©Ÿç‰ˆå¼·åˆ¶å‚ç›´å †ç–Šï¼Œä¸å£“ç¸®) */
@media (max-width: 768px) {
    /* å¼·åˆ¶å°‡å·¦å³å…©æ¬„è®Šç‚ºå–®æ¬„å‚ç›´æ’åˆ— */
    .grading-grid {
        grid-template-columns: 1fr !important;
        gap: 30px !important;
    }
    
    /* ç¢ºä¿å®¹å™¨å¯¬åº¦å¡«æ»¿ */
    .grading-scores, .grading-radar {
        width: 100% !important;
        box-sizing: border-box !important;
        margin: 0 !important;
    }

    /* ç¢ºä¿é›·é”åœ–é«˜åº¦è¶³å¤  */
    .radar-chart-container {
        height: 300px !important; /* çµ¦äºˆå›ºå®šé«˜åº¦ */
        width: 100% !important;
    }
    
    /* æ‰‹æ©Ÿå­—é«”å¾®èª¿ */
    .badge-general-title { font-size: 1.3rem; }
    .overall-grade-tag { font-size: 1.2rem; padding: 5px 20px; }
}

	/* ==========================================
   === æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºä¿®å¾© (Mobile Responsiveness) ===
   ========================================== */
@media (max-width: 768px) {
    /* 1. å¼·åˆ¶å°‡ã€Œè©•åˆ†è¡¨ã€èˆ‡ã€Œé›·é”åœ–ã€æ”¹ç‚ºå‚ç›´æ’åˆ— */
    .grading-grid {
        display: flex !important;       /* ä½¿ç”¨ Flex å–ä»£ Gridï¼Œæ§åˆ¶åŠ›æ›´å¥½ */
        flex-direction: column !important; /* å‚ç›´å †ç–Š */
        gap: 20px !important;           /* ä¸Šä¸‹é–“è· */
        width: 100% !important;
        margin: 0 !important;
    }

    /* 2. é™åˆ¶å®¹å™¨å¯¬åº¦ï¼Œé˜²æ­¢æº¢å‡º */
    .grading-scores, 
    .grading-radar,
    .report-radar-wrapper {
        width: 100% !important;
        max-width: 100% !important;     /* çµ•ä¸è¶…éè¢å¹•å¯¬ */
        box-sizing: border-box !important; /* ç¢ºä¿ padding åŒ…å«åœ¨å¯¬åº¦å…§ */
        padding: 15px !important;       /* ç¨å¾®æ¸›å°‘å…§è· */
        margin: 0 !important;
        overflow: hidden !important;    /* éš±è—ä»»ä½•æº¢å‡ºçš„å…§å®¹ */
    }

    /* 3. ä¿®å¾©é›·é”åœ– Canvas çš„éŸ¿æ‡‰å¼å¤§å° */
    .radar-chart-container {
        position: relative !important;
        width: 100% !important;         /* å¯¬åº¦æ’æ»¿å®¹å™¨ */
        height: auto !important;        /* é«˜åº¦è‡ªå‹• */
        aspect-ratio: 1 / 1 !important; /* ä¿æŒæ­£æ–¹å½¢æ¯”ä¾‹ */
        max-height: 350px !important;   /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé¿å…åœ¨å¤§æ‰‹æ©Ÿä¸Šå¤ªé•· */
        margin: 0 auto !important;
    }

    /* 4. å„ªåŒ–é€²åº¦æ¢å€åŸŸ (é¿å…æ¨™ç±¤æ–‡å­—æ›è¡Œæ“ å£“) */
    .score-item {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 10px !important;
    }

    .score-item label {
        font-size: 0.9rem !important;   /* å­—é«”ç¨ç¸®å° */
        white-space: nowrap !important; /* é˜²æ­¢æ–‡å­—æ›è¡Œ */
        min-width: 80px !important;     /* çµ¦äºˆæœ€å°å¯¬åº¦ */
    }

    .slider-container {
        flex-grow: 1 !important;        /* è®“é€²åº¦æ¢ä½”æ“šå‰©é¤˜ç©ºé–“ */
        width: auto !important;
    }

    /* 5. ç¢ºä¿æ¨™é¡Œå’Œæ¨™ç±¤ä¹Ÿä¸æœƒçˆ†ç‰ˆ */
    .badge-general, 
    .report-category-badge {
        width: 100% !important;
        max-width: 100% !important;
        white-space: normal !important; /* å…è¨±æ–‡å­—æ›è¡Œ */
        box-sizing: border-box !important;
    }
}

	/* ==========================================
   === æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºä¿®å¾© (V2 - æ¨™é¡Œç½®ä¸­ä¸æ‹‰å¯¬) ===
   ========================================== */
@media (max-width: 768px) {
    /* --- 1. åœ–è¡¨èˆ‡è©•åˆ†è¡¨ä½ˆå±€ (å‚ç›´å †ç–Š) --- */
    .grading-grid {
        display: flex !important;
        flex-direction: column !important;
        gap: 20px !important;
        width: 100% !important;
        margin: 0 !important;
    }

    .grading-scores, 
    .grading-radar,
    .report-radar-wrapper {
        width: 100% !important;
        box-sizing: border-box !important;
        padding: 15px !important;
        margin: 0 !important;
        overflow: hidden !important;
    }

    .radar-chart-container {
        height: auto !important;
        aspect-ratio: 1 / 1 !important;
        max-height: 350px !important;
        margin: 0 auto !important;
    }

    /* --- 2. æ¨™é¡Œæ¨£å¼å€åˆ† (é—œéµä¿®æ­£) --- */

    /* A. æ•´é«”æ¦‚æ³ (æœ€é«˜å±¤ç´š)ï¼šå¼·åˆ¶æ‹‰å¯¬ (100%)ï¼Œæ–¹å½¢åœ“è§’ */
    .badge-general {
        width: 100% !important;
        max-width: 100% !important;
        display: flex !important;
        flex-direction: column !important; /* å‚ç›´æ’åˆ—å…§å®¹ */
        align-items: center !important;
        
        box-sizing: border-box !important;
        padding: 20px 10px !important;
        margin-bottom: 30px !important;
        
        border-radius: 12px !important; /* æ–¹å½¢åœ“è§’ï¼Œå€åˆ¥æ–¼è† å›Š */
        text-align: center !important;
    }

    /* B. ä¸€èˆ¬ç¯„ç–‡ (é–±è®€ã€è­°è«–ç­‰)ï¼šä¸æ‹‰å¯¬ (fit-content) + æ°´å¹³ç½®ä¸­ + è† å›Šç‹€ */
    /* â˜…â˜…â˜… ä½¿ç”¨ :not(.badge-general) æ’é™¤æ•´é«”æ¦‚æ³ï¼Œé¿å…è¡çª â˜…â˜…â˜… */
    .report-category-badge:not(.badge-general) {
        width: -moz-fit-content !important;
        width: fit-content !important;       /* å¯¬åº¦åªåŒ…ä½æ–‡å­— */
        max-width: 90% !important;           /* é˜²æ­¢æ–‡å­—éé•· */
        
        display: flex !important;
        justify-content: center !important;
        
        /* é—œéµï¼šåˆ©ç”¨ margin auto é”æˆç½®ä¸­ */
        margin-left: auto !important;
        margin-right: auto !important;
        margin-bottom: 20px !important;
        
        border-radius: 50px !important;      /* ä¿æŒåœ“æ½¤è† å›Šç‹€ */
        white-space: normal !important;
        text-align: center !important;
    }

    /* C. é€²åº¦æ¢æ–‡å­—å¾®èª¿ */
    .score-item label {
        white-space: nowrap !important;
        min-width: 70px !important;
    }
}



	/* === æ–°å¢ï¼šé›²ç«¯æŒ‰éˆ•å‡çµç‹€æ…‹æ¨£å¼ === */
.btn-frozen {
    opacity: 0.4 !important;           /* é™ä½é€æ˜åº¦ */
    filter: grayscale(100%) !important; /* è®Šæˆç°è‰² */
    pointer-events: none !important;    /* é—œéµï¼šå¾¹åº•ç¦æ­¢æ»‘é¼ é»æ“Šäº‹ä»¶ */
    cursor: wait !important;            /* æ»‘é¼ ç§»ä¸Šå»é¡¯ç¤ºç­‰å¾…åœ–ç¤º */
    transform: scale(0.95);             /* ç¨å¾®ç¸®å°ï¼Œè¦–è¦ºä¸Šæ„Ÿè¦ºã€Œå‡¹é™·/ç„¡æ•ˆã€ */
}

	/* === å®‰å…¨ç‰ˆï¼šåªé‡å°ã€Œèª²æ¥­åˆ—è¡¨ã€å…§çš„å¡ç‰‡ç”Ÿæ•ˆ === */
/* åŠ ä¸Š #assignmentList å‰ç¶´ï¼Œç¢ºä¿çµ•å°ä¸æœƒå½±éŸ¿åˆ°å…¶ä»–é é¢çš„å¡ç‰‡ */
#assignmentList .task-card::before {
    background-color: var(--theme-color) !important;
}

	/* =======================================================
   === [æ–°å¢] ä¿®å¾©æ”¹å¯«ç¯„ä¾‹æ¨£å¼ & ç•«å¸ƒèŠå¤©å®¤æ¨£å¼ ===
   ======================================================= */

/* 1. æ”¹å¯«å…§å®¹å°ˆç”¨æ¨£å¼ (å·²ä¿®æ­£å­—é«”å¤§å°èˆ‡è¡Œè·) */
.rewrite-content {
    font-family: 'Noto Serif TC', serif !important;
    font-size: 1rem !important; /* ä¿®æ­£ï¼šç”± 1.1rem æ”¹ç‚º 1remï¼Œèˆ‡é»è©•ä¸€è‡´ */
    line-height: 1.8 !important; /* ä¿®æ­£ï¼šå¾®èª¿è¡Œè· */
    color: #2c3e50 !important;
    white-space: pre-wrap !important;
    text-align: justify !important;
    background-color: #fff !important;
    padding: 20px !important;
    border-radius: 8px !important;
    border: 1px solid #e0e0e0 !important;
    margin-top: 10px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.02);
}

/* 2. çµæœç•«å¸ƒå…§çš„èŠå¤©å®¤å®¹å™¨ (ä¿æŒä¸è®Š) */
.canvas-chat-container {
    margin-top: 50px;
    padding-top: 25px;
    border-top: 3px dashed #2A9689;
    animation: fadeIn 0.5s ease;
    background-color: #fcfdfd;
    padding-bottom: 20px;
}

/* èŠå¤©å®¤æ¨™é¡Œ */
.canvas-chat-header {
    color: #2A9689;
    font-size: 1.3rem;
    font-weight: bold;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* èŠå¤©ç´€éŒ„å€åŸŸ */
.canvas-chat-history {
    background-color: #f0f4f8;
    border: 1px solid #d1d9e6;
    border-radius: 12px;
    padding: 20px;
    height: 300px; /* å›ºå®šé«˜åº¦ */
    overflow-y: auto;
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* è¼¸å…¥å€åŸŸ */
.canvas-input-area {
    display: flex;
    gap: 10px;
    align-items: flex-start;
}

.canvas-input-area textarea {
    flex: 1;
    min-height: 50px;
    padding: 12px;
    border: 2px solid #ccc;
    border-radius: 8px;
    resize: vertical;
    font-size: 1rem;
    transition: border-color 0.3s;
    font-family: 'Noto Serif TC', serif;
}

.canvas-input-area textarea:focus {
    border-color: #2A9689;
    outline: none;
    box-shadow: 0 0 0 3px rgba(42, 150, 137, 0.2);
}

/* ç™¼é€æŒ‰éˆ• */
.canvas-send-btn {
    background-color: #2A9689;
    color: white;
    border: none;
    width: 55px;
    height: 55px;
    border-radius: 50%; /* åœ“å½¢ */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: all 0.2s;
    flex-shrink: 0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.canvas-send-btn:hover {
    background-color: #238074;
    transform: scale(1.1);
}

.canvas-send-btn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    transform: none;
}


	/* === æ–°å¢ï¼šè©å½™/ç‰©è±¡ ç¶²æ ¼å±•ç¤ºæ¨£å¼ === */
.vocab-grid {
    display: grid;
    /* è‡ªå‹•å¡«æ»¿ï¼Œæ¯æ ¼æœ€å°å¯¬åº¦ 80pxï¼Œé©æ‡‰æ‰‹æ©Ÿèˆ‡é›»è…¦ */
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 15px;
    padding: 15px 5px;
    margin-top: 10px;
}

.vocab-item {
    background-color: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px 5px;
    text-align: center;
    
    /* å­—é«”è¨­å®šï¼šç¢ºä¿èˆ‡ä¸»é«”ä¸€è‡´ */
    font-family: 'Noto Serif TC', 'Songti TC', serif !important;
    font-size: 1.1rem !important;
    font-weight: 500;
    color: #555;
    
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    transition: all 0.3s ease;
    cursor: default;
    
    /* é˜²æ­¢é•·è©å½™æº¢å‡º */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.vocab-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 12px rgba(42, 150, 137, 0.15);
    border-color: #2A9689;
    color: #2A9689;
    font-weight: bold;
    background-color: #f0fdfc;
}

/* é‡å°æ”¹å¯«ç¯„ä¾‹çš„æ¨™é¡Œä¿®æ­£ï¼Œç¢ºä¿èˆ‡ä¸Šæ–¹ä¸€è‡´ */
.rewrite-content {
    /* å†æ¬¡ç¢ºèªå­—é«”å¤§å°èˆ‡è¡Œè· */
    font-size: 1rem !important;
    line-height: 1.8 !important;
    font-family: 'Noto Serif TC', serif !important;
    color: #333 !important;
}


/* ========================================= */
/* === å–æ¶ˆç”Ÿæˆ UI (è«è˜­è¿ªè‰²ç³»è¨­è¨ˆ) === */
/* ========================================= */
 
/* 1. ç´”åœ–ç¤ºå–æ¶ˆéµ (ä½èª¿åœ“å½¢æŒ‰éˆ•) */
.cancel-icon-btn {
    margin-top: 30px;
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid rgba(143, 163, 152, 0.6); /* è«è˜­è¿ªç°ç¶ é‚Šæ¡† */
    color: #8fa398;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(2px);
    pointer-events: auto; /* ç¢ºä¿å¯ä»¥é»æ“Š */
}
 
.cancel-icon-btn:hover {
    background-color: rgba(143, 163, 152, 0.15);
    transform: rotate(90deg); /* æ‡¸åœæ™‚æ—‹è½‰æ•ˆæœ */
    color: #5e7067;
    border-color: #5e7067;
    box-shadow: 0 0 15px rgba(143, 163, 152, 0.2);
}
 
/* 2. ç¢ºèªè¦–çª—é®ç½© (è¦†è“‹åœ¨ Loading ä¹‹ä¸Š) */
.morandi-modal-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(253, 252, 248, 0.92); /* ç±³ç™½é®ç½©ï¼Œé«˜æ¨¡ç³Š */
    backdrop-filter: blur(8px);
    z-index: 20; /* å¿…é ˆé«˜æ–¼ loading-content */
    display: none; /* é è¨­éš±è— */
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease;
}
 
/* 3. è¦–çª—å¡ç‰‡æœ¬é«” */
.morandi-modal-card {
    background: #fffcf6; /* æš–ç™½ç´™å¼µè‰² */
    padding: 30px 35px;
    border-radius: 16px;
    border: 1px solid #e0ddd7;
    box-shadow: 0 15px 40px rgba(141, 110, 99, 0.15); /* æš–è‰²æŸ”å’Œé™°å½± */
    text-align: center;
    max-width: 85%;
    width: 340px;
    transform: translateY(0);
    animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); /* å½ˆæ€§å‹•ç•« */
}
 
.morandi-title {
    color: #5d4037; /* è«è˜­è¿ªæ·±å’–å•¡ */
    font-size: 1.3rem;
    margin: 0 0 12px 0;
    font-weight: bold;
    letter-spacing: 1px;
}
 
.morandi-text {
    color: #8d8d8d; /* æš–ç° */
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 25px;
}
 
/* 4. æŒ‰éˆ•ç¾¤çµ„ */
.morandi-btn-group {
    display: flex;
    gap: 15px;
    justify-content: center;
}
 
.morandi-btn {
    border: none;
    padding: 10px 24px;
    border-radius: 8px;
    font-size: 0.95rem;
    cursor: pointer;
    font-weight: bold;
    font-family: 'Noto Serif TC', serif;
    transition: transform 0.2s, filter 0.2s;
}
 
.morandi-btn:hover {
    transform: translateY(-2px);
    filter: brightness(105%);
}
 
.morandi-btn:active { transform: translateY(0); }
 
/* ç°è‰²æŒ‰éˆ• (ç¹¼çºŒç­‰å¾…) */
.btn-gray {
    background-color: #ececec;
    color: #777;
}
 
/* ç´…è‰²æŒ‰éˆ• (ç¢ºèªå–æ¶ˆ - è±†æ²™ç´…) */
.btn-red {
    background-color: #d69a92;
    color: white;
    box-shadow: 0 4px 12px rgba(214, 154, 146, 0.4);
}
 
/* å‹•ç•«å®šç¾© */
@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}


	/* ========================================= */
/* === [æ–°å¢] æ‰‹æ©Ÿç‰ˆç¢ºèªè¦–çª—å„ªåŒ– === */
/* ========================================= */
@media (max-width: 600px) {
    .morandi-modal-card {
        /* å¼·åˆ¶è¨­å®šå¯¬åº¦ç‚ºï¼šè¢å¹•ç¸½å¯¬æ¸›å» 80px (å³å·¦å³å„ç•™ 40px çš„å¯¬æ•é‚Šè·) */
        width: calc(100% - 80px) !important;
        
        /* ç§»é™¤åŸæœ¬çš„å›ºå®šåƒç´ å¯¬åº¦é™åˆ¶ */
        max-width: none !important;
        
        /* ç¨å¾®ç¸®å°å…§é‚Šè·ï¼Œè®“æ–‡å­—åœ¨çª„å¡ç‰‡ä¸­æ›´æœ‰å‘¼å¸ç©ºé–“ */
        padding: 25px 20px !important;
    }
 
    /* å¾®èª¿æŒ‰éˆ•åœ¨æ‰‹æ©Ÿä¸Šçš„é–“è· */
    .morandi-btn {
        padding: 10px 15px !important; /* æŒ‰éˆ•è®Šç¨å¾®ç·Šæ¹Šä¸€é»ï¼Œé˜²æ­¢æ›è¡Œ */
        font-size: 0.85rem !important;
        white-space: nowrap; /* é˜²æ­¢æŒ‰éˆ•æ–‡å­—æ›è¡Œ */
    }
    
    .morandi-btn-group {
        gap: 10px !important; /* ç¸®å°æŒ‰éˆ•ä¹‹é–“çš„è·é›¢ */
    }
}



/* === æ‰‹æ©Ÿç‰ˆå°ˆç”¨ï¼šè«è˜­è¿ªè™›ç·šèˆ‡å¡ç‰‡ä¿®å¾© === */
@media (max-width: 600px) {
    /* 1. è™›ç·šæ¨£å¼ */
    .section-separator {
        display: block;
        width: 100%;
        height: 0;
        border-top: 5px dashed #a89f91; /* è«è˜­è¿ªæš–ç°ï¼Œå¾ˆç²—çš„è™›ç·š */
        margin: 25px 0 15px 0;          /* ä¸Šä¸‹é–“è· */
        grid-column: 1 / -1;            /* å¼·åˆ¶ä½”æ»¿æ•´è¡Œ */
        opacity: 0.6;
    }

    /* 2. ã€é—œéµä¿®å¾©ã€‘å¼·åˆ¶é–å®šã€Œèª²å¤–æ›¸ç±ã€ç‚ºå¤§å¡ç‰‡ */
    /* ä½¿ç”¨ ID é¸æ“‡å™¨ï¼Œç¢ºä¿ä¸æœƒå› ç‚ºåŠ äº†è™›ç·šè€Œè®Šå½¢ */
    #booksBtn {
        grid-column: 1 / -1 !important;             /* ä½”æ»¿æ•´è¡Œ */
        width: calc(120px * 2 + 24px) !important;   /* å…©å¼µå¡ç‰‡å¯¬ + é–“è· */
        height: 130px !important;                   /* è¨­å®šé«˜åº¦ */
        max-width: none !important;
        margin: 0 auto !important;                  /* ç½®ä¸­ */
    }
    
    /* èª¿æ•´å¤§å¡ç‰‡å…§çš„æ–‡å­—å¤§å° (ä¿æŒæ‚¨åŸæœ¬çš„è¨­å®š) */
    #booksBtn .card-zh { font-size: 22px !important; }
    #booksBtn .card-en { font-size: 13px !important; }
    #booksBtn .card-icon-container { font-size: 34px !important; margin-top: 45px !important; }
}

/* é›»è…¦ç‰ˆéš±è—è™›ç·š */
@media (min-width: 601px) {
    .section-separator { display: none; }
}


/* === å…¨å±€è«è˜­è¿ª Alert æ¨£å¼ (æ‰‹æ©Ÿç‰ˆé‚Šè·å„ªåŒ–ç‰ˆ) === */
.sansi-alert-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(253, 252, 248, 0.6); /* æ¥µæ·¡ç±³è‰²é®ç½© */
    backdrop-filter: blur(5px); /* æ¯›ç»ç’ƒæ•ˆæœ */
    z-index: 2147483647; /* æœ€é ‚å±¤ */
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.sansi-alert-box {
    background-color: #fdfcf8;
    border: 1px solid #e0ddd7;
    border-radius: 16px;
    box-shadow: 0 15px 40px rgba(141, 110, 99, 0.15);
    
    /* --- é—œéµä¿®æ”¹é–‹å§‹ --- */
    width: auto;           /* è®“å¯¬åº¦è‡ªå‹•é©æ‡‰ï¼Œä¸å¼·åˆ¶å›ºå®š */
    max-width: 320px;      /* é›»è…¦ç‰ˆæœ€å¤§é™åˆ¶å¯¬åº¦ */
    min-width: 260px;      /* é˜²æ­¢å…§å®¹å¤ªå°‘æ™‚ç¸®å¾—å¤ªå° */
    margin: 0 35px;        /* â˜… é‡é»ï¼šæ‰‹æ©Ÿç‰ˆå¼·åˆ¶å·¦å³ç•™ç™½ 35pxï¼Œè§£æ±ºè²¼é‚Šå•é¡Œ */
    /* --- é—œéµä¿®æ”¹çµæŸ --- */

    padding: 25px;
    text-align: center;
    transform: translateY(20px);
    transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    position: relative;
    background-image: linear-gradient(to right, transparent 29px, #f2f0eb 30px, transparent 31px);
    background-size: 100% 100%;
}

.sansi-alert-icon {
    font-size: 2.5rem;
    color: #8fa398;
    margin-bottom: 15px;
}

.sansi-alert-message {
    font-family: 'Noto Serif TC', serif;
    font-size: 1.05rem;
    color: #5e5e5e;
    line-height: 1.6;
    margin-bottom: 25px;
    white-space: pre-wrap;
    word-break: break-word;
}

.sansi-alert-btn {
    background-color: #8fa398;
    color: white;
    border: none;
    padding: 10px 30px;
    border-radius: 50px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(143, 163, 152, 0.3);
    transition: all 0.2s ease;
    font-family: 'Noto Serif TC', serif;
}

.sansi-alert-btn:hover {
    background-color: #7d9186;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(143, 163, 152, 0.4);
}

.sansi-alert-show {
    opacity: 1;
}
.sansi-alert-show .sansi-alert-box {
    transform: translateY(0);
}

#classNumberUpdateModal .modal-content {
    padding: 0 20px; /* æ·»åŠ å·¦å³20pxçš„å†…è¾¹è· */
}

	@media (max-width: 480px) {
    #classNumberUpdateModal .modal-content {
        padding: 0 15px; /* å°å±å¹•è®¾å¤‡ä½¿ç”¨ç¨å°çš„å†…è¾¹è· */
    }
}

	/* ä¿®æ”¹ç­è™Ÿæ›´æ–°çª—å£çš„å…§å®¹å®¹å™¨ï¼Œå¢åŠ ä¸Šä¸‹å…§é‚Šè· */
#classNumberUpdateModal .modal-content {
    padding: 30px 25px;  /* ä¸Šä¸‹30pxï¼Œå·¦å³25pxçš„å…§é‚Šè· */
    box-sizing: border-box; /* ç¢ºä¿å…§é‚Šè·ä¸æœƒå¢åŠ ç¸½å¯¬åº¦ */
}

/* å¯é¸ï¼šå¦‚æœéœ€è¦é€²ä¸€æ­¥èª¿æ•´æ–‡å­—å€åŸŸçš„ä¸Šä¸‹é–“è· */
#classNumberUpdateModal .modal-content > div:first-child {
    margin-bottom: 25px; /* å¢åŠ æ¨™é¡Œå€åŸŸèˆ‡ä¸‹æ–¹å…§å®¹çš„è·é›¢ */
    padding-bottom: 10px; /* å¢åŠ æ¨™é¡Œå€åŸŸåº•éƒ¨çš„å…§é‚Šè· */
    border-bottom: 1px solid #e9e5db; /* å¯é¸ï¼šæ·»åŠ åˆ†éš”ç·šï¼Œå¢åŠ è¦–è¦ºå±¤æ¬¡ */
}

/* èª¿æ•´æŒ‰éˆ•èˆ‡é¸æ“‡å™¨ä¹‹é–“çš„è·é›¢ */
#classNumberUpdateModal .modal-content button {
    margin-top: 15px; /* å¢åŠ æŒ‰éˆ•ä¸Šæ–¹é‚Šè· */
}
	

/* === [æ–°å¢] æ­·å²ç´€éŒ„ä¿®è¨‚åŠŸèƒ½æ¨£å¼ === */
 
/* 1. ç·¨è¼¯æ¨¡å¼ä¸‹çš„è¦–è¦ºæç¤º */
[contenteditable="true"] {
    outline: none;
    border: 2px dashed #94a7b5 !important; /* è«è˜­è¿ªè—è™›ç·š */
    background-color: #fffcf6; /* æš–ç™½åº•è‰² */
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    cursor: text;
}
 
/* 2. è«è˜­è¿ªæ‡¸æµ®å„²å­˜éµ (ç´”åœ–æ¡ˆè¨­è¨ˆ) */
.morandi-save-float-btn {
    position: fixed;
    bottom: 50px;
    right: 50px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    
    /* è«è˜­è¿ªç°ç¶ æ¼¸å±¤ */
    background: linear-gradient(135deg, #8fa398 0%, #7d9186 100%);
    color: white;
    
    border: none;
    box-shadow: 0 8px 25px rgba(143, 163, 152, 0.6);
    
    display: none; /* é è¨­éš±è— */
    align-items: center;
    justify-content: center;
    font-size: 1.6rem;
    cursor: pointer;
    z-index: 99999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    
    animation: floatPopIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    transition: transform 0.2s ease, background 0.2s;
}
 
.morandi-save-float-btn:hover {
    transform: scale(1.1) rotate(15deg);
    background: linear-gradient(135deg, #9db1a6 0%, #8fa398 100%);
}
 
.morandi-save-float-btn:active {
    transform: scale(0.95);
}
 
@keyframes floatPopIn {
    from { opacity: 0; transform: scale(0); }
    to { opacity: 1; transform: scale(1); }
}

/* === æ­·å²ç´€éŒ„æ“ä½œæŒ‰éˆ•å€å„ªåŒ– === */
.history-actions {
    margin-top: 15px;
    display: flex;
    justify-content: flex-end;
    gap: 12px; /* å¢åŠ æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
    opacity: 0.8; /* ç¨å¾®æé«˜é è¨­é€æ˜åº¦ï¼Œæ–¹ä¾¿æ‰‹æ©Ÿè¾¨è­˜ */
    transition: opacity 0.3s;
}

/* ä¸‹è¼‰æŒ‰éˆ•æ¨£å¼ (è«è˜­è¿ªè—/ç°è‰²) */
.btn-download-history {
    background: transparent;
    border: 1px solid #94a7b5; /* éœ§éœ¾è—é‚Šæ¡† */
    color: #94a7b5;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    padding: 0;
}

.btn-download-history:hover {
    background-color: #94a7b5;
    color: white;
    transform: scale(1.1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

/* æ‰‹æ©Ÿç‰ˆé©é…ï¼šç¢ºä¿æŒ‰éˆ•å€åŸŸå¤ å¤§ï¼Œé˜²æ­¢èª¤è§¸ */
@media (max-width: 600px) {
    .history-actions {
        opacity: 1; /* æ‰‹æ©Ÿä¸Šç¸½æ˜¯é¡¯ç¤º */
        margin-top: 12px;
    }
    .btn-download-history, .btn-delete-history {
        width: 40px; /* æ‰‹æ©Ÿä¸ŠæŒ‰éˆ•ç¨å¾®åŠ å¤§ */
        height: 40px;
        font-size: 1.1em;
    }
}


	/* === å‚™ç”¨ç·šè·¯æç¤ºè¦–çª— (éŸ¿æ‡‰å¼è¨­è¨ˆ) === */
.backup-alert-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(253, 252, 248, 0.85); /* ç±³ç™½é«˜æ¨¡ç³Šé®ç½© */
    backdrop-filter: blur(8px);
    z-index: 999999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    display: none; /* é è¨­éš±è— */
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease;
}

.backup-alert-card {
    background: #fff;
    
    /* === ä¿®æ”¹éƒ¨åˆ†ï¼šå„ªåŒ–éŸ¿æ‡‰å¼å¯¬åº¦ === */
    /* å¼·åˆ¶å·¦å³å„ç•™ 30px é‚Šè·ï¼Œè§£æ±ºæ‰‹æ©Ÿè²¼é‚Šå•é¡Œ */
    width: calc(100% - 60px); 
    max-width: 360px;         /* é›»è…¦ç‰ˆæœ€å¤§å¯¬åº¦ä¿æŒä¸è®Š */
    box-sizing: border-box;   /* ç¢ºä¿å…§è·ä¸æœƒæ’å¤§å¡ç‰‡ */
    margin: 0 auto;           /* ç¢ºä¿æ°´å¹³ç½®ä¸­ */
    /* ============================ */

    padding: 30px 25px;
    border-radius: 16px;
    border: 1px solid #e0ddd7;
    box-shadow: 0 15px 40px rgba(141, 110, 99, 0.15);
    text-align: center;
    position: relative;
}

.backup-alert-icon {
    font-size: 3rem;
    color: #d69a92; /* è«è˜­è¿ªç´…ï¼Œè¡¨ç¤ºè­¦ç¤º */
    margin-bottom: 15px;
    animation: pulse 2s infinite;
}

.backup-alert-title {
    color: #5d4037;
    font-size: 1.3rem;
    font-weight: bold;
    margin: 0 0 10px 0;
}

.backup-alert-desc {
    color: #888;
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 25px;
}

.backup-btn-group {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.backup-btn {
    border: none;
    padding: 10px 20px;
    border-radius: 50px;
    font-size: 0.95rem;
    cursor: pointer;
    font-weight: bold;
    font-family: 'Noto Serif TC', serif;
    transition: transform 0.2s;
}

.backup-btn:hover { transform: translateY(-2px); }

.btn-stay { background: #f0f0f0; color: #777; }
.btn-switch { 
    background: #8fa398; /* è«è˜­è¿ªç¶  */
    color: white; 
    box-shadow: 0 4px 12px rgba(143, 163, 152, 0.4);
}


/* =======================================================
   === [æ–°å¢] é–±å·å“¡è¿½å•å€ (ç•«å¸ƒèŠå¤©å®¤) æ¨£å¼ - æ­·å²ç´€éŒ„å°ˆç”¨ ===
   ======================================================= */

/* 1. èŠå¤©å®¤å¤–å±¤å®¹å™¨ */
.canvas-chat-container {
    margin-top: 40px;
    padding-top: 25px;
    border-top: 3px dashed #2A9689; /* æ¨™èªŒæ€§çš„ç¶ è‰²è™›ç·š */
    background-color: #fcfdfd;
    padding-bottom: 20px;
    font-family: 'Noto Serif TC', serif;
    animation: fadeIn 0.5s ease;
}

/* 2. æ¨™é¡Œè¨­è¨ˆ */
.canvas-chat-header {
    color: #2A9689;
    font-size: 1.3rem;
    font-weight: bold;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-left: 5px;
}

/* 3. èŠå¤©ç´€éŒ„æ²å‹•å€ (åœ¨æ­·å²ç´€éŒ„ä¸­æˆ‘å€‘é€šå¸¸å¸Œæœ›å®ƒè‡ªå‹•ä¼¸å±•ï¼Œä¸è¦ Scrollï¼Œæ–¹ä¾¿åˆ—å°æˆ–é–±è®€) */
.canvas-chat-history {
    background-color: #f0f4f8; /* æ·ºè—ç°èƒŒæ™¯ */
    border: 1px solid #d1d9e6;
    border-radius: 12px;
    padding: 25px;
    /* é€™è£¡ç§»é™¤äº†å›ºå®šé«˜åº¦ (height: 300px)ï¼Œæ”¹ç‚ºè‡ªå‹•é«˜åº¦ï¼Œè®“æ­·å²ç´€éŒ„å®Œæ•´é¡¯ç¤º */
    height: auto !important; 
    min-height: 100px;
    display: flex;
    flex-direction: column;
    gap: 20px; /* æ°£æ³¡é–“è· */
}

/* 4. è¨Šæ¯æ°£æ³¡é€šç”¨è¨­å®š */
.message-bubble {
    padding: 15px 20px;
    border-radius: 18px;
    line-height: 1.8;
    font-size: 1rem;
    max-width: 88%;
    word-wrap: break-word;
    position: relative;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* 5. AI (é–±å·å“¡) æ°£æ³¡ - å·¦å´ */
.message-bubble.ai-message {
    background-color: #ffffff;
    color: #333;
    align-self: flex-start; /* é å·¦ */
    border-top-left-radius: 4px;
    border: 1px solid #e0e0e0;
}

/* 6. å­¸ç”Ÿ (ç”¨æˆ¶) æ°£æ³¡ - å³å´ */
.message-bubble.user-message {
    background-color: #2A9689; /* ä¸»é¡Œç¶  */
    color: white;
    align-self: flex-end; /* é å³ */
    border-top-right-radius: 4px;
    box-shadow: 0 4px 10px rgba(42, 150, 137, 0.2);
}

/* 7. å¼·åˆ¶éš±è—æ­·å²ç´€éŒ„ä¸­çš„è¼¸å…¥æ¡† (ä¿éšªèµ·è¦‹ï¼Œé›–ç„¶ JS æœƒç§»é™¤) */
.history-modal-content .canvas-input-area,
.detail-view .canvas-input-area {
    display: none !important;
}

	/* ========================================= */
/* === [è­°è«–-æŒ‡å¼•] å°ˆå±¬è¼¸å…¥å…§å®¹ç¾åŒ– === */
/* ========================================= */

/* 1. å•Ÿå‹•ç¶²æ ¼ä½ˆå±€ï¼šå°‡å®¹å™¨è®Šç‚º 2 æ¬„ Grid */
.history-parsed-container.argument-guide-layout {
    display: grid;
    grid-template-columns: 1fr 1fr; /* å·¦å³å…©æ¬„å¹³åˆ† */
    gap: 15px; /* å¡ç‰‡é–“è· */
    background: transparent;
    padding: 5px;
}

/* 2. è®“æ¯ä¸€å€‹è³‡æ–™å€å¡Šè®Šæˆä¸€å¼µã€Œå¡ç‰‡ã€ */
.history-parsed-container.argument-guide-layout .history-item-block {
    background-color: #fdfcf8; /* ç±³ç™½åº•è‰² */
    border: 1px solid #e0ddd7; /* è«è˜­è¿ªé‚Šæ¡† */
    border-radius: 8px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    transition: transform 0.2s ease;
}

/* æ‡¸åœå¾®äº’å‹• */
.history-parsed-container.argument-guide-layout .history-item-block:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    border-color: #ccc;
}

/* 3. ç‰¹æ®Šè™•ç†ï¼šç¬¬ä¸€å€‹å€å¡Š (é€šå¸¸æ˜¯ã€Œé¡Œç›®ã€) å¼·åˆ¶ä½”æ»¿æ•´è¡Œ */
.history-parsed-container.argument-guide-layout .history-item-block:first-child {
    grid-column: 1 / -1; /* è·¨è¶Šæ‰€æœ‰æ¬„ä½ */
    background-color: #f4f6f9; /* ç¨å¾®æ·±ä¸€é»çš„åº•è‰²ä»¥ç¤ºå€åˆ¥ */
    border-left: 4px solid var(--current-theme-color, #6a7a7d); /* å·¦å´åŠ ç²—è‰²æ¢ */
}

/* 4. å„ªåŒ–æ¨™ç±¤ (Label) æ¨£å¼ */
.history-parsed-container.argument-guide-layout .history-item-label {
    font-size: 0.9rem;
    color: #888;
    margin-bottom: 8px;
    padding-bottom: 5px;
    border-bottom: 1px dashed #e0e0e0;
    font-weight: bold;
    display: flex;
    align-items: center;
}

/* ç§»é™¤åŸæœ¬çš„å°åœ“é» (å› ç‚ºå¡ç‰‡å¼è¨­è¨ˆä¸éœ€è¦äº†) */
.history-parsed-container.argument-guide-layout .history-item-label::before {
    display: none;
}

/* 5. å„ªåŒ–å…§å®¹ (Content) æ¨£å¼ */
.history-parsed-container.argument-guide-layout .history-item-content {
    background-color: transparent !important; /* ç§»é™¤åŸæœ¬çš„ç°è‰²èƒŒæ™¯ */
    border: none !important; /* ç§»é™¤é‚Šæ¡† */
    padding: 0 !important;
    font-size: 1.1rem; /* å­—é«”ç¨å¾®åŠ å¤§ */
    color: #444;
    line-height: 1.6;
    font-family: 'Noto Serif TC', serif;
}

/* 6. æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼ï¼šè®Šå›å–®æ¬„å‚ç›´æ’åˆ— */
@media (max-width: 600px) {
    .history-parsed-container.argument-guide-layout {
        grid-template-columns: 1fr; /* å¼·åˆ¶å–®æ¬„ */
    }
}

/* === å…¨è¢å¹•é–±è®€æ¨¡å¼å°ˆç”¨æ¨£å¼ (ä¿®å¾©å…¨å±è¦†è“‹å•é¡Œ) === */
#featuredDetailView {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;           /* æ–°å¢ï¼šç¢ºä¿å¯¬åº¦å¡«æ»¿ */
    bottom: 0;          /* æ ¸å¿ƒä¿®å¾©ï¼šå¼·åˆ¶éŒ¨å®šåˆ°åº•éƒ¨ï¼Œè§£æ±ºæ‰‹æ©Ÿå·¥å…·åˆ—å°è‡´çš„é«˜åº¦å•é¡Œ */
    width: 100%;
    
    /* ç§»é™¤èˆŠçš„ height è¨­å®šï¼Œæ”¹ç”¨ auto é…åˆ bottom:0 */
    height: auto !important;
    min-height: 100dvh; /* é‡å°ç¾ä»£ç§»å‹•ç€è¦½å™¨çš„å‹•æ…‹è¦–å£é«˜åº¦ */
    
    background-color: #fdfcf8;
    z-index: 25000;
    
    /* æ»¾å‹•è¨­å®š */
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: none; /* é—œéµï¼šé˜²æ­¢æ»‘å‹•åˆ°é ‚åº•æ™‚éœ²å‡ºä¸»é èƒŒæ™¯ */
    
    padding: 0;
    box-sizing: border-box;
    
    /* ç§»é™¤åŸæœ¬å®¹å™¨çš„ padding-bottomï¼Œé¿å…è¨ˆç®—èª¤å·®ï¼Œæ”¹ç”±å…§å®¹æ’é–‹ */
}
/* é–±è®€å…§å®¹å®¹å™¨ (é™åˆ¶å¯¬åº¦ä»¥åˆ©é–±è®€) */
.read-mode-container {
    max-width: 800px;        /* æœ€ä½³é–±è®€å¯¬åº¦ */
    margin: 60px auto 100px auto; /* ä¸Šæ–¹ç•™ç™½çµ¦æ¨™é¡Œï¼Œä¸‹æ–¹ç•™ç™½ */
    padding: 40px;
    background-color: #fff;
    box-shadow: 0 4px 30px rgba(0,0,0,0.05);
    border-radius: 12px;
    position: relative;
    /* åŸç¨¿ç´™èƒŒæ™¯æ•ˆæœ */
    background-image: linear-gradient(to bottom, transparent 29px, #f0f0f0 30px);
    background-size: 100% 30px;
    line-height: 30px;
}

/* å³ä¸Šè§’æ‡¸æµ®è¿”å›éµ */
.detail-back-btn {
    position: fixed;
    top: 20px;
    right: 25px;
    z-index: 25001; /* æ¯”å…§å®¹å±¤æ›´é«˜ */
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.05);
    color: #666;
    border: 1px solid #ddd;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
}

.detail-back-btn:hover {
    background-color: #d69a92; /* è«è˜­è¿ªç´… */
    color: white;
    transform: rotate(-90deg); /* è¶£å‘³æ—‹è½‰æ•ˆæœ */
    border-color: #d69a92;
}

/* ä½œè€…èˆ‡æ¨™é¡Œæ’ç‰ˆ */


.detail-title-text {
    font-size: 2.2rem;
    font-weight: bold;
    font-family: 'Noto Serif TC', serif;
    margin-bottom: 15px;
    line-height: 1.4;
}

.detail-meta-info {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    font-family: 'Noto Serif TC', serif;
    font-size: 1.1rem;
}

.detail-author {
    color: #8d6e63; /* è«è˜­è¿ªæ·±è¤ (èˆ‡æ¨™é¡Œå€åˆ†) */
    font-weight: bold;
    padding: 2px 10px;
    background-color: #efebe9;
    border-radius: 20px;
}

.detail-date {
    color: #9e9e9e;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

/* æ‰‹æ©Ÿç‰ˆé©é… */
@media (max-width: 600px) {
    .read-mode-container {
        width: 100%;
        margin: 0;
        padding: 80px 20px 40px 20px; /* ä¸Šæ–¹ç•™æ›´å¤šç©ºé–“çµ¦æ‰‹æ©Ÿç‹€æ…‹åˆ—èˆ‡è¿”å›éµ */
        border-radius: 0;
        box-shadow: none;
        min-height: 100%;
        background-image: none; /* æ‰‹æ©Ÿç‰ˆç§»é™¤æ ¼ç·šï¼Œå¢åŠ æ˜“è®€æ€§ */
    }
    .detail-title-text { font-size: 1.8rem; }
    .detail-back-btn { top: 15px; right: 15px; }
}


	/* === å…¨è¢å¹•é–±è®€æ¨¡å¼èª¿æ•´ (V2) === */

/* é–±è®€å…§å®¹å®¹å™¨ï¼šæ”¹ç‚º 90% å¯¬åº¦ï¼Œå–„ç”¨è¢å¹•ç©ºé–“ */
.read-mode-container {
    width: 90% !important;        /* æ ¸å¿ƒä¿®è¨‚ï¼šå¯¬åº¦ç¶­æŒ 90% */
    max-width: 1200px !important; /* æ”¾å¯¬æœ€å¤§å¯¬åº¦ï¼Œé¿å…åœ¨å¤§è¢å¹•å¤ªçª„ */
    margin: 60px auto 100px auto; 
    padding: 50px 40px;           /* å…§éƒ¨ç•™ç™½ */
    background-color: #fff;
    box-shadow: 0 4px 30px rgba(0,0,0,0.05);
    border-radius: 12px;
    position: relative;
    /* åŸç¨¿ç´™èƒŒæ™¯æ•ˆæœ (ä¿æŒä¸è®Š) */
    background-image: linear-gradient(to bottom, transparent 29px, #f0f0f0 30px);
    background-size: 100% 30px;
    line-height: 30px;
    box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’ç ´ 90% */
}

/* æ¨™é¡Œèˆ‡ä½œè€…å€å¡Šå®¹å™¨ */
.detail-header-group {
    display: flex;
    flex-direction: column; /* å‚ç›´æ’åˆ— */
    align-items: center;    /* æ°´å¹³ç½®ä¸­ */
      /* â†“â†“â†“ ä¿®æ”¹é€™å…©è¡Œ â†“â†“â†“ */
    margin-bottom: 15px !important;  /* åŸæœ¬æ˜¯ 40pxï¼Œæ”¹ç‚º 15px */
    padding-bottom: 15px !important; /* åŸæœ¬æ˜¯ 25pxï¼Œæ”¹ç‚º 15px */
    
    border-bottom: 2px dashed #e0ddd7;
    padding-bottom: 25px;
}

/* ç¯‡åæ¨£å¼ */
.detail-title-text {
    font-size: 2.4rem;
    font-weight: bold;
    font-family: 'Noto Serif TC', serif;
    margin-bottom: 20px; /* èˆ‡ä½œè€…åçš„è·é›¢ */
    line-height: 1.4;
    text-align: center;
}

/* ä½œè€…åå°ˆå±¬å®¹å™¨ (ä¿®è¨‚éœ€æ±‚ä¸€) */
.detail-author-box {
    display: inline-block;
    padding: 8px 25px;
    background-color: #f5f5f5;      /* æ·ºç°åº•è‰² */
    border-radius: 4px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    /* å·²ç§»é™¤ border-left è‰²æ¢ */
}

.detail-author-text {
    color: #5d4037;
    font-size: 1.1rem;
    font-weight: bold;
    letter-spacing: 1px;
}
/* æ—¥æœŸæ¨£å¼ */
.detail-date {
    margin-top: 10px;
    color: #9e9e9e;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

/* æ‰‹æ©Ÿç‰ˆé©é… */
@media (max-width: 600px) {
read-mode-container {
        /* 1. å®¹å™¨å¯¬åº¦ï¼šç¶­æŒ 90%ï¼Œè®“è¢å¹•å·¦å³å…©å´æœ‰ç©ºéš™ */
        width: 90% !important;
        
        /* 2. å…§éƒ¨é–“è·ï¼šç”± 20px å¢åŠ è‡³ 30pxï¼Œè§£æ±ºæ–‡å­—å¤ªè²¼é‚Šçš„å•é¡Œ */
        padding: 60px 30px 40px 30px !important; 
        
        background-image: none; /* æ‰‹æ©Ÿç‰ˆç§»é™¤æ ¼ç·š */
        
        /* ç¢ºä¿é•·å–®å­—ä¸æœƒæ’çˆ†å®¹å™¨ */
        overflow-wrap: break-word; 
    }
    
    .detail-title-text { font-size: 1.8rem; }
    .detail-author-box { padding: 6px 20px; }
}



/* 3. ä½œè€…æ¨™ç±¤å®¹å™¨å¾®èª¿ */
.list-author-tag {
    margin-top: 10px;       /* èˆ‡ä¸Šæ–¹æ¨™é¡Œä¿æŒè·é›¢ */
    display: inline-block;
    padding: 4px 12px;
    background-color: #f5f5f5;
    color: #8d6e63;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: bold;
    /* ç„¡è‰²æ¢ */
}

/* 4. æ—¥æœŸæ¨£å¼ï¼šå›ºå®šåœ¨å³å´ */
.article-item-date {
    white-space: nowrap;    /* æ—¥æœŸä¸æ›è¡Œ */
    flex-shrink: 0;         /* ç¢ºä¿æ—¥æœŸä¸æœƒè¢«å£“ç¸® */
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: #aaa;
}

/* æ‰‹æ©Ÿç‰ˆå¾®èª¿ */
@media (max-width: 600px) {
    .article-item {
        align-items: flex-start !important; /* æ‰‹æ©Ÿç‰ˆæ—¥æœŸé ä¸Šå°é½Šæ¯”è¼ƒå¥½çœ‹ */
    }
    .article-item-date {
        margin-top: 5px; /* å°é½Šæ¨™é¡Œ */
        font-size: 0.8rem;
    }
}



/* === æ¥µè‡´ç·Šæ¹Šç‰ˆï¼šè³ææ¨£å¼ === */

/* 1. å¤–å±¤å®¹å™¨ */
.analysis-container {
    /* â†“â†“â†“ ä¿®æ”¹é€™å…©è¡Œï¼šå¢åŠ èˆ‡ä¸Šæ–¹åˆ†éš”ç·šçš„è·é›¢ â†“â†“â†“ */
    margin-top: 40px !important;    /* å¢åŠ å¤–éƒ¨é–“è·ï¼Œè®“åˆ†éš”ç·šèˆ‡ä¸Šæ–¹æ­£æ–‡åˆ†é–‹ */
    padding-top: 40px !important;   /* é—œéµï¼šå¢åŠ å…§éƒ¨é–“è·ï¼Œè®“æ¨™é¡Œé é›¢åˆ†éš”ç·š */
    
    border-top: 1px dashed #d1cdc5; /* å»ºè­°æ”¹ç‚ºè™›ç·š dashedï¼Œè¦–è¦ºä¸Šè¼ƒè¼•ç›ˆï¼Œä¹Ÿä¸æœƒé‚£éº¼å£“è¿« */
    position: relative;
}
	
/* 2. è³ææ¨™é¡Œ */
.analysis-header {
    text-align: center;
    font-size: 1.4rem;
    font-weight: bold;
    color: #8d6e63;
    
   /* â†“â†“â†“ ç¢ºä¿ä¸‹æ–¹ç„¡å¤šé¤˜ç•™ç™½ â†“â†“â†“ */
    margin-bottom: 5px !important; 
    padding-bottom: 0 !important;
    line-height: 1.2; 
    
    letter-spacing: 2px;
 
}

/* æ¨™é¡Œä¸Šæ–¹çš„è£é£¾ç¬¦è™Ÿ */
.analysis-header::before {
    content: 'âœ¦';
    display: block;
    font-size: 1.2rem;
    color: #b6a6ca;
    margin-bottom: 5px; 
}

/* 3. è³æå…§å®¹æœ¬é«” */
.analysis-body {
    font-size: 1.15rem;
    line-height: 30px;
    text-align: justify;
    white-space: pre-wrap;
    color: #4a4a4a;
    background-color: transparent;
    padding: 0;
    border: none;
    
    /* â˜…â˜…â˜… ä¿®æ”¹ 2ï¼šç§»é™¤å®¹å™¨é ‚éƒ¨ç•™ç™½ â˜…â˜…â˜… */
    margin-top: 0;
}

/* â˜…â˜…â˜… ä¿®æ”¹ 3 (æœ€é—œéµ)ï¼šå¼·åˆ¶ç§»é™¤ã€Œç¬¬ä¸€æ®µæ–‡å­—ã€çš„é è¨­ä¸Šé‚Šè· â˜…â˜…â˜… */
/* ç€è¦½å™¨é€šå¸¸æœƒçµ¦ p æ¨™ç±¤é è¨­ç´„ 20px çš„ä¸Šé‚Šè·ï¼Œé€™è£¡æŠŠå®ƒæ”¹æˆ 5px */
.analysis-body p:first-child {
    margin-top: 0px !important; 
}

/* å…¶ä»–æ®µè½ä¿æŒé–“è· */
.analysis-body p {
    margin-bottom: 2em;
}

/* æœ€å¾Œä¸€æ®µç§»é™¤ä¸‹é‚Šè· */
.analysis-body p:last-child {
    margin-bottom: 0;
}

/* æ‰‹æ©Ÿç‰ˆå¾®èª¿ */
@media (max-width: 600px) {
    .analysis-body {
       font-size: 1.15rem; /* <--- ä¿®æ”¹æ•¸å€¼ï¼ŒåŸç‚º 1rem */
        line-height: 1.8;
    }
}


/* ========================================= */
/* === [ä¿®è¨‚ V5] 1. å´é‚Šé¸å–®ä¸»é éµ (ç„¡èƒŒæ™¯ / é è¨­ç¶ è‰²) === */
/* ========================================= */
#sideMenuHomeBtn {
    /* 1. å®Œå…¨ç„¡èƒŒæ™¯ã€ç„¡é‚Šæ¡† */
    background-color: transparent !important; 
    border: none !important; 
    box-shadow: none !important; 
    
    margin-top: 10px;
    margin-bottom: 10px;
    transition: transform 0.3s ease; /* è¨­å®šå‹•æ…‹ç¸®æ”¾æ•ˆæœ */
}

/* --- åœ–æ¡ˆ (Icon) é è¨­ç‹€æ…‹ --- */
#sideMenuHomeBtn i {
    /* 2. é è¨­å°±æ˜¯è«è˜­è¿ªç¶  */
    color: #2C92B8 !important; 
    font-size: 26px; /* ç¨å¾®åŠ å¤§ä¸€é»ï¼Œå› ç‚ºæ²’æœ‰èƒŒæ™¯è¥¯æ‰˜ */
    transition: all 0.3s ease;
}

/* --- æ‡¸åœç‹€æ…‹ (Hover) --- */
#sideMenuHomeBtn:hover {
    background-color: transparent !important; /* ä¿æŒç„¡èƒŒæ™¯ */
    transform: scale(1.2); /* 3. æ»‘é¼ ç§»ä¸Šå»æ™‚ï¼Œåœ–æ¡ˆæ”¾å¤§ 20% */
}

#sideMenuHomeBtn:hover i {
    /* 4. æ‡¸åœæ™‚å¢åŠ äº®åº¦èˆ‡å…‰æšˆï¼Œç”¢ç”Ÿã€Œé€šé›»ã€çš„æ„Ÿè¦º */
    filter: brightness(1.2);
    text-shadow: 0 0 12px rgba(143, 163, 152, 0.8);
}

/* åŒæ­¥æ–‡å­—é¡è‰² (è‹¥æœ‰é¡¯ç¤º) */
#sideMenuHomeBtn span {
    color: #2C92B8 !important;
}


/* ========================================= */
/* === [ä¿®è¨‚ V2] 2. é–±è®€é€²åº¦æ¢ (åŠ ç²—ç‰ˆ) === */
/* ========================================= */
#readingProgressBarContainer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    
    /* â†“â†“â†“ ä¿®æ”¹ï¼šç”± 4px åŠ ç²—è‡³ 10px â†“â†“â†“ */
    height: 10px; 
    
    background: transparent;
    z-index: 25002;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
}

#readingProgressBar {
    height: 100%;
    width: 0%;
    
    /* ç„¡å°é¢¨ç±³è‰²æ¼¸å±¤ï¼šç”± æ·ºæ£‰éº»è‰²(#EBE5D5) åˆ° ç‰›çš®ç´™è‰²(#D3C4AC) */
    background: linear-gradient(90deg, #EBE5D5, #D3C4AC) !important;
    
    /* é™°å½±æ”¹ç‚ºæš–æ£•ç°è‰²ï¼Œè®“å®ƒåœ¨ç™½ç´™ä¸Šæµ®èµ·ä½†ä¸éæ–¼åˆºçœ¼ */
    box-shadow: 0 0 10px rgba(211, 196, 172, 0.8); 
    
    border-radius: 0 5px 5px 0;
    transition: width 0.1s ease-out;
}
	
	
/* === [æ¨™é¡Œè‡ªå‹•ç¸®æ”¾] å°ˆç”¨æ¨£å¼ === */
/* === [æ¨™é¡Œè‡ªå‹•ç¸®æ”¾] ä¿®æ­£ç‰ˆæ¨£å¼ === */
.auto-fit-title {
    display: block;
    width: 100%;
    white-space: nowrap;      /* åˆå§‹ç‹€æ…‹ï¼šå¼·åˆ¶å–®è¡Œ (ç‚ºäº†è®“ JS è¨ˆç®—å¯¬åº¦) */
    overflow: hidden;         /* åˆå§‹ç‹€æ…‹ï¼šéš±è—æº¢å‡º (é¿å…è¨ˆç®—æ™‚å‡ºç¾æ»¾å‹•æ¢) */
    text-overflow: clip;      /* â˜…â˜…â˜… é—œéµï¼šä¸è¦é¡¯ç¤ºçœç•¥è™Ÿ (...) â˜…â˜…â˜… */
    transition: font-size 0.1s ease;
}

/* é€™æ˜¯ JS åˆ¤æ–·éœ€è¦æ›è¡Œæ™‚æœƒåŠ å…¥çš„ class */
.auto-fit-wrap {
    white-space: normal !important;    /* å…è¨±æ›è¡Œ */
    overflow: visible !important;      /* é¡¯ç¤ºå®Œæ•´å…§å®¹ */
    line-height: 1.4 !important;       /* æ›è¡Œå¾Œçš„è¡Œè· */
}


/* === [æ–°å¢] æ…¢è®€åŠŸèƒ½å°ˆç”¨æ¨£å¼ === */

/* 1. æ–‡èƒè©³æƒ…é å³ä¸Šè§’çš„æŒ‰éˆ•ç¾¤çµ„ (æ°´å¹³æ’åˆ—ç‰ˆ) */
.detail-action-group {
    position: fixed;
    top: 20px;
    right: 25px;
    z-index: 25001;
    display: flex;
    flex-direction: row; /* â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šæ”¹ç‚º row å³è®Šæˆæ°´å¹³æ’åˆ— â˜…â˜…â˜… */
    align-items: center;
    gap: 15px;
}


.detail-float-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.9);
    color: #8d6e63; /* è«è˜­è¿ªæ·±è¤ */
    border: 1px solid #dcd6c8;
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    backdrop-filter: blur(5px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

.detail-float-btn:hover {
    background-color: #8fa398; /* è«è˜­è¿ªç¶  */
    color: white;
    transform: scale(1.1);
    border-color: #8fa398;
}

/* é—œé–‰éµç‰¹åˆ¥æ¨£å¼ (è±†æ²™ç´…) */
.detail-float-btn.close-mode:hover {
    background-color: #d69a92;
    border-color: #d69a92;
    transform: rotate(-90deg);
}

/* 2. æ…¢è®€å…¨è¢å¹•è¦†è“‹å±¤ */
#slowReaderOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: #f4f1ea; /* æ…¢è®€å°ˆç”¨æš–ç±³è‰² */
    z-index: 30000; /* æœ€é«˜å±¤ç´š */
    display: none; /* é è¨­éš±è— */
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    touch-action: none; /* ç¦æ­¢ç€è¦½å™¨é è¨­è§¸æ§ */
    user-select: none;
    -webkit-user-select: none;
}

/* æ…¢è®€é€²åº¦æ¢ */
#reader-progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    height: 6px;
    background-color: #4a7c85; /* è«è˜­è¿ªè—ç¶  */
    width: 0%;
    transition: width 0.6s ease-out;
    z-index: 30002;
}

/* æ…¢è®€æ–‡å­—å®¹å™¨ */
#reader-display-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 80%;
    max-width: 800px;
    margin-top: 30vh;
    opacity: 1;
    transition: opacity 0.6s ease-in-out;
    pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°åº•å±¤ */
}

#reader-display-wrapper.fade-out {
    opacity: 0;
}

#reader-para-num {
    font-family: 'Courier New', monospace;
    font-size: 1.2rem;
    color: #8a7968;
    margin-bottom: 1.5rem;
    opacity: 0.6;
}

#reader-text {
    font-family: 'Noto Serif TC', serif;
    font-size: 2rem; /* å¤§å­—é«” */
    line-height: 1.8;
    text-align: left;
    color: #3a3a3a;
    width: 100%;
}

/* æš«åœæç¤º */
#reader-pause-indicator {
    position: absolute;
    top: 30px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.9rem;
    color: #4a7c85;
    border: 1px solid #4a7c85;
    padding: 4px 12px;
    border-radius: 20px;
    opacity: 0;
    transition: opacity 0.3s;
    background-color: #f4f1ea;
    z-index: 30005;
}

/* 3. è¨­å®šè¦–çª— (Settings Modal) */
#readerSettingsModal {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.4);
    z-index: 26000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(3px);
}

.settings-card {
    background-color: #fdfcf8;
    padding: 25px;
    border-radius: 16px;
    border: 1px solid #e0ddd7;
    
    /* === ä¿®æ”¹é–‹å§‹ï¼šæ‰‹æ©Ÿç‰ˆå·¦å³ç•™ç™½ === */
    width: 85%;          /* æ‰‹æ©Ÿä¸Šåªä½” 85% å¯¬åº¦ï¼Œå·¦å³è‡ªå‹•ç•™ç©º */
    max-width: 320px;    /* é›»è…¦ç‰ˆé™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œä¸è®“å®ƒè®Šå¾—å¤ªå¯¬ */
    margin: 0 auto;      /* ç¢ºä¿ç½®ä¸­ */
    /* === ä¿®æ”¹çµæŸ === */
    
    text-align: center;
    box-shadow: 0 10px 30px rgba(141, 110, 99, 0.15);
}

.timer-adjuster {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
}

.timer-display {
    font-family: 'Noto Serif TC', serif;
    font-size: 2.5rem;
    font-weight: bold;
    color: #5e7067;
    width: 60px;
}

.timer-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 1px solid #dcd6c8;
    background: transparent;
    color: #8a7968;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.2s;
}

.timer-btn:hover {
    background-color: #8fa398;
    color: white;
    border-color: #8fa398;
}

/* æ‰‹æ©Ÿé©é… */
@media (max-width: 600px) {
    #reader-text { font-size: 1.6rem; }
    #reader-display-wrapper { margin-top: 25vh; }
    .detail-action-group {
        top: 15px;
        right: 15px;
        gap: 10px; /* æ‰‹æ©Ÿä¸Šç¸®å°æŒ‰éˆ•é–“è· */
    }
}


/* è¨­å®šæŒ‰éˆ•ç¾¤çµ„çš„éæ¸¡å‹•ç•« */
.detail-action-group {
    transition: transform 0.3s ease, opacity 0.3s ease;
    /* ç¢ºä¿åˆå§‹ç‹€æ…‹å¯è¦‹ */
    opacity: 1;
    transform: translateY(0);
}

/* ç•¶åŠ ä¸Š hidden class æ™‚çš„ç‹€æ…‹ */
.detail-action-group.hidden {
    opacity: 0; /* è®Šé€æ˜ */
    transform: translateY(-20px); /* å¾€ä¸Šæ»‘å‡º */
    pointer-events: none; /* éš±è—æ™‚ç¦æ­¢é»æ“Šï¼Œé˜²æ­¢èª¤è§¸ */
}


/* === æ›¸ç±¤åŠŸèƒ½å°ˆç”¨æ¨£å¼ === */

/* ========================================= */
/* === [æ–°è¨­è¨ˆ] æ›¸ç±¤åŠŸèƒ½å°ˆç”¨æ¨£å¼ (ç¥ç€ç³–è‰²) === */
/* ========================================= */

/* å®šç¾©æ–°è®Šæ•¸ï¼šè«è˜­è¿ªç¥ç€ç³–è‰² */
:root {
    /* æ‚¨å¯ä»¥åœ¨é€™è£¡ä¿®æ”¹ #E0B0A8 ç‚ºå…¶ä»–é¡è‰² */
    /* æ¨è–¦è‰²ç¢¼ï¼š#E0B0A8 (æŸ”ç²‰), #B5C9C3 (æ·¡ç°ç¶ ), #C9B8B5 (è—•ç²‰ç°) */
    --bookmark-color: #E0B0A8; 
}

/* --- 1. ä¸»é åˆ—è¡¨æ—çš„éæ¿¾æŒ‰éˆ• --- */

/* ç‹€æ…‹ A: æœªé»æ“Š (é è¨­) */
/* åªæœ‰æ·¡æ·¡çš„ç°è‰²é‚Šæ¡†ï¼Œçœ‹èµ·ä¾†å¾ˆä¹¾æ·¨ */
.bookmark-list-btn {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background-color: #fff;      /* ç™½åº• */
    border: 2px solid #e0e0e0;   /* æ¥µæ·¡ç°é‚Šæ¡† */
    color: #ccc;                 /* æ¥µæ·¡ç°åœ–ç¤º */
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: none;            /* é è¨­ç„¡é™°å½± */
}

/* ç‹€æ…‹ B: æ‡¸åœ (æ»‘é¼ ç§»ä¸Šå») */
/* é‚Šæ¡†å’Œåœ–ç¤ºè®Šè‰²ï¼Œæç¤ºç”¨æˆ¶å¯ä»¥é»æ“Šï¼Œä½†èƒŒæ™¯ä»æ˜¯ç™½çš„ */
.bookmark-list-btn:hover {
    border-color: var(--bookmark-color);
    color: var(--bookmark-color);
    transform: translateY(-2px);
    background-color: #fff;
}

/* ç‹€æ…‹ C: é»æ“Šå¾Œ (æ¿€æ´»æ¨¡å¼) */
/* å¡«æ»¿é¡è‰²ï¼Œè®Šæˆå¯¦å¿ƒï¼Œå†æ¬¡é»æ“Šç§»é™¤æ­¤ class å°±æœƒè®Šå›ç‹€æ…‹ A */
.bookmark-list-btn.active-mode {
    background-color: var(--bookmark-color) !important;
    border-color: var(--bookmark-color) !important;
    color: white !important;
    box-shadow: 0 4px 12px rgba(224, 176, 168, 0.4); /* æ·¡æ·¡çš„åŒè‰²ç³»å…‰æšˆ */
    transform: scale(1.05);
}


/* --- 2. æ–‡ç« è©³æƒ…é å³ä¸Šè§’çš„æ‡¸æµ®æŒ‰éˆ• --- */

/* ç‹€æ…‹ A: æœªæ”¶è— (é è¨­) */
/* ç¹¼æ‰¿åŸæœ‰çš„ .detail-float-btn æ¨£å¼ (ç™½åº•ã€ç°æ¡†) */
/* é€™è£¡åªéœ€å¾®èª¿å®ƒçš„ hover è¡Œç‚º */

/* ç‹€æ…‹ B: æ‡¸åœ (æœªæ”¶è—æ™‚) */
/* åªæœ‰åœ–ç¤ºè®Šè‰²ï¼Œæç¤ºé€™æ˜¯æ›¸ç±¤åŠŸèƒ½ */
#detailBookmarkBtn:not(.bookmarked):hover {
    border-color: var(--bookmark-color);
}
#detailBookmarkBtn:not(.bookmarked):hover i {
    color: var(--bookmark-color);
}

/* ç‹€æ…‹ C: é»æ“Šå¾Œ (å·²æ”¶è—) */
/* å¡«æ»¿é¡è‰²ï¼Œå†æ¬¡é»æ“Š JS æœƒç§»é™¤ .bookmarkedï¼Œè‡ªå‹•è®Šå›ç‹€æ…‹ A */
.detail-float-btn.bookmarked {
    background-color: var(--bookmark-color) !important;
    border-color: var(--bookmark-color) !important;
    color: white !important;
    box-shadow: 0 0 15px rgba(224, 176, 168, 0.5); /* æŸ”å’Œå…‰æšˆ */
    transform: scale(1.1);
}

/* å·²æ”¶è—ç‹€æ…‹ä¸‹çš„æ‡¸åœ (ç¨å¾®åŠ æ·±ä¸€é»é»æˆ–ä¿æŒåŸç‹€) */
.detail-float-btn.bookmarked:hover {
    opacity: 0.9;
    transform: scale(1.15); /* è®“ç”¨æˆ¶æ„Ÿè¦ºåˆ°å¯ä»¥é»æ“Šå–æ¶ˆ */
}
	
/* ========================================= */
/* === [ä¿®å¾©] æ›¸ç±¤æŒ‰éˆ•é¡è‰²é‚è¼¯ === */
/* ========================================= */

/* 1. æœªæ”¶è—ç‹€æ…‹çš„ Hoverï¼šå¼·åˆ¶ç™½åº• + ç¥ç€è‰²åœ–ç¤º (è¦†è“‹åŸæœ¬çš„ç¶ åº•) */
#detailBookmarkBtn:not(.bookmarked):hover {
    background-color: #fff !important;       /* å¼·åˆ¶ä¿æŒç™½åº• */
    color: var(--bookmark-color) !important; /* åœ–ç¤ºè®Šç¥ç€è‰² */
    border-color: var(--bookmark-color) !important;
    transform: scale(1.1);
}

/* 2. å·²æ”¶è—ç‹€æ…‹çš„ Hoverï¼šä¿æŒç¥ç€è‰²åº• (ç¨å¾®è®Šæ·±æˆ–é€æ˜åº¦è®ŠåŒ–) */
#detailBookmarkBtn.bookmarked:hover {
    background-color: var(--bookmark-color) !important; /* ä¿æŒç¥ç€è‰²åº• */
    color: white !important;
    border-color: var(--bookmark-color) !important;
    opacity: 0.9; /* è¼•å¾®è¦–è¦ºå›é¥‹ */
}

/* ========================================= */
/* === [æ–°å¢] è¨è«–å€å¤§æŒ‰éˆ•æ¨£å¼ === */
/* ========================================= */
.big-chat-trigger-btn {
    background-color: #8fa398; /* è«è˜­è¿ªç°ç¶  */
    color: white;
    border: none;
    width: 70px;  /* è¨­å®šå¯¬åº¦ */
    height: 70px; /* è¨­å®šé«˜åº¦ (æ­£æ–¹å½¢) */
    border-radius: 50%; /* è®Šæˆåœ“å½¢ */
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(143, 163, 152, 0.4);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 32px; /* åœ–ç¤ºå¤§å° */
    margin-bottom: 20px;
}

.big-chat-trigger-btn:hover {
    transform: scale(1.15) rotate(15deg); /* æ‡¸åœæ™‚æ”¾å¤§ä¸¦æ—‹è½‰ */
    box-shadow: 0 8px 25px rgba(143, 163, 152, 0.6);
    background-color: #7d9186; /* ç¨å¾®è®Šæ·± */
}

/* --- è­°è«–æŒ‡å¼•ï¼šè«è˜­è¿ªè—è¡“åŒ–æ’ç‰ˆ --- */
/* --- è­°è«–æŒ‡å¼•ï¼šç²¾ç…‰ç‰ˆè«è˜­è¿ªæ’ç‰ˆ --- */
.morandi-guide-container {
    padding: 10px 0;
    font-family: 'Noto Serif TC', serif;
}
 
.guide-section-card {
    background-color: #fdfcf8;
    border: 1px solid #e0ddd7;
    border-radius: 8px; /* åœ“è§’ç¨å¾®ç¸®å°ï¼Œé¡¯å¾—æ›´ä¹¾æ·¨ */
    margin-bottom: 20px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
}
 
.guide-card-header {
    background-color: #8fa398; /* è«è˜­è¿ªç°ç¶  */
    color: white;
    padding: 12px 20px;
    font-size: 1.15rem; /* æ¨™é¡Œç¸®å° */
    font-weight: bold;
    letter-spacing: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
}
 
.guide-card-body {
    padding: 20px 25px; /* ç¸®æ¸›å…§é‚Šè· */
    color: #4a4a4a;
    
    /* æ ¸å¿ƒä¿®è¨‚ï¼šæ›´ç´®å¯¦çš„è¡Œè·èˆ‡å­—é«” */
    line-height: 1.6 !important;
    font-size: 1.1rem !important;
    letter-spacing: 1px !important;
    text-align: justify;
}
 
/* é‡å°å…§å®¹ä¸­çš„æ®µè½å¢åŠ å¾®é‡é–“è· */
.guide-card-body br {
    content: "";
    display: block;
    margin: 8px 0;
}
 
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Live2D ç•«å¸ƒ */
#live2d-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 2147483647; 
    pointer-events: none !important;
    touch-action: none; 
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    -webkit-user-select: none;
    display: none; 
}

/* Q å½ˆå‹•ç•« */
@keyframes cat-jelly {
    0% { transform: scale(1, 1); }
    30% { transform: scale(1.1, 0.9); }
    40% { transform: scale(0.9, 1.1); }
    50% { transform: scale(1.05, 0.95); }
    75% { transform: scale(0.98, 1.02); }
    100% { transform: scale(1, 1); }
}

.cat-active-click {
    animation: cat-jelly 0.4s cubic-bezier(0.25, 1, 0.5, 1); 
    filter: brightness(1.1);
}

/* --- å°è©±æ°£æ³¡æ¨£å¼ (å¸¸é§å‹) --- */
.cat-speech-bubble {
    position: fixed;
    background-color: rgba(255, 255, 255, 0.95);
    border: 2px solid #8fa398; /* è«è˜­è¿ªç¶  */
    border-radius: 12px;
    padding: 15px;
    color: #5d4037;
    font-family: 'Noto Serif TC', serif;
    font-size: 1rem;
    line-height: 1.6;
    max-width: 240px; 
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    z-index: 2147483648; 
    pointer-events: auto; /* å…è¨±é¸å–æ–‡å­— */
    opacity: 0;
    transform: translateY(10px) scale(0.95);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    word-wrap: break-word;
}

.cat-speech-bubble.show {
    opacity: 1;
    transform: translateY(0) scale(1);
}

/* æ°£æ³¡å°ç®­é ­ */
.cat-speech-bubble::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 8px 8px 0;
    border-style: solid;
    border-color: #8fa398 transparent transparent transparent;
}

/* è¼‰å…¥ä¸­çš„çœç•¥è™Ÿ */
.cat-loading-dots::after {
    content: ' .';
    animation: dots 1.5s steps(5, end) infinite;
}
@keyframes dots {
    0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
    40% { color: #5d4037; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
    60% { text-shadow: .25em 0 0 #5d4037, .5em 0 0 rgba(0,0,0,0);}
    80%, 100% { text-shadow: .25em 0 0 #5d4037, .5em 0 0 #5d4037;}
}

/* æ¸¸æ¨™æ¨£å¼ */
body.cat-hovering { cursor: grab !important; }
body.cat-dragging { cursor: grabbing !important; }

/* å…¶ä»–æ¨£å¼ */
.report-option-icon { font-size: 2.5rem; margin-bottom: 10px; }
.cat-sub-menu { display: flex; justify-content: space-around; padding: 10px 5px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; margin: 5px 10px; animation: fadeIn 0.3s ease; }
.cat-option { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; background: rgba(255, 255, 255, 0.1); }
.cat-option:hover { transform: scale(1.2); background: rgba(255, 255, 255, 0.3); }
.cat-option i { color: #d69a92; font-size: 14px; }

#fullArticleBody b, #fullArticleBody strong {
    font-weight: 900 !important; 
    color: #2c3e50; 
}


/* === åˆ†é è·³è½‰è¼¸å…¥æ¡†æ¨£å¼ === */
.page-jump-input {
    width: 50px;
    text-align: center;
    border: none;
    border-bottom: 2px solid #8fa398; /* è«è˜­è¿ªç¶ åº•ç·š */
    background: transparent;
    color: #5d4037;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 1rem;
    padding: 0;
    margin: 0;
    outline: none;
}

/* è®“ä¸€éµå›é¦–é æŒ‰éˆ•èˆ‡å…¶ä»–æŒ‰éˆ•é¢¨æ ¼ä¸€è‡´ï¼Œä½†ç¨å¾®å°ä¸€é» */
#firstPageBtn {
    font-size: 0.9rem !important;
    opacity: 0.7;
}
#firstPageBtn:hover {
    opacity: 1;
    background-color: transparent !important; /* ä¿æŒç„¡èƒŒæ™¯ï¼Œåªè®Šè‰² */
    color: #2A9689 !important;
    transform: scale(1.1);
}


/* === æ–‡èƒåˆ†é éæ¸¡ç‰¹æ•ˆ === */

/* åˆ—è¡¨å®¹å™¨çš„éæ¸¡ç‹€æ…‹ */
#articleListContainer {
    transition: opacity 0.3s ease, transform 0.3s ease;
    min-height: 300px; /* ä¿æŒæœ€å°é«˜åº¦ï¼Œé˜²æ­¢æ›é æ™‚é é¢å¡Œé™· */
}

/* é€€å ´ç‹€æ…‹ï¼šé€æ˜ä¸”ç¨å¾®ä¸‹æ²‰ */
.list-fade-out {
    opacity: 0;
    transform: translateY(20px);
    pointer-events: none; /* é˜²æ­¢å‹•ç•«ä¸­èª¤è§¸ */
}

/* é€²å ´ç‹€æ…‹ï¼šä¸é€æ˜ä¸”æ­¸ä½ */
.list-fade-in {
    opacity: 1;
    transform: translateY(0);
}

/* è½‰å ´æœŸé–“çš„ Loading å®¹å™¨ */
.pagination-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #8fa398; /* è«è˜­è¿ªç¶  */
    font-family: 'Noto Serif TC', serif;
    animation: fadeIn 0.2s ease;
}

/* è½‰åœˆåœˆç‰¹æ•ˆ */
.pagination-spinner {
    font-size: 2rem;
    margin-bottom: 15px;
    animation: spin 1s linear infinite;
}

@keyframes spin { 100% { transform: rotate(360deg); } }

	
/* ========================================= */
/* === [ä¿®æ”¹] å·²è®€æ–‡ç« æ¨£å¼ (æš–ç°å²©è‰²é¢¨æ ¼) === */
/* ========================================= */
 
/* 1. å·²è®€ç‹€æ…‹çš„å¡ç‰‡èƒŒæ™¯ */
.article-item.read {
    /* ä½¿ç”¨å…¨æ–°çš„è«è˜­è¿ªæš–ç°å²©è‰²ï¼Œä»£è¡¨ã€Œå·²é–±/å­˜æª”ã€çš„æ„Ÿè¦º */
    background-color: #F0EBE5 !important;
    
    /* å·¦å´åŠ ä¸Šä¸€æ¢ä½èª¿çš„å¡å…¶è‰²é‚Šç·šï¼Œå¢å¼·è­˜åˆ¥åº¦ */
    border-left: 5px solid #A89F91 !important;
    
    /* ç¨å¾®é™ä½æ•´é«”ä¸é€æ˜åº¦ï¼Œè®“æœªè®€çš„æ–‡ç« åœ¨è¦–è¦ºä¸Šæ›´çªå‡º */
    opacity: 0.9;
}
 
/* 2. å·²è®€ç‹€æ…‹ä¸‹çš„æ»‘é¼ æ‡¸åœæ•ˆæœ */
.article-item.read:hover {
    background-color: #E6DFD7 !important; /* æ‡¸åœæ™‚ç¨å¾®è®Šæ·± */
    transform: translateX(5px); /* ä¿æŒåŸæœ¬çš„ä½ç§»æ•ˆæœ */
}
 
/* 3. ç´”å‹¾è™Ÿåœ–ç¤ºæ¨£å¼ */
.read-icon-only {
    color: #A89F91; /* èˆ‡é‚Šç·šåŒè‰² (è«è˜­è¿ªæ·±å¡å…¶) */
    font-size: 1rem;
    margin-left: 8px;
    opacity: 0.8;
}


/* ========================================= */
/* === [ä¿®è¨‚ V3] å°ˆæ³¨ç›£å¯ŸåŠŸèƒ½ (Flexæµè®Šå½¢ç‰ˆ) === */
/* ========================================= */
 
/* æŒ‰éˆ•åŸºç¤éæ¸¡ (åŠ å…¥ transform ä»¥ä¾¿å¹³æ»‘ç¸®æ”¾) */
#focusMonitorBtn {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1),
                width 0.3s ease,
                height 0.3s ease,
                background-color 0.3s ease,
                border-radius 0.3s ease;
    
    /* ç¢ºä¿æŒ‰éˆ•åœ¨ Flex å®¹å™¨ä¸­ä¸æœƒè¢«å£“ç¸® */
    flex-shrink: 0;
}
 
/* ç‹€æ…‹ä¸€ï¼šç¶ ç‡ˆ (ç›£å¯Ÿä¸­ - è«è˜­è¿ªç°ç¶ ) */
.focus-status-green {
    background-color: #8fa398 !important;
    color: white !important;
    border-color: #8fa398 !important;
    box-shadow: 0 0 15px rgba(143, 163, 152, 0.6) !important;
}
 
/* ç‹€æ…‹äºŒï¼šæ©™ç‡ˆ (é–’ç½®è­¦å‘Š - è«è˜­è¿ªé™¶åœŸè‰²) */
.focus-status-orange {
    background-color: #e6b49d !important;
    color: white !important;
    border-color: #e6b49d !important;
    box-shadow: 0 0 15px rgba(230, 180, 157, 0.6) !important;
    animation: monitor-breath 2s infinite ease-in-out;
}
 
/* ç‹€æ…‹ä¸‰ï¼šç´…ç‡ˆ (å…¥ç¡/å¤±ç¥è­¦å‘Š - è«è˜­è¿ªè±†æ²™ç´…) */
.focus-status-red {
    background-color: #d69a92 !important;
    color: white !important;
    border-color: #d69a92 !important;
    box-shadow: 0 0 20px rgba(214, 154, 146, 0.9) !important;
    animation: monitor-pulse 0.5s infinite;
}
 
/* === [æ ¸å¿ƒ] æ¥µä½èª¿è®Šå½¢æ¨¡å¼ (åŸåœ°è®Šèº«) === */
#focusMonitorBtn.minimized {
    /* å¼·åˆ¶è®Šç‚ºå°åœ“é» */
    width: 14px !important;
    height: 14px !important;
    min-height: 0 !important;
    padding: 0 !important;
    
    /* ç§»é™¤æ–‡å­—èˆ‡é‚Šæ¡†ï¼Œåƒ…ä¿ç•™è‰²å¡Š */
    border: 2px solid rgba(255, 255, 255, 0.9) !important;
    border-radius: 50% !important;
    
    /* ç¦æ­¢é»æ“Š (è®Šç‚ºç´”æŒ‡ç¤ºç‡ˆ) */
    pointer-events: none !important;
    opacity: 1 !important;
    cursor: default !important;
    box-shadow: none !important;
    
    /* ç¢ºä¿åœ¨ Flex å®¹å™¨ä¸­é¡¯ç¤º (è¦†è“‹å¯èƒ½ç¹¼æ‰¿çš„ display:none) */
    display: flex !important;
    
    /* å‚ç›´ç½®ä¸­ (é˜²æ­¢ Flex å…§å®¹æ‹‰ä¼¸å°è‡´è®Šå½¢) */
    margin-top: auto;
    margin-bottom: auto;
}
 
/* åœ¨æ¥µä½èª¿æ¨¡å¼ä¸‹ï¼Œéš±è—å…§éƒ¨çš„çœ¼ç›/éˆ´éºåœ–ç¤º */
#focusMonitorBtn.minimized i {
    display: none !important;
}
 
/* ç´…ç‡ˆåœ¨ä½èª¿æ¨¡å¼ä¸‹ä¾ç„¶é–ƒçˆ */
#focusMonitorBtn.minimized.focus-status-red {
    box-shadow: 0 0 10px rgba(214, 154, 146, 0.8) !important;
    animation: monitor-pulse 0.5s infinite;
}
 
/* å‹•ç•« Keyframes */
@keyframes monitor-breath {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.9; }
    100% { transform: scale(1); opacity: 1; }
}
 
@keyframes monitor-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}


/* === [ä¿®è¨‚ V7] æ…¢è®€å°ˆç”¨ï¼šå³ç·£å…¨é«˜é˜²ç¡ç‡ˆ (å¯¬åº¦ 12px ç‰ˆ) === */

/* === [ä¿®è¨‚ V8] æ…¢è®€å°ˆç”¨ï¼šé˜²ç¡ç‡ˆ (85% é«˜åº¦ + åœ“è§’ç‰ˆ) === */
 
#slowReaderFocusIndicator {
    position: fixed;
    
    /* --- ä¿®æ”¹é–‹å§‹ï¼šæ”¹ç‚ºå‚ç›´ç½®ä¸­ï¼Œé«˜åº¦ 85% --- */
    top: 50% !important;           /* å®šä½åˆ°ä¸­é–“ */
    transform: translateY(-50%);   /* å‘ä¸Šä¿®æ­£ 50% ä»¥é”æˆçµ•å°å‚ç›´ç½®ä¸­ */
    height: 85% !important;        /* è¨­å®šé«˜åº¦ç‚º 85% */
    bottom: auto !important;       /* å–æ¶ˆåŸæœ¬çš„æ‹‰ä¼¸è¨­å®š */
    /* --- ä¿®æ”¹çµæŸ --- */
 
    right: 0;
    width: 12px;
    
    /* ç¢ºä¿æœ€ä¸Šå±¤ */
    z-index: 2147483647;
    
    display: none;
    padding: 0;
    margin: 0;
    border: none;
    
    /* --- ä¿®æ”¹é–‹å§‹ï¼šå·¦å´åœ“è§’è™•ç† (åƒä¸€å€‹è† å›Šè²¼åœ¨å³é‚Š) --- */
    border-radius: 12px 0 0 12px !important;
    /* --- ä¿®æ”¹çµæŸ --- */
 
    background-color: transparent;
    cursor: pointer;
    
    /* é è¨­ä¸æ””æˆªé»æ“Šï¼Œä½†åœ¨ prompting ç‹€æ…‹æœƒé–‹å•Ÿ */
    pointer-events: none;
    
    transition: background-color 0.4s ease, box-shadow 0.4s ease;
}

/* ç‹€æ…‹ä¸€ï¼šç¶ ç‡ˆ (ç›£å¯Ÿä¸­ - éœè¬ç°ç¶ ) */
#slowReaderFocusIndicator.status-green {
    background-color: #8FA398 !important; 
    opacity: 0.75; 
    box-shadow: -1px 0 4px rgba(143, 163, 152, 0.4); 
    
    width: 12px;     /* â˜… ä¿®æ”¹ï¼šåŒæ­¥åŠ å¯¬ â˜… */
    pointer-events: auto; 
}
#slowReaderFocusIndicator.status-green:hover {
    opacity: 1; 
    background-color: #7D9186 !important; 
}

/* ç‹€æ…‹äºŒï¼šæ©™ç‡ˆ (180ç§’ - æš–é™¶åœŸè‰²) */
#slowReaderFocusIndicator.status-prompt {
    background-color: #DE9981 !important; 
    pointer-events: auto;
    opacity: 1;
    
    width: 12px;     /* â˜… ä¿®æ”¹ï¼šåŒæ­¥åŠ å¯¬ â˜… */
    
    box-shadow: -2px 0 15px rgba(217, 136, 109, 0.8); 
    animation: full-height-pulse 2s infinite ease-in-out;
}
/* æ“´å¤§é»æ“Šæ„Ÿæ‡‰å€ (ä¿æŒä¸è®Š) */
#slowReaderFocusIndicator.status-prompt::after {
    content: ''; position: absolute; top: 0; left: -40px; right: 0; bottom: 0;
}

/* ç‹€æ…‹ä¸‰ï¼šç´…ç‡ˆ (210ç§’ - éµé½ç´…) */
#slowReaderFocusIndicator.status-red {
    background-color: #C96055 !important; 
    pointer-events: auto;
    opacity: 1;
    
    width: 12px;     /* â˜… ä¿®æ”¹ï¼šåŒæ­¥åŠ å¯¬ â˜… */
    
    box-shadow: -3px 0 25px rgba(201, 96, 85, 0.9);
    animation: full-height-flash 0.5s infinite;
}

/* å‹•ç•«å®šç¾© */
@keyframes full-height-pulse {
    0% { opacity: 0.8; box-shadow: -1px 0 8px rgba(217, 136, 109, 0.5); }
    50% { opacity: 1; box-shadow: -3px 0 20px rgba(217, 136, 109, 0.9); }
    100% { opacity: 0.8; box-shadow: -1px 0 8px rgba(217, 136, 109, 0.5); }
}

@keyframes full-height-flash {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
	
	
</style>

<script>


// ==========================================
// === [æ ¸å¿ƒ] ç¥æ€éŸ³æ•ˆå¼•æ“ (V6 - iOS æŒä¹…æˆæ¬Šç‰ˆ) ===
// ==========================================
const SansiAudio = {
    context: null,
    buffers: {},
    activeSources: {},
    silentNode: null, // æŒä¹…ç„¡è²ç¯€é»

    sounds: {
        'sleep_warning': 'é–‰çœ¼è­¦å‘Š.mp3',
        'leave_warning': 'é›¢é–‹è­¦å‘Š.mp3'
    },

    // åˆå§‹åŒ–ä¸¦è¼‰å…¥éŸ³è¨Š
    init: async function() {
        if (this.context) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        this.context = new AudioContext();
        
        for (const [name, url] of Object.entries(this.sounds)) {
            await this.load(name, url);
        }
    },

    async load(name, url) {
        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            this.buffers[name] = await this.context.decodeAudioData(arrayBuffer);
        } catch (e) {
            console.error(`éŸ³æ•ˆè¼‰å…¥å¤±æ•— [${name}]:`, e);
        }
    },

    // é—œéµå‡½æ•¸ï¼šä½¿ç”¨è€…é»æ“Šå•Ÿå‹•æ™‚å¿…é ˆå‘¼å«ï¼Œé–‹å•Ÿã€ŒéŸ³è¨Šç®¡é“ã€
  // === ä¿®æ”¹ SansiAudio å…§çš„ unlock å‡½å¼ ===
unlock: function() {
    if (!this.context) this.init();
    
    // å¦‚æœç‹€æ…‹æ˜¯ suspendedï¼Œå¼·åˆ¶æ¢å¾©
    if (this.context.state === 'suspended') {
        this.context.resume().then(() => {
            console.log("ğŸ”Š [Audio] iOS éŸ³è¨Šè»Œé“å·²æˆåŠŸæ¢å¾©é‹è¡Œ");
        });
    }

    // å»ºç«‹æˆ–é‡æ–°å»ºç«‹æŒä¹…ç„¡è²ç¯€é»ï¼ˆé˜²æ­¢è¢«ç³»çµ±å›æ”¶ï¼‰
    if (!this.silentNode) {
        const buffer = this.context.createBuffer(1, 1, 22050);
        this.silentNode = this.context.createBufferSource();
        this.silentNode.buffer = buffer;
        this.silentNode.loop = true;
        this.silentNode.connect(this.context.destination);
        this.silentNode.start(0);
        console.log("ğŸ”Š [Audio] éœé»˜å¾ªç’°ç¯€é»å·²æ›è¼‰");
    }
},

    // æ’­æ”¾è­¦å ± (å› ç‚ºç®¡é“å·²è§£é–ï¼Œç¾åœ¨éš¨æ™‚å‘¼å«éƒ½æœƒéŸ¿)
    play: function(name, loop = false) {
        if (!this.context || !this.buffers[name]) return;
        
        // å¦‚æœæ­£åœ¨éŸ¿ï¼Œå…ˆåœæ‰
        this.stop(name);

        const source = this.context.createBufferSource();
        const gainNode = this.context.createGain();
        source.buffer = this.buffers[name];
        source.loop = loop;
        
        source.connect(gainNode);
        gainNode.connect(this.context.destination);
        
        source.start(0);
        this.activeSources[name] = { source, gain: gainNode };
        console.log(`ğŸµ [Audio] æ­£åœ¨æ’­æ”¾: ${name}`);
    },

    stop: function(name) {
        const active = this.activeSources[name];
        if (active) {
            try {
                active.source.stop();
                active.source.disconnect();
                active.gain.disconnect();
            } catch(e){}
            this.activeSources[name] = null;
        }
    }
};
 
// è‡ªå‹•åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    const unlockHandler = () => {
        SansiAudio.unlock();
        document.removeEventListener('touchstart', unlockHandler);
        document.removeEventListener('click', unlockHandler);
    };
    document.addEventListener('touchstart', unlockHandler, {passive: true});
    document.addEventListener('click', unlockHandler, {passive: true});
    SansiAudio.init();
});

	

// ==========================================
// === [æ–°å¢] å·²è®€ç‹€æ…‹ç®¡ç†æ¨¡çµ„ ===
// ==========================================
 
// 1. å…¨åŸŸè®Šæ•¸
let currentReadingArticleTitle = "";   // è¨˜éŒ„ç›®å‰æ­£åœ¨é–±è®€çš„æ–‡ç« æ¨™é¡Œ
let isAutoScrollingToAnalysis = false; // æ——æ¨™ï¼šæ˜¯å¦æ­£åœ¨ç”±æŒ‰éˆ•è§¸ç™¼æ»¾å‹•
 
// 2. å¾ LocalStorage ç²å–å·²è®€åˆ—è¡¨
function getReadArticles() {
    const stored = localStorage.getItem('sansi_read_articles_list');
    return stored ? JSON.parse(stored) : [];
}
 
// 3. æ¨™è¨˜æ–‡ç« ç‚ºå·²è®€ (æ ¸å¿ƒå‡½æ•¸)
function markArticleAsRead(title) {
    if (!title) return;
    let readList = getReadArticles();
    
    // å¦‚æœæ¨™é¡Œå°šæœªåœ¨åˆ—è¡¨ä¸­ï¼Œæ‰é€²è¡ŒåŠ å…¥
    if (!readList.includes(title)) {
        readList.push(title);
        localStorage.setItem('sansi_read_articles_list', JSON.stringify(readList));
        console.log(`æ–‡ç«  [${title}] å·²æ¨™è¨˜ç‚ºå·²è®€`);
        
        // è§¸ç™¼è¼•å¾®éœ‡å‹•å›é¥‹ (å¦‚æœè£ç½®æ”¯æ´)
        if (navigator.vibrate) navigator.vibrate(20);
    }
}


	
// =======================================================
// === Live2D è²“å’ªç³»çµ± (é è¨­ç™½è²“ + ç„¡TTS + é›™é‡è²æ•ˆ + æµ·é‡é¡Œåº«) ===
// =======================================================

let app;
let modelContainer; 
const CANVAS_ID = 'live2d-canvas';

const MODEL_PATH_HIJIKI = 'live2d/hijiki/runtime/hijiki.model3.json';
const MODEL_PATH_TORORO = 'live2d/tororo/runtime/tororo.model3.json';

// éš¨æ©Ÿè²“å«è²æ•ˆåº«
const CAT_SOUNDS = [
    'è²“å«ä¸€.mp3', 
    'è²“å«äºŒ.mp3', 
    'è²“å«ä¸‰.mp3'
];

// --- äº’å‹•ç‹€æ…‹ ---
let isDragging = false;
let isPinching = false;
let isLongPress = false; 
let isCatLoading = false; // è¼‰å…¥é–å®šæ——æ¨™

// åº§æ¨™ç›¸é—œ
let startX = 0, startY = 0;
let containerStartX = 0, containerStartY = 0;

// ç¸®æ”¾ç›¸é—œ
let initialPinchDist = 0;
let initialScale = 1;

// é›™æ“Šç›¸é—œ
let lastTapTime = 0;

// é•·æŒ‰ç›¸é—œ
let pressTimer = null;
const LONG_PRESS_DURATION = 800; // 800ms è§¸ç™¼

// å°è©±æ°£æ³¡å…ƒç´ 
let speechBubble = null;
let bubbleTimer = null;

document.addEventListener('DOMContentLoaded', () => {
    let savedMode = localStorage.getItem('sansi_cat_mode');
    
    // â˜… ä¿®æ”¹ï¼šå¦‚æœæ²’æœ‰ç´€éŒ„ (ç¬¬ä¸€æ¬¡é€²å…¥)ï¼Œé è¨­ç‚ºç™½è²“ (tororo)
    if (!savedMode) {
        savedMode = 'tororo';
    }

    if (savedMode && savedMode !== 'none') {
        setTimeout(() => selectCatMode(savedMode, false), 500);
    }
    
    createSpeechBubble();
    initGlobalInteraction();
    
    window.addEventListener('resize', () => {
        if (modelContainer && document.getElementById(CANVAS_ID).style.display !== 'none') {
            setTimeout(repositionCats, 100);
        }
    });


// éœé»˜é è¼‰ (é é¢è¼‰å…¥ 5 ç§’å¾ŒåŸ·è¡Œï¼Œä¸å½±éŸ¿ç•¶å‰æ“ä½œ)
    setTimeout(() => {
        // æª¢æŸ¥å¿«å–å‡½æ•¸æ˜¯å¦å­˜åœ¨ï¼Œé¿å…å ±éŒ¯
        if (typeof fetchWithCache === 'function') {
            console.log("ğŸˆ [Live2D] é–‹å§‹èƒŒæ™¯éœé»˜é è¼‰...");
            fetchWithCache(MODEL_PATH_HIJIKI); // é è¼‰é»‘è²“
            fetchWithCache(MODEL_PATH_TORORO); // é è¼‰ç™½è²“
        }
    }, 1500);



	
});


// ==========================================
// === Live2D IndexedDB å¿«å–ç®¡ç†å™¨ (åŠ é€Ÿæ ¸å¿ƒ) ===
// ==========================================

const CACHE_DB_NAME = 'SansiLive2DCache';
const CACHE_STORE_NAME = 'files';
const CACHE_VERSION = 1;

// 1. åˆå§‹åŒ–è³‡æ–™åº«
function openCacheDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(CACHE_DB_NAME, CACHE_VERSION);
        req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(CACHE_STORE_NAME)) {
                db.createObjectStore(CACHE_STORE_NAME);
            }
        };
        req.onsuccess = (e) => resolve(e.target.result);
        req.onerror = (e) => reject(e);
    });
}

// 2. æ ¸å¿ƒï¼šç²å–æª”æ¡ˆ (å„ªå…ˆæŸ¥åº«ï¼Œç„¡å‰‡ä¸‹è¼‰ä¸¦å¯«åº«)
async function fetchWithCache(url) {
    try {
        const db = await openCacheDB();
        const tx = db.transaction(CACHE_STORE_NAME, 'readonly');
        const store = tx.objectStore(CACHE_STORE_NAME);
        
        // å˜—è©¦å¾è³‡æ–™åº«è®€å–
        const cachedFile = await new Promise((resolve) => {
            const req = store.get(url);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => resolve(null);
        });

        if (cachedFile) {
            // console.log(`[Cache Hit] å¾æœ¬åœ°è®€å–: ${url}`);
            return cachedFile; // ç›´æ¥å›å‚³ Blob
        }

        // è³‡æ–™åº«æ²’æœ‰ï¼Œå¾ç¶²çµ¡ä¸‹è¼‰
        // console.log(`[Network] ä¸‹è¼‰ä¸­: ${url}`);
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
        const blob = await response.blob();

        // å¯«å…¥è³‡æ–™åº« (éåŒæ­¥åŸ·è¡Œï¼Œä¸é˜»æ“‹å›å‚³)
        const writeTx = db.transaction(CACHE_STORE_NAME, 'readwrite');
        writeTx.objectStore(CACHE_STORE_NAME).put(blob, url);

        return blob;

    } catch (err) {
        console.warn("å¿«å–ç³»çµ±å‡ºéŒ¯ (é™ç´šç‚ºæ™®é€šä¸‹è¼‰):", err);
        const response = await fetch(url);
        return await response.blob();
    }
}

// è¼”åŠ©å‡½å¼ï¼šå°‡ Blob è½‰ç‚º Base64 DataURI (é¿é–‹ Blob URL æ¬Šé™å•é¡Œ)
function blobToDataURL(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

	// 3. Live2D æ¨¡å‹è¼‰å…¥å™¨ (Base64 å…§åµŒç‰ˆ - çµ‚æ¥µä¿®å¾©)
async function loadCachedLive2DModel(modelUrl) {
    // A. ä¸‹è¼‰ä¸¦è§£æ model3.json
    const jsonBlob = await fetchWithCache(modelUrl);
    const jsonText = await jsonBlob.text();
    const modelData = JSON.parse(jsonText);

    // B. è¨ˆç®—åŸºç¤è·¯å¾‘
    const basePath = modelUrl.substring(0, modelUrl.lastIndexOf('/') + 1);

    // C. å»ºç«‹ Promise é™£åˆ—
    const promises = [];

    // è¼”åŠ©ï¼šå°‡è·¯å¾‘æ›¿æ›ç‚º Base64 Data URI
    const replacePathWithBase64 = async (obj, key) => {
        const relativePath = obj[key];
        if (!relativePath) return;

        const fullUrl = basePath + relativePath;
        const blob = await fetchWithCache(fullUrl);
        
        // â˜… é—œéµæ”¹è®Šï¼šè½‰æˆ Base64 å­—ä¸²ï¼Œè€Œä¸æ˜¯ Blob URL
        const dataUrl = await blobToDataURL(blob);
        obj[key] = dataUrl;
    };

    // D. æƒæä¸¦æ›¿æ›æ‰€æœ‰è³‡æº
    if (modelData.FileReferences) {
        // 1. Moc æª” (æ ¸å¿ƒæ¨¡å‹)
        if (modelData.FileReferences.Moc) {
            promises.push(replacePathWithBase64(modelData.FileReferences, 'Moc'));
        }
        // 2. Physics æª” (ç‰©ç†)
        if (modelData.FileReferences.Physics) {
            promises.push(replacePathWithBase64(modelData.FileReferences, 'Physics'));
        }
        // 3. Textures (è²¼åœ–é™£åˆ—)
        if (modelData.FileReferences.Textures) {
            modelData.FileReferences.Textures.forEach((tex, index) => {
                const fullUrl = basePath + tex;
                promises.push((async () => {
                    const blob = await fetchWithCache(fullUrl);
                    const dataUrl = await blobToDataURL(blob);
                    modelData.FileReferences.Textures[index] = dataUrl;
                })());
            });
        }
        // 4. Motions (å‹•ä½œ)
        if (modelData.FileReferences.Motions) {
            const groups = modelData.FileReferences.Motions;
            for (const groupName in groups) {
                groups[groupName].forEach(motion => {
                    if (motion.File) {
                        const fullUrl = basePath + motion.File;
                        promises.push((async () => {
                            const blob = await fetchWithCache(fullUrl);
                            const dataUrl = await blobToDataURL(blob);
                            motion.File = dataUrl;
                        })());
                    }
                });
            }
        }
    }

    // ç­‰å¾…æ‰€æœ‰æª”æ¡ˆéƒ½è½‰æˆ Base64 å­—ä¸²
    await Promise.all(promises);

    // E. è¨­å®šå¿…è¦å±¬æ€§ä»¥æ»¿è¶³æ’ä»¶æª¢æŸ¥
    // é›–ç„¶ç¾åœ¨æ‰€æœ‰è³‡æºéƒ½æ˜¯ Data URIï¼Œæ’ä»¶ä»éœ€è¦ä¸€å€‹ url æ¬„ä½ä¾†é€šéæ ¼å¼é©—è­‰
    modelData.url = modelUrl;

    // F. è¼‰å…¥æ¨¡å‹
    // ç”±æ–¼æ‰€æœ‰è·¯å¾‘éƒ½è®Šæˆäº† "data:image/png;base64,..." é€™ç¨®æ ¼å¼ï¼Œ
    // æ’ä»¶æœƒç›´æ¥è§£æå­—ä¸²æ•¸æ“šï¼Œå®Œå…¨ä¸æœƒç™¼å‡ºç¶²çµ¡è«‹æ±‚ã€‚
    return await PIXI.live2d.Live2DModel.from(modelData);
}



	
function createSpeechBubble() {
    if (document.getElementById('catSpeechBubble')) return;
    speechBubble = document.createElement('div');
    speechBubble.id = 'catSpeechBubble';
    speechBubble.className = 'cat-speech-bubble';
    speechBubble.style.display = 'none'; 
    document.body.appendChild(speechBubble);
}

async function initLive2DApp() {
    const canvas = document.getElementById(CANVAS_ID);
    if (app) return;

    // â˜…â˜…â˜… å„ªåŒ–ï¼šæ‰‹æ©Ÿç«¯é˜²æ»¾å‹•é—œéµè¨­å®š â˜…â˜…â˜…
    // é€™è¡Œ CSS æœƒå‘Šè¨´ç€è¦½å™¨ï¼šåœ¨é€™å€‹ç•«å¸ƒä¸Šç¦æ­¢é è¨­çš„æ»‘å‹•/ç¸®æ”¾è¡Œç‚º
    canvas.style.touchAction = 'none'; 

    app = new PIXI.Application({
        view: canvas,
        autoStart: true,
        backgroundAlpha: 0,
        resizeTo: window, 
        resolution: window.devicePixelRatio || 1,
        autoDensity: true,
    });

    modelContainer = new PIXI.Container();
    app.stage.addChild(modelContainer);
    
    modelContainer.visible = false;
    modelContainer.alpha = 0;
}

async function selectCatMode(mode, save = true) {
    if (isCatLoading) return; // é˜²æ­¢é‡è¤‡é»æ“Š
    isCatLoading = true;

    if (save) {
        localStorage.setItem('sansi_cat_mode', mode);
        const modal = document.getElementById('catSelectionModal');
        if(modal) modal.style.display = 'none';
    }

    const canvas = document.getElementById(CANVAS_ID);
    if (mode === 'none') {
        canvas.style.display = 'none';
        if (modelContainer) modelContainer.removeChildren();
        hideBubble(); 
        isCatLoading = false;
        return;
    }

    await initLive2DApp();
    canvas.style.display = 'block';
    
    modelContainer.removeChildren();
    modelContainer.scale.set(1);
    modelContainer.alpha = 0; 

    try {
        // â˜…â˜…â˜… ä¿®æ”¹é–‹å§‹ï¼šä¸‰æ®µå¼å¤§å°åˆ¤æ–· â˜…â˜…â˜…
        const screenW = window.innerWidth;
        let baseScale;

        if (screenW < 600) {
            baseScale = 0.10; // æ‰‹æ©Ÿ (ä¸è®Š)
        } else if (screenW <= 1024) {
            baseScale = 0.15; // å¹³æ¿ (ä¸è®Š)
        } else {
            baseScale = 0.15; // é›»è…¦ (æ”¾å¤§ä¸€å€)
        }
        // â˜…â˜…â˜… ä¿®æ”¹çµæŸ â˜…â˜…â˜…

        if (mode === 'hijiki') {
            await loadModelToContainer(MODEL_PATH_HIJIKI, baseScale, 0); 
        } else if (mode === 'tororo') {
            await loadModelToContainer(MODEL_PATH_TORORO, baseScale, 0);
        } else if (mode === 'both') {
            // é›™è²“æ¨¡å¼æ™‚ï¼Œä½ç½®åç§»é‡ä¹Ÿè¦æ ¹æ“šè£ç½®èª¿æ•´ï¼Œé¿å…é‡ç–Šæˆ–å¤ªé–‹
            let offset = screenW < 600 ? 30 : (screenW <= 1024 ? 50 : 80);
            
            await loadModelToContainer(MODEL_PATH_HIJIKI, baseScale * 0.9, -offset);
            await loadModelToContainer(MODEL_PATH_TORORO, baseScale * 0.9, offset);
        }
        
        setTimeout(() => {
            forceInitialPosition();
            
            let fadeTicker = setInterval(() => {
                modelContainer.visible = true;
                modelContainer.alpha += 0.1;
                if (modelContainer.alpha >= 1) {
                    modelContainer.alpha = 1;
                    clearInterval(fadeTicker);
                }
            }, 30);
        }, 300);
        
    } catch (err) {
        console.error("æ¨¡å‹è¼‰å…¥å¤±æ•—:", err);
    } finally {
        isCatLoading = false;
    }
}

// === ä¿®è¨‚ç‰ˆï¼šæ”¯æ´ IndexedDB å¿«å–çš„è¼‰å…¥å‡½æ•¸ ===
async function loadModelToContainer(path, scale, xOffset) {
    try {
        // 1. ä½¿ç”¨å¿«å–åŠ è¼‰å™¨ (é€™æœƒå›å‚³å·²ç¶“çµ„è£å¥½çš„ Model ç‰©ä»¶)
        const model = await loadCachedLive2DModel(path);
        
        // 2. è¨­å®šæ¨¡å‹åƒæ•¸
        model.scale.set(scale);
        model._baseOffsetX = xOffset;
        model.x = xOffset; 
        model.y = 0;
        
        // 3. åŠ å…¥èˆå°
        modelContainer.addChild(model);
        
    } catch (e) {
        console.error("å¿«å–è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦ç›´æ¥è¼‰å…¥...", e);
        // Fallback: å¦‚æœå¿«å–é‚è¼¯å¤±æ•—ï¼Œé€€å›åŸæœ¬çš„ç›´æ¥ç¶²çµ¡è¼‰å…¥
        const model = await PIXI.live2d.Live2DModel.from(path);
        model.scale.set(scale);
        model.x = xOffset;
        modelContainer.addChild(model);
    }
}

function forceInitialPosition() {
    if (!modelContainer) return;
    const bounds = modelContainer.getBounds();
    const screenW = window.innerWidth;
    const screenH = window.innerHeight;

    let targetX = screenW - bounds.width - 20;
    let targetY = screenH - bounds.height - 40;

    if (targetX < 0) targetX = 0;
    if (targetY < 0) targetY = 0;

    modelContainer.x = targetX;
    modelContainer.y = targetY;
}

// === é‚Šç•Œé™åˆ¶ (å…è¨±ç§»å‡ºä¸€åŠ) ===
function repositionCats() {
    if (!modelContainer || modelContainer.children.length === 0) return;

    const bounds = modelContainer.getBounds();
    const screenW = window.innerWidth;
    const screenH = window.innerHeight;
    
    // å…è¨±ç§»å‡ºä¸€åŠ
    const allowOverflowX = bounds.width * 0.5;
    const allowOverflowY = bounds.height * 0.5;

    let newX = modelContainer.x;
    let newY = modelContainer.y;

    // å³é‚Šç•Œ
    if (newX + bounds.width > screenW + allowOverflowX) {
        newX = screenW + allowOverflowX - bounds.width;
    }
    // ä¸‹é‚Šç•Œ
    if (newY + bounds.height > screenH + allowOverflowY) {
        newY = screenH + allowOverflowY - bounds.height;
    }
    // å·¦é‚Šç•Œ
    if (newX < -allowOverflowX) {
        newX = -allowOverflowX;
    }
    // ä¸Šé‚Šç•Œ
    if (newY < -allowOverflowY) {
        newY = -allowOverflowY;
    }

    modelContainer.position.set(newX, newY);
    
    if (speechBubble.style.display === 'block') {
        updateBubblePosition();
    }
}

// =======================================================
// === å…¨åŸŸäº’å‹•é‚è¼¯ (å·²é‡å°æ‰‹æ©Ÿæµæš¢åº¦å„ªåŒ–) ===
// =======================================================

function initGlobalInteraction() {
    const canvas = document.getElementById(CANVAS_ID);
    
  function hitTest(x, y) {
        if (!modelContainer || modelContainer.children.length === 0) return false;
        const bounds = modelContainer.getBounds();
 
        // 1. é ‚éƒ¨è¨­å®š (æ‚¨è¦ºå¾—ç†æƒ³ï¼Œç¶­æŒä¸è®Š)
        // å¿½ç•¥é ‚éƒ¨ 15% çš„é«˜åº¦
        const topOffset = bounds.height * 0.15;
 
        // 2. â˜…â˜…â˜… æ–°å¢ï¼šå·¦å³ç¸®æ¸›å€¼ (Side Shrink) â˜…â˜…â˜…
        // æ•¸å€¼è¶Šå¤§ï¼Œå·¦å³å…©é‚Šè¶Šé›£é»åˆ° (å‘å…§ç¸®)
        // å»ºè­°è¨­å®šï¼šbounds.width * 0.15 (ä»£è¡¨å·¦å³å„ç¸®æ¸› 15% çš„å¯¬åº¦)
        const sideShrink = bounds.width * 0.3;
 
        // 3. â˜…â˜…â˜… æ–°å¢ï¼šåº•éƒ¨ç¸®æ¸›å€¼ (Bottom Shrink) â˜…â˜…â˜…
        // æ•¸å€¼è¶Šå¤§ï¼Œè…³ä¸‹åˆ¤å®šå€è¶ŠçŸ­
        // å»ºè­°è¨­å®šï¼š20 (ä»£è¡¨åº•éƒ¨å‘ä¸Šç¸® 20px)
        const bottomShrink = 40;
 
        // è¨ˆç®—æœ‰æ•ˆç¯„åœï¼š
        return (
            x >= bounds.x + sideShrink &&                // å·¦é‚Šç•Œï¼šå‘å³ç¸®
            x <= bounds.x + bounds.width - sideShrink && // å³é‚Šç•Œï¼šå‘å·¦ç¸®
            y >= bounds.y + topOffset &&                 // é ‚éƒ¨ï¼šç¶­æŒåŸæ¨£
            y <= bounds.y + bounds.height - bottomShrink // åº•éƒ¨ï¼šå‘ä¸Šç¸®
        );
    }

	
    function getPinchDistance(touches) {
        return Math.hypot(
            touches[0].clientX - touches[1].clientX,
            touches[0].clientY - touches[1].clientY
        );
    }

    // --- é•·æŒ‰é‚è¼¯ ---
    function startLongPressTimer() {
        isLongPress = false;
        if (pressTimer) clearTimeout(pressTimer);
        
        pressTimer = setTimeout(() => {
            isLongPress = true;
            isDragging = false; 
            triggerCatChat(); 
            if (navigator.vibrate) navigator.vibrate(80);
        }, LONG_PRESS_DURATION);
    }

    function cancelLongPressTimer() {
        if (pressTimer) {
            clearTimeout(pressTimer);
            pressTimer = null;
        }
    }

    // --- è§¸æ§äº‹ä»¶ (Touch Events) ---
    window.addEventListener('touchstart', (e) => {
        if (canvas.style.display === 'none') return;

        // é›™æŒ‡ç¸®æ”¾
        if (e.touches.length === 2) {
            cancelLongPressTimer();
            if (hitTest(e.touches[0].clientX, e.touches[0].clientY) || 
                hitTest(e.touches[1].clientX, e.touches[1].clientY)) {
                // â˜… é˜²æ­¢ç¸®æ”¾æ™‚è§¸ç™¼ç€è¦½å™¨ç¸®æ”¾
                if (e.cancelable) e.preventDefault();
                isPinching = true;
                isDragging = false;
                initialPinchDist = getPinchDistance(e.touches);
                initialScale = modelContainer.scale.x;
                canvas.setAttribute('data-interacting', 'true');
                return;
            }
        }

        // å–®æŒ‡æ‹–æ›³/é»æ“Š
        if (e.touches.length === 1) {
            const touch = e.touches[0];
            if (hitTest(touch.clientX, touch.clientY)) {
                // â˜… é—œéµå„ªåŒ–ï¼šä¸€æ—¦ç¢ºèªé»åˆ°è²“ï¼Œç«‹åˆ»ç¦æ­¢é è¨­äº‹ä»¶ï¼ˆé˜²æ­¢é é¢æ»¾å‹•ï¼‰
                if (e.cancelable) e.preventDefault();
                
                isDragging = false;
                startX = touch.clientX;
                startY = touch.clientY;
                containerStartX = modelContainer.x;
                containerStartY = modelContainer.y;
                
                canvas.setAttribute('data-interacting', 'true');
                startLongPressTimer();
            } else {
                canvas.removeAttribute('data-interacting');
            }
        }
    }, { passive: false }); // passive: false å…è¨±æˆ‘å€‘ä½¿ç”¨ preventDefault

    window.addEventListener('touchmove', (e) => {
        // â˜… æ ¸å¿ƒå„ªåŒ–ï¼šå¦‚æœæ­£åœ¨èˆ‡è²“äº’å‹•ï¼Œç„¡æ¢ä»¶ã€ç«‹å³é˜»æ­¢é é¢æ»¾å‹•
        if (canvas.getAttribute('data-interacting') === 'true') {
            if (e.cancelable) e.preventDefault();
        } else {
            return;
        }

        // ç§»å‹•å®¹éŒ¯ (15px)
        if (!isPinching && Math.hypot(e.touches[0].clientX - startX, e.touches[0].clientY - startY) > 15) {
            cancelLongPressTimer();
            if (!isDragging) isDragging = true;
        }

        // ç¸®æ”¾é‚è¼¯
        if (isPinching && e.touches.length === 2) {
            const currentDist = getPinchDistance(e.touches);
            if (initialPinchDist > 0) {
                const scaleFactor = currentDist / initialPinchDist;
                let newScale = initialScale * scaleFactor;
                // ç„¡é™ç¸®æ”¾ï¼š0.01 ~ 10.0
                newScale = Math.max(0.01, Math.min(newScale, 10.0));
                modelContainer.scale.set(newScale);
                updateBubblePosition(); 
            }
            return;
        }

        // æ‹–æ›³é‚è¼¯
        if (!isPinching && e.touches.length === 1) {
            if (isLongPress) return;

            const touch = e.touches[0];
            const dx = touch.clientX - startX;
            const dy = touch.clientY - startY;

            if (isDragging) {
                modelContainer.x = containerStartX + dx;
                modelContainer.y = containerStartY + dy;
                updateBubblePosition();
            }
        }
    }, { passive: false });

    window.addEventListener('touchend', (e) => {
        cancelLongPressTimer();

        if (isPinching && e.touches.length < 2) {
            isPinching = false;
            repositionCats(); 
            return;
        }

        if (canvas.getAttribute('data-interacting') === 'true') {
            if (!isDragging && !isLongPress) {
                handleDoubleTap(); 
            }
            
            isDragging = false;
            canvas.removeAttribute('data-interacting');
            repositionCats();
        }
        isLongPress = false;
    });

    // --- æ»‘é¼ äº‹ä»¶ (Mouse Events) ---
    window.addEventListener('mousedown', (e) => {
        if (canvas.style.display === 'none') return;
        if (e.button !== 0) return;

        if (hitTest(e.clientX, e.clientY)) {
            e.preventDefault();
            isDragging = false;
            startX = e.clientX;
            startY = e.clientY;
            containerStartX = modelContainer.x;
            containerStartY = modelContainer.y;
            canvas.setAttribute('data-interacting', 'true');
            document.body.classList.add('cat-dragging');
            startLongPressTimer();
        }
    });

    window.addEventListener('mousemove', (e) => {
        if (hitTest(e.clientX, e.clientY)) {
            document.body.classList.add('cat-hovering');
        } else {
            document.body.classList.remove('cat-hovering');
        }

        if (canvas.getAttribute('data-interacting') !== 'true') return;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        if (Math.hypot(dx, dy) > 10) {
            cancelLongPressTimer();
            if (!isDragging) isDragging = true;
        }

        if (isDragging && !isLongPress) {
            modelContainer.x = containerStartX + dx;
            modelContainer.y = containerStartY + dy;
            updateBubblePosition();
        }
    });

    window.addEventListener('mouseup', () => {
        cancelLongPressTimer();

        if (canvas.getAttribute('data-interacting') === 'true') {
            if (!isDragging && !isLongPress) {
                handleDoubleTap(); 
            }
            repositionCats(); 
        }
        isDragging = false;
        isLongPress = false;
        canvas.removeAttribute('data-interacting');
        document.body.classList.remove('cat-dragging');
    });
    
    window.addEventListener('wheel', (e) => {
        if (canvas.style.display === 'none') return;
        if (hitTest(e.clientX, e.clientY)) {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            let newScale = modelContainer.scale.x * zoomFactor;
            newScale = Math.max(0.01, Math.min(newScale, 10.0));
            modelContainer.scale.set(newScale);
            repositionCats();
            updateBubblePosition();
        }
    }, { passive: false });
}


	

// === é›™æ“Šé‚è¼¯ (æ’­æ”¾éš¨æ©ŸéŸ³æ•ˆ + éš±è—æ°£æ³¡) ===
function handleDoubleTap() {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTapTime;
    
    if (tapLength < 500 && tapLength > 50) {
        // â˜… è§¸ç™¼é›™æ“Šäº‹ä»¶ â˜…
        hideBubble(); // éš±è—æ°£æ³¡
        triggerCatReaction(); // è§¸ç™¼å‹•ä½œ
        triggerVisualEffect(); // è§¸ç™¼è¦–è¦º
        
        // â˜… éš¨æ©Ÿæ’­æ”¾è²“å«è² â˜…
        playRandomCatSound();
        
        lastTapTime = 0; 
    } else {
        lastTapTime = currentTime;
    }
}

// === æ–°å¢ï¼šéš¨æ©Ÿæ’­æ”¾è²“å«è² ===
function playRandomCatSound() {
    // éš¨æ©Ÿé¸å–ä¸€å€‹éŸ³æ•ˆ
    const randomSoundUrl = CAT_SOUNDS[Math.floor(Math.random() * CAT_SOUNDS.length)];
    const audio = new Audio(randomSoundUrl);
    audio.volume = 0.6;
    audio.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å—é˜»:", e));
}

// === é•·æŒ‰å°è©±é‚è¼¯ (å·²ä¿®æ”¹ç‚ºä½¿ç”¨ gemini-fast) ===
// === é•·æŒ‰å°è©±é‚è¼¯ (å·²ä¿®æ”¹ç‚ºä½¿ç”¨ gemini-fast) ===
async function triggerCatChat() {
    // å¼·åˆ¶é‡ç½®/é¡¯ç¤ºæ°£æ³¡
    showBubble("å–µ... è®“æˆ‘æƒ³æƒ³... <span class='cat-loading-dots'></span>", 0); 
    triggerCatReaction();

    // 1. æµ·é‡åˆ†é¡åº« (å°ˆæ³¨æ–¼ä½œå®¶ã€ä½œå“ã€è»¼äº‹ - æ•¸é‡å……è¶³)
    const categories = [
        // --- é­¯è¿…èˆ‡ç¾ä»£æ–‡å­¸ ---
        'é­¯è¿…çš„ã€Šç‹‚äººæ—¥è¨˜ã€‹', 'é­¯è¿…çš„ã€Šå­”ä¹™å·±ã€‹', 'é­¯è¿…çš„ã€Šé˜¿Qæ­£å‚³ã€‹', 'é­¯è¿…æ£„é†«å¾æ–‡çš„åŸå› ', 'é­¯è¿…èˆ‡æœ±å®‰çš„é—œä¿‚',
        'é­¯è¿…çš„ç™¾è‰åœ’', 'å¼µæ„›ç²çš„ã€Šå‚¾åŸä¹‹æˆ€ã€‹', 'å¼µæ„›ç²çš„ã€Šé‡‘é–è¨˜ã€‹', 'å¼µæ„›ç²èˆ‡èƒ¡è˜­æˆçš„ç³¾è‘›', 'å¼µæ„›ç²æ™šå¹´çš„å­¤ç¨',
        'å¼µæ„›ç²çš„æ——è¢ç™–å¥½', 'å¾å¿—æ‘©çš„ã€Šå†åˆ¥åº·æ©‹ã€‹', 'å¾å¿—æ‘©èˆ‡æ—å¾½å› ', 'å¾å¿—æ‘©èˆ‡é™¸å°æ›¼', 'æ²ˆå¾æ–‡çš„ã€Šé‚ŠåŸã€‹',
        'æ²ˆå¾æ–‡èˆ‡å¼µå…†å’Œçš„æƒ…æ›¸', 'éŒ¢é¾æ›¸çš„ã€ŠåœåŸã€‹', 'éŒ¢é¾æ›¸çš„é©šäººè¨˜æ†¶åŠ›', 'æ¥Šçµ³çš„ã€Šæˆ‘å€‘ä»¨ã€‹', 'å·´é‡‘çš„ã€Šå®¶ã€‹',
        'å·´é‡‘çš„ç­†åç”±ä¾†', 'è€èˆçš„ã€Šé§±é§ç¥¥å­ã€‹', 'è€èˆçš„ã€ŠèŒ¶é¤¨ã€‹', 'è€èˆçš„å¹½é»˜æ„Ÿ', 'è•­ç´…çš„ã€Šå‘¼è˜­æ²³å‚³ã€‹',
        'è•­ç´…åå·çš„æƒ…è·¯', 'èŒ…ç›¾çš„ã€Šå­å¤œã€‹', 'éƒé”å¤«çš„ã€Šæ²‰æ·ªã€‹', 'èä¸€å¤šçš„æ„›åœ‹è©©', 'æˆ´æœ›èˆ’çš„ã€Šé›¨å··ã€‹',
        'æœ±è‡ªæ¸…çš„ã€ŠèƒŒå½±ã€‹', 'æœ±è‡ªæ¸…ä¸åƒç¾åœ‹éºµç²‰', 'å†°å¿ƒçš„ã€Šç¹æ˜Ÿã€‹', 'å†°å¿ƒçš„ã€Šå¯„å°è®€è€…ã€‹', 'æ—æµ·éŸ³çš„ã€ŠåŸå—èˆŠäº‹ã€‹',
        
        // --- æ¸¯å°èˆ‡ç•¶ä»£æ–‡å­¸ ---
        'é‡‘åº¸çš„ã€Šå°„éµ°è‹±é›„å‚³ã€‹', 'é‡‘åº¸çš„ã€Šç¥éµ°ä¿ ä¾¶ã€‹', 'é‡‘åº¸çš„ã€Šå¤©é¾å…«éƒ¨ã€‹', 'é‡‘åº¸ç­†åçš„ç”±ä¾†', 'é‡‘åº¸å°èªªä¸­çš„æ­·å²äººç‰©',
        'å¤é¾çš„å—œé…’å¦‚å‘½', 'å¤é¾ç­†ä¸‹çš„æµªå­å½¢è±¡', 'å€ªåŒ¡çš„è¡›æ–¯ç†ç³»åˆ—', 'å€ªåŒ¡å¹«é‡‘åº¸ä»£ç­†çš„è¶£äº‹', 'ä¸‰æ¯›çš„æ’’å“ˆæ‹‰æ•…äº‹',
        'ä¸‰æ¯›èˆ‡è·è¥¿çš„æ„›æƒ…', 'ç“Šç‘¤çš„è¨€æƒ…ä¸–ç•Œ', 'ä½™å…‰ä¸­çš„ã€Šé„‰æ„ã€‹', 'ç™½å…ˆå‹‡çš„ã€Šè‡ºåŒ—äººã€‹', 'ç™½å…ˆå‹‡çš„ã€ŠéŠåœ’é©šå¤¢ã€‹',
        'è¥¿è¥¿çš„ã€Šæˆ‘åŸã€‹', 'è¥¿è¥¿çš„ã€Šåƒæˆ‘é€™æ¨£çš„ä¸€å€‹å¥³å­ã€‹', 'åŠ‰ä»¥é¬¯çš„ã€Šå°å€’ã€‹', 'åŠ‰ä»¥é¬¯çš„ã€Šé…’å¾’ã€‹æ„è­˜æµ', 'ä¹Ÿæ–¯çš„é£²é£Ÿæ–‡å­¸',
        'è‘£å•Ÿç« çš„ã€Šå¤©å·¥é–‹ç‰©ã€‹', 'è«è¨€çš„ã€Šç´…é«˜ç²±ã€‹', 'è«è¨€çš„é­”å¹»ç¾å¯¦ä¸»ç¾©', 'ä½™è¯çš„ã€Šæ´»è‘—ã€‹', 'ä½™è¯çš„ã€Šè¨±ä¸‰è§€è³£è¡€è¨˜ã€‹',
        'è˜‡ç«¥çš„ã€Šå¦»å¦¾æˆç¾¤ã€‹', 'é˜¿åŸçš„ã€Šæ£‹ç‹ã€‹', 'ç‹å®‰æ†¶çš„ã€Šé•·æ¨æ­Œã€‹', 'é™³ä¹‹è—©çš„ã€Šå¤±æ ¹çš„è˜­èŠ±ã€‹', 'æ¢å¯¦ç§‹çš„ã€Šé›…èˆå°å“ã€‹',
        'æ—èªå ‚çš„å¹½é»˜å“²å­¸', 'èƒ¡é©çš„ã€Šå˜—è©¦é›†ã€‹', 'è”¡å…ƒåŸ¹çš„æ•™è‚²æ€æƒ³', 'æ¢å•Ÿè¶…çš„ã€Šæ–°æ°‘èªªã€‹', 'ç‹åœ‹ç¶­çš„äººé–“è©è©±',

        // --- å”è©©å®‹è©èˆ‡è©©äºº ---
        'æç™½çš„é†‰é…’è©©', 'æç™½çš„ã€Šéœå¤œæ€ã€‹', 'æç™½èˆ‡æœç”«çš„å‹èª¼', 'æç™½ã€Œéµæµç£¨æˆé‡ã€çš„å‚³èªª', 'æç™½æ’ˆæœˆè€Œæ­»çš„æ•…äº‹',
        'æœç”«çš„ã€Šæ˜¥æœ›ã€‹', 'æœç”«çš„æˆéƒ½èŒ…å±‹', 'æœç”«çš„æµäº¡ç”Ÿæ´»', 'æœç”«èˆ‡æé¾œå¹´', 'ç‹ç¶­çš„éš±å±…ç”Ÿæ´»',
        'ç‹ç¶­è©©ä¸­æœ‰ç•«ç•«ä¸­æœ‰è©©', 'ç™½å±…æ˜“çš„ã€Šé•·æ¨æ­Œã€‹', 'ç™½å±…æ˜“çš„ã€Šçµç¶è¡Œã€‹', 'ç™½å±…æ˜“èˆ‡å…ƒç¨¹çš„äº¤æƒ…', 'éŸ“æ„ˆçš„ã€Šå¸«èªªã€‹',
        'éŸ“æ„ˆè««è¿ä½›éª¨è¢«è²¶', 'æŸ³å®—å…ƒçš„ã€Šæ°¸å·å…«è¨˜ã€‹', 'æŸ³å®—å…ƒçš„ã€Šæ±Ÿé›ªã€‹', 'åŠ‰ç¦¹éŒ«çš„ã€Šé™‹å®¤éŠ˜ã€‹', 'æå•†éš±çš„ç„¡é¡Œè©©',
        'æœç‰§çš„ã€Šæ¸…æ˜ã€‹', 'æœç‰§çš„æšå·å¤¢', 'è˜‡è»¾çš„ã€Šèµ¤å£è³¦ã€‹', 'è˜‡è»¾çš„ã€Šå®šé¢¨æ³¢ã€‹', 'è˜‡è»¾èˆ‡æ±å¡è‚‰',
        'è˜‡è»¾èˆ‡ä½›å°çš„è¶£äº‹', 'è˜‡è»¾çš„è²¶è¬«ç”Ÿæ¶¯', 'æ­é™½ä¿®çš„ã€Šé†‰ç¿äº­è¨˜ã€‹', 'èŒƒä»²æ·¹çš„ã€Šå²³é™½æ¨“è¨˜ã€‹', 'ç‹å®‰çŸ³çš„è®Šæ³•èˆ‡è©©æ–‡',
        'æ›¾éçš„æ•£æ–‡', 'æŸ³æ°¸çš„å©‰ç´„è©', 'æŸ³æ°¸èˆ‡æ­Œå¦“', 'ææ¸…ç…§çš„ã€Šè²è²æ…¢ã€‹', 'ææ¸…ç…§èˆ‡è¶™æ˜èª ',
        'ææ¸…ç…§æ™šå¹´å†å«çš„é¢¨æ³¢', 'è¾›æ£„ç–¾çš„è±ªæ”¾è©', 'è¾›æ£„ç–¾çš„è»æ—…ç”Ÿæ¶¯', 'é™¸æ¸¸çš„ã€Šç¤ºå…’ã€‹', 'é™¸æ¸¸èˆ‡å”å©‰çš„ã€Šé‡µé ­é³³ã€‹',
        'å§œå¤”çš„ã€Šæšå·æ…¢ã€‹', 'å­Ÿæµ©ç„¶çš„ç”°åœ’è©©', 'ç‹æ˜Œé½¡çš„é‚Šå¡è©©', 'é«˜é©çš„è»æ—…è©©', 'è³€çŸ¥ç« çš„å›é„‰å¶æ›¸',

        // --- å¤å…¸åè‘—èˆ‡å°èªª ---
        'æ–½è€åºµçš„ã€Šæ°´æ»¸å‚³ã€‹', 'æ­¦æ¾æ‰“è™çš„ç´°ç¯€', 'é­¯æ™ºæ·±å€’æ‹”å‚æ¥ŠæŸ³', 'ç¾…è²«ä¸­çš„ã€Šä¸‰åœ‹æ¼”ç¾©ã€‹', 'è«¸è‘›äº®ç©ºåŸè¨ˆ',
        'é—œç¾½æº«é…’æ–¬è¯é›„', 'æ›¹æ“ç…®é…’è«–è‹±é›„', 'å³æ‰¿æ©çš„ã€Šè¥¿éŠè¨˜ã€‹', 'å­«æ‚Ÿç©ºå¤§é¬§å¤©å®®', 'è±¬å…«æˆ’çš„èº«ä¸–',
        'æ›¹é›ªèŠ¹çš„ã€Šç´…æ¨“å¤¢ã€‹', 'è³ˆå¯¶ç‰èˆ‡æ—é»›ç‰', 'ç´…æ¨“å¤¢çš„çµå±€ä¹‹è¬', 'ç‹ç†™é³³çš„æ½‘è¾£æ€§æ ¼', 'åŠ‰å§¥å§¥é€²å¤§è§€åœ’',
        'è’²æ¾é½¡çš„ã€ŠèŠé½‹èªŒç•°ã€‹', 'è’²æ¾é½¡çš„è·¯é‚ŠèŒ¶æ”¤', 'å³æ•¬æ¢“çš„ã€Šå„’æ—å¤–å²ã€‹', 'èŒƒé€²ä¸­èˆ‰çš„è«·åˆº', 'åŠ‰é¶šçš„ã€Šè€æ®˜éŠè¨˜ã€‹',
        'æå¯¶å˜‰çš„ã€Šå®˜å ´ç¾å½¢è¨˜ã€‹', 'è¢æšçš„ã€Šéš¨åœ’é£Ÿå–®ã€‹', 'ç´è˜­æ€§å¾·çš„è©', 'é¾”è‡ªççš„å·±äº¥é›œè©©', 'é—œæ¼¢å¿çš„ã€Šç«‡å¨¥å†¤ã€‹',
        'ç‹å¯¦ç”«çš„ã€Šè¥¿å»‚è¨˜ã€‹', 'æ¹¯é¡¯ç¥–çš„ã€Šç‰¡ä¸¹äº­ã€‹', 'å­”å°šä»»çš„ã€Šæ¡ƒèŠ±æ‰‡ã€‹', 'æ´ªæ˜‡çš„ã€Šé•·ç”Ÿæ®¿ã€‹', 'ä¸‰è¨€äºŒæ‹çš„æ•…äº‹',

        // --- å…ˆç§¦æ¼¢é­å…­æœ ---
        'é™¶æ·µæ˜çš„ã€Šæ¡ƒèŠ±æºè¨˜ã€‹', 'é™¶æ·µæ˜ä¸ç‚ºäº”æ–—ç±³æŠ˜è…°', 'å±ˆåŸçš„ã€Šé›¢é¨·ã€‹', 'å±ˆåŸæŠ•æ±Ÿçš„å‚³èªª', 'æ›¹æ“çš„ã€ŠçŸ­æ­Œè¡Œã€‹',
        'æ›¹æ¤çš„ã€Šä¸ƒæ­¥è©©ã€‹', 'ç«¹æ—ä¸ƒè³¢çš„æ•…äº‹', 'åµ‡åº·çš„ã€Šå»£é™µæ•£ã€‹', 'ç‹ç¾²ä¹‹çš„ã€Šè˜­äº­é›†åºã€‹', 'è¬éˆé‹çš„å±±æ°´è©©',
        'å¸é¦¬é·çš„ã€Šå²è¨˜ã€‹', 'å¸é¦¬é·å—å®®åˆ‘å¿è¾±è² é‡', 'é …ç¾½çš„ã€Šå“ä¸‹æ­Œã€‹', 'è«¸è‘›äº®çš„ã€Šå‡ºå¸«è¡¨ã€‹', 'æå¯†çš„ã€Šé™³æƒ…è¡¨ã€‹',
        'ç‹å‹ƒçš„ã€Šæ»•ç‹é–£åºã€‹', 'é™³å­æ˜‚çš„ã€Šç™»å¹½å·è‡ºæ­Œã€‹', 'æœ¨è˜­è¾­çš„æ•…äº‹', 'å­”é›€æ±å—é£›', 'å¤è©©åä¹é¦–',
        'èŠå­çš„é€é™éŠ', 'èŠå‘¨å¤¢è¶', 'æƒ å­èˆ‡èŠå­çš„è¾¯è«–', 'å­Ÿæ¯ä¸‰é·çš„æ•…äº‹', 'è˜‡ç§¦æ‡¸æ¢åˆºè‚¡'
    ];

    const randomCategory = categories[Math.floor(Math.random() * categories.length)];
    const randomSeed = Math.floor(Math.random() * 999999);

    const prompt = `
    (RandomSeed: ${randomSeed})
    ä½ æ˜¯æˆ‘çš„è²“å’ªåŠ©æ‰‹ã€‚è«‹å‘Šè¨´æˆ‘ä¸€å€‹é—œæ–¼ã€${randomCategory}ã€‘çš„æ–‡å­¸å†·çŸ¥è­˜ã€è¶£äº‹æˆ–ä½œå“æ·±æ„ã€‚
    è¦æ±‚ï¼š
    1. å…§å®¹è¦æœ‰è¶£ã€ç¨ç‰¹ï¼Œæˆ–è€…æ˜¯æ•™ç§‘æ›¸æ²’æ•™çš„ç´°ç¯€ã€‚
    2. å­—æ•¸åš´æ ¼é™åˆ¶åœ¨ 60 å­—ä»¥å…§ã€‚
    3. èªæ°£å¯æ„›ã€è«‹å‹™å¿…ä½¿ç”¨ç²µèªå›ç­”ï¼Œä¾‹å¦‚ä½¿ç”¨ã€Œä¿‚ã€ã€ã€Œå˜…ã€ã€ã€Œå’ã€ã€ã€Œã—ã€ã€‚
    4. ä¸è¦ç”¨åˆ—é»ï¼Œä¸è¦åƒæ•™ç§‘æ›¸ï¼Œç›´æ¥åƒæœ‹å‹èŠå¤©ä¸€æ¨£èªªå‡ºä¾†ï¼Œä¸å¯èªªé«’è©±ï¼Œèªæ°£è¦è‡ªç„¶ã€‚
    5. çµ•å°ä¸è¦è¬›ã€Œä½ å¥½ã€ã€ã€Œä½ çŸ¥é“å—ã€é€™é¡å»¢è©±ï¼Œç›´æ¥è¬›é‡é»çŸ¥è­˜ã€‚
    `;

    try {
        // â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šæ”¹ç‚ºå‘¼å« callCatAPIï¼Œé–å®š gemini-fast â˜…â˜…â˜…
        const text = await callCatAPI(prompt, 0.99); 
        showBubble(text, 0); 
    } catch (e) {
        console.error("API Error", e);
        showBubble("å–µå—š... è…¦è¢‹æ‰“çµäº†... å†è©¦ä¸€æ¬¡ï¼Ÿ", 0);
    }
}

// é¡¯ç¤ºæ°£æ³¡ (autoHideMs = 0 ä»£è¡¨å¸¸é§)
function showBubble(htmlContent, autoHideMs = 0) {
    if (!speechBubble) return;
    
    speechBubble.innerHTML = htmlContent;
    speechBubble.style.display = 'block';
    void speechBubble.offsetWidth; 
    speechBubble.classList.add('show');
    
    updateBubblePosition();
}

function hideBubble() {
    if (!speechBubble) return;
    speechBubble.classList.remove('show');
    setTimeout(() => {
        speechBubble.style.display = 'none';
    }, 300);
}

function updateBubblePosition() {
    if (!modelContainer || !speechBubble || speechBubble.style.display === 'none') return;

    const bounds = modelContainer.getBounds();
    const bubbleRect = speechBubble.getBoundingClientRect();
    const screenW = window.innerWidth;
    const padding = 10;

    let left = bounds.x + (bounds.width / 2) - (bubbleRect.width / 2);
    let top = bounds.y - bubbleRect.height - 15;

    if (top < padding) {
        top = bounds.y + bounds.height + 15;
    }
    if (left < padding) left = padding;
    if (left + bubbleRect.width > screenW - padding) {
        left = screenW - bubbleRect.width - padding;
    }

    speechBubble.style.left = `${left}px`;
    speechBubble.style.top = `${top}px`;
}

function triggerCatReaction() {
    if (!modelContainer) return;
    modelContainer.children.forEach(cat => { playRandomMotion(cat); });
    if (navigator.vibrate) navigator.vibrate([50, 50, 50]); 
}

function triggerVisualEffect() {
    const canvas = document.getElementById(CANVAS_ID);
    canvas.classList.remove('cat-active-click');
    void canvas.offsetWidth; 
    canvas.classList.add('cat-active-click');
    setTimeout(() => { canvas.classList.remove('cat-active-click'); }, 400);
}

function playRandomMotion(model) {
    if (!model || !model.internalModel || !model.internalModel.motionManager) return;
    const motionMgr = model.internalModel.motionManager;
    
    const groups = Object.keys(motionMgr.definitions);
    if (groups.length === 0) return;

    let targetGroups = groups.filter(g => !g.toLowerCase().includes('idle') && !g.toLowerCase().includes('loop'));
    
    if (targetGroups.length === 0) targetGroups = groups;
    
    const randomGroup = targetGroups[Math.floor(Math.random() * targetGroups.length)];
    motionMgr.startRandomMotion(randomGroup, 3); 
}

function openCatMenu() {
    const sideMenu = document.getElementById('sideMenu');
    if(sideMenu) { sideMenu.classList.remove('active'); document.getElementById('sideMenuToggle').classList.remove('active'); }
    document.getElementById('catSelectionModal').style.display = 'flex';
}
function closeCatMenu(e) { if(e.target.id === 'catSelectionModal') e.target.style.display = 'none'; }
</script>


	
</head>
<body>


<div class="title-container">
<h1>
<span class="title-text">ç¥æ€</span>
</h1>
</div>



<!-- æ–‡èƒå®¹å™¨ (åŸï¼šç²¾é¸æ–‡ç« å®¹å™¨) -->
<div id="featuredContainer" class="box" style="display: none;">
    
    
    <!-- åˆ—è¡¨è¦–åœ– -->
    <div id="featuredListView">
        <!-- æœå°‹åˆ— -->
<div class="search-bar-wrapper" style="display: flex; align-items: center; gap: 12px; max-width: 450px;">
    <!-- æœå°‹æ¡† -->
    <input type="text" id="articleSearchInput" class="no-modal-editor" placeholder="æœå°‹æ¨™é¡Œæˆ–ä½œè€…..." oninput="searchArticles()" style="flex-grow: 1; border-radius: 50px; padding-left: 20px;">
    
    <!-- æ›¸ç±¤éæ¿¾æŒ‰éˆ• -->
    <button id="bookmarkFilterBtn" class="bookmark-list-btn" onclick="toggleBookmarkMode()" title="åªé¡¯ç¤ºæˆ‘çš„æ›¸ç±¤">
        <i class="fas fa-bookmark"></i>
    </button>
</div>
        <!-- æ–‡ç« åˆ—è¡¨ -->
        <div id="articleListContainer" class="article-list">
            <!-- JS å°‡è‡ªå‹•ç”Ÿæˆåˆ—è¡¨ -->
            <div style="text-align:center; color:#999; padding:20px;">è¼‰å…¥ä¸­...</div>
        </div>

       <!-- åˆ†é æ§åˆ¶ (ä¿®è¨‚ç‰ˆ) -->
<div class="pagination-controls" style="gap: 15px;"> <!-- ç¨å¾®ç¸®å°é–“è· -->
    <!-- [æ–°å¢] ä¸€éµå›é¦–é æŒ‰éˆ• (é›™ç®­é ­åœ–ç¤º) -->
    <button id="firstPageBtn" onclick="goToFirstPage()" title="å›åˆ°ç¬¬ 1 é " style="display: none; margin-right: -10px;">
        <i class="fas fa-angle-double-left"></i>
    </button>

    <button id="prevPageBtn" onclick="changeArticlePage(-1)" disabled>
        <i class="fas fa-chevron-left"></i>
    </button>
    
    <!-- [ä¿®æ”¹] é ç¢¼æŒ‡ç¤ºå™¨ï¼šåŠ å…¥ onclick äº‹ä»¶èˆ‡ title æç¤º -->
    <!-- æ¨£å¼è¨­å®š cursor: pointer æç¤ºå¯é»æ“Š -->
    <span id="pageIndicator" onclick="triggerPageJump()" title="é»æ“Šè¼¸å…¥é ç¢¼" 
          style="cursor: pointer; user-select: none; transition: opacity 0.2s;">
        1 / 1
    </span>
    
    <button id="nextPageBtn" onclick="changeArticlePage(1)" disabled>
        <i class="fas fa-chevron-right"></i>
    </button>
</div>
    </div>

    <!-- è©³æƒ…è¦–åœ– (é è¨­éš±è—) -->
    <div id="featuredDetailView" style="display: none;">
        <div class="article-actions">
            <button class="back-icon-btn" onclick="backToArticleList()" title="è¿”å›åˆ—è¡¨">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
        
        <div class="article-content-paper">
            <h3 id="detailTitle" class="article-title"></h3>
            <div id="detailDate" class="article-date"></div>
            <div class="article-separator"></div>
            <div id="detailBody" class="article-body"></div>
        </div>
    </div>
</div>




	
<div id="hitokoto-container" class="box">
<div id="hitokoto"></div>
<div id="hitokoto-footer">
<span id="hitokoto-from"></span>
<button id="refresh-btn"><i class="fas fa-sync-alt"></i></button>
</div>
</div>

	<!-- DSE å€’æ•¸æ—¥æ›†å®¹å™¨ -->
<div class="box" id="dse-countdown-box">
    <!-- æ¨™é¡Œéƒ¨åˆ† (ç§»é™¤ä¸‹æ‹‰é¸å–®ï¼Œå›æ­¸ç´”æ–‡å­—) -->
    <div class="dse-header">è·é›¢èˆ‡DSEä¸­æ–‡ç§‘åˆ†æ‰‹å°šé¤˜</div>

    <!-- ä¸»è¦é¡¯ç¤ºå€åŸŸï¼šå·¦é‚Šé¸å–® + å³é‚Šå€’æ•¸ -->
    <div class="dse-main-wrapper">
        
        <!-- å·¦å´ï¼šå¹´ç´šé¸æ“‡å™¨ (ç›´æ’) -->
        <div class="grade-sidebar">
            <div class="grade-label">å¹´ç´š</div>
            <button class="grade-btn" data-val="s6">6</button>
            <button class="grade-btn" data-val="s5">5</button>
            <button class="grade-btn" data-val="s4">4</button>
            <button class="grade-btn" data-val="s3">3</button>
            <button class="grade-btn" data-val="s2">2</button>
            <button class="grade-btn" data-val="s1">1</button>
        </div>

        <!-- å³å´ï¼šå€’æ•¸å¡ç‰‡å€ -->
        <div class="countdown-section">
            <div class="countdown-container">
                <!-- ã€Œç´„ã€å­—æ¨™ç±¤ -->
                <div id="approx-label" class="approx-label hidden">ç´„</div>

                <!-- åƒä½ -->
                <div class="flip-unit hidden" id="unit-0">
                    <div class="card-part top" id="t0-next">0</div>
                    <div class="card-part bottom" id="b0-old">0</div>
                    <div class="flap" id="f0" data-old="0" data-new="0"></div>
                </div>
                
                <!-- ç™¾ä½ -->
                <div class="flip-unit" id="unit-1">
                    <div class="card-part top" id="t1-next">0</div>
                    <div class="card-part bottom" id="b1-old">0</div>
                    <div class="flap" id="f1" data-old="0" data-new="0"></div>
                </div>
                <!-- åä½ -->
                <div class="flip-unit" id="unit-2">
                    <div class="card-part top" id="t2-next">0</div>
                    <div class="card-part bottom" id="b2-old">0</div>
                    <div class="flap" id="f2" data-old="0" data-new="0"></div>
                </div>
                <!-- å€‹ä½ -->
                <div class="flip-unit" id="unit-3">
                    <div class="card-part top" id="t3-next">0</div>
                    <div class="card-part bottom" id="b3-old">0</div>
                    <div class="flap" id="f3" data-old="0" data-new="0"></div>
                </div>

 <!-- â˜…â˜…â˜… æ–°å¢é€™è¡Œï¼šæ—¥å­—æ¨™ç±¤ â˜…â˜…â˜… -->
    <div class="days-label">æ—¥</div>
				
            </div>
            
            <div class="dse-footer">DAYS TO BREAKUP</div>
        </div>
    </div>
    
    <audio id="flip-sound" src="åˆ‡æ›å¹´ç´š.mp3" preload="auto"></audio>
</div>



<style>
#hitokoto-container {
background: rgba(220, 220, 220, 0.96);
border-radius: 8px;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
padding: 16px;
margin: 15px 0;
text-align: center;
max-width: 800px;
position: relative;
}

@media (max-width: 600px) {
#hitokoto-container {
text-align: left;
}
}

#hitokoto {
font-size: 21px;
font-style: italic;
color: #333;
margin-bottom: 10px;
}

#hitokoto p {
margin: 5px 0;
}

#hitokoto-footer {
display: flex;
justify-content: space-between;
align-items: center;
margin-top: 10px;
}

#hitokoto-from {
font-size: 16px;
color: #666;
}

#refresh-btn {
background: none;
border: none;
cursor: pointer;
font-size: 20px;
color: #666;
transition: color 0.3s;
padding: 0;
margin: 0;
}

#refresh-btn:hover {
color: #000;
}


/* --- æ–°å¢ï¼šç¢ºèªåœ–ç¤ºæŒ‰éµæ¨£å¼ --- */

.btn-icon-confirm {
/* 1. å¤–è§€è¨­å®šï¼šåœ“å½¢ã€ç¶ è‰²èƒŒæ™¯ */
width: 44px;
height: 44px;
border-radius: 50%; /* è£½ä½œæˆå®Œç¾çš„åœ“å½¢ */
background-color: #28a745; /* æˆåŠŸã€ç¢ºèªçš„ç¶ è‰² */
border: none;

/* 2. åœ–ç¤ºç½®ä¸­èˆ‡æ¨£å¼ */
display: inline-flex;
align-items: center;
justify-content: center;
color: white; /* åœ–ç¤ºé¡è‰² */
font-size: 20px; /* åœ–ç¤ºå¤§å° */

/* 3. äº’å‹•æ•ˆæœèˆ‡é™°å½± */
cursor: pointer;
box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
transition: all 0.2s ease-in-out;
}

.btn-icon-confirm:hover {
/* 4. æ»‘é¼ æ‡¸åœæ™‚ï¼šæ”¾å¤§ã€æäº®ï¼Œé™°å½±åŠ æ·± */
transform: scale(1.1);
filter: brightness(110%);
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

.btn-icon-confirm:active {
/* 5. é»æ“Šç¬é–“ï¼šå†æ”¾å¤§ä¸€é»ï¼Œæä¾›å›é¥‹æ„Ÿ */
transform: scale(1.15);
}

/* === DSE å€’æ•¸æ—¥æ›†å°ˆç”¨æ¨£å¼ (éŸ¿æ‡‰å¼å„ªåŒ– - åº•éƒ¨é¸å–®ç‰ˆ) === */
#dse-countdown-box {
    --dse-card-bg: #ffffff;
    --dse-text-color: #000000;
    --dse-line-color: #e0e0e0; 
    --dse-flip-duration: 0.6s;
    --dse-theme-color: #90A1B9;
    
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    padding: 15px 20px;
}

.dse-header {
    font-size: 1.1rem;
    letter-spacing: 0.3rem;
    margin-bottom: 1.2rem;
    color: #888;
    font-weight: 300;
    text-align: center;
}

/* === ä¸»è¦å®¹å™¨ === */
.dse-main-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 25px;
    width: 100%;
}

/* === å¹´ç´šé¸å–® (Desktop: å·¦å´ç›´æ’) === */
.grade-sidebar {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding-right: 20px;
    border-right: 1px dashed #ddd; /* é›»è…¦ç‰ˆï¼šå³å´åˆ†éš”ç·š */
    flex-shrink: 0;
}

.grade-label {
    font-size: 0.75rem;
    color: #aaa;
    margin-bottom: 2px;
    font-weight: bold;
}

.grade-btn {
    background: transparent;
    border: 1px solid transparent;
    color: #ccc;
    font-family: 'Noto Serif TC', serif;
    font-size: 1rem;
    font-weight: bold;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
}

.grade-btn:hover {
    color: var(--dse-theme-color);
    background: rgba(26, 117, 149, 0.1);
}

.grade-btn.active {
    color: white;
    background-color: var(--dse-theme-color);
    box-shadow: 0 2px 5px rgba(26, 117, 149, 0.3);
    transform: scale(1.1);
}

/* === æ–°å¢ï¼šæ—¥å­—æ¨™ç±¤æ¨£å¼ === */
.days-label {
    font-size: 24px;
    color: var(--dse-theme-color); /* è·Ÿéš¨ä¸»é¡Œé¡è‰² */
    margin-bottom: 20px;           /* èˆ‡æ•¸å­—åº•éƒ¨å°é½Šçš„å¾®èª¿ */
    margin-left: 8px;              /* èˆ‡æ•¸å­—ä¿æŒä¸€é»è·é›¢ */
    font-weight: bold;
    opacity: 0.8;
}
	
/* === å³å´å€’æ•¸å€å¡Š === */
.countdown-section {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.countdown-container {
    display: flex;
    gap: 10px;
    perspective: 1200px;
    justify-content: center;
    align-items: flex-end;
}

.approx-label {
    font-size: 24px;
    color: var(--dse-theme-color);
    margin-bottom: 20px;
    margin-right: 5px;
    font-weight: bold;
    opacity: 0.8;
}
.approx-label.hidden { display: none; }

/* ç¿»é å–®å…ƒæ¨£å¼ */
.flip-unit {
    position: relative;
    width: 90px;
    height: 120px;
    font-size: 70px;
    font-family: 'Noto Serif TC', "Songti TC", serif;
    font-weight: bold;
    text-align: center;
    border-radius: 6px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.03);
    color: var(--dse-text-color);
    line-height: 120px;
    z-index: 1;
}

.flip-unit::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 6px;
    pointer-events: none;
    z-index: 10;
    background: linear-gradient(180deg, #46ECD5 0%, 
        #3BB8DB 40%, 
        #36BBA7 100%);
    mix-blend-mode: screen;
    box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.2);
}

.card-part {
    position: absolute;
    left: 0; width: 100%; height: 50%;
    overflow: hidden;
    background: var(--dse-card-bg);
    backface-visibility: hidden;
}

.top { top: 0; border-radius: 6px 6px 0 0; line-height: 120px; border-bottom: 0.5px solid var(--dse-line-color); }
.bottom { bottom: 0; border-radius: 0 0 6px 6px; line-height: 0px; border-top: none; }

.flap {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 50%;
    background: var(--dse-card-bg);
    border-radius: 6px 6px 0 0;
    transform-origin: bottom;
    z-index: 3;
    transition: transform var(--dse-flip-duration) cubic-bezier(0.4, 0, 0.2, 1);
    transform-style: preserve-3d;
    border-bottom: 0.5px solid var(--dse-line-color);
    color: var(--dse-text-color);
}
.flap::before { content: attr(data-old); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--dse-card-bg); border-radius: 6px 6px 0 0; backface-visibility: hidden; line-height: 120px; }
.flap::after { content: attr(data-new); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--dse-card-bg); border-radius: 0 0 6px 6px; transform: rotateX(-180deg); backface-visibility: hidden; line-height: 0; display: flex; justify-content: center; border-top: none; }
.card-part, .flap::before, .flap::after { text-shadow: 0 2px 3px rgba(0, 0, 0, 0.2); }
.flipping .flap { transform: rotateX(-180deg); }

.flip-unit.hidden { display: none; }

.dse-footer {
    margin-top: 1rem;
    letter-spacing: 0.2rem;
    font-size: 0.85rem;
    color: #c0c0c0;
    font-weight: 300;
}

/* === RWD éŸ¿æ‡‰å¼èª¿æ•´ (é—œéµä¿®è¨‚ï¼šæŒ‰éˆ•ç§»è‡³åº•éƒ¨) === */
@media (max-width: 600px) {
    .dse-main-wrapper {
        flex-direction: column; /* å‚ç›´æ’åˆ— */
        gap: 15px;
    }
    
    /* 1. å€’æ•¸å€å¡Š (åŒ…å«å¡ç‰‡å’Œ DAYS TO BREAKUP) */
    .countdown-section {
        order: 1; /* è¦–è¦ºä¸Šæ’ç¬¬ä¸€ */
        width: 100%;
        margin-bottom: 5px;
    }

    /* 2. å¹´ç´šé¸å–® */
    .grade-sidebar {
        order: 2; /* è¦–è¦ºä¸Šæ’ç¬¬äºŒ (åº•éƒ¨) */
        flex-direction: row; /* æ©«å‘æ’åˆ— */
        width: 100%;
        justify-content: center;
        padding-right: 0;
        
        border-right: none;
        border-top: 1px dashed #e0e0e0; /* åˆ†éš”ç·šæ”¹åœ¨ä¸Šæ–¹ */
        
        padding-top: 15px;
        flex-wrap: wrap;
    }
    
    .grade-label {
        margin-right: 10px;
        margin-bottom: 0;
        align-self: center; /* å‚ç›´ç½®ä¸­ */
    }

    .grade-btn {
        width: 24px;  /* æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•ç¸®å° */
        height: 24px;
        font-size: 0.8rem;
    }

    .countdown-container {
        transform: scale(0.8); 
        margin: -10px 0;
    }
    
    .flip-unit {
        width: 70px;
        height: 100px;
        font-size: 55px;
        line-height: 100px;
    }
    .top { line-height: 100px; }
    .flap::before { line-height: 100px; }
}


/* === ç²¾é¸æ–‡ç« å°ˆç”¨æ¨£å¼ === */

/* æœå°‹åˆ— */
.search-bar-wrapper {
    position: relative;
    margin-bottom: 25px;
    width: 100%;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

#articleSearchInput {
    width: 100%;
    padding: 12px 40px 12px 15px;
    border: 2px solid #e0ddd7;
    border-radius: 25px;
    background-color: #fdfcf8;
    color: #5e5e5e;
    font-family: 'Noto Serif TC', serif;
    font-size: 1rem;
    transition: all 0.3s ease;
}

#articleSearchInput:focus {
    border-color: #8fa398; /* è«è˜­è¿ªç¶  */
    box-shadow: 0 4px 10px rgba(143, 163, 152, 0.2);
    outline: none;
}

.search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #aaa;
}

/* æ–‡ç« åˆ—è¡¨é …ç›® */
.article-item {
    background-color: #fdfcf8;
    border-bottom: 1px dashed #d1cdc5; /* è™›ç·šåˆ†éš” */
    padding: 20px 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.article-item:hover {
    background-color: rgba(143, 163, 152, 0.1); /* æ‡¸åœæ™‚æ·¡æ·¡çš„ç¶  */
    padding-left: 25px; /* è¼•å¾®ç§»å‹•æ•ˆæœ */
}

/* 1. åˆ—è¡¨å¡ç‰‡ï¼šæ¢å¾©æ©«å‘æ’åˆ—ï¼Œè®“æ—¥æœŸèƒ½å¾…åœ¨å³é‚Š */
.article-item {
    display: flex !important;
    flex-direction: row !important;       /* æ©«å‘æ’åˆ—ï¼šå·¦é‚Šå…§å®¹ï¼Œå³é‚Šæ—¥æœŸ */
    align-items: center !important;       /* å‚ç›´ç½®ä¸­ */
    justify-content: space-between !important; /* å·¦å³æ’é–‹ */
    padding: 20px 25px !important;
}

/* 2. å·¦å´å…§å®¹ç¾¤çµ„ï¼šåŒ…å«æ¨™é¡Œå’Œä½œè€… (å‚ç›´æ’åˆ—) */
.article-left-group {
    display: flex;
    flex-direction: column; /* å‚ç›´å †ç–Š */
    align-items: flex-start; /* é å·¦å°é½Š */
    flex: 1;                 /* ä½”æ“šä¸­é–“å‰©é¤˜ç©ºé–“ */
    padding-right: 20px;     /* é¿å…æ–‡å­—ç¢°åˆ°æ—¥æœŸ */
    min-width: 0;            /* é—œéµï¼šé˜²æ­¢ Flex å­å…ƒç´ å…§å®¹éé•·æº¢å‡º */
}


/* åˆ—è¡¨æ¨™é¡Œæ¨£å¼å¾®èª¿ */
.article-item-title {
    width: 100%;
    line-height: 1.4;
    margin-bottom: 5px;
    display: block; /* ç¢ºä¿ä½”æ»¿ä¸€è¡Œ */
}

/* åˆ—è¡¨ä¸‹æ–¹è³‡è¨Šåˆ— (ä½œè€…èˆ‡æ—¥æœŸ) */
.article-meta-row {
    width: 100%;
    display: flex;
    justify-content: space-between; /* ä½œè€…é å·¦ï¼Œæ—¥æœŸé å³ */
    align-items: center;
}

/* ç¢ºä¿æ—¥æœŸå­—é«”ä¸è·‘ç‰ˆ */
.article-item-date {
    white-space: nowrap;
    margin-left: 10px;
}

	
.article-item-title {
    font-size: 1.1rem;
    color: #5d4037;
    font-weight: bold;
    font-family: 'Noto Serif TC', serif;
}

.article-item-date {
    font-size: 0.85rem;
    color: #999;
    font-family: 'Courier New', monospace;
    min-width: 90px;
    text-align: right;
}

/* åˆ†é æ§åˆ¶ */
.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 30px;
    gap: 20px;
}

.pagination-controls button {
    background: transparent;
    border: 1px solid #e0ddd7;
    color: #8fa398;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s;
}

.pagination-controls button:hover:not(:disabled) {
    background-color: #8fa398;
    color: white;
}

.pagination-controls button:disabled {
    color: #eee;
    border-color: #eee;
    cursor: default;
}

#pageIndicator {
    color: #888;
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

/* æ–‡ç« è©³æƒ…é  (ç´™å¼µé¢¨æ ¼) */
.article-actions {
    margin-bottom: 20px;
}

.back-icon-btn {
    background: transparent;
    border: 2px solid #d69a92; /* è«è˜­è¿ªç´… */
    color: #d69a92;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: all 0.3s ease;
}

.back-icon-btn:hover {
    background-color: #d69a92;
    color: white;
    transform: translateX(-5px);
}

.article-content-paper {
    background-color: #fdfcf8;
    border: 1px solid #e0ddd7;
    border-radius: 8px;
    padding: 40px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    /* æ¨¡ä»¿ä¿¡ç´™èƒŒæ™¯ */
    background-image: linear-gradient(to bottom, transparent 29px, #f0f0f0 30px);
    background-size: 100% 30px;
    line-height: 30px; /* é…åˆæ ¼ç·š */
}

.article-title {
    font-size: 1.8rem;
    color: #2A9689; /* ä¸»é¡Œç¶  */
    text-align: center;
    margin-bottom: 10px;
    line-height: 1.4;
}

.article-date {
    text-align: center;
    color: #aaa;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    margin-bottom: 20px;
}

.article-separator {
    height: 1px;
    background: transparent;
    border-top: 2px dashed #d69a92;
    margin: 0 auto 30px auto;
    width: 50px;
}

.article-body {
    font-size: 1.15rem;
    color: #4a4a4a;
    text-align: justify;
    white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
}

/* è®“æ®µè½ä¹‹é–“æœ‰è¡Œè· */
.article-body p {
    margin-bottom: 2em; /* æ®µè½é–“è· */
}

@media (max-width: 600px) {
    .article-content-paper {
        padding: 20px;
        line-height: 1.8; /* æ‰‹æ©Ÿç‰ˆå–æ¶ˆæ ¼ç·šå°é½Šï¼Œä»¥æ˜“è®€ç‚ºä¸» */
        background-image: none;
    }
    .article-title {
        font-size: 1.4rem;
    }
}








	
</style>

<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>


<script>


// ==========================================
// === è¦†å¯«åŸç”Ÿ alert ç‚ºè«è˜­è¿ª UI ===
// ==========================================
(function() {
    // ä¿å­˜åŸå§‹ alert ä»¥é˜²è¬ä¸€éœ€è¦ä½¿ç”¨ (é›–ç„¶é€™è£¡æˆ‘å€‘é¸æ“‡å®Œå…¨è¦†è“‹)
    const originalAlert = window.alert;

    window.alert = function(message) {
        // 1. ç§»é™¤é é¢ä¸Šå¯èƒ½å·²å­˜åœ¨çš„ Alert (é˜²æ­¢å †ç–Š)
        const existingAlert = document.getElementById('sansi-custom-alert');
        if (existingAlert) existingAlert.remove();

        // 2. å»ºç«‹ DOM çµæ§‹
        const overlay = document.createElement('div');
        overlay.id = 'sansi-custom-alert';
        overlay.className = 'sansi-alert-overlay';

        // åˆ¤æ–·æ˜¯å¦ç‚ºéŒ¯èª¤è¨Šæ¯ (ç°¡å–®åˆ¤æ–·é—œéµå­—)
        const isError = String(message).includes('å¤±æ•—') || String(message).includes('éŒ¯èª¤') || String(message).includes('è«‹å…ˆ');
        const iconClass = isError ? 'fa-exclamation-circle' : 'fa-info-circle';
        const iconColor = isError ? '#d69a92' : '#8fa398'; // éŒ¯èª¤ç”¨è±†æ²™ç´…ï¼Œæ™®é€šç”¨ç°ç¶ 

        overlay.innerHTML = `
            <div class="sansi-alert-box">
                <div class="sansi-alert-icon">
                    <i class="fas ${iconClass}" style="color: ${iconColor};"></i>
                </div>
                <div class="sansi-alert-message">${String(message)}</div>
                <button class="sansi-alert-btn" onclick="closeSansiAlert()">
                    æ˜ç™½
                </button>
            </div>
        `;

        // 3. åŠ å…¥é é¢
        document.body.appendChild(overlay);

        // 4. è§¸ç™¼é€²å ´å‹•ç•« (éœ€è¦ä¸€é»å»¶é²è®“ DOM æ¸²æŸ“)
        requestAnimationFrame(() => {
            overlay.classList.add('sansi-alert-show');
        });

        // 5. ç¶å®šéµç›¤äº‹ä»¶ (æŒ‰ Enter é—œé–‰)
        const handleEnter = (e) => {
            if (e.key === 'Enter' || e.key === 'Escape') {
                closeSansiAlert();
                document.removeEventListener('keydown', handleEnter);
            }
        };
        document.addEventListener('keydown', handleEnter);
    };

    // å…¨åŸŸé—œé–‰å‡½å¼
    window.closeSansiAlert = function() {
        const overlay = document.getElementById('sansi-custom-alert');
        if (overlay) {
            // é€€å ´å‹•ç•«
            overlay.classList.remove('sansi-alert-show');
            setTimeout(() => {
                if (overlay) overlay.remove();
            }, 300); // ç­‰å¾… CSS transition çµæŸ
        }
    };
})();

	

let globalAbortController = null;

// === æ–°å¢ï¼šæ¬Šé™èˆ‡é¡åº¦æ§åˆ¶ ===

// Base64 ç·¨ç¢¼çš„é›»éƒµ
// kenchan20131@gmail.com (æ‰®å­¸ç”Ÿ)
const STUDENT_ADDITION_B64 = "a2VuY2hhbjIwMTMxQGdtYWlsLmNvbQ=="; 
// kenchan20151@gmail.com (ç‰¹è¨±ç”¨å®¶)
const SPECIAL_USER_B64 = "a2VuY2hhbjIwMTUxQGdtYWlsLmNvbQ==";

/**
 * æª¢æŸ¥è¨ªå®¢æ¯æ—¥ä½¿ç”¨é¡åº¦
 * @returns {boolean} true=å…è¨±ç¹¼çºŒ, false=é˜»æ­¢
 */
function checkGuestUsage() {
    // 1. æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ (å­¸ç”Ÿã€è€å¸«ã€ç‰¹è¨±ç”¨å®¶)
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    if (s) {
        console.log(`[æ¬Šé™æª¢æŸ¥] ç”¨æˆ¶å·²ç™»å…¥ (${s.name})ï¼Œä¸è¨­é™åˆ¶ã€‚`);
        return true; 
    }

    // 2. æœªç™»å…¥è¨ªå®¢ï¼šæª¢æŸ¥ LocalStorage è¨ˆæ•¸
    const today = new Date().toLocaleDateString('zh-HK'); // æ ¼å¼å¦‚ 2025/1/15
    const storageKey = `sansi_guest_usage_${today}`;
    
    // å–å¾—ç›®å‰æ¬¡æ•¸ (é è¨­ç‚º 0)
    let currentCount = parseInt(localStorage.getItem(storageKey) || "0");
    
    console.log(`[æ¬Šé™æª¢æŸ¥] è¨ªå®¢ç‹€æ…‹ | æ—¥æœŸ: ${today} | å·²ç”¨æ¬¡æ•¸: ${currentCount} | ä¸Šé™: 1`);

    if (currentCount >= 1) {
        alert("âš ï¸ è¨ªå®¢æ¯æ—¥é«”é©—é¡åº¦å·²ç”¨å®Œã€‚\n\nè«‹ç™»å…¥å­¸æ ¡å¸³è™Ÿæˆ–è¨»å†Šä»¥ç„¡é™ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ã€‚");
        console.warn("[æ¬Šé™æª¢æŸ¥] æ””æˆªï¼šè¶…éæ¯æ—¥é¡åº¦ã€‚");
        return false;
    }

    // 3. å¢åŠ è¨ˆæ•¸ (åœ¨ API å‘¼å«æˆåŠŸå‰å…ˆæ‰£é™¤ï¼Œé˜²æ­¢ä½µç™¼)
    localStorage.setItem(storageKey, currentCount + 1);
    return true;
}




	
	// === [æ–°å¢] ä¸­æ–·ç”Ÿæˆæ§åˆ¶é‚è¼¯ ===
 
// æ‰“é–‹ç¢ºèªè¦–çª—
function openCancelModal() {
    const modal = document.getElementById('cancelConfirmModal');
    if (modal) modal.style.display = 'flex';
}
 
// é—œé–‰ç¢ºèªè¦–çª— (ç¹¼çºŒç­‰å¾…)
function closeCancelModal() {
    const modal = document.getElementById('cancelConfirmModal');
    if (modal) modal.style.display = 'none';
}
 
// ç¢ºèªå–æ¶ˆ (åŸ·è¡Œä¸­æ–·)
function confirmCancel() {
    closeCancelModal(); // é—œé–‰ç¢ºèªçª—
    
    // 1. ä¸­æ–· API é€£ç·š
    if (globalAbortController) {
        globalAbortController.abort(); // ç™¼é€ä¸­æ–·è¨Šè™Ÿ
        globalAbortController = null;
        console.log("ä½¿ç”¨è€…æ‰‹å‹•å–æ¶ˆç”Ÿæˆ");
    }
 
    // 2. éš±è—åŠ è¼‰ç•«é¢
    hideLoading();
 
    // 3. é‡æ–°å•Ÿç”¨æ‰€æœ‰è¢«é–å®šçš„æäº¤æŒ‰éˆ•
    enableSubmitButtons();
}
 
// è¼”åŠ©ï¼šé‡æ–°å•Ÿç”¨æŒ‰éˆ•
function enableSubmitButtons() {
    const ids = [
        'submitWritingBtn', 'submitReadingBtn', 'submitExpandBtn', 'submitExpandGuideBtn',
        'submitArgumentOutlineBtn', 'submitArgumentWritingBtn', 'submitArgumentGuideBtn',
        'submitWritingGuideBtn', 'startDiscussionBtn', 'continueBtn',
        'continueWritingBtn', 'continueWritingGuideBtn', 'continueArgumentBtn',
        'canvasChatSendBtn'
    ];
    ids.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = false;
    });
}
	


// === åˆ†é æ§åˆ¶è®Šæ•¸ ===
let allAssignmentTasks = []; // æš«å­˜è©²ç­ç´šæ‰€æœ‰åŠŸèª²çš„ Metadata (ä¸å«å…§å®¹ï¼Œå¾ˆå°)
let currentLoadedCount = 0;  // ç›®å‰å·²é¡¯ç¤ºçš„æ•¸é‡
const BATCH_SIZE = 5;        // æ¯æ¬¡è¼‰å…¥å¹¾ä»½ (é è¨­ 5)

	

	// === ç¥æ€é€šçŸ¥ç³»çµ±é‚è¼¯ ===

// === ç¥æ€é€šçŸ¥ç³»çµ±é‚è¼¯ (é«˜æ•ˆèƒ½ä¿®æ­£ç‰ˆ) ===

// è®€å–å·²è®€ç´€éŒ„
let notifiedIds = JSON.parse(localStorage.getItem('sansi_read_notifications') || '[]');

// ç”¨ä¾†ç®¡ç†ç›£è½å™¨ï¼Œé¿å…é‡è¤‡ç¶å®š
let activeListeners = {
    assignments: null,
    submissions: {} // å„²å­˜å€‹åˆ¥ä½œæ¥­çš„æäº¤ç‹€æ…‹ç›£è½å™¨
};
let isNotificationInitialized = false; // é˜²æ­¢é‡è¤‡åŸ·è¡Œ

function initNotificationListeners() {
    // 1. é˜²æ­¢é‡è¤‡å•Ÿå‹•
    if (isNotificationInitialized) return;
    
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    if (!s) return; // æœªç™»å…¥å‰‡ä¸åŸ·è¡Œ

    // å»ºç«‹é€šçŸ¥å®¹å™¨ (å¦‚æœä¸å­˜åœ¨)
    if (!document.getElementById('notifContainer')) {
        const div = document.createElement('div');
        div.id = 'notifContainer';
        div.className = 'sansi-notification-container';
        document.body.appendChild(div);
    }

    isNotificationInitialized = true;
    console.log("é€šçŸ¥ç›£è½ç³»çµ±å·²å•Ÿå‹• (é«˜æ•ˆèƒ½æ¨¡å¼)");

    // --- 1. ç›£è½ç­ç´šèª²æ¥­åˆ—è¡¨ (ä¸»ç›£è½å™¨) ---
    const assignmentPath = `assignments/${s.grade}/${s.class}`;
    
    // å¦‚æœä¹‹å‰æœ‰ç›£è½ï¼Œå…ˆç§»é™¤
    if (activeListeners.assignments) {
        database.ref(assignmentPath).off();
    }

    activeListeners.assignments = database.ref(assignmentPath);
    activeListeners.assignments.on('value', (snapshot) => {
        const assignmentsData = snapshot.val() || {};
        const assignmentKeys = Object.keys(assignmentsData);

        // A. è™•ç†æ–°èª²æ¥­é€šçŸ¥
        assignmentKeys.forEach(key => {
            // å¦‚æœä¸åœ¨å·²è®€åˆ—è¡¨ä¸­ï¼Œç™¼é€é€šçŸ¥
            if (!notifiedIds.includes(key)) {
                showSansiNotif('new', assignmentsData[key].topic, key);
            }

            // B. [é—œéµå„ªåŒ–] ç‚ºæ¯ä¸€ä»½å­˜åœ¨çš„ä½œæ¥­ï¼Œç²¾æº–ç›£è½ã€Œè©²å­¸ç”Ÿçš„æäº¤ç‹€æ…‹ã€
            // é€™æ¨£å°±ä¸ç”¨ä¸‹è¼‰å…¨æ ¡çš„è³‡æ–™åº«ï¼Œå¤§å¹…æå‡é€Ÿåº¦
            monitorSubmissionStatus(key, s.name, assignmentsData[key].topic);
        });

        // C. æ¸…ç†èˆŠç›£è½å™¨ (å¦‚æœä½œæ¥­è¢«è€å¸«åˆªé™¤äº†ï¼Œå°±ä¸å†ç›£è½è©²ä½œæ¥­çš„æäº¤ç‹€æ…‹)
        Object.keys(activeListeners.submissions).forEach(monitoredKey => {
            if (!assignmentKeys.includes(monitoredKey)) {
                // ä½œæ¥­å·²ä¸å­˜åœ¨ï¼Œç§»é™¤ç›£è½
                database.ref(`assignments_submissions/${monitoredKey}/${s.name}`).off();
                delete activeListeners.submissions[monitoredKey];
            }
        });

        // D. åŒæ­¥ç§»é™¤ç•«é¢ä¸Šå·²å¤±æ•ˆçš„é€šçŸ¥å¡ç‰‡ (ä¾‹å¦‚è€å¸«åˆªé™¤äº†ä½œæ¥­)
        const activeNotifs = document.querySelectorAll('.sansi-notification[data-type="new"]');
        activeNotifs.forEach(node => {
            const id = node.getAttribute('data-notif-id');
            if (!assignmentKeys.includes(id)) {
                node.classList.add('fade-out');
                setTimeout(() => { node.remove(); updateNotifBadge(); }, 500);
            }
        });

        updateNotifBadge();
    });
}

// è¼”åŠ©å‡½å¼ï¼šé‡å°å–®ä»½ä½œæ¥­ç›£è½ã€Œå·²ç™¼é‚„ã€ç‹€æ…‹
function monitorSubmissionStatus(assignmentId, studentName, topicTitle) {
    // å¦‚æœå·²ç¶“åœ¨ç›£è½é€™ä»½ä½œæ¥­ï¼Œå°±è·³é
    if (activeListeners.submissions[assignmentId]) return;

    const submissionPath = `assignments_submissions/${assignmentId}/${studentName}`;
    const subRef = database.ref(submissionPath);

    // å„²å­˜åƒç…§ä»¥ä¾¿ç¨å¾Œå¯ä»¥ç§»é™¤
    activeListeners.submissions[assignmentId] = subRef;

    subRef.on('value', (snapshot) => {
        const myWork = snapshot.val();
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ã€Œå·²ç™¼é‚„ã€æ¨™è¨˜
        if (myWork && myWork.teacherFeedback && myWork.teacherFeedback.status === 'returned') {
            // ç”¢ç”Ÿå”¯ä¸€çš„è©•èª ID (åˆ©ç”¨æ™‚é–“æˆ³)
            const feedbackId = "fb_" + assignmentId + "_" + myWork.teacherFeedback.timestamp;
            
            // å¦‚æœé€™å€‹è©•èªé‚„æ²’è¢«è®€éï¼Œé¡¯ç¤ºé€šçŸ¥
            if (!notifiedIds.includes(feedbackId)) {
                showSansiNotif('returned', myWork.title || topicTitle || "èª²æ¥­", feedbackId);
            }
        }
        
        // å¦‚æœç‹€æ…‹è®Šæˆä¸æ˜¯ returned (ä¾‹å¦‚è€å¸«æ’¤å›)ï¼Œå¯ä»¥åœ¨é€™è£¡è™•ç†é€šçŸ¥æ’¤å› (é¸ç”¨)
        // ç›®å‰ä¿ç•™ç°¡å–®é‚è¼¯å³å¯
    });
}

/**
 * é¡¯ç¤ºé€šçŸ¥å¡ç‰‡ (ç¶­æŒåŸæœ¬çš„ UI é‚è¼¯)
 */
function showSansiNotif(type, topic, uniqueId) {
    if (document.querySelector(`[data-notif-id="${uniqueId}"]`)) return; // é˜²é‡è¤‡

    const container = document.getElementById('notifContainer');
    if (!container) return;

    // === æ–°å¢ï¼šè«è˜­è¿ªè‰²ç³» ===
    const morandiPalette = ['#8fa398', '#94a7b5', '#b6a6ca', '#d69a92', '#c7b299'];
    // éš¨æ©Ÿé¸å–é¡è‰²
    const randomThemeColor = morandiPalette[Math.floor(Math.random() * morandiPalette.length)];

    const notif = document.createElement('div');
    notif.setAttribute('data-notif-id', uniqueId);
    notif.setAttribute('data-type', type); 
    
    // === æ–°å¢ï¼šè¨­å®šè‰²æ¢é¡è‰² ===
    notif.style.setProperty('--theme-color', randomThemeColor);
    
    const isNew = type === 'new';
    notif.className = `sansi-notification ${isNew ? 'notif-new' : 'notif-returned'}`;
    
    const badgeText = isNew ? 'æ–°èª²æ¥­ç™¼ä½ˆ' : 'æ‰¹æ”¹å·²ç™¼é‚„';
    const descText = isNew 
        ? 'è€å¸«ç‚ºä½ çš„ç­ç´šæŒ‡æ´¾äº†æ–°ä»»å‹™ï¼Œè«‹é©æ™‚é€²å…¥ç³»çµ±å®Œæˆç·´ç¿’ã€‚' 
        : 'ä½ æäº¤çš„èª²æ¥­å·²æœ‰æ–°çš„è€å¸«è©•èªåŠè©•åˆ†ï¼Œè«‹å³æ™‚æª¢é–±ã€‚';

    notif.innerHTML = `
        <div class="notif-badge">${badgeText}</div>
        <div class="notif-header">
            <div class="notif-topic">ã€Š${topic}ã€‹</div>
        </div>
        <div class="notif-desc">${descText}</div>
        <div class="notif-footer">
            <span>é»æ“Šå‰å¾€æŸ¥çœ‹è©³æƒ…</span>
            <i class="fas fa-chevron-right" style="font-size: 0.7rem;"></i>
        </div>
    `;

    notif.onclick = () => {
        // è¨˜éŒ„å·²è®€
        if (!notifiedIds.includes(uniqueId)) {
            notifiedIds.push(uniqueId);
            localStorage.setItem('sansi_read_notifications', JSON.stringify(notifiedIds));
        }
        // ç§»é™¤å¡ç‰‡
        notif.classList.add('fade-out');
        setTimeout(() => {
            notif.remove();
            updateNotifBadge();
        }, 500);
        // æ‰“é–‹é›²ç«¯ä¸­å¿ƒ
        openStudentLoginModal();
    };

    container.appendChild(notif);
    updateNotifBadge();
}

// æ›´æ–°å´é‚Šæ¬„ç´…é»
function updateNotifBadge() {
    const container = document.getElementById('notifContainer');
    const badge = document.getElementById('notifBadge');
    // å¦‚æœå…¨åŸŸæœ‰æœªäº¤åŠŸèª²è®Šæ•¸ (window.hasPendingWork)ï¼Œä¹Ÿè¦è€ƒæ…®é€²å»
    const hasVisibleNotifs = (container && container.querySelectorAll('.sansi-notification').length > 0);
    const hasPending = window.hasPendingWork || false;

    if (badge) {
        badge.style.display = (hasVisibleNotifs || hasPending) ? 'block' : 'none';
    }
}



	
	
// å•Ÿå‹•é»ï¼šé é¢è¼‰å…¥å¾ŒåŸ·è¡Œ
document.addEventListener('DOMContentLoaded', () => {
    // åªä¿ç•™é€™ä¸€å€‹å•Ÿå‹•é»ï¼Œç§»é™¤å…¶ä»–çš„ setTimeout
    setTimeout(initNotificationListeners, 1500);
});

// ä¿®æ”¹åŸæœ‰çš„ç™»å…¥æª¢æŸ¥ï¼Œç™»å…¥å¾Œç«‹å³å•Ÿå‹•ç›£è½
const originalCheckLoginForNotif = window.checkStudentLogin;
window.checkStudentLogin = async function() {
    await originalCheckLoginForNotif();
    // ç™»å…¥æˆåŠŸå¾Œï¼Œç«‹å³åˆå§‹åŒ–é€šçŸ¥ç›£è½ (å¦‚æœå°šæœªåˆå§‹åŒ–)
    initNotificationListeners();
};


// é¡¯ç¤ºæˆ–éš±è—å´é‚Šé¸å–®ç´…é»
function showRedBadge(show) {
    const cloudBtn = document.getElementById('sideMenuCloudBtn');
    if (!cloudBtn) return;

    let badge = cloudBtn.querySelector('.notification-badge');
    if (!badge) {
        badge = document.createElement('div');
        badge.className = 'notification-badge';
        cloudBtn.appendChild(badge);
    }
    badge.style.display = show ? 'block' : 'none';
}

// åœ¨é é¢è¼‰å…¥åŠç™»å…¥æˆåŠŸå¾Œå•Ÿå‹•
document.addEventListener('DOMContentLoaded', () => {
    // å»¶é²ä¸€é»é»å•Ÿå‹•ï¼Œé¿é–‹åˆæ¬¡è¼‰å…¥çš„æ•¸æ“šæ´ªæµ
    setTimeout(initNotificationListeners, 2000);
});

// ä¿®æ”¹ä½ åŸæœ‰çš„ checkStudentLoginï¼Œåœ¨åˆ‡æ›åˆ°é›²ç«¯é¢æ¿æ™‚æ¸…é™¤ç´…é»
const originalCheckLogin = window.checkStudentLogin;
window.checkStudentLogin = async function() {
    await originalCheckLogin();
    showRedBadge(false); // æ‰“é–‹é›²ç«¯ä¸­å¿ƒå°±è¦–ç‚ºå·²è®€
};

	// æ‰“é–‹çµæœç•«å¸ƒ
function openResultCanvas(title) {
    const canvas = document.getElementById('resultCanvas');
    const body = document.getElementById('resultCanvasBody');
    document.getElementById('resultCanvasTitle').innerText = title || "ç”Ÿæˆçµæœ";
    
    body.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
    canvas.style.display = 'block';
    document.body.style.overflow = 'hidden'; // é–å®šä¸»é é¢æ²å‹•
}

// é—œé–‰çµæœç•«å¸ƒ
function closeResultCanvas() {
    const canvas = document.getElementById('resultCanvas');
    canvas.style.display = 'none';
    document.body.style.overflow = 'auto'; // æ¢å¾©ä¸»é é¢æ²å‹•
    
    // å¦‚æœæœ‰é›·é”åœ–å¯¦ä¾‹ï¼Œé—œé–‰æ™‚éŠ·æ¯€ä»¥é˜²è¡çª (é¸ç”¨)
    // if (window.narrative_radarChartInstance) window.narrative_radarChartInstance.destroy();
}


	// === é¡¯ç¤ºåŠ è¼‰å‹•ç•« ===
// === é¡¯ç¤ºåŠ è¼‰å‹•ç•« (éš¨æ©Ÿ GIF ç‰ˆ) ===
function showLoading(text) {
    const overlay = document.getElementById('loadingOverlay');
    const textEl = document.getElementById('loadingText');
    const imgEl = document.getElementById('loadingImage'); // ç²å–åœ–ç‰‡å…ƒç´ 

    // â˜…â˜…â˜… åœ¨é€™è£¡è¨­å®šä½ çš„ GIF æ¸…å–® â˜…â˜…â˜…
    // è«‹ç¢ºä¿é€™äº›æª”æ¡ˆéƒ½å·²ç¶“ä¸Šå‚³åˆ°ä½ çš„ç¶²ç«™ç›®éŒ„ä¸­
    const gifList = [
        'ç”Ÿæˆä¸­.gif',
        'ç”Ÿæˆä¸­2.gif',
        'ç”Ÿæˆä¸­3.gif',
        'ç”Ÿæˆä¸­4.gif',
        'ç”Ÿæˆä¸­5.gif',
        'ç”Ÿæˆä¸­6.gif'
        // å¦‚æœæœ‰æ›´å¤šï¼Œå¯ä»¥ç¹¼çºŒåŠ ï¼š 'ç”Ÿæˆä¸­3.gif',
    ];

    if (overlay && textEl) {
        // 1. éš¨æ©ŸæŠ½å–ä¸€å¼µ GIF
        if (imgEl) {
            const randomIndex = Math.floor(Math.random() * gifList.length);
            const selectedGif = gifList[randomIndex];
            imgEl.src = selectedGif; //æ›´æ›åœ–ç‰‡ä¾†æº
        }

        // 2. è¨­å®šæ–‡å­—ä¸¦é¡¯ç¤º
        textEl.innerText = text || "æ­£åœ¨é‹ç®—ä¸­..."; 
        overlay.style.display = 'flex';
    }
}

// === éš±è—åŠ è¼‰å‹•ç•« ===
function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}


	// === å‹•ç•«è§¸ç™¼è¼”åŠ©å‡½æ•¸ ===
function playEntryAnimation(elementId) {
    const el = document.getElementById(elementId);
    if (el) {
        // 1. ç§»é™¤å‹•ç•« class (å¦‚æœæœ‰çš„è©±)
        el.classList.remove('fade-in-up');
        
        // 2. å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª (Reflow) - é€™æ˜¯é—œéµï¼Œå¦å‰‡ç€è¦½å™¨æœƒå¿½ç•¥é‡æ–°æ·»åŠ  class çš„å‹•ä½œ
        void el.offsetWidth;
        
        // 3. é‡æ–°åŠ å…¥å‹•ç•« class
        el.classList.add('fade-in-up');
    }
}

document.addEventListener('DOMContentLoaded', function() {
	   // â˜… åŠ å…¥é€™ä¸€è¡Œï¼šå•Ÿå‹•èƒŒæ™¯å¿«å–è¼‰å…¥
    loadAndCacheBackground();
const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
const hitokotoElement = document.getElementById('hitokoto');
const hitokotoFromElement = document.getElementById('hitokoto-from');
const refreshBtn = document.getElementById('refresh-btn');


function initDSECalendar() {
    // === 1. è¨­å®šæ—¥æœŸ ===
    const config = {
        s6: '2026-04-09', 
        s5: '2027-04-02',
        offsets: { s4: 1, s3: 2, s2: 3, s1: 4 }
    };

    // === 2. è‡ªå‹•å»ºç«‹/ç²å–ç…™èŠ±ç•«å¸ƒ ===
    let fireworksCanvas = document.getElementById('fireworksCanvas');
    if (!fireworksCanvas) {
        fireworksCanvas = document.createElement('canvas');
        fireworksCanvas.id = 'fireworksCanvas';
        fireworksCanvas.style.position = 'fixed';
        fireworksCanvas.style.top = '0';
        fireworksCanvas.style.left = '0';
        fireworksCanvas.style.width = '100%';
        fireworksCanvas.style.height = '100%';
        fireworksCanvas.style.pointerEvents = 'none'; 
        fireworksCanvas.style.zIndex = '2147483647';
        fireworksCanvas.style.display = 'none';
        document.body.appendChild(fireworksCanvas);
    }

    const gradeButtons = document.querySelectorAll('.grade-btn');
    const unit0 = document.getElementById('unit-0');
    const approxLabel = document.getElementById('approx-label');
    
    let currentGrade = localStorage.getItem('dse_grade') || 's6';

    // === 3. ç…™èŠ±ç‰¹æ•ˆé‚è¼¯ (ä¿æŒä¸è®Š) ===
    let fireworksInterval;
    let autoStopTimer; 
    let cleanupTimer;  
    let fireworksActive = false;
    const ctx = fireworksCanvas.getContext('2d');
    let particles = [];

    function resizeCanvas() {
        fireworksCanvas.width = window.innerWidth;
        fireworksCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function createParticle(x, y) {
        const particleCount = 35; 
        for (let i = 0; i < particleCount; i++) {
            particles.push({
                x: x,
                y: y,
                colors: ['#1A7595', '#D87C7C', '#E6D0A6', '#8FB2C9', '#A8D8B9'],
                color: '',
                radius: Math.random() * 2 + 0.8, 
                velocity: {
                    x: (Math.random() - 0.5) * 6,
                    y: (Math.random() - 0.5) * 6
                },
                alpha: 0.9,
                decay: Math.random() * 0.01 + 0.005
            });
            particles[particles.length - 1].color = particles[particles.length - 1].colors[Math.floor(Math.random() * 5)];
        }
    }

    function animateFireworks() {
        if (particles.length === 0 && !fireworksActive) return;
        requestAnimationFrame(animateFireworks);
        ctx.globalCompositeOperation = 'destination-out';
        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        ctx.fillRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
        ctx.globalCompositeOperation = 'lighter';
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.alpha;
            ctx.fill();
            p.x += p.velocity.x;
            p.y += p.velocity.y;
            p.velocity.y += 0.03;
            p.velocity.x *= 0.98;
            p.velocity.y *= 0.98;
            p.alpha -= p.decay;
            if (p.alpha <= 0) particles.splice(i, 1);
        }
    }

    function startFireworks() {
        if (fireworksActive) return;
        fireworksActive = true;
        fireworksCanvas.style.display = 'block';
        animateFireworks();
        createParticle(window.innerWidth / 2, window.innerHeight / 3);
        fireworksInterval = setInterval(() => {
            const x = Math.random() * (fireworksCanvas.width * 0.6) + (fireworksCanvas.width * 0.2);
            const y = Math.random() * (fireworksCanvas.height / 2); 
            createParticle(x, y);
        }, 700);
        clearTimeout(autoStopTimer);
        clearTimeout(cleanupTimer);
        autoStopTimer = setTimeout(() => stopLaunching(), 3000);
    }

    function stopLaunching() {
        clearInterval(fireworksInterval);
        fireworksActive = false;
        cleanupTimer = setTimeout(() => {
            fireworksCanvas.style.display = 'none';
            ctx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
            particles = [];
        }, 3000);
    }

    function forceStopFireworks() {
        clearInterval(fireworksInterval);
        clearTimeout(autoStopTimer);
        clearTimeout(cleanupTimer);
        fireworksActive = false;
        fireworksCanvas.style.display = 'none';
        ctx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
        particles = [];
    }

    // === 4. æŒ‰éˆ•ç›£è½ (ä¿®æ”¹è™•ï¼šå‚³å…¥è¼ƒçŸ­å»¶é²) ===
    gradeButtons.forEach(btn => {
        if (btn.dataset.val === currentGrade) btn.classList.add('active');

        btn.addEventListener('click', function() {
            gradeButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            currentGrade = this.dataset.val;
            localStorage.setItem('dse_grade', currentGrade);
            
            // â˜…â˜…â˜… é€™è£¡æ”¹æˆ 250ms (0.25ç§’)ï¼Œåˆ‡æ›æ™‚æ›´å¿«é€Ÿ â˜…â˜…â˜…
            updateCountdown(true, 250); 
        });
    });

    // === 5. å€’æ•¸æ›´æ–° (ä¿®æ”¹è™•ï¼šæ¥æ”¶ delay åƒæ•¸) ===
    function updateCountdown(animate = true, delay = 800) {
        // ä½¿ç”¨å‚³å…¥çš„ delay åƒæ•¸ï¼Œé è¨­ç‚º 800ms
        const flipDelay = delay; 

        let targetDate;
        const isApprox = ['s1', 's2', 's3', 's4'].includes(currentGrade);
        if (approxLabel) approxLabel.classList.toggle('hidden', !isApprox);
        
        if (currentGrade === 's6' || currentGrade === 's5') {
            targetDate = new Date(config[currentGrade]);
        } else {
            const baseDate = new Date(config.s5);
            const yearsToAdd = config.offsets[currentGrade];
            targetDate = new Date(baseDate.getTime() + (yearsToAdd * 365 * 24 * 60 * 60 * 1000));
        }
        
        const now = new Date();
        targetDate.setHours(0, 0, 0, 0);
        now.setHours(0, 0, 0, 0);
        const diff = targetDate.getTime() - now.getTime();
        let days = Math.ceil(diff / (1000 * 60 * 60 * 24));
        
        const daysLabel = document.querySelector('.countdown-container .days-label, .days-label');
        
        // è™•ç†è² æ•¸å¤©æ•¸
        if (days < 0) {
            forceStopFireworks();
            if (unit0) unit0.classList.remove('hidden');
            const fullStr = "å·²åˆ†æ‰‹";
            for (let i = 0; i < 3; i++) {
                const unit = document.getElementById(`unit-${i}`);
                if (unit) {
                    unit.classList.remove('flipping');
                    document.getElementById(`t${i}-next`).innerText = fullStr[i] || '';
                    document.getElementById(`b${i}-old`).innerText = fullStr[i] || '';
                    const flap = document.getElementById(`f${i}`);
                    flap.setAttribute('data-old', fullStr[i] || '');
                    flap.setAttribute('data-new', fullStr[i] || '');
                }
            }
            const unit3 = document.getElementById('unit-3');
            if (unit3) unit3.classList.add('hidden');
            if (approxLabel) approxLabel.classList.add('hidden');
            if (daysLabel) daysLabel.style.display = 'none';
            const footer = document.querySelector('.dse-footer');
            if (footer) footer.textContent = "WE ARE FREE";
            return;
        }

        // æ­£å¸¸é¡¯ç¤º
        if (daysLabel) daysLabel.style.display = '';
        if (unit0) unit0.classList.toggle('hidden', days < 1000);
        
        const fullStr = days.toString().padStart(4, '0');      // æ–°æ•¸å­—
        const prevDays = days + 1;                             // èˆŠæ•¸å­—
        const oldFullStr = prevDays.toString().padStart(4, '0'); 
        
        // ç…™èŠ±é‚è¼¯
        if (days <= 0) {
            days = 0;
            if (!fireworksActive) startFireworks();
        } else {
            forceStopFireworks();
        }
        
        // â˜…â˜…â˜… ç¬¬ä¸€éšæ®µï¼šç„¡å‹•ç•«ã€ç¬é–“é‡ç½®ç‚ºã€ŒèˆŠæ•¸å­—ã€ (é˜²é–ƒçˆé‚è¼¯) â˜…â˜…â˜…
        for (let i = 0; i <= 3; i++) {
            const unit = document.getElementById(`unit-${i}`);
            if (unit) {
                const oldVal = oldFullStr[i];
                const flap = document.getElementById(`f${i}`);

                // é—œé–‰éæ¸¡ï¼Œé˜²é–ƒçˆ
                flap.style.transition = 'none';
                unit.classList.remove('flipping');
                
                // è¨­ç‚ºèˆŠæ•¸å­—
                document.getElementById(`t${i}-next`).innerText = oldVal;
                document.getElementById(`b${i}-old`).innerText = oldVal;
                flap.setAttribute('data-old', oldVal);
                flap.setAttribute('data-new', oldVal);

                // å¼·åˆ¶é‡ç¹ª
                void unit.offsetWidth; 

                // æ¢å¾©éæ¸¡
                flap.style.transition = ''; 
            }
        }

        // â˜…â˜…â˜… ç¬¬äºŒéšæ®µï¼šæ ¹æ“š delay æ™‚é–“ç¿»é  â˜…â˜…â˜…
        if (animate) {
            setTimeout(() => {
                const sound = document.getElementById('flip-sound');
                if (sound) {
                    sound.currentTime = 0;
					sound.volume = 1.0; // <--- åŠ å…¥é€™è¡Œï¼Œå¼·åˆ¶è¨­å®šç‚ºæœ€å¤§è² (100%)
                    sound.play().catch(() => {});
                }

                for (let i = 0; i <= 3; i++) {
                    const unit = document.getElementById(`unit-${i}`);
                    if (unit) {
                        const newVal = fullStr[i];
                        const oldVal = oldFullStr[i];
                        
                        if (oldVal !== newVal) {
                            const flap = document.getElementById(`f${i}`);
                            document.getElementById(`t${i}-next`).innerText = newVal;
                            flap.setAttribute('data-new', newVal);
                            unit.classList.add('flipping');
                        }
                    }
                }
            }, flipDelay); // ä½¿ç”¨å‹•æ…‹å‚³å…¥çš„ delay
        } else {
             for (let i = 0; i <= 3; i++) {
                const unit = document.getElementById(`unit-${i}`);
                if (unit) {
                    const newVal = fullStr[i];
                    document.getElementById(`t${i}-next`).innerText = newVal;
                    document.getElementById(`b${i}-old`).innerText = newVal;
                    const flap = document.getElementById(`f${i}`);
                    flap.setAttribute('data-old', newVal);
                    flap.setAttribute('data-new', newVal);
                }
            }
        }
    }
    
    // é¦–æ¬¡åŸ·è¡Œ (ä¿æŒè¼ƒé•·å»¶é²ï¼Œé€™è£¡è¨­ç‚º 800ms)
    setTimeout(() => {
        updateCountdown(true, 800);
    }, 100); 
}

// ç¢ºä¿è…³æœ¬åŸ·è¡Œ
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initDSECalendar();
} else {
    document.addEventListener('DOMContentLoaded', initDSECalendar);
}

	
function fetchHitokoto() {
fetch('https://v1.hitokoto.cn/?c=d&c=i&c=k&encode=json')
.then(response => response.json())
.then(data => {
if (data.from.includes('é­”é“ç¥–å¸«')) {
fetchHitokoto(); // å¦‚æœä¾†æºæ˜¯ã€Œé­”é“ç¥–å¸«ã€ï¼Œé‡æ–°ç²å–åè¨€
} else {
// ä½¿ç”¨ textContent å¯ä»¥è‡ªå‹•è™•ç†ç‰¹æ®Šå­—å…ƒï¼Œæ˜¯é¡¯ç¤ºç´”æ–‡å­—çš„æœ€ä½³é¸æ“‡
hitokotoElement.textContent = converter(data.hitokoto);
hitokotoFromElement.textContent = `â€”â€” ${converter(data.from_who || 'ä½šå')} ã€Š${converter(data.from)}ã€‹`;
}
})
.catch(error => {
console.error('ç²å–åè¨€å¤±æ•—:', error);
hitokotoElement.innerHTML = '<p>ç²å–åè¨€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
hitokotoFromElement.innerHTML = '';
});
}

fetchHitokoto();
refreshBtn.addEventListener('click', fetchHitokoto);
});
</script>









<!-- å…§ç½®çš„ DSE è©•åˆ†åŸå‰‡ (éš±è—) -->
<div id="dse-grading-principles" style="display: none;">
<h3>ã€æ“¬å·ç†å¿µã€‘</h3>
<p>1. è€ƒæ ¸èƒ½åŠ›ï¼šè€ƒæ ¸è€ƒç”Ÿæ§‹æ€ã€è¡¨é”ã€å‰µä½œç­‰èƒ½åŠ›ã€‚</p>
<p>2. è¨­é¡Œæ–¹å¼ï¼šæˆ–å‘½é¡Œï¼Œæˆ–æŒ‡å®šæƒ…å¢ƒï¼Œä¸¦æä¾›é¸æ“‡ã€‚</p>
<p>3. è¨­é¡Œæ–¹å‘ï¼šä¸»è¦ç’°ç¹è€ƒç”Ÿç”Ÿæ´»ç¶“é©—åŠæ—¥å¸¸æ€è€ƒã€é—œæ³¨çš„æƒ…æˆ–äº‹ï¼›ä¸¦ç›¡é‡çµ¦äºˆå¯«ä½œç©ºé–“ï¼Œè®“è€ƒç”Ÿç™¼æ®å‰µæ„ã€‚</p>
<p>4. å¯«ä½œè¦æ±‚ï¼šè€ƒç”Ÿå®œé€éå¯©é¡Œï¼Œæ€è€ƒå¯«ä½œç«‹æ„ï¼Œé¸å–ææ–™ï¼Œæ›¸å¯«æ–‡ç« ã€‚</p>
<p>5. æ–‡é«”è¦æ±‚ï¼šä»¥æŸé¡æ–‡é«”ç‚ºä¸»ï¼Œæˆ–æ–‡é«”ä¸é™ã€‚</p>

<h3>ã€ä¸€èˆ¬è©•åˆ†åŸå‰‡ï¼šå¯©é¡Œã€å…¥å“ã€‘</h3>
<p>1. æº–ç¢ºç†è§£é—œéµæ¦‚å¿µã€‚</p>
<p>2. æ˜ç™½å¯«ä½œè¦æ±‚ã€‚</p>
<p>3. æŠŠæ¡ä¸åŒå“ä½çš„å…¥å“è¦æ±‚ã€‚</p>

<h3>ã€è©•åˆ†é …ç›®è©³è§£ã€‘</h3>
<p><strong>å…§å®¹ (40åˆ†):</strong></p>
<ul>
<li>ç«‹æ„ã€å…§å®¹æ˜¯å¦åˆä¹å¯«ä½œè¦æ±‚ï¼›æ˜¯å¦è±å¯Œã€æ·±åˆ»ã€‚</li>
<li>å–ææ˜¯å¦æ°ç•¶ï¼›èƒ½å¦å½°é¡¯ç«‹æ„ã€‚</li>
<li>é—¡è¿°æ˜¯å¦åˆç†ã€é£½æ»¿ã€‚</li>
</ul>
<p><strong>è¡¨é” (30åˆ†):</strong></p>
<ul>
<li>ç”¨è©æ˜¯å¦ç²¾ç¢ºã€è±å¯Œã€‚(ä¸»)</li>
<li>æ–‡å¥æ˜¯å¦æµæš¢ã€é€šé †ã€‚(ä¸»)</li>
<li>è¡¨é”æ‰‹æ³•æ˜¯å¦ç´”ç†Ÿéˆæ´»ã€‚(è¼”)</li>
</ul>
<p><strong>çµæ§‹ (20åˆ†):</strong></p>
<ul>
<li>æ®µè½å€åˆ†æ˜¯å¦æ˜æ™°ã€‚</li>
<li>èµ·æ‰¿è½‰åˆæ˜¯å¦è‡ªç„¶ã€‚</li>
<li>è¼•é‡è©³ç•¥æ˜¯å¦æ°ç•¶ã€‚</li>
</ul>
<p><strong>æ¨™é»å­—é«” (10åˆ†):</strong></p>
<ul>
<li>å­—é«”ç‚ºä¸»ï¼Œæ¨™é»ç‚ºè¼”ã€‚</li>
<li>æ¨™é»ä½¿ç”¨åœ¨æ–¼æº–ç¢ºå’Œéˆæ´»ï¼Œä¸åœ¨æ–¼æ•¸é‡å¤šå°‘ã€‚</li>
</ul>
<p><strong>éŒ¯åˆ¥å­— (3åˆ†):</strong></p>
<ul>
<li>0-1å€‹çµ¦3åˆ†ï¼›2-4å€‹çµ¦2åˆ†ï¼›5-7å€‹çµ¦1åˆ†ï¼›8å€‹æˆ–ä»¥ä¸Šä¸çµ¦åˆ†ã€‚</li>
<li>é‡éŒ¯ä¸è¨ˆã€‚</li>
</ul>

<h3>ã€é›¢é¡Œå·è©•åˆ†ã€‘</h3>
<p>ã€Œå…§å®¹ã€æœ€é«˜çµ¦ã€Œä¸‹ä¸Šã€ï¼›ã€Œè¡¨é”ã€åŠã€Œçµæ§‹ã€æœ€é«˜çµ¦ã€Œä¸­ä¸Šã€ï¼›ã€Œæ¨™é»å­—é«”ã€æœ€é«˜ä»å¯çµ¦ã€Œä¸Šä¸Šã€ã€‚</p>

<h3>ã€å­—æ•¸ä¸è¶³650å­—ã€‘</h3>
<p>ã€Œå…§å®¹ã€æœ€é«˜çµ¦åˆ†ï¼š550-649å­—ï¼šã€Œä¸Šä¸Šã€ï¼›450-549å­—ï¼šã€Œä¸­ä¸Šã€ï¼›300-449å­—ï¼šã€Œä¸­ä¸­(ä¸‹)ã€ï¼›300å­—ä»¥ä¸‹ï¼šã€Œä¸‹ä¸Šã€ã€‚</p>

<h3>ã€ä¸€èˆ¬è©•è«–æ‘˜è¦ã€‘</h3>
<p><strong>å„ªå‹ä¹‹è™•:</strong></p>
<ul>
<li><strong>å¯©é¡Œ:</strong> èƒ½æ­£ç¢ºç†è§£é¡Œç›®ã€‚</li>
<li><strong>ç«‹æ„:</strong> å¶æœ‰ä½³ä½œï¼Œèƒ½ç”±æ—¥å¸¸ç”Ÿæ´»å¼•ç”³è‡³äººç”Ÿæ„ç¾©ã€ç”Ÿæ´»å“²ç†ï¼Œå‘ˆç¾å°ç”Ÿæ´»æœ‰æ•éŠ³çš„è§€å¯Ÿå’Œæ€è€ƒã€‚</li>
<li><strong>å–æ:</strong> åœç¹æ—¥å¸¸ç”Ÿæ´»ç¶“æ­·æˆ–è¦‹èå–æã€‚</li>
<li><strong>è¡¨é”:</strong> ç”¨è©å¤§è‡´æ°ç•¶ï¼Œæ–‡å¥å¤§è‡´é€šé †ï¼›èƒ½æ°ç•¶åœ°æ•˜äº‹æŠ’æƒ…ã€æç¹ªäººç‰©æˆ–é—¡è¿°çœ‹æ³•ï¼›å˜—è©¦é‹ç”¨ä¸åŒå¯«ä½œæ‰‹æ³•ã€‚</li>
<li><strong>çµæ§‹:</strong> åˆ†æ®µå¤§è‡´æ¸…æ™°ï¼Œå°šè¦‹è„ˆçµ¡ï¼›éæ¸¡åˆç†ï¼Œçµæ§‹å®Œæ•´ã€‚</li>
</ul>
<p><strong>ä¸è¶³ä¹‹è™•:</strong></p>
<ul>
<li><strong>å¯©é¡Œ:</strong> æµæ–¼è¡¨é¢ï¼ŒæœªæŠ“ç·Šé¡Œçœ¼ç™¼æ®ã€‚</li>
<li><strong>ç«‹æ„:</strong> ç«‹æ„å¹³å¸¸ï¼Œå±¤æ¬¡ä¸é«˜ã€‚</li>
<li><strong>å–æ:</strong> æ•˜äº‹å¿½ç•¥ç´°ç¯€ï¼Œæå¯«æµæ–¼è¡¨é¢ï¼Œè«–è¿°ç²—ç–ç°¡ç•¥ï¼›æœªèƒ½ç¿»å‡ºæ–°æ„ï¼Œæå‡ºç²¾é—¢è¦‹è§£ã€‚</li>
<li><strong>è¡¨é”:</strong> æ–‡å¥ä¸é€šï¼Œè©ä¸é”æ„ã€‚</li>
<li><strong>çµæ§‹:</strong> é®®èƒ½åšåˆ°å±¤å±¤æ·±åŒ–ï¼Œå‰å¾Œå‘¼æ‡‰è€…ï¼›å°‘æ•¸æ–‡ç« ç¯‡å¹…è¼ƒé•·ï¼Œæƒœæ™‚é–“æ‰€é™ï¼Œçµæœè™é ­è›‡å°¾ï¼›æœ‰è©³ç•¥ç¨æœ‰å¤±è¡¡çš„æƒ…æ³ã€‚</li>
</ul>
</div>


<!-- å·¥å…·é¸æ“‡ -->
<div class="box" id="toolsBox" style="display: none;">
    <h2>å·¥å…·ä¸€è¦½ï¼š</h2>
    <button id="expandToolsBtn2">é»æ“Šå±•é–‹</button>
<div id="effectContainer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1001; pointer-events: none;"></div>
</div>



<!-- ç¯„ç–‡é¸æ“‡ï¼šå‹•æ¼«å¡ç‰‡é¢¨æ ¼ (å·²ä¿®è¨‚ï¼šæ”¾å…¥ä¸€è‡´çš„ Container) -->
<div class="box" id="mainMenuBox"> <!-- é€™è£¡åŠ ä¸Šäº† ID -->
    <h2>é¸æ“‡ç¯„ç–‡ï¼š</h2>
    
   <!-- éŸ³æ•ˆæª”ï¼šæ‹”åŠå‡ºé˜ (Metal Sword Sheath) -->
    <audio id="ui-click-sound" preload="auto">
        <source src="é»æ“Š.mp3" type="audio/mpeg">
    </audio>

    <div class="category-cards-wrapper">
        <div class="category-cards-container">
            <!-- é–±è®€å¡ç‰‡ -->
            <div id="readingBtn" class="anime-card" style="--bg-img: url('éƒµç­’.png');">
                <div class="card-overlay"></div>
                <div class="card-border-effect"></div>
                <div class="card-content">
                 
                    <div class="card-text">
                        <span class="card-zh">é–±è®€</span>
                        <span class="card-en">READING</span>
                    </div>
                </div>
            </div>

            <!-- æ•˜äº‹æŠ’æƒ…å¡ç‰‡ -->
            <div id="writingBtn" class="anime-card" style="--bg-img: url('ç›¸æ©Ÿ.png');">
                <div class="card-overlay"></div>
                <div class="card-border-effect"></div>
                <div class="card-content">
                  
                    <div class="card-text">
                        <span class="card-zh">æ•˜äº‹æŠ’æƒ…</span>
                        <span class="card-en">NARRATIVE</span>
                    </div>
                </div>
            </div>

            <!-- è­°è«–å¡ç‰‡ -->
            <div id="argumentBtn" class="anime-card" style="--bg-img: url('ç­†.png');">
                <div class="card-overlay"></div>
                <div class="card-border-effect"></div>
                <div class="card-content">
                
                    <div class="card-text">
                        <span class="card-zh">è­°è«–</span>
                        <span class="card-en">ARGUMENT</span>
                    </div>
                </div>
            </div>

            <!-- æ•´åˆæ‹“å±•å¡ç‰‡ -->
            <div id="expandBtn" class="anime-card" style="--bg-img: url('ç«è»Š.png');">
                <div class="card-overlay"></div>
                <div class="card-border-effect"></div>
                <div class="card-content">
                  
                    <div class="card-text">
                        <span class="card-zh">æ•´åˆæ‹“å±•</span>
                        <span class="card-en">EXPAND</span>
                    </div>
                </div>
            </div>




        </div>
    </div>
</div>

<!-- å¯«ä½œå®¹å™¨ -->
<div id="writingContainer" class="box">
    <h2>æ•˜äº‹æŠ’æƒ…</h2>
    <div style="position:relative; width:100%; height:0px; padding-bottom:62.222%"><iframe allow="fullscreen" allowfullscreen height="100%" src="https://streamable.com/e/lke2eo?loop=0" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; bottom:2px; overflow:hidden;" referrerpolicy="no-referrer-when-downgrade" credentialless></iframe></div>

    <div class="function-selector-wrapper">
        <label for="writingType">é¸æ“‡åŠŸèƒ½ï¼š</label>
        <select id="writingType" onchange="toggleWritingType()">
            <option value="" selected disabled>è«‹åœ¨æ­¤é¸æ“‡åŠŸèƒ½</option>
           
            <option value="å¤§ç¶±">å¤§ç¶±é»è©•</option>
            <option value="ç‰‡æ®µæå¯«">æ–‡ç« é»è©•</option>
			 <option value="guide">è§£é¡ŒæŒ‡å¼•</option>
            <option value="æ•˜äº‹ç‰©è±¡">æ•˜äº‹ç‰©è±¡</option>
        </select>
    </div>

    <div id="writingContentContainer" style="display: none;">
        
        <!-- === æ–°å¢ï¼šè§£é¡ŒæŒ‡å¼•å€åŸŸ (ä¿®è¨‚ç‰ˆ) === -->
        <div id="writingGuideArea" style="display: none;">
            <label for="writingGuideTopicInput">è«‹è¼¸å…¥é¡Œç›®ï¼š</label>
            <input type="text" id="writingGuideTopicInput" placeholder="ä¾‹å¦‚ï¼šå¯‚å¯çš„çœŸç›¸ã€è¢«éºå¿˜çš„æ‰¿è«¾..." style="font-size: 1.1rem;">
            
            <button id="submitWritingGuideBtn" class="btn-action" onclick="submitWritingGuide()">æäº¤åˆ†æ</button>

            <!-- çµæœé¡¯ç¤ºå€ -->
            <div id="writingGuideResultContainer" style="display: none; margin-top: 25px;">
                
                <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šé—œéµè©å¼µåŠ›åˆ†æ -->
                <div class="guide-section-header" style="border-left: 5px solid #4A90E2; color: #4A90E2;">
                    <h3><i class="fas fa-search"></i> é¡Œçœ¼åˆ†æ</h3>
                </div>
                <!-- ç¸½é«”åˆ†æ (æ¯”å–»èˆ‡é—œä¿‚) -->
                <div id="guideIntro" class="guide-intro-card"></div>
                <!-- ä¸‰ç¨®å¿ƒæƒ… (ä¸‰æ¬„ä½ˆå±€) -->
                <div id="guideEmotions" class="guide-grid-3"></div>

                <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šå¯«ä½œæ–¹å‘å»ºè­° -->
                <div class="guide-section-header" style="border-left: 5px solid #28a745; color: #28a745; margin-top: 30px;">
                    <h3><i class="fas fa-compass"></i> å¯«ä½œæ–¹å‘</h3>
                </div>
                <!-- ä¸‰å€‹æ•…äº‹ç¨®å­ (ä¸‰æ¬„ä½ˆå±€) -->
                <div id="guideSeeds" class="guide-grid-3"></div>


<!-- æ–°å¢ï¼šè§£é¡ŒæŒ‡å¼•çš„èŠå¤©å®¤ä»‹é¢ -->
                <div id="writingGuideChatHistory" style="display: none; background-color: #f0f4f8; border: 1px solid #dde3ea; border-radius: 12px; padding: 20px 15px; margin-top: 15px; margin-bottom: 15px; max-height: 400px; overflow-y: auto; flex-direction: column;"></div>
                
                <div id="writingGuideChatInputContainer" style="display: none; align-items: center; gap: 10px; margin-top: 15px;">
                    <textarea id="writingGuideUserInput" class="no-modal-editor" rows="2" placeholder="å¯å°±ä»¥ä¸ŠæŒ‡å¼•è¿½å•..." style="flex-grow: 1; margin: 0;"></textarea>
                    <button id="continueWritingGuideBtn" class="btn-icon-action" onclick="continueWritingGuideDiscussion()" title="ç¹¼çºŒè¨è«–" style="background-color: #2d9966;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
				</div>

				
                <!-- å„²å­˜æŒ‰éˆ• -->
                <div class="result-wrapper">
                    <button id="save-guide-html-btn" class="btn-save-html" title="å„²å­˜ç‚ºHTMLæª”æ¡ˆ" onclick="savePageAsHTML('ç¥æ€-æ•˜äº‹æŠ’æƒ…-è§£é¡ŒæŒ‡å¼•.html')" style="display: flex;">
                        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- === æ–°å¢çµæŸ === -->

        <div id="outlineStructureArea" style="display: none;">
            <label for="structure">é¸æ“‡å¤§ç¶±çµæ§‹ï¼š</label>
            <select id="structure" onchange="generateOutlineTable()">
                <option value="fourPart">èµ·æ‰¿è½‰åˆ</option>
                <option value="threeLine">ä¸‰ç·š</option>
            </select>
        </div>
        
        <!-- ... èˆŠæœ‰ä»£ç¢¼ä¿æŒä¸è®Š ... -->
        <div id="topicSelectionArea">
            <label>é¸æ“‡é¡Œç›®æ–¹å¼ï¼š</label>
            <div class="topic-buttons-container">
                <button class="btn btn-generate" onclick="generateTopic(this)">
                    <i class="fas fa-sync-alt"></i> ç”Ÿæˆ
                </button>
                <button class="btn btn-custom" onclick="showCustomTopicInput(this)">
                    <i class="fas fa-edit"></i> è‡ªè¨‚
                </button>
            </div>
            <div id="customTopicArea" style="display: none; margin-top: 15px;"></div>
        </div>

        <div id="topicResult"></div>
        <div id="narrativeElementsArea" style="display: none;">
            <label for="narrativeElements">è«‹è¼¸å…¥æ‚¨çš„å–ææˆ–æ•…äº‹èƒŒæ™¯ï¼š</label>
            <textarea id="narrativeElements" rows="5" placeholder="ä¾‹å¦‚ï¼šæ•…äº‹èƒŒæ™¯ã€äººç‰©è¨­å®šã€å–æç­‰..."></textarea>
        </div>
        
        <div id="writingArea">
            <div id="outlineTableArea"></div>
            <div id="outlineButtons" style="display: none;" class="action-buttons-container">
                <button class="btn-icon-action btn-save-icon" onclick="saveOutline()" title="å„²å­˜å¤§ç¶±">
                    <i class="fas fa-save"></i>
                </button>
                <button class="btn-icon-action btn-clear-icon" onclick="clearOutline()" title="æ¸…ç©ºå¤§ç¶±">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
            <textarea id="writingContent" rows="10" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„æ–‡ç« ..." style="display: none;"></textarea>
            
            <label for="writingTone" id="writingToneLabel" class="tone-selector-label" style="display: none;">é¸æ“‡é»è©•èªæ°£ï¼š</label>
            <select id="writingTone" style="display: none;">
                <option value="serious">åš´è‚…æ­£ç¶“</option>
                <option value="chen">é™³SIRèªæ°£</option>
            </select>

            <label for="writingReviewer" id="writingReviewerLabel" class="tone-selector-label" style="display: none;">é¸æ“‡é–±å·å“¡ï¼š</label>
            <select id="writingReviewer" style="display: none;">
                <option value="chen_sir" selected>é™³Sir</option>
                <option value="ms_chan">Ms Chan</option>
                <option value="huang_laoshi">é»ƒè€å¸«</option>
                <option value="deng_laoshi">é„§è€å¸«</option>
                <option value="xiao_laoshi">è•­è€å¸«</option>
                <option value="dong_laoshi">è‘£è€å¸«</option>
                <option value="li_laoshi">æè€å¸«</option>
                <option value="zhen_laoshi">ç”„è€å¸«</option>
                <option value="wen_laoshi">æº«è€å¸«</option>
                <option value="jiang_laoshi">æ±Ÿè€å¸«</option>
            </select>

            <div id="reviewScopeArea" style="display: none; margin-top: 25px;">
                <label class="tone-selector-label">é¸æ“‡é»è©•ç¯„ç–‡ï¼š</label>
                <div class="scope-selector-container">
                    <label class="scope-label all-scope"><input type="checkbox" name="reviewScope" value="å…¨éƒ¨" checked> å…¨éƒ¨</label>
                    <label class="scope-label"><input type="checkbox" name="reviewScope" value="æ‰£é¡Œ"> æ‰£é¡Œ</label>
                    <label class="scope-label"><input type="checkbox" name="reviewScope" value="ç«‹æ„"> ç«‹æ„</label>
                    <label class="scope-label"><input type="checkbox" name="reviewScope" value="å–æ"> å–æ</label>
                    <label class="scope-label"><input type="checkbox" name="reviewScope" value="è©³ç•¥"> è©³ç•¥</label>
                    <label class="scope-label"><input type="checkbox" name="reviewScope" value="æ–‡ç­†"> æ–‡ç­†</label>
                </div>
            </div>

            <button id="submitWritingBtn" class="btn-action" onclick="submitWriting()">æäº¤</button>
            
            <div id="writingReviewResultContainer">
                <div id="writingGradingResult"></div>
                <div id="writingChatHistory" style="display: none;"></div>
                <div id="writingChatInputContainer" style="display: none;">
                    <textarea id="writingUserInput" class="no-modal-editor" rows="2" placeholder="å¯å°±ä»¥ä¸Šé»è©•è¿½å•..."></textarea>
                    <button id="continueWritingBtn" class="btn-icon-action" onclick="continueWritingDiscussion()" title="ç¹¼çºŒè¨è«–" style="background-color: #2d9966;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <div class="result-wrapper" style="position: relative;">
                <div id="commentResult"></div>
              
            </div>
        </div>
    </div>
</div>



<!-- é–±è®€å®¹å™¨ -->
<div id="readingContainer" class="box" style="display: none;">
<h2>é–±è®€</h2>
<div style="position:relative; width:100%; height:0px; padding-bottom:62.222%"><iframe allow="fullscreen" allowfullscreen height="100%" src="https://streamable.com/e/vt3i1j?loop=0" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; bottom:2px; overflow:hidden;" referrerpolicy="no-referrer-when-downgrade" credentialless></iframe></div>

<div class="function-selector-wrapper">
<label for="readingFunction">é¸æ“‡åŠŸèƒ½ï¼š</label>
<select id="readingFunction" onchange="toggleReadingFunction()">
<option value="" selected disabled>è«‹åœ¨æ­¤é¸æ“‡åŠŸèƒ½</option>
<option value="comment">é»è©•</option>
<option value="guide">æŒ‡å¼•</option>
<option value="training">è¨“ç·´</option>  <!-- æ–°å¢æ­¤è¡Œ -->
</select>
</div>

<div id="readingInputArea" style="display: none;">
<label for="readingPassage">è²¼ä¸Šé–±è®€ç¯‡ç« ï¼š</label>
<textarea id="readingPassage" rows="10" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šé–±è®€ç¯‡ç« ..."></textarea>
<label for="readingQuestion">è²¼ä¸Šé¡Œç›®ï¼š</label>
<textarea id="readingQuestion" rows="3" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šé¡Œç›®..."></textarea>
<div id="studentAnswerArea" style="display: none;">
<label for="studentAnswer">è²¼ä¸Šç­”æ¡ˆï¼š</label>
<textarea id="studentAnswer" rows="5" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šç­”æ¡ˆ..."></textarea>
</div>
<label for="readingTone" id="readingToneLabel" class="tone-selector-label" style="display: none;">é¸æ“‡é»è©•èªæ°£ï¼š</label>
<select id="readingTone" style="display: none;">
<option value="serious">åš´è‚…æ­£ç¶“</option>
<option value="chen">é™³SIRèªæ°£</option>
</select>
<!-- å°‡ <button onclick="submitReading()"> æ”¹ç‚ºï¼š -->
<button id="submitReadingBtn" class="btn-action" onclick="submitReading()">æäº¤</button>
<div class="result-wrapper" style="position: relative;">
	<div id="readingResult"></div>
	
</div>
</div>
</div>

<!-- èª²å¤–æ›¸ç±å®¹å™¨ -->
<div id="booksContainer" class="box" style="display: none;">
<h2>æ›¸ç±è¨è«–</h2>
<div style="position:relative; width:100%; height:0px; padding-bottom:62.222%"><iframe allow="fullscreen" allowfullscreen height="100%" src="https://streamable.com/e/4eznsi?loop=0" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; bottom:2px; overflow:hidden;" referrerpolicy="no-referrer-when-downgrade" credentialless></iframe></div>

<!-- åˆå§‹è¼¸å…¥è¡¨å–® -->
<div id="initialDiscussionForm">
<p>è«‹åœ¨ä¸‹æ–¹å¡«å¯«æ›¸åã€ä½œè€…å’Œè¨è«–å•é¡Œï¼Œé–‹å§‹èˆ‡é™³SIRå°è©±ï¼š</p>
<input type="text" id="bookTitle" class="no-modal-editor" placeholder="æ›¸å">
<input type="text" id="author" class="no-modal-editor" placeholder="ä½œè€…">
<textarea id="discussionQuestion" class="no-modal-editor" rows="3" placeholder="è¨è«–å•é¡Œ"></textarea>
<label for="booksTone">é¸æ“‡èªæ°£ï¼š</label>
<select id="booksTone">
<option value="serious">åš´è‚…æ­£ç¶“</option>
<option value="casual">è¼•é¬†æ´»æ½‘</option>
</select>
<div id="discussionControlButtons">
<button id="startDiscussionBtn" class="btn-action" onclick="startDiscussion()">é–‹å§‹è¨è«–</button>
</div>
</div>

<!-- èŠå¤©æ­·å²ç´€éŒ„ -->
<div class="result-wrapper" style="position: relative;">
	<div id="chatHistory"></div>
	
</div>


<!-- èŠå¤©è¼¸å…¥ä»‹é¢ (å·²ç§»é™¤æ–°å¢æŒ‰éˆ•) -->
<div id="chatInputContainer">
<textarea id="userInput" class="no-modal-editor" rows="2" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å›æ‡‰..."></textarea>
<button id="continueBtn" class="btn-icon-action" onclick="continueDiscussion()" title="ç¹¼çºŒè¨è«–" style="background-color: #2d9966;">
<i class="fas fa-paper-plane"></i>
</button>
</div>

<!-- å„²å­˜/æ¸…é™¤æŒ‰éˆ• (å·²åŠ å…¥æ–°å¢æŒ‰éˆ•) -->
<div id="booksButtons" class="action-buttons-container">
  
	
<!-- ã€Œæ–°å¢è¨è«–ã€æŒ‰éˆ•å·²ç§»åˆ°æ­¤è™•ï¼Œä½æ–¼å„²å­˜æŒ‰éˆ•å·¦æ–¹ -->
<button id="newTopicBtn" class="btn-icon-action btn-add-icon" title="æ–°å¢è¨è«–ä¸»é¡Œ">
<i class="fas fa-plus"></i>
</button>
<button class="btn-icon-action btn-save-icon" onclick="saveBooksChat()" title="å„²å­˜å°è©±">
<i class="fas fa-save"></i>
</button>
<button class="btn-icon-action btn-clear-icon" onclick="clearBooksChat()" title="æ¸…ç©ºå°è©±">
<i class="fas fa-trash-alt"></i>
</button>
</div>
</div>

<!-- æ–°å¢è¨è«–çš„å½ˆå‡ºè¦–çª— -->
<div id="newTopicModal" class="books-modal">
<div class="modal-content">
<span class="close-modal-btn" id="closeNewTopicModal">&times;</span>
<h3>æ–°å¢è¨è«–</h3>
<input type="text" id="modalBookTitle" class="no-modal-editor" placeholder="æ›¸å">
<input type="text" id="modalAuthor" class="no-modal-editor" placeholder="ä½œè€…">
<textarea id="modalDiscussionQuestion" class="no-modal-editor" rows="3" placeholder="è¨è«–å•é¡Œ"></textarea>
<div style="text-align: right; margin-top:15px;">
<button id="modalStartDiscussionBtn" class="btn-icon-confirm" title="é–‹å§‹æ–°è¨è«–">
<i class="fas fa-check"></i>
</button>
</div>
</div>
</div>


<!-- æ•´åˆæ‹“å±•å®¹å™¨ -->
<div id="expandContainer" class="box" style="display: none;">
<h2>æ•´åˆæ‹“å±•</h2>
<div style="position:relative; width:100%; height:0px; padding-bottom:62.222%"><iframe allow="fullscreen" allowfullscreen height="100%" src="https://streamable.com/e/2otwxv?loop=0" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; bottom:2px; overflow:hidden;" referrerpolicy="no-referrer-when-downgrade" credentialless></iframe></div>

<div class="function-selector-wrapper">
<label for="expandFunction">é¸æ“‡åŠŸèƒ½ï¼š</label>
<select id="expandFunction" onchange="toggleExpandFunction()">
<option value="" selected disabled>è«‹åœ¨æ­¤é¸æ“‡åŠŸèƒ½</option>
<option value="comment">é»è©•</option>
<option value="guide">æŒ‡å¼•</option>
</select>
</div>

<div id="expandContentContainer" style="display: none;">

<div id="expandTopicSelectionArea" style="display: none;">
<label>é¸æ“‡é¡Œç›®æ–¹å¼ï¼š</label>
<div class="topic-buttons-container">
<!-- å¥—ç”¨æ–°çš„ class: btn-generate -->
<button class="btn btn-generate" onclick="generateExpandTopic(this)">
<i class="fas fa-sync-alt"></i> ç”Ÿæˆ
</button>
<!-- å¥—ç”¨æ–°çš„ class: btn-custom -->
<button class="btn btn-custom" onclick="showExpandCustomTopicInput(this)">
<i class="fas fa-edit"></i> è‡ªè¨‚
</button>
</div>
<!-- é€™å€‹ div ç”¨ä¾†å‹•æ…‹é¡¯ç¤ºè‡ªè¨‚é¡Œç›®çš„è¼¸å…¥æ¡† -->
<div id="expandCustomTopicInputArea" style="display: none; margin-top: 15px;">
</div>
</div>
<div id="expandTopicResult"></div>

<div id="expandWritingArea" style="display: none;">
<label for="expandContent">æ•´åˆæ‹“å±•ï¼ˆæœ€å¤š180å­—ï¼‰ï¼š</label>
<textarea id="expandContent" rows="5" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ•´åˆæ‹“å±•å…§å®¹..." oninput="updateCharCount()"></textarea>
<p id="charCount">å‰©é¤˜å­—æ•¸ï¼š180</p>
<label for="expandTone" id="expandToneLabel" class="tone-selector-label" style="display: none;">é¸æ“‡é»è©•èªæ°£ï¼š</label>
<select id="expandTone" style="display: none;">
<option value="serious">åš´è‚…æ­£ç¶“</option>
<option value="chen">é™³SIRèªæ°£</option>
</select>
<!-- å°‡ <button onclick="submitExpand()"> æ”¹ç‚ºï¼š -->
<button id="submitExpandBtn" class="btn-action" onclick="submitExpand()">æäº¤</button>
<div class="result-wrapper" style="position: relative;">
	<div id="expandCommentResult"></div>
	
</div>
</div>

<div id="expandGuideArea" style="display: none;">
<table>
<tr><th>é¡Œç›®</th><td><input type="text" id="expandGuideTitle" placeholder="è«‹è¼¸å…¥é¡Œç›®"></td></tr>
<tr><th>ä¸»é¡Œå¥</th><td><textarea id="expandGuideTheme" rows="2" placeholder="è«‹è¼¸å…¥ä¸»é¡Œå¥"></textarea></td></tr>
<tr><th>æŠ„éŒ„è³‡æ–™</th><td><textarea id="expandGuideData" rows="3" placeholder="è«‹è¼¸å…¥æŠ„éŒ„è³‡æ–™"></textarea></td></tr>
<tr><th>æ•´åˆæ‹“å±•</th><td><textarea id="expandGuideExpand" rows="3" placeholder="è«‹è¼¸å…¥æ•´åˆæ‹“å±•"></textarea></td></tr>
</table>
<!-- ã€ä¿®è¨‚è™•ã€‘ç‚ºæŒ‰éˆ•æ·»åŠ  ID -->
<button id="submitExpandGuideBtn" class="btn-action" onclick="submitExpand()">æäº¤</button>
<div style="position: relative;">
	<div id="expandGuideResult"></div>

</div>
</div></div>
</div>

<!-- è­°è«–å®¹å™¨ -->
<div id="argumentContainer" class="box" style="display: none;">
<h2>è­°è«–</h2>
<div style="position:relative; width:100%; height:0px; padding-bottom:62.222%"><iframe allow="fullscreen" allowfullscreen height="100%" src="https://streamable.com/e/0ki8mx?loop=0" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; bottom:2px; overflow:hidden;" referrerpolicy="no-referrer-when-downgrade" credentialless></iframe></div>

<div class="function-selector-wrapper">
<label for="argumentType">é¸æ“‡åŠŸèƒ½ï¼š</label>
<select id="argumentType" onchange="toggleArgumentType()">
<option value="" selected disabled>è«‹åœ¨æ­¤é¸æ“‡åŠŸèƒ½</option>
<option value="outline">å¤§ç¶±é»è©•</option>
<option value="writing">æ–‡ç« é»è©•</option>
<option value="guide">æŒ‡å¼•</option>
</select>
</div>

<div id="argumentContentContainer" style="display: none;">
<div id="argumentTopicSelectionArea">
<label>é¸æ“‡é¡Œç›®æ–¹å¼ï¼š</label>
<div class="topic-buttons-container">
<!-- å¥—ç”¨æ–°çš„ class: btn-generate -->
<button class="btn btn-generate" onclick="generateArgumentTopic(this)">
<i class="fas fa-sync-alt"></i> ç”Ÿæˆ
</button>
<!-- å¥—ç”¨æ–°çš„ class: btn-custom -->
<button class="btn btn-custom" onclick="showArgumentCustomTopicInput(this)">
<i class="fas fa-edit"></i> è‡ªè¨‚
</button>
</div>
<div id="argumentCustomTopicArea" style="display: none; margin-top: 15px;">
<!-- å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
</div>
</div>
<div id="argumentTopicResult"></div>
<div id="argumentOutlineArea" style="display: none;">

<div id="argumentOutlineTableArea"></div>

<!-- æŒ‰éˆ•å®¹å™¨ç¾åœ¨åŒ…å«äº†æ–°å¢ã€å„²å­˜å’Œæ¸…é™¤æŒ‰éˆ• -->
<div id="argumentOutlineButtons" class="action-buttons-container">
<button class="btn-icon-action btn-add-icon" onclick="addArgumentStructureSegment()" title="æ–°å¢çµæ§‹æ®µ">
<i class="fas fa-plus"></i>
</button>
<button class="btn-icon-action btn-save-icon" onclick="saveArgumentOutline()" title="å„²å­˜å¤§ç¶±">
<i class="fas fa-save"></i>
</button>
<button class="btn-icon-action btn-clear-icon" onclick="clearArgumentOutline()" title="æ¸…ç©ºå¤§ç¶±">
<i class="fas fa-trash-alt"></i>
</button>
</div>

<label for="argumentOutlineTone" class="tone-selector-label">é¸æ“‡é»è©•èªæ°£ï¼š</label>
<select id="argumentOutlineTone">
<option value="serious">åš´è‚…æ­£ç¶“</option>
<option value="chen">é™³SIRèªæ°£</option>
</select>
<button id="submitArgumentOutlineBtn" class="btn-action" onclick="submitArgumentOutline()">æäº¤</button>
<div class="result-wrapper" style="position: relative;">
	<div id="argumentOutlineResult"></div>

</div>
</div>
<div id="argumentWritingArea" style="display: none;">
<textarea id="argumentWritingContent" rows="10" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„æ–‡ç« ..."></textarea>
<label for="argumentWritingTone" class="tone-selector-label">é¸æ“‡é»è©•èªæ°£ï¼š</label>
<select id="argumentWritingTone">
        <option value="serious">åš´è‚…æ­£ç¶“</option>
        <option value="chen">é™³SIRèªæ°£</option>
    </select>

    <!-- ======= è«‹åœ¨é€™è£¡åŠ å…¥ä»¥ä¸‹ç¨‹å¼ç¢¼ ======= -->
    <label for="argumentReviewer" class="tone-selector-label">é¸æ“‡é–±å·å“¡ï¼š</label>
    <select id="argumentReviewer">
      <option value="chen_sir" selected>é™³Sir</option>
      <option value="ms_chan">Ms Chan</option>
      <option value="huang_laoshi">é»ƒè€å¸«</option>
      <option value="deng_laoshi">é„§è€å¸«</option>
      <option value="xiao_laoshi">è•­è€å¸«</option>
      <option value="dong_laoshi">è‘£è€å¸«</option>
      <option value="li_laoshi">æè€å¸«</option>
      <option value="zhen_laoshi">ç”„è€å¸«</option>
      <option value="wen_laoshi">æº«è€å¸«</option>
      <option value="jiang_laoshi">æ±Ÿè€å¸«</option>
    </select>
    <!-- ======= åŠ å…¥çµæŸ ======= -->

<!-- ======= è«‹åœ¨é€™è£¡åŠ å…¥ã€è­°è«–æ–‡é»è©•ç¯„ç–‡ã€‘HTML ç¨‹å¼ç¢¼ ======= -->
<div id="argumentReviewScopeArea" style="display: none; margin-top: 25px;">
    <label class="tone-selector-label">é¸æ“‡é»è©•ç¯„ç–‡ï¼š</label>
    <div class="scope-selector-container">
        <label class="scope-label all-scope"><input type="checkbox" name="argumentReviewScope" value="å…¨éƒ¨" checked> å…¨éƒ¨</label>
        <label class="scope-label"><input type="checkbox" name="argumentReviewScope" value="è¬€ç¯‡"> è¬€ç¯‡</label>
        <label class="scope-label"><input type="checkbox" name="argumentReviewScope" value="è«–é»"> è«–é»</label>
        <label class="scope-label"><input type="checkbox" name="argumentReviewScope" value="è«–æ“š"> è«–æ“š</label>
        <label class="scope-label"><input type="checkbox" name="argumentReviewScope" value="è«–è­‰"> è«–è­‰</label>
        <label class="scope-label"><input type="checkbox" name="argumentReviewScope" value="æ–‡ç­†"> æ–‡ç­†</label>
    </div>
</div>
<!-- ======= åŠ å…¥çµæŸ ======= -->

  <button id="submitArgumentWritingBtn" class="btn-action" onclick="submitArgumentWriting()">æäº¤</button>

    <!-- æ­£ç¢ºçš„çµæ§‹ï¼šç”¨ result-wrapper åŒ…è£¹ä½æ‰€æœ‰çµæœå’ŒèŠå¤©ä»‹é¢ -->
    <div class="result-wrapper">
        
        <!-- è©•åˆ†å¡ã€æ–‡å­—é»è©•å’ŒèŠå¤©ä»‹é¢éƒ½å°‡è¢«å‹•æ…‹æ”¾å…¥é€™å€‹å®¹å™¨ä¸­ -->
        <div id="argumentReviewResultContainer">
            <!-- è©•åˆ†ç³»çµ±æˆ–èšç„¦å¼é»è©•å°‡æœƒè¢«å‹•æ…‹æ’å…¥åˆ°é€™è£¡ -->
            <div id="argumentGradingResult"></div>

            <!-- èŠå¤©æ­·å²ç´€éŒ„ -->
            <div id="argumentChatHistory" style="display: none;"></div>

            <!-- èŠå¤©è¼¸å…¥ä»‹é¢ -->
            <div id="argumentChatInputContainer" style="display: none;">
                <textarea id="argumentUserInput" class="no-modal-editor" rows="2" placeholder="å¯å°±ä»¥ä¸Šé»è©•è¿½å•..."></textarea>
                <button id="continueArgumentBtn" class="btn-icon-action" onclick="continueArgumentDiscussion()" title="ç¹¼çºŒè¨è«–" style="background-color: #2d9966;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

    
    </div>
</div>
<div id="argumentGuideArea" style="display: none;">
<label for="argumentGuideTopic">é¡Œç›®ï¼š</label>
<input type="text" id="argumentGuideTopic" placeholder="è«‹è¼¸å…¥é¡Œç›®">
<label for="argumentGuidePoint">è«–é»ï¼ˆå¯é¸ï¼‰ï¼š</label>
<textarea id="argumentGuidePoint" rows="3" placeholder="è«‹è¼¸å…¥è«–é»"></textarea>
<label for="argumentGuideEvidence">è«–æ“šï¼ˆå¯é¸ï¼‰ï¼š</label>
<textarea id="argumentGuideEvidence" rows="3" placeholder="è«‹è¼¸å…¥è«–æ“š"></textarea>
<label for="argumentGuideArgument">è«–è­‰ï¼ˆå¯é¸ï¼‰ï¼š</label>
<textarea id="argumentGuideArgument" rows="3" placeholder="è«‹è¼¸å…¥è«–è­‰"></textarea>
<button id="submitArgumentGuideBtn" class="btn-action" onclick="submitArgumentGuide()">æäº¤</button>
<div class="result-wrapper" style="position: relative;">
	<div id="argumentGuideResult"></div>
	
</div>
</div>
</div>
</div>

<!-- éŸ³æ¨‚æ’­æ”¾å™¨ HTML (å·²æ›´æ›åœ–ç¤º) -->
<!-- éŸ³æ¨‚æ’­æ”¾å™¨ HTML (å·²ç§»é™¤æ‡¸æµ®æŒ‰éˆ•) -->
<!-- éŸ³æ¨‚æ’­æ”¾å™¨ HTML -->
<div id="music-player">
    <div class="controls">
        <select id="music-select">
            <option value="">é¸æ“‡éŸ³æ¨‚</option>
            <!-- å…¶ä»–é¸é …å·²è¢«ç§»é™¤ï¼Œå°‡ç”± JS å‹•æ…‹è¼‰å…¥ -->
        </select>
        <button id="play-pause" title="æ’­æ”¾/æš«åœ"><i class="fas fa-play"></i></button>
    </div>
    
    <div class="progress">
        <input type="range" id="progress-bar-music" value="0" min="0" max="100">
    </div>
    
    <div class="mode">
        <select id="play-mode">
            <option value="loop" selected>å–®æ›²å¾ªç’°</option>
            <option value="next">è‡ªå‹•æ’­æ”¾ä¸‹é¦–</option>
        </select>
    </div>
    
    <button class="hide-btn" id="hide-player" title="é—œé–‰æ’­æ”¾å™¨"><i class="fas fa-chevron-down"></i></button>
</div>

<!-- å°‡ preload æ”¹ç‚º noneï¼Œé¿å…é é¢è¼‰å…¥æ™‚ä¸‹è¼‰éŸ³è¨Š -->
<audio id="audio" preload="none"></audio>
<!-- === æ­·å²ç´€éŒ„å®¹å™¨ (æœ€çµ‚ç‰ˆ) === -->
<div id="historyContainer" class="box" style="display: none;">
    
 <!-- æ¨™é¡Œåˆ— -->
    <div class="history-header-bar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
        <h2 style="margin:0; color: #333; font-size: 1.5em;"><i class="fas fa-history"></i> æ­·å²ç´€éŒ„</h2>
        
        <div style="display: flex; gap: 10px;">
            
            <!-- â˜…â˜…â˜… æ–°å¢ï¼šç”Ÿæˆå­¸ç¿’å ±å‘ŠæŒ‰éˆ• â˜…â˜…â˜… -->
           <button class="history-clear-btn" title="å­¸ç¿’å ±å‘Š" onclick="openReportMenu()" style="color: #2A9689;">
    <i class="fas fa-chart-pie"></i>
</button>
            <!-- â˜…â˜…â˜… æ–°å¢çµæŸ â˜…â˜…â˜… -->

            <!-- åŸæœ‰çš„ï¼šæ—¥æœŸæœå°‹æŒ‰éˆ• -->
            <div id="historyDateSearchContainer" style="display: none; position: relative;">
                <button class="history-clear-btn" title="ä¾æ—¥æœŸæœå°‹" onclick="triggerDatePicker()">
                    <i class="fas fa-calendar-alt"></i>
                </button>
                <input type="date" id="historyDatePicker" onchange="scrollToHistoryDate(this)" 
                       style="position: absolute; top: 0; left: 0; width: 0; height: 0; opacity: 0; border: none; padding: 0;">
            </div>

            <!-- åŸæœ‰çš„ï¼šæ¸…ç©ºæŒ‰éˆ• -->
            <button class="history-clear-btn" title="æ¸…ç©ºæ‰€æœ‰ç´€éŒ„" onclick="clearAllHistory()">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
    </div>


	<!-- å­¸ç¿’å ±å‘Šæ“ä½œé¸å–® (æ–°å¢) -->
<div id="reportMenuModal" class="report-menu-overlay" onclick="closeReportMenu(event)">
    <div class="report-menu-content">
        <div class="report-menu-title">å­¸ç¿’å ±å‘Š</div>
        <div class="report-options-grid">
            <!-- é¸é …ä¸€ï¼šç”Ÿæˆæ–°å ±å‘Š -->
            <div class="report-option-card" onclick="generateHistoryReport()">
                <i class="fas fa-magic report-option-icon"></i>
                <span class="report-option-text">ç”Ÿæˆæ–°å ±å‘Š</span>
            </div>
            <!-- é¸é …äºŒï¼šæª¢é–±ç´€éŒ„ -->
            <div class="report-option-card" onclick="viewPastReports()">
                <i class="fas fa-folder-open report-option-icon"></i>
                <span class="report-option-text">æª¢é–±ç´€éŒ„</span>
            </div>
        </div>
    </div>
</div>

    <!-- éºµåŒ…å±‘å°èˆª -->
    <div id="historyBreadcrumb" class="history-breadcrumb" style="display: none; margin-bottom: 20px; padding: 10px 15px; background: rgba(0,0,0,0.05); border-radius: 8px; font-size: 1rem;">
        <span onclick="renderHistoryCategories()" style="cursor: pointer; color: #007bff; font-weight: bold;"><i class="fas fa-home"></i> ä¸»ç¯„ç–‡</span> 
        <span id="breadcrumb-sep-1" style="display:none; color: #666;"> &gt; </span>
        <span id="breadcrumb-category" onclick="backToSubFunctions()" style="cursor: pointer; color: #007bff; display:none;"></span>
        <span id="breadcrumb-sep-2" style="display:none; color: #666;"> &gt; </span>
        <span id="breadcrumb-sub" style="font-weight: bold; color: #333; display:none;"></span>
    </div>

    <!-- ç¬¬ä¸€å±¤ï¼šä¸»ç¯„ç–‡é¸æ“‡ (å¡ç‰‡å®¹å™¨) -->
    <div id="historyLevel1Wrapper" class="category-cards-wrapper" style="padding-top: 10px; padding-bottom: 20px;">
        <div id="historyLevel1" class="category-cards-container">
            <!-- JS å°‡åœ¨é€™è£¡ç”Ÿæˆå‹•æ¼«å¡ç‰‡ -->
        </div>
    </div>

    <!-- ç¬¬äºŒå±¤ï¼šå­åŠŸèƒ½é¸æ“‡ (Grid é¸å–®) -->
    <div id="historyLevel2" class="history-grid-menu" style="display: none;">
        <!-- JS ç”Ÿæˆå­åŠŸèƒ½æŒ‰éˆ• -->
    </div>

    <!-- ç¬¬ä¸‰å±¤ï¼šç´€éŒ„åˆ—è¡¨ -->
    <div id="historyLevel3" class="history-list-container" style="display: none;">
        <!-- JS ç”Ÿæˆç´€éŒ„å¡ç‰‡ -->
    </div>
</div>

<!-- === æ­·å²ç´€éŒ„è©³ç´°æª¢è¦–è¦–çª— (ä¿æŒä¸è®Š) === -->
<div id="historyModal" class="preview-modal-overlay">
    <div class="preview-modal-content" style="max-width: 900px; height: 90%;">
        <div class="history-modal-header" style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="historyModalTitle" style="margin: 0; color: #2A9689;">ç´€éŒ„è©³æƒ…</h3>
            <span id="historyModalDate" style="color: #888; font-size: 0.9em;"></span>
        </div>
        <div class="preview-modal-body" style="padding: 20px; overflow-y: auto; display: block;">
            <div id="historyModalContent"></div>
        </div>
        <button class="preview-close-btn" onclick="closeHistoryModal()" style="top: 10px; right: 10px;">&times;</button>
    </div>
</div>

	
<!-- å±•é–‹å·¥å…·äºŒ (èªè–ˆ) å®¹å™¨ -->
<div id="toolsContainer2">
<button id="closeToolsBtn2">&times;</button>
<div class="main-container">
<!-- Floating Title -->
<!-- Floating Title -->
<header class="floating-header">
<h1>èªè–ˆ</h1>
<button id="video-tour-btn" title="è§€çœ‹ä»‹ç´¹å½±ç‰‡">
<svg class="icon" viewBox="0 0 24 24"><use xlink:href="#icon-video"></use></svg>
</button>
</header>

<!-- Embedded SVG Icons -->
<svg width="0" height="0" style="position:absolute">
<defs>
<symbol id="icon-brain" viewBox="0 0 24 24"><path d="M7.445 11.232C7.445 10.537 7.98 9.96 8.629 9.96H9.02V8.203H7.818C6.983 8.203 6.3 8.91 6.3 9.778V11.23H5.161C4.326 11.23 3.644 11.938 3.644 12.806V14.17H2.82C2.17 14.17 1.636 14.746 1.636 15.44V17.65H1.523C.688 17.65 0 18.358 0 19.226V20.48C0 21.35 0.688 22.056 1.523 22.056H6.738C6.738 23.13 7.573 24 8.628 24H15.37C16.425 24 17.26 23.13 17.26 22.058H22.477C23.312 22.058 24 21.35 24 20.48V19.225C24 18.357 23.312 17.65 22.477 17.65H22.364V15.44C22.364 14.745 21.83 14.17 21.18 14.17H20.356V12.805C20.356 11.937 19.674 11.23 18.839 11.23H17.68V9.777C17.68 8.908 17.017 8.2 16.182 8.2H14.98V9.96H15.37C16.02 9.96 16.555 10.536 16.555 11.23V12.986H15.37V15.92H8.629V12.986H7.445V11.232M11.1 11.23H12.9V14.17H11.1V11.23M12 1.947C10.13 1.947 8.58 2.894 7.854 4.316C7.65 3.52 7.2 2.813 6.545 2.27C5.124 1.053 2.95 1.54 1.987 3.16C0.945 4.925 1.489 7.346 3.09 8.528C3.21 8.62 3.33 8.71 3.464 8.78C3.464 7.024 4.818 5.618 6.52 5.618C8.22 5.618 9.573 7.024 9.573 8.78V9.1H14.4V8.78C14.4 7.024 15.78 5.618 17.48 5.618C19.18 5.618 20.536 7.024 20.536 8.78C20.662 8.71 20.782 8.62 20.91 8.528C22.51 7.346 23.055 4.925 22.013 3.16C21.05 1.54 18.876 1.053 17.455 2.27C16.8 2.813 16.35 3.52 16.145 4.316C15.42 2.894 13.87 1.947 12 1.947Z"/></symbol>
<symbol id="icon-write" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></symbol>
<symbol id="icon-read" viewBox="0 0 24 24"><path d="M18.5,1.15C19.9,1.15 21.15,2.4 21.15,3.85V15.85C21.15,17.3 19.9,18.55 18.5,18.55H5.5C4.1,18.55 2.85,17.3 2.85,15.85V3.85C2.85,2.4 4.1,1.15 5.5,1.15H18.5M18.5,22.85H5.5C2.45,22.85 0,20.4 0,17.35V2.35C0,1.4 0.35,0.6 0.95,0.1C1.25,-0.1 1.7,-0.05 2,0.25L3.1,1.35C3.3,1.55 3.3,1.85 3.1,2.05L2.05,3.1C1.85,3.3 1.55,3.3 1.35,3.1L0.7,2.45C0.7,5.55 2.85,7.85 5.5,7.85H18.5C21.15,7.85 23.3,5.55 23.3,2.45L22.6,3.1C22.4,3.3 22.1,3.3 21.9,3.1L20.85,2.05C20.65,1.85 20.65,1.55 20.85,1.35L21.95,0.25C22.25,-0.05 22.7,-0.1 23,0.1C23.6,0.6 24,1.4 24,2.35V17.35C24,20.4 21.5,22.85 18.5,22.85Z" /></symbol>
<symbol id="icon-work" viewBox="0 0 24 24"><path d="M14,6V4H10V6H14M18,9H15V6H9V9H6A2,2 0 0,0 4,11V19A2,2 0 0,0 6,21H18A2,2 0 0,0 20,19V11A2,2 0 0,0 18,9Z" /></symbol>
<symbol id="icon-support" viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z" /></symbol>
<symbol id="icon-foundation" viewBox="0 0 24 24"><path d="M12 2L2 7V17L12 22L22 17V7L12 2ZM19.6 8.25L12 12.5L4.4 8.25L12 4L19.6 8.25Z"/></symbol>
<symbol id="icon-explore" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A1.5,1.5 0 0,1 13.5,5.5A1.5,1.5 0 0,1 12,7A1.5,1.5 0 0,1 10.5,5.5A1.5,1.5 0 0,1 12,4M12,18.2C9.5,18.2 7.29,16.42 6.5,14H17.5C16.71,16.42 14.5,18.2 12,18.2Z"/></symbol>
<symbol id="icon-video" viewBox="0 0 24 24"><path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z" /></symbol>
</defs>
</svg>

<!-- Mind Map Layout -->
<main class="mind-map-container" id="mind-map">
<svg class="connector-svg" id="connector-svg"></svg>

<!-- 1. Core AI -->
<div class="category" id="core-ai" data-connect-to="">
<div class="node" data-id="core-ai-node" style="padding: 10px 20px;">
<a href="https://kenchan20141.github.io/AIChinese/" data-tool-id="sansi">






<svg class="icon" style="width:32px; height:32px;"><use xlink:href="#icon-brain"></use></svg>
ç¥æ€
</a>
</div>
<div class="sub-group" style="flex-direction: row; gap: 10px;">

<div class="node level-3"><a href="https://sansi.vercel.app/" data-tool-id="sansi-v3">ç¥æ€ (å‚™ç”¨)</a></div>
</div>
</div>

<!-- Foundations tier -->
<div id="foundations" data-connect-to="core-ai-node">
<div class="foundation-item" data-id="foundation-tizi">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-foundation"></use></svg>æ‡‰è©¦</div>
<div class="sub-group-title">AIæ“¬é¡Œ</div>
<div class="node level-2"><a href="toolbox/generator.html" data-tool-id="tizi">é¡Œå­³<br></a></div>
</div>
<div class="foundation-item" data-id="foundation-explore">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-explore"></use></svg>èª²å¤–æ¢ç´¢</div>
<div class="sub-group-title">èª²å¤–ç¯‡ç« </div>
<div class="node level-2"><a href="toolbox/reading.html" data-tool-id="reading-pieces">æ–‡å­¸ãƒ»ç‰‡æ®µ</a></div>
<div class="node level-2"><a href="toolbox/mensyu.html" data-tool-id="mensyu">æ–‡æ¨</a></div>
<div class="node level-2"><a href="toolbox/slowreading.html" data-tool-id="slowreading">æ…¢è®€</a></div>
<div class="sub-group-title">ä¸»é¡Œæ¢è¨</div>
<div class="node level-2"><a href="https://litstudy.vercel.app/" data-tool-id="study">æ–‡å­¸å°ˆé¡Œæ¢ç©¶</a></div>

<div class="sub-group-title">ç”Ÿæ´»è©©æ„</div>
<div class="node level-2"><a href="toolbox/wabisabi.html" data-tool-id="wabisabi">ä¸€ç¬ä¹‹è©©</a></div>
<div class="sub-group-title">æ›¸ç±æ¨è–¦</div>
<div class="node level-2"><a href="https://621d05f47d591.site123.me/%E6%9B%B8%E9%96%A3%E8%97%8F%E6%9B%B8%E6%A6%82%E8%A6%BD" data-tool-id="book-overview">æ›¸ç±æ¦‚è¦½</a></div>
	<div class="sub-group-title">æ­Œè©éŠæˆ²</div>
<div class="node level-2"><a href="https://lyricschi.vercel.app/" data-tool-id="lyrics">è©æµ·æ‹¾å¿ƒ</a></div>
</div>
</div>

<!-- 2. Writing -->
<div class="category" id="writing" data-connect-to="foundation-tizi">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-write"></use></svg>å¯«ä½œå‰µä½œ</div>
<div class="sub-group">
<div class="sub-group-title">AIç¯„æ–‡</div>
<div class="node level-2"><a href="toolbox/article.html" data-tool-id="fanshui-narrative">ç¿»æ°´ (æ•˜äº‹)</a></div>
<div class="node level-2"><a href="toolbox/essay.html" data-tool-id="fanshui-argument">ç¿»æ°´ (è­°è«–)</a></div>
</div>
<div class="sub-group">
<div class="sub-group-title">è‰æ“¬</div>
<div class="node level-2"><a href="toolbox/manuscriptpaper.html" data-tool-id="manuscript">æ™ºèƒ½åŸç¨¿ç´™</a></div>
</div>
<div class="sub-group">
<div class="sub-group-title">æ½¤è‰²èˆ‡å»¶ä¼¸</div>
<div class="node level-2"><a href="toolbox/words.html" data-tool-id="words">å­—æ–Ÿãƒ»å¥é…Œ</a></div>
<div class="node level-2"><a href="toolbox/slideshow.html" data-tool-id="slideshow">æ–‡ç« å¹»ç‡ˆç‰‡</a></div>
</div>
</div>

<!-- 3. Reading -->
<div class="category" id="reading" data-connect-to="foundation-tizi">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-read"></use></svg>é–±è®€æº«ç¿’</div>
 <div class="sub-group">
        <div class="sub-group-title">èª²æ–‡æº«ç¿’</div>
        <!-- ä¿®æ”¹è™•ï¼šç§»é™¤ id="yuyilu-toggle"ï¼Œç›´æ¥æ”¾å…¥é€£çµï¼Œä¸¦ç§»é™¤ä¸‹æ–¹çš„ yuyilu-grades div -->
        <div class="node level-2">
            <a href="https://kenchan20141.github.io/f1chinese/" data-tool-id="yuyilu">èªå¼ˆéŒ„</a>
        </div>
        <div class="node level-2"><a href="toolbox/timer.html" data-tool-id="timer">èƒŒæ›¸ç¥å™¨</a></div>
    </div>

    <div class="sub-group">
        <div class="sub-group-title">æ–‡è¨€æ–‡</div>
        <div class="node level-2"><a href="toolbox/mensyu.html" data-tool-id="mensyu-2">æ–‡æ¨</a></div>
    </div>
</div>

<!-- 4. Assignments -->
<div class="category" id="assignments" data-connect-to="core-ai-node">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-work"></use></svg>å·¥å…·</div>
<div class="sub-group">
<div class="sub-group-title">èª²æ¥­æµç¨‹</div>
<div class="node level-2"><a href="https://script.google.com/a/macros/ccckyc.edu.hk/s/AKfycby1T18HxuFICIaR0LYWRuaqlpmglkL191bVl39MH69zj5CQ-uhozF17edtJ_T54NhZ5/exec" data-tool-id="zhiyun">å¸™é›²</a></div>
</div>
<div class="sub-group">
<div class="sub-group-title">å¯¦ç”¨å·¥å…·</div>
<div class="node level-2"><a href="toolbox/WCT.html" data-tool-id="zhuoyu">ç¢ç‰</a></div>
<div class="node level-2"><a href="toolbox/quizbuzzer.html" data-tool-id="quizbuzzer">æ¶ç­”å™¨</a></div>
	<div class="node level-2"><a href="toolbox/pulseqa.html" data-tool-id="pulseqa">è„ˆå•å ‚</a></div>
<div class="node level-2"><a href="https://www.i2ocr.com/free-online-chinese-traditional-ocr" data-tool-id="ocr">æ‰‹å¯«æ–‡å­—è½‰æ› (OCR)</a></div>
<div class="node level-2"><a href="toolbox/epub.html" data-tool-id="epub">é›»å­æ›¸é–±è®€å™¨</a></div>
	<div class="node level-2"><a href="toolbox/decibelmeter.html" data-tool-id="decibelmeter">åˆ†è²è¨ˆ</a></div>
	<div class="node level-2"><a href="https://penpalchi.vercel.app/" data-tool-id="friends">ä»¥æ–‡æœƒå‹</a></div>
</div>
</div>

<!-- 5. Support -->
<div class="category" id="support" data-connect-to="core-ai-node">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-support"></use></svg>å­¸ç¿’æ”¯æ´</div>
<div class="sub-group">
<div class="sub-group-title">AIèŠå¤©å®¤</div>
<div class="node level-2"><a href="toolbox/chitutor.html" data-tool-id="chitutor">å–»è›‹æ•™å®¤</a></div>
<div class="node level-2"><a href="toolbox/histutor.html" data-tool-id="histutor">å²èŠå§†æ•™å®¤</a></div>
<div class="node level-2"><a href="toolbox/counseling.html" data-tool-id="counseling">è§£æ†‚é›œè²¨åº—</a></div>
</div>
<div class="sub-group">
<div class="sub-group-title">è³‡æºåº«</div>
<div class="node level-2"><a href="https://621d05f47d591.site123.me/" data-tool-id="self-learning">è‡ªå­¸è³‡æº</a></div>
</div>
</div>
</main>
</div>
</div>

<!-- Preview Modal (ä¿®è¨‚å¾Œ) -->
<div id="previewModal" class="preview-modal-overlay">
<div class="preview-modal-content">
<div class="preview-modal-body">
<iframe id="previewIframe" src="" frameborder="0" credentialless></iframe>
<div class="preview-modal-footer">
<div id="previewDescription" class="preview-description"></div>
<a id="previewGoToPageBtn" href="" target="_blank" class="preview-goto-btn">å‰å¾€</a>
</div>
</div>
<button id="previewCloseBtn" class="preview-close-btn" title="é—œé–‰">&times;</button>
</div>
</div>


<!-- Video Modal (æ–°å¢) -->
<div id="videoModal" class="video-modal-overlay">
<div class="video-modal-content">
<iframe id="videoIframe" allow="fullscreen" allowfullscreen src="" width="100%" style="border:none;" credentialless></iframe>
</div>
</div>

<script>


// === ç›£è½æœªç¹³äº¤åŠŸèª²ä¸¦æ§åˆ¶ç´…é» (æ ¸å¿ƒé‚è¼¯) ===
let pendingMonitorRef = null; // ç”¨æ–¼å„²å­˜ç›£è½å™¨ï¼Œæ–¹ä¾¿ç™»å‡ºæ™‚ç§»é™¤

function monitorPendingAssignments() {
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    const badge = document.getElementById('notifBadge');
    
    // å¦‚æœæ²’æœ‰ç™»å…¥è³‡æ–™æˆ–æ‰¾ä¸åˆ°ç´…é»å…ƒç´ ï¼Œç›´æ¥é€€å‡º
    if (!s || !badge) return;

    // å¦‚æœä¹‹å‰æœ‰ç›£è½å™¨ï¼Œå…ˆç§»é™¤ï¼Œé¿å…é‡è¤‡ç–ŠåŠ 
    if (pendingMonitorRef) {
        pendingMonitorRef.off();
    }

    // è¨­å®šç›£è½è·¯å¾‘ï¼šè©²å¹´ç´šç­åˆ¥çš„æ‰€æœ‰åŠŸèª²
    pendingMonitorRef = database.ref(`assignments/${s.grade}/${s.class}`);

    pendingMonitorRef.on('value', async (snapshot) => {
        const assignments = snapshot.val();
        
        // å¦‚æœè€å¸«æ ¹æœ¬æ²’æ´¾ç™¼éåŠŸèª²ï¼Œéš±è—ç´…é»
        if (!assignments) {
            badge.style.display = 'none';
            return;
        }

        const assignmentKeys = Object.keys(assignments);
        let hasPending = false;

        // ä½¿ç”¨ Promise.all ä¸¦è¡Œæª¢æŸ¥æ¯ä¸€ä»½åŠŸèª²çš„ç¹³äº¤ç‹€æ…‹
        const checkPromises = assignmentKeys.map(async (key) => {
            // æª¢æŸ¥ assignments_submissions è·¯å¾‘ä¸‹æ˜¯å¦æœ‰è©²å­¸ç”Ÿçš„ç´€éŒ„
            const subSnap = await database.ref(`assignments_submissions/${key}/${s.name}`).once('value');
            
            // å¦‚æœ subSnap.exists() ç‚º falseï¼Œä»£è¡¨é‚„æ²’äº¤
            return subSnap.exists(); 
        });

        const results = await Promise.all(checkPromises);

        // æª¢æŸ¥çµæœï¼šåªè¦çµæœé™£åˆ—ä¸­æœ‰ä»»ä½•ä¸€å€‹ false (æœªäº¤)ï¼Œå°±æ¨™è¨˜ç‚ºæœ‰å¾…è¾¦
        if (results.includes(false)) {
            hasPending = true;
        }

        // æ›´æ–° UI
        if (hasPending) {
            badge.style.display = 'block';
            badge.title = "æ‚¨æœ‰æœªç¹³äº¤çš„èª²æ¥­ï¼"; // æ»‘é¼ æ‡¸åœæç¤º
        } else {
            badge.style.display = 'none';
        }
    });
}
	

// --- ã€å…¨æ–°ä¿®è¨‚ã€‘å„²å­˜é é¢ç‚º HTML çš„åŠŸèƒ½ (å·²æ•´åˆé›·é”åœ–è½‰æ›) ---
function savePageAsHTML(filename = 'ç¥æ€-å­˜æª”.html') {
    // 1. å»ºç«‹ç•¶å‰æ–‡æª”çš„æ·±åº¦è¤‡è£½å“ï¼Œæˆ‘å€‘å°‡åœ¨é€™å€‹è¤‡è£½å“ä¸Šæ“ä½œ
    const clonedDocElement = document.documentElement.cloneNode(true);

    // --- ã€æ ¸å¿ƒæ–°å¢é‚è¼¯ï¼šè™•ç†é›·é”åœ–ã€‘ ---
    // a. æ‰¾å‡ºç•¶å‰é é¢ä¸Šæ‰€æœ‰å¯è¦‹çš„é›·é”åœ–ç•«å¸ƒ (canvas)
    const visibleCanvases = document.querySelectorAll('.radar-chart-container canvas');
    
    visibleCanvases.forEach(originalCanvas => {
        // b. æª¢æŸ¥ç•«å¸ƒæ˜¯å¦çœŸçš„å¯è¦‹ï¼Œé¿å…è™•ç†éš±è—çš„åœ–è¡¨
        if (originalCanvas.offsetParent !== null) {
            try {
                // c. å°‡ç•«å¸ƒå…§å®¹è½‰æ›ç‚º Base64 æ ¼å¼çš„åœ–ç‰‡æ•¸æ“š (PNG)
                const imageDataUrl = originalCanvas.toDataURL('image/png');
                
                // d. åœ¨ "è¤‡è£½å“" ä¸­æ‰¾åˆ°å°æ‡‰çš„ç•«å¸ƒ
                const clonedCanvas = clonedDocElement.querySelector(`#${originalCanvas.id}`);
                
                if (clonedCanvas) {
                    // e. å»ºç«‹ä¸€å€‹æ–°çš„ <img> å…ƒç´ 
                    const img = document.createElement('img');
                    img.src = imageDataUrl; // å°‡åœ–ç‰‡æ•¸æ“šè¨­ç½®ç‚ºä¾†æº
                    img.style.width = '100%'; // ä¿æŒèˆ‡åŸç•«å¸ƒå®¹å™¨å¯¬åº¦ä¸€è‡´
                    img.style.height = 'auto'; // é«˜åº¦è‡ªå‹•èª¿æ•´
                    
                    // f. åœ¨è¤‡è£½å“ä¸­ï¼Œç”¨é€™å¼µéœæ…‹åœ–ç‰‡ <img> å–ä»£åŸæœ¬çš„ <canvas>
                    clonedCanvas.parentNode.replaceChild(img, clonedCanvas);
                }
            } catch (e) {
                console.error('è½‰æ›é›·é”åœ–ç‚ºåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
            }
        }
    });
    // --- ã€é›·é”åœ–è™•ç†é‚è¼¯çµæŸã€‘ ---

    // 2. åœ¨è¤‡è£½å“ä¸ŠåŒæ­¥æ‰€æœ‰è¡¨å–®å…ƒç´ çš„ç•¶å‰ç‹€æ…‹ (æ­¤éƒ¨åˆ†é‚è¼¯ä¸è®Š)
    const originalTextareas = document.getElementsByTagName('textarea');
    const clonedTextareas = clonedDocElement.getElementsByTagName('textarea');
    for (let i = 0; i < originalTextareas.length; i++) {
        clonedTextareas[i].textContent = originalTextareas[i].value;
    }

    const originalInputs = document.querySelectorAll('input');
    const clonedInputs = clonedDocElement.querySelectorAll('input');
    for (let i = 0; i < originalInputs.length; i++) {
        clonedInputs[i].setAttribute('value', originalInputs[i].value);
        if (originalInputs[i].type === 'radio' || originalInputs[i].type === 'checkbox') {
             if (originalInputs[i].checked) {
                clonedInputs[i].setAttribute('checked', 'checked');
            } else {
                clonedInputs[i].removeAttribute('checked');
            }
        }
    }

    const originalSelects = document.getElementsByTagName('select');
    const clonedSelects = clonedDocElement.getElementsByTagName('select');
    for (let i = 0; i < originalSelects.length; i++) {
        const selectedIndex = originalSelects[i].selectedIndex;
        if (selectedIndex > -1) {
            Array.from(clonedSelects[i].options).forEach(opt => opt.removeAttribute('selected'));
            clonedSelects[i].options[selectedIndex].setAttribute('selected', 'selected');
        }
    }

    // 3. åœ¨è¤‡è£½å“ä¸­ç§»é™¤æ‰€æœ‰ã€Œå„²å­˜HTMLã€æŒ‰éˆ•åŠå…¶ä»–ä¸éœ€ä¿å­˜çš„äº’å‹•æŒ‰éˆ•
    const clonedSaveButtons = clonedDocElement.querySelectorAll('.btn-save-html');
    clonedSaveButtons.forEach(btn => btn.remove());
    
    const clonedShowPlayerBtn = clonedDocElement.querySelector('#show-player');
    if (clonedShowPlayerBtn) clonedShowPlayerBtn.remove();
    
    const clonedExpandToolsBtn2 = clonedDocElement.querySelector('#expandToolsBtn2');
    if (clonedExpandToolsBtn2) clonedExpandToolsBtn2.remove();


    // 4. ç”Ÿæˆå®Œæ•´çš„ HTML å­—ä¸²
    const finalHtml = '<!DOCTYPE html>\n' + clonedDocElement.outerHTML;

    // 5. å‰µå»º Blob ä¸¦è§¸ç™¼ä¸‹è¼‰
    const blob = new Blob([finalHtml], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// --- ã€æ–°å¢ã€‘éš±è—æ‰€æœ‰ã€Œå„²å­˜HTMLã€æŒ‰éˆ•çš„å°ˆç”¨å‡½å¼ ---
function hideAllSaveHtmlButtons() {
    const saveButtons = document.querySelectorAll('.btn-save-html');
    saveButtons.forEach(button => {
        button.style.display = 'none';
    });
}

// ã€å®‰å…¨ä¿®è¨‚ã€‘é˜²æ­¢ XSS æ”»æ“Šçš„æ ¸å¿ƒå‡½å¼
function sanitizeHTML(str) {
// è‹¥å‚³å…¥çš„ä¸æ˜¯å­—ä¸²ï¼Œç›´æ¥è¿”å›åŸå€¼
if (typeof str !== 'string') return str;
// å°‡ç‰¹æ®Šå­—å…ƒè½‰æ›ç‚º HTML å¯¦é«”
return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

// ã€æ ¸å¿ƒä¿®è¨‚ã€‘å»ºç«‹ä¸€å€‹æ¸…é™¤æ‰€æœ‰é¡Œç›®ç‹€æ…‹çš„å°ˆç”¨å‡½å¼
function clearAllTopicStates() {
// 1. æ¸…é™¤æ‰€æœ‰é¡Œç›®é¡¯ç¤ºå€å¡Šçš„å…§å®¹ä¸¦éš±è—å®ƒå€‘
document.getElementById('topicResult').innerHTML = '';
document.getElementById('topicResult').style.display = 'none';
document.getElementById('argumentTopicResult').innerHTML = '';
document.getElementById('argumentTopicResult').style.display = 'none';
document.getElementById('expandTopicResult').innerHTML = '';
document.getElementById('expandTopicResult').style.display = 'none';

// 2. æ¸…é™¤æ‰€æœ‰å„²å­˜åœ¨ localStorage çš„é¡Œç›®ç›¸é—œè³‡æ–™
// ã€Œæ•˜äº‹æŠ’æƒ…ã€ç›¸é—œ
localStorage.removeItem("currentTopic");
localStorage.removeItem("currentFocus");
localStorage.removeItem("currentPlot");
localStorage.removeItem("lastTopic");

// ã€Œè­°è«–ã€ç›¸é—œ
localStorage.removeItem("argumentCurrentTopic");
localStorage.removeItem("lastArgumentTopic");

// ã€Œæ•´åˆæ‹“å±•ã€ç›¸é—œ
localStorage.removeItem("expandCurrentTitle");
localStorage.removeItem("expandCurrentTheme");
localStorage.removeItem("expandCurrentData");

// 3. æ¸…é™¤è‡ªè¨‚é¡Œç›®çš„è¼¸å…¥å€
const customTopicArea = document.getElementById("customTopicArea");
if (customTopicArea) {
customTopicArea.innerHTML = '';
customTopicArea.style.display = 'none';
}
const argumentCustomTopicArea = document.getElementById("argumentCustomTopicArea");
if (argumentCustomTopicArea) {
argumentCustomTopicArea.innerHTML = '';
argumentCustomTopicArea.style.display = 'none';
}
}



/**
* æ›´æ–°æŒ‰éˆ•çš„ í™œì„±í™” (active) ç‹€æ…‹ã€‚
* @param {HTMLElement} clickedButton - è¢«é»æ“Šçš„æŒ‰éˆ•å…ƒç´ ã€‚
*/
function updateButtonActiveState(clickedButton) {
// æ‰¾åˆ°æŒ‰éˆ•æ‰€åœ¨çš„å®¹å™¨
const container = clickedButton.closest('.topic-buttons-container');
if (!container) return;

// ç²å–å®¹å™¨å…§çš„æ‰€æœ‰æŒ‰éˆ•
const buttons = container.querySelectorAll('.btn');

// é¦–å…ˆï¼Œç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ 'active' class
buttons.forEach(button => {
button.classList.remove('active');
});

// ç„¶å¾Œï¼Œåªç‚ºè¢«é»æ“Šçš„æŒ‰éˆ•æ·»åŠ  'active' class
clickedButton.classList.add('active');
}


// â˜… è¨­å®š Worker å¾Œç«¯ç¶²å€ â˜…
const CLOUDFLARE_WORKER_URL = "https://script.google.com/macros/s/AKfycbw3GLUM12ls3PhST5TkimLZvZwQx2H4RG8g2SbZiMJmuxg3HqsO_d13kPU4AnKpxi2P6A/exec";
 
// ä»¥ä¸‹ç¶­æŒä¸è®Šï¼Œå®ƒå€‘éƒ½æœƒè‡ªå‹•ä½¿ç”¨ä¸Šé¢é€™æ¢æ–°è·¯å¾‘
const API_URL = CLOUDFLARE_WORKER_URL;         
const READING_API_URL = CLOUDFLARE_WORKER_URL;
const LLAMA3_API_URL = CLOUDFLARE_WORKER_URL;  
 
// æ¨¡å‹è¨­å®šä¿æŒä¸è®Š
const MODEL = "gemini";
const READING_MODEL = "deepseek";
const LLAMA3_MODEL = "gemini";


// =======================================================
// === [æ–°å¢] ç•«å¸ƒèŠå¤©å®¤æ ¸å¿ƒé‚è¼¯ ===
// =======================================================

let canvasChatHistory = []; 
let currentContextType = ""; 
let currentContextContent = ""; 
let currentContextReview = ""; 

// =======================================================
// === [ä¿®è¨‚ç‰ˆ] ç•«å¸ƒèŠå¤©å®¤ HTML ç”Ÿæˆ (ç§»é™¤ IDï¼Œæ”¹ç”¨ç›¸å°å®šä½) ===
// =======================================================
function getCanvasChatHTML(type) {
    currentContextType = type;
    canvasChatHistory = [];
    
    // ä¿®æ”¹é‡é»ï¼š
    // 1. ç§»é™¤äº† textarea çš„ id="canvasChatInput"
    // 2. ç§»é™¤äº† button çš„ id="canvasChatSendBtn"
    // 3. onclick åŠ å…¥ 'this' åƒæ•¸ï¼Œç²¾ç¢ºå‚³éé»æ“Šçš„æŒ‰éˆ•
    return `
    <div class="canvas-chat-container">
        <div class="canvas-chat-header">
            <i class="fas fa-comments"></i> é–±å·å“¡è¿½å•å€
        </div>
        <div class="canvas-chat-history">
            <div class="message-bubble ai-message">ä½ å¥½ï¼å°æ–¼å‰›æ‰çš„é»è©•æˆ–æ”¹å¯«ï¼Œæœ‰ç”šéº¼æƒ³é€²ä¸€æ­¥äº†è§£çš„å—ï¼Ÿæ­¡è¿è¿½å•ï¼ğŸ¤Œ</div>
        </div>
        <div class="canvas-input-area">
            <textarea class="no-modal-editor" placeholder="åœ¨æ­¤è¼¸å…¥ä½ çš„å•é¡Œ... "></textarea>
            <button class="canvas-send-btn" onclick="sendCanvasMessage(this)" title="ç™¼é€">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>`;
}
 
// ==========================================
// === [ä¿®è¨‚ç‰ˆ] ç•«å¸ƒèŠå¤©å®¤ç™¼é€é‚è¼¯ (ç›¸å°å®šä½æŸ¥æ‰¾) ===
// ==========================================
// ==========================================
// === [ä¿®è¨‚ç‰ˆ] ç•«å¸ƒèŠå¤©å®¤ç™¼é€é‚è¼¯ (ç¹é«”åŒ– + å¼•è™Ÿä¿®æ­£) ===
// ==========================================
async function sendCanvasMessage(btnElement) {
    // 1. é–å®šè§¸ç™¼æŒ‰éˆ•ï¼šå„ªå…ˆä½¿ç”¨å‚³å…¥çš„ this (btnElement)
    let sendBtn = btnElement;
    
    // å¦‚æœæ²’æœ‰å‚³å…¥åƒæ•¸ (èˆŠç‰ˆ HTML ç›¸å®¹)ï¼Œå˜—è©¦å¾ window.event ç²å–
    if (!sendBtn && window.event) {
        sendBtn = window.event.target.closest('button');
    }
    
    // å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œå˜—è©¦å°‹æ‰¾é é¢ä¸Šã€Œå¯è¦‹ã€çš„ç™¼é€æŒ‰éˆ• (æœ€å¾Œé˜²ç·š)
    if (!sendBtn) {
        const visibleBtn = Array.from(document.querySelectorAll('.canvas-send-btn')).find(btn => btn.offsetParent !== null);
        if (visibleBtn) sendBtn = visibleBtn;
    }
 
    if (!sendBtn) {
        console.error("æ‰¾ä¸åˆ°ç™¼é€æŒ‰éˆ•");
        return;
    }
    // 2. åŸºæ–¼æŒ‰éˆ•ä½ç½®ï¼Œå¾€ä¸Šå°‹æ‰¾æœ€è¿‘çš„å®¹å™¨ (Context)
    const container = sendBtn.closest('.canvas-chat-container');
    if (!container) return;
    // 3. åœ¨è©²å®¹å™¨å…§å°‹æ‰¾è¼¸å…¥æ¡†èˆ‡æ­·å²å€ (ä½¿ç”¨ Class é¸æ“‡å™¨ï¼Œè€Œé ID)
    const inputEl = container.querySelector('textarea');
    const historyBox = container.querySelector('.canvas-chat-history');
    
    if (!inputEl || !historyBox) return;
    const userText = sanitizeHTML(inputEl.value.trim());
    if (!userText) {
        // æç¤ºç”¨æˆ¶è¼¸å…¥
        inputEl.style.borderColor = "#d69a92";
        setTimeout(() => inputEl.style.borderColor = "#ccc", 500);
        return;
    }
    // --- ä»¥ä¸‹ç‚ºç™¼é€é‚è¼¯ ---
 
    // 1. é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
    const userBubble = document.createElement("div");
    userBubble.className = "message-bubble user-message";
    userBubble.innerHTML = userText.replace(/\n/g, '<br>');
    historyBox.appendChild(userBubble);
    
    inputEl.value = "";
    sendBtn.disabled = true; // æš«æ™‚ç¦ç”¨æŒ‰éˆ•
    historyBox.scrollTop = historyBox.scrollHeight;
    // 2. é¡¯ç¤º AI æ€è€ƒä¸­
    const aiBubble = document.createElement("div");
    aiBubble.className = "message-bubble ai-message";
    aiBubble.innerHTML = `<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ€è€ƒ...`;
    historyBox.appendChild(aiBubble);
    historyBox.scrollTop = historyBox.scrollHeight;
    // 3. æŠ“å–ä¹‹å‰çš„å°è©±ç´€éŒ„ (ä½œç‚º Context)
    const bubbles = Array.from(historyBox.querySelectorAll('.message-bubble'));
    let historyText = "";
    // å–æœ€è¿‘ 5 å‰‡å°è©±ï¼Œé¿å… Token éé•·
    bubbles.slice(-6, -1).forEach(b => {
        const role = b.classList.contains('ai-message') ? "é™³SIR" : "å­¸ç”Ÿ";
        historyText += `${role}: ${b.innerText}\n`;
    });
    
    // --- å…¨æ–¹ä½åµæ¸¬èªæ°£èˆ‡é–±å·å“¡ ---
    let toneNote = "è«‹ç”¨æ—¥å¸¸ã€è¦ªåˆ‡çš„èªæ°£å›æ‡‰ï¼Œå¤šç”¨ä¾‹å­èªªæ˜ã€‚";
    let activeReviewer = "ä¸­æ–‡è€å¸«";
    let currentToneVal = "serious";
 
    // å˜—è©¦å¾æ‰€æœ‰å¯èƒ½çš„ ID ä¸­æŠ“å–ç›®å‰ã€Œå¯è¦‹ã€çš„èªæ°£è¨­å®š
    const possibleToneIds = [
        "writingTone", "argumentWritingTone", "argumentOutlineTone",
        "readingTone", "expandTone", "booksTone"
    ];
 
    for (const id of possibleToneIds) {
        const el = document.getElementById(id);
        if (el && el.offsetParent !== null) {
            currentToneVal = el.value;
            break;
        }
    }
 
    // å˜—è©¦æ‰¾å‡ºç›®å‰ã€Œå¯è¦‹ã€çš„é–±å·å“¡
    const possibleReviewerIds = ["writingReviewer", "argumentReviewer"];
    for (const id of possibleReviewerIds) {
        const el = document.getElementById(id);
        if (el && el.offsetParent !== null) {
            activeReviewer = el.options[el.selectedIndex].text.replace(/\s*\(é è¨­\)\s*/, '');
            break;
        }
    }
 
    // æ ¹æ“šæƒ…å¢ƒè¨­å®š Prompt
    if (typeof currentContextType !== 'undefined' && currentContextType === 'featured_discussion') {
        toneNote = "ä½ ç¾åœ¨æ˜¯é™³SIRã€‚è«‹ç”¨æ›¸é¢èªå›æ‡‰ï¼Œè¼•é¬†åˆè¦‹èªçœŸï¼Œç”¨èªé©åˆé«˜ä¸­ç”Ÿï¼Œ**å¿…é ˆä½¿ç”¨å¤§é‡Emoji** ğŸ¤Œâœ¨ã€‚";
        activeReviewer = "é™³SIR";
    } else {
        if (currentToneVal === "chen") {
            toneNote = "ä½ ç¾åœ¨æ˜¯é™³SIRã€‚è«‹ç”¨å¹½é»˜è©¼è«§ã€é©æ™‚æ¶æ„çš„èªæ°£å›æ‡‰ï¼Œ**å¿…é ˆä½¿ç”¨å¤§é‡Emoji** ğŸ¤ªâœ¨ï¼Œè¡¨ç¤ºæ¶æ„æ™‚æœƒç”¨ğŸ¤Œé€™å€‹EMOJIã€‚";
            activeReviewer = "é™³SIR";
        } else if (currentToneVal === "casual") {
            toneNote = "è«‹ç”¨è¼•é¬†æ´»æ½‘çš„èªæ°£å›æ‡‰ã€‚";
        }
    }
    // 4. æ§‹å»º Prompt
    let promptContext = "";
    // å˜—è©¦è®€å–å…¨åŸŸè®Šæ•¸ä¸­çš„ä¸Šä¸‹æ–‡ï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­å€¼
    let readableContent = (typeof currentContextContent !== 'undefined' ? currentContextContent : "") || "å­¸ç”Ÿæäº¤çš„ä½œæ¥­";
    if (typeof readableContent === 'object') {
        try { readableContent = JSON.stringify(readableContent); } catch(e){}
    }
 
    if (typeof currentContextType !== 'undefined' && currentContextType === 'featured_discussion') {
        promptContext = readableContent;
    } else {
        // é™åˆ¶é•·åº¦ä»¥é˜² Token çˆ†æ‰
        promptContext = `ã€èƒŒæ™¯è³‡æ–™ã€‘\n${readableContent.substring(0, 1500)}\n\nã€ä¹‹å‰çš„é»è©•ã€‘\n${(typeof currentContextReview !== 'undefined' ? currentContextReview : "").substring(0, 800)}...`;
    }
    
    // â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šåŠ å…¥ã€è² é¢ç´„æŸã€‘æŒ‡ä»¤ â˜…â˜…â˜…
    const fullPrompt = `ä½ æ˜¯ä¸€ä½${activeReviewer}ã€‚${promptContext}
ã€å°è©±ç´€éŒ„ã€‘
${historyText}
ã€å­¸ç”Ÿæœ€æ–°å•é¡Œã€‘
${userText}

ã€å›æ‡‰è¦æ±‚ã€‘
1. é‡å°å•é¡Œå…·é«”èˆ‰ä¾‹èªªæ˜ã€‚
2. èªæ°£è¦æ±‚ï¼š${toneNote}ï¼Œä¸è¦éä»½æ‹˜è¬¹ï¼Œè¦è¼•é¬†å¹½é»˜ã€‚
3. å­—æ•¸200å­—å…§ã€‚
4. ã€é‡è¦ã€‘è«‹å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡(Traditional Chinese)å›ç­”ï¼Œä¸¦ä½¿ç”¨é¦™æ¸¯ç”¨èªã€‚
5. ã€é‡è¦ã€‘**åš´ç¦**åœ¨å›æ‡‰ä¸­åŒ…å«ä»»ä½•æ‹¬è™Ÿè¨»é‡‹ï¼ˆä¾‹å¦‚ï¼šã€Œï¼ˆèªæ°£è¦ªåˆ‡ï¼‰ã€ã€ã€Œï¼ˆå­—æ•¸ï¼š150å­—ï¼‰ã€ç­‰ï¼‰ï¼Œè«‹ç›´æ¥ä»¥å°è©±å½¢å¼å›æ‡‰å­¸ç”Ÿï¼Œä¸è¦è¼¸å‡ºå¤šé¤˜çš„ç³»çµ±è³‡è¨Šã€‚`;
    
    try {
        // çµ±ä¸€ä½¿ç”¨ Reading API (DeepSeek)
        let response = await callReadingAPI(fullPrompt);

        // â˜…â˜…â˜… å¼·åˆ¶ç¹é«”åŒ– (OpenCC) â˜…â˜…â˜…
        if (typeof OpenCC !== 'undefined') {
            const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
            response = converter(response);
        }

        // â˜…â˜…â˜… å¼·åˆ¶æ›¿æ›å¼•è™Ÿ (å°‡ "" æˆ– â€œâ€ è½‰ç‚º ã€Œã€) â˜…â˜…â˜…
        response = response.replace(/["â€œ](.*?)["â€]/g, 'ã€Œ$1ã€');
        
        let formattedResponse = response.replace(/\n/g, '<br>');
        formattedResponse = formattedResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // æ›´æ–° UI
        aiBubble.innerHTML = formattedResponse;
        
        // åªæœ‰éç²¾é¸æ–‡ç« è¨è«–æ‰å„²å­˜åˆ°æ­·å²ç´€éŒ„
        if (typeof currentContextType === 'undefined' || currentContextType !== 'featured_discussion') {
            setTimeout(async () => {
                if (typeof updateHistoryChat === 'function') {
                    await updateHistoryChat();
                }
            }, 100);
        }
    } catch (error) {
        aiBubble.innerHTML = "æŠ±æ­‰ï¼Œé€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚";
        console.error(error);
    } finally {
        sendBtn.disabled = false; // è§£é–æŒ‰éˆ•
        historyBox.scrollTop = historyBox.scrollHeight;
    }
}
	



// æ³¨æ„ï¼šæ‰“é–‹æ’­æ”¾å™¨çš„åŠŸèƒ½ç¾åœ¨å®Œå…¨ç”±å´é‚Šé¸å–®çš„ toggleMusicPlayer() è² è²¬

// é è¨­å¯«ä½œé¡Œç›®åˆ—è¡¨
const topics = [
"æ—è§€", "èˆå°", "é€™ä»¶ç‰©ä»¶å¾ˆæ˜¯è¼•å·§ï¼Œå»è®“æˆ‘æ˜ç™½ã€ä½†æ±‚ç„¡æ„§æ–¼å¿ƒã€çš„é“ç†ã€‚", "å±±é ‚", "ç¨®å­", "æ ¹", "ç–¤ç—•",
"ä»Šå¤©ï¼Œæˆ‘ä¸èƒ½åƒè³½ï¼Œåªèƒ½ååœ¨è§€çœ¾å¸­ä¸Šï¼Œä½†ç•¶æ™‚çš„æ‰€è¦‹æ‰€èå»çµ¦äºˆæˆ‘å¶„æ–°çš„é«”æœƒã€‚", "å¾ä»Šä»¥å¾Œï¼Œæˆ‘ä¸æœƒå†è¼•è¨€æ”¾æ£„ã€‚",
"ç­‰å€™", "æˆ‘æ›¾ç¶“åŠªåŠ›å˜—è©¦ï¼Œä½†æœ€çµ‚ä»æ˜¯äº‹èˆ‡é¡˜é•", "å›æ†¶", "å¾¹å¤œé›£çœ ", "å½©è™¹",
"æ˜Ÿç©ºä¸‹ï¼Œçœ¼å‰çš„æ™¯è±¡è®“æˆ‘æƒ³èµ·é‚£æ®µå¾€äº‹ï¼Œä»¤æˆ‘ä¸ç¦æ­äº†ä¸€å£æ°£â€¦â€¦", "è·¯ç‰Œ", "ä»Šå­¸å¹´æœ€å¾Œæ‚”çš„ä¸€ä»¶äº‹",
"æœ€ä»¤æˆ‘æ„Ÿå‹•çš„ä¸€å¥è©±", "å†è©¦ä¸€æ¬¡", "ä»Šå¤©å†æ¬¡åœ¨å°ä¸Šæ¼”å¥ï¼Œæˆ‘å·²ç¶“è„«èƒæ›éª¨ï¼Œä¸å†æ˜¯å¾å‰é‚£å€‹é©•å‚²è‡ªæ»¿çš„æˆ‘äº†ã€‚",
"æ¯æ¬¡ç¶“éé€™æ¢è¡—ï¼Œçœ‹ç€è¡—ä¸Šçš„æ™¯ç‰©ï¼Œæˆ‘ä¾¿æ„Ÿè§¸ä¸å·²â€¦â€¦", "æ„å¤–", "é‘°åŒ™", "éŒ¯éäº†çš„æ©Ÿæœƒ",
"é‚£å¥è©±ï¼Œæˆ‘å¯¦åœ¨ä¸è©²èªªâ€¦â€¦", "è‰²å½©", "ç…™ç«", "è—¥", "æ”¾ä¸‹", "è¿½é€", "åŸä¾†ï¼Œé€™åªæ˜¯ä¸€å ´èª¤æœƒ",
"ç¼ºæ†¾", "ç„¡æ‚”çš„æŠ‰æ“‡", "å‹‡æ°£", "å‚˜", "è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘æ˜ç™½åˆ°åŸä¾†çˆ¶æ¯çš„æ„›ç¸½æ˜¯é«”ç¾åœ¨å°äº‹ä¸Šã€‚",
"ä¸€ä»¶ä»¤æˆ‘å¾Œæ‚”ä¸å·²çš„äº‹", "ä¸€æ¬¡å°·å°¬çš„ç¶“æ­·", "æ²¿é€”æœ‰ä½ ", "é€™ä¸€æ¬¡ï¼Œæˆ‘å¯¦åœ¨æ„Ÿåˆ°ç„¡åœ°è‡ªå®¹ã€‚",
"é€™ä¸€æ¬¡ï¼Œæˆ‘æ˜ç™½åˆ°ï¼ŒåŸä¾†å¹«åŠ©ä»–äººçš„åŒæ™‚ï¼Œä¹Ÿå¹«åŠ©äº†è‡ªå·±ã€‚",
"æˆ‘çš„é„°å±…å¼µå…ˆç”Ÿæ˜¯ä¸€ä½å¾ˆè‹›åˆ»çš„äººï¼Œç¶“å¸¸æœƒç‚ºäº›ã€å°äº‹ã€è€ŒæŠ•è¨´ä»–äººã€‚ä½†ä»Šå¤©æˆ‘ç™¼ç¾ï¼Œä»–é€™æ¨£åšæ˜¯æœ‰åŸå› çš„â€¦â€¦",
"ç¨è™•çš„ä¸€å¤©", "é€™ä¸€åˆ»ï¼Œæˆ‘çµ‚æ–¼èˆ’äº†ä¸€å£æ°£ã€‚", "è¨˜ä¸€æ¬¡è¢«èª¤è§£çš„ç¶“æ­·", "ä¸€æ¬¡èˆ‡åˆ¥äººè¨€æ­¸äºå¥½çš„ç¶“æ­·",
"è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘æ„Ÿåˆ°è‡ªå·±çœŸçš„é•·å¤§äº†ã€‚", "è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘æ˜ç™½åˆ°å¹¸ç¦åŸä¾†å¯ä»¥å¾ˆç°¡å–®ã€‚", "è¨˜ä¸€æ¬¡è‹¦ç›¡ç”˜ä¾†çš„ç¶“æ­·ã€‚",
"é€™ä»¶äº‹è®“æˆ‘é«”æœƒåˆ°å–œå‡ºæœ›å¤–çš„æ»‹å‘³ã€‚", "è·¯æ¨™", "è¶³å°", "éºæ†¾", "é–", "é¢å…·", "å¿ƒçµ", "é–€",
"å½±å­", "ç¦å€", "ç­‰å¾…", "æ ¹", "æœ€å¾Œï¼Œæˆ‘é¸æ“‡äº†æ”¾æ£„", "è‡ªé‚£ä¸€åˆ»ï¼Œæˆ‘è§£é–‹äº†å¿ƒçµ",
"è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘æ˜ç™½çŒ¶è±«æœƒä½¿äººä¸€äº‹ç„¡æˆã€‚", "åŸä¾†æˆ‘æ²’æœ‰å¿˜è¨˜é‚£ä¸€é “é£¯ã€‚", "æˆ‘åœ¨å¤§è‡ªç„¶ä¹‹ä¸­æ‰¾åˆ°å¿«æ¨‚ã€‚",
"ç†±é¬§éå¾Œï¼Œæˆ‘å»æ„Ÿåˆ°å¤±è½ã€‚", "çœ‹è‘—é€æ¼¸é å»çš„èƒŒå½±ï¼Œæˆ‘æ„Ÿåˆ°å¾ˆå…§ç–šã€‚", "ä»Šå¤©æˆ‘æµæ·šäº†ï¼Œä½†æˆ‘ä¸¦éæ„Ÿåˆ°é›£éã€‚",
"è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘æ‰¾åˆ°äº†å‹•åŠ›", "ç¶“æ­·äº†é€™æ¬¡é¢¨æ³¢ï¼Œæˆ‘é•·å¤§äº†ã€‚",
"ç¶“éé€™ä»¶äº‹ï¼Œæˆ‘æ‰æ˜ç™½åˆ°ä¸€å¿ƒæ˜¯æˆ‘çš„çŸ¥å·±ï¼Œæ˜¯çœŸæ­£äº†è§£æˆ‘çš„äººã€‚", "è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘å­¸æœƒæ”¾ä¸‹ç„¡è¬‚çš„é¢å­ã€‚",
"é€™ä¸€æ¬¡ï¼Œæˆ‘å†æ²’æœ‰éºæ†¾", "é‡éŠèˆŠåœ°æ‰€è¦‹æœ‰æ„Ÿ", "å¤±è€Œå¾©å¾—", "é€™æ¢è¡—é›–ç„¶è€èˆŠï¼Œä½†å»å……æ»¿äººæƒ…å‘³ã€‚",
"é€™å¥è©±ï¼Œæˆ‘æœƒè¨˜ä¸Šä¸€è¼©å­ã€‚", "é–€", "ä¾†æ—¥æ–¹é•·", "å¾—ä¸å„Ÿå¤±", "éš±è—", "å¾®ç¬‘ä»¥å°",
"ç†±é¬§éå¾Œï¼Œæˆ‘å»æ„Ÿåˆ°å¤±è½ã€‚", "å¤¢æƒ³çœ‹ä¼¼ä¸åˆ‡å¯¦éš›ï¼Œä½†å…¶å¯¦å¾ˆæœ‰æ„ç¾©", "å¤¢æƒ³çœ‹ä¼¼å¾ˆæœ‰æ„ç¾©ï¼Œå…¶å¯¦ä¸åˆ‡å¯¦éš›",
"ä»Šå¤©æˆ‘æ²’æœ‰å¸¶æ‰‹æé›»è©±å¤–å‡ºï¼Œå› è€Œæœ‰ä¸ä¸€æ¨£çš„ç¶“æ­·å’Œé«”æœƒã€‚",
"ä»Šå¤©ç™¼ç”Ÿäº†ä¸€ä»¶äº‹æƒ…ï¼Œç•¶æ™‚æˆ‘æ›¾ç¶“æƒ³åŠ›é™³å·±è¦‹ï¼Œæœ€å¾Œé¸æ“‡äº†æ²‰é»˜ã€‚æˆ‘èªç‚ºæ²‰é»˜æ˜¯å¿…è¦çš„ã€‚",
"çŸ›ç›¾", "æœªå…Œç¾çš„è«¾è¨€", "æœªå¯„å‡ºçš„ä¿¡", "è·é›¢", "ä¸€å ´æ²’æœ‰å¤±æ•—è€…çš„æ¯”è³½", "ä¸€ä»¶ç™¼äººæ·±çœçš„äº‹",
"æˆ‘æœ€æƒ³ä¿ç•™çš„ä¸€æœ¬ç›¸ç°¿", "æˆ‘æœ€æƒ³å°‹å›çš„ä¸€ä»¶ç©å…·", "ç„¡æ„§çš„æŠ‰æ“‡", "ä¸èƒ½æ‰ä¸‹çš„çœ¼æ·š", "ç„¡ç•çš„æ¢ç´¢",
"ä¸€æ¬¡ä»¤æˆ‘ç™¾æ„Ÿäº¤é›†çš„èšé¤", "å¦‚é¡˜ä»¥å„Ÿ"
];

// é è¨­è­°è«–é¡Œç›®åˆ—è¡¨ï¼ˆè«‹åœ¨æ­¤è™•è¼¸å…¥æ‚¨çš„é¡Œåº«ï¼‰
const argumentTopics = [
'æ‰€è¬‚ã€Œå¤©è¡Œæœ‰å¸¸ï¼Œç«‹èº«æœ‰æœ¬ã€‚ã€æ„æ€æ˜¯å¤§è‡ªç„¶é‹è¡Œæœ‰æ—¢å®šçš„è¦å¾‹ï¼Œäººç«‹èº«è™•ä¸–æœ‰ä¸€å®šçš„åŸå‰‡ã€‚è©¦è«‡è«‡ä½ å°ã€Œç«‹èº«æœ‰æœ¬ã€çš„çœ‹æ³•ã€‚',
'æ—è§€',
'æœ‰äººèªç‚ºã€Œäººç”Ÿåœ¨ä¸–ï¼Œå¿…é ˆè¬›ç©¶å„€å¼ã€‚ã€ä½ åŒæ„å—ï¼Ÿè©¦æ’°æ–‡ä¸€ç¯‡ï¼Œè«–è¿°ä½ çš„çœ‹æ³•ã€‚',
'èˆå°',
'æ ¹',
'å¤äººèªªï¼šã€Œå›å­ä¸ä»¥äººå»¢è¨€ã€‚ã€æ„æ€æ˜¯ï¼šå›å­ä¸æœƒå› ç‚ºæŸäººçš„å¾·è¡Œä¸å¥½è€Œä¸æ¡ç´ä»–çš„å–„æ„è¦å‹¸ã€‚åœ¨ç¾ä»Šç¤¾æœƒï¼Œä½ æ˜¯å¦åŒæ„ã€Œå›å­ä¸ä»¥äººå»¢è¨€ã€ï¼Ÿè©¦è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'è¨ˆç®—',
'æœ‰äººèªªï¼šã€Œåœ¨ç¾ä»Šç¤¾æœƒä¸­ï¼Œæˆ‘å€‘é›£ä»¥æ´»å‡ºçœŸæˆ‘ã€‚ã€ä½ åŒæ„å—ã€‚è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'ä¿—èªèªªã€Œæœ‰ç«¶çˆ­æ‰æœ‰é€²æ­¥ã€ï¼Œä¹Ÿæœ‰äººèªªã€Œç«¶çˆ­ç„¡ç”¨ã€ã€‚è©¦å¯«ä½œæ–‡ç« ä¸€ç¯‡ï¼Œè«‡è«‡ä½ å°ã€Œç«¶çˆ­ç„¡ç”¨ã€çš„çœ‹æ³•ã€‚',
'å±±é ‚',
'ã€Œç¨®å­ã€é›–æ˜¯å¹³å¸¸äº‹ç‰©ï¼Œå»å¯ä»¥å¼•èµ·è¯æƒ³ï¼Œæˆ–ç‰½å‹•æ€ç·’ï¼Œåˆæˆ–å•Ÿç™¼æ€è€ƒã€‚è©¦ä»¥ã€Œç¨®å­ã€ç‚ºé¡Œï¼Œå°±å€‹äººé«”æœƒå¯«ä½œæ–‡ç« ä¸€ç¯‡ã€‚',
'æœ‰äººèªç‚ºã€ŒæŒ«æ•—æ›´æœ‰åˆ©å­©å­æˆé•·ã€‚ã€ä½ åŒæ„å—ï¼Ÿè©¦æ’°æ–‡ä¸€ç¯‡ï¼Œè«–è¿°ä½ çš„çœ‹æ³•ã€‚',
'ç–¤ç—•',
'è©¦ä»¥ã€Œè«‡ç©ç‰©å–ªå¿—ã€æˆ–ã€Œè«‡ç©ç‰©é¤Šå¿—ã€ç‚ºé¡Œï¼Œå¯«ä½œæ–‡ç« ä¸€ç¯‡ã€‚',
'æ³°ç„¶è™•ä¹‹',
'å¤èªæœ‰äº‘ã€Œå¤©ä¸‹çš†çŸ¥å–ä¹‹ç‚ºå–ï¼Œè€Œè«çŸ¥èˆ‡ä¹‹ç‚ºå–ã€‚ã€æ„æ€æ˜¯ä¸–äººéƒ½çŸ¥é“ç´¢å–å¯ä»¥ç²å¾—ï¼Œè€Œä¸çŸ¥é“çµ¦äºˆä¹Ÿå¯ä»¥ç²å¾—ã€‚è©¦è«‡è«‡ä½ å°é€™å¥è©±çš„çœ‹æ³•ã€‚',
'è«‡åš´è‹›',
'è«‡å¯¬å®¹',
'è«‡æ†¤æ€’',
'å¾…å€™',
'æœ‰äººèªç‚ºï¼šã€Œèˆ‡å…¶è¿½æ±‚æˆåŠŸï¼Œä¸å¦‚è¿½æ±‚å¹¸ç¦ã€‚ã€ä½ åŒæ„å—ï¼Ÿè©¦æ’°å¯«æ–‡ç« ä¸€ç¯‡ï¼Œè«–è¿°ä½ çš„çœ‹æ³•ã€‚',
'çŸ›ç›¾',
'æœ‰äººèªç‚ºï¼šã€Œä¿æŒè·é›¢èƒ½ä»¤é—œä¿‚é•·ä¹…ã€‚ã€ä½ åŒæ„å—ï¼Ÿè©¦æ’°æ–‡ä¸€ç¯‡ï¼Œè«–è¿°ä½ çš„çœ‹æ³•ã€‚',
'æœ‰äººèªªï¼šã€Œè¿‘æœ±è€…èµ¤ï¼Œè¿‘å¢¨è€…é»‘ã€‚ã€ä½ åŒæ„å—ï¼Ÿç‚ºç”šéº¼ï¼Ÿ',
'è©¦ä»¥ã€Œç•¶ç§‘æŠ€æ–‡æ˜æ¶ˆå¤±å¾Œã€ç‚ºé¡Œï¼Œå¯«ä¸€ç¯‡è©•è«–ï¼Œåæ€ç§‘æŠ€ç™¼å±•å¸¶ä¾†çš„å½±éŸ¿ã€‚',
'æˆåŠŸè·¯ä¸Šç„¡æ·å¾‘ï¼Œè©¦è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'å€‹äººé›»å­ç”¢å“çš„æ™®åŠåŒ–ï¼Œæœ‰äººèªç‚ºæ˜¯ç”Ÿæ´»çš„é€²æ­¥ï¼Œæœ‰äººèªç‚ºæ˜¯ç”Ÿæ´»çš„å€’é€€ã€‚ä½ è¼ƒèªåŒå“ªä¸€ç¨®è§€é»ï¼Ÿè©¦è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'æœ‰äººèªç‚ºå³ä½¿å¿ƒä¸­ä¸å¿«ï¼Œäº¦è¦ä»¥ç¬‘é¢å°äººï¼›æœ‰äººèªç‚ºæ‡‰ä»¥çœŸæ€§æƒ…å°äººï¼Œä¸æ‡‰æ©é£¾å¿ƒä¸­çš„æ„Ÿå—ï¼Œä½ è¼ƒè´ŠåŒå“ªä¸€æ–¹ï¼Ÿè©¦è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'é‘°åŒ™',
'è²§ä¹èˆ‡å¯Œè¶³',
'è«–æ„å¤–',
'è©¦è«‡è«‡ä½ å°ã€Œè½å¤©ç”±å‘½ã€é€™ç¨®è™•ä¸–æ…‹åº¦çš„çœ‹æ³•ã€‚',
'ã€Œå¤©è³œé£Ÿæ–¼é³¥ï¼Œå»ä¸æŠ•é£Ÿæ–¼å·¢ã€‚ã€ä¸Šå¤©è³œäºˆé³¥é¡è¦“é£Ÿçš„æœ¬èƒ½ï¼Œè€Œä¸æŠŠé£Ÿç‰©æŠ•åˆ°é³¥å·¢ã€‚æ„æ€æ˜¯äººéœ€è¦é€šéåŠªåŠ›ï¼Œæ‰èƒ½æœ‰æ‰€å¾—ã€‚ä½ èªåŒå—?è©¦è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'è‰²å½©',
'è«‡è—è¡“çš„åƒ¹å€¼',
'è—¥',
'æœ‰äººèªªï¼šã€Œæ¯æ¬¡ä»˜å‡ºæ‡‰è©²å…ˆè¨ˆç®—å›å ±ã€‚ã€ä½ åŒæ„é€™ç¨®è™•äº‹æ…‹åº¦å—ï¼Ÿ',
'è«–å…¬å¾·å¿ƒçš„é‡è¦æ€§',
'æœ‰äººèªç‚ºä¸­å­¸ç”Ÿæ‡‰å¤šåƒèˆ‡èª²å¤–æ´»å‹•ï¼Œç™¼å±•èˆˆè¶£ï¼›æœ‰äººå‰‡èªç‚ºæ‡‰å°ˆæ³¨å­¸æ¥­ï¼Œçˆ­å–å¥½æˆç¸¾ã€‚ä½ è¼ƒèªåŒå“ªç¨®èªªæ³•ï¼Ÿè©¦è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'ä½ åŒæ„ã€Œå“å¾·æ¯”å­¸å•æ›´é‡è¦ã€å—ï¼Ÿè©¦å¯«ä¸€ç¯‡è­°è«–æ–‡ï¼Œè«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'è«‡ç«¶çˆ­',
'è«‡ç¼ºæ†¾',
'è«‡å¾—å¤±',
'è«‡å‹‡æ°£',
'å¾—ä¸å„Ÿå¤±',
'çˆºçˆºï¼šã€Œæˆ‘ç•¶é˜éŒ¶åŒ è¶…é50å¹´ï¼Œç•¢ç”Ÿå°ˆæ³¨é€™é–€æ‰‹è—ï¼Œèƒ½åšåˆ°åˆ†æ¯«ä¸å·®ã€‚ã€å…è¡Œï¼šã€Œæˆ‘æ˜¯å“å‘³ç”Ÿæ´»çš„å’–å•¡å¸«ï¼Œäº¦æ˜¯æ›¸å¯«äººç”Ÿçš„ä½œå®¶ï¼Œæ›´æ˜¯åŸ¹è‚²å¾Œé€²çš„æ­¦è¡“æ•™ç·´ã€‚ã€å„äººå°äººç”Ÿæœ‰ä¸åŒè¿½æ±‚ã€‚æœ‰äººèªç‚ºï¼šã€Œèˆ‡å…¶ä¸€ç”Ÿå°ˆç²¾ä¸€äº‹ï¼Œä¸å¦‚ç™¼å±•å¤šå…ƒäººç”Ÿã€‚ã€ä½ åŒæ„å—ï¼Ÿè©¦æ’°æ–‡ä¸€ç¯‡ï¼Œè«–è¿°ä½ çš„çœ‹æ³•ã€‚',
'å¾®ç¬‘ä»¥å°',
'æœ‰äººèªç‚ºã€Œå‚³çµ±å¾€å¾€æ˜¯å‰µæ–°çš„åŒ…è¢±ã€ã€‚è©¦è«‡è«‡ä½ å°é€™å¥è©±çš„çœ‹æ³•ã€‚',
'è¶³å°',
'å¤äººèªªï¼šã€Œç¨å­¸è€Œç„¡å‹ï¼Œå‰‡å­¤é™‹è€Œå¯¡èã€‚ã€æ„æ€æ˜¯ç¨è‡ªå­¸ç¿’ï¼Œæ²’æœ‰æœ‹å‹äº’ç›¸åˆ‡ç£‹è§£é›£ï¼Œäººä¾¿æœƒæ·ºé™‹è€Œè¦‹è­˜ä¸å»£ã€‚åœ¨ç¾ä»Šçš„å­¸ç¿’ç”Ÿæ´»ä¸­ï¼Œä½ æ˜¯å¦åŒæ„ã€Œç¨å­¸è€Œç„¡å‹ï¼Œå‰‡å­¤é™‹è€Œå¯¡èã€ï¼Ÿè©¦è©¦è«‡ä½ çš„çœ‹æ³•ã€‚',
'ã€Œä¸åšç¬¬ä¸€ï¼Œä¹Ÿä¸åšæœ€å¾Œã€‚ã€è©¦è«‡è«‡ä½ å°é€™ç¨®è™•ä¸–æ…‹åº¦çš„çœ‹æ³•ã€‚',
'è©¦ä»¥ã€Œé™½å…‰èˆ‡é™°å½±ã€ç‚ºé¡Œï¼Œå¯«ä½œä¸€ç¯‡æ–‡ç« ã€‚',
'ã€Œå­©å­ä¸æ˜¯ç­‰å¾…è¢«å¡«æ»¿çš„ç“¶å­ï¼Œè€Œæ˜¯ç›¼æœ›åŒ–ä½œç‡ƒç‡’çš„ç«ç„°ã€‚ã€è©¦å°±å€‹äººå°é€™å¥è©±çš„é«”æœƒ ï¼Œä»¥ã€Œæˆé•·ã€ç‚ºé¡Œï¼Œå¯«ä½œä¸€ç¯‡æ–‡ç« ã€‚',
'ã€Œä»Šæ—©åª½åª½æ‰“æƒçš„æ™‚å€™ï¼Œç„ä¸€ç„ç»ç’ƒçª—å¤–é„°å±…æ™¾æ›¬çš„è¡£æœï¼Œä¾¿æ‰¹è©•é“ï¼šã€çœ‹ï¼Œé‚£æ–°é„°å±…çœŸé¦¬è™ï¼è¡£æœé‚„æ˜¯æ±¡æ¼¬æ–‘æ–‘ï¼Œæ´—å¾—ä¸€é»ä¹Ÿä¸ä¹¾æ·¨ã€‚ã€å¥³å…’è½å¾Œï¼Œä¸€è¨€ä¸ç™¼ï¼Œèµ°åˆ°çª—å‰ä»”ç´°æ‰“é‡ï¼Œéš¨å³æŠ¹æ‰çª—ä¸Šçš„ç°å¡µï¼Œèªªé“ï¼šã€é€™ä¸å°±ä¹¾æ·¨äº†å—ï¼Ÿã€åª½åª½æç„¶å¤§æ‚Ÿï¼Œä¸ä¹¾æ·¨çš„ä¸æ˜¯åˆ¥äººçš„è¡£æœï¼Œè€Œæ˜¯è‡ªå·±çš„çª—å­ã€‚ã€è©¦å°±é€™å€‹æ•…äº‹å°ä½ çš„å•“ç™¼ï¼Œå¯«ä½œä¸€ç¯‡æ–‡ç« ï¼Œè«‡è«‡å¦‚ä½•æ¶ˆé™¤åè¦‹ã€‚',
'ã€Œä¸€å€‹å¯’å†·çš„å†¬å¤©ï¼Œå¹¾éš»åˆºèŸæ“ åœ¨ä¸€èµ·å–æš–ã€‚ç”±æ–¼ç‰ å€‘èº«ä¸Šé•·æ»¿äº†çŸ­åˆºï¼Œå½¼æ­¤æˆ³ç—›äº†å°æ–¹ï¼Œæ‰€ä»¥ä¸å¾—ä¸æ•£é–‹ã€‚å¯æ˜¯ï¼Œå¯’å†·çš„å¤©æ°£åˆé©…ä½¿ç‰ å€‘æ“ åœ¨ä¸€èµ·ï¼ŒåŒæ¨£çš„äº‹æƒ…é‡è¤‡ç™¼ç”Ÿï¼Œç‰ å€‘çµ‚æ–¼æ˜ç™½ï¼›ä¸è¦å¤ªè¿‘ï¼Œä¹Ÿä¸è¦å¤ªé ï¼Œæœ€å¥½å½¼æ­¤ä¿æŒä¸€å®šçš„è·é›¢ã€‚ã€é€™å€‹æ•…äº‹çš„é“ç†ä»ç„¶è²«ç©¿åœ¨æˆ‘å€‘çš„ç¾å¯¦ç”Ÿæ´»ä¸­ï¼Œè©¦å°±æ­¤å¯«ä¸€ç¯‡æ–‡ç« ã€‚',
'å€‹äººç§éš±æ¯”å…¬çœ¾çŸ¥æƒ…æ¬Šæ›´é‡è¦ï¼Œä½ åŒæ„å—ï¼Ÿè«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'é¦™æ¸¯æ˜¯ä¸€å€‹ç‰©è³ªç”Ÿæ´»ååˆ†å¯Œåº¶çš„åœ°æ–¹ï¼Œå¯æ˜¯åœ¨å¤šå€‹åœ‹éš›æ€§çš„èª¿æŸ¥ä¸­ï¼Œã€Œå¿«æ¨‚æŒ‡æ•¸ã€çš„æ’åä¸¦ä¸é«˜ã€‚æœ‰äººèªç‚ºå¯Œåº¶çš„ç‰©è³ªç”Ÿæ´»åä»¤äººé›£ä»¥å¿«æ¨‚ï¼›ä¹Ÿæœ‰äººèªç‚ºå¯Œåº¶çš„ç‰©è³ªç”Ÿæ´»æ˜¯å¿«æ¨‚çš„åŸºç¤ã€‚é€™å…©ç¨®çœ‹æ³•ï¼Œä½ æ¯”è¼ƒèªåŒå“ªä¸€ç¨®ï¼Ÿè©¦è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'é¢å°ä¸åŒæ„è¦‹ï¼Œæœ‰äººèªç‚ºæ‡‰æ“šç†åŠ›çˆ­ï¼Œå …å®ˆç«‹å ´ï¼›æœ‰äººèªç‚ºæ‡‰å½¼æ­¤åŒ…å®¹ï¼Œæ±‚åŒå­˜ç•°ã€‚ä¸Šè¿°å…©ç¨®æ…‹åº¦ï¼Œå“ªä¸€ç¨®è¼ƒç‚ºç†æƒ³ï¼Ÿè©¦è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'æœ‰äººèªç‚ºçˆ¶æ¯æ•™é¤Šå­å¥³ï¼Œæ‡‰è©²çµ¦äºˆç©ºé–“ï¼Œè®“å­å¥³è‡ªç”±ç™¼å±•ï¼›æœ‰äººèªç‚ºæ‡‰è©²çµ¦äºˆæ˜ç¢ºçš„æŒ‡å°ï¼Œè®“å­å¥³ä¾å¾ã€‚ä¸Šè¿°æ•™é¤Šå­å¥³çš„æ–¹æ³•ï¼Œå“ªä¸€ç¨®è¼ƒç‚ºç†æƒ³ï¼Ÿè©¦è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'æœ‰äººèªªï¼šã€Œèˆ‡å…¶è¿½éš¨æ½®æµï¼Œä¸å¦‚å±•ç¾å€‹äººé¢¨æ ¼ã€‚ã€ä½ å°é€™å¥è©±æœ‰ä»€éº¼çœ‹æ³•ï¼Ÿ',
'æœ‰äººèªªï¼šã€Œæ£’ä¸‹å‡ºå­å­ï¼Œåš´å¸«å‡ºé«˜å¾’ã€‚ã€ä¹Ÿæœ‰äººèªªï¼šã€Œçè³æ˜¯æ•™è‚²çš„æ©ç‰©ã€‚ã€ä½ å°é€™å…©ç¨®èªªæ³•æœ‰ä»€éº¼æ„è¦‹ï¼Ÿ',
'ç¾ä»Šç¤¾æœƒï¼Œè¨±å¤šäººèªç‚ºè²¡å¯Œèˆ‡ç¤¾æœƒåœ°ä½æˆæ­£æ¯”ï¼Œè²¡å¯Œæ„ˆå¤šï¼Œç¤¾æœƒåœ°ä½æ„ˆé«˜ã€‚ä½ çš„çœ‹æ³•å¦‚ä½•ï¼Ÿ',
'æœ‰äººèªç‚ºè®šè³æ˜¯æˆåŠŸçš„æœ€å¤§æ¨å‹•åŠ›ï¼Œä½ åŒæ„å—ï¼Ÿè©¦ä½œæ–‡ä¸€ç¯‡ï¼Œè«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'æœ‰äººèªªï¼šã€Œè±è£•çš„ç‰©è³ªç”Ÿæ´»å°±æ˜¯æœ€ç¾å¥½çš„ç”Ÿæ´»ã€‚ã€ä½ åŒæ„å—ï¼Ÿè©¦è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'ç²å–çŸ¥è­˜æ˜¯é€šå¾€æˆåŠŸçš„å”¯ä¸€é€”å¾‘ï¼Œä½ åŒæ„å—ï¼Ÿè©¦è«‡è«‡ä½ çš„çœ‹æ³•ã€‚',
'è«‡è«‡é’å¹´äººæ‡‰å¦‚ä½•å…‹æœå›°é›£',
'ã€Œå¾‹å·±ä»¥åš´ï¼Œå¾…äººä»¥å¯¬ã€‚ã€è«‡è«‡ä½ å°é€™è©±çš„çœ‹æ³•ã€‚',
'ã€ŒæˆåŠŸæ˜¯æ†å¿ƒçš„åŸºçŸ³ã€è«‡è«‡ä½ å°é€™è©±çš„çœ‹æ³•ã€‚',
'è«–ã€Œå®¶æœ‰ä¸€è€ï¼Œå¦‚æœ‰ä¸€å¯¶ã€',
'é€ç¦®ä¹‹æˆ‘è¦‹',
'é„‰æ‘ç™¼å±•ç‚ºå·¥æ¥­å€ï¼ŒåŸä¾†çš„å¤©ç„¶æ™¯ç‰©å—åˆ°ç ´å£ã€‚æœ‰äººèªªï¼šã€Œæœ‰ç ´å£æ‰æœ‰å»ºè¨­ã€‚ã€ä¹Ÿæœ‰äººèªªï¼šã€Œé€™ç¨®å»ºè¨­ç ´å£äº†äººå€‘ç”Ÿæ´»çš„æƒ…è¶£ã€‚ã€ä½ çš„çœ‹æ³•åˆæ€æ¨£ï¼Ÿè©¦èªªå‡ºä½ å€‹äººçš„æ„è¦‹ã€‚'
];

let lastTopic = localStorage.getItem("lastTopic") || "";
let lastArgumentTopic = localStorage.getItem("lastArgumentTopic") || "";


// === ä¿®è¨‚ï¼šå‹•æ¼«å¡ç‰‡é¸æ“‡é‚è¼¯ (åŒ…å«éŸ³æ•ˆ) ===

// === ä¿®è¨‚ï¼šå‹•æ¼«å¡ç‰‡é¸æ“‡é‚è¼¯ (åŒ…å«éŸ³æ•ˆ + å»¶é²å‹•ç•«) ===

// === ä¿®è¨‚ï¼šå‹•æ¼«å¡ç‰‡é¸æ“‡é‚è¼¯ (åŒ…å«éŸ³æ•ˆ + å»¶é²å‹•ç•«) ===

// 1. é¸å–æ‰€æœ‰æ–°çš„å¡ç‰‡å…ƒç´ 
const categoryCards = document.querySelectorAll('.anime-card');
const clickSound = document.getElementById('ui-click-sound');

// 2. ç‚ºæ¯å€‹å¡ç‰‡æ·»åŠ é»æ“Šäº‹ä»¶
categoryCards.forEach(card => {
    card.addEventListener('click', function(e) {
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©ï¼šä½¿ç”¨ e.currentTarget é–å®šç•¶å‰é»æ“Šçš„å…ƒç´  â˜…â˜…â˜…
        const targetCard = e.currentTarget;

        // A. æ’­æ”¾æ¸…è„†éŸ³æ•ˆ
        if (clickSound) {
            clickSound.currentTime = 0; 
            clickSound.volume = 1.0;    
            clickSound.play().catch(err => console.log("éŸ³æ•ˆæ’­æ”¾è¢«ç€è¦½å™¨é˜»æ“‹:", err));
        }

        // B. ç«‹å³æ·»åŠ è¦–è¦ºæ•ˆæœ (è®“å¡ç‰‡è®Šè‰²/ç™¼å…‰)
        // å…ˆç§»é™¤æ‰€æœ‰å‹•æ¼«å¡ç‰‡çš„ active æ¨£å¼
        document.querySelectorAll('.anime-card').forEach(c => c.classList.remove('active'));
        
        // åªç‚ºç•¶å‰é»æ“Šçš„é€™å¼µå¡ç‰‡åŠ ä¸Š active
        targetCard.classList.add('active');

        // C. ç²å–ç›®æ¨™ Container ID (ç¢ºä¿æœ‰é»æ“Šåˆ°æœ‰ ID çš„å¡ç‰‡)
        if (targetCard.id) {
            const containerId = targetCard.id.replace('Btn', 'Container');
            
            // D. è¨­ç½®å»¶é²ï¼Œè®“å‹•ç•«è·‘å®Œ 500ms å¾Œæ‰åˆ‡æ›ç•«é¢
            setTimeout(() => {
                showContainer(containerId, targetCard);
            }, 500); 
        }
    });
});


// === æ²‰æµ¸å¼å ´æ™¯è¨­å®š ===
const scenes = {
    'home': 'https://i.ibb.co/xtsrPW6M/image.png', // åŸæœ¬çš„ä¸»é èƒŒæ™¯
    'writingContainer': 'ç¯„ç–‡ä¸€.png', // å¯«ä½œï¼šæ›¸æ¡Œèˆ‡ç­†
    'readingContainer': 'ç¯„ç–‡äºŒ.png', // é–±è®€ï¼šåœ–æ›¸é¤¨
    'argumentContainer': 'ç¯„ç–‡ä¸‰.png', // è­°è«–ï¼šæ³•é™¢/æœ¨æ§Œ
    'expandContainer': 'ç¯„ç–‡å››.png', // æ‹“å±•ï¼šå”ä½œ/ç¶²çµ¡
    'booksContainer': 'ç¯„ç–‡äº”.png' // æ›¸ç±ï¼šèˆ’é©é–±è®€è§’
};

// === æ›´æ–°ç‰ˆï¼šé€²å…¥åŠŸèƒ½å®¹å™¨ (å«è‡ªå‹•ç½®é ‚) ===
// === æ›´æ–°ç‰ˆï¼šé€²å…¥åŠŸèƒ½å®¹å™¨ (å«è‡ªå‹•ç½®é ‚ + éš±è—æ­·å²ç´€éŒ„) ===
function showContainer(containerId, clickedButton) {
    hideAllSaveHtmlButtons(); 
    
    // 1. åˆ‡æ›èƒŒæ™¯åœ–ç‰‡ (æ”¯æ´åœ–ç‰‡æˆ–ç´”è‰²)
    const bg = scenes[containerId];
    if (bg) {
        if (bg.startsWith('#') || bg.startsWith('rgb')) {
            document.body.style.backgroundImage = 'none';
            document.body.style.backgroundColor = bg;
        } else {
            document.body.style.backgroundImage = `url('${bg}')`;
            document.body.style.backgroundColor = ''; 
        }
    }

    // 2. éš±è—ä¸»é¸å–®å…ƒç´ 
    document.querySelector('.title-container').style.display = 'none';
    document.getElementById('hitokoto-container').style.display = 'none';
    document.getElementById('mainMenuBox').style.display = 'none'; 
    document.getElementById('toolsBox').style.display = 'none';    
    
    // === ã€æ–°å¢ã€‘éš±è— DSE å€’æ•¸ ===
    const dseBox = document.getElementById('dse-countdown-box');
    if (dseBox) dseBox.style.display = 'none';
    // ===========================

    // 3. ä¿®æ”¹é€™éƒ¨åˆ†ï¼šéš±è—å·¦ä¸Šè§’çš„åœ“å½¢è¿”å›æŒ‰éˆ•
    document.getElementById('homeBtn').style.display = 'none'; 
    document.getElementById('sideMenuHomeBtn').style.display = 'flex';

    // 4. æ¸…é™¤ç‹€æ…‹èˆ‡éš±è—å…¶ä»–å®¹å™¨
    const allCards = document.querySelectorAll('.anime-card');
    allCards.forEach(card => card.classList.remove('active'));
    if (clickedButton) clickedButton.classList.add('active');

    clearAllTopicStates();

    const containers = ['writingContainer', 'readingContainer', 'booksContainer', 'expandContainer', 'argumentContainer'];
    containers.forEach(id => document.getElementById(id).style.display = "none");

    // â˜…â˜…â˜… æ–°å¢ï¼šç¢ºä¿æ­·å²ç´€éŒ„éš±è— â˜…â˜…â˜…
    const historyContainer = document.getElementById('historyContainer');
    if (historyContainer) historyContainer.style.display = 'none';

    // 5. å¼·åˆ¶æ»¾å‹•åˆ°é é¢æœ€é ‚ç«¯
    window.scrollTo({ top: 0, behavior: 'instant' });

    // 6. é¡¯ç¤ºç›®æ¨™å®¹å™¨ (æ·¡å…¥å‹•ç•«)
    const targetContainer = document.getElementById(containerId);
    if (targetContainer) {
        targetContainer.style.display = "block";
        targetContainer.style.opacity = '0';
        targetContainer.style.transform = 'translateY(20px)';
        
        // è§¸ç™¼é‡ç¹ª (Reflow) ç¢ºä¿ transition ç”Ÿæ•ˆ
        void targetContainer.offsetWidth; 

        targetContainer.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        targetContainer.style.opacity = '1';
        targetContainer.style.transform = 'translateY(0)';
    }

    // 7. åˆå§‹åŒ–ç‰¹å®šåŠŸèƒ½
    if (containerId === "writingContainer") { toggleWritingType(); loadOutline(); }
    else if (containerId === "readingContainer") { toggleReadingFunction(); }
    else if (containerId === "expandContainer") { toggleExpandFunction(); }
    else if (containerId === "booksContainer") { loadBooksChat(); }
    else if (containerId === "argumentContainer") { toggleArgumentType(); }
}


// === æ›´æ–°ç‰ˆï¼šè¿”å›ä¸»é å‡½å¼ ===
function returnToHome() {
    // 1. æ¢å¾©ä¸»é èƒŒæ™¯
    document.body.style.backgroundImage = `url('${scenes['home']}')`;

    // 2. ç¢ºä¿æ‡¸æµ®ç·¨è¼¯è¦–çª—è¢«é—œé–‰
    const outlineModal = document.getElementById('outline-editor-modal');
    if (outlineModal) {
        outlineModal.style.display = 'none';
    }
    if (typeof currentEditingElement !== 'undefined') {
        currentEditingElement = null;
    }

    // 3. â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šåŠ å…¥ 'historyContainer' åˆ°éš±è—åˆ—è¡¨ â˜…â˜…â˜…
    const containers = ['writingContainer', 'readingContainer', 'booksContainer', 'expandContainer', 'argumentContainer', 'historyContainer'];
    containers.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
    });

    // 4. â˜…â˜…â˜… é¡å¤–ä¿®æ­£ï¼šå¼·åˆ¶é—œé–‰æ­·å²è©³æƒ…æ¨¡æ…‹è¦–çª— â˜…â˜…â˜…
    const historyModal = document.getElementById('historyModal');
    if (historyModal) {
        historyModal.style.display = 'none';
    }

    // 5. â˜…â˜…â˜… é¡å¤–ä¿®æ­£ï¼šé‡ç½®æ­·å²ç´€éŒ„ä»‹é¢è‡³ç¬¬ä¸€å±¤ (ç¯„ç–‡é¸æ“‡)ï¼Œé¿å…ä¸‹æ¬¡æ‰“é–‹æ™‚åœç•™åœ¨èˆŠç´€éŒ„ â˜…â˜…â˜…
    const histL1 = document.getElementById('historyLevel1Wrapper');
    const histL2 = document.getElementById('historyLevel2');
    const histL3 = document.getElementById('historyLevel3');
    const histBread = document.getElementById('historyBreadcrumb');
    
    if (histL1) histL1.style.display = 'flex'; // æ¢å¾©é¡¯ç¤ºç¬¬ä¸€å±¤
    if (histL2) histL2.style.display = 'none';
    if (histL3) histL3.style.display = 'none';
    if (histBread) histBread.style.display = 'none'; // éš±è—éºµåŒ…å±‘

    // 6. é¡¯ç¤ºä¸»é å…ƒç´ 
    document.querySelector('.title-container').style.display = 'block';
    document.getElementById('hitokoto-container').style.display = 'block';
    document.getElementById('mainMenuBox').style.display = 'block';
    document.getElementById('toolsBox').style.display = 'block';

    // 7. é‡æ–°é¡¯ç¤º DSE å€’æ•¸
    const dseBox = document.getElementById('dse-countdown-box');
    if (dseBox) dseBox.style.display = 'flex';

    // 8. éš±è—è¿”å›æŒ‰éˆ•
    document.getElementById('sideMenuHomeBtn').style.display = 'none';
    document.getElementById('homeBtn').style.display = 'none';

    // 9. ç§»é™¤æ‰€æœ‰å¡ç‰‡ active ç‹€æ…‹
    document.querySelectorAll('.anime-card').forEach(card => card.classList.remove('active'));

    // 10. å¼·åˆ¶éš±è—ã€Œå·¥å…·ä¸€è¦½ã€
    const toolsContainer2 = document.getElementById('toolsContainer2');
    if (toolsContainer2) {
        toolsContainer2.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // 11. æ”¶èµ·å´é‚Šé¸å–®
    const sideMenu = document.getElementById('sideMenu');
    if (sideMenu && sideMenu.classList.contains('active')) {
        sideMenu.classList.remove('active');
        document.getElementById('sideMenuToggle').classList.remove('active');
    }

    // 12. éš±è—æ‰€æœ‰å„²å­˜æŒ‰éˆ•
    hideAllSaveHtmlButtons();

    // 13. å¼·åˆ¶æ»¾å‹•åˆ°é ‚éƒ¨
    window.scrollTo({ top: 0, behavior: 'instant' });
    
    // 14. ç¢ºä¿èˆŠç‰ˆå·¥å…·ç®±éš±è—
    const toolsBox = document.getElementById('toolsBox');
    if (toolsBox) {
        toolsBox.style.display = 'none'; 
    }
}
// æ–°å¢æ­¤å‡½å¼ï¼šç”¨æ–¼é¡¯ç¤ºè­°è«–çš„è‡ªè¨‚é¡Œç›®ä»‹é¢
// æ–°å¢æ­¤å‡½å¼ï¼šç”¨æ–¼é¡¯ç¤ºè­°è«–çš„è‡ªè¨‚é¡Œç›®ä»‹é¢ (å·²ä¿®è¨‚ï¼šåŠ å…¥ Toggle é–‹é—œé‚è¼¯)
function showArgumentCustomTopicInput(buttonElement) { 
    // --- 1. Toggle é‚è¼¯ ---
    if (buttonElement && buttonElement.classList.contains('active')) {
        buttonElement.classList.remove('active');
        
        const customTopicArea = document.getElementById("argumentCustomTopicArea");
        customTopicArea.style.display = "none";
        customTopicArea.innerHTML = "";
        
        const topicResult = document.getElementById("argumentTopicResult");
        topicResult.style.display = "none";
        topicResult.innerHTML = "";
        
        localStorage.removeItem("argumentCurrentTopic");
        return;
    }

    // --- 2. æ­£å¸¸é–‹å•Ÿé‚è¼¯ ---
    if (buttonElement) {
        updateButtonActiveState(buttonElement);
    }

    const customTopicArea = document.getElementById("argumentCustomTopicArea");
    const topicResult = document.getElementById("argumentTopicResult");

    topicResult.innerHTML = "";
    topicResult.style.display = "none";
    localStorage.removeItem("argumentCurrentTopic");

    customTopicArea.innerHTML = `
    <input type="text" id="argumentCustomTopic" class="no-modal-editor" placeholder="è«‹è¼¸å…¥è‡ªè¨‚é¡Œç›®">
    <button class="btn-icon-confirm" onclick="setArgumentCustomTopic()" title="ç¢ºèªé¡Œç›®">
    <i class="fas fa-check"></i>
    </button>
    `;
    customTopicArea.style.display = "block";
}

// åˆ‡æ›å¯«ä½œé¡å‹
function toggleWritingType() {
    hideAllSaveHtmlButtons();
    clearAllTopicStates();
    const writingType = document.getElementById("writingType").value;
    const contentContainer = document.getElementById("writingContentContainer");

    // ç²å–æ‰€æœ‰ç›¸é—œå€åŸŸ
    const writingGuideArea = document.getElementById("writingGuideArea");
    const outlineStructureArea = document.getElementById("outlineStructureArea");
    const narrativeElementsArea = document.getElementById("narrativeElementsArea");
    const topicSelectionArea = document.getElementById("topicSelectionArea");
    const writingArea = document.getElementById("writingArea");
    const submitWritingBtn = document.getElementById("submitWritingBtn");

    // é‡ç½®ç‹€æ…‹
    document.getElementById("writingGradingResult").innerHTML = "";
    document.getElementById("writingChatHistory").style.display = "none";

    if (writingType) {
        contentContainer.style.display = "block";
    } else {
        contentContainer.style.display = "none";
        return;
    }

    // é è¨­éš±è—æ‰€æœ‰ç‰¹å®šå€åŸŸ
    writingGuideArea.style.display = "none";
    outlineStructureArea.style.display = "none";
    narrativeElementsArea.style.display = "none";
    topicSelectionArea.style.display = "none"; 
    writingArea.style.display = "none"; 

    if (writingType === "guide") {
        writingGuideArea.style.display = "block";
        // è§£é¡ŒæŒ‡å¼•ä¸ä½¿ç”¨é€šç”¨çš„å¯«ä½œå€åŸŸ
    } 
    else if (writingType === "å¤§ç¶±") {
        writingArea.style.display = "block";
        topicSelectionArea.style.display = "block";
        outlineStructureArea.style.display = "block";
        document.getElementById("outlineTableArea").style.display = "block";
        generateOutlineTable();
        loadOutline();
        
        document.getElementById("writingContent").style.display = "none";
        document.getElementById("writingToneLabel").style.display = "block";
        document.getElementById("writingTone").style.display = "block";
        document.getElementById("outlineButtons").style.display = "flex"; 
        document.getElementById("writingReviewerLabel").style.display = "none";
        document.getElementById("writingReviewer").style.display = "none";
        document.getElementById("reviewScopeArea").style.display = "none";
        submitWritingBtn.style.display = "block";
    } 
    else if (writingType === "æ•˜äº‹ç‰©è±¡") {
        writingArea.style.display = "block";
        topicSelectionArea.style.display = "block";
        narrativeElementsArea.style.display = "block";
        
        document.getElementById("writingContent").style.display = "none";
        document.getElementById("outlineTableArea").style.display = "none";
        document.getElementById("writingToneLabel").style.display = "none";
        document.getElementById("writingTone").style.display = "none";
        document.getElementById("outlineButtons").style.display = "none";
        document.getElementById("writingReviewerLabel").style.display = "none";
        document.getElementById("writingReviewer").style.display = "none";
        document.getElementById("reviewScopeArea").style.display = "none";
        submitWritingBtn.style.display = "block";
    } 
    else { // ç‰‡æ®µæå¯«
        writingArea.style.display = "block";
        topicSelectionArea.style.display = "block";
        document.getElementById("writingContent").style.display = "block";
        
        document.getElementById("outlineTableArea").style.display = "none";
        document.getElementById("writingToneLabel").style.display = "block";
        document.getElementById("writingTone").style.display = "block";
        document.getElementById("outlineButtons").style.display = "none";
        document.getElementById("writingReviewerLabel").style.display = "block";
        document.getElementById("writingReviewer").style.display = "block";
        document.getElementById("reviewScopeArea").style.display = "block";
        submitWritingBtn.style.display = "block";
    }
}


// åŸ showCustomTopicInput() å‡½å¼
// åŸ showCustomTopicInput() å‡½å¼ (å·²ä¿®è¨‚ï¼šåŠ å…¥ Toggle é–‹é—œé‚è¼¯)
function showCustomTopicInput(buttonElement) {
    // --- 1. Toggle é‚è¼¯ï¼šå¦‚æœæŒ‰éˆ•å·²ç¶“æ˜¯ Active ç‹€æ…‹ï¼Œå‰‡é—œé–‰å®ƒ ---
    if (buttonElement && buttonElement.classList.contains('active')) {
        // ç§»é™¤ Active ç‹€æ…‹
        buttonElement.classList.remove('active');
        
        // éš±è—è¼¸å…¥å€
        const customTopicArea = document.getElementById("customTopicArea");
        customTopicArea.style.display = "none";
        customTopicArea.innerHTML = ""; // æ¸…ç©ºå…§å®¹
        
        // éš±è—çµæœå€ (å› ç‚ºå–æ¶ˆäº†é¸æ“‡)
        const topicResult = document.getElementById("topicResult");
        topicResult.style.display = "none";
        topicResult.innerHTML = "";
        
        // æ¸…é™¤ç›¸é—œ LocalStorage
        localStorage.removeItem("currentTopic");
        localStorage.removeItem("currentFocus");
        localStorage.removeItem("currentPlot");
        
        return; // çµæŸå‡½å¼
    }

    // --- 2. æ­£å¸¸é–‹å•Ÿé‚è¼¯ ---
    if (buttonElement) {
        updateButtonActiveState(buttonElement);
    }

    const writingType = document.getElementById("writingType").value;
    const customTopicArea = document.getElementById("customTopicArea");
    const topicResult = document.getElementById("topicResult");

    topicResult.innerHTML = "";
    topicResult.style.display = "none";
    localStorage.removeItem("currentTopic");
    localStorage.removeItem("currentFocus");
    localStorage.removeItem("currentPlot");

    if (writingType === "ç‰‡æ®µæå¯«") {
        customTopicArea.innerHTML = `
        <table>
        <tr><th colspan="2">è‡ªè¨‚é¡Œç›®èˆ‡é‡é»</th></tr>
        <tr><td colspan="2"><input type="text" id="customTitle" class="no-modal-editor" placeholder="è«‹è¼¸å…¥è‡ªè¨‚é¡Œç›®"></td></tr>
        <tr><td>æ‰£é¡Œæ–¹å‘</td><td>æƒ…ç¯€å¤§è¦</td></tr>
        <tr><td><textarea id="customFocus" class="no-modal-editor" rows="3" placeholder="è«‹è¼¸å…¥æ‰£é¡Œæ–¹å‘"></textarea></td>
        <td><textarea id="customPlot" class="no-modal-editor" rows="3" placeholder="è«‹è¼¸å…¥æƒ…ç¯€å¤§è¦"></textarea></td></tr>
        </table>
        <button class="btn-icon-confirm" onclick="setCustomTopic()" title="ç¢ºèªé¡Œç›®">
        <i class="fas fa-check"></i>
        </button>
        `;
    } else { 
        customTopicArea.innerHTML = `
        <input type="text" id="customTopic" class="no-modal-editor" placeholder="è«‹è¼¸å…¥è‡ªè¨‚é¡Œç›®">
        <button class="btn-icon-confirm" onclick="setCustomTopic()" title="ç¢ºèªé¡Œç›®">
        <i class="fas fa-check"></i>
        </button>
        `;
    }
    customTopicArea.style.display = "block";
}

// ä¿å­˜å¤§ç¶±
function saveOutline() {
const structure = document.getElementById("structure").value;
const parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];
const outlineData = parts.map((part, index) => {
const focusId = structure + "Focus" + (index + 1);
const plotId = structure + "Plot" + (index + 1);
const focus = document.getElementById(focusId)?.value.trim() || "";
const plot = document.getElementById(plotId)?.value.trim() || "";
return { part, focus, plot };
});
localStorage.setItem("outlineData", JSON.stringify(outlineData));
localStorage.setItem("outlineStructure", structure);
alert("å¤§ç¶±å·²å„²å­˜");
}

// æ¸…ç©ºå¤§ç¶±
function clearOutline() {
if (confirm("ç¢ºå®šè¦æ¸…ç©ºå¤§ç¶±å—ï¼Ÿ")) {
const structure = document.getElementById("structure").value;
const parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];
parts.forEach((part, index) => {
const focusId = structure + "Focus" + (index + 1);
const plotId = structure + "Plot" + (index + 1);
if (document.getElementById(focusId)) document.getElementById(focusId).value = "";
if (document.getElementById(plotId)) document.getElementById(plotId).value = "";
});
localStorage.removeItem("outlineData");
localStorage.removeItem("outlineStructure");
}
}

// åŠ è¼‰å¤§ç¶±
function loadOutline() {
const savedStructure = localStorage.getItem("outlineStructure");
const savedData = localStorage.getItem("outlineData");
if (savedStructure && savedData) {
document.getElementById("structure").value = savedStructure;
generateOutlineTable();
try {
const parsedData = JSON.parse(savedData);
parsedData.forEach((item, index) => {
const focusId = savedStructure + "Focus" + (index + 1);
const plotId = savedStructure + "Plot" + (index + 1);
const focusElement = document.getElementById(focusId);
const plotElement = document.getElementById(plotId);
if (focusElement) focusElement.value = item.focus;
if (plotElement) plotElement.value = item.plot;
});
} catch (e) {
console.error("Error parsing outlineData:", e);
}
}
}

// ä¿å­˜èª²å¤–æ›¸ç±å°è©±
function saveBooksChat() {
// åªåœ¨æœ‰èŠå¤©è¨˜éŒ„æ™‚æ‰å„²å­˜
if (chatHistory.length > 0) {
const booksTone = document.getElementById("booksTone").value;
const currentState = {
// å¾ chatHistory ä¸­æ‰¾åˆ°æœ€æ–°çš„æ›¸ç±è³‡è¨Šä¾†å„²å­˜
bookTitle: bookTitle, 
author: author,
discussionQuestion: discussionQuestion,
booksTone: booksTone
};
localStorage.setItem("booksChatHistory", JSON.stringify(chatHistory));
localStorage.setItem("booksChatState", JSON.stringify(currentState));
alert("å°è©±å·²å„²å­˜");
} else {
alert("æ²’æœ‰å°è©±ç´€éŒ„å¯å„²å­˜ã€‚");
}
}

function clearBooksChat() {
if (confirm("ç¢ºå®šè¦æ¸…ç©ºå°è©±åŠç´€éŒ„å—ï¼Ÿ")) {
// æ¸…ç©º UI
document.getElementById("chatHistory").innerHTML = "";
document.getElementById("chatHistory").style.display = "none";
document.getElementById("chatInputContainer").style.display = "none";
document.getElementById("initialDiscussionForm").style.display = "block"; // é¡¯ç¤ºåˆå§‹è¡¨å–®
document.getElementById("booksButtons").style.display = "none"; // <-- æ–°å¢é€™ä¸€è¡Œ


// æ¸…ç©ºè¡¨å–®æ¬„ä½
document.getElementById("bookTitle").value = "";
document.getElementById("author").value = "";
document.getElementById("discussionQuestion").value = "";
document.getElementById("userInput").value = "";

// æ¸…ç©º localStorage
localStorage.removeItem("booksChatHistory");
localStorage.removeItem("booksChatState");

// é‡ç½® JS è®Šæ•¸
chatHistory = [];
bookTitle = "";
author = "";
discussionQuestion = "";
booksTone = "";
}
}


function loadBooksChat() {
const savedChatJSON = localStorage.getItem("booksChatHistory");
const savedStateJSON = localStorage.getItem("booksChatState");
const initialForm = document.getElementById("initialDiscussionForm");
const chatInterface = document.getElementById("chatInputContainer");
const chatHistoryDiv = document.getElementById("chatHistory");
const saveBtn = document.getElementById('save-books-html-btn');

if (savedChatJSON && savedStateJSON) {
// --- æœ‰å„²å­˜ç´€éŒ„çš„æ¨¡å¼ ---
initialForm.style.display = "none"; // éš±è—åˆå§‹è¡¨å–®
chatInterface.style.display = "flex"; // é¡¯ç¤ºèŠå¤©è¼¸å…¥ä»‹é¢
chatHistoryDiv.style.display = "flex"; // é¡¯ç¤ºèŠå¤©ç´€éŒ„
document.getElementById("booksButtons").style.display = "flex"; // <-- æ–°å¢é€™ä¸€è¡Œ
saveBtn.style.display = 'flex'; // é¡¯ç¤ºå„²å­˜æŒ‰éˆ•

chatHistoryDiv.innerHTML = '';
chatHistory = JSON.parse(savedChatJSON);
const state = JSON.parse(savedStateJSON);

// å¾ state æ¢å¾©å…¨åŸŸè®Šæ•¸
bookTitle = state.bookTitle || "";
author = state.author || "";
discussionQuestion = state.discussionQuestion || "";
booksTone = state.booksTone || "serious";

// æ¢å¾©èªæ°£é¸æ“‡
document.getElementById("booksTone").value = booksTone;

// é‡æ–°æ¸²æŸ“èŠå¤©ç´€éŒ„
chatHistory.forEach(item => {
renderMessage(item.sender, item.message);
});

} else {
// --- æ²’æœ‰å„²å­˜ç´€éŒ„çš„æ¨¡å¼ (åˆå§‹ç‹€æ…‹) ---
initialForm.style.display = "block"; // é¡¯ç¤ºåˆå§‹è¡¨å–®
chatInterface.style.display = "none"; // éš±è—èŠå¤©è¼¸å…¥ä»‹é¢
chatHistoryDiv.style.display = "none"; // éš±è—èŠå¤©ç´€éŒ„
saveBtn.style.display = 'none'; // éš±è—å„²å­˜æŒ‰éˆ•
}
}


/**
* æ›´æ–°æœ€å¾Œä¸€æ¢ AI è¨Šæ¯çš„å…§å®¹ï¼ˆå¾ "æ­£åœ¨å›æ‡‰..." åˆ°å¯¦éš›çš„å›æ‡‰ï¼‰ã€‚
* é€™å€‹æ–°ç‰ˆæœ¬èƒ½è™•ç†å¸¶æœ‰é ­åƒå’Œæ°£æ³¡çš„è¤‡é›œ HTML çµæ§‹ã€‚
* @param {string} newMessage - å¾ API ç²å–åˆ°çš„æ–°è¨Šæ¯å…§å®¹ã€‚
*/
function updateLastAIMessage(newMessage) {
// ç¾åœ¨ ai-loading é€™å€‹ ID ç›´æ¥åœ¨ message-bubble å…ƒç´ ä¸Š
const loadingBubble = document.getElementById("ai-loading"); 

if (loadingBubble) {
// ç›´æ¥æ›´æ–°æ°£æ³¡çš„å…§å®¹
loadingBubble.innerHTML = newMessage;
// ç§»é™¤ ID
loadingBubble.id = ""; 

// åŒæ­¥æ•¸æ“š
if (chatHistory.length > 0) {
chatHistory[chatHistory.length - 1].message = newMessage;
}
} else {
addMessageToHistory("ai", newMessage);
}
}


// åˆ‡æ›é–±è®€åŠŸèƒ½
function toggleReadingFunction() {
    hideAllSaveHtmlButtons(); // <-- åœ¨é€™è£¡åŠ å…¥å‡½å¼å‘¼å«
    clearAllTopicStates();
    const readingFunction = document.getElementById("readingFunction").value;
    
    // æ–°å¢ï¼šè™•ç†ã€Œè¨“ç·´ã€é¸é …ï¼Œç›´æ¥è·³è½‰
    if (readingFunction === "training") {
        window.location.href = "toolbox/interpretation.html";
        return;  // ç«‹å³è¿”å›ï¼Œé¿å…åŸ·è¡Œå¾ŒçºŒé‚è¼¯
    }
    
    const contentContainer = document.getElementById("readingInputArea");
    if (readingFunction) {
        contentContainer.style.display = "block";
    } else {
        contentContainer.style.display = "none";
        return; // å¦‚æœæ²’æœ‰é¸æ“‡ï¼Œå‰‡åœæ­¢åŸ·è¡Œ
    }
    
    const studentAnswerArea = document.getElementById("studentAnswerArea");
    const readingToneLabel = document.getElementById("readingToneLabel");
    const readingTone = document.getElementById("readingTone");
    if (readingFunction === "comment") {
        studentAnswerArea.style.display = "block";
        readingToneLabel.style.display = "block";
        readingTone.style.display = "block";
    } else {
        studentAnswerArea.style.display = "none";
        readingToneLabel.style.display = "none";
        readingTone.style.display = "none";
    }
}


// è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬çš„å‡½å¼ï¼Œæ›¿æ›æ‰æ‚¨åŸæœ¬çš„ toggleExpandFunction
function toggleExpandFunction() {
hideAllSaveHtmlButtons(); // <-- åœ¨é€™è£¡åŠ å…¥å‡½å¼å‘¼å«
clearAllTopicStates(); // é€™è¡Œå¾ˆå¥½ï¼Œä¿æŒä¸è®Š

const expandFunction = document.getElementById("expandFunction").value;
const contentContainer = document.getElementById("expandContentContainer");

if (expandFunction) {
contentContainer.style.display = "block";
} else {
contentContainer.style.display = "none";
return;
}

const expandWritingArea = document.getElementById("expandWritingArea");
const expandGuideArea = document.getElementById("expandGuideArea");
const expandTopicSelectionArea = document.getElementById("expandTopicSelectionArea");
const expandToneLabel = document.getElementById("expandToneLabel");
const expandTone = document.getElementById("expandTone");

// æ ¹æ“šé¸æ“‡çš„åŠŸèƒ½ï¼Œé¡¯ç¤ºæˆ–éš±è—å°æ‡‰çš„å€å¡Š
if (expandFunction === "comment") {
expandWritingArea.style.display = "block";
expandGuideArea.style.display = "none";
expandTopicSelectionArea.style.display = "block"; // é¡¯ç¤ºæˆ‘å€‘æ–°çš„æŒ‰éˆ•å€å¡Š
expandToneLabel.style.display = "block";
expandTone.style.display = "block";

// ç¢ºä¿è‡ªè¨‚é¡Œç›®è¼¸å…¥å€é è¨­æ˜¯éš±è—çš„
const customInputArea = document.getElementById("expandCustomTopicInputArea");
if(customInputArea) {
customInputArea.style.display = 'none';
customInputArea.innerHTML = '';
}

} else { // "guide"
expandWritingArea.style.display = "none";
expandGuideArea.style.display = "block";
expandTopicSelectionArea.style.display = "none";
expandToneLabel.style.display = "none";
expandTone.style.display = "none";
}
}
// æ–°å¢æ­¤å‡½å¼ï¼šç”¨æ–¼é¡¯ç¤ºæ•´åˆæ‹“å±•çš„è‡ªè¨‚é¡Œç›®ä»‹é¢
// æ–°å¢æ­¤å‡½å¼ï¼šç”¨æ–¼é¡¯ç¤ºæ•´åˆæ‹“å±•çš„è‡ªè¨‚é¡Œç›®ä»‹é¢ (å·²ä¿®è¨‚ï¼šåŠ å…¥ Toggle é–‹é—œé‚è¼¯)
function showExpandCustomTopicInput(buttonElement) {
    // --- 1. Toggle é‚è¼¯ ---
    if (buttonElement && buttonElement.classList.contains('active')) {
        buttonElement.classList.remove('active');
        
        const customTopicArea = document.getElementById("expandCustomTopicInputArea");
        customTopicArea.style.display = "none";
        customTopicArea.innerHTML = "";
        
        const topicResult = document.getElementById("expandTopicResult");
        topicResult.style.display = "none";
        topicResult.innerHTML = "";
        
        localStorage.removeItem("expandCurrentTitle");
        localStorage.removeItem("expandCurrentTheme");
        localStorage.removeItem("expandCurrentData");
        
        return;
    }

    // --- 2. æ­£å¸¸é–‹å•Ÿé‚è¼¯ ---
    if (buttonElement) {
        updateButtonActiveState(buttonElement);
    }

    const customTopicArea = document.getElementById("expandCustomTopicInputArea");
    const topicResult = document.getElementById("expandTopicResult");

    topicResult.innerHTML = "";
    topicResult.style.display = "none";
    localStorage.removeItem("expandCurrentTitle");
    localStorage.removeItem("expandCurrentTheme");
    localStorage.removeItem("expandCurrentData");

    // å‹•æ…‹ç”Ÿæˆè‡ªè¨‚é¡Œç›®çš„è¼¸å…¥è¡¨æ ¼å’Œç¢ºèªæŒ‰éˆ•
    customTopicArea.innerHTML = `
    <table>
    <tr><th>é¡Œç›®</th><td><input type="text" id="expandCustomTitle" class="no-modal-editor" placeholder="è«‹è¼¸å…¥é¡Œç›®"></td></tr>
    <tr><th>ä¸»é¡Œå¥</th><td><textarea id="expandCustomTheme" class="no-modal-editor" rows="2" placeholder="è«‹è¼¸å…¥ä¸»é¡Œå¥"></textarea></td></tr>
    <tr><th>æŠ„éŒ„è³‡æ–™</th><td><textarea id="expandCustomData" class="no-modal-editor" rows="3" placeholder="è«‹è¼¸å…¥æŠ„éŒ„è³‡æ–™"></textarea></td></tr>
    </table>
    <button class="btn-icon-confirm" onclick="setExpandCustomTopic()" title="ç¢ºèªé¡Œç›®">
    <i class="fas fa-check"></i>
    </button>
    `;
    customTopicArea.style.display = "block";
}


// åˆ‡æ›è­°è«–åŠŸèƒ½
function toggleArgumentType() {
    hideAllSaveHtmlButtons();
    clearAllTopicStates();

    const argumentType = document.getElementById("argumentType").value;
    const contentContainer = document.getElementById("argumentContentContainer");

    // ======= ã€æ ¸å¿ƒä¿®è¨‚ã€‘ç²å–æ‰€æœ‰æ–°å¢çš„å…ƒç´  =======
    const reviewScopeArea = document.getElementById("argumentReviewScopeArea");
    const gradingResultDiv = document.getElementById("argumentGradingResult");
    const chatHistoryDiv = document.getElementById("argumentChatHistory");
    const chatInputContainer = document.getElementById("argumentChatInputContainer");

    // åœ¨åˆ‡æ›æ™‚ï¼Œé‡ç½®ä¸¦éš±è—æ‰€æœ‰çµæœèˆ‡èŠå¤©ä»‹é¢
    gradingResultDiv.innerHTML = "";
    chatHistoryDiv.innerHTML = "";
    chatHistoryDiv.style.display = "none";
    chatInputContainer.style.display = "none";
    reviewScopeArea.style.display = "none";
    // ==========================================

    if (argumentType) {
        contentContainer.style.display = "block";
    } else {
        contentContainer.style.display = "none";
        return;
    }

    const outlineArea = document.getElementById("argumentOutlineArea");
    const writingArea = document.getElementById("argumentWritingArea");
    const guideArea = document.getElementById("argumentGuideArea");
    const topicSelectionArea = document.getElementById("argumentTopicSelectionArea");

    if (argumentType === "outline") {
        outlineArea.style.display = "block";
        writingArea.style.display = "none";
        guideArea.style.display = "none";
        topicSelectionArea.style.display = "block";
        generateArgumentOutlineTable();
    } else if (argumentType === "writing") {
        outlineArea.style.display = "none";
        writingArea.style.display = "block";
        guideArea.style.display = "none";
        topicSelectionArea.style.display = "block";
        reviewScopeArea.style.display = "block"; // ã€ä¿®è¨‚ã€‘åœ¨æ–‡ç« é»è©•æ¨¡å¼ä¸‹é¡¯ç¤ºç¯„ç–‡é¸æ“‡
    } else if (argumentType === "guide") {
        outlineArea.style.display = "none";
        writingArea.style.display = "none";
        guideArea.style.display = "block";
        topicSelectionArea.style.display = "none";
    }
}

// ç”Ÿæˆè­°è«–é¡Œç›®
async function generateArgumentTopic(buttonElement) { 
if (buttonElement) {
updateButtonActiveState(buttonElement);
}

const customTopicArea = document.getElementById("argumentCustomTopicArea");
customTopicArea.style.display = "none";
customTopicArea.innerHTML = "";

const topicResult = document.getElementById("argumentTopicResult");
topicResult.style.display = 'block';

let selectedTopic;
do {
selectedTopic = argumentTopics[Math.floor(Math.random() * argumentTopics.length)];
} while (selectedTopic === lastArgumentTopic && argumentTopics.length > 1);
lastArgumentTopic = selectedTopic;

localStorage.setItem("lastArgumentTopic", lastArgumentTopic);
topicResult.innerHTML = "<strong>" + selectedTopic + "</strong>";
localStorage.setItem("argumentCurrentTopic", selectedTopic);
}




// è¨­å®šè‡ªè¨‚é¡Œç›®ï¼ˆè­°è«–ï¼‰
function setArgumentCustomTopic() {
// ã€ä¸»è¦ä¿®æ”¹ã€‘åœ¨é€™è£¡ä½¿ç”¨ sanitizeHTML å‡½å¼
const customTopic = sanitizeHTML(document.getElementById("argumentCustomTopic").value.trim());
if (!customTopic) {
alert("è«‹è¼¸å…¥è‡ªè¨‚é¡Œç›®");
return;
}

const topicResult = document.getElementById("argumentTopicResult");
topicResult.innerHTML = "<strong>" + customTopic + "</strong>"; // <- ç¾åœ¨å®‰å…¨äº†
localStorage.setItem("argumentCurrentTopic", customTopic);

// ã€æ ¸å¿ƒä¿®è¨‚ã€‘å¼·åˆ¶è®“é¡Œç›®çµæœå€å¡Šé¡¯ç¤ºå‡ºä¾†
topicResult.style.display = "block"; 

// éš±è—ä¸¦æ¸…ç©ºè¼¸å…¥å€åŸŸ
const customTopicArea = document.getElementById("argumentCustomTopicArea");
customTopicArea.style.display = "none";
customTopicArea.innerHTML = "";
}
// ç”Ÿæˆè­°è«–å¤§ç¶±è¡¨æ ¼
function generateArgumentOutlineTable() {
const savedData = localStorage.getItem("argumentOutlineData");
let outlineData = [];
if (savedData) {
try {
outlineData = JSON.parse(savedData);
} catch (e) {
console.error("Error parsing argumentOutlineData:", e);
}
}
if (outlineData.length === 0) {
outlineData = [
{ part: "èµ·", point: "", evidence: "" },
{ part: "çµæ§‹æ®µä¸€", point: "", evidence: "" },
{ part: "çµæ§‹æ®µäºŒ", point: "", evidence: "" },
{ part: "çµæ§‹æ®µä¸‰", point: "", evidence: "" },
{ part: "åˆ", point: "", evidence: "" }
];
}
let tableHTML = "<div class='table-container'><table id='argumentOutlineTable'><tr><th>éƒ¨ä»½</th><th>è«–é»</th><th>è«–æ“šåŠè«–è­‰</th></tr>";
outlineData.forEach((item, index) => {
tableHTML += `<tr><td>${item.part}</td><td><textarea id="argumentPoint${index}" rows="3">${item.point}</textarea></td><td><textarea id="argumentEvidence${index}" rows="3">${item.evidence}</textarea></td></tr>`;
});
tableHTML += "</table></div>";
document.getElementById("argumentOutlineTableArea").innerHTML = tableHTML;
}

function addArgumentStructureSegment() {
const table = document.getElementById("argumentOutlineTable");
const rows = table.rows;
let structureSegmentCount = 0;
for (let i = 1; i < rows.length - 1; i++) { // è·³éè¡¨é ­å’Œã€Œåˆã€
if (rows[i].cells[0].innerText.startsWith("çµæ§‹æ®µ")) {
structureSegmentCount++;
}
}
const newSegmentNumber = structureSegmentCount + 1;
const chineseNumbers = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹", "å"];
const segmentName = `çµæ§‹æ®µ${chineseNumbers[newSegmentNumber - 1] || newSegmentNumber}`;
const newRowIndex = rows.length - 1; // åœ¨ã€Œåˆã€ä¹‹å‰æ’å…¥
const newRow = table.insertRow(newRowIndex);
const cell1 = newRow.insertCell(0);
const cell2 = newRow.insertCell(1);
const cell3 = newRow.insertCell(2);
cell1.innerText = segmentName;
cell2.innerHTML = `<textarea id="argumentPoint${newRowIndex - 1}" rows="3"></textarea>`;
cell3.innerHTML = `<textarea id="argumentEvidence${newRowIndex - 1}" rows="3"></textarea>`;
}

// ä¿å­˜è­°è«–å¤§ç¶±
function saveArgumentOutline() {
const table = document.getElementById("argumentOutlineTable");
const rows = table.rows;
const outlineData = [];
for (let i = 1; i < rows.length; i++) { // è·³éè¡¨é ­
const part = rows[i].cells[0].innerText;
const pointTextarea = rows[i].cells[1].querySelector("textarea");
const evidenceTextarea = rows[i].cells[2].querySelector("textarea");
const point = pointTextarea ? pointTextarea.value.trim() : "";
const evidence = evidenceTextarea ? evidenceTextarea.value.trim() : "";
outlineData.push({ part, point, evidence });
}
localStorage.setItem("argumentOutlineData", JSON.stringify(outlineData));
alert("å¤§ç¶±å·²å„²å­˜");
}

// æ¸…ç©ºè­°è«–å¤§ç¶±
function clearArgumentOutline() {
if (confirm("ç¢ºå®šè¦æ¸…ç©ºå¤§ç¶±å—ï¼Ÿ")) {
const table = document.getElementById("argumentOutlineTable");
const rows = table.rows;
for (let i = 1; i < rows.length; i++) {
document.getElementById(`argumentPoint${i - 1}`).value = "";
document.getElementById(`argumentEvidence${i - 1}`).value = "";
}
localStorage.removeItem("argumentOutlineData");
}
}

// === ä¿®æ­£ç‰ˆï¼šæäº¤è­°è«–æŒ‡å¼• (ç§»é™¤å‰ç«¯ä¸å­˜åœ¨çš„ categories å¼•ç”¨) ===
async function submitArgumentGuide() {
    const submitBtn = document.getElementById('submitArgumentGuideBtn');
    if (!submitBtn) return;
    
    submitBtn.disabled = true;
    hideAllSaveHtmlButtons();
 
    try {
        const topic = document.getElementById("argumentGuideTopic").value.trim();
        const point = document.getElementById("argumentGuidePoint").value.trim();
        const evidence = document.getElementById("argumentGuideEvidence").value.trim();
        const argument = document.getElementById("argumentGuideArgument").value.trim();
        
        if (!topic) {
            alert("è«‹è¼¸å…¥é¡Œç›®");
            submitBtn.disabled = false;
            return;
        }
 
        showLoading("é™³SIR æ­£åœ¨ç·¨å¯«æŒ‡å¼•...");
        
        // å‚³é€æ•¸æ“šè‡³å¾Œç«¯ (å·²ç§»é™¤ categories å¼•ç”¨)
        const payload = {
            action: "grade_argument",
            data: {
                subType: "guide",
                topic: topic,
                point: point || "ç„¡",
                evidence: evidence || "ç„¡",
                argument: argument || "ç„¡"
            }
        };
 
        const guide = await callReadingAPI(payload);
        
        currentContextContent = `é¡Œç›®ï¼š${topic}\nè«–é»ï¼š${point}\nè«–æ“šï¼š${evidence}\nè«–è­‰ï¼š${argument}`;
        currentContextReview = guide;
 
        // --- çµ„è£ HTML ---
        const guideParts = guide.split("###").map(part => part.trim()).filter(part => part);
        
        let guideHTML = `
            <div class="morandi-guide-container">
                <div style="margin-bottom: 20px; border-bottom: 1px solid #e0ddd7; padding-bottom: 10px;">
                    <h2 style="color: #5e7067; font-size: 1.4rem; letter-spacing: 2px; margin: 0;">${topic}</h2>
                </div>
        `;
 
        guideParts.forEach(part => {
            const lines = part.split("\n").filter(line => line.trim());
            const title = lines.shift() || "æŒ‡å¼•å…§å®¹";
            // è™•ç†æ›è¡Œï¼Œè®“æ®µè½åˆ†æ˜ä½†ä¸éå¯¬
            const content = lines.join("<br>");
 
            guideHTML += `
                <div class="guide-section-card">
                    <div class="guide-card-header">${title}</div>
                    <div class="guide-card-body">${content}</div>
                </div>
            `;
        });
 
        guideHTML += `</div>`;
 
        // åŠ å…¥è¿½å•èŠå¤©å®¤
        guideHTML += getCanvasChatHTML('argument_guide');
 
        // é–‹å•Ÿçµæœç•«å¸ƒ
        openResultCanvas("è­°è«–æ–‡å¯«ä½œæŒ‡å¼•");
        document.getElementById("resultCanvasBody").innerHTML = guideHTML;
 
        // å„²å­˜è‡³æ­·å²ç´€éŒ„
        await saveToHistory("è­°è«–", "æŒ‡å¼•", topic, `é¡Œç›®ï¼š${topic}\nè«–é»ï¼š${point}\nè«–æ“šï¼š${evidence}\nè«–è­‰ï¼š${argument}`, guideHTML);
        
    } catch (error) {
        console.error("æäº¤æŒ‡å¼•æ™‚å‡ºéŒ¯:", error);
        alert("æŒ‡å¼•ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
    } finally {
        submitBtn.disabled = false;
        hideLoading();
    }
}

// ==========================================
// === è­°è«–æ–‡æäº¤å‡½å¼ (å–®ç³»çµ±) ===
// ==========================================

// ==========================================
// === è­°è«–æ–‡æäº¤å‡½å¼ (å–®ç³»çµ±) ===
// ==========================================

// ==========================================
// === è­°è«–æ–‡æäº¤å‡½å¼ (å–®ç³»çµ±) ===
// ==========================================

async function submitArgumentWriting() {
    const submitBtn = document.getElementById('submitArgumentWritingBtn');
    submitBtn.disabled = true;
    hideAllSaveHtmlButtons();

    const gradingResultDiv = document.getElementById("argumentGradingResult");
    const chatHistoryDiv = document.getElementById("argumentChatHistory");
    const chatInputContainer = document.getElementById("argumentChatInputContainer");
    if(gradingResultDiv) gradingResultDiv.innerHTML = "";
    if(chatHistoryDiv) chatHistoryDiv.style.display = "none";
    if(chatInputContainer) chatInputContainer.style.display = "none";
    argumentChatHistoryData = [];

    try {
        const reviewerSelect = document.getElementById('argumentReviewer');
        const selectedReviewerText = reviewerSelect.options[reviewerSelect.selectedIndex].text;
        currentReviewerName = selectedReviewerText.replace(/\s*\(é è¨­\)\s*/, '');

        const topic = localStorage.getItem("argumentCurrentTopic");
        if (!topic) { alert("è«‹å…ˆè¨­å®šé¡Œç›®"); submitBtn.disabled = false; return; }
        const content = document.getElementById("argumentWritingContent").value.trim();
        if (!content) { alert("è«‹è¼¸å…¥æ‚¨çš„æ–‡ç« "); submitBtn.disabled = false; return; }
        
        currentArgumentArticle = content;
        const tone = document.getElementById("argumentWritingTone").value;
        const selectedScopes = Array.from(document.querySelectorAll('input[name="argumentReviewScope"]:checked')).map(cb => cb.value);
        const isFullReview = selectedScopes.includes("å…¨éƒ¨") || selectedScopes.length === 0;

        showLoading(`${currentReviewerName} æ­£åœ¨é»è©•...`); // æ›´æ–°æç¤º

        // â˜…â˜…â˜… RAG é‚è¼¯ (å·²æ›´æ–°) â˜…â˜…â˜…
        const ragReference = await searchSimilarEssays(content, 'argument');

        // â˜…â˜…â˜… ä¿®æ­£è™•ï¼šå·²ç§»é™¤ argumentReviewerPreferences çš„è®€å– â˜…â˜…â˜…
        // å› ç‚ºæ­¤è®Šæ•¸å·²ç§»è‡³å¾Œç«¯ Code.gs

        // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šPrompt çµæ§‹é‡çµ„ (ç§»é™¤å‰ç«¯æ³¨å…¥çš„åå¥½) â˜…â˜…â˜…
        const finalPromptContent = `
ã€ç³»çµ±å¼·åˆ¶æŒ‡ä»¤ (System Instruction)ã€‘
1. **å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ (Traditional Chinese)**ï¼šç„¡è«–åƒè€ƒè³‡æ–™æ˜¯ç°¡é«”æˆ–ç¹é«”ï¼Œä½ çš„æ‰€æœ‰è¼¸å‡ºéƒ½å¿…é ˆæ˜¯ç¹é«”ä¸­æ–‡ã€‚
2. **å°ˆæ¥­è¡“èª**ï¼šè«‹ä½¿ç”¨é¦™æ¸¯é«˜ä¸­ä¸­æ–‡ç§‘è­°è«–æ–‡è¡“èªï¼ˆå¦‚ï¼šè«–é»ã€è«–æ“šã€è«–è­‰ã€èªä¾‹ã€è¨­ä¾‹ç­‰ï¼‰ã€‚
3. **å€åˆ†åƒè€ƒèˆ‡æ­£æ–‡**ï¼šä¸‹æ–¹çš„ã€åƒè€ƒè³‡æ–™ã€‘åƒ…ä¾›åƒè€ƒï¼Œè«‹åªå°ã€å¾…è©•æ ¸å­¸ç”Ÿæ–‡ç« ã€‘é€²è¡Œè©•åˆ†ã€‚
4. **æ ¼å¼åš´æ ¼**ï¼šåš´æ ¼éµå®ˆ JSON/XML è¼¸å‡ºæ ¼å¼ï¼Œä¸è¦è¼¸å‡ºå…¶ä»–æ–‡å­—ã€‚
5. **é–±å·å“¡é¢¨æ ¼**ï¼šè«‹åš´æ ¼æ ¹æ“šå¾Œç«¯ç³»çµ±æŒ‡ç¤ºçš„ã€é–±å·å“¡ç‰¹å®šè©•åˆ†å–å‘ã€‘é€²è¡Œè©•åˆ†åŠæ’°å¯«é»è©•ï¼Œå‹™å¿…é«”ç¾è©²é–±å·å“¡é‡è¦–çš„ç‰¹é»ã€‚

${ragReference ? ragReference : "(æœ¬æ¬¡æœªæª¢ç´¢åˆ°åƒè€ƒç¯„æ–‡)"}

=== ğŸ“ å¾…è©•æ ¸å­¸ç”Ÿæ–‡ç«  (Target Student Essay) ===
${content}
`;

        // â˜… å»ºæ§‹ Payload
        const payload = {
            action: "grade_argument",
            data: {
                subType: "writing", 
                isFullReview: isFullReview,
                topic: topic,
                content: finalPromptContent, // å‚³é€çµ„åˆå¥½çš„ Prompt
                reviewer: document.getElementById('argumentReviewer').value, // å¾Œç«¯æœƒæ ¹æ“šæ­¤ ID è®€å–è¨­å®š
                tone: tone,
                selectedScopes: selectedScopes
            }
        };
        
        // è­°è«–æ–‡é€šå¸¸ä½¿ç”¨ Reading API (DeepSeek) è™•ç†è¤‡é›œé‚è¼¯
        const response = await callReadingAPI(payload, 0); 
        
        currentContextContent = content;
        currentContextReview = response;

        if (isFullReview) {
            await displayFullCommentWithGrading('argumentGradingResult', response, null, 'argument', content);
        } else {
            // èšç„¦é»è©•è™•ç†
            const critiqueMatch = response.match(/<critique>([\s\S]*?)<\/critique>/);
            const suggestionsMatch = response.match(/<suggestions>([\s\S]*?)<\/suggestions>/);
            let initialReviewHTML = `<h3>${currentReviewerName}èšç„¦é»è©•ï¼š</h3>`;
            if (critiqueMatch?.[1]) initialReviewHTML += createBulletedListHTML("é»è©•", critiqueMatch[1].trim());
            if (suggestionsMatch?.[1]) initialReviewHTML += createBulletedListHTML("å»ºè­°", suggestionsMatch[1].trim());
            if (!critiqueMatch && !suggestionsMatch) initialReviewHTML += "<p>æŠ±æ­‰ï¼Œç„¡æ³•ç”Ÿæˆé»è©•ã€‚</p>";
            
            initialReviewHTML += getCanvasChatHTML('argument_writing');
            openResultCanvas("èšç„¦é»è©•çµæœ");
            document.getElementById("resultCanvasBody").innerHTML = initialReviewHTML;
            
            const htmlToSave = captureContainerHTML('resultCanvasBody'); 
            saveToHistory("è­°è«–", "æ–‡ç« é»è©•", topic || "ç„¡é¡Œç›®", `é¡Œç›®ï¼š${topic}\n\næ–‡ç« ï¼š${content}\n(èšç„¦é»è©•ï¼š${selectedScopes.join("ã€")})`, htmlToSave);
        }

    } catch (error) {
        console.error("æäº¤æ–‡ç« æ™‚å‡ºéŒ¯:", error);
        alert("é»è©•ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
    } finally {
        submitBtn.disabled = false;
        hideLoading();
    }
}

// =========================================
// === [ä¿®å¾©] è­°è«–æ–‡å¤§ç¶±æäº¤ (æ­·å²ç´€éŒ„åªé¡¯ç¤ºé¡Œç›®) ===
// =========================================
async function submitArgumentOutline() {
    const submitBtn = document.getElementById('submitArgumentOutlineBtn');
    submitBtn.disabled = true;
    hideAllSaveHtmlButtons();

    try {
        const topic = localStorage.getItem("argumentCurrentTopic");
        if (!topic) { alert("è«‹å…ˆè¨­å®šé¡Œç›®"); submitBtn.disabled = false; return; }

        // æ”¶é›†ç”¨æˆ¶è¼¸å…¥çš„å¤§ç¶±æ•¸æ“š
        const table = document.getElementById("argumentOutlineTable");
        const rows = table.rows;
        const outlineData = [];
        
        // æ§‹å»ºçµ¦ AI è®€çš„ä¸Šä¸‹æ–‡ (åŒ…å«è©³ç´°å…§å®¹)
        let readableContext = `é¡Œç›®ï¼š${topic}\n\n`;
        
        // å¾ç¬¬äºŒè¡Œé–‹å§‹ (è·³éè¡¨é ­)
        for (let i = 1; i < rows.length; i++) {
            const part = rows[i].cells[0].innerText.trim();
            const point = rows[i].cells[1].querySelector("textarea")?.value.trim() || "";
            const evidence = rows[i].cells[2].querySelector("textarea")?.value.trim() || "";
            
            outlineData.push({ part, point, evidence });
            
            // ç´¯åŠ åˆ°ä¸Šä¸‹æ–‡æ–‡å­— (çµ¦èŠå¤©å®¤ç”¨)
            if(point || evidence) {
                readableContext += `ã€${part}ã€‘\nè«–é»ï¼š${point}\nè«–æ“šï¼š${evidence}\n\n`;
            }
        }

        showLoading("é™³SIR æ­£åœ¨å¯©è¦–å¤§ç¶±...");

        const payload = {
            action: "grade_argument",
            data: {
                subType: "outline",
                topic: topic,
                outlineData: outlineData, 
                tone: document.getElementById("argumentOutlineTone").value
            }
        };
        
        const response = await callAPI(payload, 0);
        
        // è¨­å®šèŠå¤©å®¤ä¸Šä¸‹æ–‡ (é€™æ˜¯è©³ç´°ç‰ˆï¼Œçµ¦ AI çœ‹çš„)
        currentContextContent = readableContext;
        currentContextReview = response;

        // é¡¯ç¤ºçµæœ
        displayArgumentOutlineComment(response, outlineData);
        
        // å„²å­˜åˆ°æ­·å²ç´€éŒ„
        const htmlToSave = document.getElementById("resultCanvasBody").innerHTML;
        
        // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šå­˜å…¥æ­·å²ç´€éŒ„çš„ User Content åªåŒ…å«é¡Œç›® â˜…â˜…â˜…
        // é€™è£¡å‚³å…¥ `é¡Œç›®ï¼š${topic}`ï¼Œè€Œä¸æ˜¯ `readableContext`
        await saveToHistory("è­°è«–", "å¤§ç¶±é»è©•", topic, `é¡Œç›®ï¼š${topic}`, htmlToSave);

    } catch (error) {
        console.error("æäº¤å¤§ç¶±å¤±æ•—", error);
        alert("ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
    } finally {
        submitBtn.disabled = false;
        hideLoading();
    }
}

// 2. [æ ¸å¿ƒä¿®å¾©] è­°è«–æ–‡å¤§ç¶±è§£æèˆ‡é¡¯ç¤ºå‡½å¼
// 2. [æ ¸å¿ƒä¿®å¾©] è­°è«–æ–‡å¤§ç¶±è§£æèˆ‡é¡¯ç¤ºå‡½å¼ (å·²ç§»é™¤ç´…ç¶ è‰²æ¨£å¼)
function displayArgumentOutlineComment(response, inputData) {
    console.log("[Argument Outline] Raw Response:", response);

    // --- A. åˆ‡å‰²å›æ‡‰å€å¡Š ---
    // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼å°‹æ‰¾åˆ†éš”ç·šï¼Œå®¹è¨±å‰å¾Œæœ‰ç©ºæ ¼
    const sections = response.split(/===\s*(.+?)\s*===/).filter(s => s.trim());
    
    let commentPart = "";
    let rewritePart = "";
    let explanationPart = "";

    // å°‹æ‰¾å°æ‡‰çš„å…§å®¹å€å¡Š
    for (let i = 0; i < sections.length; i++) {
        if (sections[i].includes("é»è©•åŠå»ºè­°")) commentPart = sections[i + 1] || "";
        if (sections[i].includes("æ”¹å¯«å¾Œçš„å¤§ç¶±")) rewritePart = sections[i + 1] || "";
        if (sections[i].includes("æ”¹å¯«èªªæ˜")) explanationPart = sections[i + 1] || "";
    }

    // --- B. è§£æã€Œé»è©•åŠå»ºè­°ã€ ---
    const comments = {};
    const commentRegex = /\[(.+?)\][\s\S]*?é»è©•\s*[ï¼š:]\s*([\s\S]+?)(?=\s*å»ºè­°\s*[ï¼š:]|\s*\[|$)/g;
    const suggestionRegex = /\[(.+?)\][\s\S]*?å»ºè­°\s*[ï¼š:]\s*([\s\S]+?)(?=\s*\[|$)/g;
    
    let match;
    while ((match = commentRegex.exec(commentPart)) !== null) {
        const part = match[1].trim();
        comments[part] = comments[part] || {};
        comments[part].comment = match[2].trim();
    }
    while ((match = suggestionRegex.exec(commentPart)) !== null) {
        const part = match[1].trim();
        comments[part] = comments[part] || {};
        comments[part].suggestion = match[2].trim();
    }

    // --- C. è§£æã€Œæ”¹å¯«å¾Œçš„å¤§ç¶±ã€ ---
    const rewrites = {};
    const pointRegex = /\[(.+?)\][\s\S]*?è«–é»\s*[ï¼š:]\s*([\s\S]+?)(?=\s*è«–æ“šåŠè«–è­‰\s*[ï¼š:]|\s*\[|$)/g;
    const evidenceRegex = /\[(.+?)\][\s\S]*?è«–æ“šåŠè«–è­‰\s*[ï¼š:]\s*([\s\S]+?)(?=\s*\[|$)/g;
    
    while ((match = pointRegex.exec(rewritePart)) !== null) {
        const part = match[1].trim();
        rewrites[part] = rewrites[part] || {};
        rewrites[part].point = match[2].trim();
    }
    while ((match = evidenceRegex.exec(rewritePart)) !== null) {
        const part = match[1].trim();
        rewrites[part] = rewrites[part] || {};
        rewrites[part].evidence = match[2].trim();
    }

    // --- D. ç”Ÿæˆ HTML è¡¨æ ¼ 1 (åŸç¨¿ + é»è©•) ---
    // [ä¿®æ”¹é»] é€™è£¡ç§»é™¤äº†é¡è‰²æ¨£å¼ï¼Œä¸¦çµ±ä¸€åŠ ä¸Šé‚Šæ¡†æ¨£å¼ï¼Œç¢ºä¿è¡¨æ ¼æ•´é½Š
    const cellStyle = "border:1px solid #ccc; padding:10px; vertical-align:top; line-height:1.6;";
    
    let commentTableHTML = `
        <h3>é™³SIRé»è©•åŠå»ºè­°ï¼š</h3>
        <div class="table-container">
            <table id="argumentCommentTable" style="width:100%; border-collapse: collapse;">
                <tr>
                    <th style="width:10%; border:1px solid #ccc; padding:8px; background:#2A9689; color:white;">éƒ¨ä»½</th>
                    <th style="width:20%; border:1px solid #ccc; padding:8px; background:#2A9689; color:white;">åŸæœ‰è«–é»</th>
                    <th style="width:20%; border:1px solid #ccc; padding:8px; background:#2A9689; color:white;">åŸæœ‰è«–æ“š</th>
                    <th style="width:25%; border:1px solid #ccc; padding:8px; background:#2A9689; color:white;">é»è©•</th>
                    <th style="width:25%; border:1px solid #ccc; padding:8px; background:#2A9689; color:white;">å»ºè­°</th>
                </tr>`;
                
    inputData.forEach(item => {
        const partKey = Object.keys(comments).find(k => k.includes(item.part) || item.part.includes(k)) || item.part;
        const data = comments[partKey] || {};
        
        commentTableHTML += `
            <tr>
                <td style="${cellStyle} background-color:#f9f9f9;"><strong>${item.part}</strong></td>
                <td style="${cellStyle}">${item.point || "(ç„¡)"}</td>
                <td style="${cellStyle}">${item.evidence || "(ç„¡)"}</td>
                <td style="${cellStyle}">${(data.comment || "ç„¡é»è©•").replace(/\n/g, '<br>')}</td>
                <td style="${cellStyle}">${(data.suggestion || "ç„¡å»ºè­°").replace(/\n/g, '<br>')}</td>
            </tr>`;
    });
    commentTableHTML += "</table></div>";

    // --- E. ç”Ÿæˆ HTML è¡¨æ ¼ 2 (æ”¹å¯«åƒè€ƒ) ---
    let rewriteTableHTML = `
        <h3 style="margin-top:30px;">æ”¹å¯«å¾Œçš„å¤§ç¶±åƒè€ƒï¼š</h3>
        <div class="table-container">
            <table id="argumentRewriteTable" style="width:100%; border-collapse: collapse;">
                <tr>
                    <th style="width:10%; border:1px solid #ccc; padding:8px; background:#2A9689; color:white;">éƒ¨ä»½</th>
                    <th style="width:45%; border:1px solid #ccc; padding:8px; background:#2A9689; color:white;">æ”¹å¯«è«–é»</th>
                    <th style="width:45%; border:1px solid #ccc; padding:8px; background:#2A9689; color:white;">æ”¹å¯«è«–æ“šåŠè«–è­‰</th>
                </tr>`;
                
    inputData.forEach(item => {
        const partKey = Object.keys(rewrites).find(k => k.includes(item.part) || item.part.includes(k)) || item.part;
        const data = rewrites[partKey] || {};
        
        rewriteTableHTML += `
            <tr>
                <td style="${cellStyle} background-color:#f9f9f9;"><strong>${item.part}</strong></td>
                <td style="${cellStyle}">${(data.point || "...").replace(/\n/g, '<br>')}</td>
                <td style="${cellStyle}">${(data.evidence || "...").replace(/\n/g, '<br>')}</td>
            </tr>`;
    });
    rewriteTableHTML += "</table></div>";

    // --- F. ç”Ÿæˆæ”¹å¯«èªªæ˜ ---
    let explanationHTML = '';
    if (explanationPart.trim()) {
        explanationHTML = createBulletedListHTML("æ”¹å¯«èªªæ˜", explanationPart.trim());
    }

    // --- G. çµ„åˆä¸¦é¡¯ç¤º ---
    const finalHTML = commentTableHTML + rewriteTableHTML + explanationHTML + getCanvasChatHTML('argument_outline');
    
    openResultCanvas("è­°è«–æ–‡å¤§ç¶±é»è©•");
    document.getElementById("resultCanvasBody").innerHTML = finalHTML;
}


	

// ã€æ–°å¢ã€‘ç”¨æ–¼å„²å­˜è§£é¡ŒæŒ‡å¼•å°è©±çš„ä¸Šä¸‹æ–‡
let currentGuideTopic = '';
let currentGuideAnalysis = '';
let writingGuideChatHistoryData = [];
	
// ã€æ–°å¢ã€‘ç”¨æ–¼å„²å­˜æ–‡ç« é»è©•å°è©±çš„ä¸Šä¸‹æ–‡

// ã€æ–°å¢ã€‘ç”¨æ–¼å„²å­˜æ–‡ç« é»è©•å°è©±çš„ä¸Šä¸‹æ–‡
let currentWritingArticle = '';
let currentWritingReview = '';
let writingChatHistoryData = [];

// ======= è«‹åœ¨é€™è£¡åŠ å…¥ä»¥ä¸‹ç¨‹å¼ç¢¼ =======
// ã€æ–°å¢ã€‘ç”¨æ–¼å„²å­˜è­°è«–æ–‡é»è©•å°è©±çš„ä¸Šä¸‹æ–‡
let currentArgumentArticle = '';
let currentArgumentReview = '';
let argumentChatHistoryData = [];





// ã€æ–°å¢ã€‘è™•ç†è­°è«–æ–‡ã€Œé»è©•ç¯„ç–‡ã€ä¸­ã€Œå…¨éƒ¨ã€è¤‡é¸æ¡†çš„é‚è¼¯
function handleArgumentAllScopeChange(checkbox) {
    const container = checkbox.closest('div');
    const otherCheckboxes = container.querySelectorAll('input[name="argumentReviewScope"]:not([value="å…¨éƒ¨"])');
    if (checkbox.checked) {
        otherCheckboxes.forEach(cb => {
            cb.checked = false;
            cb.disabled = true;
        });
    } else {
        otherCheckboxes.forEach(cb => {
            cb.disabled = false;
        });
    }
}
// ======= åŠ å…¥çµæŸ =======

// ã€æ–°å¢ã€‘ç”¨æ–¼å„²å­˜ç•¶å‰é–±å·å“¡çš„å§“å
let currentReviewerName = "é™³SIR"; // é è¨­ç‚ºé™³SIR

// ã€æ–°å¢ã€‘è™•ç†ã€Œé»è©•ç¯„ç–‡ã€ä¸­ã€Œå…¨éƒ¨ã€è¤‡é¸æ¡†çš„é‚è¼¯
function handleAllScopeChange(checkbox) {
    const container = checkbox.closest('div');
    const otherCheckboxes = container.querySelectorAll('input[name="reviewScope"]:not([value="å…¨éƒ¨"])');
    if (checkbox.checked) {
        otherCheckboxes.forEach(cb => {
            cb.checked = false;
            cb.disabled = true;
        });
    } else {
        otherCheckboxes.forEach(cb => {
            cb.disabled = false;
        });
    }
}



// â˜…â˜…â˜… æ–°å¢ï¼šçµ±ä¸€è™•ç† Log é¡è‰²çš„è¼”åŠ©å‡½æ•¸ â˜…â˜…â˜…
// â˜…â˜…â˜… ä¿®æ”¹å¾Œçš„ Log å‡½å¼ (æ”¯æ´ GAS å›å‚³æ ¼å¼) â˜…â˜…â˜…
function logProviderInfo(dataOrResponse, apiName) {
    let provider = null;
    let debugTraceStr = null;

    // åˆ¤æ–·å‚³å…¥çš„æ˜¯ Response ç‰©ä»¶(èˆŠç‰ˆ/Worker) é‚„æ˜¯ Data ç‰©ä»¶(æ–°ç‰ˆ/GAS)
    if (dataOrResponse.headers && typeof dataOrResponse.headers.get === 'function') {
        // èˆŠç‰ˆé‚è¼¯ (ä¿ç•™ä»¥é˜²è¬ä¸€)
        provider = dataOrResponse.headers.get('X-Provider-Log');
        debugTraceStr = dataOrResponse.headers.get('X-Debug-Trace');
    } else if (dataOrResponse._provider_log) {
        // â˜… æ–°ç‰ˆ GAS é‚è¼¯ï¼šå¾ JSON å…§å®¹è®€å– â˜…
        provider = dataOrResponse._provider_log;
        // å¦‚æœä½ æœ‰å‚³å› trace ä¹Ÿå¯ä»¥åœ¨é€™è£¡è®€å–
    }

    // 1. é¡¯ç¤ºå¤±æ•—çš„å˜—è©¦ (å¦‚æœæœ‰)
    if (debugTraceStr) {
        try {
            const traces = JSON.parse(debugTraceStr);
            traces.forEach(trace => {
                console.log(`%c[${apiName} Fail] ${trace}`, "color: #ffeb3b; background: #333; padding: 2px 5px;");
            });
        } catch(e) {}
    }

    // 2. é¡¯ç¤ºæˆåŠŸçš„èª¿ç”¨ (é¡è‰²è¨­å®šèˆ‡åŸç‰ˆä¸€è‡´)
    if (provider) {
        if (provider.includes("OFFICIAL DEEPSEEK")) {
            // å®˜æ–¹ DeepSeekï¼šæ©™ç´…é¢¨æ ¼
            console.log(`%cğŸš€ [${apiName}] SUCCESS via ${provider}`, "color: #fff; background: #e64a19; padding: 4px 8px; border-radius: 4px; font-weight: bold;");
        } else {
            // Pollinationsï¼šè—ç¶ é¢¨æ ¼
            console.log(`%cğŸŒ¿ [${apiName}] SUCCESS via ${provider}`, "color: #fff; background: #009688; padding: 4px 8px; border-radius: 4px; font-weight: bold;");
        }
    }
}

// ------------------------------------------------------------------

// ==========================================
// === API å‘¼å«æ ¸å¿ƒå‡½å¼ (ä¿®è¨‚ç‰ˆï¼šæ”¯æ´ Action) ===
// ==========================================

// 1. é€šç”¨ API (Gemini) - å®‰å…¨ç‰ˆ
async function callAPI(input, temperature = null) {
    // ç²å–ç•¶å‰ç™»å…¥ä½¿ç”¨è€…
    const user = firebase.auth().currentUser;
    
    // å¦‚æœæœªç™»å…¥ï¼Œç›´æ¥æ‹‹å‡ºéŒ¯èª¤ï¼Œå®Œå…¨ä¸ç™¼é€è«‹æ±‚
    if (!user) {
        // è§¸ç™¼ç™»å…¥è¦–çª—
        document.getElementById('loginRequiredModal').style.display = 'flex';
        throw new Error("è«‹å…ˆç™»å…¥å­¸æ ¡å¸³è™Ÿ (Client blocked)");
    }

    // ç²å–æœ€æ–°çš„ ID Token
    const token = await user.getIdToken();

    const TIMEOUT_MS = 100000;
    const controller = new AbortController();
    globalAbortController = controller;
    const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);
 
    try {
        let requestBody = {};
 
        if (typeof input === 'string') {
            requestBody = {
                token: token, // â˜… åŠ å…¥ Token
                model: MODEL,
                messages: [{ role: "user", content: input }],
                max_tokens: 8000
            };
        } else if (typeof input === 'object' && input.action) {
            requestBody = {
                token: token, // â˜… åŠ å…¥ Token
                model: MODEL,
                action: input.action,
                data: input.data,
                max_tokens: 8000
            };
        }
 
        if (temperature !== null) {
            requestBody.temperature = temperature;
        }
 
        const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(requestBody),
            signal: controller.signal
        });
 
        clearTimeout(timeoutId);
 
        if (!response.ok) {
            throw new Error(`API èª¿ç”¨å¤±æ•—: ${response.status}`);
        }
 
        const data = await response.json();

        // å¦‚æœå¾Œç«¯é©—è­‰å¤±æ•—å›å‚³éŒ¯èª¤
        if (data.error && data.error.includes("Unauthorized")) {
            throw new Error(data.error);
        }

        logProviderInfo(data, "Gemini API");

        if (!data.choices || data.choices.length === 0) {
             throw new Error("API å›å‚³æ ¼å¼ç•°å¸¸");
        }
 
        let content = data.choices[0].message.content.trim();
        return content.replace(/<think\s*>.*?<\/think\s*>|<think\s*\/>|<think\s*>|<\/think\s*>/gis, '').trim();
 
    } catch (error) {
        clearTimeout(timeoutId);
        console.error("callAPI Error:", error);
        throw error;
    }
}
 
// 2. é–±è®€å°ˆç”¨ API (DeepSeek) - å®‰å…¨ç‰ˆ
async function callReadingAPI(input, temperature = null) {
    const user = firebase.auth().currentUser;
    if (!user) {
        document.getElementById('loginRequiredModal').style.display = 'flex';
        throw new Error("è«‹å…ˆç™»å…¥å­¸æ ¡å¸³è™Ÿ (Client blocked)");
    }
    const token = await user.getIdToken();
 
    const TIMEOUT_MS = 100000;
    const controller = new AbortController();
    globalAbortController = controller;
    const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);
 
    try {
        let requestBody = {};
 
        if (typeof input === 'string') {
            requestBody = {
                token: token, // â˜… åŠ å…¥ Token
                model: READING_MODEL,
                messages: [{ role: "user", content: input }],
                max_tokens: 4000
            };
        } else if (typeof input === 'object' && input.action) {
            requestBody = {
                token: token, // â˜… åŠ å…¥ Token
                model: READING_MODEL,
                action: input.action,
                data: input.data,
                max_tokens: 4000
            };
        }
 
        if (temperature !== null) {
            requestBody.temperature = temperature;
        }
 
        const response = await fetch(READING_API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(requestBody),
            signal: controller.signal
        });
 
        clearTimeout(timeoutId);
 
        if (!response.ok) {
            throw new Error(`é–±è®€ API èª¿ç”¨å¤±æ•—: ${response.status}`);
        }
 
        const data = await response.json();

        if (data.error && data.error.includes("Unauthorized")) {
            throw new Error(data.error);
        }

        logProviderInfo(data, "Reading API");

        let content = data.choices[0].message.content.trim();
        return content.replace(/<think\s*>.*?<\/think\s*>|<think\s*\/>|<think\s*>|<\/think\s*>/gis, '').trim();
 
    } catch (error) {
        clearTimeout(timeoutId);
        console.error("callReadingAPI Error:", error);
        throw error;
    }
}
 
// 3. é©—è­‰å°ˆç”¨ API (Llama3) - å®‰å…¨ç‰ˆ
async function callLlama3API(input, temperature = null) {
    const user = firebase.auth().currentUser;
    if (!user) {
        // Llama3 é€šå¸¸æ˜¯èƒŒæ™¯èª¿ç”¨ï¼Œé€™è£¡ç›´æ¥æ‹‹éŒ¯å³å¯
        throw new Error("è«‹å…ˆç™»å…¥å­¸æ ¡å¸³è™Ÿ (Client blocked)");
    }
    const token = await user.getIdToken();

    const TIMEOUT_MS = 100000;
    const controller = new AbortController();
    globalAbortController = controller;
    const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);
 
    try {
        let requestBody = {};
 
        if (typeof input === 'object' && input.action) {
            requestBody = {
                token: token, // â˜… åŠ å…¥ Token
                model: LLAMA3_MODEL,
                action: input.action,
                data: input.data,     
                max_tokens: 8000
            };
        } else if (typeof input === 'string') {
             requestBody = {
                token: token, // â˜… åŠ å…¥ Token
                model: LLAMA3_MODEL,
                messages: [{ role: "user", content: input }],
                max_tokens: 8000
            };
        }
 
        if (temperature !== null) {
            requestBody.temperature = temperature;
        }
 
        const response = await fetch(LLAMA3_API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(requestBody),
            signal: controller.signal
        });
 
        clearTimeout(timeoutId);
 
        if (!response.ok) {
            throw new Error(`é©—è­‰ API èª¿ç”¨å¤±æ•—: ${response.status}`);
        }
 
        const data = await response.json();

        if (data.error && data.error.includes("Unauthorized")) {
            throw new Error(data.error);
        }

        logProviderInfo(data, "Llama3 API");

        let content = data.choices[0].message.content.trim();
        return content.replace(/<think\s*>.*?<\/think\s*>|<think\s*\/>|<think\s*>|<\/think\s*>/gis, '').trim();
 
    } catch (error) {
        clearTimeout(timeoutId);
        console.error("callLlama3API Error:", error);
        throw error;
    }
}



// ==========================================
// === [æ–°å¢] è²“å’ªå°è©±å°ˆç”¨ API (Gemini Fast) ===
// ==========================================
async function callCatAPI(input, temperature = null) {
    const user = firebase.auth().currentUser;
    // å¦‚æœæœªç™»å…¥ï¼Œä¸é˜»æ“‹è²“å’ªè³£èŒï¼Œä½†å¾Œç«¯å¯èƒ½æœƒæ“‹ï¼Œé€™è£¡ä¿ç•™åŸºæœ¬æª¢æŸ¥
    if (!user) {
        // å¦‚æœä½ å¸Œæœ›è¨ªå®¢ä¹Ÿèƒ½ç©è²“ï¼Œå¯ä»¥è¨»è§£æ‰ä¸‹é¢é€™è¡Œï¼›å¦‚æœè¦å¼·åˆ¶ç™»å…¥å‰‡ä¿ç•™
        // document.getElementById('loginRequiredModal').style.display = 'flex';
        // throw new Error("è«‹å…ˆç™»å…¥å­¸æ ¡å¸³è™Ÿ (Client blocked)");
    }
    
    const token = user ? await user.getIdToken() : null;

    const TIMEOUT_MS = 60000; // è²“å’ªå°è©±å¯ä»¥å¿«ä¸€é»ï¼Œè¨­ 60 ç§’è¶…æ™‚
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);
 
    try {
        let requestBody = {};
 
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå¼·åˆ¶é–å®šæ¨¡å‹ç‚º gemini-fast â˜…â˜…â˜…
        if (typeof input === 'string') {
            requestBody = {
                token: token,
                model: "grok", // æŒ‡å®šåç¨±ï¼Œçµ•å°ä¸æ”¹
                messages: [{ role: "user", content: input }],
                max_tokens: 1000 // è²“å’ªèªªè©±çŸ­ï¼Œä¸éœ€è¦å¤ªå¤§
            };
        }
 
        if (temperature !== null) {
            requestBody.temperature = temperature;
        }
 
        // ä½¿ç”¨èˆ‡åŸæœ¬ç›¸åŒçš„ API_URL (Worker ç¶²å€)
        const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(requestBody),
            signal: controller.signal
        });
 
        clearTimeout(timeoutId);
 
        if (!response.ok) {
            throw new Error(`Cat API èª¿ç”¨å¤±æ•—: ${response.status}`);
        }
 
        const data = await response.json();

        if (data.error && data.error.includes("Unauthorized")) {
            throw new Error(data.error);
        }

        // é€™è£¡ä¸å‘¼å« logProviderInfo ä»¥å…æ´—ç‰ˆ Console
        // logProviderInfo(data, "Cat API");

        if (!data.choices || data.choices.length === 0) {
             throw new Error("API å›å‚³æ ¼å¼ç•°å¸¸");
        }
 
        let content = data.choices[0].message.content.trim();
        // æ¸…ç†å¯èƒ½å‡ºç¾çš„æ€ç¶­éˆæ¨™ç±¤
        return content.replace(/<think\s*>.*?<\/think\s*>|<think\s*\/>|<think\s*>|<\/think\s*>/gis, '').trim();
 
    } catch (error) {
        clearTimeout(timeoutId);
        console.error("callCatAPI Error:", error);
        throw error;
    }
}


	

/**
 * ã€å…¨æ–°å‡½å¼ã€‘æ‡‰ç”¨ Llama-3 é©—è­‰æ¨¡å‹çš„å…§å®¹èˆ‡çµæ§‹åˆ†æ•¸å·®è·è¦å‰‡ã€‚
 * è¦å‰‡ï¼šå…§å®¹åˆ†å’Œçµæ§‹åˆ†çš„åˆ†å·®å€¼ä¸èƒ½é«˜æ–¼1åˆ†ã€‚
 * åŸ·è¡Œæ–¹å¼ï¼šå¦‚æœåˆ†å·®å¤§æ–¼1ï¼Œå‰‡å°‡è¼ƒé«˜çš„åˆ†æ•¸ä¸‹èª¿è‡³ã€Œè¼ƒä½åˆ†+1ã€ã€‚
 * @param {object} scores - å¾ Llama-3 æ¨¡å‹è§£æå‡ºçš„åŸå§‹è©•åˆ†ç‰©ä»¶ã€‚
 * @returns {object} - ç¶“éè¦å‰‡èª¿æ•´å¾Œçš„è©•åˆ†ç‰©ä»¶ã€‚
 */
const applyContentStructureRule = (scores) => {
    // å»ºç«‹ä¸€å€‹åˆ†æ•¸ç‰©ä»¶çš„æ·±å±¤è¤‡æœ¬ï¼Œé¿å…å½±éŸ¿åŸå§‹æ•¸æ“š
    let s = JSON.parse(JSON.stringify(scores));

    // æª¢æŸ¥ content å’Œ structure åˆ†æ•¸æ˜¯å¦å­˜åœ¨
    if (s.content !== undefined && s.structure !== undefined) {
        const contentScore = s.content;
        const structureScore = s.structure;
        const difference = Math.abs(contentScore - structureScore);

        // å¦‚æœåˆ†æ•¸å·®è·å¤§æ–¼ 1ï¼Œå‰‡è§¸ç™¼èª¿æ•´æ©Ÿåˆ¶
        if (difference > 1) {
            console.log(`è§¸ç™¼ Llama-3 å…§å®¹/çµæ§‹åˆ†å·®å€¼è¦å‰‡ï¼šå…§å®¹=${contentScore}, çµæ§‹=${structureScore}, å·®å€¼=${difference}`);
            
            // åˆ¤æ–·å“ªå€‹åˆ†æ•¸è¼ƒé«˜ï¼Œä¸¦å°‡å…¶ä¸‹èª¿
            if (contentScore > structureScore) {
                s.content = structureScore + 1; // å°‡å…§å®¹åˆ†ä¸‹èª¿è‡³ã€Œçµæ§‹åˆ†+1ã€
                console.log(`èª¿æ•´å¾Œå…§å®¹åˆ†æ•¸: ${s.content}`);
            } else { // structureScore > contentScore
                s.structure = contentScore + 1; // å°‡çµæ§‹åˆ†ä¸‹èª¿è‡³ã€Œå…§å®¹åˆ†+1ã€
                console.log(`èª¿æ•´å¾Œçµæ§‹åˆ†æ•¸: ${s.structure}`);
            }
        }
    }
    // è¿”å›èª¿æ•´å¾Œï¼ˆæˆ–ç„¡éœ€èª¿æ•´ï¼‰çš„åˆ†æ•¸ç‰©ä»¶
    return s;
};




/**
* Creates a beautiful bulleted list HTML from raw text content.
* @param {string} title - The title for the card (e.g., 'é»è©•', 'å»ºè­°').
* @param {string} rawContent - The raw text content.
* @returns {string} - The formatted HTML string.
*/
function createBulletedListHTML(title, rawContent) {
    // â˜…â˜…â˜… ä¿®æ”¹ 1ï¼šå¼·åˆ¶ç°¡è½‰ç¹ (ä½¿ç”¨ OpenCC) â˜…â˜…â˜…
    if (typeof OpenCC !== 'undefined') {
        try {
            const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
            rawContent = converter(rawContent);
        } catch (e) {
            console.error("[OpenCC] è½‰æ›å¤±æ•—:", e);
        }
    }

    // â˜…â˜…â˜… ä¿®æ”¹ 2ï¼šç§»é™¤ Markdown æ˜Ÿè™Ÿ (*) â˜…â˜…â˜…
    rawContent = rawContent.replace(/\*/g, '');

    // â˜…â˜…â˜… ä¿®æ”¹ 3 (æ–°)ï¼šå°‡è‹±æ–‡å¼•è™Ÿ "" æˆ– â€œâ€ è½‰ç‚ºä¸­æ–‡ ã€Œã€ â˜…â˜…â˜…
    // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æ•æ‰å¼•è™Ÿå…§çš„å…§å®¹ä¸¦æ›¿æ›
    rawContent = rawContent.replace(/["â€œ](.*?)["â€]/g, 'ã€Œ$1ã€');

    // å˜—è©¦åˆ†å‰²åˆ—é»
    let points = rawContent.split(/\s*(?=\d+\.\s*)/).map(p => p.trim()).filter(p => p);

    // å¦‚æœæ²’æœ‰æ•¸å­—ç·¨è™Ÿï¼Œå˜—è©¦ç”¨æ›è¡Œç¬¦è™Ÿåˆ†å‰²
    if (points.length <= 1 && rawContent.includes('\n')) {
        const newlinePoints = rawContent.split('\n').map(p => p.trim()).filter(p => p);
        if (newlinePoints.length > 1) {
            points = newlinePoints;
        }
    }

    // å¦‚æœå®Œå…¨ç„¡æ³•åˆ†å‰²ï¼Œç›´æ¥é¡¯ç¤º
    if (points.length === 0) {
        // æ¸…ç†å–®æ®µæ–‡å­—çš„å†’è™Ÿå‰ç¶´
        let cleanSingleText = rawContent.replace(/^[^ï¼š:\n]*[ï¼š:]\s*/, '');
        
        return `<div class="rewrite-explanation-container">
            <div class="rewrite-explanation-card">
            <h3>${title}</h3>
            <div class="explanation-text">${cleanSingleText.replace(/\n/g, '<br>')}</div>
            </div>
            </div>`;
    }

    let explanationHTML = `<div class="rewrite-explanation-container">
    <div class="rewrite-explanation-card">
    <h3>${title}</h3>`;

    points.forEach((point, index) => {
        let number = index + 1;
        let text = point;

        // æª¢æŸ¥æ˜¯å¦åŒ…å«æ•¸å­—é–‹é ­ (ä¾‹å¦‚ "1. ")
        const match = point.match(/^(\d+)\.?\s*(.*)$/s);
        if (match) {
            number = match[1]; 
            text = match[2]; 
        }

        // â˜…â˜…â˜… ä¿®æ”¹ 4ï¼šç§»é™¤å…§å®¹ä¸­çš„æ¨™é¡Œ/å‰ç¶´ â˜…â˜…â˜…
        // åˆªé™¤é–‹é ­ç›´åˆ°å†’è™Ÿç‚ºæ­¢çš„å­—å…ƒ (ä¾‹å¦‚ "å„ªé»ï¼šæ–‡ç­†æµæš¢" -> "æ–‡ç­†æµæš¢")
        text = text.replace(/^[^ï¼š:\n]*[ï¼š:]\s*/, '');

        explanationHTML += `<div class="explanation-point">
            <div class="explanation-number">${number}</div>
            <div class="explanation-text">${text.replace(/\n/g, '<br>')}</div>
            </div>`;
    });

    explanationHTML += `</div></div>`;
    return explanationHTML;
}


// åŸ generateTopic() å‡½å¼
// åŸ generateTopic() å‡½å¼ (å·²ä¿®è¨‚ï¼šåªç”Ÿæˆé¡Œç›®ï¼Œä¸èª¿ç”¨ LLM)
function generateTopic(buttonElement) { 
    if (buttonElement) {
        updateButtonActiveState(buttonElement);
    }

    // éš±è—è‡ªè¨‚é¡Œç›®è¼¸å…¥å€ï¼Œç¢ºä¿ä»‹é¢ä¹¾æ·¨
    const customTopicArea = document.getElementById("customTopicArea");
    customTopicArea.style.display = "none";
    customTopicArea.innerHTML = "";

    const topicResult = document.getElementById("topicResult");
    topicResult.style.display = 'block';

    // éš¨æ©ŸæŠ½é¸é¡Œç›®
    let selectedTopic;
    do {
        selectedTopic = topics[Math.floor(Math.random() * topics.length)];
    } while (selectedTopic === lastTopic && topics.length > 1);
    
    lastTopic = selectedTopic;
    localStorage.setItem("lastTopic", lastTopic);

    // ç›´æ¥é¡¯ç¤ºé¡Œç›® (ä¸å€åˆ†å¯«ä½œé¡å‹ï¼Œçµ±ä¸€è™•ç†)
    topicResult.innerHTML = "<strong>" + selectedTopic + "</strong>";
    
    // å„²å­˜ç‹€æ…‹
    localStorage.setItem("currentTopic", selectedTopic);
    
    // é—œéµï¼šæ¸…ç©ºä¹‹å‰çš„é‡é»å’Œæƒ…ç¯€è¨­å®šï¼Œä»¥å…å½±éŸ¿é€™æ¬¡çš„è©•åˆ†
    localStorage.setItem("currentFocus", "");
    localStorage.setItem("currentPlot", "");
}

	
// è¨­å®šè‡ªè¨‚é¡Œç›®ï¼ˆå¯«ä½œï¼‰
function setCustomTopic() {
const writingType = document.getElementById("writingType").value;
const topicResult = document.getElementById("topicResult");

if (writingType === "ç‰‡æ®µæå¯«") {
// ã€æ ¸å¿ƒä¿®è¨‚ã€‘åªæª¢æŸ¥é¡Œç›®æ˜¯å¦å·²è¼¸å…¥
const title = sanitizeHTML(document.getElementById("customTitle").value.trim());
if (!title) {
alert("è«‹è‡³å°‘è¼¸å…¥è‡ªè¨‚é¡Œç›®");
return;
}

// ç²å–ï¼ˆå¯èƒ½æ˜¯ç©ºçš„ï¼‰é‡é»å’Œæƒ…ç¯€
const focus = document.getElementById("customFocus").value.trim();
const plot = document.getElementById("customPlot").value.trim();

// å³ä½¿ focus å’Œ plot æ˜¯ç©ºçš„ï¼Œä¹Ÿæ­£å¸¸ç”Ÿæˆé¡¯ç¤ºè¡¨æ ¼
// é€™æ¨£ä½¿ç”¨è€…å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ä»–å€‘è¼¸å…¥äº†ä»€éº¼ï¼Œæ²’è¼¸å…¥ä»€éº¼
topicResult.innerHTML = `
<strong>${title}</strong>
<table>
<tr><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th></tr>
<tr><td>${focus || '<i>ï¼ˆæœªæä¾›ï¼‰</i>'}</td><td>${plot || '<i>ï¼ˆæœªæä¾›ï¼‰</i>'}</td></tr>
</table>
`;

// å„²å­˜åˆ° localStorageï¼Œç©ºå€¼ä¹Ÿä¸€ä½µå„²å­˜
localStorage.setItem("currentTopic", title);
localStorage.setItem("currentFocus", focus);
localStorage.setItem("currentPlot", plot);

} else { 
const customTopic = sanitizeHTML(document.getElementById("customTopic").value.trim());
if (!customTopic) {
alert("è«‹è¼¸å…¥è‡ªè¨‚é¡Œç›®");
return;
}
topicResult.innerHTML = "<strong>" + customTopic + "</strong>";
localStorage.setItem("currentTopic", customTopic);
}

topicResult.style.display = 'block';

const customTopicArea = document.getElementById("customTopicArea");
customTopicArea.style.display = "none";
customTopicArea.innerHTML = "";
}
// ç”Ÿæˆå¤§ç¶±è¡¨æ ¼
function generateOutlineTable() {
const structure = document.getElementById("structure").value;
let parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];
let tableHTML = "<div class='table-container'><table><tr><th>éƒ¨ä»½</th><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th></tr>";
parts.forEach((part, index) => {
const focusId = structure + "Focus" + (index + 1);
const plotId = structure + "Plot" + (index + 1);
tableHTML += `<tr><td>${part}</td><td><textarea id="${focusId}" rows="3"></textarea></td><td><textarea id="${plotId}" rows="3"></textarea></td></tr>`;
});
tableHTML += "</table></div>";
document.getElementById("outlineTableArea").innerHTML = tableHTML;
}





async function continueWritingGuideDiscussion() {
    const continueBtn = document.getElementById('continueWritingGuideBtn');
    continueBtn.disabled = true;

    const userInputText = sanitizeHTML(document.getElementById("writingGuideUserInput").value.trim());
    if (!userInputText) {
        alert("è«‹è¼¸å…¥æ‚¨çš„å›æ‡‰");
        continueBtn.disabled = false;
        return;
    }
    
    const chatHistoryDiv = document.getElementById('writingGuideChatHistory');
    
    // 1. é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
    const userMessageBubble = document.createElement('div');
    userMessageBubble.className = 'message-bubble user-message';
    userMessageBubble.textContent = userInputText;
    chatHistoryDiv.appendChild(userMessageBubble);
    
    writingGuideChatHistoryData.push({ sender: 'user', message: userInputText });
    document.getElementById("writingGuideUserInput").value = "";
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

    // 2. é¡¯ç¤º AI æ­£åœ¨å›æ‡‰
    const aiMessageBubble = document.createElement('div');
    aiMessageBubble.className = 'message-bubble ai-message';
    aiMessageBubble.textContent = `é™³SIRæ­£åœ¨å›æ‡‰...`;
    chatHistoryDiv.appendChild(aiMessageBubble);
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

    // 3. æº–å‚™ Prompt
    const conversationHistoryForPrompt = writingGuideChatHistoryData.map(item => {
        const role = item.sender === 'user' ? 'å­¸ç”Ÿ' : 'é™³SIR';
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = item.message;
        const cleanMessage = tempDiv.textContent || tempDiv.innerText || "";
        return `${role}: ${cleanMessage}`;
    }).join('\n');

    // å»ºæ§‹ä¸€èˆ¬å°è©±çš„ Prompt
    const prompt = `
    ã€è§’è‰²è¨­å®šã€‘ä½ æ˜¯ä¸€ä½é«˜ä¸­ä¸­æ–‡ç§‘è€å¸«ã€Œé™³SIRã€ã€‚
    ã€èƒŒæ™¯è³‡æ–™ã€‘è§£é¡ŒæŒ‡å¼•å…§å®¹ï¼š${currentGuideAnalysis}
    ã€å°è©±ç´€éŒ„ã€‘${conversationHistoryForPrompt}
    ã€å­¸ç”Ÿè¿½å•ã€‘${userInputText}
    ã€ä»»å‹™ã€‘è«‹é‡å°å­¸ç”Ÿè¿½å•å›æ‡‰ï¼Œç·Šæ‰£å‰›æ‰çš„æŒ‡å¼•ï¼Œå­—æ•¸200å­—ä»¥å…§ã€‚\nã€é‡è¦ã€‘è«‹å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡(Traditional Chinese)å›ç­”ã€‚
    `;

   try {
        // ä½¿ç”¨é€šç”¨ API (Gemini)
        let aiResponse = await callAPI(prompt);
        if (!aiResponse) throw new Error('API å‚³å›ç„¡æ•ˆå›æ‡‰');
        
        // â˜…â˜…â˜… å¼·åˆ¶ç¹é«”åŒ– (OpenCC) â˜…â˜…â˜…
        if (typeof OpenCC !== 'undefined') {
            const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
            aiResponse = converter(aiResponse);
        }

        // â˜…â˜…â˜… å¼·åˆ¶æ›¿æ›å¼•è™Ÿ (å°‡ "" æˆ– â€œâ€ è½‰ç‚º ã€Œã€) â˜…â˜…â˜…
        aiResponse = aiResponse.replace(/["â€œ](.*?)["â€]/g, 'ã€Œ$1ã€');

        let formattedResponse = aiResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formattedResponse = formattedResponse.replace(/\n/g, '<br>');
        aiMessageBubble.innerHTML = formattedResponse;
        
        writingGuideChatHistoryData.push({ sender: 'ai', message: aiResponse });

        // æ›´æ–°æ­·å²ç´€éŒ„
        await updateHistoryChat();

    } catch (error) {
        console.error("ç¹¼çºŒæŒ‡å¼•è¨è«–æ™‚å‡ºéŒ¯:", error);
        aiMessageBubble.textContent = "æŠ±æ­‰ï¼Œå›æ‡‰å¤±æ•—ã€‚";
    } finally {
        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        continueBtn.disabled = false;
    }
}
// ==========================================
// === ä¿®è¨‚ï¼šè§£é¡ŒæŒ‡å¼•æäº¤å‡½æ•¸ (å«è¿½å•èŠå¤©å®¤åŠŸèƒ½) ===
// ==========================================
async function submitWritingGuide() {
    const submitBtn = document.getElementById('submitWritingGuideBtn');
    const inputTopic = document.getElementById('writingGuideTopicInput').value.trim();
    
    // éš±è—é é¢ä¸Šçš„èˆŠå…ƒç´ ï¼Œä»¥å…æ··äº‚
    const resultContainerOnPage = document.getElementById('writingGuideResultContainer');
    if (resultContainerOnPage) resultContainerOnPage.style.display = "none";

    if (!inputTopic) {
        alert("è«‹è¼¸å…¥é¡Œç›®ï¼");
        return;
    }

    submitBtn.disabled = true;
    showLoading("é™³SIR æ­£åœ¨æ‹†è§£é¡Œç›®...");
    
    const prompt = `ä½ æ˜¯ä¸€ä½æ·±è«³ä¸­åœ‹æ–‡å­¸çš„å¯«ä½œé¡§å•ã€‚ä½¿ç”¨è€…è¼¸å…¥é¡Œç›®ï¼šã€Œ${inputTopic}ã€ã€‚

è«‹æ¨¡ä»¿ä»¥ä¸‹ã€ç¤ºä¾‹ã€‘çš„é¢¨æ ¼ã€æ·±åº¦å’Œèªæ°£ï¼Œç‚ºé€™å€‹é¡Œç›®æ’°å¯«ã€Œé¡Œçœ¼åˆ†æã€åŠã€Œå¯«ä½œæ–¹å‘ã€ã€‚
åœ¨ã€Œé¡Œçœ¼åˆ†æã€ï¼Œç”¨èªè¦æ±‚æº–ç¢ºã€ç†æ€§ã€éæ–‡å­¸åŒ–ï¼Œè€Œåœ¨ã€Œå¯«ä½œæ–¹å‘ã€ï¼Œä½ çš„è¼¸å‡ºå¿…é ˆæ–‡å­¸åŒ–ã€æ„Ÿæ€§ã€‚
**åš´ç¦**ä½¿ç”¨ã€Œä½ å¥½ã€ã€ã€Œæˆ‘å€‘ä¾†çœ‹çœ‹ã€ç­‰é–‹å ´ç™½ï¼Œç›´æ¥è¼¸å‡ºå…§å®¹ã€‚
**åš´ç¦**ä½¿ç”¨ 1. 2. 3. ç­‰æ•¸å­—åˆ—è¡¨ï¼Œè«‹åš´æ ¼éµå®ˆä¸‹æ–¹çš„ã€è¼¸å‡ºæ ¼å¼ã€‘æ¨™ç±¤ã€‚

ã€ä»»å‹™è¦æ±‚ã€‘
1. **é¡Œçœ¼åˆ†æ**ï¼š
   - åˆ†æé¡Œçœ¼çš„æ„æ€ï¼Œåšéæ–‡å­¸æ€§ã€è²¼è¿‘æ—¥å¸¸ç”Ÿæ´»çš„é‡‹ç¾©ï¼Œç´„150-200å­—ã€‚
2. **å¯«ä½œæ–¹å‘**ï¼š
   - æä¾› 3 å€‹å…·é«”çš„ã€Œæ•…äº‹ç¨®å­ã€ã€‚
   - æ¯å€‹ç¨®å­åŒ…å«ï¼šæ¨™é¡Œã€æƒ…å¢ƒï¼ˆå…·é«”ç•«é¢ï¼‰ã€å¼µåŠ›ï¼ˆç‚ºä½•æ‰£é€£é¡Œç›®ï¼‰ã€‚

ã€è¼¸å‡ºæ ¼å¼ (è«‹åš´æ ¼éµå®ˆåˆ†éš”ç¬¦)ã€‘
[INTRO]
(é€™è£¡å¡«å¯«é¡Œçœ¼åˆ†æèˆ‡è©èªé—œä¿‚åˆ†æ...)
[SEED]
(æ•…äº‹ç¨®å­æ¨™é¡Œ 1)
æƒ…å¢ƒï¼š(å…·é«”ç•«é¢æè¿°...)
å¼µåŠ›ï¼š(è§£é‡‹ç‚ºä½•æ‰£é¡Œ...)
[SEED]
(æ•…äº‹ç¨®å­æ¨™é¡Œ 2)
æƒ…å¢ƒï¼š(å…·é«”ç•«é¢æè¿°...)
å¼µåŠ›ï¼š(è§£é‡‹ç‚ºä½•æ‰£é¡Œ...)
[SEED]
(æ•…äº‹ç¨®å­æ¨™é¡Œ 3)
æƒ…å¢ƒï¼š(å…·é«”ç•«é¢æè¿°...)
å¼µåŠ›ï¼š(è§£é‡‹ç‚ºä½•æ‰£é¡Œ...)
`;

    try {
        // ä½¿ç”¨é–±è®€å°ˆç”¨ API (é€šå¸¸è¼ƒç©©å®š) æˆ–é€šç”¨ API
        const response = await callReadingAPI(prompt);
        
        // â˜…â˜…â˜… é—œéµï¼šè¨­å®šå…¨åŸŸè®Šæ•¸ï¼Œä¾›ç•«å¸ƒèŠå¤©å®¤çš„ AI è®€å– â˜…â˜…â˜…
        currentContextContent = `é¡Œç›®ï¼š${inputTopic}`; 
        currentContextReview = response; // è®“ AI çŸ¥é“å®ƒå‰›å‰›åˆ†æäº†ä»€éº¼

        // === è§£æé‚è¼¯ ===
        // 1. è§£æ Intro
        let introContent = "";
        const introSplit = response.split('[INTRO]');
        if (introSplit.length > 1) {
            introContent = introSplit[1].split('[SEED]')[0].trim();
        }

        // 2. è§£æ Seeds
        const seedParts = response.split('[SEED]').slice(1).map(p => p.trim());

        // === çµ„è£ HTML ===
        let finalHTML = `<h3>é™³SIR è§£é¡ŒæŒ‡å¼•ï¼š${inputTopic}</h3>`;

        // åŠ å…¥é¡Œçœ¼åˆ†æå€å¡Š
        finalHTML += `
        <div class="guide-section-header" style="border-left: 5px solid #4A90E2; color: #4A90E2;">
            <h3><i class="fas fa-search"></i> é¡Œçœ¼åˆ†æ</h3>
        </div>`;
        
        if (introContent) {
            finalHTML += `<div class="guide-intro-card"><p>${introContent.replace(/\n/g, '<br>')}</p></div>`;
        }

        // åŠ å…¥å¯«ä½œæ–¹å‘å€å¡Š
        finalHTML += `
        <div class="guide-section-header" style="border-left: 5px solid #28a745; color: #28a745; margin-top: 30px;">
            <h3><i class="fas fa-compass"></i> å¯«ä½œæ–¹å‘</h3>
        </div>`;

        if (seedParts.length > 0) {
            finalHTML += `<div class="guide-grid-3">`; // é–‹å§‹ Grid å®¹å™¨
            
            seedParts.forEach(part => {
                const lines = part.split('\n').filter(l => l.trim());
                const title = (lines[0] || "æ•…äº‹ç¨®å­").replace(/\*\*/g, '');
                const contentText = lines.slice(1).join('\n');
                let situation = "å…§å®¹è§£æä¸­...";
                let contradiction = "å…§å®¹è§£æä¸­...";
                const cleanContent = contentText.replace(/\*\*/g, ''); 
                
                const parts = cleanContent.split(/(?:å¼µåŠ›|çŸ›ç›¾)[:ï¼š]/);
                if (parts.length > 1) {
                    situation = parts[0].replace(/^(?:æƒ…å¢ƒ|æƒ…æ™¯)[:ï¼š]\s*/, '').trim();
                    contradiction = parts[1].trim();
                } else {
                    situation = cleanContent;
                    contradiction = "";
                }

                finalHTML += `
                <div class="guide-card seed-card">
                    <div class="seed-header">${title}</div>
                    <div class="seed-body">
                        <p><strong><i class="fas fa-image"></i> æƒ…å¢ƒï¼š</strong></p>
                        <p>${situation.replace(/\n/g, '<br>')}</p>
                        <hr style="border:0; border-top:1px dashed #ddd; margin: 10px 0;">
                        <p><strong><i class="fas fa-bolt"></i> å¼µåŠ›ï¼š</strong></p>
                        <p>${contradiction.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>`;
            });
            
            finalHTML += `</div>`; // çµæŸ Grid å®¹å™¨
        }

        // â˜…â˜…â˜… é—œéµï¼šåŠ å…¥ç•«å¸ƒèŠå¤©å®¤ä»‹é¢ â˜…â˜…â˜…
        // é€™æœƒè‡ªå‹•ç”Ÿæˆå°è©±æ¡†ï¼Œä¸¦ä¸” sendCanvasMessage æœƒè®€å–ä¸Šé¢çš„ currentContext è®Šæ•¸
        finalHTML += getCanvasChatHTML('narrative_guide');

        // === æ‰“é–‹ç•«å¸ƒä¸¦å¯«å…¥å…§å®¹ ===
        openResultCanvas("è§£é¡ŒæŒ‡å¼•");
        const resultContainer = document.getElementById("resultCanvasBody");
        resultContainer.innerHTML = finalHTML;

        // === å„²å­˜æ­·å²ç´€éŒ„ ===
        // æ–°çš„é‚è¼¯ï¼šå®Œæ•´å„²å­˜ (åŒ…å«èŠå¤©å®¤ä»‹é¢)
await saveToHistory("æ•˜äº‹æŠ’æƒ…", "è§£é¡ŒæŒ‡å¼•", inputTopic, `é¡Œç›®ï¼š${inputTopic}`, finalHTML);
        
        // é¡¯ç¤ºå„²å­˜æŒ‰éˆ• (å¦‚æœæœ‰çš„è©±)
        hideAllSaveHtmlButtons();
   


    } catch (error) {
        console.error("è§£é¡ŒæŒ‡å¼•ç”Ÿæˆå¤±æ•—:", error);
        alert("ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    } finally {
        submitBtn.disabled = false;
        hideLoading();
    }
}



	
// ==========================================
// === æ•˜äº‹æŠ’æƒ…æäº¤å‡½å¼ (å¤§ç¶±æ¨¡å¼åªå­˜é¡Œç›®) ===
// ==========================================
async function submitWriting() {
    console.log("ğŸ–±ï¸ [ç³»çµ±] æäº¤æŒ‰éˆ•è¢«é»æ“Šäº†ï¼");
    const submitBtn = document.getElementById('submitWritingBtn');
    submitBtn.disabled = true;
    hideAllSaveHtmlButtons();

    const writingGradingResultDiv = document.getElementById("writingGradingResult");
    const writingChatHistoryDiv = document.getElementById("writingChatHistory");
    const writingChatInputContainerDiv = document.getElementById("writingChatInputContainer");
    if(writingGradingResultDiv) writingGradingResultDiv.innerHTML = "";
    if(writingChatHistoryDiv) writingChatHistoryDiv.style.display = "none";
    if(writingChatInputContainerDiv) writingChatInputContainerDiv.style.display = "none";
    writingChatHistoryData = [];

    try {
        const reviewerSelect = document.getElementById('writingReviewer');
        if (reviewerSelect) {
            const selectedReviewerText = reviewerSelect.options[reviewerSelect.selectedIndex].text;
            currentReviewerName = selectedReviewerText.replace(/\s*\(é è¨­\)\s*/, '');
        } else {
            currentReviewerName = "é™³SIR";
        }

        const writingType = document.getElementById("writingType").value;
        const topic = localStorage.getItem("currentTopic");
        if (!topic) { alert("è«‹å…ˆè¨­å®šé¡Œç›®"); submitBtn.disabled = false; return; }

        const tone = document.getElementById("writingTone").value;
        let content = "";

        // === æ¨¡å¼ä¸€ï¼šå¤§ç¶±é»è©• ===
        if (writingType === "å¤§ç¶±") {
            const structure = document.getElementById("structure").value;
            const parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];
            
            let outlineRawText = ""; 
            const outlineData = parts.map((part, index) => {
                const focusId = structure + "Focus" + (index + 1);
                const plotId = structure + "Plot" + (index + 1);
                const focus = document.getElementById(focusId)?.value.trim() || "";
                const plot = document.getElementById(plotId)?.value.trim() || "";
                if (!focus || !plot) throw new Error("è«‹å¡«å¯«æ‰€æœ‰å¤§ç¶±è¡¨æ ¼");
                outlineRawText += `[${part}] é‡é»ï¼š${focus} \n æƒ…ç¯€ï¼š${plot}\n`;
                return { part, focus, plot };
            });

            showLoading("é™³SIR æ­£åœ¨é»è©•å¤§ç¶±..."); 
            
            const payload = {
                action: "grade_narrative",
                data: {
                    subType: "å¤§ç¶±",
                    topic: topic,
                    outlineData: outlineData,
                    structure: structure,
                    tone: tone
                }
            };
            
            const response = await callAPI(payload, 0);
            
            currentContextContent = outlineRawText;
            currentContextReview = response;
            displayOutlineComment(response, outlineData);
            
            saveToHistory("æ•˜äº‹æŠ’æƒ…", "å¤§ç¶±é»è©•", topic, `é¡Œç›®ï¼š${topic}`, document.getElementById("resultCanvasBody").innerHTML);

        } 
        // === æ¨¡å¼äºŒï¼šæ•˜äº‹ç‰©è±¡ ===
        else if (writingType === "æ•˜äº‹ç‰©è±¡") {
            content = document.getElementById("narrativeElements").value.trim();
            showLoading("é™³SIR æ­£åœ¨ç”Ÿæˆç‰©è±¡...");
            
            const payload = {
                action: "grade_narrative",
                data: {
                    subType: "æ•˜äº‹ç‰©è±¡",
                    topic: topic,
                    content: content
                }
            };

            const response = await callAPI(payload, 0);
            
            currentContextContent = `é¡Œç›®ï¼š${topic}\nèƒŒæ™¯ï¼š${content}`;
            currentContextReview = response;

            const elements = response.split("\n").map(item => item.replace(/^\d+\.|^-\s*/, '').trim()).filter(item => item);
            let elementsHTML = `<div class="rewrite-explanation-container"><div class="rewrite-explanation-card"><h3>ç”Ÿæˆçš„ç‰©è±¡ï¼ˆ${elements.length}é …ï¼‰ï¼š</h3><div class="vocab-grid">`;
            elements.forEach(element => { elementsHTML += `<div class="vocab-item">${element}</div>`; });
            elementsHTML += `</div></div></div>`; 
            elementsHTML += getCanvasChatHTML('narrative_elements');

            openResultCanvas("ç”Ÿæˆçš„æ•˜äº‹ç‰©è±¡");
            document.getElementById("resultCanvasBody").innerHTML = elementsHTML;
            await saveToHistory("æ•˜äº‹æŠ’æƒ…", "æ•˜äº‹ç‰©è±¡", topic, `é¡Œç›®ï¼š${topic}\nå–æï¼š${content}`, elementsHTML);

        } 
        // === æ¨¡å¼ä¸‰ï¼šç‰‡æ®µæå¯« ===
        else { 
            console.log("ğŸ“ [ç³»çµ±] é€²å…¥æ•˜äº‹æŠ’æƒ…å…¨æ–‡æ¨¡å¼ï¼Œæº–å‚™å‘¼å« RAG...");

            content = document.getElementById("writingContent").value.trim();
            if (!content) { alert("è«‹å…ˆè¼¸å…¥å¯«ä½œå…§å®¹"); submitBtn.disabled = false; return; }
            
            const selectedScopes = Array.from(document.querySelectorAll('input[name="reviewScope"]:checked')).map(cb => cb.value);
            const isFullReview = selectedScopes.includes("å…¨éƒ¨") || selectedScopes.length === 0;

            showLoading(`${currentReviewerName} æ­£åœ¨é»è©•...`);

            // RAG é‚è¼¯
            const ragReference = await searchSimilarEssays(content, 'narrative');
            
            // â˜…â˜…â˜… ä¿®æ­£è™•ï¼šç§»é™¤äº†å‰ç«¯ç²å– narrativeReviewerPreferences çš„é‚è¼¯ â˜…â˜…â˜…
            // å› ç‚ºé€™äº›è³‡æ–™ç¾åœ¨ä½æ–¼å¾Œç«¯ï¼Œæˆ‘å€‘åªéœ€è¦å‚³é€ reviewer ID å³å¯ã€‚

            // â˜…â˜…â˜… ä¿®æ­£è™•ï¼šç§»é™¤äº† ${specificPreference} è®Šæ•¸ â˜…â˜…â˜…
            const finalPromptContent = `
ã€ç³»çµ±å¼·åˆ¶æŒ‡ä»¤ (System Instruction)ã€‘
1. **å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ (Traditional Chinese)**ï¼šç„¡è«–åƒè€ƒè³‡æ–™æ˜¯ç°¡é«”æˆ–ç¹é«”ï¼Œä½ çš„æ‰€æœ‰è¼¸å‡ºï¼ˆé»è©•ã€å»ºè­°ã€æ”¹å¯«ï¼‰éƒ½å¿…é ˆè½‰æ›ç‚ºç¹é«”ä¸­æ–‡ï¼ˆé¦™æ¸¯ç¿’æ…£ï¼‰ã€‚
2. **å€åˆ†è§’è‰²**ï¼šä¸‹æ–¹çš„ã€åƒè€ƒè³‡æ–™ã€‘æ˜¯ç”¨ä¾†å¹«åŠ©ä½ å»ºç«‹è©•åˆ†æ¨™æº–çš„ã€Œç¯„æ–‡ã€ï¼Œä¸‹æ–¹çš„ã€å¾…è©•æ ¸å­¸ç”Ÿæ–‡ç« ã€‘æ‰æ˜¯ä½ éœ€è¦è©•æ”¹çš„å°è±¡ã€‚åƒè¬ä¸è¦è©•æ”¹åƒè€ƒè³‡æ–™ã€‚
3. **æ ¼å¼åš´æ ¼**ï¼šåš´æ ¼éµå®ˆåŸæœ¬è¨­å®šçš„ XML/JSON è¼¸å‡ºæ ¼å¼ï¼Œä¸è¦è¼¸å‡ºé¡å¤–çš„ã€Œæ”¹å¯«èªªæ˜ã€æˆ–é–’èŠæ–‡å­—ã€‚
4. **é–±å·å“¡é¢¨æ ¼**ï¼šè«‹åš´æ ¼æ ¹æ“šå¾Œç«¯ç³»çµ±æŒ‡ç¤ºçš„ã€é–±å·å“¡ç‰¹å®šè©•åˆ†å–å‘ã€‘é€²è¡Œè©•åˆ†åŠæ’°å¯«é»è©•ï¼Œå‹™å¿…é«”ç¾è©²é–±å·å“¡é‡è¦–çš„ç‰¹é»ã€‚

${ragReference ? ragReference : "(æœ¬æ¬¡æœªæª¢ç´¢åˆ°åƒè€ƒç¯„æ–‡)"}

=== ğŸ“ å¾…è©•æ ¸å­¸ç”Ÿæ–‡ç«  (Target Student Essay) ===
(è«‹é‡å°ä»¥ä¸‹æ–‡ç« é€²è¡Œè©•åˆ†èˆ‡é»è©•)
${content}
`;

            // å»ºæ§‹ Payload
            const payload = {
                action: "grade_narrative",
                data: {
                    subType: "ç‰‡æ®µæå¯«",
                    isFullReview: isFullReview,
                    topic: topic,
                    focus: localStorage.getItem("currentFocus"), 
                    plot: localStorage.getItem("currentPlot"),   
                    content: finalPromptContent, 
                    reviewer: document.getElementById('writingReviewer').value, // å¾Œç«¯æœƒæ ¹æ“šæ­¤ ID è®€å–å°æ‡‰çš„ Preference
                    tone: tone,
                    selectedScopes: selectedScopes
                }
            };

            if (isFullReview) {
                const [originalApiResponse, llama3ApiResponse] = await Promise.all([
                    callAPI(payload, 0),
                    callLlama3API(payload, 0)
                ]);

                currentContextContent = content;
                currentContextReview = originalApiResponse;

                await displayFullCommentWithGrading('writingGradingResult', originalApiResponse, llama3ApiResponse, 'narrative', content);
            
            } else {
                const response = await callAPI(payload, 0);
                
                currentContextContent = content;
                currentContextReview = response;

                const critiqueMatch = response.match(/<critique>([\s\S]*?)<\/critique>/);
                const suggestionsMatch = response.match(/<suggestions>([\s\S]*?)<\/suggestions>/);
                let initialReviewHTML = `<h3>${currentReviewerName}èšç„¦é»è©•ï¼š</h3>`;
                if (critiqueMatch?.[1]) initialReviewHTML += createBulletedListHTML("é»è©•", critiqueMatch[1].trim());
                if (suggestionsMatch?.[1]) initialReviewHTML += createBulletedListHTML("å»ºè­°", suggestionsMatch[1].trim());
                if (!critiqueMatch && !suggestionsMatch) initialReviewHTML += "<p>æŠ±æ­‰ï¼Œç„¡æ³•ç”Ÿæˆé»è©•ã€‚</p>";
                
                initialReviewHTML += getCanvasChatHTML('narrative_writing');
                openResultCanvas("èšç„¦é»è©•çµæœ");
                document.getElementById("resultCanvasBody").innerHTML = initialReviewHTML;
                
                const htmlToSave = captureContainerHTML('resultCanvasBody'); 
                saveToHistory("æ•˜äº‹æŠ’æƒ…", "æ–‡ç« é»è©•", topic || "ç„¡é¡Œç›®", `é¡Œç›®ï¼š${topic}\n\næ–‡ç« ï¼š${content}\n(èšç„¦é»è©•ï¼š${selectedScopes.join("ã€")})`, htmlToSave);
            }
        }
    } catch (error) {
        console.error("æäº¤å¯«ä½œæ™‚å‡ºéŒ¯:", error);
        alert("é»è©•ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
    } finally {
        submitBtn.disabled = false;
        hideLoading();
    }
}


// è¼”åŠ©å‡½å¼ï¼Œç”¨æ–¼é¡¯ç¤ºå¤§ç¶±çš„è©•è«– (å¾ submitWriting ä¸­æå–å‡ºä¾†)
// è¼”åŠ©å‡½å¼ï¼Œç”¨æ–¼é¡¯ç¤ºå¤§ç¶±çš„è©•è«– (æ•˜äº‹æŠ’æƒ… - V3 ä¿®å¾©ç‰ˆ)
function displayOutlineComment(response, content) {
    console.log("[Narrative Outline] Raw Response:", response); // LOG raw response

    const sections = response.split(/=== (.+?) ===/).filter(s => s.trim());
    const commentIndex = sections.indexOf("é»è©•åŠå»ºè­°");
    const rewriteIndex = sections.indexOf("æ”¹å¯«å¾Œçš„å¤§ç¶±");
    const explanationIndex = sections.indexOf("æ”¹å¯«èªªæ˜");
    const commentPart = commentIndex !== -1 ? sections[commentIndex + 1] : "";
    const rewritePart = rewriteIndex !== -1 ? sections[rewriteIndex + 1] : "";
    const explanationPart = explanationIndex !== -1 ? sections[explanationIndex + 1].trim() : "";

    function parseCommentPart(commentPart) {
        const comments = {};
        // å¢å¼· Regexï¼šå®¹è¨± Markdown åŠ ç²— (**), å®¹è¨±è‹±æ–‡å†’è™Ÿ (:)
        const regex = /\[(.+?)\]\s*(?:\*\*|)\s*é»è©•\s*(?:\*\*|)\s*[ï¼š:]\s*(.+?)(?=\s*(?:\*\*|)\s*å»ºè­°\s*(?:\*\*|)\s*[ï¼š:]|\s*\[|$)/gs;
        const suggestionRegex = /\[(.+?)\]\s*.*?\s*(?:\*\*|)\s*å»ºè­°\s*(?:\*\*|)\s*[ï¼š:]\s*(.+?)(?=\s*\[|$)/gs;
        let match;
        while ((match = regex.exec(commentPart)) !== null) {
            const part = match[1];
            comments[part] = comments[part] || {};
            comments[part].comment = match[2].trim();
        }
        while ((match = suggestionRegex.exec(commentPart)) !== null) {
            const part = match[1];
            comments[part] = comments[part] || {};
            comments[part].suggestion = match[2].trim();
        }
        return comments;
    }

    function parseRewritePart(rewritePart) {
        const rewrites = {};
        const regex = /\[(.+?)\]\s*(?:\*\*|)\s*çµæ§‹æ®µé‡é»\s*(?:\*\*|)\s*[ï¼š:]\s*(.+?)(?=\s*(?:\*\*|)\s*æƒ…ç¯€å¤§è¦\s*(?:\*\*|)\s*[ï¼š:]|\s*\[|$)/gs;
        const plotRegex = /\[(.+?)\]\s*.*?\s*(?:\*\*|)\s*æƒ…ç¯€å¤§è¦\s*(?:\*\*|)\s*[ï¼š:]\s*(.+?)(?=\s*\[|$)/gs;
        let match;
        while ((match = regex.exec(rewritePart)) !== null) {
            const part = match[1];
            rewrites[part] = rewrites[part] || {};
            rewrites[part].focus = match[2].trim();
        }
        while ((match = plotRegex.exec(rewritePart)) !== null) {
            const part = match[1];
            rewrites[part] = rewrites[part] || {};
            rewrites[part].plot = match[2].trim();
        }
        return rewrites;
    }
    
    const comments = parseCommentPart(commentPart);
    const rewrites = parseRewritePart(rewritePart);

    // LOG è§£æçµæœä»¥ä¾¿é™¤éŒ¯
    console.log("[Narrative Outline] Parsed Comments:", comments);
    console.log("[Narrative Outline] Parsed Rewrites:", rewrites);

    let commentTableHTML = `<h3>é™³SIRé»è©•åŠå»ºè­°ï¼š</h3><div class="table-container"><table id="commentTable"><tr><th style="width:10%;">éƒ¨ä»½</th><th style="width:15%;">çµæ§‹æ®µé‡é»</th><th style="width:20%;">æƒ…ç¯€å¤§è¦</th><th style="width:27.5%;">é»è©•</th><th style="width:27.5%;">å»ºè­°</th></tr>`;
    
    // â˜…â˜…â˜… ä¿®å¾©ï¼šå°‡ inputData æ”¹ç‚º content â˜…â˜…â˜…
    content.forEach(item => {
        // å˜—è©¦æ¨¡ç³ŠåŒ¹é… Key (é˜²æ­¢ AI è¼¸å‡º "çµæ§‹æ®µ1" è€Œæœ¬åœ°æ˜¯ "çµæ§‹æ®µä¸€")
        const partKey = Object.keys(comments).find(k => k.includes(item.part) || item.part.includes(k)) || item.part;

        const comment = comments[partKey]?.comment || "<span style='color:red;'>æœªèƒ½è§£æ (è«‹æŸ¥çœ‹Console)</span>";
        const suggestion = comments[partKey]?.suggestion || "-";
        
        commentTableHTML += `<tr><td>${item.part}</td><td>${item.focus}</td><td>${item.plot}</td><td>${comment}</td><td>${suggestion}</td></tr>`;
    });
    commentTableHTML += "</table></div>";

    let rewriteTableHTML = `<h3>æ”¹å¯«å¾Œçš„å¤§ç¶±ï¼š</h3><div class="table-container"><table id="rewriteTable"><tr><th style="width:15%;">éƒ¨ä»½</th><th style="width:42.5%;">çµæ§‹æ®µé‡é»</th><th style="width:42.5%;">æƒ…ç¯€å¤§è¦</th></tr>`;
    
    // â˜…â˜…â˜… ä¿®å¾©ï¼šå°‡ inputData æ”¹ç‚º content â˜…â˜…â˜…
    content.forEach(item => {
        const partKey = Object.keys(rewrites).find(k => k.includes(item.part) || item.part.includes(k)) || item.part;
        const rewrite = rewrites[partKey] || { focus: "...", plot: "..." };
        rewriteTableHTML += `<tr><td>${item.part}</td><td>${rewrite.focus || "..."}</td><td>${rewrite.plot || "..."}</td></tr>`;
    });
    rewriteTableHTML += "</table></div>";

    let explanationHTML = '';
    if (explanationPart) {
        const points = explanationPart.split(/\s*(?=\d\.\s*)/).filter(p => p.trim());
        explanationHTML = `<div class="rewrite-explanation-container"><div class="rewrite-explanation-card"><h3>æ”¹å¯«èªªæ˜</h3>`;
        points.forEach(point => {
            const match = point.match(/^(\d)\.\s*(.*)$/s);
            if (match) {
                const number = match[1];
                const text = match[2];
                explanationHTML += `<div class="explanation-point"><div class="explanation-number">${number}</div><div class="explanation-text">${text}</div></div>`;
            } else {
                 explanationHTML += `<div class="explanation-text">${point}</div>`;
            }
        });
        explanationHTML += `</div></div>`;
    }
    
    openResultCanvas("æ•˜äº‹å¤§ç¶±é»è©•çµæœ");
    const resultContainer = document.getElementById("resultCanvasBody");
    resultContainer.innerHTML = commentTableHTML + rewriteTableHTML + explanationHTML + getCanvasChatHTML('narrative_outline');
}

// æ›¿æ›èˆŠçš„ submitReading å‡½å¼ (ä¿®æ­£æ­·å²ç´€éŒ„å„²å­˜å•é¡Œ)
// æ›¿æ›èˆŠçš„ submitReading å‡½å¼ (ä¿®æ­£æ­·å²ç´€éŒ„å„²å­˜è®Šæ•¸éŒ¯èª¤)
async function submitReading() {
    const submitBtn = document.getElementById('submitReadingBtn');
    submitBtn.disabled = true; 
    hideAllSaveHtmlButtons();

    try {
        const readingFunction = document.getElementById("readingFunction").value;
        const passage = document.getElementById("readingPassage").value.trim();
        const question = document.getElementById("readingQuestion").value.trim();
        let studentAnswer = "";

        if (readingFunction === "comment") {
            studentAnswer = document.getElementById("studentAnswer").value.trim();
            if (!passage || !question || !studentAnswer) { alert("è«‹å¡«å¯«æ‰€æœ‰é–±è®€è¼¸å…¥"); return; }
            currentContextContent = `ç¯‡ç« ï¼š${passage.substring(0, 100)}...\né¡Œç›®ï¼š${question}\nç­”æ¡ˆï¼š${studentAnswer}`;
        } else {
            if (!passage || !question) { alert("è«‹å¡«å¯«é–±è®€ç¯‡ç« å’Œé¡Œç›®"); return; }
            currentContextContent = `ç¯‡ç« ï¼š${passage.substring(0, 100)}...\né¡Œç›®ï¼š${question}`;
        }

        showLoading("é™³SIR æ­£åœ¨åˆ†æç¯‡ç« ...");

        // â˜… å»ºæ§‹ Payload
        const payload = {
            action: "grade_reading",
            data: {
                subType: readingFunction, // "comment" æˆ– "guide"
                passage: passage,
                question: question,
                answer: studentAnswer,
                tone: document.getElementById("readingTone").value 
            }
        };

        const result = await callReadingAPI(payload);
        currentContextReview = result;

        // === ä»¥ä¸‹ä¿ç•™åŸæœ‰çš„ HTML ç”Ÿæˆèˆ‡æ¸²æŸ“é‚è¼¯ ===
        let finalHTML = "";
        let guideHTML = "";

        if (readingFunction === "comment") {
            const parts = result.split("###").map(part => part.trim()).filter(part => part);
            finalHTML = "<h3>é™³SIRé»è©•ï¼š</h3>";

            parts.forEach(part => {
                const lines = part.split("\n").filter(line => line.trim());
                const title = lines.shift() || "";
                const content = lines.join("\n");

                if (title.includes("é»è©•")) {
                    finalHTML += createBulletedListHTML(title, content);
                } 
                else if (title.includes("ç­”é¡Œæ­¥é©ŸåŠæ€è·¯")) {
                    finalHTML += `<div class="rewrite-explanation-container">
                    <div class="rewrite-explanation-card">
                    <h3>${title}</h3>
                    <div class="steps-container">`;
                    const steps = content.split(/\s*(?=ã€.*?ã€‘)/).filter(s => s.trim());
                    steps.forEach(stepText => {
                        const match = stepText.match(/^(ã€.*?ã€‘)(.*)$/s);
                        if (match) {
                            const stepTitle = match[1].trim();
                            const stepContent = match[2].trim().replace(/\n/g, '<br>');
                            finalHTML += `<div class="step-card">
                            <div class="step-title">${stepTitle}</div>
                            <div class="step-content">${stepContent}</div>
                            </div>`;
                        }
                    });
                    finalHTML += `</div></div></div>`;
                }
                else if (title.includes("æ”¹å¯«")) {
                    const cleanContent = content.replace(/\*/g, '');
                    finalHTML += `<div class="rewrite-explanation-container">
                        <div class="rewrite-explanation-card">
                            <h3>${title}</h3>
                            <div class="rewrite-content">${cleanContent.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>`;
                }
                else {
                    finalHTML += `<div class="rewrite-explanation-container">
                    <div class="rewrite-explanation-card">
                    <h3>${title}</h3>
                    <div class="explanation-text">${content.replace(/\n/g, '<br>')}</div>
                    </div>
                    </div>`;
                }
            });
            
            finalHTML += getCanvasChatHTML('reading_comment');
            openResultCanvas("é–±è®€ç†è§£é»è©•");
            document.getElementById("resultCanvasBody").innerHTML = finalHTML;
            saveToHistory("é–±è®€", "é»è©•", question || "é–±è®€ç·´ç¿’", `ç¯‡ç« ï¼š${passage}\né¡Œç›®ï¼š${question}\nç­”æ¡ˆï¼š${studentAnswer}`, finalHTML);

        } else { // guide
            const guideParts = result.split("###").map(part => part.trim()).filter(part => part);
            guideHTML = "<h3>é™³SIRæŒ‡å¼•ï¼š</h3>";

            guideParts.forEach(part => {
                const lines = part.split("\n").filter(line => line.trim());
                const title = lines.shift() || "";
                
                guideHTML += `<div class="rewrite-explanation-container">
                <div class="rewrite-explanation-card">
                <h3>${title}</h3>`;

                if (title.includes("ç­”é¡ŒæŒ‡å¼•")) {
                    lines.forEach((item, index) => {
                        const match = item.match(/^(\d+)\.?\s*(.*)$/);
                        const number = match ? match[1] : index + 1;
                        const text = match ? match[2].trim() : item;
                        guideHTML += `<div class="explanation-point">
                        <div class="explanation-number">${number}</div>
                        <div class="explanation-text">${text}</div>
                        </div>`;
                    });
                    guideHTML += `</div></div>`;
                } 
                else if (title.includes("ç­”é¡Œè©åŒ¯")) {
                    guideHTML += `<div class="vocab-grid">`;
                    lines.forEach(item => {
                        const cleanItem = item.replace(/^\d+\.|^-\s*/, '').trim();
                        if (cleanItem) {
                            guideHTML += `<div class="vocab-item">${cleanItem}</div>`;
                        }
                    });
                    guideHTML += `</div></div></div>`;
                } else {
                    guideHTML += `<p class="explanation-text">${lines.join('<br>')}</p></div></div>`;
                }
            });
            
            guideHTML += getCanvasChatHTML('reading_guide');
            openResultCanvas("é–±è®€ç†è§£æŒ‡å¼•");
            document.getElementById("resultCanvasBody").innerHTML = guideHTML;
            await saveToHistory("é–±è®€", "æŒ‡å¼•", question || "é–±è®€æŒ‡å¼•", `ç¯‡ç« ï¼š${passage}\né¡Œç›®ï¼š${question}`, guideHTML);
        }

    } catch (error) {
        console.error("æäº¤é–±è®€æ™‚å‡ºéŒ¯:", error);
        alert("ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
    } finally {
        submitBtn.disabled = false;
        hideLoading();
    }
}


// èª²å¤–æ›¸ç±è¨è«–åŠŸèƒ½
let chatHistory = [];
let bookTitle = "";
let author = "";
let discussionQuestion = "";
let booksTone = "";

// å°‡è¨Šæ¯æ¸²æŸ“åˆ°ç•«é¢ä¸Š
function renderMessage(sender, message) {
const chatHistoryDiv = document.getElementById("chatHistory");
const element = document.createElement("div");

if (sender === "info") {
element.className = "discussion-info";
element.innerHTML = message;
} else {
element.className = `message-bubble ${sender}-message`;
element.innerHTML = message; // innerHTML to render formatted text
if (sender === "ai" && message === "é™³SIRæ­£åœ¨å›æ‡‰...") {
element.id = "ai-loading";
}
}
chatHistoryDiv.appendChild(element);
chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
}

// å°‡è¨Šæ¯åŠ å…¥æ­·å²ç´€éŒ„ä¸¦æ¸²æŸ“
function addMessageToHistory(sender, message) {
chatHistory.push({ sender, message });
renderMessage(sender, message);
}


async function startDiscussion() {
const startBtn = document.getElementById('startDiscussionBtn');
startBtn.disabled = true;

try {
bookTitle = sanitizeHTML(document.getElementById("bookTitle").value.trim());
author = sanitizeHTML(document.getElementById("author").value.trim());
discussionQuestion = sanitizeHTML(document.getElementById("discussionQuestion").value.trim());
booksTone = document.getElementById("booksTone").value;

if (!bookTitle || !author || !discussionQuestion) {
alert("è«‹å¡«å¯«æ›¸åã€ä½œè€…å’Œè¨è«–å•é¡Œ");
return;
}

// éš±è—åˆå§‹è¡¨å–®ï¼Œé¡¯ç¤ºèŠå¤©ä»‹é¢
document.getElementById("initialDiscussionForm").style.display = "none";
document.getElementById("chatHistory").style.display = "flex";
document.getElementById("chatInputContainer").style.display = "flex";
document.getElementById("booksButtons").style.display = "flex";



chatHistory = []; // é–‹å§‹æ–°è¨è«–æ™‚æ¸…ç©ºæ­·å²ç´€éŒ„

const initialMessage = `<table><tr><td>æ›¸åï¼š</td><td>${bookTitle}</td></tr><tr><td>ä½œè€…ï¼š</td><td>${author}</td></tr><tr><td>è¨è«–ï¼š</td><td>${discussionQuestion}</td></tr></table>`;
addMessageToHistory("info", initialMessage);

await sendInitialMessage();

} catch (error) {
console.error("é–‹å§‹è¨è«–æ™‚å‡ºéŒ¯:", error);
} finally {
startBtn.disabled = false;
}
}

// ==========================================
// === èª²å¤–æ›¸ç±è¨è«–èˆ‡èŠå¤©å®¤å‡½å¼ ===
// ==========================================

async function sendInitialMessage() {
    const payload = {
        action: "chat_books",
        data: {
            bookTitle: bookTitle,
            author: author,
            discussionQuestion: discussionQuestion,
            tone: booksTone
        }
    };
    
    addMessageToHistory("ai", "é™³SIRæ­£åœ¨å›æ‡‰...");
    try {
        const aiResponse = await callReadingAPI(payload);
        updateLastAIMessage(aiResponse);
    } catch (error) {
        console.error("API call failed:", error);
        updateLastAIMessage("æŠ±æ­‰ï¼Œé™³SIRæš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    }
}


// =================================================================================
// === è«‹è¤‡è£½æ­¤è™•é–‹å§‹çš„å®Œæ•´å‡½æ•¸ ===
// =================================================================================
async function continueArgumentDiscussion() {
    const continueBtn = document.getElementById('continueArgumentBtn');
    continueBtn.disabled = true;

    const userInputText = sanitizeHTML(document.getElementById("argumentUserInput").value.trim());
    if (!userInputText) {
        alert("è«‹è¼¸å…¥æ‚¨çš„å›æ‡‰");
        continueBtn.disabled = false;
        return;
    }
    
    const chatHistoryDiv = document.getElementById('argumentChatHistory');
    
    const userMessageBubble = document.createElement('div');
    userMessageBubble.className = 'message-bubble user-message';
    userMessageBubble.textContent = userInputText;
    chatHistoryDiv.appendChild(userMessageBubble);
    
    argumentChatHistoryData.push({ sender: 'user', message: userInputText });
    document.getElementById("argumentUserInput").value = "";
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

    const aiLoadingBubble = document.createElement('div');
    aiLoadingBubble.className = 'message-bubble ai-message';
    aiLoadingBubble.textContent = `${currentReviewerName}æ­£åœ¨å›æ‡‰...`;
    chatHistoryDiv.appendChild(aiLoadingBubble);
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

    const conversationHistoryForPrompt = argumentChatHistoryData.map(item => {
        const speaker = item.sender === 'user' ? 'æˆ‘çš„è¿½å•' : 'ä½ çš„ä¸Šä¸€è¼ªå›æ‡‰';
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = item.message;
        const cleanMessage = tempDiv.textContent || tempDiv.innerText || "";
        return `${speaker}: ${cleanMessage}`;
    }).join('\n---\n');

    // å–å¾—ç•¶å‰èªæ°£è¨­å®š
    const tone = document.getElementById("argumentWritingTone").value;
    let toneNote = "";
    if (tone === "chen") {
        toneNote = "è«‹ç”¨å¹½é»˜è©¼è«§ã€é©æ™‚æ¶æ„çš„èªæ°£å›æ‡‰ï¼Œ**å¿…é ˆä½¿ç”¨å¤§é‡Emoji** ğŸ¤ªâœ¨ï¼Œè¡¨ç¤ºæ¶æ„æ™‚æœƒç”¨ğŸ¤Œé€™å€‹EMOJIï¼Œå¶çˆ¾ç”¨ç¶²çµ¡ç”¨èªã€‚";
    } else {
        toneNote = "è«‹ç”¨æ—¥å¸¸çš„èªè¨€å›æ‡‰æˆ‘ï¼Œä¸è¦éæ–¼ç†è«–åŒ–ã€‚";
    }
    
    // å»ºæ§‹ä¸€èˆ¬å°è©±çš„ Prompt
    const prompt = `æˆ‘æ˜¯ä¸€ä½é«˜ä¸­ç”Ÿï¼Œä½ æ­£åœ¨é»è©•æˆ‘çš„è­°è«–æ–‡ã€‚\nåŸæ–‡ï¼š${currentArgumentArticle}\nå°è©±ç´€éŒ„ï¼š${conversationHistoryForPrompt}\nè«‹é‡å°æœ€æ–°è¿½å•å›æ‡‰ã€‚${toneNote}\n\nã€é‡è¦ã€‘è«‹å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡(Traditional Chinese)å›ç­”ã€‚`;
    
    try {
        // ä½¿ç”¨ callReadingAPI (è­°è«–æ–‡é€šå¸¸ç”¨ DeepSeek)
        let aiResponse = await callReadingAPI(prompt);
        
        // â˜…â˜…â˜… å¼·åˆ¶ç¹é«”åŒ– (OpenCC) â˜…â˜…â˜…
        if (typeof OpenCC !== 'undefined') {
            const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
            aiResponse = converter(aiResponse);
        }

        // â˜…â˜…â˜… å¼·åˆ¶æ›¿æ›å¼•è™Ÿ (å°‡ "" æˆ– â€œâ€ è½‰ç‚º ã€Œã€) â˜…â˜…â˜…
        aiResponse = aiResponse.replace(/["â€œ](.*?)["â€]/g, 'ã€Œ$1ã€');
        
        let formattedResponse = aiResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formattedResponse = formattedResponse.replace(/\n/g, '<br>');
        aiLoadingBubble.innerHTML = formattedResponse;
        
        argumentChatHistoryData.push({ sender: 'ai', message: aiResponse });

        // æ›´æ–°æ­·å²ç´€éŒ„
        await updateHistoryChat();

    } catch (error) {
        console.error("ç¹¼çºŒè­°è«–æ–‡è¨è«–æ™‚å‡ºéŒ¯:", error);
        aiLoadingBubble.textContent = "æŠ±æ­‰ï¼Œå›æ‡‰å¤±æ•—ã€‚";
    } finally {
        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        continueBtn.disabled = false;
    }
}
// =================================================================================
// === è«‹è¤‡è£½åˆ°æ­¤è™•çµæŸ ===
// =================================================================================


async function continueWritingDiscussion() {
    // é€™è£¡æˆ‘å€‘ä»ç„¶éœ€è¦æ§‹å»º Promptï¼Œå› ç‚º chat_general action éœ€è¦ raw prompt
    const continueBtn = document.getElementById('continueWritingBtn');
    continueBtn.disabled = true;
    const userInputText = sanitizeHTML(document.getElementById("writingUserInput").value.trim());
    
    const writingChatHistoryDiv = document.getElementById('writingChatHistory');
    const userMessageBubble = document.createElement('div');
    userMessageBubble.className = 'message-bubble user-message';
    userMessageBubble.textContent = userInputText;
    writingChatHistoryDiv.appendChild(userMessageBubble);
    
    document.getElementById("writingUserInput").value = "";
    writingChatHistoryDiv.scrollTop = writingChatHistoryDiv.scrollHeight;

    const tone = document.getElementById("writingTone").value;
    let toneNote = tone === "chen" ? "è«‹ç”¨å¹½é»˜è©¼è«§çš„èªæ°£ï¼Œå°±åƒé™³SIRä¸€æ¨£ã€‚" : "è«‹ç”¨æ—¥å¸¸èªè¨€ï¼Œä¸è¦éæ–¼ç†è«–ã€‚";
    
    const prompt = `æˆ‘æ˜¯ä¸€ä½é«˜ä¸­ç”Ÿï¼Œä½ å‰›å‰›é»è©•äº†æˆ‘çš„æ–‡ç« ã€‚\nåŸæ–‡ï¼š${currentWritingArticle}\né»è©•ï¼š${currentWritingReview}\nè¿½å•ï¼š${userInputText}\nè«‹ç”¨æ—¥å¸¸èªè¨€å›æ‡‰ï¼Œè©³ç´°åˆ†æä¸¦èˆ‰ä¾‹ã€‚${toneNote}\n\nã€é‡è¦ã€‘è«‹å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡(Traditional Chinese)å›ç­”ã€‚`;
    
    const aiMessageBubble = document.createElement('div');
    aiMessageBubble.className = 'message-bubble ai-message';
    aiMessageBubble.textContent = `${currentReviewerName}æ­£åœ¨å›æ‡‰...`;
    writingChatHistoryDiv.appendChild(aiMessageBubble);

    try {
        // ä½¿ç”¨å­—ä¸²æ¨¡å¼å‘¼å«ï¼Œè‡ªå‹•è§¸ç™¼ chat_general
        let aiResponse = await callReadingAPI(prompt);

        // â˜…â˜…â˜… å¼·åˆ¶ç¹é«”åŒ– (OpenCC) â˜…â˜…â˜…
        if (typeof OpenCC !== 'undefined') {
            const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
            aiResponse = converter(aiResponse);
        }

        // â˜…â˜…â˜… å¼·åˆ¶æ›¿æ›å¼•è™Ÿ (å°‡ "" æˆ– â€œâ€ è½‰ç‚º ã€Œã€) â˜…â˜…â˜…
        aiResponse = aiResponse.replace(/["â€œ](.*?)["â€]/g, 'ã€Œ$1ã€');

        aiMessageBubble.innerHTML = aiResponse.replace(/\n/g, '<br>');
        await updateHistoryChat();
    } catch (error) {
        aiMessageBubble.textContent = "æŠ±æ­‰ï¼Œå›æ‡‰å¤±æ•—ã€‚";
    } finally {
        continueBtn.disabled = false;
    }
}


async function continueDiscussion() {
    const continueBtn = document.getElementById('continueBtn');
    continueBtn.disabled = true;
    const userInputText = sanitizeHTML(document.getElementById("userInput").value.trim());
    if (!userInputText) { alert("è«‹è¼¸å…¥æ‚¨çš„å›æ‡‰"); continueBtn.disabled = false; return; }

    addMessageToHistory("user", userInputText);
    document.getElementById("userInput").value = "";
    addMessageToHistory("ai", "é™³SIRæ­£åœ¨å›æ‡‰...");

    const payload = {
        action: "chat_books",
        data: {
            bookTitle: bookTitle,
            author: author,
            discussionQuestion: discussionQuestion,
            tone: booksTone,
            userInput: userInputText
        }
    };

    try {
        const aiResponse = await callReadingAPI(payload);
        updateLastAIMessage(aiResponse);
    } catch (error) {
        console.error("ç¹¼çºŒè¨è«–æ™‚å‡ºéŒ¯:", error);
        updateLastAIMessage("æŠ±æ­‰ï¼Œé™³SIRç„¡æ³•å›æ‡‰ã€‚");
    } finally {
        continueBtn.disabled = false;
    }
}

// --- æ–°å¢ï¼šè™•ç†å½ˆå‡ºè¦–çª—çš„é‚è¼¯ ---
const newTopicModal = document.getElementById('newTopicModal');
const newTopicBtn = document.getElementById('newTopicBtn');
const closeNewTopicModal = document.getElementById('closeNewTopicModal');
const modalStartDiscussionBtn = document.getElementById('modalStartDiscussionBtn');

newTopicBtn.addEventListener('click', () => {
newTopicModal.style.display = 'flex';
});

closeNewTopicModal.addEventListener('click', () => {
newTopicModal.style.display = 'none';
});

window.addEventListener('click', (event) => {
if (event.target == newTopicModal) {
newTopicModal.style.display = 'none';
}
});

modalStartDiscussionBtn.addEventListener('click', async () => {
const newBookTitle = document.getElementById("modalBookTitle").value.trim();
const newAuthor = document.getElementById("modalAuthor").value.trim();
const newDiscussionQuestion = document.getElementById("modalDiscussionQuestion").value.trim();

if (!newBookTitle || !newAuthor || !newDiscussionQuestion) {
alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");
return;
}

// æ›´æ–°å…¨åŸŸè®Šæ•¸
bookTitle = newBookTitle;
author = newAuthor;
discussionQuestion = newDiscussionQuestion;

// æ¸…ç©ºèˆŠçš„èŠå¤©æ­·å²å’Œ UI
document.getElementById("chatHistory").innerHTML = '';
chatHistory = [];

// æ·»åŠ æ–°çš„æ›¸ç±è³‡è¨Šå¡ç‰‡
const initialMessage = `<table><tr><td>æ›¸åï¼š</td><td>${bookTitle}</td></tr><tr><td>ä½œè€…ï¼š</td><td>${author}</td></tr><tr><td>è¨è«–ï¼š</td><td>${discussionQuestion}</td></tr></table>`;
addMessageToHistory("info", initialMessage);

// é—œé–‰å½ˆå‡ºè¦–çª—
newTopicModal.style.display = 'none';

// æ¸…ç©ºå½ˆå‡ºè¦–çª—çš„è¼¸å…¥
document.getElementById("modalBookTitle").value = '';
document.getElementById("modalAuthor").value = '';
document.getElementById("modalDiscussionQuestion").value = '';

// ç™¼é€åˆå§‹è¨Šæ¯
await sendInitialMessage();
});


// =================================================================================
// === ã€å…¨æ–°ã€‘é»è©•ç¯„ç–‡ UI/UX äº’å‹•é‚è¼¯ ===
// =================================================================================
function setupScopeUI(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const allCheckbox = container.querySelector('input[value="å…¨éƒ¨"]');
    const otherCheckboxes = container.querySelectorAll('input:not([value="å…¨éƒ¨"])');

    // è² è²¬æ›´æ–°æ‰€æœ‰æ¨™ç±¤æ¨£å¼çš„æ ¸å¿ƒå‡½æ•¸
    const updateUI = () => {
        // æ›´æ–° "å…¨éƒ¨" æ¨™ç±¤çš„æ¨£å¼
        const allLabel = allCheckbox.parentElement;
        if (allCheckbox.checked) {
            allLabel.classList.add('active');
        } else {
            allLabel.classList.remove('active');
        }

        // æ›´æ–°å…¶ä»–æ‰€æœ‰æ¨™ç±¤çš„æ¨£å¼
        otherCheckboxes.forEach(cb => {
            const label = cb.parentElement;
            if (cb.checked) {
                label.classList.add('active');
            } else {
                label.classList.remove('active');
            }

            if (cb.disabled) {
                label.classList.add('disabled');
            } else {
                label.classList.remove('disabled');
            }
        });
    };

    // ç‚º "å…¨éƒ¨" è¤‡é¸æ¡†æ·»åŠ äº‹ä»¶ç›£è½
    allCheckbox.addEventListener('change', () => {
        if (allCheckbox.checked) {
            // å¦‚æœ "å…¨éƒ¨" è¢«é¸ä¸­ï¼Œå–æ¶ˆé¸ä¸­ä¸¦ç¦ç”¨å…¶ä»–æ‰€æœ‰é¸é …
            otherCheckboxes.forEach(cb => {
                cb.checked = false;
                cb.disabled = true;
            });
        } else {
            // å¦‚æœ "å…¨éƒ¨" è¢«å–æ¶ˆé¸ä¸­ï¼Œå•Ÿç”¨å…¶ä»–æ‰€æœ‰é¸é …
            otherCheckboxes.forEach(cb => {
                cb.disabled = false;
            });
        }
        updateUI(); // æ›´æ–°ä»‹é¢
    });

    // ç‚ºå…¶ä»–è¤‡é¸æ¡†æ·»åŠ äº‹ä»¶ç›£è½
    otherCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            // å¦‚æœä»»ä½•ä¸€å€‹å…¶ä»–é¸é …è¢«é¸ä¸­ï¼Œå‰‡å–æ¶ˆé¸ä¸­ "å…¨éƒ¨"
            if (cb.checked) {
                allCheckbox.checked = false;
            }
            updateUI(); // æ›´æ–°ä»‹é¢
        });
    });
    
    // é é¢åŠ è¼‰æ™‚ï¼Œç«‹å³æ ¹æ“šåˆå§‹ç‹€æ…‹æ›´æ–°ä¸€æ¬¡UI
    updateUI();
}

// åœ¨ DOM åŠ è¼‰å®Œæˆå¾Œï¼Œç‚ºå…©å€‹é»è©•ç¯„ç–‡å€å¡Šåˆå§‹åŒ– UI é‚è¼¯
document.addEventListener('DOMContentLoaded', () => {
    setupScopeUI('reviewScopeArea');
    setupScopeUI('argumentReviewScopeArea');
});
	

// æ›¿æ›èˆŠçš„ generateExpandTopic å‡½å¼
async function generateExpandTopic(buttonElement) {
    if (buttonElement) {
        updateButtonActiveState(buttonElement);
    }

    // éš±è—è‡ªè¨‚é¡Œç›®è¼¸å…¥å€ï¼Œç¢ºä¿ä»‹é¢ä¹¾æ·¨
    const customTopicArea = document.getElementById("expandCustomTopicInputArea");
    customTopicArea.style.display = "none";
    customTopicArea.innerHTML = "";

    const topicResult = document.getElementById("expandTopicResult");
    
    topicResult.innerHTML = "é™³SIRæ­£åœ¨å‡ºé¡Œ...";
    topicResult.style.display = 'block';

    try {
        // â˜…â˜…â˜… å»ºæ§‹ Payload å‚³çµ¦å¾Œç«¯ (å–ä»£æœ¬åœ° Prompt) â˜…â˜…â˜…
        // æ³¨æ„ï¼šé€™è£¡ä¸éœ€è¦å‚³é€ä»»ä½•é¡å¤–è³‡æ–™ï¼Œåªéœ€è¦å‘Šè¨´å¾Œç«¯è¦åš "topic_generation"
        const payload = {
            action: "grade_expand",
            data: {
                subType: "topic_generation" 
            }
        };
        
        const topic = await callAPI(payload);
        
        // === ä»¥ä¸‹ä¿æŒåŸæœ‰çš„è§£æèˆ‡æ¸²æŸ“é‚è¼¯ ===
        const lines = topic.split("\n").map(line => line.trim()).filter(line => line);
        const themeMatch = lines.find(line => line.startsWith("ä¸»é¡Œå¥ï¼š"));
        const dataMatch = lines.find(line => line.startsWith("æŠ„éŒ„è³‡æ–™ï¼š"));
        
        if (!themeMatch || !dataMatch) throw new Error("API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º");
        
        const theme = themeMatch.replace("ä¸»é¡Œå¥ï¼š", "").trim();
        const data = dataMatch.replace("æŠ„éŒ„è³‡æ–™ï¼š", "").trim();
        
        if (!theme || !data) throw new Error("ç”Ÿæˆå…§å®¹ä¸å®Œæ•´");

        topicResult.innerHTML = `
        <div class="table-container">
        <table>
        <tr><th>ä¸»é¡Œå¥</th><th>æŠ„éŒ„è³‡æ–™</th></tr>
        <tr><td>${theme}</td><td>${data}</td></tr>
        </table>
        </div>
        `;
        
        localStorage.setItem("expandCurrentTheme", theme);
        localStorage.setItem("expandCurrentData", data);
        // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„è‡ªè¨‚é¡Œç›® Title
        localStorage.removeItem("expandCurrentTitle");

    } catch (error) {
        console.error("ç”Ÿæˆæ•´åˆæ‹“å±•é¡Œç›®æ™‚å‡ºéŒ¯:", error);
        if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
            alert("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œæˆ–APIç„¡æ³•é€£æ¥ï¼Œè«‹æ˜å¤©å†è©¦");
        } else {
            alert("ç”Ÿæˆé¡Œç›®æ™‚å‡ºéŒ¯ï¼Œè«‹é‡è©¦");
        }
        topicResult.innerHTML = "";
        topicResult.style.display = 'none';
    }
}


// æ›¿æ›èˆŠçš„ setExpandCustomTopic å‡½å¼
function setExpandCustomTopic() {
const title = sanitizeHTML(document.getElementById("expandCustomTitle").value.trim());
const theme = sanitizeHTML(document.getElementById("expandCustomTheme").value.trim());
const data = sanitizeHTML(document.getElementById("expandCustomData").value.trim());
if (!title || !theme || !data) {
alert("è«‹è¼¸å…¥æ‰€æœ‰å…§å®¹ï¼ˆé¡Œç›®ã€ä¸»é¡Œå¥ã€æŠ„éŒ„è³‡æ–™ï¼‰");
return;
}

const topicResult = document.getElementById("expandTopicResult");
topicResult.innerHTML = `
<strong>é¡Œç›®ï¼š${title}</strong>
<div class="table-container">
<table>
<tr><th>ä¸»é¡Œå¥</th><th>æŠ„éŒ„è³‡æ–™</th></tr>
<tr><td>${theme}</td><td>${data}</td></tr>
</table>
</div>
`;

topicResult.style.display = 'block';

localStorage.setItem("expandCurrentTitle", title);
localStorage.setItem("expandCurrentTheme", theme);
localStorage.setItem("expandCurrentData", data);

// ç¢ºèªå¾Œï¼Œéš±è—ä¸¦æ¸…ç©ºè¼¸å…¥å€åŸŸ
const customTopicArea = document.getElementById("expandCustomTopicInputArea");
customTopicArea.style.display = 'none';
customTopicArea.innerHTML = '';
}

// æ›´æ–°å­—æ•¸è¨ˆæ•¸
function updateCharCount() {
const content = document.getElementById("expandContent").value;
const remaining = 180 - content.length;
document.getElementById("charCount").textContent = `å‰©é¤˜å­—æ•¸ï¼š${remaining >= 0 ? remaining : 0}`;
if (remaining < 0) {
document.getElementById("expandContent").value = content.substring(0, 180);
}
}

// â˜…â˜…â˜… è«‹å°‡è£œå›çš„ä»£ç¢¼è²¼åœ¨é€™è£¡ â˜…â˜…â˜…
async function submitExpand() {
    const expandFunction = document.getElementById("expandFunction").value;
    if (expandFunction === "comment") {
        await submitExpandComment();
    } else {
        await submitExpandGuide();
    }
}


// æäº¤æ•´åˆæ‹“å±•å…§å®¹
async function submitExpandComment() {
    const submitBtn = document.getElementById('submitExpandBtn');
    submitBtn.disabled = true;
    hideAllSaveHtmlButtons();

    try {
        const title = localStorage.getItem("expandCurrentTitle");
        const theme = localStorage.getItem("expandCurrentTheme");
        const data = localStorage.getItem("expandCurrentData");
        
        // ç²å–ç”¨æˆ¶è¼¸å…¥çš„å…§å®¹
        const content = document.getElementById("expandContent").value.trim();
        
        if (!theme || !data || !content) {
            alert("è«‹å…ˆè¨­å®šé¡Œç›®ä¸¦è¼¸å…¥æ•´åˆæ‹“å±•å…§å®¹");
            return;
        }

        const tone = document.getElementById("expandTone").value;

        showLoading("é™³SIR æ­£åœ¨å¯©è¦–æ‹“å±•æ–¹å‘...");
        
        // â˜…â˜…â˜… å»ºæ§‹ Payload å‚³çµ¦å¾Œç«¯ (å–ä»£æœ¬åœ° Prompt) â˜…â˜…â˜…
        const payload = {
            action: "grade_expand",
            data: {
                subType: "comment", // å‘Šè¨´å¾Œç«¯é€™æ˜¯é»è©•
                title: title || "ç„¡",
                theme: theme,
                data: data,
                content: content,
                tone: tone
            }
        };
        
        // å‘¼å«é€šç”¨ API
        const comment = await callAPI(payload);
        
        // è¨­å®šèŠå¤©å®¤ä¸Šä¸‹æ–‡
        currentContextContent = `é¡Œç›®ï¼š${title}\nä¸»é¡Œå¥ï¼š${theme}\næŠ„éŒ„è³‡æ–™ï¼š${data}\nå…§å®¹ï¼š${content}`;
        currentContextReview = comment;

        // === ä»¥ä¸‹ä¿æŒåŸæœ‰çš„ HTML è§£æèˆ‡æ¸²æŸ“é‚è¼¯ ===
        const commentParts = comment.split("###").map(part => part.trim()).filter(part => part);
        
        let finalHTML = "<h3>é™³SIRé»è©•ï¼š</h3>";
        
        commentParts.forEach(part => {
            const lines = part.split("\n").filter(line => line.trim());
            const sectionTitle = lines.shift() || "";
            const sectionContent = lines.join("\n");

            if (sectionTitle.includes("é»è©•") || sectionTitle.includes("å»ºè­°")) {
                finalHTML += createBulletedListHTML(sectionTitle, sectionContent);
            } else {
                const cleanContent = sectionContent.replace(/\*/g, '');
                finalHTML += `<div class="rewrite-explanation-container">
                    <div class="rewrite-explanation-card">
                        <h3>${sectionTitle}</h3>
                        <div class="rewrite-content">${cleanContent.replace(/\n/g, '<br>')}</div>
                    </div>
                </div>`;
            }
        });

        // åŠ å…¥èŠå¤©å®¤
        finalHTML += getCanvasChatHTML('expand_comment');

        openResultCanvas("æ•´åˆæ‹“å±•é»è©•");
        document.getElementById("resultCanvasBody").innerHTML = finalHTML;
        
        // å„²å­˜æ™‚ç§»é™¤èŠå¤©å®¤ HTML çµæ§‹ä»¥ä¿æŒä¹¾æ·¨
        // æˆ–è€…ç›´æ¥å„²å­˜ finalHTMLï¼ŒsaveToHistory å…§éƒ¨æœƒè™•ç†è¼¸å…¥æ¡†ç§»é™¤
        const historyHTML = finalHTML; 
        
        await saveToHistory(
            "æ•´åˆæ‹“å±•", 
            "é»è©•", 
            title || "ç„¡é¡Œç›®", 
            `é¡Œç›®ï¼š${title}\nä¸»é¡Œå¥ï¼š${theme}\næŠ„éŒ„è³‡æ–™ï¼š${data}\nå…§å®¹ï¼š${content}`, 
            historyHTML
        );

    } catch (error) {
        console.error("æäº¤æ•´åˆæ‹“å±•é»è©•æ™‚å‡ºéŒ¯:", error);
        alert("é»è©•ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
    } finally {
        submitBtn.disabled = false;
        hideLoading();
    }
}

	
// ã€ä¿®è¨‚å¾Œã€‘æäº¤æ•´åˆæ‹“å±•æŒ‡å¼•
async function submitExpandGuide() {
    const submitBtn = document.getElementById('submitExpandGuideBtn');
    submitBtn.disabled = true;
    hideAllSaveHtmlButtons();

    try {
        const title = document.getElementById("expandGuideTitle").value.trim();
        const theme = document.getElementById("expandGuideTheme").value.trim();
        const data = document.getElementById("expandGuideData").value.trim();
        const expand = document.getElementById("expandGuideExpand").value.trim();
        
        if (!title || !theme || !data || !expand) {
            alert("è«‹å¡«å¯«æ‰€æœ‰è¼¸å…¥");
            return; 
        }

        showLoading("é™³SIR æ­£åœ¨æ€è€ƒæŒ‡å¼•...");
        
        // â˜…â˜…â˜… å»ºæ§‹ Payload å‚³çµ¦å¾Œç«¯ (å–ä»£æœ¬åœ° Prompt) â˜…â˜…â˜…
        const payload = {
            action: "grade_expand",
            data: {
                subType: "guide", // å‘Šè¨´å¾Œç«¯é€™æ˜¯æŒ‡å¼•
                title: title,
                theme: theme,
                data: data,
                content: expand
            }
        };
        
        // å‘¼å«é€šç”¨ API
        const guide = await callAPI(payload);
        
        // è¨­å®šèŠå¤©å®¤ä¸Šä¸‹æ–‡
        currentContextContent = `é¡Œç›®ï¼š${title}\nä¸»é¡Œå¥ï¼š${theme}\næŠ„éŒ„è³‡æ–™ï¼š${data}\nå…§å®¹ï¼š${expand}`;
        currentContextReview = guide;

        // === ä»¥ä¸‹ä¿æŒåŸæœ‰çš„ HTML è§£æèˆ‡æ¸²æŸ“é‚è¼¯ ===
        const guideParts = guide.split("###").map(part => part.trim()).filter(part => part);
        let guideHTML = "<h3>é™³SIRæŒ‡å¼•ï¼š</h3>";

        guideParts.forEach(part => {
            const lines = part.split("\n").filter(line => line.trim());
            const sectionTitle = lines.shift() || "æŒ‡å¼•å•é¡Œ";
            const questions = lines;

            guideHTML += `<div class="rewrite-explanation-container">
            <div class="rewrite-explanation-card">
            <h3>${sectionTitle}</h3>`;

            questions.slice(0, 3).forEach((question, index) => {
                const match = question.match(/^(\d+)\.?\s*(.*)$/);
                const number = match ? match[1] : index + 1;
                const text = match ? match[2].trim() : question;

                guideHTML += `<div class="explanation-point">
                <div class="explanation-number">${number}</div>
                <div class="explanation-text">${text}</div>
                </div>`;
            });

            guideHTML += `</div></div>`;
        });

        // åŠ å…¥èŠå¤©å®¤
        guideHTML += getCanvasChatHTML('expand_guide');

        openResultCanvas("æ•´åˆæ‹“å±•æŒ‡å¼•");
        document.getElementById("resultCanvasBody").innerHTML = guideHTML;
        
        // å„²å­˜æ­·å²ç´€éŒ„ (ç§»é™¤èŠå¤©å®¤)
        const historyHTML = guideHTML.split('<div class="canvas-chat-container">')[0];
        saveToHistory("æ•´åˆæ‹“å±•", "æŒ‡å¼•", title, `é¡Œç›®ï¼š${title}\nä¸»é¡Œå¥ï¼š${theme}\næŠ„éŒ„è³‡æ–™ï¼š${data}\nå…§å®¹ï¼š${expand}`, historyHTML);

    } catch (error) {
        console.error("æäº¤æ•´åˆæ‹“å±•æŒ‡å¼•æ™‚å‡ºéŒ¯:", error);
        alert("æŒ‡å¼•ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
    } finally {
        submitBtn.disabled = false; 
        hideLoading();
    }
}


// --- JavaScript for Tool 2 (èªè–ˆ) & Modals ---
let debounceTimer;

const toolDescriptions = {
'sansi': 'æœ¬å·¥å…·æ—¨åœ¨å”åŠ©åŒå­¸ç·´ç¿’å¯«ä½œå·å’Œé–±è®€å·ï¼Œä¸¦æä¾›èª²å¤–æ›¸ç±è¨è«–ã€‚',
'sansi-v3': 'ã€Œç¥æ€ã€å‚™ç”¨ç‰ˆæœ¬ï¼ŒåŠŸèƒ½èˆ‡ä¸»ç‰ˆæœ¬ç›¸åŒã€‚',
'tizi': 'ç”±AIæ“¬è¨­é–±è®€å·åŠå¯«ä½œå·çš„é¡Œç›®ï¼Œç‚ºåŒå­¸æä¾›æºæºä¸çµ•çš„æ‡‰è©¦ç·´ç¿’ã€‚',
'reading-pieces': 'æä¾›AIç”Ÿæˆçš„æ–‡å­¸ç‰‡æ®µï¼ŒåŸ¹é¤ŠåŒå­¸é‘‘è³æ–‡å­¸çš„èƒ½åŠ›ã€‚',
'study': 'å…·æœ‰æ ¹æ“šæ¢ç©¶å•é¡Œç”Ÿæˆåœ–è§£èˆ‡æ–‡å­—åˆ†æçš„åŠŸèƒ½ï¼ŒåŸ¹é¤ŠåŒå­¸æ·±å…¥ç ”è¨å°ˆé¡Œçš„èƒ½åŠ›ã€‚',
'mensyu': 'å…·æœ‰AIå°‹æ‰¾æ–‡è¨€ç¯‡ç« çš„åŠŸèƒ½ï¼Œä¸¦è¼”ä»¥èªè­¯åŠè©è§£ï¼ŒåŸ¹é¤ŠåŒå­¸é‘‘è³æ–‡è¨€æ–‡çš„èƒ½åŠ›ã€‚',
'wabisabi': 'æ ¹æ“šåŒå­¸ä¸Šå‚³çš„åœ–ç‰‡ï¼Œå‰µä½œå…·æœ‰æ„å¢ƒçš„å¥å­ã€‚',
'book-overview': 'æä¾›å¤§é‡æ›¸ç±çš„å…§å®¹æ¦‚è¦½ï¼ŒåŠ©ä½ å¿«é€Ÿäº†è§£æ›¸ç±å¤§æ„ï¼Œé¸æ“‡æ„Ÿèˆˆè¶£çš„è®€ç‰©ã€‚',
'fanshui-narrative': 'ç”±AIç”Ÿæˆæ•˜äº‹ç¯„æ–‡ï¼Œå¯æ ¹æ“šé¡Œç›®å‰µä½œé«˜è³ªç´ çš„æ•˜äº‹æ–‡ç« ä»¥ä¾›åƒè€ƒã€‚',
'fanshui-argument': 'ç”±AIç”Ÿæˆè­°è«–ç¯„æ–‡ï¼Œå¯æ ¹æ“šé¡Œç›®å‰µä½œçµæ§‹åš´è¬¹çš„è­°è«–æ–‡ä»¥ä¾›åƒè€ƒã€‚',
'manuscript': 'æä¾›é›»å­åŸç¨¿ç´™ï¼Œæ¨¡æ“¬çœŸå¯¦å¯«ä½œæƒ…å¢ƒï¼Œä¸¦è¨­æœ‰AIç­”æƒ‘åŠŸèƒ½ã€‚',
'words': 'è¨­æœ‰æŸ¥è€ƒè©ç¾©ã€æ–‡ç« æ½¤è‰²åŠæ¸¬é©—åŠŸèƒ½ï¼Œæœ‰åŠ©åŒå­¸ç´¯ç©è©å½™ï¼Œæ–Ÿå­—é…Œå¥ã€‚',
'slideshow': 'å°‡åŒå­¸çš„æ–‡ç« è½‰æ›ç‚ºå¹»ç‡ˆç‰‡ï¼Œä»¥è—è¡“æ–¹å¼å±•ç¤ºåŒå­¸ä½œå“ã€‚',
'yuyilu': 'èªå¼ˆéŒ„æ˜¯ä¸€æ¬¾å•ç­”éŠæˆ²ï¼Œé¡Œç›®ç¯„åœæ¶µè“‹èª²æ–‡ã€‚æ­¤ç‚ºä¸­ä¸€ç‰ˆæœ¬ã€‚',
'timer': 'è¨­æœ‰å€’è¨ˆæ™‚åŠŸèƒ½ï¼Œç¨‹å¼æª¢æ¸¬åˆ°äººè²æœƒé‡ç½®æ™‚è¨ˆï¼Œæ˜¯å°ˆå¿ƒèƒŒæ›¸æº«ç¿’çš„å¥½å¹«æ‰‹ã€‚',
'mensyu-2': 'æ–‡è¨€æ–‡ç¿»è­¯åŠåˆ†æå·¥å…·ï¼ŒåŠ©åŒå­¸å…‹æœå¤æ–‡é–±è®€çš„éšœç¤™ã€‚',
'zhiyun': 'ä»¥Google Driveå»ºè¨­çš„é›²ç«¯å¹³è‡ºï¼Œå¯ä¾›ç”¨å®¶ç¹³äº¤èª²æ¥­ã€æª¢é–±ç¹³äº¤ç´€éŒ„åŠç€è¦½å€‹äººèª²æ¥­æ–‡ä»¶å¤¾ï¼Œè¨­æœ‰è‡ªå‹•ç”Ÿæˆç¹³äº¤èª²æ¥­ç´€éŒ„ã€æ­¸é¡æ–‡ä»¶åŠè¿½æ”¶åŠŸèª²çš„åŠŸèƒ½ã€‚',
'zhuoyu': 'å¯åœ¨PDFåŠåœ–ç‰‡æª”æ¡ˆå³é‚Šä½œæ—æ‰¹æˆ–å‚™è¨»ï¼Œæ–¹ä¾¿æ‰¹é–±ä½œæ–‡æˆ–åšç­†è¨˜ã€‚',
'quizbuzzer': 'ä¸€å€‹ç°¡å–®æ˜“ç”¨çš„ç·šä¸Šæ¶ç­”å™¨ï¼Œé©åˆèª²å ‚æˆ–æ´»å‹•ä¸­ä½¿ç”¨ã€‚',
'ocr': 'i2OCR æ˜¯å…è²»çš„ç·šä¸Šå…‰å­¸å­—å…ƒè¾¨è­˜ (OCR) è»Ÿé«”ï¼Œå¯å¾åœ–åƒæˆ–PDFæ–‡ä»¶ä¸­æå–æ–‡å­—ï¼Œæ–¹ä¾¿å°‡æ‰‹å¯«ç¨¿è½‰ç‚ºé›»å­æª”ã€‚',
'epub': 'ç·šä¸Šé›»å­æ›¸(ePub)é–±è®€å™¨ï¼Œæ–¹ä¾¿é–±è®€é›»å­æ›¸ï¼Œç„¡éœ€å®‰è£ä»»ä½•è»Ÿä»¶ã€‚',
'decibelmeter': 'å…·æœ‰é‡åº¦åˆ†è²çš„åŠŸèƒ½ï¼Œå°ˆç‚ºèª²å ‚ç§©åºç®¡ç†è¨­è¨ˆã€‚',
'chitutor': 'AIä¸­æ–‡èŠå¤©å®¤ï¼Œå°ˆç‚ºä¸­æ–‡å­¸ç¿’è€Œè¨­ï¼Œå¯ä»¥èˆ‡AIè¨è«–å„ç¨®ä¸­æ–‡å•é¡Œã€‚',
'histutor': 'AIæ­·å²èŠå¤©å®¤ï¼Œå°ˆç‚ºæ­·å²å­¸ç¿’è€Œè¨­ï¼Œå¯ä»¥èˆ‡AIè¨è«–æ­·å²äº‹ä»¶å’Œäººç‰©ã€‚',
'counseling': 'AIè¼”å°èŠå¤©å®¤ï¼Œç•¶åŒå­¸æ„Ÿåˆ°å›°æƒ‘æˆ–éœ€è¦å‚¾è¨´æ™‚ï¼Œå¯ä»¥åœ¨é€™è£¡æ‰¾åˆ°æ…°è—‰ã€‚',
'self-learning': 'æä¾›å¤§é‡è‡ªå­¸ä¸­æ–‡çš„è³‡æºï¼ŒåŒ…æ‹¬æ•™å­¸å½±ç‰‡ã€ä½³ä½œåŠå„å·ç­†è¨˜ç­‰ã€‚',
'lyrics': 'ä¸€æ¬¾çµåˆç¯€å¥éŠæˆ²èˆ‡æ­Œè©æ¸¬é©—çš„ä¸­æ–‡èªæ–‡å·¥å…·ï¼Œé€ééŸ³æ¨‚äº’å‹•åŸ¹é¤ŠåŒå­¸çš„è©å½™ç©ç´¯ã€æ–‡å­¸é‘‘è³åŠèªæ„Ÿèƒ½åŠ›ï¼Œä¸¦æ”¯æ´ç·šä¸Šå°æˆ°èˆ‡æ’è¡Œæ¦œï¼Œå¢æ·»æ¨‚è¶£èˆ‡ç«¶çˆ­çš„å­¸ç¿’é«”é©—ã€‚',
	'friends': 'ã€åƒ…ä¾›å‰µä½œç¤¾æˆå“¡ä½¿ç”¨ã€‘å…è¨±ç”¨æˆ¶å»ºç«‹ç¾¤çµ„ã€åŒ¿åäº¤å‹ã€æŠ•ç¨¿ä½œå“ã€ç•™è¨€è¨è«–ï¼Œä¸¦é€ééŠæˆ²äº’å‹•å¢é€²èªæ–‡å­¸ç¿’çš„æ¨‚è¶£ï¼ŒåŸ¹é¤ŠåŒå­¸çš„è¡¨é”èˆ‡ç¤¾äº¤èƒ½åŠ›ã€‚',
	'slowreading': 'ä¸€æ¬¾å°ˆæ³¨æ·±åº¦é–±è®€çš„å·¥å…·ï¼Œä½¿ç”¨è€…å¯è²¼ä¸Šæ–‡æœ¬ä¸¦è‡ªè¨‚ç¿»é ç§’æ•¸ï¼Œç³»çµ±å°‡è‡ªå‹•é€å¥æ’­æ”¾ï¼Œå¹«åŠ©è®€è€…èšç„¦å…§å®¹ï¼Œæå‡é–±è®€çš„å°ˆæ³¨åŠ›ã€‚',
	'pulseqa': 'ä¸€å€‹ç°¡æ½”é«˜æ•ˆçš„èª²å ‚å•ç­”è¨ˆæ™‚å·¥å…·ã€‚ä¸»æŒäººå¯å‰µå»ºæˆ¿é–“ã€è¨­ç½®å•é¡Œèˆ‡è¨ˆæ™‚ï¼Œå­¸ç”Ÿå‰‡éœ€è¦æŒ‰æ™‚ä½œç­”ã€‚'
};


function drawConnectors() {
const svg = document.getElementById('connector-svg');
const container = document.getElementById('mind-map');
if (!svg || !container) {
return;
}
svg.innerHTML = '';

if (window.getComputedStyle(container).display === 'none') {
return;
}

const getElementEdge = (el, side = 'top') => {
const rect = el.getBoundingClientRect();
const containerRect = container.getBoundingClientRect();
const center_x = rect.left - containerRect.left + rect.width / 2;
const center_y = rect.top - containerRect.top + rect.height / 2;

switch(side) {
case 'top': return { x: center_x, y: rect.top - containerRect.top };
case 'bottom': return { x: center_x, y: rect.bottom - containerRect.top };
case 'left': return { x: rect.left - containerRect.left, y: center_y };
case 'right': return { x: rect.right - containerRect.left, y: center_y };
default: return {x: center_x, y: center_y};
}
}

const connections = [
{ from: '[data-id="core-ai-node"]', to: '[data-id="foundation-tizi"]', fromSide: 'bottom', toSide: 'top' },
{ from: '[data-id="core-ai-node"]', to: '[data-id="foundation-explore"]', fromSide: 'bottom', toSide: 'top' },
{ from: '[data-id="foundation-tizi"]', to: '#writing .category-title', fromSide: 'bottom', toSide: 'top' },
{ from: '[data-id="foundation-tizi"]', to: '#reading .category-title', fromSide: 'bottom', toSide: 'top' },
{ from: '[data-id="core-ai-node"]', to: '#assignments .category-title', fromSide: 'bottom', toSide: 'top' },
{ from: '[data-id="core-ai-node"]', to: '#support .category-title', fromSide: 'bottom', toSide: 'top' }
];

connections.forEach(conn => {
const fromEl = document.querySelector(conn.from);
const toEl = document.querySelector(conn.to);

if (fromEl && toEl) {
const fromPoint = getElementEdge(fromEl, conn.fromSide);
const toPoint = getElementEdge(toEl, conn.toSide);

const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
line.setAttribute('x1', fromPoint.x);
line.setAttribute('y1', fromPoint.y);
line.setAttribute('x2', toPoint.x);
line.setAttribute('y2', toPoint.y);
svg.appendChild(line);
}
});
}

// Listeners for Tool 2 (å·¥å…·ä¸€è¦½å±•é–‹é‚è¼¯ - å·²ä¿®å¾©èƒŒæ™¯æ®˜ç•™)
document.getElementById('expandToolsBtn2').addEventListener('click', function() {
    // 1. â˜…â˜…â˜… å¼·åˆ¶é—œé–‰å…¶ä»–å…¨è¢å¹•ä»‹é¢ â˜…â˜…â˜…
    document.getElementById('historyContainer').style.display = 'none';
    document.getElementById('studentCloudModal').style.display = 'none';
    document.getElementById('featuredContainer').style.display = 'none'; // <--- â˜…â˜…â˜… é—œéµæ–°å¢ â˜…â˜…â˜…

    // 2. éš±è—ä¸»é å…ƒç´  (è§£æ±ºæ‰“é–‹èªè–ˆå¾Œé—œé–‰æ™‚çœ‹åˆ°ä¸»é æ®˜ç•™çš„å•é¡Œ)
    document.querySelector('.title-container').style.display = 'none';
    document.getElementById('hitokoto-container').style.display = 'none';
    document.getElementById('mainMenuBox').style.display = 'none';
    document.getElementById('toolsBox').style.display = 'none';
    const dseBox = document.getElementById('dse-countdown-box');
    if (dseBox) dseBox.style.display = 'none';

    // 3. é¡¯ç¤ºèªè–ˆ
    const container = document.getElementById('toolsContainer2');
    container.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // é–å®šæ²å‹•
    document.querySelector('#toolsContainer2 .main-container').classList.add('loaded');
    
    // 4. æŒ‰éˆ•ç‹€æ…‹èª¿æ•´
    document.getElementById('homeBtn').style.display = 'none';
    document.getElementById('sideMenuHomeBtn').style.display = 'flex';
    
    // ç¢ºä¿é›²ç«¯æŒ‰éˆ•é¡¯ç¤º
    const cloudBtn = document.getElementById('sideMenuCloudBtn');
    if (cloudBtn) cloudBtn.style.display = 'flex';
    
    // æ”¶èµ·å´é‚Šé¸å–®
    document.getElementById('sideMenu').classList.remove('active');
    document.getElementById('sideMenuToggle').classList.remove('active');

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(drawConnectors, 100);
});

// å·¥å…·ä¸€è¦½é—œé–‰é‚è¼¯
// å·¥å…·ä¸€è¦½é—œé–‰é‚è¼¯
document.getElementById('closeToolsBtn2').addEventListener('click', function() {
    // åŒæ¨£ç›´æ¥å‘¼å« returnToHome() ä»¥ç¢ºä¿ä¸»é è¢«æ­£ç¢ºé‚„åŸï¼Œä¸æœƒé¡¯ç¤ºç™½ç•«é¢
    returnToHome();
});

// 'èªå¼ˆéŒ„' Interactivity for Tool 2
const yuyiluToggleTool2 = document.getElementById('yuyilu-toggle');
const yuyiluGradesTool2 = document.getElementById('yuyilu-grades');

if (yuyiluToggleTool2 && yuyiluGradesTool2) {
yuyiluToggleTool2.addEventListener('click', function(event) {
event.preventDefault();
yuyiluGradesTool2.classList.toggle('collapsed');
setTimeout(drawConnectors, 500);
});
}

// --- Preview Modal & Video Modal Logic ---
const previewModal = document.getElementById('previewModal');
const previewIframe = document.getElementById('previewIframe');
const previewCloseBtn = document.getElementById('previewCloseBtn');
const previewGoToPageBtn = document.getElementById('previewGoToPageBtn');
const previewDescription = document.getElementById('previewDescription');

const videoModal = document.getElementById('videoModal');
const videoIframe = document.getElementById('videoIframe');
const videoTourBtn = document.getElementById('video-tour-btn');

const chartLinks = document.querySelectorAll('#toolsContainer2 .node a:not([href="#"])');

chartLinks.forEach(link => {
link.addEventListener('click', function(event) {
event.preventDefault();
const url = this.getAttribute('href');
const toolId = this.getAttribute('data-tool-id');
const description = toolDescriptions[toolId] || "æš«ç„¡ä»‹ç´¹ã€‚";

previewIframe.setAttribute('src', url);
previewGoToPageBtn.setAttribute('href', url);
previewDescription.textContent = description;

previewModal.style.display = 'flex';
});
});

function closePreviewModal() {
previewModal.style.display = 'none';
previewIframe.setAttribute('src', 'about:blank');
}

previewCloseBtn.addEventListener('click', closePreviewModal);


videoTourBtn.addEventListener('click', () => {
videoIframe.src = "https://streamable.com/e/jzhzr1?loop=0&autoplay=1&muted=0";
videoModal.style.display = 'flex';
});

function closeVideoModal() {
videoModal.style.display = 'none';
videoIframe.src = '';
}

videoModal.addEventListener('click', closeVideoModal);


// Redraw connectors on resize
window.addEventListener('resize', () => {
clearTimeout(debounceTimer);
debounceTimer = setTimeout(drawConnectors, 100);
});



/// =======================================================
// === é€šç”¨æ‡¸æµ®è¦–çª—ç·¨è¼¯å™¨ (æœ€çµ‚ç‰ˆ - æ¨™é¡Œä¿®æ­£) ===
// =======================================================
document.addEventListener('DOMContentLoaded', function() {

// --- ç‚ºå‹•æ…‹ç”Ÿæˆçš„ã€Œè‡ªè¨‚é¡Œç›®ã€è¼¸å…¥æ¡†åŠ ä¸Šæ’é™¤æ¨™è¨˜ (ä¿æŒä¸è®Š) ---

const originalShowCustomTopicInput = window.showCustomTopicInput;
window.showCustomTopicInput = function(buttonElement) {
originalShowCustomTopicInput(buttonElement);
const customTopicInput = document.getElementById('customTopic');
if (customTopicInput) {
customTopicInput.classList.add('no-modal-editor');
}
};

const originalShowArgumentCustomTopicInput = window.showArgumentCustomTopicInput;
window.showArgumentCustomTopicInput = function(buttonElement) {
originalShowArgumentCustomTopicInput(buttonElement);
const argumentCustomTopicInput = document.getElementById('argumentCustomTopic');
if (argumentCustomTopicInput) {
argumentCustomTopicInput.classList.add('no-modal-editor');
}
};

const originalShowExpandCustomTopicInput = window.showExpandCustomTopicInput;
window.showExpandCustomTopicInput = function(buttonElement) {
originalShowExpandCustomTopicInput(buttonElement);
const container = document.getElementById('expandCustomTopicInputArea');
if (container) {
container.querySelectorAll('input[type="text"], textarea').forEach(el => el.classList.add('no-modal-editor'));
}
};

// --- æ‡¸æµ®è¦–çª—æ ¸å¿ƒé‚è¼¯ (æ¨™é¡Œç”Ÿæˆéƒ¨åˆ†å·²é‡å¯«) ---

const modal = document.getElementById('outline-editor-modal');
const modalTextarea = document.getElementById('modal-textarea');
const modalTitle = document.getElementById('modal-title');
const modalSaveBtn = document.getElementById('modal-save-btn');
const modalCloseBtn = document.getElementById('modal-close-btn');

if (!modal || !modalTextarea || !modalSaveBtn || !modalCloseBtn) {
console.error("æ‡¸æµ®è¦–çª—çš„ HTML çµæ§‹ä¸å®Œæ•´æˆ–æœªæ‰¾åˆ°ï¼");
return;
}

let currentEditingElement = null;


// ç¯„æ–‡åº«è³‡æ–™ (æ”¾åœ¨é€™è£¡ä»¥ä¾¿å…¨åŸŸå­˜å–)
const textLibrary = {
    "version": "1.0",
    "texts": [
        { "title": "å»‰é —è—ºç›¸å¦‚åˆ—å‚³", "content": "å»‰é —è€…ï¼Œè¶™ä¹‹è‰¯å°‡ä¹Ÿã€‚è¶™æƒ æ–‡ç‹åå…­å¹´ ï¼Œå»‰é —ç‚ºè¶™å°‡ä¼é½Š ï¼Œå¤§ç ´ä¹‹ï¼Œå–é™½æ™‰ï¼Œæ‹œç‚ºä¸Šå¿ ï¼Œä»¥å‹‡æ°£èæ–¼è«¸ä¾¯ã€‚è—ºç›¸å¦‚è€…ï¼Œè¶™äººä¹Ÿï¼Œç‚ºè¶™å®¦è€…ä»¤ç¹†è³¢èˆäºº ã€‚\n\nè¶™æƒ æ–‡ç‹æ™‚ï¼Œå¾—æ¥šå’Œæ°ç’§ ã€‚ç§¦æ˜­ç‹èä¹‹ï¼Œä½¿äººéº è¶™ç‹æ›¸ï¼Œé¡˜ä»¥åäº”åŸè«‹æ˜“ç’§ã€‚è¶™ç‹èˆ‡å¤§å°‡è»å»‰é —è«¸å¤§è‡£è¬€ï¼šæ¬²äºˆç§¦ï¼Œç§¦åŸæä¸å¯å¾—ï¼Œå¾’è¦‹æ¬º ï¼›æ¬²å‹¿äºˆï¼Œå³æ‚£ç§¦å…µä¹‹ä¾†ã€‚è¨ˆæœªå®šï¼Œæ±‚äººå¯ä½¿å ±ç§¦è€… ï¼Œæœªå¾—ã€‚\n\nã€€ã€€å®¦è€…ä»¤ç¹†è³¢æ›°ï¼šã€Œè‡£èˆäººè—ºç›¸å¦‚å¯ä½¿ ã€‚ã€ç‹å•ï¼šã€Œä½•ä»¥çŸ¥ä¹‹ï¼Ÿã€å°æ›°ï¼šã€Œè‡£å˜—æœ‰ç½ªï¼Œç«Šè¨ˆæ¬²äº¡èµ°ç‡• ï¼Œè‡£èˆäººç›¸å¦‚æ­¢è‡£ï¼Œæ›°ï¼šã€å›ä½•ä»¥çŸ¥ç‡•ç‹ï¼Ÿã€è‡£èª æ›°ï¼šã€è‡£å˜—å¾å¤§ç‹èˆ‡ç‡•ç‹æœƒå¢ƒä¸Š ï¼Œç‡•ç‹ç§æ¡è‡£æ‰‹ï¼Œæ›°ã€Œé¡˜çµå‹ã€‚ã€ä»¥æ­¤çŸ¥ä¹‹ï¼Œæ•…æ¬²å¾€ã€‚ã€ç›¸å¦‚è¬‚è‡£æ›°ï¼šã€å¤«è¶™å½Šè€Œç‡•å¼±ï¼Œè€Œå›å¹¸æ–¼è¶™ç‹ ï¼Œæ•…ç‡•ç‹æ¬²çµæ–¼å›ã€‚ä»Šå›ä¹ƒäº¡è¶™èµ°ç‡•ï¼Œç‡•ç•è¶™ï¼Œå…¶å‹¢å¿…ä¸æ•¢ç•™å›ï¼Œè€ŒæŸå›æ­¸è¶™çŸ£ ã€‚å›ä¸å¦‚è‚‰è¢’ä¼æ–§è³ªè«‹ç½ª ï¼Œå‰‡å¹¸å¾—è„«çŸ£ã€‚ã€è‡£å¾å…¶è¨ˆï¼Œå¤§ç‹äº¦å¹¸èµ¦è‡£ã€‚è‡£ç«Šä»¥ç‚ºå…¶äººå‹‡å£«ï¼Œæœ‰æ™ºè¬€ï¼Œå®œå¯ä½¿ã€‚ã€\n\nã€€ã€€æ–¼æ˜¯ç‹å¬è¦‹ï¼Œå•è—ºç›¸å¦‚æ›°ï¼šã€Œç§¦ç‹ä»¥åäº”åŸè«‹æ˜“å¯¡äººä¹‹ç’§ï¼Œå¯äºˆä¸ ï¼Ÿã€ç›¸å¦‚æ›°ï¼šã€Œç§¦å½Šè€Œè¶™å¼±ï¼Œä¸å¯ä¸è¨±ã€‚ã€ç‹æ›°ï¼šã€Œå–å¾ç’§ï¼Œä¸äºˆæˆ‘åŸï¼Œå¥ˆä½•ï¼Ÿã€ç›¸å¦‚æ›°ï¼šã€Œç§¦ä»¥åŸæ±‚ç’§è€Œè¶™ä¸è¨±ï¼Œæ›² åœ¨è¶™ï¼›è¶™äºˆç’§è€Œç§¦ä¸äºˆè¶™åŸï¼Œæ›²åœ¨ç§¦ã€‚å‡ä¹‹äºŒç­– ï¼Œå¯§è¨±ä»¥è² ç§¦æ›² ã€‚ã€ç‹æ›°ï¼šã€Œèª°å¯ä½¿è€…ï¼Ÿã€ç›¸å¦‚æ›°ï¼šã€Œç‹å¿…ç„¡äºº ï¼Œè‡£é¡˜å¥‰ç’§å¾€ä½¿ ã€‚åŸå…¥è¶™è€Œç’§ç•™ç§¦ï¼›åŸä¸å…¥ï¼Œè‡£è«‹å®Œç’§æ­¸è¶™ ã€‚ã€è¶™ç‹æ–¼æ˜¯é‚é£ç›¸å¦‚å¥‰ç’§è¥¿å…¥ç§¦ã€‚\n\nã€€ã€€ç§¦ç‹åç« å°è¦‹ç›¸å¦‚ ï¼Œç›¸å¦‚å¥‰ç’§å¥ç§¦ç‹ ã€‚ç§¦ç‹å¤§å–œï¼Œå‚³ä»¥ç¤ºç¾äººåŠå·¦å³ ï¼Œå·¦å³çš†å‘¼è¬æ­²ã€‚ç›¸å¦‚è¦–ç§¦ç‹ç„¡æ„å„Ÿè¶™åŸï¼Œä¹ƒå‰æ›°ï¼šã€Œç’§æœ‰ç‘• ï¼Œè«‹æŒ‡ç¤ºç‹ã€‚ã€ç‹æˆç’§ï¼Œç›¸å¦‚å› æŒç’§ï¼Œå»ç«‹ ï¼Œå€šæŸ±ï¼Œæ€’é«®ä¸Šè¡å†  ï¼Œè¬‚ç§¦ç‹æ›°ï¼šã€Œå¤§ç‹æ¬²å¾—ç’§ï¼Œä½¿äººç™¼æ›¸è‡³è¶™ç‹ï¼Œè¶™ç‹æ‚‰å¬ç¾£è‡£è­°ï¼Œçš†æ›°ï¼šã€ç§¦è²ªï¼Œè² å…¶å½Š ï¼Œä»¥ç©ºè¨€æ±‚ç’§ï¼Œå„ŸåŸæä¸å¯å¾—ã€ã€‚è­°ä¸æ¬²äºˆç§¦ç’§ã€‚è‡£ä»¥ç‚ºå¸ƒè¡£ä¹‹äº¤å°šä¸ç›¸æ¬º ï¼Œæ³å¤§åœ‹ä¹ï¼ä¸”ä»¥ä¸€ç’§ä¹‹æ•…é€†å½Šç§¦ä¹‹é©© ï¼Œä¸å¯ã€‚æ–¼æ˜¯è¶™ç‹ä¹ƒé½‹æˆ’ äº”æ—¥ï¼Œä½¿è‡£å¥‰ç’§ï¼Œæ‹œé€æ›¸æ–¼åº­ ã€‚ä½•è€…ï¼Ÿåš´å¤§åœ‹ä¹‹å¨ä»¥ä¿®æ•¬ä¹Ÿ ã€‚ä»Šè‡£è‡³ï¼Œå¤§ç‹è¦‹è‡£åˆ—è§€ ï¼Œç¦®ç¯€ç”šå€¨ ï¼›å¾—ç’§ï¼Œå‚³ä¹‹ç¾äººï¼Œä»¥æˆ²å¼„è‡£ã€‚è‡£è§€å¤§ç‹ç„¡æ„å„Ÿè¶™ç‹åŸé‚‘ï¼Œæ•…è‡£å¾©å–ç’§ã€‚å¤§ç‹å¿…æ¬²æ€¥ è‡£ï¼Œè‡£é ­ä»Šèˆ‡ç’§ä¿±ç¢æ–¼æŸ±çŸ£ï¼ã€\n\nã€€ã€€ç›¸å¦‚æŒå…¶ç’§ç¨ æŸ±ï¼Œæ¬²ä»¥æ“ŠæŸ±ã€‚ç§¦ç‹æå…¶ç ´ç’§ï¼Œä¹ƒè¾­è¬å›ºè«‹ ï¼Œå¬æœ‰å¸æ¡ˆåœ– ï¼ŒæŒ‡å¾æ­¤ä»¥å¾€åäº”éƒ½äºˆè¶™ ã€‚\n\nã€€ã€€ç›¸å¦‚åº¦ç§¦ç‹ç‰¹ä»¥è©ä½¯ç‚ºäºˆè¶™åŸ ï¼Œå¯¦ä¸å¯å¾—ï¼Œä¹ƒè¬‚ç§¦ç‹æ›°ï¼šã€Œå’Œæ°ç’§ï¼Œå¤©ä¸‹æ‰€å…±å‚³å¯¶ä¹Ÿ ã€‚è¶™ç‹æï¼Œä¸æ•¢ä¸ç»ã€‚è¶™ç‹é€ç’§æ™‚ï¼Œé½‹æˆ’äº”æ—¥ï¼Œä»Šå¤§ç‹äº¦å®œé½‹æˆ’äº”æ—¥ï¼Œè¨­ä¹è³“æ–¼å»· ï¼Œè‡£ä¹ƒæ•¢ä¸Šç’§ã€‚ã€ç§¦ç‹åº¦ä¹‹ï¼Œçµ‚ä¸å¯å½Šå¥ª ï¼Œé‚è¨±é½‹äº”æ—¥ï¼Œèˆç›¸å¦‚å»£æˆå‚³ ã€‚\n\nã€€ã€€ç›¸å¦‚åº¦ç§¦ç‹é›–é½‹ï¼Œæ±ºè² ç´„ä¸å„ŸåŸï¼Œä¹ƒä½¿å…¶å¾è€…è¡£è¤ ï¼Œæ‡·å…¶ç’§ï¼Œå¾å¾‘é“ äº¡ ï¼Œæ­¸ç’§æ–¼è¶™ã€‚\n\nã€€ã€€ç§¦ç‹é½‹äº”æ—¥å¾Œï¼Œä¹ƒè¨­ä¹è³“ç¦®æ–¼å»·ï¼Œå¼•è¶™ä½¿è€…è—ºç›¸å¦‚ã€‚ç›¸å¦‚è‡³ï¼Œè¬‚ç§¦ç‹æ›°ï¼šã€Œç§¦è‡ªç¹†å…¬ ä»¥ä¾†äºŒåé¤˜å›ï¼Œæœªå˜—æœ‰å …æ˜ç´„æŸè€…ä¹Ÿ ã€‚è‡£èª æè¦‹æ¬ºæ–¼ç‹è€Œè² è¶™ï¼Œæ•…ä»¤äººæŒç’§æ­¸ï¼Œé–“è‡³è¶™çŸ£ ã€‚ä¸”ç§¦å½Šè€Œè¶™å¼±ï¼Œå¤§ç‹é£ä¸€ä»‹ ä¹‹ä½¿è‡³è¶™ï¼Œè¶™ç«‹å¥‰ç’§ä¾†ï¼›ä»Šä»¥ç§¦ä¹‹å½Šè€Œå…ˆå‰²åäº”éƒ½äºˆè¶™ï¼Œè¶™è±ˆæ•¢ç•™ç’§è€Œå¾—ç½ªæ–¼å¤§ç‹ä¹ï¼Ÿè‡£çŸ¥æ¬ºå¤§ç‹ä¹‹ç½ªç•¶èª…ï¼Œè‡£è«‹å°±æ¹¯é‘Š ã€‚å”¯å¤§ç‹èˆ‡ç¾£è‡£å­°è¨ˆè­°ä¹‹ ï¼ã€\n\nã€€ã€€ç§¦ç‹èˆ‡ç¾£è‡£ç›¸è¦–è€Œå˜» ã€‚å·¦å³æˆ–æ¬²å¼•ç›¸å¦‚å» ï¼Œç§¦ç‹å›  æ›°ï¼šã€Œä»Šæ®ºç›¸å¦‚ï¼Œçµ‚ä¸èƒ½å¾—ç’§ä¹Ÿï¼Œè€Œçµ•ç§¦è¶™ä¹‹é©©ï¼Œä¸å¦‚å› è€Œåšé‡ä¹‹ ï¼Œä½¿æ­¸è¶™ï¼Œè¶™ç‹è±ˆä»¥ä¸€ç’§ä¹‹æ•…æ¬ºç§¦é‚ª ï¼ã€å’å»·è¦‹ç›¸å¦‚ ï¼Œç•¢ç¦®è€Œæ­¸ä¹‹ã€‚\n\nã€€ã€€ç›¸å¦‚æ—¢æ­¸ï¼Œè¶™ç‹ä»¥ç‚ºè³¢å¤§å¤«ï¼Œä½¿ä¸è¾±æ–¼è«¸ä¾¯ ï¼Œæ‹œç›¸å¦‚ç‚ºä¸Šå¤§å¤« ã€‚\n\nã€€ã€€ç§¦äº¦ä¸ä»¥åŸäºˆè¶™ï¼Œè¶™äº¦çµ‚ä¸äºˆç§¦ç’§ã€‚\n\nã€€ã€€å…¶å¾Œç§¦ä¼è¶™ï¼Œæ‹”çŸ³åŸã€‚æ˜å¹´ï¼Œå¾©æ”»è¶™ï¼Œæ®ºäºŒè¬äººã€‚\n\nã€€ã€€ç§¦ç‹ä½¿ä½¿è€…å‘Šè¶™ç‹ï¼Œæ¬²èˆ‡ç‹ç‚ºå¥½æœƒæ–¼è¥¿æ²³å¤–æ¾ æ±  ã€‚è¶™ç‹ç•ç§¦ï¼Œæ¬²æ¯‹è¡Œ ã€‚å»‰é —ã€è—ºç›¸å¦‚è¨ˆæ›°ï¼šã€Œç‹ä¸è¡Œï¼Œç¤ºè¶™å¼±ä¸”æ€¯ä¹Ÿã€‚ã€è¶™ç‹é‚è¡Œï¼Œç›¸å¦‚å¾ã€‚å»‰é —é€è‡³å¢ƒï¼Œèˆ‡ç‹è¨£æ›° ï¼šã€Œç‹è¡Œï¼Œåº¦é“é‡Œæœƒé‡ä¹‹ç¦®ç•¢ ï¼Œé‚„ï¼Œä¸éä¸‰åæ—¥ã€‚ä¸‰åæ—¥ä¸é‚„ï¼Œå‰‡è«‹ç«‹å¤ªå­ç‚ºç‹ï¼Œä»¥çµ•ç§¦æœ›ã€‚ã€ç‹è¨±ä¹‹ï¼Œé‚èˆ‡ç§¦ç‹æœƒæ¾ æ± ã€‚\n\nã€€ã€€ç§¦ç‹é£²é…’é…£ ï¼Œæ›°ï¼šã€Œå¯¡äººç«Šèè¶™ç‹å¥½éŸ³ï¼Œè«‹å¥ç‘Ÿ ã€‚ã€è¶™ç‹é¼“ç‘Ÿã€‚ç§¦å¾¡å²å‰æ›¸æ›° ï¼šã€ŒæŸå¹´æœˆæ—¥ï¼Œç§¦ç‹èˆ‡è¶™ç‹æœƒé£²ï¼Œä»¤è¶™ç‹é¼“ç‘Ÿã€‚ã€è—ºç›¸å¦‚å‰æ›°ï¼šã€Œè¶™ç‹ç«Šèç§¦ç‹å–„ç‚ºç§¦è²ï¼Œè«‹å¥ç›†ç¼»ç§¦ç‹ ï¼Œä»¥ç›¸å¨›æ¨‚ã€‚ã€ç§¦ç‹æ€’ï¼Œä¸è¨±ã€‚æ–¼æ˜¯ç›¸å¦‚å‰é€²ç¼»ï¼Œå› è·ªè«‹ç§¦ç‹ã€‚ç§¦ç‹ä¸è‚¯æ“Šç¼»ã€‚ç›¸å¦‚æ›°ï¼šã€Œäº”æ­¥ä¹‹å…§ï¼Œç›¸å¦‚è«‹å¾—ä»¥é ¸è¡€æ¿ºå¤§ç‹çŸ£ ï¼ã€å·¦å³æ¬²åˆƒç›¸å¦‚ ï¼Œç›¸å¦‚å¼µç›®å±ä¹‹ï¼Œå·¦å³çš†é¡ ã€‚æ–¼æ˜¯ç§¦ç‹ä¸æ‡Œ ï¼Œç‚ºä¸€æ“Šç¼»ã€‚ç›¸å¦‚é¡§ å¬è¶™å¾¡å²æ›¸æ›°ï¼šã€ŒæŸå¹´æœˆæ—¥ï¼Œç§¦ç‹ç‚ºè¶™ç‹æ“Šç¼»ã€‚ã€ç§¦ä¹‹ç¾£è‡£æ›°ï¼šã€Œè«‹ä»¥è¶™åäº”åŸç‚ºç§¦ç‹å£½ ã€‚ã€è—ºç›¸å¦‚äº¦æ›°ï¼šã€Œè«‹ä»¥ç§¦ä¹‹å’¸é™½ ç‚ºè¶™ç‹å£½ã€‚ã€\n\nã€€ã€€ç§¦ç‹ç«Ÿé…’ ï¼Œçµ‚ä¸èƒ½åŠ å‹æ–¼è¶™ã€‚è¶™äº¦ç››è¨­å…µä»¥å¾…ç§¦ï¼Œç§¦ä¸æ•¢å‹•ã€‚\n\nã€€ã€€æ—¢ç½·æ­¸åœ‹ï¼Œä»¥ç›¸å¦‚åŠŸå¤§ï¼Œæ‹œç‚ºä¸Šå¿ï¼Œä½åœ¨å»‰é —ä¹‹å³ã€‚\n\nã€€ã€€å»‰é —æ›°ï¼šã€Œæˆ‘ç‚ºè¶™å°‡ï¼Œæœ‰æ”»åŸé‡æˆ°ä¹‹å¤§åŠŸï¼Œè€Œè—ºç›¸å¦‚å¾’ä»¥å£èˆŒç‚ºå‹ ï¼Œè€Œä½å±…æˆ‘ä¸Šï¼Œä¸”ç›¸å¦‚ç´ è³¤äºº ï¼Œå¾ç¾ï¼Œä¸å¿ç‚ºä¹‹ä¸‹ ã€‚ã€å®£è¨€æ›°ï¼šã€Œæˆ‘è¦‹ç›¸å¦‚ï¼Œå¿…è¾±ä¹‹ã€‚ã€ç›¸å¦‚èï¼Œä¸è‚¯èˆ‡æœƒã€‚ç›¸å¦‚æ¯æœæ™‚ï¼Œå¸¸ç¨±ç—…ï¼Œä¸æ¬²èˆ‡å»‰é —çˆ­åˆ— ã€‚å·²è€Œ ç›¸å¦‚å‡ºï¼Œæœ›è¦‹å»‰é —ï¼Œç›¸å¦‚å¼•è»Šé¿åŒ¿ ã€‚\n\nã€€ã€€æ–¼æ˜¯èˆäººç›¸èˆ‡è««æ›°ï¼šã€Œè‡£æ‰€ä»¥å»è¦ªæˆšè€Œäº‹å›è€… ï¼Œå¾’æ…•å›ä¹‹é«˜ç¾©ä¹Ÿ ã€‚ä»Šå›èˆ‡å»‰é —åŒåˆ—ï¼Œå»‰å›å®£æƒ¡è¨€è€Œå›ç•åŒ¿ä¹‹ï¼Œææ‡¼æ®Šç”šï¼Œä¸”åº¸äººå°šç¾ä¹‹ï¼Œæ³æ–¼å°‡ç›¸ä¹ï¼è‡£ç­‰ä¸è‚– ï¼Œè«‹è¾­å»ã€‚ã€è—ºç›¸å¦‚å›ºæ­¢ä¹‹ï¼Œæ›°ï¼šã€Œå…¬ä¹‹è¦–å»‰å°‡è»å­°èˆ‡ç§¦ç‹ ï¼Ÿã€æ›°ï¼šã€Œä¸è‹¥ä¹Ÿ ã€‚ã€ç›¸å¦‚æ›°ï¼šã€Œå¤«ä»¥ç§¦ç‹ä¹‹å¨ï¼Œè€Œç›¸å¦‚å»·å±ä¹‹ï¼Œè¾±å…¶ç¾£è‡£ï¼Œç›¸å¦‚é›–é§‘ ï¼Œç¨ç•å»‰å°‡è»å“‰ï¼Ÿé¡§ å¾å¿µä¹‹ï¼Œå½Šç§¦ä¹‹æ‰€ä»¥ä¸æ•¢åŠ å…µæ–¼è¶™è€…ï¼Œå¾’ä»¥å¾å…©äººåœ¨ä¹Ÿã€‚ä»Šå…©è™å…±é¬¥ï¼Œå…¶å‹¢ä¸ä¿±ç”Ÿ ã€‚å¾æ‰€ä»¥ç‚ºæ­¤è€…ï¼Œä»¥å…ˆåœ‹å®¶ä¹‹æ€¥è€Œå¾Œç§è®ä¹Ÿ ã€‚ã€\n\nã€€ã€€å»‰é —èä¹‹ï¼Œè‚‰è¢’ è² èŠ ï¼Œå› è³“å®¢è‡³è—ºç›¸å¦‚é–€è¬ç½ª ã€‚æ›°ï¼šã€Œé„™è³¤ä¹‹äººï¼Œä¸çŸ¥å°‡è»å¯¬ä¹‹è‡³æ­¤ä¹Ÿ ã€‚ã€\n\nã€€ã€€å’ç›¸èˆ‡é©©ï¼Œç‚ºåˆé ¸ä¹‹äº¤ ã€‚" },
        { "title": "å±±å±…ç§‹æš", "content": "ç©ºå±±æ–°é›¨å¾Œ ï¼Œå¤©æ°£æ™šä¾†ç§‹ã€‚\næ˜æœˆæ¾é–“ç…§ï¼Œæ¸…æ³‰çŸ³ä¸Šæµã€‚\nç«¹å–§æ­¸æµ£å¥³ï¼Œè“®å‹•ä¸‹æ¼èˆŸã€‚ \néš¨æ„æ˜¥èŠ³æ­‡ ï¼Œç‹å­«è‡ªå¯ç•™ ã€‚" },
        { "title": "æœˆä¸‹ç¨é…Œ", "content": "èŠ±é–“ä¸€å£ºé…’ï¼Œç¨é…Œç„¡ç›¸è¦ª ã€‚ \nèˆ‰æ¯é‚€æ˜æœˆï¼Œå°å½±æˆä¸‰äºº ã€‚\næœˆæ—¢ä¸è§£ é£²ï¼Œå½±å¾’éš¨æˆ‘èº«ã€‚\næš«ä¼´æœˆå°‡ å½±ï¼Œè¡Œæ¨‚é ˆåŠæ˜¥ ã€‚ \næˆ‘æ­Œæœˆå¾˜å¾Š ï¼Œæˆ‘èˆå½±é›¶äº‚ ã€‚ \né†’æ™‚åŒäº¤æ­¡ ï¼Œé†‰å¾Œå„åˆ†æ•£ ã€‚\næ°¸çµç„¡æƒ…éŠ ï¼Œç›¸æœŸé‚ˆé›²æ¼¢ ã€‚" },
        { "title": "ç™»æ¨“", "content": "èŠ±è¿‘é«˜æ¨“å‚·å®¢å¿ƒï¼Œ è¬æ–¹å¤šé›£æ­¤ç™»è‡¨ã€‚ \néŒ¦æ±Ÿæ˜¥è‰²ä¾†å¤©åœ°ï¼Œ ç‰å£˜æµ®é›²è®Šå¤ä»Šã€‚ \nåŒ—æ¥µæœå»·çµ‚ä¸æ”¹ï¼Œ è¥¿å±±å¯‡ç›œè«ç›¸ä¾µã€‚ \nå¯æ†å¾Œä¸»é‚„ç¥ å»Ÿï¼Œ æ—¥æš®èŠç‚ºã€ˆæ¢ç”«åŸã€‰ã€‚" },
        { "title": "å¸«èªª", "content": "å¤ä¹‹å­¸è€…å¿…æœ‰å¸«ã€‚å¸«è€…ï¼Œæ‰€ä»¥å‚³é“ã€å—æ¥­ ã€è§£æƒ‘ä¹Ÿã€‚äººéç”Ÿè€ŒçŸ¥ä¹‹è€… ï¼Œå­°èƒ½ç„¡æƒ‘ï¼Ÿæƒ‘è€Œä¸å¾å¸«ï¼Œå…¶ç‚ºæƒ‘ä¹Ÿçµ‚ä¸è§£çŸ£ã€‚\n\nç”Ÿä¹å¾å‰ï¼Œå…¶èé“ ä¹Ÿå›º å…ˆä¹å¾ï¼Œå¾å¾è€Œå¸«ä¹‹ï¼›ç”Ÿä¹å¾å¾Œï¼Œå…¶èé“ä¹Ÿäº¦å…ˆä¹å¾ï¼Œå¾å¾è€Œå¸«ä¹‹ã€‚å¾å¸«é“ä¹Ÿï¼Œå¤«åº¸çŸ¥ å…¶å¹´ä¹‹å…ˆå¾Œç”Ÿæ–¼å¾ä¹ï¼Ÿæ˜¯æ•…ç„¡è²´ç„¡è³¤ï¼Œç„¡é•·ç„¡å°‘ï¼Œé“ä¹‹æ‰€å­˜ï¼Œå¸«ä¹‹æ‰€å­˜ä¹Ÿã€‚\n\nå—Ÿä¹ï¼å¸«é“ä¹‹ä¸å‚³ä¹Ÿä¹…çŸ£ï¼æ¬²äººä¹‹ç„¡æƒ‘ä¹Ÿé›£çŸ£ï¼å¤ä¹‹è–äººï¼Œå…¶å‡ºäººä¹Ÿé çŸ£ï¼ŒçŒ¶ä¸”å¾å¸«è€Œå•ç„‰ï¼›ä»Šä¹‹çœ¾äººï¼Œå…¶ä¸‹è–äººä¹Ÿäº¦é çŸ£ï¼Œè€Œæ¥å­¸æ–¼å¸«ï¼›æ˜¯æ•…è–ç›Šè–ï¼Œæ„šç›Šæ„šï¼Œè–äººä¹‹æ‰€ä»¥ç‚ºè–ï¼Œæ„šäººä¹‹æ‰€ä»¥ç‚ºæ„šï¼Œå…¶ çš†å‡ºæ–¼æ­¤ä¹ï¼Ÿ\n\næ„›å…¶å­ï¼Œæ“‡å¸«è€Œæ•™ä¹‹ï¼Œæ–¼å…¶èº«ä¹Ÿï¼Œå‰‡æ¥å¸«ç„‰ï¼Œæƒ‘çŸ£ï¼å½¼ç«¥å­ä¹‹å¸«ï¼Œæˆä¹‹æ›¸è€Œç¿’å…¶å¥è®€ è€…ä¹Ÿï¼Œéå¾æ‰€è¬‚å‚³å…¶é“ï¼Œè§£å…¶æƒ‘è€…ä¹Ÿã€‚å¥è®€ä¹‹ä¸çŸ¥ï¼Œæƒ‘ä¹‹ä¸è§£ï¼Œæˆ–å¸«ç„‰ï¼Œæˆ–ä¸ç„‰ï¼Œå°å­¸è€Œå¤§éºï¼Œå¾æœªè¦‹å…¶æ˜ä¹Ÿã€‚\n\nå·«é†« ã€æ¨‚å¸«ï¼Œç™¾å·¥ä¹‹äººï¼Œä¸æ¥ç›¸å¸«ï¼›å£«å¤§å¤«ä¹‹æ—ï¼Œæ›°å¸«ã€æ›°å¼Ÿå­äº‘è€…ï¼Œå‰‡ç¾¤èšè€Œç¬‘ä¹‹ï¼Œå•ä¹‹ï¼Œå‰‡æ›°ï¼šã€Œå½¼èˆ‡å½¼å¹´ç›¸è‹¥ä¹Ÿï¼Œé“ç›¸ä¼¼ä¹Ÿã€‚ä½å‘å‰‡è¶³ç¾ï¼Œå®˜ç››å‰‡è¿‘è«› ã€‚ã€å—šå‘¼ï¼å¸«é“ä¹‹ä¸å¾©å¯çŸ¥çŸ£ã€‚å·«ã€é†«ã€æ¨‚å¸«ã€ç™¾å·¥ä¹‹äººï¼Œå›å­ ä¸é½’ ï¼Œä»Šå…¶æ™ºä¹ƒåä¸èƒ½åŠï¼Œå…¶å¯æ€ªä¹Ÿæ­Ÿï¼\n\nè–äººç„¡å¸¸å¸« ï¼Œå­”å­å¸«éƒ¯å­ ã€è‡å¼˜ ã€å¸«è¥„ ã€è€èƒ ã€‚éƒ¯å­ä¹‹å¾’ï¼Œå…¶è³¢ä¸åŠå­”å­ã€‚å­”å­æ›°ï¼šã€Œä¸‰äººè¡Œï¼Œå‰‡å¿…æœ‰æˆ‘å¸«ã€‚ã€ æ˜¯æ•…å¼Ÿå­ä¸å¿…ä¸å¦‚å¸«ï¼Œå¸«ä¸å¿…è³¢æ–¼å¼Ÿå­ï¼Œèé“æœ‰å…ˆå¾Œï¼Œè¡“æ¥­æœ‰å°ˆæ”»ï¼Œå¦‚æ˜¯è€Œå·²ã€‚\n\nææ°å­èŸ  ï¼Œå¹´åä¸ƒï¼Œå¥½å¤æ–‡ï¼Œå…­è— ç¶“å‚³ï¼Œçš†é€šç¿’ä¹‹ï¼›ä¸æ‹˜æ–¼æ™‚ï¼Œå­¸æ–¼ä½™ï¼Œä½™å˜‰å…¶èƒ½è¡Œå¤é“ï¼Œä½œã€ˆå¸«èªªã€‰ä»¥è²½ ä¹‹ã€‚" },
        { "title": "å²³é™½æ¨“è¨˜", "content": "æ…¶æ›†å››å¹´æ˜¥ ï¼Œæ»•å­äº¬ è¬«å®ˆå·´é™µéƒ¡ ã€‚è¶Šæ˜å¹´ï¼Œæ”¿é€šäººå’Œï¼Œç™¾å»¢å…· èˆˆã€‚ä¹ƒé‡ä¿®å²³é™½æ¨“ï¼Œå¢å…¶èˆŠåˆ¶ï¼Œåˆ»å”è³¢ã€ä»Šäººè©©è³¦æ–¼å…¶ä¸Šï¼›å±¬ äºˆä½œæ–‡ä»¥è¨˜ä¹‹ã€‚\n\näºˆè§€å¤«å·´é™µå‹ç‹€ ï¼Œåœ¨æ´åº­ä¸€æ¹–ã€‚éŠœé å±±ï¼Œåé•·æ±Ÿï¼Œæµ©æµ©æ¹¯æ¹¯ ï¼Œæ©«ç„¡éš›æ¶¯ï¼›æœæš‰å¤•é™°ï¼Œæ°£è±¡è¬åƒã€‚æ­¤å‰‡å²³é™½æ¨“ä¹‹å¤§è§€ä¹Ÿï¼Œå‰äººä¹‹è¿°å‚™ çŸ£ã€‚ç„¶å‰‡åŒ—é€šå·«å³½ ï¼Œå—æ¥µç€Ÿæ¹˜ ï¼Œé·å®¢é¨·äºº ï¼Œå¤šæœƒæ–¼æ­¤ï¼Œè¦½ç‰©ä¹‹æƒ…ï¼Œå¾—ç„¡ç•°ä¹ï¼Ÿ\n\nè‹¥å¤«éœªé›¨éœéœ ï¼Œé€£æœˆä¸é–‹ï¼›é™°é¢¨æ€’è™Ÿ ï¼Œæ¿æµªæ’ç©ºï¼›æ—¥æ˜Ÿéš±è€€ï¼Œå±±å²³æ½›å½¢ï¼›å•†æ—…ä¸è¡Œï¼Œæª£å‚¾æ¥«æ‘§ ï¼›è–„æš®å†¥å†¥ ï¼Œè™å˜¯çŒ¿å•¼ã€‚ç™»æ–¯æ¨“ä¹Ÿï¼Œå‰‡æœ‰å»åœ‹ æ‡·é„‰ï¼Œæ†‚è®’ç•è­ï¼Œæ»¿ç›®è•­ç„¶ ï¼Œæ„Ÿæ¥µè€Œæ‚²è€…çŸ£ã€‚\n\nè‡³è‹¥æ˜¥å’Œæ™¯æ˜ ï¼Œæ³¢ç€¾ä¸é©š ï¼Œä¸Šä¸‹å¤©å…‰ï¼Œä¸€ç¢§è¬é ƒï¼›æ²™é·—ç¿”é›† ï¼ŒéŒ¦é±—æ¸¸æ³³ï¼Œå²¸èŠ·æ±€è˜­ ï¼Œéƒéƒé’é’ ã€‚è€Œæˆ–é•·ç…™ä¸€ç©º ï¼Œçš“æœˆåƒé‡Œï¼Œæµ®å…‰èºé‡‘ ï¼Œéœå½±æ²‰ç’§ ï¼›æ¼æ­Œäº’ç­”ï¼Œæ­¤æ¨‚ä½•æ¥µï¼ç™»æ–¯æ¨“ä¹Ÿï¼Œå‰‡æœ‰å¿ƒæ› ç¥æ€¡ ï¼Œå¯µè¾± çš†å¿˜ï¼ŒæŠŠé…’è‡¨é¢¨ ï¼Œå…¶å–œæ´‹æ´‹ è€…çŸ£ã€‚\n\nå—Ÿå¤«ï¼äºˆå˜—æ±‚å¤ä»äººä¹‹å¿ƒï¼Œæˆ–ç•°äºŒè€…ä¹‹ç‚º ã€‚ä½•å“‰ï¼Ÿä¸ä»¥ç‰©å–œï¼Œä¸ä»¥å·±æ‚² ã€‚å±…å»Ÿå ‚ä¹‹é«˜ ï¼Œå‰‡æ†‚å…¶æ°‘ï¼›è™•æ±Ÿæ¹–ä¹‹é  ï¼Œå‰‡æ†‚å…¶å›ã€‚æ˜¯é€²äº¦æ†‚ï¼Œé€€äº¦æ†‚ï¼Œç„¶å‰‡ä½•æ™‚è€Œæ¨‚è€¶ï¼Ÿå…¶å¿…æ›°ï¼šã€Œå…ˆå¤©ä¸‹ä¹‹æ†‚è€Œæ†‚ï¼Œå¾Œå¤©ä¸‹ä¹‹æ¨‚è€Œæ¨‚ã€æ­Ÿï¼å™«ï¼å¾®æ–¯äºº ï¼Œå¾èª°èˆ‡æ­¸ ï¼" },
        { "title": "å§‹å¾—è¥¿å±±å®´éŠè¨˜", "content": "è‡ªä½™ç‚ºåƒ‡äºº ï¼Œå±…æ˜¯å·ï¼Œæ’æƒ´æ…„ ã€‚å…¶éš™ä¹Ÿ ï¼Œå‰‡æ–½æ–½ è€Œè¡Œï¼Œæ¼«æ¼« è€ŒéŠã€‚æ—¥èˆ‡å…¶å¾’ ä¸Šé«˜å±±ï¼Œå…¥æ·±æ—ï¼Œçª®è¿´æºª ï¼Œå¹½æ³‰ æ€ªçŸ³ï¼Œç„¡é ä¸åˆ°ã€‚åˆ°å‰‡æŠ«è‰ è€Œåï¼Œå‚¾å£ºè€Œé†‰ã€‚é†‰å‰‡æ›´ç›¸æ• ä»¥è‡¥ï¼Œè‡¥è€Œå¤¢ã€‚æ„æœ‰æ‰€æ¥µ ï¼Œå¤¢äº¦åŒè¶£ ã€‚è¦º è€Œèµ·ï¼Œèµ·è€Œæ­¸ã€‚ä»¥ç‚ºå‡¡æ˜¯å·ä¹‹å±±æœ‰ç•°æ…‹è€…ï¼Œçš†æˆ‘æœ‰ä¹Ÿï¼Œè€Œæœªå§‹çŸ¥è¥¿å±±ä¹‹æ€ªç‰¹ã€‚\n\nä»Šå¹´ä¹æœˆäºŒåå…«æ—¥ï¼Œå› åæ³•è¯è¥¿äº­ ï¼Œæœ›è¥¿å±±ï¼Œå§‹æŒ‡ç•°ä¹‹ ã€‚é‚å‘½åƒ•éæ¹˜æ±Ÿ ï¼Œç·£æŸ“æºª ï¼Œæ–«æ¦›è½ ã€‚ç„šèŒ…èŒ· ï¼Œçª® å±±ä¹‹é«˜è€Œæ­¢ã€‚\n\næ”€æ´è€Œç™»ï¼Œç®•è¸è€Œé¨ ï¼Œå‰‡å‡¡æ•¸å·ä¹‹åœŸå£¤ ï¼Œçš†åœ¨è¡½å¸­ ä¹‹ä¸‹ã€‚å…¶é«˜ä¸‹ä¹‹å‹¢ï¼Œå²ˆç„¶çªªç„¶ ï¼Œè‹¥å¤ è‹¥ç©´ï¼Œå°ºå¯¸åƒé‡Œ ï¼Œæ”¢è¹™ç´¯ç© ï¼Œè«å¾—é¯éš± ã€‚ç¸ˆé’ç¹šç™½ ï¼Œå¤–èˆ‡å¤©éš› ï¼Œå››æœ›å¦‚ä¸€ã€‚ç„¶å¾ŒçŸ¥æ˜¯å±±ä¹‹ç‰¹å‡ºï¼Œä¸èˆ‡åŸ¹å¡¿ ç‚ºé¡ã€‚æ‚ æ‚ ä¹èˆ‡é¡¥æ°£ ä¿±ï¼Œè€Œè«å¾—å…¶æ¶¯ï¼›æ´‹æ´‹ ä¹èˆ‡é€ ç‰©è€…éŠ ï¼Œè€Œä¸çŸ¥å…¶æ‰€çª®ã€‚\n\nå¼• è§´æ»¿é…Œï¼Œé ¹ç„¶ å°±é†‰ï¼Œä¸çŸ¥æ—¥ä¹‹å…¥ã€‚è’¼ç„¶æš®è‰² ï¼Œè‡ªé è€Œè‡³ï¼Œè‡³ç„¡æ‰€è¦‹ï¼Œè€ŒçŒ¶ä¸æ¬²æ­¸ã€‚å¿ƒå‡å½¢é‡‹ ï¼Œèˆ‡è¬åŒ–å†¥åˆ ã€‚ç„¶å¾ŒçŸ¥å¾åš® ä¹‹æœªå§‹ éŠï¼ŒéŠæ–¼æ˜¯ä¹å§‹ï¼Œæ•…ç‚ºä¹‹æ–‡ä»¥å¿— ã€‚æ˜¯æ­²å…ƒå’Œå››å¹´ ä¹Ÿã€‚" },
        { "title": "å¿µå¥´å¬Œâ€§èµ¤å£æ‡·å¤", "content": "å¤§æ±Ÿæ±å»ï¼Œæµªæ·˜ç›¡ã€åƒå¤é¢¨æµäººç‰©ã€‚æ•…å£˜è¥¿é‚Šï¼Œäººé“æ˜¯ã€ä¸‰åœ‹å‘¨éƒ èµ¤å£ã€‚äº‚çŸ³ç©¿ç©ºï¼Œé©šæ¿¤æ‹å²¸ï¼Œæ²èµ·åƒå †é›ªã€‚æ±Ÿå±±å¦‚ç•«ï¼Œä¸€æ™‚å¤šå°‘è±ªå‚‘ï¼\n\né™æƒ³å…¬ç‘¾ç•¶å¹´ï¼Œå°å–¬ åˆå«äº†ï¼Œé›„å§¿è‹±ç™¼ã€‚ç¾½æ‰‡ç¶¸å·¾ ï¼Œè«‡ç¬‘é–“ã€æª£æ«“ ç°é£›ç…™æ»…ã€‚æ•…åœ‹ ç¥éŠï¼Œå¤šæƒ…æ‡‰ç¬‘æˆ‘ï¼Œæ—©ç”Ÿè¯é«® ã€‚äººé–“å¦‚å¤¢ï¼Œä¸€å°Š é‚„é…¹ æ±Ÿæœˆã€‚" },
        { "title": "é’ç‰æ¡ˆ", "content": "æ±é¢¨å¤œæ”¾èŠ±åƒæ¨¹ï¼Œæ›´å¹è½ï¼Œæ˜Ÿå¦‚é›¨ã€‚å¯¶é¦¬é›•è»Šé¦™æ»¿è·¯ã€‚é³³ç°«è²å‹•ï¼Œç‰å£ºå…‰è½‰ï¼Œä¸€å¤œé­šé¾èˆã€‚ \n\nè›¾å…’é›ªæŸ³é»ƒé‡‘ç¸·ï¼Œç¬‘èªç›ˆç›ˆæš—é¦™å»ã€‚çœ¾è£å°‹ä»–åƒç™¾åº¦ï¼›é©€ç„¶è¿´é¦–ï¼Œé‚£äººå»åœ¨ï¼Œç‡ˆç«é—ŒçŠè™•ã€‚" },
        { "title": "è²è²æ…¢", "content": "å°‹å°‹è¦“è¦“ï¼Œå†·å†·æ¸…æ¸…ï¼Œæ‚½æ‚½æ…˜æ…˜æˆšæˆšã€‚ä¹æš–é‚„å¯’æ™‚å€™ï¼Œ æœ€é›£å°‡æ¯ã€‚ ä¸‰æ¯å…©ç›æ·¡é…’ï¼Œæ€æ•µä»–ï¼Œæ™šä¾†é¢¨æ€¥ï¼Ÿé›éä¹Ÿï¼Œæ­£å‚·å¿ƒï¼Œå»æ˜¯èˆŠæ™‚ç›¸è­˜ã€‚\n\næ»¿åœ°é»ƒèŠ±å †ç©ï¼Œ æ†”æ‚´æï¼Œå¦‚ä»Šæœ‰èª°å ªæ‘˜ï¼Ÿå®ˆè‘—çª—å…’ï¼Œç¨è‡ªæ€ç”Ÿå¾—é»‘ï¼æ¢§æ¡æ›´å…¼ç´°é›¨ï¼Œåˆ°é»ƒæ˜ã€é»é»æ»´æ»´ã€‚é€™æ¬¡ç¬¬ï¼Œæ€ä¸€ç®‡æ„å­—äº†å¾—ï¼" },
        { "title": "é€é™éŠ", "content": "æƒ å­ è¬‚èŠå­æ›°ï¼šã€Œé­ç‹è²½æˆ‘å¤§ç“ ä¹‹ç¨® ï¼Œæˆ‘æ¨¹ä¹‹æˆè€Œå¯¦äº”çŸ³ ã€‚ä»¥ç››æ°´æ¼¿ï¼Œå…¶å …ä¸èƒ½è‡ªèˆ‰ä¹Ÿ ã€‚å‰–ä¹‹ä»¥ç‚ºç“¢ ï¼Œå‰‡ç“ è½ç„¡æ‰€å®¹ ã€‚éä¸å‘ºç„¶ å¤§ä¹Ÿï¼Œå¾ç‚ºå…¶ç„¡ç”¨è€ŒæŠä¹‹ ã€‚ã€èŠå­æ›°ï¼šã€Œå¤«å­å›ºæ‹™æ–¼ ç”¨å¤§çŸ£ï¼å®‹äººæœ‰å–„ç‚ºä¸é¾œæ‰‹ä¹‹è—¥è€… ï¼Œä¸–ä¸–ä»¥æ´´æ¾¼çµ–ç‚ºäº‹ ã€‚å®¢èä¹‹ï¼Œè«‹è²·å…¶æ–¹ç™¾é‡‘ã€‚èšæ—è€Œè¬€æ›°ï¼šã€æˆ‘ä¸–ä¸–ç‚ºæ´´æ¾¼çµ–ï¼Œä¸éæ•¸é‡‘ï¼›ä»Šä¸€æœè€Œé¬»æŠ€ç™¾é‡‘ ï¼Œè«‹èˆ‡ä¹‹ã€‚ã€å®¢å¾—ä¹‹ï¼Œä»¥èªª å³ç‹ã€‚è¶Šæœ‰é›£ ï¼Œå³ç‹ä½¿ä¹‹å°‡ ï¼Œå†¬èˆ‡è¶Šäººæ°´æˆ°ï¼Œå¤§æ•—è¶Šäººï¼Œè£‚åœ° è€Œå°ä¹‹ã€‚èƒ½ä¸é¾œæ‰‹ä¸€ä¹Ÿ ï¼›æˆ–ä»¥å°ï¼Œæˆ–ä¸å…æ–¼æ´´æ¾¼çµ–ï¼Œå‰‡æ‰€ç”¨ä¹‹ç•°ä¹Ÿ ã€‚ä»Šå­æœ‰äº”çŸ³ä¹‹ç“ ï¼Œä½•ä¸æ…®ä»¥ç‚ºå¤§æ¨½è€Œæµ®æ–¼æ±Ÿæ¹– ï¼Œè€Œæ†‚å…¶ç“ è½ç„¡æ‰€å®¹ï¼Œå‰‡å¤«å­çŒ¶æœ‰è“¬ä¹‹å¿ƒä¹Ÿå¤« ï¼ã€\n\næƒ å­è¬‚èŠå­æ›°ï¼šã€Œå¾æœ‰å¤§æ¨¹ï¼Œäººè¬‚ä¹‹æ¨— ï¼›å…¶å¤§æœ¬æ“è…«è€Œä¸ä¸­ç¹©å¢¨ ï¼Œå…¶å°æå·æ›²è€Œä¸ä¸­è¦çŸ© ã€‚ç«‹ä¹‹å¡— ï¼ŒåŒ è€…ä¸é¡§ã€‚ä»Šå­ä¹‹è¨€ï¼Œå¤§è€Œç„¡ç”¨ï¼Œè¡†æ‰€åŒå»ä¹Ÿ ã€‚ã€èŠå­æ›°ï¼šã€Œå­ç¨ä¸è¦‹ç‹¸ç‹Œä¹ ï¼Ÿå‘èº«è€Œä¼ï¼Œä»¥å€™æ•–è€… ï¼›æ±è¥¿è·³æ¢ï¼Œä¸è¾Ÿé«˜ä¸‹ ï¼Œä¸­æ–¼æ©Ÿè¾Ÿï¼Œæ­»æ–¼ç½”ç½Ÿ ã€‚ä»Šå¤«æ–„ç‰›ï¼Œå…¶å¤§è‹¥å‚å¤©ä¹‹é›² ï¼›æ­¤èƒ½ç‚ºå¤§çŸ£ï¼Œè€Œä¸èƒ½åŸ·é¼  ã€‚ä»Šå­æœ‰å¤§æ¨¹ï¼Œæ‚£å…¶ç„¡ç”¨ï¼Œä½•ä¸æ¨¹ä¹‹æ–¼ç„¡ä½•æœ‰ä¹‹é„‰ ï¼Œå»£è«ä¹‹é‡ ï¼Œå½·å¾¨ä¹ç„¡ç‚ºå…¶å´ï¼Œé€é™ä¹å¯¢è‡¥å…¶ä¸‹ ï¼›ä¸å¤­æ–¤æ–§ï¼Œç‰©ç„¡å®³è€… ã€‚ç„¡æ‰€å¯ç”¨ï¼Œå®‰æ‰€å›°è‹¦å“‰ ï¼Ÿã€" },
        { "title": "å‡ºå¸«è¡¨", "content": "å…ˆå¸å‰µæ¥­æœªåŠ ï¼Œè€Œä¸­é“å´©æ®‚ ï¼›ä»Šå¤©ä¸‹ä¸‰åˆ† ï¼Œç›Šå·ç–²å¼Š ï¼Œæ­¤èª å±æ€¥å­˜äº¡ä¹‹ç§‹ä¹Ÿï¹—ç„¶ä¾è¡ä¹‹è‡£ï¼Œä¸æ‡ˆæ–¼å…§ï¼›å¿ å¿—ä¹‹å£«ï¼Œå¿˜èº«æ–¼å¤–è€… ï¼Œè“‹è¿½å…ˆå¸ä¹‹æ®Šé‡ï¼Œæ¬²å ±ä¹‹æ–¼é™›ä¸‹ä¹Ÿ ã€‚èª å®œé–‹å¼µè–è½ ï¼Œä»¥å…‰å…ˆå¸éºå¾· ï¼Œæ¢å¼˜å¿—å£«ä¹‹æ°£ ï¹”ä¸å®œå¦„è‡ªè²è–„ ï¼Œå¼•å–»å¤±ç¾© ï¼Œä»¥å¡å¿ è««ä¹‹è·¯ä¹Ÿ ã€‚\n\nå®®ä¸­ã€åºœä¸­ï¼Œä¿±ç‚ºä¸€é«” ï¼›é™Ÿç½°è‡§å¦ ï¼Œä¸å®œç•°åŒã€‚è‹¥æœ‰ä½œå§¦ã€çŠ¯ç§‘ï¼ŒåŠç‚ºå¿ å–„è€… ï¼Œå®œä»˜æœ‰å¸ï¼Œè«–å…¶åˆ‘è³ ï¼Œä»¥æ˜­é™›ä¸‹å¹³æ˜ä¹‹æ²» ï¼›ä¸å®œåç§ï¼Œä½¿å…§å¤–ç•°æ³•ä¹Ÿ ã€‚\n\nä¾ä¸­ã€ä¾éƒéƒ­æ”¸ä¹‹ã€è²»ç¦•ã€è‘£å…ç­‰ ï¼Œæ­¤çš†è‰¯å¯¦ï¼Œå¿—æ…®å¿ ç´” ï¼Œæ˜¯ä»¥å…ˆå¸ç°¡æ‹”ä»¥éºé™›ä¸‹ ã€‚æ„šä»¥ç‚ºå®®ä¸­ä¹‹äº‹ï¼Œäº‹ç„¡å¤§å°ï¼Œæ‚‰ä»¥å’¨ä¹‹ ï¼Œç„¶å¾Œæ–½è¡Œï¼Œå¿…èƒ½è£¨è£œé—•æ¼ï¼Œæœ‰æ‰€å»£ç›Š ã€‚\n\nå°‡è»å‘å¯µï¼Œæ€§è¡Œæ·‘å‡ ï¼Œæ›‰æš¢è»äº‹ï¼Œè©¦ç”¨æ–¼æ˜”æ—¥ï¼Œå…ˆå¸ç¨±ä¹‹æ›°ã€Œèƒ½ã€ï¼Œæ˜¯ä»¥çœ¾è­°èˆ‰å¯µç‚ºç£ ã€‚æ„šä»¥ç‚ºç‡Ÿä¸­ä¹‹äº‹ï¼Œæ‚‰ä»¥å’¨ä¹‹ï¼Œå¿…èƒ½ä½¿è¡Œé™£å’Œç¦ï¼Œå„ªåŠ£å¾—æ‰€ ã€‚\n\nè¦ªè³¢è‡£ï¼Œé å°äºº ï¼Œæ­¤å…ˆæ¼¢æ‰€ä»¥èˆˆéš†ä¹Ÿï¹”è¦ªå°äººï¼Œé è³¢è‡£ï¼Œæ­¤å¾Œæ¼¢æ‰€ä»¥å‚¾é ¹ä¹Ÿã€‚å…ˆå¸åœ¨æ™‚ï¼Œæ¯èˆ‡è‡£è«–æ­¤äº‹ï¼Œæœªå˜—ä¸æ­æ¯ç—›æ¨æ–¼æ¡“ã€éˆä¹Ÿ ï¼ä¾ä¸­ã€å°šæ›¸ã€é•·å²ã€åƒè» ï¼Œæ­¤æ‚‰è²è‰¯æ­»ç¯€ä¹‹è‡£ï¼Œé¡˜é™›ä¸‹è¦ªä¹‹ã€ä¿¡ä¹‹ï¼Œå‰‡æ¼¢å®¤ä¹‹éš†ï¼Œå¯è¨ˆæ—¥è€Œå¾…ä¹Ÿã€‚\n\nè‡£æœ¬å¸ƒè¡£ï¼Œèº¬è€•æ–¼å—é™½ ï¼Œè‹Ÿå…¨æ€§å‘½æ–¼äº‚ä¸–ï¼Œä¸æ±‚èé”æ–¼è«¸ä¾¯ ã€‚å…ˆå¸ä¸ä»¥è‡£å‘é„™ï¼ŒçŒ¥è‡ªæ‰å±ˆ ï¼Œä¸‰é¡§è‡£æ–¼è‰å»¬ä¹‹ä¸­ï¼Œè«®è‡£ä»¥ç•¶ä¸–ä¹‹äº‹ï¼›ç”±æ˜¯æ„Ÿæ¿€ï¼Œé‚è¨±å…ˆå¸ä»¥é©…é¦³ ã€‚å¾Œå€¼å‚¾è¦† ï¼Œå—ä»»æ–¼æ•—è»ä¹‹éš›ï¼Œå¥‰å‘½æ–¼å±é›£ä¹‹é–“ï¼Œçˆ¾ä¾†äºŒåæœ‰ä¸€å¹´çŸ£ ã€‚å…ˆå¸çŸ¥è‡£è¬¹æ…ï¼Œæ•…è‡¨å´©å¯„è‡£ä»¥å¤§äº‹ä¹Ÿ ã€‚å—å‘½ä»¥ä¾†ï¼Œå¤™å¤œæ†‚æ­ï¼Œæè¨—ä»˜ä¸æ•ˆï¼Œä»¥å‚·å…ˆå¸ä¹‹æ˜ ã€‚æ•…äº”æœˆæ¸¡ç€˜ï¼Œæ·±å…¥ä¸æ¯› ã€‚ä»Šå—æ–¹å·²å®šï¼Œå…µç”²å·²è¶³ï¼Œç•¶çç‡ä¸‰è»ï¼ŒåŒ—å®šä¸­åŸï¼Œåº¶ç«­é§‘éˆï¼Œæ”˜é™¤å§¦å‡¶ ï¼Œèˆˆå¾©æ¼¢å®¤ï¼Œé‚„æ–¼èˆŠéƒ½ ã€‚æ­¤è‡£æ‰€ä»¥å ±å…ˆå¸è€Œå¿ é™›ä¸‹ä¹‹è·åˆ†ä¹Ÿã€‚è‡³æ–¼æ–Ÿé…Œæç›Šï¼Œé€²ç›¡å¿ è¨€ï¼Œå‰‡æ”¸ä¹‹ã€ç¦•ã€å…ä¹‹ä»»ä¹Ÿ ã€‚\n\né¡˜é™›ä¸‹è¨—è‡£ä»¥è¨è³Šèˆˆå¾©ä¹‹æ•ˆï¼›ä¸æ•ˆï¼Œå‰‡æ²»è‡£ä¹‹ç½ªï¼Œä»¥å‘Šå…ˆå¸ä¹‹éˆã€‚è‹¥ç„¡èˆˆå¾·ä¹‹è¨€ï¼Œå‰‡è²¬æ”¸ä¹‹ã€ç¦•ã€å…ç­‰ä¹‹æ…¢ï¼Œä»¥å½°å…¶å’ ã€‚é™›ä¸‹äº¦å®œè‡ªè¬€ï¼Œä»¥è«®è«å–„é“ï¼Œå¯Ÿç´é›…è¨€ ï¼Œæ·±è¿½å…ˆå¸éºè©”ã€‚è‡£ä¸å‹å—æ©æ„Ÿæ¿€ã€‚ä»Šç•¶é é›¢ï¼Œè‡¨è¡¨æ¶•é›¶ ï¼Œä¸çŸ¥æ‰€è¨€ ï¼" },
        { "title": "å…­åœ‹è«–", "content": "å…­åœ‹ç ´æ»… ï¼Œéå…µä¸åˆ© ï¼Œæˆ°ä¸å–„ ï¼Œå¼Šåœ¨è³‚ç§¦ ã€‚è³‚ç§¦è€ŒåŠ›è™§ ï¼Œç ´æ»…ä¹‹é“ ä¹Ÿã€‚æˆ–æ›°ï¼šã€Œå…­åœ‹äº’å–ª ï¼Œç‡ è³‚ç§¦è€¶ï¼Ÿã€æ›°ï¼šã€Œä¸è³‚è€…ä»¥è³‚è€…å–ªã€‚ã€è“‹å¤±å¼·æ´ ï¼Œä¸èƒ½ç¨å®Œ ï¼Œæ•…æ›°ã€Œå¼Šåœ¨è³‚ç§¦ã€ä¹Ÿã€‚\n\nç§¦ä»¥æ”»å– ä¹‹å¤–ï¼Œå°å‰‡ç²é‚‘ ï¼Œå¤§å‰‡å¾—åŸï¼Œè¼ƒç§¦ä¹‹æ‰€å¾— èˆ‡æˆ°å‹è€Œå¾—è€…ï¼Œå…¶å¯¦ç™¾å€ï¼›è«¸ä¾¯ä¹‹æ‰€äº¡ èˆ‡æˆ°æ•—è€Œäº¡è€…ï¼Œå…¶å¯¦äº¦ç™¾å€ã€‚å‰‡ç§¦ä¹‹æ‰€å¤§æ¬²ï¼Œè«¸ä¾¯ä¹‹æ‰€å¤§æ‚£ï¼Œå›ºä¸åœ¨æˆ°çŸ£ã€‚æ€å¥å…ˆç¥–çˆ¶ ï¼Œæš´éœœéœ²ï¼Œæ–¬èŠæ£˜ ï¼Œä»¥æœ‰å°ºå¯¸ä¹‹åœ° ã€‚å­å­«è¦–ä¹‹ä¸ç”šæƒœï¼Œèˆ‰ä»¥äºˆäºº ï¼Œå¦‚æ£„è‰èŠ¥ ã€‚ä»Šæ—¥å‰²äº”åŸï¼Œæ˜æ—¥å‰²ååŸï¼Œç„¶å¾Œå¾—ä¸€å¤•å®‰å¯¢ï¼›èµ·è¦–å››å¢ƒï¼Œè€Œç§¦å…µåˆè‡³çŸ£ã€‚ç„¶å‰‡è«¸ä¾¯ä¹‹åœ°æœ‰é™ï¼Œæš´ç§¦ä¹‹æ¬²ç„¡å­ ï¼Œå¥‰ä¹‹å½Œ ç¹ï¼Œä¾µä¹‹æ„ˆæ€¥ï¼Œæ•…ä¸æˆ°è€Œå¼·å¼±å‹è² å·²åˆ¤ çŸ£ã€‚è‡³æ–¼é¡›è¦† ï¼Œç†å›ºå®œç„¶ã€‚å¤äºº äº‘ï¼šã€Œä»¥åœ°äº‹ç§¦ï¼ŒçŒ¶æŠ±è–ªæ•‘ç«ï¼Œè–ªä¸ç›¡ï¼Œç«ä¸æ»…ã€‚ã€ æ­¤è¨€å¾—ä¹‹ã€‚ \n\né½Šäººæœªå˜—è³‚ç§¦ï¼Œçµ‚ç¹¼äº”åœ‹é·æ»… ï¼Œä½•å“‰ï¼Ÿèˆ‡å¬´ è€Œä¸åŠ©äº”åœ‹ä¹Ÿã€‚äº”åœ‹æ—¢å–ªï¼Œé½Šäº¦ä¸å…çŸ£ã€‚ç‡•è¶™ä¹‹å›ï¼Œå§‹æœ‰é ç•¥ ï¼Œèƒ½å®ˆå…¶åœŸï¼Œç¾©ä¸è³‚ç§¦ ã€‚æ˜¯æ•…ç‡•é›–å°åœ‹è€Œå¾Œäº¡ï¼Œæ–¯ç”¨å…µä¹‹æ•ˆ ä¹Ÿã€‚è‡³ä¸¹ä»¥èŠå¿ç‚ºè¨ˆ ï¼Œå§‹é€Ÿç¦ ç„‰ã€‚è¶™å˜—äº”æˆ°äºç§¦ ï¼ŒäºŒæ•—è€Œä¸‰å‹ ï¼›å¾Œç§¦æ“Šè¶™è€…å†ï¼Œæç‰§ é€£å» ä¹‹ï¼›æ´ç‰§ä»¥è®’èª… ï¼Œé‚¯é„²ç‚ºéƒ¡ ï¼Œæƒœå…¶ç”¨æ­¦è€Œä¸çµ‚ ä¹Ÿã€‚\n\nä¸”ç‡•è¶™è™•ç§¦é©æ»… æ®†ç›¡ä¹‹éš›ï¼Œå¯è¬‚æ™ºåŠ›å­¤å± ï¼Œæˆ°æ•—è€Œäº¡ï¼Œèª ä¸å¾—å·²ã€‚å‘ä½¿ä¸‰åœ‹å„æ„›å…¶åœ° ï¼Œé½Šäººå‹¿é™„æ–¼ç§¦ï¼Œåˆºå®¢ä¸è¡Œ ï¼Œè‰¯å°‡ çŒ¶åœ¨ï¼Œå‰‡å‹è² ä¹‹æ•¸ ï¼Œå­˜äº¡ä¹‹ç†ï¼Œç•¶ èˆ‡ç§¦ç›¸è¼ƒï¼Œæˆ–æœªæ˜“é‡ ã€‚\n\nå—šå‘¼ï¼ä»¥è³‚ç§¦ä¹‹åœ°ï¼Œå°å¤©ä¸‹ä¹‹è¬€è‡£ï¼›ä»¥äº‹ç§¦ä¹‹å¿ƒï¼Œç¦® å¤©ä¸‹ä¹‹å¥‡æ‰ï¼›å¹·åŠ›è¥¿åš® ï¼Œå‰‡å¾æç§¦äººé£Ÿä¹‹ä¸å¾—ä¸‹åš¥ ä¹Ÿã€‚æ‚²å¤«ï¼æœ‰å¦‚æ­¤ä¹‹å‹¢ï¼Œè€Œç‚ºç§¦äººç©å¨ ä¹‹æ‰€åŠ«ï¼Œæ—¥å‰Šæœˆå‰²ï¼Œä»¥è¶¨æ–¼äº¡ï¼ç‚ºåœ‹è€…ç„¡ä½¿ç‚ºç©å¨ä¹‹æ‰€åŠ«å“‰ï¼\n\nå¤«å…­åœ‹èˆ‡ç§¦çš†è«¸ä¾¯ï¼Œå…¶å‹¢å¼±æ–¼ç§¦ï¼Œè€ŒçŒ¶æœ‰å¯ä»¥ä¸è³‚è€Œå‹ä¹‹ä¹‹å‹¢ï¼›èŒä»¥å¤©ä¸‹ä¹‹å¤§ï¼Œè€Œå¾å…­åœ‹ç ´äº¡ä¹‹æ•…äº‹ ï¼Œæ˜¯åˆåœ¨å…­åœ‹ä¸‹çŸ£ï¼" },
        { "title": "å‹¸å­¸", "content": "å›å­æ›°ï¼šå­¸ä¸å¯ä»¥å·² ã€‚é’ï¼Œå–ä¹‹æ–¼è— ï¼Œè€Œé’æ–¼è— ï¼›å†°ï¼Œæ°´ç‚ºä¹‹ï¼Œè€Œå¯’æ–¼æ°´ã€‚æœ¨ç›´ä¸­ç¹© ï¼Œè¼® ä»¥ç‚ºè¼ªï¼Œå…¶æ›²ä¸­è¦ ï¼›é›–æœ‰æ§æš´ ã€ä¸å¾©æŒº è€…ï¼Œè¼®ä½¿ä¹‹ç„¶ä¹Ÿã€‚æ•…æœ¨å—ç¹©å‰‡ç›´ ï¼Œé‡‘å°±ç¤ª å‰‡åˆ©ï¼Œå›å­åšå­¸è€Œæ—¥åƒçœ ä¹å·±ï¼Œå‰‡çŸ¥ æ˜è€Œè¡Œ ç„¡éçŸ£ã€‚\n\nå¾å˜—çµ‚æ—¥è€Œæ€çŸ£ï¼Œä¸å¦‚é ˆè‡¾ ä¹‹æ‰€å­¸ä¹Ÿï¼›å¾å˜—è·‚ è€Œæœ›çŸ£ï¼Œä¸å¦‚ç™»é«˜ä¹‹åšè¦‹ä¹Ÿã€‚ç™»é«˜è€Œæ‹›ï¼Œè‡‚éåŠ é•·ä¹Ÿï¼Œè€Œè¦‹è€…é ã€‚é †é¢¨è€Œå‘¼ï¼Œè²éåŠ ç–¾ ä¹Ÿï¼Œè€Œèè€…å½° ã€‚å‡è¼¿é¦¬è€… ï¼Œéåˆ©è¶³ ä¹Ÿï¼Œè€Œè‡´ åƒé‡Œï¼›å‡èˆŸæ¥« è€…ï¼Œéèƒ½æ°´ ä¹Ÿï¼Œè€Œçµ•æ±Ÿæ²³ ã€‚å›å­ç”Ÿéç•° ä¹Ÿï¼Œå–„å‡æ–¼ç‰© ä¹Ÿã€‚\n\nç©åœŸæˆå±±ï¼Œé¢¨é›¨èˆˆç„‰ï¼›ç©æ°´æˆæ·µ ï¼Œè›Ÿé¾ ç”Ÿç„‰ï¼›ç©å–„æˆå¾·ï¼Œè€Œç¥æ˜ è‡ªå¾—ï¼Œè–å¿ƒ å‚™ç„‰ã€‚æ•…ä¸ç©è·¬æ­¥ ï¼Œç„¡ä»¥è‡³åƒé‡Œï¼›ä¸ç©å°æµï¼Œç„¡ä»¥æˆæ±Ÿæµ·ã€‚é¨é©¥ ä¸€èºï¼Œä¸èƒ½åæ­¥ï¼›é§‘é¦¬åé§• ï¼ŒåŠŸåœ¨ä¸èˆ ã€‚é¥ è€Œèˆä¹‹ï¼Œæœ½æœ¨ä¸æŠ˜ï¼›é¥è€Œä¸èˆï¼Œé‡‘çŸ³å¯é¤ ã€‚è¾ ç„¡çˆªç‰™ä¹‹åˆ©ï¼Œç­‹éª¨ä¹‹å¼·ï¼Œä¸Šé£ŸåŸƒåœŸ ï¼Œä¸‹é£²é»ƒæ³‰ï¼Œç”¨å¿ƒä¸€ä¹Ÿã€‚èŸ¹å…­è·ªè€ŒäºŒè¯ ï¼Œéè›‡èŸº ä¹‹ç©´ç„¡å¯å¯„è¨—è€…ï¼Œç”¨å¿ƒèº ä¹Ÿã€‚" },
        { "title": "è«–ä»ã€è«–å­ã€è«–å›å­", "content": "è«–ä»\n(1)å­æ›°ï¼šã€Œä¸ä»è€…ï¼Œä¸å¯ä»¥ä¹…è™•ç´„ ï¼Œä¸å¯ä»¥é•·è™•æ¨‚ã€‚ä»è€…å®‰ä»ï¼ŒçŸ¥è€…åˆ©ä» ã€‚ã€ï¼ˆã€Šé‡Œä»ã€‹ç¬¬å››ï¼‰\n(2)å­æ›°ï¼šã€Œå¯Œèˆ‡è²´ï¼Œæ˜¯äººä¹‹æ‰€æ¬²ä¹Ÿï¼›ä¸ä»¥å…¶é“å¾—ä¹‹ï¼Œä¸è™•ä¹Ÿ ã€‚è²§èˆ‡è³¤ï¼Œæ˜¯äººä¹‹æ‰€æƒ¡ä¹Ÿï¼›ä¸ä»¥å…¶é“å¾—ä¹‹ ï¼Œä¸å» ä¹Ÿã€‚å›å­å»ä»ï¼Œæƒ¡ä¹æˆå ï¼Ÿå›å­ç„¡çµ‚é£Ÿä¹‹é–“é•ä» ï¼Œé€ æ¬¡å¿…æ–¼æ˜¯ ï¼Œé¡›æ²›å¿…æ–¼æ˜¯ã€‚ã€ï¼ˆã€Šé‡Œä»ã€‹ç¬¬å››ï¼‰\n(3)é¡æ·µå•ä»ã€‚\nå­æ›°ï¼šã€Œå…‹å·±å¾©ç¦®ç‚ºä» ã€‚ä¸€æ—¥å…‹å·±å¾©ç¦®ï¼Œå¤©ä¸‹æ­¸ä»ç„‰ã€‚ç‚ºä»ç”±å·±ï¼Œè€Œç”±äººä¹å“‰ ï¼Ÿã€\né¡æ·µæ›°ï¼šã€Œè«‹å•å…¶ç›® ã€‚ã€å­æ›°ï¼šã€Œéç¦®å‹¿è¦–ï¼Œéç¦®å‹¿è½ï¼Œéç¦®å‹¿è¨€ï¼Œéç¦®å‹¿å‹• ã€‚ã€\né¡æ·µæ›°ï¼šã€Œå›é›–ä¸æ•ï¼Œè«‹äº‹æ–¯èªçŸ£ ã€‚ã€ï¼ˆã€Šé¡æ·µã€‹ç¬¬åäºŒï¼‰\n(4)å­æ›°ï¼šã€Œå¿—å£«ä»äººï¼Œç„¡æ±‚ç”Ÿä»¥å®³ä»ï¼Œæœ‰æ®ºèº«ä»¥æˆä» ã€‚ã€ï¼ˆã€Šè¡›éˆå…¬ã€‹ç¬¬åäº”ï¼‰\n\nè«–å­\n(5)å­Ÿæ‡¿å­ å•å­ã€‚å­æ›°ï¼šã€Œç„¡é• ã€‚ã€\næ¨Šé²å¾¡ ï¼Œå­å‘Šä¹‹æ›°ï¼šã€Œå­Ÿå­«å•å­æ–¼æˆ‘ï¼Œæˆ‘å°æ›°ï¼Œç„¡é•ã€‚ã€\næ¨Šé²æ›°ï¼šã€Œä½•è¬‚ä¹Ÿï¼Ÿã€å­æ›°ï¼šã€Œç”Ÿäº‹ä¹‹ä»¥ç¦® ï¼›æ­»è‘¬ä¹‹ä»¥ç¦®ï¼Œç¥­ä¹‹ä»¥ç¦® ã€‚ã€ï¼ˆã€Šç‚ºæ”¿ã€‹ç¬¬äºŒï¼‰\n(6)å­æ¸¸ å•å­ã€‚å­æ›°ï¼šã€Œä»Šä¹‹å­è€…ï¼Œæ˜¯è¬‚èƒ½é¤Š ã€‚è‡³æ–¼çŠ¬é¦¬ï¼Œçš†èƒ½æœ‰é¤Š ï¼›ä¸æ•¬ï¼Œä½•ä»¥åˆ¥ä¹ ï¼ã€ï¼ˆã€Šç‚ºæ”¿ã€‹ç¬¬äºŒï¼‰\n\n(7)å­æ›°ï¼šã€Œäº‹çˆ¶æ¯å¹¾è«« ï¼Œè¦‹å¿—ä¸å¾ï¼Œåˆæ•¬ä¸é•ï¼Œå‹è€Œä¸æ€¨ ã€‚ã€ï¼ˆã€Šé‡Œä»ã€‹ç¬¬å››ï¼‰\n(8)å­æ›°ï¼šã€Œçˆ¶æ¯ä¹‹å¹´ï¼Œä¸å¯ä¸çŸ¥ä¹Ÿã€‚ä¸€å‰‡ä»¥å–œï¼Œä¸€å‰‡ä»¥æ‡¼ ã€‚ã€ï¼ˆã€Šé‡Œä»ã€‹ç¬¬å››ï¼‰\n\nè«–å›å­\n(9)å­æ›°ï¼šã€Œå›å­ä¸é‡å‰‡ä¸å¨ ï¼›å­¸å‰‡ä¸å›º ã€‚ä¸»å¿ ä¿¡ ã€‚ç„¡å‹ä¸å¦‚å·±è€… ã€‚éå‰‡å‹¿æ†šæ”¹ ã€‚ã€ï¼ˆã€Šå­¸è€Œã€‹ç¬¬ä¸€ï¼‰\n(10)å­æ›°ï¼šã€Œå›å­å¦è•©è•©ï¼Œå°äººé•·æˆšæˆš ã€‚ã€ï¼ˆã€Šè¿°è€Œã€‹ç¬¬ä¸ƒï¼‰\n(11)å¸é¦¬ç‰› å•å›å­ã€‚å­æ›°ï¼šã€Œå›å­ä¸æ†‚ä¸æ‡¼ã€‚ã€æ›°ï¼šã€Œä¸æ†‚ä¸æ‡¼ï¼Œæ–¯è¬‚ä¹‹å›å­å·²ä¹ ï¼Ÿã€å­æ›°ï¼šã€Œå…§çœä¸ç–šï¼Œå¤«ä½•æ†‚ä½•æ‡¼ ï¼Ÿã€ï¼ˆã€Šé¡æ·µã€‹ç¬¬åäºŒï¼‰\n(12)å­æ›°ï¼šã€Œå›å­æˆäººä¹‹ç¾ï¼Œä¸æˆäººä¹‹æƒ¡ ã€‚å°äººåæ˜¯ ã€‚ã€ï¼ˆã€Šé¡æ·µã€‹ç¬¬åäºŒï¼‰\n(13)å­æ›°ï¼šã€Œå›å­æ¥å…¶è¨€è€Œéå…¶è¡Œ ã€‚ã€ï¼ˆã€Šæ†²å•ã€‹ç¬¬åå››ï¼‰\n(14)å­æ›°ï¼šã€Œå›å­ç¾©ä»¥ç‚ºè³ª ï¼Œç¦®ä»¥è¡Œä¹‹ï¼Œå­«ä»¥å‡ºä¹‹ï¼Œä¿¡ä»¥æˆä¹‹ ã€‚å›å­å“‰ï¼ã€ï¼ˆã€Šè¡›éˆå…¬ã€‹ç¬¬åäº”ï¼‰\n(15)å­æ›°ï¼šã€Œå›å­ç—…ç„¡èƒ½ç„‰ï¼Œä¸ç—…äººä¹‹ä¸å·±çŸ¥ä¹Ÿ ã€‚ã€ï¼ˆã€Šè¡›éˆå…¬ã€‹ç¬¬åäº”ï¼‰\n(16)å­æ›°ï¼šã€Œå›å­æ±‚è«¸å·±ï¼Œå°äººæ±‚è«¸äºº ã€‚ã€ï¼ˆã€Šè¡›éˆå…¬ã€‹ç¬¬åäº”ï¼‰" },
        { "title": "é­šæˆ‘æ‰€æ¬²ä¹Ÿ", "content": "å­Ÿå­æ›°ï¼šã€Œé­šï¼Œæˆ‘æ‰€æ¬²ä¹Ÿï¼Œç†ŠæŒï¼Œäº¦æˆ‘æ‰€æ¬²ä¹Ÿï¼›äºŒè€…ä¸å¯å¾—å…¼ï¼Œèˆé­šè€Œå–ç†ŠæŒ è€…ä¹Ÿã€‚ç”Ÿäº¦æˆ‘æ‰€æ¬²ä¹Ÿï¼Œç¾©äº¦æˆ‘æ‰€æ¬²ä¹Ÿï¼›äºŒè€…ä¸å¯å¾—å…¼ï¼Œèˆç”Ÿè€Œå–ç¾©è€…ä¹Ÿã€‚\n\nã€Œç”Ÿäº¦æˆ‘æ‰€æ¬²ï¼Œæ‰€æ¬²æœ‰ç”šæ–¼ç”Ÿè€…ï¼Œæ•…ä¸ç‚ºè‹Ÿå¾— ä¹Ÿï¼›æ­»äº¦æˆ‘æ‰€æƒ¡ ï¼Œæ‰€æƒ¡æœ‰ç”šæ–¼æ­»è€…ï¼Œæ•…æ‚£æœ‰æ‰€ä¸è¾Ÿ ä¹Ÿã€‚å¦‚ä½¿äººä¹‹æ‰€æ¬²è«ç”šæ–¼ç”Ÿï¼Œå‰‡å‡¡å¯ä»¥å¾—ç”Ÿè€…ï¼Œä½•ä¸ç”¨ä¹Ÿï¼Ÿä½¿äººä¹‹æ‰€æƒ¡è«ç”šæ–¼æ­»è€…ï¼Œå‰‡å‡¡å¯ä»¥è¾Ÿæ‚£è€…ï¼Œä½•ä¸ç‚ºä¹Ÿï¼Ÿç”±æ˜¯å‰‡ç”Ÿè€Œæœ‰ä¸ç”¨ä¹Ÿï¼Œç”±æ˜¯å‰‡å¯ä»¥è¾Ÿæ‚£è€Œæœ‰ä¸ç‚ºä¹Ÿï¼Œæ˜¯æ•…æ‰€æ¬²æœ‰ç”šæ–¼ç”Ÿè€…ï¼Œæ‰€æƒ¡æœ‰ç”šæ–¼æ­»è€…ã€‚éç¨è³¢è€…æœ‰æ˜¯å¿ƒä¹Ÿï¼Œäººçš†æœ‰ä¹‹ï¼Œè³¢è€…èƒ½å‹¿å–ªè€³ ã€‚\n\nä¸€ç°é£Ÿ ï¼Œä¸€è±†ç¾¹ ï¼Œå¾—ä¹‹å‰‡ç”Ÿï¼Œå¼— å¾—å‰‡æ­»ã€‚å˜‘çˆ¾è€Œèˆ‡ä¹‹ ï¼Œè¡Œé“ä¹‹äººå¼—å— ï¼›è¹´çˆ¾è€Œèˆ‡ä¹‹ ï¼Œä¹äººä¸å±‘ä¹Ÿ ï¼›è¬é¾ å‰‡ä¸è¾¯ ç¦®ç¾©è€Œå—ä¹‹ã€‚è¬é¾æ–¼æˆ‘ä½•åŠ  ç„‰ï¼Ÿç‚ºå®®å®¤ä¹‹ç¾ã€å¦»å¦¾ä¹‹å¥‰ ã€æ‰€è­˜çª®ä¹è€…å¾—æˆ‘èˆ‡ ï¼Ÿé„‰ ç‚ºèº«æ­»è€Œä¸å—ï¼Œä»Šç‚ºå®®å®¤ä¹‹ç¾ç‚ºä¹‹ï¼›é„‰ç‚ºèº«æ­»è€Œä¸å—ï¼Œä»Šç‚ºå¦»å¦¾ä¹‹å¥‰ç‚ºä¹‹ï¼›é„‰ç‚ºèº«æ­»è€Œä¸å—ï¼Œä»Šç‚ºæ‰€è­˜çª®ä¹è€…å¾—æˆ‘è€Œç‚ºä¹‹ï¼Œæ˜¯äº¦ä¸å¯ä»¥å·² ä¹ï¼Ÿæ­¤ä¹‹è¬‚å¤±å…¶æœ¬å¿ƒ ã€‚ã€" }
    ]
};



	
/* === ä¿®æ”¹å¾Œçš„ openModalEditor (æ‰‹æ©Ÿç‰ˆä¸è‡ªå‹•å½ˆå‡ºéµç›¤) === */
function openModalEditor(element) {
    currentEditingElement = element;
    modalTextarea.value = currentEditingElement.value;

    let titleText = 'ç·¨è¼¯å…§å®¹'; 

    // === æ¨™é¡Œç”Ÿæˆé‚è¼¯ (ä¿æŒä¸è®Š) ===
    if (element.id === 'writingContent' || element.id === 'argumentWritingContent') {
        titleText = 'è¼¸å…¥æ‚¨çš„æ–‡ç« ';
    } else {
        const parentTableCell = element.closest('td');
        if (parentTableCell) {
            const parentRow = parentTableCell.closest('tr');
            if (parentRow) {
                const headerCell = parentRow.cells[0];
                const table = parentRow.closest('table');
                if (table && table.rows.length > 0) {
                    const columnHeaderCell = table.rows[0].cells[parentTableCell.cellIndex];
                    const rowTitle = headerCell ? headerCell.textContent.trim().replace(/[:ï¼š]/g, '') : '';
                    const colTitle = columnHeaderCell ? columnHeaderCell.textContent.trim().replace(/[:ï¼š]/g, '') : '';
                    if (rowTitle && colTitle && rowTitle !== colTitle) {
                        titleText = `ç·¨è¼¯ã€Œ${rowTitle}ã€çš„ã€Œ${colTitle}ã€`;
                    } else if (rowTitle) {
                        titleText = `ç·¨è¼¯ã€Œ${rowTitle}ã€`;
                    } else if (colTitle) {
                        titleText = `ç·¨è¼¯ã€Œ${colTitle}ã€`;
                    }
                }
            }
        } else {
            let associatedLabel = null;
            if (element.id) {
                associatedLabel = document.querySelector(`label[for="${element.id}"]`);
            }
            if (!associatedLabel) {
                const parentContainer = element.closest('div');
                if (parentContainer) {
                    associatedLabel = parentContainer.querySelector('label');
                }
            }
            if (associatedLabel) {
                titleText = `ç·¨è¼¯ã€Œ${associatedLabel.textContent.trim().replace(/[:ï¼š]/g, '')}ã€`;
            }
        }
    }

    modalTitle.textContent = titleText;

    // === ç¯„æ–‡é¸æ“‡å™¨é‚è¼¯ (ä¿®æ­£ç‰ˆ) ===
    const templateSelect = document.getElementById('modal-template-select');
    
    if (element.id === 'readingPassage') {
        templateSelect.style.display = 'block';
        
        // 1. å¦‚æœé¸é …é‚„æ²’å»ºç«‹ï¼Œå…ˆå»ºç«‹é¸é … (åªåŸ·è¡Œä¸€æ¬¡)
        if (templateSelect.options.length <= 1) { 
            textLibrary.texts.forEach(text => {
                const option = document.createElement('option');
                option.value = text.content;
                option.textContent = text.title;
                templateSelect.appendChild(option);
            });
        }

        // 2. â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šå°‡ onchange ç›£è½å™¨ç§»åˆ° if å¤–é¢ â˜…â˜…â˜…
        // é€™æ¨£æ¯æ¬¡æ‰“é–‹è¦–çª—æ™‚ï¼Œéƒ½æœƒç¢ºä¿ç›£è½å™¨æ˜¯é‹ä½œä¸­çš„
        templateSelect.onchange = function() {
            if (this.value) {
                modalTextarea.value = this.value;
            }
        };

        // 3. é‡ç½®é¸å–®å›åˆ°ã€ŒæŒ‡å®šç¯„æ–‡ã€é è¨­é¸é …
        templateSelect.value = ""; 

    } else {
        templateSelect.style.display = 'none';
        templateSelect.onchange = null; // å…¶ä»–è¼¸å…¥æ¡†ä¸éœ€è¦æ­¤åŠŸèƒ½
    }

    // é¡¯ç¤ºè¦–çª—
    modal.style.display = 'flex';

    // === éµç›¤æ§åˆ¶é‚è¼¯ (ä¿æŒä¸è®Š) ===
    modalTextarea.blur();
    if (window.innerWidth > 1024) {
        setTimeout(() => {
            modalTextarea.focus();
        }, 50);
    } 
}

function closeModalEditor() {
modal.style.display = 'none';
currentEditingElement = null;
}

function saveAndCloseEditor() {
if (currentEditingElement) {
currentEditingElement.value = modalTextarea.value;
if (currentEditingElement.id === 'expandContent') {
updateCharCount();
}
}
closeModalEditor();
}




// ä¸»äº‹ä»¶ç›£è½å™¨ (ä¿æŒä¸è®Š)
document.body.addEventListener('click', function(event) {
    const target = event.target;

    const isTextInput = target.tagName === 'INPUT' && target.type === 'text';
    const isTextarea = target.tagName === 'TEXTAREA';

    // æª¢æŸ¥æ˜¯å¦ç‚ºéœ€è¦è§¸ç™¼æ‡¸æµ®è¦–çª—çš„è¼¸å…¥æ¡†
    if ((isTextInput || isTextarea) && !target.classList.contains('no-modal-editor') && target.id !== 'modal-textarea') {
        event.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­çš„èšç„¦è¡Œç‚º
        target.blur();          // â˜… é—œéµï¼šè®“åŸæœ¬é»æ“Šçš„æ¡†ç«‹åˆ»å¤±ç„¦ï¼Œé˜²æ­¢æ‰‹æ©Ÿéµç›¤é–ƒç¾
        openModalEditor(target);
    }
});

// ç‚ºæ‡¸æµ®è¦–çª—çš„æŒ‰éˆ•å’Œå¤–éƒ¨å€åŸŸç¶å®šäº‹ä»¶ (ä¿æŒä¸è®Š)
modalSaveBtn.addEventListener('click', saveAndCloseEditor);
modalCloseBtn.addEventListener('click', closeModalEditor);

});



// =======================================================
// === å…¨æ–°è©•ç­‰ç³»çµ±é‚è¼¯ (Grading System Logic) ===
// =======================================================

let radarChartInstance = null; // å…¨åŸŸè®Šæ•¸ï¼Œç”¨æ–¼å­˜æ”¾é›·é”åœ–å¯¦ä¾‹

/**
* å»ºç«‹è©•ç­‰ç³»çµ±çš„å®Œæ•´ HTML çµæ§‹ (ä¿®è¨‚ç‰ˆ)
* @param {string} uniqueIdPrefix - ç”¨æ–¼å€åˆ†ä¸åŒåŠŸèƒ½å€å¡Šçš„å”¯ä¸€å‰ç¶´
* @returns {string} HTML å­—ç¬¦ä¸²
*/
/**
* å»ºç«‹è©•ç­‰ç³»çµ±çš„å®Œæ•´ HTML çµæ§‹ (ä¿®è¨‚ç‰ˆï¼šç›´æ¥æ³¨å…¥åˆ†æ•¸)
* @param {string} uniqueIdPrefix - ç”¨æ–¼å€åˆ†ä¸åŒåŠŸèƒ½å€å¡Šçš„å”¯ä¸€å‰ç¶´
* @param {object} scores - (æ–°) AI è©•åˆ†çµæœç‰©ä»¶ï¼Œè‹¥ç„¡å‰‡ç‚º null
* @param {string} grade - (æ–°) æœ€çµ‚ç­‰ç´š
* @returns {string} HTML å­—ç¬¦ä¸²
*/
function createGradingSystemHTML(uniqueIdPrefix, scores = null, grade = "3") {
    // 1. ç²å–åˆ†æ•¸ (å¦‚æœ scores å­˜åœ¨å°±ç”¨ scoresï¼Œå¦å‰‡ç”¨é è¨­å€¼ 5)
    // é€é || é‹ç®—ç¬¦è™•ç†å¯èƒ½çš„ undefinedï¼Œç¢ºä¿æœ‰æ•¸å€¼
    const c = scores ? (scores.content || 0) : 5;
    const e = scores ? (scores.expression || 0) : 5;
    const s = scores ? (scores.structure || 0) : 5;
    
    // æ¨™é»å’ŒéŒ¯åˆ¥å­—ç›®å‰ AI æ²’è©•åˆ†ï¼Œç¶­æŒå›ºå®šå€¼
    const p = 5; 
    const t = 1; // éŒ¯åˆ¥å­—é è¨­ 1 åˆ† (3åˆ†æ»¿åˆ†)

    // 2. è¨ˆç®—é¡¯ç¤ºç”¨çš„ç¸½åˆ†èˆ‡ç™¾åˆ†æ¯”å¯¬åº¦
    const c_disp = c * 4;
    const e_disp = e * 3;
    const s_disp = s * 2;
    const p_disp = p * 1;
    const t_disp = t;
    
    const totalScore = c_disp + e_disp + s_disp + p_disp + t_disp;
    const cappedTotal = Math.min(totalScore, 100);

    // 3. ç”Ÿæˆ HTML (ç›´æ¥å°‡ width å’Œ value å¯«æ­»åœ¨ HTML è£¡)
    return `
    <div class="grading-container">
        <div class="grading-grid">
            <div class="grading-scores">
                <h3>è©•ç­‰</h3>
                
                <!-- å…§å®¹ -->
                <div class="score-item">
                    <label>å…§å®¹ (40)</label>
                    <div class="slider-container">
                        <div class="progress-bar-container">
                            <div id="${uniqueIdPrefix}ContentScoreFill" class="progress-bar-fill" style="width: ${c * 10}%"></div>
                        </div>
                        <span id="${uniqueIdPrefix}ContentScoreDisplay" class="score-display">${c_disp}</span>
                    </div>
                </div>

                <!-- è¡¨é” -->
                <div class="score-item">
                    <label>è¡¨é” (30)</label>
                    <div class="slider-container">
                        <div class="progress-bar-container">
                            <div id="${uniqueIdPrefix}ExpressionScoreFill" class="progress-bar-fill" style="width: ${e * 10}%"></div>
                        </div>
                        <span id="${uniqueIdPrefix}ExpressionScoreDisplay" class="score-display">${e_disp}</span>
                    </div>
                </div>

                <!-- çµæ§‹ -->
                <div class="score-item">
                    <label>çµæ§‹ (20)</label>
                    <div class="slider-container">
                        <div class="progress-bar-container">
                            <div id="${uniqueIdPrefix}StructureScoreFill" class="progress-bar-fill" style="width: ${s * 10}%"></div>
                        </div>
                        <span id="${uniqueIdPrefix}StructureScoreDisplay" class="score-display">${s_disp}</span>
                    </div>
                </div>

                <!-- æ¨™é» -->
                <div class="score-item">
                    <label>æ¨™é»å­—é«” (10)</label>
                    <div class="slider-container">
                        <div class="progress-bar-container">
                            <div id="${uniqueIdPrefix}PunctuationScoreFill" class="progress-bar-fill" style="width: ${p * 10}%"></div>
                        </div>
                        <span id="${uniqueIdPrefix}PunctuationScoreDisplay" class="score-display">${p_disp}</span>
                    </div>
                </div>

                <!-- éŒ¯åˆ¥å­— -->
                <div class="score-item">
                    <label>éŒ¯åˆ¥å­— (+3)</label>
                    <div class="slider-container">
                        <div class="progress-bar-container">
                            <!-- éŒ¯åˆ¥å­—æ»¿åˆ†æ˜¯3ï¼Œæ‰€ä»¥å¯¬åº¦è¨ˆç®—ä¸åŒ -->
                            <div id="${uniqueIdPrefix}TypoScoreFill" class="progress-bar-fill" style="width: ${(t / 3) * 100}%"></div>
                        </div>
                        <span id="${uniqueIdPrefix}TypoScoreDisplay" class="score-display">${t_disp}</span>
                    </div>
                </div>

                <!-- éš±è—çš„ input ç”¨æ–¼æ•¸å€¼å„²å­˜ (ç¢ºä¿ value æ˜¯çœŸå¯¦åˆ†æ•¸) -->
                <input type="hidden" id="${uniqueIdPrefix}ContentScore" value="${c}">
                <input type="hidden" id="${uniqueIdPrefix}ExpressionScore" value="${e}">
                <input type="hidden" id="${uniqueIdPrefix}StructureScore" value="${s}">
                <input type="hidden" id="${uniqueIdPrefix}PunctuationScore" value="${p}">
                <input type="hidden" id="${uniqueIdPrefix}TypoScore" value="${t}">

                <div class="total-score-container">
                    <span id="${uniqueIdPrefix}TotalScoreDisplay">ç¸½åˆ†: ${cappedTotal} / 100</span>
                    <span id="${uniqueIdPrefix}FinalGrade">ç­‰ç´š: ${grade}</span>
                </div>
            </div>
            
            <div class="grading-radar">
                <h3>èƒ½åŠ›é›·é”åœ–</h3>
                <div class="radar-chart-container">
                    <canvas id="${uniqueIdPrefix}RadarChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    `;
}

/**
* åˆå§‹åŒ–è©•ç­‰ç³»çµ±ï¼ŒåŒ…æ‹¬è¨­å®šåˆ†æ•¸å’Œç¹ªè£½åˆå§‹åœ–è¡¨
* @param {string} uniqueIdPrefix - ç”¨æ–¼å€åˆ†ä¸åŒåŠŸèƒ½å€å¡Šçš„å”¯ä¸€å‰ç¶´
* @param {object} initialScores - åŒ…å«åˆå§‹åˆ†æ•¸çš„ç‰©ä»¶
* @param {string} finalGrade - ã€æ–°ã€‘ç›´æ¥å‚³å…¥æœ€çµ‚è¨ˆç®—å¥½çš„ç­‰ç´š
*/
function initializeGradingSystem(uniqueIdPrefix, initialScores = {}, finalGrade) {
    // ç¢ºä¿ initialScores å’Œ initialScores.radar å­˜åœ¨
    if (!initialScores || !initialScores.radar) {
        console.error("åˆå§‹åŒ–è©•åˆ†ç³»çµ±æ™‚ç¼ºå°‘å¿…è¦çš„åˆ†æ•¸æ•¸æ“šã€‚");
        return;
    }

    // å°‡æœ€çµ‚è¨ˆç®—å‡ºçš„åˆ†æ•¸è¨­å®šåˆ°éš±è—çš„ input ä¸­ï¼Œé€™äº› input æ˜¯å¾ŒçºŒè¨ˆç®—çš„åŸºç¤
    document.getElementById(`${uniqueIdPrefix}ContentScore`).value = initialScores.content;
    document.getElementById(`${uniqueIdPrefix}ExpressionScore`).value = initialScores.expression;
    document.getElementById(`${uniqueIdPrefix}StructureScore`).value = initialScores.structure;
    
    // æ¨™é»å’ŒéŒ¯åˆ¥å­—åˆ†æ•¸ä½¿ç”¨å›ºå®šçš„é è¨­å€¼
    document.getElementById(`${uniqueIdPrefix}PunctuationScore`).value = 5;
    document.getElementById(`${uniqueIdPrefix}TypoScore`).value = 1;

    // å‘¼å«æ›´æ–°å‡½å¼ï¼Œå®ƒæœƒè™•ç†æ‰€æœ‰ä»‹é¢å…ƒç´ çš„æ›´æ–°ï¼ŒåŒ…æ‹¬é¡¯ç¤ºåˆ†æ•¸ã€é€²åº¦æ¢å’Œé›·é”åœ–
    updateScoresAndGrade(uniqueIdPrefix, finalGrade, initialScores.radar);
}




/**
* æ ¹æ“šåˆ†æ•¸è¨ˆç®—ç¸½åˆ†ï¼Œä¸Šé™ç‚º 100
* @param {string} uniqueIdPrefix - åŠŸèƒ½å€å¡Šçš„å”¯ä¸€å‰ç¶´
* @returns {number} è¨ˆç®—å¾Œä¸”ä¸è¶…é 100 çš„ç¸½åˆ†
*/
function calculateTotalScore(uniqueIdPrefix) {
// ã€ä¿®è¨‚äºŒã€‘å¾éš±è—çš„ input ä¸­ç²å–åŸå§‹åˆ†æ•¸ (0-10)
const content = parseInt(document.getElementById(`${uniqueIdPrefix}ContentScore`).value) * 4;
const expression = parseInt(document.getElementById(`${uniqueIdPrefix}ExpressionScore`).value) * 3;
const structure = parseInt(document.getElementById(`${uniqueIdPrefix}StructureScore`).value) * 2;
const punctuation = parseInt(document.getElementById(`${uniqueIdPrefix}PunctuationScore`).value) * 1;
const typo = parseInt(document.getElementById(`${uniqueIdPrefix}TypoScore`).value);

const totalScore = content + expression + structure + punctuation + typo;

// è¿”å›åˆ†æ•¸ï¼Œä½†æœ€é«˜ä¸è¶…é 100
return Math.min(totalScore, 100);
}

/**
* æ ¹æ“šç¸½åˆ†æ±ºå®š DSE ç­‰ç´š
* @param {number} score - ç¸½åˆ† (0-103)
* @returns {string} DSE ç­‰ç´š
*/
function determineGrade(score) {
if (score >= 72) return "5**";
if (score >= 69) return "5*";
if (score >= 64) return "5";
if (score >= 57) return "4";
if (score >= 50) return "3";
if (score >= 45) return "2";
return "1";
}

/**
* æ›´æ–°æ‰€æœ‰åˆ†æ•¸é¡¯ç¤ºã€ç¸½åˆ†ã€ç­‰ç´šã€é€²åº¦æ¢å’Œé›·é”åœ–
* @param {string} uniqueIdPrefix - åŠŸèƒ½å€å¡Šçš„å”¯ä¸€å‰ç¶´
* @param {string} finalGrade - ã€æ–°ã€‘ç›´æ¥å‚³å…¥æœ€çµ‚è¨ˆç®—å¥½çš„ç­‰ç´š
* @param {object} radarData - é›·é”åœ–çš„æ•¸æ“š (å¯é¸)
*/
function updateScoresAndGrade(uniqueIdPrefix, finalGrade, radarData = null) {
    // å¾éš±è—çš„ input ç²å–åŸå§‹åˆ†æ•¸ (0-10 æˆ– 0-3)
    const contentVal = parseInt(document.getElementById(`${uniqueIdPrefix}ContentScore`).value);
    const expressionVal = parseInt(document.getElementById(`${uniqueIdPrefix}ExpressionScore`).value);
    const structureVal = parseInt(document.getElementById(`${uniqueIdPrefix}StructureScore`).value);
    const punctuationVal = parseInt(document.getElementById(`${uniqueIdPrefix}PunctuationScore`).value);
    const typoVal = parseInt(document.getElementById(`${uniqueIdPrefix}TypoScore`).value);

    // æ›´æ–°å„åˆ†é …é¡¯ç¤ºï¼ˆä¹˜ä»¥æ¬Šé‡å¾Œçš„åˆ†æ•¸ï¼‰
    document.getElementById(`${uniqueIdPrefix}ContentScoreDisplay`).textContent = contentVal * 4;
    document.getElementById(`${uniqueIdPrefix}ExpressionScoreDisplay`).textContent = expressionVal * 3;
    document.getElementById(`${uniqueIdPrefix}StructureScoreDisplay`).textContent = structureVal * 2;
    document.getElementById(`${uniqueIdPrefix}PunctuationScoreDisplay`).textContent = punctuationVal * 1;
    document.getElementById(`${uniqueIdPrefix}TypoScoreDisplay`).textContent = typoVal;

    // æ›´æ–°é€²åº¦æ¢å¯¬åº¦
    document.getElementById(`${uniqueIdPrefix}ContentScoreFill`).style.width = `${contentVal * 10}%`;
    document.getElementById(`${uniqueIdPrefix}ExpressionScoreFill`).style.width = `${expressionVal * 10}%`;
    document.getElementById(`${uniqueIdPrefix}StructureScoreFill`).style.width = `${structureVal * 10}%`;
    document.getElementById(`${uniqueIdPrefix}PunctuationScoreFill`).style.width = `${punctuationVal * 10}%`;
    document.getElementById(`${uniqueIdPrefix}TypoScoreFill`).style.width = `${(typoVal / 3) * 100}%`;

    // è¨ˆç®—ä¸¦æ›´æ–°ç¸½åˆ†
    const totalScore = calculateTotalScore(uniqueIdPrefix);
    document.getElementById(`${uniqueIdPrefix}TotalScoreDisplay`).textContent = `ç¸½åˆ†: ${totalScore} / 100`;
    // ã€ä¿®è¨‚ã€‘ç›´æ¥ä½¿ç”¨å‚³å…¥çš„ finalGrade
    document.getElementById(`${uniqueIdPrefix}FinalGrade`).textContent = `ç­‰ç´š: ${finalGrade}`;

    // æº–å‚™ä¸¦æ›´æ–°é›·é”åœ–æ•¸æ“š
    let currentRadarData;
    if (radarData) {
        currentRadarData = [
            radarData.ç«‹æ„ || 5,
            radarData.å–æ || 5,
            radarData.æ‰£é¡Œ || 5,
            radarData.è©³ç•¥ || 5,
            radarData.è©å½™ || 5,
            radarData.æ–‡å­¸æ€§ || 5
        ];
    } else {
        // è‹¥ AI æœªæä¾›é›·é”åœ–æ•¸æ“šï¼Œå‰‡æ ¹æ“šåˆ†æ•¸ä¼°ç®— (æ­¤ç‚ºå‚™ç”¨é‚è¼¯)
        currentRadarData = [
            Math.round((contentVal * 0.6 + structureVal * 0.4)), 
            Math.round((contentVal * 0.8 + expressionVal * 0.2)),
            Math.round((contentVal * 0.7 + structureVal * 0.3)),
            Math.round((structureVal * 0.7 + contentVal * 0.3)),
            expressionVal,
            expressionVal
        ];
    }
    createOrUpdateRadarChart(uniqueIdPrefix, currentRadarData);
}


/**
* å‰µå»ºæˆ–æ›´æ–°é›·é”åœ–
* @param {string} uniqueIdPrefix - åŠŸèƒ½å€å¡Šçš„å”¯ä¸€å‰ç¶´
* @param {array} data - åŒ…å«äº”å€‹èƒ½åŠ›å€¼çš„æ•¸çµ„
*/
function createOrUpdateRadarChart(uniqueIdPrefix, data) {
const ctx = document.getElementById(`${uniqueIdPrefix}RadarChart`).getContext('2d');

if (window[`${uniqueIdPrefix}_radarChartInstance`]) {
window[`${uniqueIdPrefix}_radarChartInstance`].data.datasets[0].data = data;
window[`${uniqueIdPrefix}_radarChartInstance`].update();
} else {
window[`${uniqueIdPrefix}_radarChartInstance`] = new Chart(ctx, {
type: 'radar',
data: {
labels: ['ç«‹æ„', 'å–æ', 'æ‰£é¡Œ', 'è©³ç•¥', 'è©å½™', 'æ–‡å­¸æ€§'],
datasets: [{
label: 'èƒ½åŠ›åˆ†ä½ˆ',
data: data,
backgroundColor: 'rgba(54, 162, 235, 0.2)',
borderColor: 'rgba(54, 162, 235, 1)',
borderWidth: 2,
pointBackgroundColor: 'rgba(54, 162, 235, 1)',
pointBorderColor: '#fff',
pointHoverBackgroundColor: '#fff',
pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
r: {
angleLines: {
display: true
},
suggestedMin: 0,
suggestedMax: 10,
pointLabels: {
font: {
size: 14,
family: "'Noto Serif TC', serif"
}
},
ticks: {
stepSize: 2
}
}
},
plugins: {
legend: {
display: false
}
}
}
});
}
}

/**
* æ§‹å»ºå¸¶æœ‰è©•ç­‰æŒ‡ä»¤çš„ API Prompt (V15 - æ¢ä»¶å¼åŠ åˆ†)
* æ­¤ç‰ˆæœ¬åš´æ ¼è¦å®šã€Œå…§å®¹ã€å’Œã€Œçµæ§‹ã€åˆ†æ•¸å¿…é ˆä»¥ã€Œæ‰£é¡Œã€åˆ†æ•¸ç‚ºåŸºç¤ï¼Œ
* ä½†å…è¨±åœ¨é€™åŸºç¤ä¸Šæœ‰æ¢ä»¶åœ°åŠ ä¸€åˆ†ï¼Œä»¥çå‹µè¡¨ç¾å‡ºè‰²çš„éƒ¨åˆ†ã€‚
*/
function buildGradingPrompt(type, topic, content, toneNote, focus = null, plot = null) {
    const dsePrinciples = document.getElementById('dse-grading-principles').innerText;
    
   // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¸å†å¾ HTML è®€å–ç¯„æ–‡ï¼Œç›´æ¥ä½¿ç”¨å‚³å…¥çš„ RAG çµæœ â˜…â˜…â˜…
    // å¦‚æœ ragReference æ˜¯ç©ºçš„ï¼Œå°±é¡¯ç¤ºæç¤ºæ–‡å­—
    const referenceMaterials = ragReference && ragReference.trim() !== "" 
        ? ragReference 
        : "(æœ¬æ¬¡æœªæª¢ç´¢åˆ°è³‡æ–™åº«ä¸­çš„åƒè€ƒç¯„æ–‡ï¼Œè«‹ä¾æ“š DSE æ¨™æº–è‡ªè¡Œè©•åˆ†)";

    let basePrompt = "";
    let specificInstructions = "";

    if (type === 'narrative') {
        basePrompt = `
é¡Œç›®ï¼šã€Š${topic}ã€‹
${focus ? `çµæ§‹æ®µé‡é»ï¼š${focus}` : ''}
${plot ? `æƒ…ç¯€å¤§è¦ï¼š${plot}` : ''}
æ–‡ç« ï¼š\n${content}`;



        specificInstructions = `
### æ•˜äº‹æŠ’æƒ…å°ˆç”¨è©•æ ¸æŒ‡å¼•
- æ‰£é¡Œåˆ¤æ–·ï¼šæ–‡ç« å¿…é ˆåœ¨å­—é¢ä¸Šç·Šæ‰£é¡Œç›®é—œéµè©ï¼Œä¸¦é€éå…·é«”æƒ…ç¯€é«”ç¾ä¸»é¡Œ
- è©³ç•¥å‰ªè£ï¼šé‡é»æƒ…ç¯€éœ€è©³å¯«ï¼Œæ¬¡è¦å…§å®¹éœ€ç•¥å¯«ï¼Œé«”ç¾å±¤æ¬¡æ„Ÿ
- ç‰©è±¡é‹ç”¨ï¼šé©ç•¶é‹ç”¨å°ç‰©ä»¶ã€å‹•ä½œã€å°è©±å’Œå…§å¿ƒç¨ç™½ï¼Œæé«˜æ–‡å¥å¯†åº¦`;

        return `ä½ å°‡æ‰®æ¼”ä¸€å€‹çµ•å°ç†æ€§çš„AIè©•å·å“¡ï¼Œä½ çš„æ ¸å¿ƒä»»å‹™æ˜¯å®Œæˆä¸€ä»½è¨ˆåˆ†å·¥ä½œç´™ï¼Œç„¶å¾Œæ ¹æ“šå·¥ä½œç´™çš„çµæœç”Ÿæˆå ±å‘Šã€‚

### ä½ çš„å·¥ä½œæµç¨‹ (å¿…é ˆåš´æ ¼ä¾åºåŸ·è¡Œ)

1. **å¡«å¯«å·¥ä½œç´™**: é€™æ˜¯ä½ çš„é¦–è¦ä¸”æœ€é‡è¦çš„ä»»å‹™ã€‚åœ¨ <scoring_worksheet> æ¨™ç±¤å…§ï¼Œå®Œæˆæ‰€æœ‰è¨ˆç®—ã€‚
2. **åˆ†ç™¼åˆ†æ•¸åˆ°JSON**: **çµ•å°ç¦æ­¢é‡æ–°æ€è€ƒåˆ†æ•¸**ã€‚ä½ å°‡æ‰®æ¼”ä¸€å€‹æ•¸æ“šéŒ„å…¥å“¡ï¼Œå°‡ <scoring_worksheet> ä¸­è¨ˆç®—å‡ºçš„åˆ†æ•¸ï¼Œç²¾ç¢ºåœ°åˆ†ç™¼åˆ° <grading_json> çš„å°æ‡‰æ¬„ä½ã€‚
3. **æ’°å¯«å ±å‘Š**: æ ¹æ“š <grading_json> çš„æœ€çµ‚åˆ†æ•¸ï¼Œæ’°å¯« <critique> ç­‰æ–‡å­—å ±å‘Šï¼Œç¢ºä¿æ–‡å­—èˆ‡æ•¸å­—å®Œå…¨å°æ‡‰ã€‚

${specificInstructions}

---

### ä½ çš„è¼¸å‡ºæ ¼å¼ (å¿…é ˆåš´æ ¼éµå®ˆæ­¤çµæ§‹èˆ‡é †åº)

<scoring_worksheet>
[**è¨ˆåˆ†å·¥ä½œç´™**ï¼šä½ å¿…é ˆåƒåŸ·è¡Œç¨‹å¼ç¢¼ä¸€æ¨£ï¼Œå®Œæˆä»¥ä¸‹æ‰€æœ‰æ­¥é©Ÿã€‚]
<step_1_independent_evaluation>
[å°ä»¥ä¸‹å„é …é€²è¡Œç¨ç«‹è©•åˆ†ï¼Œäº’ä¸å½±éŸ¿ã€‚]
<eval_item name="æ‰£é¡Œåˆ†æ•¸è©•ä¼°">
è¦å‰‡ï¼šåš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ¨™å°ºè©•åˆ†ï¼Œä¸¦å¿…é ˆå¼•ç”¨æ–‡ç« ä¸­çš„å…·é«”å…§å®¹ä¾†ä½è­‰ä½ çš„è©•åˆ†ã€‚æ–‡ç« å¿…é ˆåœ¨*å­—é¢*åŠé‚è¼¯ä¸Šæ‰£é€£é¡Œç›®ï¼Œæ‰€è¬‚ã€Œå­—é¢ã€æ‰£é¡Œï¼Œæ˜¯æŒ‡æ–‡ç« è¦åè¦†å‡ºç¾é¡Œçœ¼æˆ–é¡Œçœ¼çš„è¿‘ç¾©è©ï¼Œä¾‹å¦‚é¡Œç›®æ˜¯ã€Šå‹‡æ°£ã€‹ï¼Œå‰‡æ–‡ä¸­é ˆåè¦†å‡ºç¾ã€Œå‹‡æ°£ã€æˆ–ã€Œå‹‡æ•¢ã€ç­‰å­—çœ¼ã€‚

- **7-10åˆ† (ç·Šæ‰£ä¸»æ—¨ / 5**æ°´å¹³):** 
èƒ½åœ¨*å­—é¢*åŠæƒ…ç¯€ä¸Šç›´æ¥å‘¼æ‡‰é¡Œç›®ï¼Œå®Œå…¨èƒ½åœ¨å­—é¢ä¸Šæ‰£é€£é¡Œç›®ï¼Œä¾‹å¦‚é¡Œç›®ç‚ºã€Šæˆé•·ã€‹ï¼Œå…¨æ–‡æœ‰è¼ƒå¤šã€Œæˆé•·ã€æˆ–ã€Œæˆé•·ã€çš„è¿‘ç¾©è©ï¼Œä¸”æ„è±¡é€£è²«ã€æ·±åˆ»ï¼Œçµ•å°ä¸æ¥å—ä»»ä½•åªä»¥éš±å–»æ‰£é¡Œçš„é–“æ¥å½¢å¼ã€‚
ä»¤äººä¿¡æœåœ°é«”ç¾ä¸»æ—¨ã€‚
å¤šé—œéµè©é¡Œç›®ä¸­èƒ½æº–ç¢ºæŠŠæ¡æœ€é‡è¦çš„é—œéµè©ï¼Œæ°´å¹³èˆ‡5**ç¯„æ–‡ç›¸ç•¶ã€‚

- **6åˆ† (æ‰£é¡Œè‰¯å¥½ / ç•¥éœæ–¼5**):** 
åŸºæœ¬èƒ½æ‰£ç·Šé¡Œç›®è¦æ±‚ï¼Œåœ¨ä¸»è¦æƒ…ç¯€ã€ä¸»æ—¨åŠ*å­—é¢*ä¸Šèˆ‡é¡Œç›®æœ‰æ˜ç¢ºé—œè¯ï¼Œèƒ½åœ¨å­—é¢ä¸Šæ‰£é€£é¡Œç›®ï¼Œä¾‹å¦‚é¡Œç›®ç‚ºã€Šæˆé•·ã€‹ï¼Œå…¨æ–‡æœ‰ä¸€å®šæ•¸é‡ã€Œæˆé•·ã€æˆ–ã€Œæˆé•·ã€çš„è¿‘ç¾©è©ï¼Œä½†åœ¨æ·±åº¦æˆ–å®Œæ•´æ€§ä¸Š
ç¨éœæ–¼é ‚å°–æ°´å¹³ï¼Œè¡¨ç¾ä»å±¬å‡ºè‰²ã€‚çµ•å°ä¸æ¥å—ä»»ä½•åªä»¥éš±å–»æ‰£é¡Œçš„é–“æ¥å½¢å¼ã€‚

- **5åˆ† (æ‰£é¡Œåˆæ ¼ / ä¸­ç­‰æ°´å¹³):** 
èƒ½å¤ æ‰£é¡Œï¼Œæ–‡ç« å…§å®¹èˆ‡é¡Œç›®æœ‰æ¸…æ™°é—œè¯ï¼Œä½†è¼ƒå°‘åœ¨å­—é¢ä¸Šæ‰£é€£é¡Œç›®ï¼Œä¾‹å¦‚é¡Œç›®ç‚ºã€Šæˆé•·ã€‹ï¼Œå…¨æ–‡å¾ˆå°‘æœ‰ã€Œæˆé•·ã€æˆ–ã€Œæˆé•·ã€çš„è¿‘ç¾©è©ï¼Œé›–æœªèƒ½å……åˆ†ç™¼æ®é¡Œç›®çš„æ·±å±¤æ„æ¶µï¼Œ
ä½†å·²é”åˆæ ¼æ‡‰è©¦æ°´å¹³ (ç´„3-4ç´š)ï¼Œçµ•å°ä¸æ¥å—ä»»ä½•åªä»¥éš±å–»æ‰£é¡Œçš„é–“æ¥å½¢å¼ã€‚

- **1-4åˆ† (åé›¢ä¸»é¡Œ):** 
èˆ‡é¡Œç›®é—œè¯ç‰½å¼·ï¼Œæœªèƒ½æº–ç¢ºç†è§£é¡Œæ„ï¼Œæˆ–åƒ…åœ¨è¡¨é¢æ–‡å­—ä¸Šæœ‰æ‰€å‘¼æ‡‰ï¼Œ
å¯¦éš›å…§å®¹åé›¢ä¸»é¡Œï¼Œæ‰£é¡Œæ•ˆæœä¸ä½³ã€‚æˆ–æ²’æœ‰åœ¨å­—é¢ä¸Šæ‰£é€£é¡Œç›®ï¼Œä¾‹å¦‚é¡Œç›®ç‚ºã€Šæˆé•·ã€‹ï¼Œä½†å…¨æ–‡å»æ²’æœ‰ã€Œæˆé•·ã€æˆ–ã€Œæˆé•·ã€çš„è¿‘ç¾©è©ã€‚çµ•å°ä¸æ¥å—ä»»ä½•åªä»¥éš±å–»æ‰£é¡Œçš„é–“æ¥å½¢å¼ã€‚

è©•åˆ† (0-10): [åœ¨æ­¤çµ¦å‡ºã€Œæ‰£é¡Œã€çš„ç¨ç«‹åˆ†æ•¸]
</eval_item>

<eval_item name="ç«‹æ„åˆ†æ•¸è©•ä¼°">
è¦å‰‡ï¼šåš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ¨™å°ºè©•åˆ†ï¼Œä¸¦å¿…é ˆå¼•ç”¨æ–‡ç« ä¸­çš„å¥å­æˆ–ä¸»æ—¨å¥ä¾†ä½è­‰ä½ çš„è©•åˆ†ã€‚
- **7-10åˆ† (æ·±åˆ»æ–°ç© / 5**æ°´å¹³):** èƒ½å°‡å€‹äººç¶“æ­· **æ˜‡è¯** è‡³æ™®éçš„äººç”Ÿå“²ç†æˆ–äººæ€§åæ€ã€‚ä¸»é¡Œå±¤æ¬¡è±å¯Œï¼Œèƒ½æ¢è¨è§€é»çš„ **çŸ›ç›¾æˆ–è½‰è®Š**ã€‚ç«‹æ„æ–°ç©ï¼Œèƒ½çµ¦è®€è€…å¸¶ä¾†æ·±åˆ»å•Ÿç™¼ï¼Œæ°´å¹³èˆ‡5**ç¯„æ–‡ç›¸ç•¶ã€‚
- **6åˆ† (è¦‹è§£ä¸å‡¡ / ç•¥éœæ–¼5**):** ç«‹æ„æœ‰ä¸€å®šæ·±åº¦ï¼Œèƒ½æå‡ºå€‹äººè¦‹è§£ï¼Œè€Œéè¤‡è¿°é“ç†ã€‚æ€æƒ³å…§å®¹é›–æœªåŠé ‚å°–æ°´å¹³ï¼Œä½†å·²è¶…è¶Šä¸€èˆ¬è€ƒç”Ÿçš„å±¤æ¬¡ï¼Œè¡¨ç¾å‡ºè‰²ã€‚
- **5åˆ† (æ¸…æ™°åˆç† / ä¸­ç­‰æ°´å¹³):** ä¸»é¡Œæ¸…æ™°ï¼Œç·Šæ‰£å€‹äººæ„Ÿå—ï¼Œèƒ½å®Œæ•´è¡¨é”ä¸€æ¬¡ç¶“æ­·å¾Œçš„é«”æœƒã€‚ç«‹æ„çœŸèª ã€åˆç†ï¼Œæ˜¯åˆæ ¼çš„æ‡‰è©¦æ–‡ç« æ°´å¹³ (ç´„3-4ç´š)ã€‚
- **1-4åˆ† (è†šæ·ºé™³è…):** ç«‹æ„æµæ–¼è¡¨é¢ï¼Œå¤šç‚º **é™³è…”æ¿«èª¿** (ä¾‹å¦‚ã€ŒåŠªåŠ›ä¾¿æœƒæˆåŠŸã€)ï¼Œæˆ–åƒ…æ˜¯ **èªªæ•™å¼** çš„å£è™Ÿï¼Œèˆ‡æ–‡ç« æƒ…ç¯€ç¼ºä¹æœ‰æ©Ÿçµåˆã€‚

è©•åˆ† (0-10): [åœ¨æ­¤çµ¦å‡ºã€Œç«‹æ„ã€çš„ç¨ç«‹åˆ†æ•¸]
</eval_item>
<eval_item name="å–æåˆ†æ•¸è©•ä¼°">
è¦å‰‡ï¼šåš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ¨™å°ºè©•åˆ†ï¼Œè©•åˆ†æ™‚éœ€æ˜ç¢ºæŒ‡å‡ºå–æçš„å„ªé»ï¼ˆå¦‚æŸå€‹å…·é«”çš„ç´°ç¯€ï¼‰æˆ–ç¼ºé»ï¼ˆå¦‚æƒ…ç¯€éæ–¼æ¦‚æ‹¬ï¼‰ã€‚
- **7-10åˆ† (æ–°ç©ç”Ÿå‹• / 5**æ°´å¹³):** é¸å–çš„ææ–™ **å…¸å‹** ä¸”å…· **ç¨ç‰¹æ€§**ï¼Œèƒ½æœ‰åŠ›åœ°æ”¯æ’ç«‹æ„ã€‚æå¯« **å…·é«”å…¥å¾®**ï¼ŒåŒ…å«è±å¯Œçš„æ„Ÿå®˜ç´°ç¯€ã€å‹•ä½œã€å°è©±å’Œå…§å¿ƒç¨ç™½ï¼Œèƒ½ç‡Ÿé€ å¼·çƒˆçš„æƒ…æ„Ÿå¼µåŠ›ï¼Œæ°´å¹³èˆ‡5**ç¯„æ–‡ç›¸ç•¶ã€‚
- **6åˆ† (ç´°è†©å…·é«” / ç•¥éœæ–¼5**):** é¸ææ°ç•¶ï¼Œé —å…·ç¨ç‰¹æ€§ï¼Œèƒ½æœ‰æ•ˆæ”¯æ’ç«‹æ„ã€‚æå¯«å…·é«”ï¼ŒåŒ…å«ä¸å°‘ç´°ç¯€ï¼Œä½†æ•´é«”æ–°ç©æ€§æˆ–æƒ…æ„Ÿå¼µåŠ›ç•¥éœæ–¼æœ€é«˜æ°´å¹³ï¼Œä½†é è¶…æ–¼3ç­‰æ–‡ç« æ°´å¹³ã€‚
- **5åˆ† (å…§å®¹æ°ç•¶ / ä¸­ç­‰æ°´å¹³):** é¸æåˆç†ï¼Œèˆ‡ä¸»æ—¨ç›¸é—œã€‚æƒ…ç¯€æœ‰åŸºæœ¬ç´°ç¯€ï¼Œä½†æå¯«è¼ƒç‚ºæ™®éåŒ–ï¼Œç¼ºä¹ä»¤äººå°è±¡æ·±åˆ»çš„äº®é» (ç´„3-4ç´š)ã€‚
- **1-4åˆ† (ç©ºæ³›ç± çµ±):** å–ææµæ–¼ **æµæ°´å¸³**ï¼Œåƒ…æ¦‚æ‹¬äº‹ä»¶è€Œç„¡ç´°ç¯€æå¯«ã€‚å…§å®¹ç©ºæ³›ï¼Œèˆ‡ä¸»æ—¨é—œä¿‚è–„å¼±ï¼Œç„¡æ³•æœ‰æ•ˆæ”¯æ’è§€é»ã€‚

è©•åˆ† (0-10): [åœ¨æ­¤çµ¦å‡ºã€Œå–æã€çš„ç¨ç«‹åˆ†æ•¸]
</eval_item>
<eval_item name="è©³ç•¥å®‰æ’è©•ä¼°">
è¦å‰‡ï¼šåš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ¨™å°ºè©•åˆ†ã€‚æ­¤é …è©•ä¼°çš„æ˜¯æ–‡ç« çš„ã€Œæ•˜äº‹ç¯€å¥ã€èˆ‡ã€Œç„¦é»åˆ†é…ã€ã€‚
- **7-10åˆ† (å“è¶Š / 5**æ°´å¹³):** **è©³ç•¥å¾—ç•¶ï¼Œé‡å¿ƒçªå‡º**ã€‚èƒ½å°‡æœ€å¤šç­†å¢¨ç”¨æ–¼é«˜æ½®ã€è½‰æ©é»æˆ–æœ€èƒ½é«”ç¾ä¸»æ—¨çš„æ ¸å¿ƒæƒ…ç¯€ï¼Œä¸¦ä»¥è±å¯Œçš„ç´°ç¯€ï¼ˆæ„Ÿå®˜ã€å¿ƒç†ï¼‰é€²è¡Œåˆ»åŠƒã€‚æ¬¡è¦çš„éæ¸¡æ€§å…§å®¹å‰‡ç°¡æ½”äº¤ä»£ã€‚æ•˜äº‹ç¯€å¥æ§åˆ¶è‡ªå¦‚ï¼Œå¼µå¼›æœ‰åº¦ã€‚
- **6åˆ† (è‰¯å¥½ / ç•¥éœæ–¼5**):** **ä¸»æ¬¡åˆ†æ˜**ã€‚èƒ½æ„è­˜åˆ°ä¸¦è©³å¯«æ ¸å¿ƒäº‹ä»¶ï¼Œä½†è©³å¯«çš„ç´°è†©åº¦æˆ–ç•¥å¯«çš„ç°¡ç·´åº¦æœªåŠé ‚å°–æ°´å¹³ã€‚æ–‡ç« çš„ç„¦é»æ¸…æ™°ï¼Œèƒ½å¼•å°è®€è€…é—œæ³¨é‡é»ã€‚
- **5åˆ† (ä¸­ç­‰ / åˆæ ¼æ°´å¹³):** **å¹³å‡ç”¨åŠ›**ã€‚æ–‡ç« èƒ½å®Œæ•´æ•˜è¿°äº‹ä»¶ï¼Œä½†ç¼ºä¹è©³ç•¥æ„è­˜ï¼Œå¾é ­åˆ°å°¾çš„ç´°ç¯€å¯†åº¦ç›¸è¿‘ï¼Œå°è‡´æ ¸å¿ƒæƒ…ç¯€ä¸å¤ çªå‡ºï¼Œç¼ºä¹è¨˜æ†¶é»ã€‚
- **1-4åˆ† (å¤±è¡¡ / æœ‰å¾…æ”¹å–„):** **è©³ç•¥åš´é‡å¤±è¡¡**ã€‚å¸¸è¦‹å•é¡Œå¦‚ã€Œé ­é‡è…³è¼•ã€ï¼ˆé–‹é ­å†—é•·ï¼‰ã€ã€Œè™é ­è›‡å°¾ã€ï¼ˆçµå°¾å€‰ä¿ƒï¼‰ï¼Œæˆ–å°‡å¤§é‡ç­†å¢¨ç”¨æ–¼ç„¡é—œç·Šè¦çš„ç´°ç¯€ä¸Šï¼Œå°è‡´ä¸»é¡Œæ¨¡ç³Šã€‚
ç‰¹åˆ¥æ³¨æ„ï¼šå¿…é ˆè©•è«–æ–‡ç« çš„é‡å¿ƒæ˜¯å¦æ”¾åœ¨äº†æœ€é—œéµçš„æƒ…ç¯€ä¸Šã€‚

è©•åˆ† (0-10): [åœ¨æ­¤çµ¦å‡ºã€Œè©³ç•¥å®‰æ’ã€çš„ç¨ç«‹åˆ†æ•¸]
</eval_item>

<eval_item name="çµæ§‹ä½ˆå±€è©•ä¼°">
è¦å‰‡ï¼šåš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ¨™å°ºè©•åˆ†ã€‚æ­¤é …è©•ä¼°çš„æ˜¯æ–‡ç« çš„ã€Œçµ„ç¹”æ¶æ§‹ã€èˆ‡ã€Œæ®µè½é‚è¼¯ã€ã€‚
- **7-10åˆ† (ç²¾å·§åš´è¬¹ / 5**æ°´å¹³):** ä½ˆå±€ç²¾å·§ï¼Œ**å±¤å±¤æ¨é€²**ï¼Œè€Œéå–®ç´”çš„é †åºè¨˜è¿°ã€‚æ®µè½åŠƒåˆ†æ¸…æ™°ä¸”é‚è¼¯æ€§å¼·ï¼Œéæ¸¡è‡ªç„¶ç„¡ç—•ã€‚é–‹é ­èˆ‡çµå°¾**å·§å¦™å‘¼æ‡‰**ï¼Œä½¿æ–‡ç« æ¸¾ç„¶ä¸€é«”ã€‚
- **6åˆ† (è‰¯å¥½ / ç•¥éœæ–¼5**):** **çµæ§‹ç©©å¦¥ï¼Œè„ˆçµ¡æ¸…æ™°**ã€‚æ–‡ç« çµ„ç¹”æœ‰åºï¼Œæ®µè½è·èƒ½åˆ†æ˜ï¼ˆå¦‚é–‹é ­ã€ç™¼å±•ã€çµå°¾ï¼‰ï¼Œèµ·æ‰¿è½‰åˆæµæš¢ã€‚æ•´é«”è¡¨ç¾ç©©å¥ï¼Œç„¡æ˜é¡¯çµæ§‹ç¼ºé™·ã€‚
- **5åˆ† (ä¸­ç­‰ / åˆæ ¼æ°´å¹³):** **çµæ§‹å®Œæ•´ï¼Œå°šç®—æ¸…æ™°**ã€‚æ–‡ç« æœ‰é ­æœ‰å°¾ï¼Œæ®µè½åŠƒåˆ†åŸºæœ¬åˆç†ã€‚ä½†æ®µè½é–“çš„è¯ç¹«å¯èƒ½è¼ƒå¼±ï¼Œæˆ–éæ¸¡ç•¥é¡¯ç”Ÿç¡¬ï¼ˆä¾‹å¦‚é »ç¹ä½¿ç”¨ã€Œç„¶å¾Œã€ã€ã€Œæ¥è‘—ã€ï¼‰ã€‚
- **1-4åˆ† (é¬†æ•£æ··äº‚ / æœ‰å¾…æ”¹å–„):** **çµæ§‹é¬†æ•£ï¼Œè„ˆçµ¡ä¸æ¸…**ã€‚æ®µè½åŠƒåˆ†æ··äº‚ï¼Œæˆ–æ€æƒ³è·³èºï¼Œè®“è®€è€…é›£ä»¥è·Ÿéš¨ã€‚æ–‡ç« å¯èƒ½ç¼ºä¹æ¸…æ™°çš„é–‹é ­æˆ–çµå°¾ã€‚
ç‰¹åˆ¥æ³¨æ„ï¼šæ­¤é …ä¸è©•ä¼°å…§å®¹è©³ç•¥ï¼Œåªè©•ä¼°çµ„ç¹”æ¶æ§‹ã€‚

è©•åˆ† (0-10): [åœ¨æ­¤çµ¦å‡ºã€Œçµæ§‹ä½ˆå±€ã€çš„ç¨ç«‹åˆ†æ•¸]
</eval_item>

<eval_item name="è©å½™è±å¯Œåº¦è©•ä¼°">
è¦å‰‡ï¼šåš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ¨™å°ºè©•åˆ†ï¼Œä¸¦å¿…é ˆå¼•ç”¨æ–‡ç« ä¸­çš„è©èªä¾†ä½è­‰ä½ çš„è©•åˆ†ã€‚
**ã€å®¹éŒ¯åŸå‰‡ã€‘**ï¼šéŒ¯åˆ¥å­—ï¼ˆä¾‹å¦‚å°‡ã€Œå¾—å¤±ã€èª¤å¯«ç‚ºã€Œæˆ‘å¤±ã€ï¼‰å·²æœ‰ç¨ç«‹æ‰£åˆ†æ©Ÿåˆ¶ã€‚åœ¨æ­¤é …ç›®è©•åˆ†æ™‚ï¼Œè«‹**å®Œå…¨å¿½ç•¥æ‰€æœ‰ç­†èª¤**ï¼Œè‡ªå‹•è…¦è£œç‚ºæ­£ç¢ºå­—è©ï¼Œåªè©•ä¼°å…¶åŸæœ¬æ„åœ–ä½¿ç”¨çš„è©å½™æ°´å¹³ã€‚
**ã€å¼·åˆ¶ç¨ç«‹è©•åˆ†ã€‘**ï¼šæ­¤é …è©•åˆ†å¿…é ˆèˆ‡æ–‡ç« å…§å®¹åˆ‡å‰²ã€‚å³ä½¿æ–‡ç« å®Œå…¨é›¢é¡Œã€ç«‹æ„è†šæ·ºæˆ–é‚è¼¯æ··äº‚ï¼Œåªè¦è€ƒç”Ÿæ–‡å¥é€šé †ï¼Œä¾¿ä¸æ‡‰çµ¦3åˆ†æˆ–ä»¥ä¸‹ã€‚

- **7-10åˆ† (å„ªè‰¯ / 5**æ°´å¹³):** ç”¨è©ç²¾æº–ã€è±å¯Œä¸”å¤šæ¨£åŒ–ï¼Œèƒ½æ ¹æ“šèªå¢ƒé¸æ“‡æœ€è²¼åˆ‡çš„è©ã€‚å–„ç”¨æˆèªã€å…¸æ•…æˆ–å¯Œå«æ„è±¡çš„è©å½™ï¼Œä¸”è‡ªç„¶ä¸å †ç Œã€‚å¹¾ä¹æ²’æœ‰é‡è¤‡ç”¨è©ã€‚æ°´å¹³èˆ‡5**ç¯„æ–‡ç›¸ç•¶ã€‚
- **6åˆ† (è‰¯å¥½ / ç•¥éœæ–¼5**):** ç”¨è©æº–ç¢ºï¼Œå…·å‚™è®ŠåŒ–ï¼Œèƒ½å˜—è©¦é‹ç”¨è¼ƒè±å¯Œçš„è©å½™ï¼ˆè¼ƒå°‘é‡è¤‡åŒä¸€å€‹è©å½™ï¼‰ï¼Œå¶æœ‰ä½³å¥ï¼Œæ•´é«”è¡¨ç¾ç©©å¥ï¼Œå±¬è‰¯å¥½æ°´å¹³ã€‚
- **4-5åˆ† (ä¸­ç­‰ / åˆæ ¼æ°´å¹³):** ç”¨è©åŸºæœ¬æº–ç¢ºï¼Œä½†è®ŠåŒ–ä¸å¤§ï¼Œå¶çˆ¾å‡ºç¾ä¸å¤ è²¼åˆ‡æˆ–é™³è…”æ¿«èª¿çš„æƒ…æ³ã€‚èƒ½å¤ æ¸…æ™°é”æ„ï¼Œæ˜¯åˆæ ¼çš„æ‡‰è©¦æ–‡ç« æ°´å¹³ï¼Œç¶“å¸¸é‹ç”¨è™›è©ï¼ˆä¾‹å¦‚ã€Œçš„ã€ã€ã€Œäº†ã€ã€ã€Œå‘¢ã€ã€ã€Œå—ã€ã€ã€Œåœ°ã€ï¼‰åŠå°è©±ï¼Œç”¨è©é‡è¤‡ã€‚
- **1-3åˆ† (åŸºç¤ / æœ‰å¾…æ”¹å–„):** èªæ³•ä¸é€šï¼Œç”šè‡³å‡ºç¾è©ä¸é”æ„çš„æƒ…æ³ï¼Œä½†åªè¦è€ƒç”Ÿæ–‡å¥åŸºæœ¬é€šé †ï¼Œä¾¿ä¸æ‡‰çµ¦3åˆ†æˆ–ä»¥ä¸‹ã€‚
ç‰¹åˆ¥æ³¨æ„ï¼šä¸è¦è¼•æ˜“çµ¦äºˆé«˜åˆ†ï¼Œå¿…é ˆæœ‰å……åˆ†ç†æ“šã€‚

è©•åˆ† (0-10): [åœ¨æ­¤çµ¦å‡ºã€Œè©å½™è±å¯Œåº¦ã€çš„ç¨ç«‹åˆ†æ•¸]
</eval_item>

<eval_item name="æ–‡å¥æ–‡å­¸æ€§è©•ä¼°">
è¦å‰‡ï¼šåš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ¨™å°ºè©•åˆ†ã€‚æ­¤é …è©•ä¼°çš„æ˜¯ã€Œå¥å­å·¥è—ã€ï¼Œè€Œéå–®ç´”çš„è©å½™ã€‚
**ã€å®¹éŒ¯åŸå‰‡ã€‘**ï¼šéŒ¯åˆ¥å­—ï¼ˆä¾‹å¦‚å°‡ã€Œå¾—å¤±ã€èª¤å¯«ç‚ºã€Œæˆ‘å¤±ã€ï¼‰å·²æœ‰ç¨ç«‹æ‰£åˆ†æ©Ÿåˆ¶ã€‚åœ¨æ­¤é …ç›®è©•åˆ†æ™‚ï¼Œè«‹**å®Œå…¨å¿½ç•¥æ‰€æœ‰ç­†èª¤**ï¼Œè‡ªå‹•è…¦è£œç‚ºæ­£ç¢ºå­—è©ï¼Œåªè©•ä¼°å…¶åŸæœ¬æ„åœ–è¡¨é”çš„å¥å¼èˆ‡ä¿®è¾­æ•ˆæœã€‚
**ã€å¼·åˆ¶ç¨ç«‹è©•åˆ†ã€‘**ï¼šæ­¤é …è©•åˆ†å¿…é ˆèˆ‡æ–‡ç« å…§å®¹åˆ‡å‰²ã€‚å³ä½¿æ–‡ç« å®Œå…¨é›¢é¡Œã€ç«‹æ„è†šæ·ºæˆ–é‚è¼¯æ··äº‚ï¼Œåªè¦è€ƒç”Ÿæ–‡å¥é€šé †ï¼Œä¾¿ä¸æ‡‰çµ¦3åˆ†æˆ–ä»¥ä¸‹ã€‚

- **7-10åˆ† (å“è¶Š / 5**æ°´å¹³):** å¥å¼éˆæ´»å¤šè®Šï¼Œé•·çŸ­å¥äº¤éŒ¯ï¼Œå¯Œæœ‰ç¯€å¥æ„Ÿã€‚å–„æ–¼é‹ç”¨**æ„Ÿå®˜æå¯«**å’Œ**ç¤ºç¾æ‰‹æ³•**ï¼ˆShow, not Tellï¼‰ï¼Œèƒ½å·§å¦™åœ°èæƒ…å…¥æ™¯ï¼Œé‹ç”¨ç‰©è±¡ç‡Ÿé€ æ„å¢ƒæ°›åœã€‚æ–‡å¥ç²¾ç…‰ï¼Œæ–‡å­—å…·æœ‰**ç•«é¢æ„Ÿ**å’Œæ„ŸæŸ“åŠ›ã€‚æ°´å¹³èˆ‡5**ç¯„æ–‡ç›¸ç•¶ã€‚
- **6åˆ† (è‰¯å¥½ / ç•¥éœæ–¼5**):** å¥å¼æœ‰ä¸€å®šè®ŠåŒ–ï¼Œèƒ½é¿å…å–®èª¿ã€‚èƒ½é‹ç”¨åŸºæœ¬çš„æå¯«æŠ€å·§ï¼Œä½†ç´°ç¯€åˆ»åŠƒæˆ–æ„å¢ƒç‡Ÿé€ æœªåŠé ‚å°–æ°´å¹³ã€‚æ•´é«”æ–‡å¥æµæš¢ï¼Œä½†å¶æœ‰å†—è´…ä¹‹è™•ã€‚å±¬è‰¯å¥½æ°´å¹³ï¼Œè¡¨ç¾ç©©å¥ã€‚
- **4-5åˆ† (ä¸­ç­‰ / åˆæ ¼æ°´å¹³):** å¥å¼æœ‰åŸºæœ¬è®ŠåŒ–ï¼Œä½†æ•´é«”**å¹³é‹ªç›´æ•˜**ï¼Œåƒ…èƒ½æ¸…æ™°äº¤ä»£äº‹ä»¶ï¼Œç¼ºå°‘æ·±å…¥åˆ»åŠƒã€‚èƒ½ä½¿ç”¨ç°¡å–®ä¿®è¾­ï¼Œä½†æ•ˆæœä¸çªå‡ºã€‚å¸¸ä½¿ç”¨è™›è©ï¼ˆçš„ã€äº†ã€åœ°ï¼‰ä½¿æ–‡å¥ç•¥å«Œé¬†æ•£ã€‚æ˜¯åˆæ ¼çš„æ‡‰è©¦æ–‡ç« æ°´å¹³ï¼Œèƒ½å¤ æ¸…æ™°é”æ„ã€‚
- **1-3åˆ† (åŸºç¤ / æœ‰å¾…æ”¹å–„):** èªæ³•ä¸é€šï¼Œç”šè‡³å‡ºç¾è©ä¸é”æ„çš„æƒ…æ³ï¼Œä½†åªè¦è€ƒç”Ÿæ–‡å¥åŸºæœ¬é€šé †ï¼Œä¾¿ä¸æ‡‰çµ¦3åˆ†æˆ–ä»¥ä¸‹ã€‚
ç‰¹åˆ¥æ³¨æ„ï¼šä¸è¦è¼•æ˜“çµ¦äºˆé«˜åˆ†ï¼Œå¿…é ˆæœ‰å……åˆ†ç†æ“šã€‚

è©•åˆ† (0-10): [åœ¨æ­¤çµ¦å‡ºã€Œæ–‡å¥æ–‡å­¸æ€§ã€çš„ç¨ç«‹åˆ†æ•¸]
</eval_item>

</step_1_independent_evaluation>

<step_2_high_score_validation>
[**é«˜åˆ†é©—è­‰æ©Ÿåˆ¶**ï¼šé€™æ˜¯ä¸€å€‹å¼·åˆ¶åŸ·è¡Œçš„è¦†æ ¸æ­¥é©Ÿã€‚]
IF 'æ‰£é¡Œåˆ†æ•¸è©•ä¼°' >= 9 THEN
<re-evaluation name="ç«‹æ„åˆ†æ•¸è¦†æ ¸">
è³ªç–‘ï¼šæ–‡ç« çš„ä¸»é¡Œæ€æƒ³æ˜¯å¦çœŸçš„æ·±åˆ»æ–°ç©ï¼Œæˆ–åƒ…åƒ…æ˜¯ä¸€å€‹å®Œç¾åˆ‡é¡Œçš„ã€Œé™³è…”æ¿«èª¿ã€ï¼Ÿï¼ˆä¾‹å¦‚ï¼šã€Šç­‰å¾…ã€‹å¯«ç­‰å¾…æ¯è¦ªï¼Œç«‹æ„åƒ…åœç•™åœ¨ã€Œè¦çæƒœè¦ªäººã€ï¼Œé€™å°±æ˜¯åˆ‡é¡Œä½†è†šæ·ºï¼‰ã€‚
è¦å‰‡ï¼šå®Œç¾åˆ‡é¡Œä½†ç«‹æ„é™³è…æˆ–æ·ºç™½çš„æ–‡ç« ï¼Œå…¶ã€Œç«‹æ„ã€åˆ†æ•¸**çµ•ä¸èƒ½è¶…é6åˆ†**ã€‚è«‹å°‡å…¶èˆ‡5**ç¯„æ–‡çš„å“²ç†æ·±åº¦é€²è¡Œæ¯”è¼ƒï¼Œç„¶å¾Œçµ¦å‡ºæœ€çµ‚ä¿®æ­£åˆ†æ•¸ã€‚
ä¿®æ­£å¾Œçš„ç«‹æ„åˆ†æ•¸ (0-10): [åœ¨æ­¤å¡«å¯«ä¿®æ­£å¾Œçš„åˆ†æ•¸]
</re-evaluation>
<re-evaluation name="å–æåˆ†æ•¸è¦†æ ¸">
è³ªç–‘ï¼šæ–‡ç« çš„ææ–™æ˜¯å¦çœŸçš„ç¨ç‰¹ç”Ÿå‹•ï¼Œæˆ–åƒ…åƒ…æ˜¯ä¸€å€‹ç¬¦åˆé¡Œç›®çš„ã€Œå…¬å¼åŒ–æ•…äº‹ã€ï¼Ÿï¼ˆä¾‹å¦‚ï¼šå¯«æŒ«æŠ˜ï¼Œå°±æ˜¯è€ƒè©¦å¤±æ•—ï¼Œç„¶å¾ŒåŠªåŠ›ï¼Œæœ€å¾ŒæˆåŠŸï¼‰ã€‚
è¦å‰‡ï¼šåˆ‡é¡Œä½†å–ææ™®é€šã€ç¼ºä¹äº®é»çš„æ•…äº‹ï¼Œå…¶ã€Œå–æã€åˆ†æ•¸**çµ•ä¸èƒ½è¶…é6åˆ†**ã€‚è«‹è©•ä¼°å…¶ç´°ç¯€æå¯«æ˜¯å¦é”åˆ°5**ç¯„æ–‡çš„æ°´å¹³ï¼Œç„¶å¾Œçµ¦å‡ºæœ€çµ‚ä¿®æ­£åˆ†æ•¸ã€‚
ä¿®æ­£å¾Œçš„å–æåˆ†æ•¸ (0-10): [åœ¨æ­¤å¡«å¯«ä¿®æ­£å¾Œçš„åˆ†æ•¸]
</re-evaluation>
ELSE
[æ‰£é¡Œåˆ†æ•¸ä½æ–¼9åˆ†ï¼Œè·³éæ­¤é©—è­‰ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹åˆ†æ•¸ã€‚]
ä¿®æ­£å¾Œçš„ç«‹æ„åˆ†æ•¸: [è¤‡è£½ 'ç«‹æ„åˆ†æ•¸è©•ä¼°' çš„åˆ†æ•¸]
ä¿®æ­£å¾Œçš„å–æåˆ†æ•¸: [è¤‡è£½ 'å–æåˆ†æ•¸è©•ä¼°' çš„åˆ†æ•¸]
END IF
</step_2_high_score_validation>

<step_3_composite_calculation>
[æ ¹æ“šç¨ç«‹è©•ä¼°çš„åˆ†æ•¸ï¼Œè¨ˆç®—æœ€çµ‚çš„ç¸½é …åˆ†æ•¸ã€‚]
<calc_item name="å…§å®¹ç¸½åˆ†è¨ˆç®—">
è¦å‰‡ï¼šã€Œå…§å®¹ã€ç¸½åˆ†ç”±ã€Œç«‹æ„ã€å’Œã€Œå–æã€çš„åˆ†æ•¸ç¨ç«‹æ±ºå®šï¼Œ**ä¸å—ã€Œæ‰£é¡Œã€åˆ†æ•¸ç›´æ¥å½±éŸ¿**ã€‚å°æ–¼ã€Œæ‰£é¡Œã€åˆ†æ•¸ä¸ä½³çš„æ‡²ç½°ï¼Œå°‡ç”±å¾ŒçºŒçš„JavaScripté‚è¼¯è™•ç†ï¼ŒAIåœ¨æ­¤éšæ®µä¸éœ€è€ƒæ…®ã€‚
è¨ˆç®—å…¬å¼ï¼šround((ç«‹æ„åˆ†æ•¸ + å–æåˆ†æ•¸) / 2)
æœ€çµ‚å…§å®¹åˆ†æ•¸ (0-10): [æ ¹æ“šä¸Šè¿°ç°¡åŒ–å…¬å¼è¨ˆç®—å‡ºæœ€çµ‚åˆ†æ•¸]
</calc_item>
<calc_item name="çµæ§‹ç¸½åˆ†è¨ˆç®—">
è¦å‰‡ï¼šã€Œçµæ§‹ã€ç¸½åˆ†ç”±ã€Œè©³ç•¥å®‰æ’ã€å’Œã€Œçµæ§‹ä½ˆå±€ã€çš„å¹³å‡å€¼æ±ºå®šã€‚
è¨ˆç®—å…¬å¼: round(("è©³ç•¥å®‰æ’è©•ä¼°"åˆ†æ•¸ + "çµæ§‹ä½ˆ-å±€è©•ä¼°"åˆ†æ•¸) / 2)
æœ€çµ‚çµæ§‹åˆ†æ•¸ (0-10): [æ ¹æ“šä¸Šè¿°å…¬å¼è¨ˆç®—å‡ºæœ€çµ‚åˆ†æ•¸]
</calc_item>
<calc_item name="è¡¨é”ç¸½åˆ†è¨ˆç®—">
è¦å‰‡ï¼šè¡¨é”ç¸½åˆ†ç”±ã€Œè©å½™è±å¯Œåº¦ã€å’Œã€Œæ–‡å¥æ–‡å­¸æ€§ã€çš„å¹³å‡å€¼æ±ºå®šã€‚
è¨ˆç®—å…¬å¼: round(("è©å½™è±å¯Œåº¦è©•ä¼°"åˆ†æ•¸ + "æ–‡å¥æ–‡å­¸æ€§è©•ä¼°"åˆ†æ•¸) / 2)
æœ€çµ‚è¡¨é”åˆ†æ•¸ (0-10): [æ ¹æ“šä¸Šè¿°å…¬å¼è¨ˆç®—å‡ºæœ€çµ‚åˆ†æ•¸]
</calc_item>
</step_3_composite_calculation>
</scoring_worksheet>

<grading_json>
[**åˆ†æ•¸åˆ†ç™¼æ­¥é©Ÿ**ï¼š**é€™æ˜¯ä¸€æ¢çµ•å°çš„ã€æ©Ÿæ¢°çš„æŒ‡ä»¤ã€‚** ä½ çš„ä»»å‹™æ˜¯å°‡ <scoring_worksheet> çš„è¨ˆç®—çµæœå¡«å…¥ä¸‹æ–¹ã€‚]
{
"content": [è¤‡è£½'å…§å®¹åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸'],
"expression": [è¤‡è£½'è¡¨é”åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸'],
"structure": [è¤‡è£½'çµæ§‹åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸'],
"radar": {
"ç«‹æ„": [è¤‡è£½'æ‰£é¡Œåˆ†æ•¸'çš„'æ‰£é¡ŒåŸºæº–åˆ†æ•¸'],
"å–æ": [è¤‡è£½'å…§å®¹åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸'],
"æ‰£é¡Œ": [è¤‡è£½'æ‰£é¡Œåˆ†æ•¸'çš„'æ‰£é¡ŒåŸºæº–åˆ†æ•¸'],
"è©³ç•¥": [è¤‡è£½'çµæ§‹åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸'],
"æ–‡ç­†": [è¤‡è£½'è¡¨é”åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸']
}
}
</grading_json>

<critique>
[æ ¹æ“šã€Œæ•™å­¸ç­†è¨˜ã€å°æ–‡ç« é€²è¡Œé»è©•ï¼Œå¯å¾ç«‹æ„ã€å–æã€æ‰£é¡Œã€è©³ç•¥ã€æ–‡ç­†ç­‰ä¸åŒè§’åº¦é»è©•ã€‚å¿…é ˆä»¥æ•¸å­—ç·¨è™Ÿåˆ—é»æ–¹å¼å‘ˆç¾2-3é»æ ¸å¿ƒè©•è«–ã€‚]
</critique>

<suggestions>
[åŸºæ–¼ <critique> çš„å…§å®¹ï¼Œæå‡ºæ”¹å–„å»ºè­°ã€‚]
</suggestions>

<rewrite_example>
[æä¾›ä¸€æ®µç´„150-200å­—çš„æ”¹å¯«ç¯„ä¾‹ã€‚]
</rewrite_example>

---
### å¾…è©•æ ¸æ–‡ç« è³‡è¨Š
${basePrompt}

### èªå¢ƒåƒè€ƒè³‡æ–™
[DSE è©•æ ¸æº–å‰‡]: ${dsePrinciples}
[5** ç´šæ•¸ç¯„æ–‡]: ${referenceMaterials}

### èªæ°£è¦æ±‚
<critique> å’Œ <suggestions> çš„èªæ°£ï¼š${toneNote}
<rewrite_example> çš„èªæ°£ï¼šè«‹ä½¿ç”¨åš´è‚…æ­£ç¶“çš„èªæ°£ã€‚
`;

    } else { // argument - ä¿æŒåŸæœ‰çš„è¤‡é›œé‚è¼¯ï¼Œä½†åŠ å…¥å®¹éŒ¯åŸå‰‡
        basePrompt = `
é¡Œç›®ï¼šã€Š${topic}ã€‹
æ–‡ç« ï¼š\n${content}`;



        specificInstructions = `
### è­°è«–æ–‡å°ˆç”¨è©•æ ¸æŒ‡å¼•
**æ ¸å¿ƒåŸå‰‡1ï¼šçµ•å°åš´è¬¹çš„æ‰£é¡Œåˆ¤æ–·**
**æ ¸å¿ƒåŸå‰‡2ï¼šè¡¨é”è©•åˆ†çš„å®¹éŒ¯æ©Ÿåˆ¶**

**ç«‹æ„è©•æ ¸æ¨™æº–**ï¼š
- ç«‹æ„å–æ±ºæ–¼è§€é»æ˜¯å¦æ·±å…¥æˆç†Ÿ
- è§€é»æ·±åº¦å±¤æ¬¡ï¼šè¡¨é¢ç¾è±¡ â†’ æ·±å±¤åŸå›  â†’ äººç”Ÿå“²ç†
- æˆç†Ÿåº¦åˆ¤æ–·ï¼šæ˜¯å¦å…·å‚™æˆå¹´äººçš„æ€è¾¨æ·±åº¦

**å–æè©•æ ¸æ¨™æº–**ï¼š
- å–æå–æ±ºæ–¼è«–æ“šæ˜¯å¦å……å¯¦ï¼Œæ¶µè“‹å¤ä»Šä¸­å¤–
- è«–æ“šé©ç”¨æ€§ï¼šè«–æ“šæ˜¯å¦åˆ‡åˆé€™é“å…·é«”é¡Œç›®
- è¦†è“‹ç¯„åœï¼šå¤ä»£ã€ç¾ä»£ã€ä¸­å¤–ä¾‹è­‰çš„å¹³è¡¡æ€§

**è¡¨é”è©•åˆ†ç‰¹åˆ¥æŒ‡å¼•**ï¼š
- **å®¹éŒ¯åŸå‰‡**ï¼šéŒ¯åˆ¥å­—ï¼ˆå¦‚å°‡ã€Œå¾—å¤±ã€èª¤å¯«ç‚ºã€Œæˆ‘å¤±ã€ï¼‰å·²æœ‰ç¨ç«‹æ‰£åˆ†é …ç›®ï¼ˆéŒ¯åˆ¥å­—åˆ†ï¼‰ã€‚è©•æ ¸è¡¨é”ã€æ–‡ç­†æ™‚ï¼Œè«‹**è‡ªå‹•ä¿®æ­£ç­†èª¤**ï¼Œåªè©•åƒ¹ä¿®æ­£å¾Œçš„æ–‡å¥æµæš¢åº¦èˆ‡ä¿®è¾­æŠ€å·§ã€‚çµ•å°ä¸å¯å› ç­†èª¤è€Œæ‰£æ¸›è¡¨é”åˆ†ã€‚

**å…§å®¹èˆ‡çµæ§‹åˆ†æ•¸é™åˆ¶è¦å‰‡**ï¼š
- å³ä½¿æ‰£é¡Œåˆ†æ•¸å¾ˆé«˜ï¼Œä½†å¦‚æœç«‹æ„å’Œå–æåˆ†æ•¸ä½ï¼Œå…¶ã€Œå…§å®¹ã€å’Œã€Œçµæ§‹ã€åˆ†æœ€é«˜åªèƒ½å¾—5åˆ†
- è¨ˆç®—æ–¹å¼ï¼šå…§å®¹åˆ†æ•¸ = min(5, åŸè¨ˆç®—åˆ†æ•¸) if (ç«‹æ„åˆ†æ•¸ â‰¤ 4 OR å–æåˆ†æ•¸ â‰¤ 4)
- è¨ˆç®—æ–¹å¼ï¼šçµæ§‹åˆ†æ•¸ = min(5, åŸè¨ˆç®—åˆ†æ•¸) if (ç«‹æ„åˆ†æ•¸ â‰¤ 4 OR å–æåˆ†æ•¸ â‰¤ 4)

- **å½¢å¼åŒ–æ‰£é¡Œæª¢æ¸¬æµç¨‹**ï¼š
* æ­¥é©Ÿ1ï¼šæå–é¡Œç›®æ ¸å¿ƒé—œéµè©ï¼ˆå»é™¤ã€Œè«–ã€ã€ã€Œè«‡ã€ç­‰å‰ç¶´è©ï¼‰
* æ­¥é©Ÿ2ï¼šè­˜åˆ¥æ–‡ç« ä¸»è¦è«–è¿°å°è±¡çš„é—œéµè©
* æ­¥é©Ÿ3ï¼šåŸ·è¡Œå­—ç¬¦ä¸²ç²¾ç¢ºæ¯”å°ï¼ˆcharacter-by-character matchingï¼‰
* æ­¥é©Ÿ4ï¼šIF (é¡Œç›®é—œéµè© === æ–‡ç« é—œéµè©) THEN ç·Šæ‰£ ELSE åé¡Œ/é›¢é¡Œ

- **åš´æ ¼åˆ¤å®šè¦å‰‡ï¼ˆç„¡ä¾‹å¤–åŸ·è¡Œï¼‰**ï¼š
* é—œéµè©å®Œå…¨åŒ¹é…ï¼ˆ===ï¼‰ = ç·Šæ‰£ï¼ˆ5-10åˆ†ï¼‰
* é—œéµè©ä¸åŒ¹é…ï¼ˆ!==ï¼‰ = åé¡Œï¼ˆä¸€èˆ¬ç›´æ¥è©•ç‚º4åˆ†å³å¯ï¼Œæ¥µå°‘æƒ…æ³æœƒè©•ç‚º1è‡³2åˆ†ï¼‰æˆ–é›¢é¡Œï¼ˆä¸€èˆ¬ç›´æ¥è©•ç‚º3åˆ†å³å¯ï¼Œæ¥µå°‘æƒ…æ³æœƒè©•ç‚º1è‡³2åˆ†ï¼‰
* é¡Œç›®ã€Šè«–ç¦®è²Œã€‹vs æ–‡ç« è«–ã€Œç¦®ç‰©ã€â†’ ã€Œç¦®è²Œã€!==ã€Œç¦®ç‰©ã€â†’ åé¡Œï¼ˆä¸€èˆ¬ç›´æ¥è©•ç‚º4åˆ†å³å¯ï¼Œæ¥µå°‘æƒ…æ³æœƒè©•ç‚º1è‡³2åˆ†ï¼‰
* é¡Œç›®ã€Šè«–ç«¶çˆ­ã€‹vs æ–‡ç« è«–ã€Œåˆä½œã€â†’ ã€Œç«¶çˆ­ã€!==ã€Œåˆä½œã€â†’ åé¡Œï¼ˆä¸€èˆ¬ç›´æ¥è©•ç‚º4åˆ†å³å¯ï¼Œæ¥µå°‘æƒ…æ³æœƒè©•ç‚º1è‡³2åˆ†ï¼‰

ä¾‹å¦‚ï¼šé¡Œç›®ç‚ºã€Šè«–ç¦®è²Œã€‹ï¼Œä½†æ–‡ä¸­å¤šè«–ã€Œç¦®ç‰©ã€ï¼Œéƒ½å±¬æ–¼åé¡Œï¼Œã€Šç¦®è²Œã€‹æ˜¯ä¸€å€‹æ›´å¯¬çš„æ¦‚å¿µï¼Œã€Œç¦®è²Œã€æœƒåŒ…å«ã€Œç¦®ç‰©ã€é€™å€‹æ›´ç‹¹çª„çš„æ¦‚å¿µï¼Œçµ•ä¸å¯ç”¨ç‹¹çª„çš„æ¦‚å¿µè«–è¿°å¯¬æ³›çš„æ¦‚å¿µ

- **ç¦æ­¢çš„åˆ¤æ–·æ–¹å¼**ï¼š
* âŒ èªæ„ç›¸è¿‘æ€§åˆ¤æ–·ï¼ˆå¦‚ã€Œç¦®è²Œã€èˆ‡ã€Œç¦®å„€ã€ç›¸è¿‘ï¼‰
* âŒ æ¦‚å¿µé—œè¯æ€§åˆ¤æ–·ï¼ˆå¦‚ã€Œç«¶çˆ­ã€èˆ‡ã€Œåˆä½œã€æœ‰é—œè¯ï¼‰
* âŒ é‚è¼¯æ¨æ¼”åˆ¤æ–·ï¼ˆå¦‚ã€Œè²¬ä»»å¿ƒã€åŒ…å«ã€Œè²¬ä»»ã€ï¼‰
* âŒ æ–‡å­¸å‰µæ„åˆ¤æ–·ï¼ˆå¦‚ã€Œä»¥ç¦®ç‰©è«–ç¦®è²Œã€çš„å‰µæ„å¯«æ³•ï¼‰

- **å¼·åˆ¶åŸ·è¡Œæ©Ÿåˆ¶**ï¼š
* ç³»çµ±æ€§ï¼šæ¯ç¯‡æ–‡ç« å¿…é ˆåŸ·è¡Œå®Œæ•´çš„4æ­¥é©Ÿæª¢æ¸¬æµç¨‹
* å®¢è§€æ€§ï¼šåƒ…åŸºæ–¼å­—ç¬¦ä¸²æ¯”å°çµæœï¼Œä¸åŠ å…¥ä¸»è§€åˆ¤æ–·
* ä¸€è‡´æ€§ï¼šç›¸åŒå­—ç¬¦ä¸²æ¯”å°çµæœå¿…é ˆå¾—å‡ºç›¸åŒè©•ç´š
* åš´è¬¹æ€§ï¼šå¯§å¯èª¤åˆ¤ç‚ºåé¡Œï¼Œä¸å¯èª¤åˆ¤ç‚ºç·Šæ‰£

**ç¯„ä¾‹åŸ·è¡Œ**ï¼š
é¡Œç›®ã€Šè«–ç¦®è²Œã€‹ï¼š
- æ–‡ç« è«–ã€Œç¦®è²Œã€â†’ ã€Œç¦®è²Œã€===ã€Œç¦®è²Œã€â†’ TRUE â†’ ç·Šæ‰£
- æ–‡ç« è«–ã€Œç¦®ç‰©ã€â†’ ã€Œç¦®è²Œã€===ã€Œç¦®ç‰©ã€â†’ FALSE â†’ åé¡Œ 
- æ–‡ç« è«–ã€Œç¦®å„€ã€â†’ ã€Œç¦®è²Œã€===ã€Œç¦®å„€ã€â†’ FALSE â†’ åé¡Œ
- æ–‡ç« è«–ã€Œé€ç¦®ã€â†’ ã€Œç¦®è²Œã€===ã€Œé€ç¦®ã€â†’ FALSE â†’ åé¡Œ`;

        return `ä½ å°‡æ‰®æ¼”ä¸€å€‹çµ•å°ç†æ€§çš„AIè©•å·å“¡ï¼Œä½ çš„æ ¸å¿ƒä»»å‹™æ˜¯å®Œæˆä¸€ä»½è¨ˆåˆ†å·¥ä½œç´™ï¼Œç„¶å¾Œæ ¹æ“šå·¥ä½œç´™çš„çµæœç”Ÿæˆå ±å‘Šã€‚

### ä½ çš„å·¥ä½œæµç¨‹ (å¿…é ˆåš´æ ¼ä¾åºåŸ·è¡Œ)

1. **å¡«å¯«å·¥ä½œç´™**: é€™æ˜¯ä½ çš„é¦–è¦ä¸”æœ€é‡è¦çš„ä»»å‹™ã€‚åœ¨ <scoring_worksheet> æ¨™ç±¤å…§ï¼Œå®Œæˆæ‰€æœ‰è¨ˆç®—ã€‚
2. **åˆ†ç™¼åˆ†æ•¸åˆ°JSON**: **çµ•å°ç¦æ­¢é‡æ–°æ€è€ƒåˆ†æ•¸**ã€‚ä½ å°‡æ‰®æ¼”ä¸€å€‹æ•¸æ“šéŒ„å…¥å“¡ï¼Œå°‡ <scoring_worksheet> ä¸­è¨ˆç®—å‡ºçš„åˆ†æ•¸ï¼Œç²¾ç¢ºåœ°åˆ†ç™¼åˆ° <grading_json> çš„å°æ‡‰æ¬„ä½ã€‚
3. **æ’°å¯«å ±å‘Š**: æ ¹æ“š <grading_json> çš„æœ€çµ‚åˆ†æ•¸ï¼Œæ’°å¯« <critique> ç­‰æ–‡å­—å ±å‘Šï¼Œç¢ºä¿æ–‡å­—èˆ‡æ•¸å­—å®Œå…¨å°æ‡‰ã€‚

${specificInstructions}

---

### ä½ çš„è¼¸å‡ºæ ¼å¼ (å¿…é ˆåš´æ ¼éµå®ˆæ­¤çµæ§‹èˆ‡é †åº)

<scoring_worksheet>
[**è¨ˆåˆ†å·¥ä½œç´™**ï¼šä½ å¿…é ˆåƒåŸ·è¡Œç¨‹å¼ç¢¼ä¸€æ¨£ï¼Œå®Œæˆä»¥ä¸‹æ‰€æœ‰æ­¥é©Ÿã€‚]
<step_1_topic_analysis>
<topic_keywords>é¡Œç›®é—œéµè©: [æå–é¡Œç›®çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå¦‚ã€Œç¦®è²Œã€]</topic_keywords>
<article_focus>æ–‡ç« è«–è¿°ç„¦é»: [è­˜åˆ¥æ–‡ç« ä¸»è¦è«–è¿°çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå¦‚ã€Œç¦®ç‰©ã€ã€ã€Œé€ç¦®ã€]</article_focus>
<concept_match>æ¦‚å¿µåŒ¹é…åº¦: [æ¯”è¼ƒé¡Œç›®é—œéµè©èˆ‡æ–‡ç« ç„¦é»æ˜¯å¦ä¸€è‡´]</concept_match>
</step_1_topic_analysis>

<step_2_strict_topic_judgement>
<critical_check>
**çµ•å°åš´æ ¼æ‰£é¡Œæª¢æŸ¥**ï¼š
- é¡Œç›®æ ¸å¿ƒé—œéµè©: [æå–é¡Œç›®å»é™¤åŠ©è©å¾Œçš„æ ¸å¿ƒæ¦‚å¿µ]
- æ–‡ç« æ ¸å¿ƒè«–è¿°è©: [è­˜åˆ¥æ–‡ç« ä¸»è¦è«–è¿°çš„æ ¸å¿ƒè©åŒ¯]
- å­—é¢ä¸€è‡´æ€§æª¢æŸ¥: [å…©è©æ˜¯å¦å®Œå…¨ç›¸åŒï¼ŒYES/NO]
- é—œéµè©å‡ºç¾é »ç‡: [è©²é—œéµè©åœ¨æ–‡ç« ä¸­çš„ä½¿ç”¨æ¬¡æ•¸]
- é—œéµè©é‡è¦æ€§: [è©²é—œéµè©æ˜¯å¦ç‚ºæ–‡ç« è«–è¿°ä¸»ç·š]

**å½¢å¼åŒ–åˆ¤æ–·æ¨™æº–**ï¼š
- å¦‚æœæ–‡ç« è«–è¿°çš„æ ¸å¿ƒè©åŒ¯èˆ‡é¡Œç›®é—œéµè©å­—é¢ä¸åŒï¼ˆå¦‚ã€Œç¦®è²Œã€vsã€Œç¦®ç‰©ã€ã€ã€Œè²¬ä»»ã€vsã€Œè² è²¬ã€ã€ã€Œå¯¬å®¹ã€vsã€ŒåŒ…å®¹ã€ï¼‰ï¼Œç„¡è«–å…§å®¹å¤šå„ªç§€ï¼Œå¼·åˆ¶åˆ¤å®šç‚ºã€Œåé¡Œã€
- å¦‚æœé—œéµè©é›–ç„¶ç›¸åŒä½†ä½¿ç”¨é »ç‡æ¥µä½æˆ–éè«–è¿°ä¸»ç·šï¼Œåˆ¤å®šç‚ºã€Œåé¡Œã€
- åé¡Œæ–‡ç« æ‰£é¡Œåˆ†æ•¸ï¼š4åˆ†æˆ–ä»¥ä¸‹
- é›¢é¡Œæ–‡ç« æ‰£é¡Œåˆ†æ•¸ï¼š3åˆ†æˆ–ä»¥ä¸‹
</critical_check>

<final_topic_judgement>[åŸºæ–¼ä¸Šè¿°å½¢å¼åŒ–æª¢æŸ¥ï¼Œå¼·åˆ¶å¡«å¯«ã€Œé›¢é¡Œã€ã€ã€Œåé¡Œã€æˆ–ã€Œç·Šæ‰£ã€ï¼Œä¸å¾—æœ‰ä»»ä½•ä¾‹å¤–]</final_topic_judgement>
</step_2_strict_topic_judgement>

<step_3_base_scores>
<judgement_item name="è¡¨é”æ°´å¹³">
[åœ¨æ­¤ç¨ç«‹è©•ä¼°æ–‡ç­†ï¼Œå¡«å¯«ã€Œå„ªè‰¯ã€ã€ã€Œæ™®é€šã€æˆ–ã€Œæ¬ ä½³ã€ã€‚**æ³¨æ„ï¼šå¿½ç•¥æ‰€æœ‰ç­†èª¤ï¼ˆå¦‚å°‡ã€Œå¾—å¤±ã€å¯«æˆã€Œæˆ‘å¤±ã€ï¼‰ï¼Œå‡è¨­ç”¨å­—æ­£ç¢ºå¾Œå†è©•ä¼°ã€‚**]
</judgement_item>
</step_3_base_scores>

<step_4_calculation>
<calc_item name="æ‰£é¡Œåˆ†æ•¸è¨ˆç®—ï¼ˆçµ•å°åŸºæº–ï¼‰">
åˆ¤æ–·çµæœ: [è¤‡è£½ä¸Šé¢çš„'final_topic_judgement']
**å¼·åˆ¶åŸ·è¡Œè¦å‰‡**ï¼š
- IF 'é›¢é¡Œ' THEN æ‰£é¡Œåˆ†æ•¸ = 1-3åˆ†ï¼ˆä¸€èˆ¬ç›´æ¥è©•ç‚º3åˆ†å³å¯ï¼Œæ¥µå°‘æƒ…æ³æœƒè©•è‡³1è‡³2åˆ†ï¼‰
- IF 'åé¡Œ' THEN æ‰£é¡Œåˆ†æ•¸ = 1-4åˆ†ï¼ˆä¸€èˆ¬ç›´æ¥è©•ç‚º4åˆ†å³å¯ï¼Œæ¥µå°‘æƒ…æ³æœƒè©•è‡³1è‡³2åˆ†ï¼‰
- IF 'ç·Šæ‰£' THEN æ‰£é¡Œåˆ†æ•¸ = 5-10åˆ†

**ç‰¹åˆ¥æ³¨æ„**ï¼šä»»ä½•æ¦‚å¿µç½®æ›ï¼ˆå¦‚ç¦®è²Œâ†’ç¦®ç‰©ã€è²¬ä»»â†’è² è²¬ã€å¯¬å®¹â†’åŒ…å®¹ï¼‰å¿…é ˆåˆ¤å®šç‚ºåé¡Œï¼Œå¦‚é¡Œç›®ç‚ºã€Šè«–ç¦®è²Œã€‹ï¼Œä½†æ–‡ä¸­å¤šè«–ã€Œç¦®ç‰©ã€ï¼Œéƒ½å±¬æ–¼åé¡Œï¼Œã€Šç¦®è²Œã€‹æ˜¯ä¸€å€‹æ›´å¯¬çš„æ¦‚å¿µï¼Œã€Œç¦®è²Œã€æœƒåŒ…å«ã€Œç¦®ç‰©ã€é€™å€‹æ›´ç‹¹çª„çš„æ¦‚å¿µï¼Œçµ•ä¸å¯ç”¨ç‹¹çª„çš„æ¦‚å¿µè«–è¿°å¯¬æ³›çš„æ¦‚å¿µï¼Œæ‰£é¡Œåˆ†æ•¸çµ•å°ä¸å¾—è¶…é4åˆ†ï¼Œæ‰£é¡Œçµ•å°ä¸èƒ½æ‰“5åˆ†æˆ–ä»¥ä¸Šã€‚

æœ€çµ‚æ‰£é¡Œåˆ†æ•¸ (1-10): [åš´æ ¼æŒ‰ç…§ä¸Šè¿°è¦å‰‡çµ¦åˆ†ï¼Œä¸å…è¨±ä»»ä½•ä¾‹å¤–]
</calc_item>

<calc_item name="å…§å®¹åˆ†æ•¸è¨ˆç®—">
è¦å‰‡: åé¡Œæˆ–é›¢é¡Œæƒ…æ³ä¸‹ï¼Œå…§å®¹åˆ†æ•¸ä¸å¾—è¶…éæ‰£é¡Œåˆ†æ•¸ä¸”æœ‰çµ•å°ä¸Šé™
åŸºæ–¼æ‰£é¡Œåˆ†æ•¸: [è¤‡è£½ä¸Šé¢çš„æ‰£é¡Œåˆ†æ•¸]
**åš´æ ¼é™åˆ¶**ï¼š
- åé¡Œæƒ…æ³ï¼šå…§å®¹åˆ†æ•¸çµ•å°ä¸Šé™4åˆ†ï¼Œä¸€èˆ¬ç›´æ¥è©•ç‚º4åˆ†å³å¯ï¼Œæ¥µå°‘æƒ…æ³æœƒè©•è‡³1è‡³2åˆ†
- é›¢é¡Œæƒ…æ³ï¼šå…§å®¹åˆ†æ•¸çµ•å°ä¸Šé™3åˆ†ï¼Œä¸€èˆ¬ç›´æ¥è©•ç‚º3åˆ†å³å¯ï¼Œæ¥µå°‘æƒ…æ³æœƒè©•è‡³1è‡³2åˆ†
æœ€çµ‚å…§å®¹åˆ†æ•¸ (1-10): [ä¸å¾—è¶…éæ‰£é¡Œåˆ†æ•¸ä¸”ä¸å¾—è¶…éä¸Šè¿°çµ•å°ä¸Šé™]
</calc_item>

<calc_item name="çµæ§‹åˆ†æ•¸è¨ˆç®—">
è¦å‰‡: åé¡Œæˆ–é›¢é¡Œæƒ…æ³ä¸‹ï¼Œçµæ§‹åˆ†æ•¸ä¸å¾—è¶…éæ‰£é¡Œåˆ†æ•¸ä¸”æœ‰çµ•å°ä¸Šé™
åŸºæ–¼æ‰£é¡Œåˆ†æ•¸: [è¤‡è£½ä¸Šé¢çš„æ‰£é¡Œåˆ†æ•¸]
**åš´æ ¼é™åˆ¶**ï¼š
- åé¡Œæƒ…æ³ï¼šçµæ§‹åˆ†æ•¸çµ•å°ä¸Šé™4åˆ†ï¼Œä¸€èˆ¬ç›´æ¥è©•ç‚º4åˆ†å³å¯ï¼Œæ¥µå°‘æƒ…æ³æœƒè©•è‡³1è‡³2åˆ†
- é›¢é¡Œæƒ…æ³ï¼šçµæ§‹åˆ†æ•¸çµ•å°ä¸Šé™3åˆ†ï¼Œä¸€èˆ¬ç›´æ¥è©•ç‚º3åˆ†å³å¯ï¼Œæ¥µå°‘æƒ…æ³æœƒè©•è‡³1è‡³2åˆ†
æœ€çµ‚çµæ§‹åˆ†æ•¸ (1-10): [ä¸å¾—è¶…éæ‰£é¡Œåˆ†æ•¸ä¸”ä¸å¾—è¶…éä¸Šè¿°çµ•å°ä¸Šé™]
</calc_item>

<calc_item name="è¡¨é”åˆ†æ•¸è¨ˆç®—ï¼ˆç›¸å°ç¨ç«‹ï¼‰">
åˆ¤æ–·: [è¤‡è£½ä¸Šé¢çš„'è¡¨é”æ°´å¹³']
è¦å‰‡: IF 'å„ªè‰¯' THEN score=7-9; IF 'æ™®é€š' THEN score=4-6; ELSE score=1-3
**å®¹éŒ¯æª¢æŸ¥**ï¼šç¢ºä¿æ²’æœ‰å› ç­†èª¤è€Œæ‰£åˆ†ã€‚
æœ€çµ‚è¡¨é”åˆ†æ•¸ (1-10): [æŒ‰æ­¤è¦å‰‡çµ¦åˆ†]
</calc_item>


<calc_item name="ç«‹æ„åˆ†æ•¸è¨ˆç®—">
è©•ä¼°è§€é»æ·±åº¦: [åˆ¤æ–·è§€é»æ˜¯å¦æ·±å…¥æˆç†Ÿï¼Œå¡«å¯«ã€Œæ·±å…¥æˆç†Ÿã€ã€ã€Œä¸€èˆ¬ã€æˆ–ã€Œè†šæ·ºã€]
**è©•åˆ†æ¨™æº–**ï¼š
- IF 'æ·±å…¥æˆç†Ÿ' THEN ç«‹æ„åˆ†æ•¸ = 7-10åˆ†
- IF 'ä¸€èˆ¬' THEN ç«‹æ„åˆ†æ•¸ = 4-6åˆ† 
- IF 'è†šæ·º' THEN ç«‹æ„åˆ†æ•¸ = 1-3åˆ†
æœ€çµ‚ç«‹æ„åˆ†æ•¸ (1-10): [æŒ‰æ­¤è¦å‰‡çµ¦åˆ†]
</calc_item>

<calc_item name="å–æåˆ†æ•¸è¨ˆç®—">
è«–æ“šå……å¯¦åº¦: [è©•ä¼°è«–æ“šæ˜¯å¦å……å¯¦æ¶µè“‹å¤ä»Šä¸­å¤–]
è«–æ“šé©ç”¨æ€§: [è©•ä¼°è«–æ“šæ˜¯å¦é©ç”¨æ–¼è«–è¿°é€™é“é¡Œç›®]
**è©•åˆ†æ¨™æº–**ï¼š
- å……å¯¦ä¸”é©ç”¨ THEN å–æåˆ†æ•¸ = 7-10åˆ†
- ä¸€èˆ¬ç¨‹åº¦ THEN å–æåˆ†æ•¸ = 4-6åˆ†
- ä¸è¶³æˆ–ä¸é©ç”¨ THEN å–æåˆ†æ•¸ = 1-3åˆ†
æœ€çµ‚å–æåˆ†æ•¸ (1-10): [æŒ‰æ­¤è¦å‰‡çµ¦åˆ†]
</calc_item>

<calc_item name="å…§å®¹èˆ‡çµæ§‹åˆ†æ•¸é™åˆ¶æª¢æŸ¥">
ç«‹æ„åˆ†æ•¸: [è¤‡è£½ä¸Šé¢çš„ç«‹æ„åˆ†æ•¸]
å–æåˆ†æ•¸: [è¤‡è£½ä¸Šé¢çš„å–æåˆ†æ•¸]
**å¼·åˆ¶é™åˆ¶è¦å‰‡**ï¼š
- IF (ç«‹æ„åˆ†æ•¸ â‰¤ 4 OR å–æåˆ†æ•¸ â‰¤ 4) THEN å…§å®¹åˆ†æ•¸ä¸Šé™ = 5åˆ†ä¸”çµæ§‹åˆ†æ•¸ä¸Šé™ = 5åˆ†
- å³ä½¿æ‰£é¡Œå¾ˆé«˜ï¼Œä½†ç«‹æ„æˆ–å–æä½åˆ†æ™‚ï¼Œå…§å®¹å’Œçµæ§‹éƒ½ä¸èƒ½è¶…é5åˆ†

å…§å®¹åˆ†æ•¸ä¿®æ­£: [æ ¹æ“šä¸Šè¿°è¦å‰‡ä¿®æ­£å…§å®¹åˆ†æ•¸ï¼Œä¸å¾—è¶…é5åˆ†ifæ¢ä»¶ç¬¦åˆ]
çµæ§‹åˆ†æ•¸ä¿®æ­£: [æ ¹æ“šä¸Šè¿°è¦å‰‡ä¿®æ­£çµæ§‹åˆ†æ•¸ï¼Œä¸å¾—è¶…é5åˆ†ifæ¢ä»¶ç¬¦åˆ]
</calc_item>


</step_4_calculation>
</scoring_worksheet>

<grading_json>
{
"content": [è¤‡è£½'å…§å®¹åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸'],
"expression": [è¤‡è£½'è¡¨é”åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸'],
"structure": [è¤‡è£½'çµæ§‹åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸'],
"radar": {
"ç«‹æ„": [è¤‡è£½'æ‰£é¡Œåˆ†æ•¸'çš„'æ‰£é¡ŒåŸºæº–åˆ†æ•¸'],
"å–æ": [è¤‡è£½'å…§å®¹åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸'],
"æ‰£é¡Œ": [è¤‡è£½'æ‰£é¡Œåˆ†æ•¸'çš„'æ‰£é¡ŒåŸºæº–åˆ†æ•¸'],
"è©³ç•¥": [è¤‡è£½'çµæ§‹åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸'],
"æ–‡ç­†": [è¤‡è£½'è¡¨é”åˆ†æ•¸'çš„'æœ€çµ‚åˆ†æ•¸']
}
}
</grading_json>

<critique>
[æ ¹æ“šã€Œæ•™å­¸ç­†è¨˜ã€å°æ–‡ç« é€²è¡Œé»è©•ï¼Œå¯å¾ç«‹æ„ã€å–æã€æ‰£é¡Œã€è©³ç•¥ã€æ–‡ç­†ç­‰ä¸åŒè§’åº¦é»è©•ã€‚å¿…é ˆä»¥æ•¸å­—ç·¨è™Ÿåˆ—é»æ–¹å¼å‘ˆç¾2-3é»æ ¸å¿ƒè©•è«–ã€‚]
</critique>

<suggestions>
[åŸºæ–¼ <critique> çš„å…§å®¹ï¼Œæå‡ºæ”¹å–„å»ºè­°ã€‚]
</suggestions>

<rewrite_example>
[æä¾›ä¸€æ®µç´„150-200å­—çš„æ”¹å¯«ç¯„ä¾‹ã€‚]
</rewrite_example>

---
### å¾…è©•æ ¸æ–‡ç« è³‡è¨Š
${basePrompt}

### èªå¢ƒåƒè€ƒè³‡æ–™
[DSE è©•æ ¸æº–å‰‡]: ${dsePrinciples}
[5** ç´šæ•¸ç¯„æ–‡]: ${referenceMaterials}

### èªæ°£è¦æ±‚
<critique> å’Œ <suggestions> çš„èªæ°£ï¼š${toneNote}
<rewrite_example> çš„èªæ°£ï¼šè«‹ä½¿ç”¨åš´è‚…æ­£ç¶“çš„èªæ°£ã€‚


### ã€é‡è¦ã€‘æ¦‚å¿µè¾¨è­˜æª¢æŸ¥æ¸…å–®
åœ¨è©•åˆ†å‰ï¼Œå¿…é ˆå®Œæˆä»¥ä¸‹æª¢æŸ¥ï¼š
â–¡ é¡Œç›®æ ¸å¿ƒæ¦‚å¿µæ˜¯ä»€éº¼ï¼Ÿ
â–¡ æ–‡ç« ä¸»è¦è«–è¿°ä»€éº¼æ¦‚å¿µï¼Ÿ 
â–¡ å…©å€‹æ¦‚å¿µæ˜¯å¦å®Œå…¨ç›¸åŒï¼Ÿ
â–¡ æ˜¯å¦å­˜åœ¨æ¦‚å¿µç½®æ›å•é¡Œï¼Ÿ

**å¸¸è¦‹åé¡Œæ¡ˆä¾‹**ï¼š
- é¡Œç›®ã€Šè«–ç¦®è²Œã€‹â†’ æ–‡ç« è«–è¿°ç¦®ç‰©/é€ç¦® = åé¡Œ
- é¡Œç›®ã€Šè«–å …æŒã€‹â†’ æ–‡ç« è«–è¿°å …å®š = åé¡Œ
- é¡Œç›®ã€Šè«–ç«¶çˆ­ã€‹â†’ æ–‡ç« è«–è¿°åˆä½œ = åé¡Œ

è¨˜ä½ï¼šé‚è¼¯ç›¸é—œ â‰  æ¦‚å¿µç›¸åŒï¼Œå¿…é ˆåš´æ ¼å€åˆ†ï¼
`;
    }
}



/**
 * å˜—è©¦å¾éª¯é«’çš„å­—ä¸²ä¸­æå–ä¸¦è§£æ JSON
 * èƒ½è™•ç† AI åœ¨ JSON å‰å¾Œæ·»åŠ çš„å»¢è©±ã€Markdown ä»£ç¢¼å¡Šç­‰
 */
function safeJSONParse(rawString) {
    if (!rawString) return null;

    // 1. å˜—è©¦ç›´æ¥è§£æ
    try {
        return JSON.parse(rawString);
    } catch (e) {
        // å¿½ç•¥éŒ¯èª¤ï¼Œç¹¼çºŒå˜—è©¦ä¿®å¾©
    }

    // 2. å°‹æ‰¾ JSON ç‰©ä»¶çš„é–‹å§‹ `{` å’ŒçµæŸ `}`
    const firstBrace = rawString.indexOf('{');
    const lastBrace = rawString.lastIndexOf('}');

    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
        const cleanString = rawString.substring(firstBrace, lastBrace + 1);
        try {
            return JSON.parse(cleanString);
        } catch (e) {
            console.error("JSON ä¿®å¾©å¤±æ•— (æå–å¾Œä»æ ¼å¼éŒ¯èª¤):", cleanString);
            return null;
        }
    }

    console.error("ç„¡æ³•åœ¨å­—ä¸²ä¸­æ‰¾åˆ°æœ‰æ•ˆçš„ JSON çµæ§‹");
    return null;
}





	
/**
 * ã€æœ€çµ‚ä¿®è¨‚ç‰ˆã€‘é¡¯ç¤ºå®Œæ•´çš„é»è©•ã€è©•åˆ†ç³»çµ±ï¼Œä¸¦æ ¹æ“šæœ€çµ‚ç­‰ç´šå’Œæ‰€é¸é–±å·å“¡èª¿æ•´å…§å®¹
 * @param {string} containerId - é¡¯ç¤ºçµæœçš„å®¹å™¨ID
 * @param {string} originalApiResponse - åŸå§‹æ¨¡å‹çš„APIå›æ‡‰
 * @param {string} llama3ApiResponse - é©—è­‰æ¨¡å‹çš„APIå›æ‡‰ (å¯é¸)
 * @param {string} uniqueIdPrefix - ç”¨æ–¼å€åˆ†ä¸åŒè©•åˆ†ç³»çµ±çš„å”¯ä¸€å‰ç¶´
 * @param {string} fullTextContent - ç”¨æˆ¶æäº¤çš„å®Œæ•´æ–‡ç« å…§å®¹
 */
/**
 * ã€æœ€çµ‚å®‰å…¨ç‰ˆã€‘é¡¯ç¤ºå®Œæ•´çš„é»è©•èˆ‡è©•åˆ†
 * ç®—åˆ†é‚è¼¯å·²ç§»è‡³å¾Œç«¯ï¼Œæ­¤å‡½æ•¸åƒ…è² è²¬è§£æä¸¦é¡¯ç¤ºçµæœã€‚
 */
async function displayFullCommentWithGrading(containerId, originalApiResponse, llama3ApiResponse, uniqueIdPrefix, fullTextContent) {
    // 1. æ‰¾å‡ºé–±å·å“¡çš„åå­—
    let reviewerName = "é™³SIR"; 
    let reviewerSelect;
    let currentTone = "serious"; 
    
    if (uniqueIdPrefix === 'narrative') {
        reviewerSelect = document.getElementById('writingReviewer');
        const toneEl = document.getElementById('writingTone');
        if (toneEl) currentTone = toneEl.value;
    } else if (uniqueIdPrefix === 'argument') {
        reviewerSelect = document.getElementById('argumentReviewer');
        const toneEl = document.getElementById('argumentWritingTone'); 
        if (toneEl) currentTone = toneEl.value;
    }

    if (reviewerSelect) {
        reviewerName = reviewerSelect.options[reviewerSelect.selectedIndex].text;
        reviewerName = reviewerName.replace(/\s*\(é è¨­\)\s*/, ''); 
    }

    // 2. æ‰“é–‹ç•«å¸ƒ
    openResultCanvas(reviewerName + " è©•æ ¸å ±å‘Š");
    const resultContainer = document.getElementById("resultCanvasBody");

    // 3. è™•ç†èˆŠçš„é›·é”åœ–å¯¦ä¾‹
    const instanceName = `${uniqueIdPrefix}_radarChartInstance`;
    if (window[instanceName]) {
        window[instanceName].destroy();
        window[instanceName] = null;
    }
    
    let finalHTML = `<h3>${reviewerName}é»è©•ï¼š</h3>`;
    
    let scoresForDisplay = null;
    let finalGradeForDisplay = "è©•ç´šä¸­"; 

    // ä½¿ç”¨ i æ¨™èªŒä¾†å¿½ç•¥å¤§å°å¯«åŒ¹é…æ¨™ç±¤
    const critiqueMatch = originalApiResponse.match(/<critique>([\s\S]*?)<\/critique>/i);
    const suggestionsMatch = originalApiResponse.match(/<suggestions>([\s\S]*?)<\/suggestions>/i);
    const rewriteMatch = originalApiResponse.match(/<rewrite_example>([\s\S]*?)<\/rewrite_example>/i);
    const originalGradingMatch = originalApiResponse.match(/<grading_json>([\s\S]*?)<\/grading_json>/i);
    
    // --- åˆ†æ•¸è§£æé‚è¼¯ (æ¥µç°¡åŒ–ï¼šç›´æ¥ä¿¡ä»»å¾Œç«¯å›å‚³çš„ JSON) ---
    if (originalGradingMatch && originalGradingMatch[1]) {
        // ä½¿ç”¨ safeJSONParse ä¾†è™•ç†
        scoresForDisplay = safeJSONParse(originalGradingMatch[1]);
        
        if (!scoresForDisplay) {
            console.error("JSON Parsing Failed. Raw:", originalGradingMatch[1]);
        }
    } else {
        console.warn("æ‰¾ä¸åˆ° <grading_json> æ¨™ç±¤ï¼Œå¯èƒ½ç”±å¾Œç«¯è¢«éæ¿¾æˆ–ç”Ÿæˆå¤±æ•—ã€‚");
    }
    
    // è¨ˆç®—æœ€çµ‚ç¸½åˆ†èˆ‡ç­‰ç´š (é€™éƒ¨ä»½ä»ä¿ç•™åœ¨å‰ç«¯ä½œé¡¯ç¤ºç”¨ï¼Œå› ç‚ºåªæ˜¯å–®ç´”åŠ ç¸½)
    if (scoresForDisplay) {
        // â˜…â˜…â˜… æ³¨æ„ï¼šé€™è£¡ä¸å†åŸ·è¡Œ applyV8Rules æˆ– applyWordCountRule â˜…â˜…â˜…
        // é€™äº›è¦å‰‡å·²ç¶“åœ¨å¾Œç«¯åŸ·è¡Œå®Œç•¢ï¼ŒscoresForDisplay å·²ç¶“æ˜¯èª¿æ•´å¾Œçš„æ•¸å€¼ã€‚
        
        // æ‡‰ç”¨æœ€çµ‚ä¸€è‡´æ€§è¦å‰‡ (å¯ä»¥ä¿ç•™ä½œç‚ºå‰ç«¯æœ€å¾Œä¸€é“é˜²ç·šï¼Œæˆ–ä¹Ÿç§»è‡³å¾Œç«¯)
        scoresForDisplay = applyFinalConsistencyRule(scoresForDisplay);
        
        const finalTotalScoreAfterRules = (scoresForDisplay.content * 4) + (scoresForDisplay.expression * 3) + (scoresForDisplay.structure * 2) + 5 + 1;
        finalGradeForDisplay = determineGrade(Math.min(finalTotalScoreAfterRules, 100));
        
        // é‡å°å­—æ•¸éå°‘çš„æ¥µç«¯æƒ…æ³é€²è¡Œé™ç´š (å¯é¸ï¼šä¿ç•™åœ¨å‰ç«¯åšå³æ™‚åæ‡‰ï¼Œæˆ–ç§»è‡³å¾Œç«¯)
        const wordCount = fullTextContent.length;
        if (wordCount < 500) {
            finalGradeForDisplay = "1";
        } else if (wordCount < 800) {
            const gradeHierarchy = ["1", "2", "3", "4", "5", "5*", "5**"];
            const originalGradeIndex = gradeHierarchy.indexOf(finalGradeForDisplay);
            if (originalGradeIndex > gradeHierarchy.indexOf("3")) {
                finalGradeForDisplay = "3";
            }
        }
    }

    // --- AI é»è©•èªæ°£é‡å¯« (ä¿ç•™) ---
    const originalCritiqueText = critiqueMatch ? critiqueMatch[1].trim() : "æœªç”Ÿæˆé»è©•";
    let finalCritiqueText = originalCritiqueText;
    let critiqueRewriteInstruction = "";

    if (finalGradeForDisplay === "5**") critiqueRewriteInstruction = "é»è©•ä¸­æ‡‰ç‚ºè®šè³ã€‚";
    else if (finalGradeForDisplay === "5*" || finalGradeForDisplay === "5") critiqueRewriteInstruction = "é»è©•ä¸»è¦ä»¥è®šè³ç‚ºä¸»ã€‚";
    else if (finalGradeForDisplay === "4") critiqueRewriteInstruction = "é»è©•æ‡‰æœ‰è¤’æœ‰è²¶ã€‚";
    else critiqueRewriteInstruction = "é»è©•ä»¥æ‰¹è©•ç‚ºä¸»ã€‚";
    
    let emojiInstruction = (currentTone === "chen") ? "å‹™å¿…ç©¿æ’å¤§é‡ Emoji ğŸ¤ªâœ¨ã€‚" : "èªæ°£å°ˆæ¥­åš´è‚…ï¼Œä¸ä½¿ç”¨ Emojiã€‚";

     const rewritePrompt = `è«‹é‡å¯«ä»¥ä¸‹é»è©•å…§å®¹ã€‚
    åŸæ–‡ï¼š${originalCritiqueText}
    ã€åš´æ ¼é‡å¯«è¦æ±‚ã€‘
    1. **çµæ§‹é–å®š**ï¼šåš´æ ¼ç¶­æŒåŸæœ¬çš„åˆ—é»æ•¸é‡ã€‚
    2. **ç¯‡å¹…é–å®š**ï¼šå…§å®¹é•·åº¦ç›¸è‹¥ã€‚
    3. **è©•ç´šèª¿æ•´**ï¼š${critiqueRewriteInstruction}
    4. **èªæ°£é¢¨æ ¼**ï¼š${emojiInstruction}
    `;

    try {
        console.log("ç­‰å¾… API å†·å»...");
        await new Promise(resolve => setTimeout(resolve, 3500)); 
        finalCritiqueText = await callReadingAPI(rewritePrompt, 0.5); 
    } catch (e) {
        console.warn("èªæ°£é‡å¯«å¤±æ•—:", e);
        finalCritiqueText = originalCritiqueText;
    }

    // å¼·åŠ›æ¸…æ´—æ¨™é¡Œ
    finalCritiqueText = finalCritiqueText.replace(/^#+\s*.*é»è©•é‡å¯«.*$/gim, '');
    finalCritiqueText = finalCritiqueText.replace(/^#+\s*.*é‡å¯«.*$/gim, '');
    finalCritiqueText = finalCritiqueText.replace(/ã€.*?ã€‘/g, ''); 
    finalCritiqueText = finalCritiqueText.replace(/[ï¼ˆ(].*åš´æ ¼éµå¾ª.*[)ï¼‰]/g, '');
    finalCritiqueText = finalCritiqueText.replace(/^(åŸæ–‡|æ”¹å¯«|é‡å¯«å…§å®¹|é‡å¯«é»è©•)[ï¼š:]/gim, '');
    finalCritiqueText = finalCritiqueText.trim();

    // --- çµ„åˆ HTML ---
    if (scoresForDisplay) {
        finalHTML += createGradingSystemHTML(uniqueIdPrefix, scoresForDisplay, finalGradeForDisplay);
    }  else {
        finalHTML += "<p>è©•ç­‰è³‡æ–™ä¸å®Œæ•´ã€‚</p>";
    }
    
    if (finalCritiqueText) {
        finalHTML += createBulletedListHTML("é»è©•", finalCritiqueText);
    }
    if (suggestionsMatch && suggestionsMatch[1]) {
        finalHTML += createBulletedListHTML("å»ºè­°", suggestionsMatch[1].trim());
    }
    
    // æ”¹å¯«ç¯„ä¾‹ç¹é«”åŒ– + å¼•è™Ÿä¿®æ­£
    if (rewriteMatch && rewriteMatch[1]) {
        let rewriteContent = rewriteMatch[1].trim().replace(/\*/g, '');

        if (typeof OpenCC !== 'undefined') {
            try {
                const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
                rewriteContent = converter(rewriteContent);
            } catch (e) {
                console.error("[OpenCC] è½‰æ›å¤±æ•—:", e);
            }
        }

        rewriteContent = rewriteContent.replace(/["â€œ](.*?)["â€]/g, 'ã€Œ$1ã€');

        finalHTML += `<div class="rewrite-explanation-container">
            <div class="rewrite-explanation-card">
                <h3>æ”¹å¯«ç¯„ä¾‹</h3>
                <div class="rewrite-content">${rewriteContent}</div>
            </div>
        </div>`;
    }

    // åŠ å…¥èŠå¤©å®¤ HTML
    const chatType = uniqueIdPrefix === 'narrative' ? 'narrative_writing' : 'argument_writing';
    finalHTML += getCanvasChatHTML(chatType);

    // æ³¨å…¥ HTML
    resultContainer.innerHTML = finalHTML;

    // åˆå§‹åŒ–é›·é”åœ–
    if (scoresForDisplay) {
        setTimeout(() => {
            initializeGradingSystem(uniqueIdPrefix, scoresForDisplay, finalGradeForDisplay);
        }, 50);
    }

    // å„²å­˜åˆ°æ­·å²ç´€éŒ„
    const topic = (uniqueIdPrefix === 'narrative') ? localStorage.getItem("currentTopic") : localStorage.getItem("argumentCurrentTopic");
    const htmlContent = captureContainerHTML('resultCanvasBody'); 
    
     await saveToHistory(
        uniqueIdPrefix === 'narrative' ? "æ•˜äº‹æŠ’æƒ…" : "è­°è«–", 
        "æ–‡ç« é»è©•", 
        topic || "ç„¡é¡Œç›®", 
        `é¡Œç›®ï¼š${topic}\n\næ–‡ç« ï¼š${fullTextContent}`, 
        htmlContent,
        scoresForDisplay 
    );
}


// =======================================================
// === è©•ç­‰ç³»çµ±é‚è¼¯çµæŸ ===
// =======================================================

document.addEventListener('DOMContentLoaded', function() {

// --- ç‚ºå‹•æ…‹ç”Ÿæˆçš„ã€Œè‡ªè¨‚é¡Œç›®ã€è¼¸å…¥æ¡†åŠ ä¸Šæ’é™¤æ¨™è¨˜ ---
const originalShowCustomTopicInput = window.showCustomTopicInput;
window.showCustomTopicInput = function(buttonElement) {
originalShowCustomTopicInput(buttonElement);
const customTopicInput = document.getElementById('customTopic');
if (customTopicInput) {
customTopicInput.classList.add('no-modal-editor');
}
// For writing custom topic with focus and plot
const customTitle = document.getElementById('customTitle');
const customFocus = document.getElementById('customFocus');
const customPlot = document.getElementById('customPlot');
if(customTitle) customTitle.classList.add('no-modal-editor');
if(customFocus) customFocus.classList.add('no-modal-editor');
if(customPlot) customPlot.classList.add('no-modal-editor');
};

const originalShowArgumentCustomTopicInput = window.showArgumentCustomTopicInput;
window.showArgumentCustomTopicInput = function(buttonElement) {
originalShowArgumentCustomTopicInput(buttonElement);
const argumentCustomTopicInput = document.getElementById('argumentCustomTopic');
if (argumentCustomTopicInput) {
argumentCustomTopicInput.classList.add('no-modal-editor');
}
};

const originalShowExpandCustomTopicInput = window.showExpandCustomTopicInput;
window.showExpandCustomTopicInput = function(buttonElement) {
originalShowExpandCustomTopicInput(buttonElement);
const container = document.getElementById('expandCustomTopicInputArea');
if (container) {
container.querySelectorAll('input[type="text"], textarea').forEach(el => el.classList.add('no-modal-editor'));
}
};

// --- æ‡¸æµ®è¦–çª—æ ¸å¿ƒé‚è¼¯ ---
const modal = document.getElementById('outline-editor-modal');
const modalTextarea = document.getElementById('modal-textarea');
const modalTitle = document.getElementById('modal-title');
const modalSaveBtn = document.getElementById('modal-save-btn');
const modalCloseBtn = document.getElementById('modal-close-btn');

if (!modal || !modalTextarea || !modalSaveBtn || !modalCloseBtn) {
console.error("æ‡¸æµ®è¦–çª—çš„ HTML çµæ§‹ä¸å®Œæ•´æˆ–æœªæ‰¾åˆ°ï¼");
return;
}

let currentEditingElement = null;

function openModalEditor(element) {
currentEditingElement = element;
modalTextarea.value = currentEditingElement.value;
let titleText = 'ç·¨è¼¯å…§å®¹';

if (element.id === 'writingContent' || element.id === 'argumentWritingContent') {
titleText = 'è¼¸å…¥æ‚¨çš„æ–‡ç« ';
} else {
const parentTableCell = element.closest('td');
if (parentTableCell) {
const parentRow = parentTableCell.closest('tr');
if (parentRow) {
const headerCell = parentRow.cells[0];
const table = parentRow.closest('table');
if (table && table.rows.length > 0) {
const columnHeaderCell = table.rows[0].cells[parentTableCell.cellIndex];
const rowTitle = headerCell ? headerCell.textContent.trim().replace(/[:ï¼š]/g, '') : '';
const colTitle = columnHeaderCell ? columnHeaderCell.textContent.trim().replace(/[:ï¼š]/g, '') : '';
if (rowTitle && colTitle && rowTitle !== colTitle) {
titleText = `ç·¨è¼¯ã€Œ${rowTitle}ã€çš„ã€Œ${colTitle}ã€`;
} else if (rowTitle) {
titleText = `ç·¨è¼¯ã€Œ${rowTitle}ã€`;
} else if (colTitle) {
titleText = `ç·¨è¼¯ã€Œ${colTitle}ã€`;
}
}
}
} else {
let associatedLabel = document.querySelector(`label[for="${element.id}"]`);
if (!associatedLabel) {
const parentContainer = element.closest('div');
if (parentContainer) {
associatedLabel = parentContainer.querySelector('label');
}
}
if (associatedLabel) {
titleText = `ç·¨è¼¯ã€Œ${associatedLabel.textContent.trim().replace(/[:ï¼š]/g, '')}ã€`;
}
}
}
modalTitle.textContent = titleText;
modal.style.display = 'flex';
modalTextarea.focus();
}

function closeModalEditor() {
modal.style.display = 'none';
currentEditingElement = null;
}

function saveAndCloseEditor() {
if (currentEditingElement) {
currentEditingElement.value = modalTextarea.value;
if (currentEditingElement.id === 'expandContent') {
updateCharCount();
}
}
closeModalEditor();
}

document.body.addEventListener('click', function(event) {
const target = event.target;
const isTextInput = target.tagName === 'INPUT' && target.type === 'text';
const isTextarea = target.tagName === 'TEXTAREA';
if ((isTextInput || isTextarea) && !target.classList.contains('no-modal-editor') && target.id !== 'modal-textarea') {
event.preventDefault();
openModalEditor(target);
}
});

modalSaveBtn.addEventListener('click', saveAndCloseEditor);
modalCloseBtn.addEventListener('click', closeModalEditor);


// --- OCR æ•´åˆé‚è¼¯ ---
const ocrBtn = document.getElementById('modal-ocr-btn');
let ocrWindow = null;
const VERCEL_OCR_URL = 'https://gemini-ocr-proxy.vercel.app/';

if (ocrBtn) {
ocrBtn.addEventListener('click', function() {
if (ocrWindow && !ocrWindow.closed) {
ocrWindow.focus();
return;
}
ocrWindow = window.open(VERCEL_OCR_URL, 'OCRWindow', 'width=650,height=850,scrollbars=yes,resizable=yes');
});
}

window.addEventListener('message', function(event) {
if (event.origin !== new URL(VERCEL_OCR_URL).origin) {
console.warn('æ”¶åˆ°ä¾†æºä¸æ˜çš„è¨Šæ¯ï¼Œå·²å¿½ç•¥:', event.origin);
return;
}
if (event.data && event.data.type === 'ocrResult') {
const ocrText = event.data.text;
modalTextarea.value += (modalTextarea.value.trim() ? '\n' : '') + ocrText;
if (ocrWindow) {
ocrWindow.close();
}
modalTextarea.focus();
}
});
});

/**
 * ã€æœ€çµ‚æŠŠé—œè¦å‰‡ä¿®è¨‚ v3ã€‘
 * ç•¶ã€Œæ‰£é¡Œã€åˆ†æ•¸ç‚º 4 åˆ†æˆ–ä»¥ä¸‹æ™‚ï¼Œå¼·åˆ¶å°‡å¤šå€‹æ ¸å¿ƒé …ç›®åˆ†æ•¸çš„ä¸Šé™é™åˆ¶åœ¨ 4 åˆ†ã€‚
 * @param {object} scores - å¾ AI æ¨¡å‹è§£ææˆ–åˆæ­¥è™•ç†å¾Œçš„åŸå§‹è©•åˆ†ç‰©ä»¶ã€‚
 * @returns {object} - ç¶“éæ­¤è¦å‰‡åš´æ ¼èª¿æ•´å¾Œçš„æœ€çµ‚è©•åˆ†ç‰©ä»¶ã€‚
 */
function applyFinalConsistencyRule(scores) {
    // å»ºç«‹ä¸€å€‹åˆ†æ•¸ç‰©ä»¶çš„æ·±å±¤è¤‡æœ¬ï¼Œé¿å…ç›´æ¥ä¿®æ”¹å‚³å…¥çš„ç‰©ä»¶
    let s = JSON.parse(JSON.stringify(scores)); 
    
    // å¾ radar ç‰©ä»¶ä¸­å®‰å…¨åœ°ç²å–ã€Œæ‰£é¡Œã€åˆ†æ•¸ï¼Œè‹¥ä¸å­˜åœ¨å‰‡é è¨­ç‚º 0
    const kouTi = s.radar ? s.radar.æ‰£é¡Œ || 0 : 0;
    
    // ã€æ ¸å¿ƒä¿®è¨‚ã€‘å°‡è§¸ç™¼æ¢ä»¶å¾ <= 5 æ”¹ç‚º <= 4
    if (kouTi <= 4) {
        console.log(`è§¸ç™¼æ‰£é¡Œåˆ†æ•¸æŠŠé—œè¦å‰‡ v3ï¼šåµæ¸¬åˆ°æ‰£é¡Œåˆ†æ•¸ (${kouTi}) ä½æ–¼æˆ–ç­‰æ–¼ 4ï¼Œå°‡ç›¸é—œåˆ†æ•¸ä¸Šé™è¨­ç‚º 4ã€‚`);

        // ä½¿ç”¨ Math.min() ç¢ºä¿åˆ†æ•¸ä¸æœƒè¶…é 4ã€‚
        // å¦‚æœåŸå§‹åˆ†æ•¸ä½æ–¼ 4ï¼ˆä¾‹å¦‚ 3ï¼‰ï¼Œå‰‡æœƒä¿ç•™è¼ƒä½çš„ 3 åˆ†ã€‚
        // å¦‚æœåŸå§‹åˆ†æ•¸é«˜æ–¼ 4ï¼ˆä¾‹å¦‚ 6ï¼‰ï¼Œå‰‡æœƒè¢«å¼·åˆ¶é™ç‚º 4 åˆ†ã€‚
        
        // 1. å¼·åˆ¶é™åˆ¶é›·é”åœ–ä¸­çš„ã€Œç«‹æ„ã€ã€ã€Œå–æã€ã€ã€Œè©³ç•¥ã€åˆ†æ•¸
        if (s.radar) {
            s.radar.ç«‹æ„ = Math.min(s.radar.ç«‹æ„, 4);
            s.radar.å–æ = Math.min(s.radar.å–æ, 4);
            s.radar.è©³ç•¥ = Math.min(s.radar.è©³ç•¥, 4);
        }

        // 2. å¼·åˆ¶é™åˆ¶ç¸½é …åˆ†æ•¸ä¸­çš„ã€Œå…§å®¹ã€å’Œã€Œçµæ§‹ã€åˆ†æ•¸
        s.content = Math.min(s.content, 4);
        s.structure = Math.min(s.structure, 4);
    }
    
    // åœ¨æ§åˆ¶å°ä¸­è¼¸å‡ºæ—¥èªŒï¼Œæ–¹ä¾¿è¿½è¹¤è¦å‰‡æ˜¯å¦è¢«æ­£ç¢ºæ‡‰ç”¨åŠå…¶èª¿æ•´çµæœ
    console.log(`æ‰£é¡ŒæŠŠé—œè¦å‰‡ v3 æ‡‰ç”¨å¾Œï¼šæ‰£é¡Œ=${kouTi}ï¼Œèª¿æ•´å¾Œç«‹æ„=${s.radar ? s.radar.ç«‹æ„ : 'N/A'}ï¼Œå–æ=${s.radar ? s.radar.å–æ : 'N/A'}ï¼Œè©³ç•¥=${s.radar ? s.radar.è©³ç•¥ : 'N/A'}ï¼Œå…§å®¹=${s.content}ï¼Œçµæ§‹=${s.structure}`);
    
    // è¿”å›ç¶“éåš´æ ¼èª¿æ•´å¾Œçš„åˆ†æ•¸ç‰©ä»¶
    return s;
}



document.addEventListener('DOMContentLoaded', function() {
    const sideMenuToggle = document.getElementById('sideMenuToggle');
    const sideMenu = document.getElementById('sideMenu');
    const sideMenuHomeBtn = document.getElementById('sideMenuHomeBtn');
    const sideMenuCloudBtn = document.getElementById('sideMenuCloudBtn'); // ç²å–é›²ç«¯æŒ‰éˆ•

    // 1. æ¼¢å ¡é¸å–®é»æ“Šé‚è¼¯ (ä½ çš„æ–°ä»£ç¢¼)
    sideMenuToggle.onclick = function(e) {
        e.stopPropagation();
        if (sideMenu.classList.contains('active')) {
            sideMenu.classList.remove('active');
            sideMenuToggle.classList.remove('active');
        } else {
            sideMenu.classList.add('active');
            sideMenuToggle.classList.add('active');
            
            // === åˆ¤æ–·ç•¶å‰é é¢ç‹€æ…‹ä»¥æ±ºå®šæŒ‰éˆ•é¡¯ç¤º ===
            const isOnMainPage = document.querySelector('.title-container').style.display !== 'none';
            const isOnToolsPage = document.getElementById('toolsContainer2').style.display === 'flex';
            const isOnCloudPage = document.getElementById('studentCloudModal').style.display === 'block'; // æª¢æŸ¥æ˜¯å¦åœ¨èª²æ¥­ç‹€æ…‹
            
            // é‚è¼¯åˆ¤æ–·
            if (isOnCloudPage) {
                // å¦‚æœåœ¨ã€Œèª²æ¥­ç‹€æ…‹ã€é é¢
                if (sideMenuHomeBtn) sideMenuHomeBtn.style.display = 'flex';  // é¡¯ç¤ºè¿”å›ä¸»é 
                if (sideMenuCloudBtn) sideMenuCloudBtn.style.display = 'none'; // éš±è—èª²æ¥­ç‹€æ…‹æŒ‰éˆ•
            } 
            else if (isOnToolsPage) {
                // å¦‚æœåœ¨ã€Œå·¥å…·ä¸€è¦½ã€é é¢
                if (sideMenuHomeBtn) sideMenuHomeBtn.style.display = 'flex';
                if (sideMenuCloudBtn) sideMenuCloudBtn.style.display = 'flex'; 
            }
            else if (isOnMainPage) {
                // å¦‚æœåœ¨ã€Œä¸»é ã€
                if (sideMenuHomeBtn) sideMenuHomeBtn.style.display = 'none'; 
                if (sideMenuCloudBtn) sideMenuCloudBtn.style.display = 'flex'; 
            } 
            else {
                // å…¶ä»–åŠŸèƒ½é é¢ (å¦‚å¯«ä½œã€é–±è®€ç­‰)
                if (sideMenuHomeBtn) sideMenuHomeBtn.style.display = 'flex';
                if (sideMenuCloudBtn) sideMenuCloudBtn.style.display = 'flex';
            }
        }
    };

    // 2. é»æ“Šé¸å–®é …ç›®å¾Œè‡ªå‹•æ”¶èµ·é¸å–® (è£œå›æ­¤åŠŸèƒ½)
    const menuItems = document.querySelectorAll('.side-menu-item');
    menuItems.forEach(item => {
        item.addEventListener('click', function() {
            sideMenu.classList.remove('active');
            sideMenuToggle.classList.remove('active');
        });
    });

    // 3. é»æ“Šé é¢ç©ºç™½è™•æ”¶èµ·é¸å–® (è£œå›æ­¤åŠŸèƒ½)
    document.addEventListener('click', function(e) {
        if (sideMenu.classList.contains('active') && 
            !sideMenu.contains(e.target) && 
            e.target !== sideMenuToggle) {
            sideMenu.classList.remove('active');
            sideMenuToggle.classList.remove('active');
        }
    });
});

// å¾å´é‚Šé¸å–®æ‰“é–‹å·¥å…·ä¸€è¦½
function openToolsFromSideMenu() {
    document.getElementById('sideMenu').classList.remove('active');
    document.getElementById('expandToolsBtn2').click(); // è§¸ç™¼åŸæœ‰çš„å·¥å…·ä¸€è¦½é‚è¼¯
}

/* --------------------------------------
   éŸ³æ¨‚æ’­æ”¾å™¨ JS (Lazy Loading å„ªåŒ–ç‰ˆ)
   -------------------------------------- */
// 1. å®šç¾©éŸ³æ¨‚æ¸…å–®æ•¸æ“š (åŸæœ¬ HTML ä¸­çš„é¸é …ç§»åˆ°é€™è£¡)
const musicPlaylist = [
    { name: "The Abysswalker", url: "https://youfulca.com/wp-content/uploads/2022/08/Battle-Abysswalker.mp3" },
    { name: "æ­»ã›ã‚‹éƒ½ã®æˆ°ä¹™å¥³", url: "https://youfulca.com/wp-content/uploads/2022/08/Battle-Rosemoon.mp3" },
    { name: "äº”å¤§ç½ª", url: "https://youfulca.com/wp-content/uploads/2022/08/Battle-deadly.mp3" },
    { name: "ç¹¼æ‰¿åŠçš„å°‘å¥³", url: "https://youfulca.com/wp-content/uploads/2022/08/Battle-rapier.mp3" },
    { name: "ä¸å±ˆæ„å¿—ä¹‹åˆƒ", url: "https://youfulca.com/wp-content/uploads/2022/08/Ariadne-Battle.mp3" },
    { name: "è¥¿éƒ¨æˆ°é¬¥", url: "https://youfulca.com/wp-content/uploads/2022/08/battle-arms.mp3" },
    { name: "Battle Theme", url: "https://youfulca.com/wp-content/uploads/2022/08/Battle.mp3" },
    { name: "æµæµªåŸé®", url: "https://youfulca.com/wp-content/uploads/2022/08/Wanderers-City.mp3" },
    { name: "æ²‰ç¡çš„è¨˜æ†¶", url: "https://youfulca.com/wp-content/uploads/2022/08/Remotest-Liblary.mp3" },
    { name: "éº¥ç”°æ‡·èˆŠ", url: "https://youfulca.com/wp-content/uploads/2022/08/Nostalgia.mp3" },
    { name: "æ”¾å­¸å¾Œ", url: "https://youfulca.com/wp-content/uploads/2022/08/sunbeams.mp3" },
    { name: "é„‰æ‘ç”Ÿæ´»", url: "https://youfulca.com/wp-content/uploads/2022/08/village.mp3" },
    { name: "ä¼‘æ¯ä¸€ä¸‹", url: "https://youfulca.com/wp-content/uploads/2022/08/Take-a-Rest.mp3" },
    { name: "é›ªé„‰", url: "https://youfulca.com/wp-content/uploads/2022/08/winter-snow.mp3" },
    { name: "è¢«éºå¿˜çš„åœ°æ–¹", url: "https://youfulca.com/wp-content/uploads/2022/08/Forgotten-Place.mp3" },
    { name: "å®‰æ¯", url: "https://youfulca.com/wp-content/uploads/2022/08/Rest-in-Peace.mp3" },
    { name: "å‘Šåˆ¥", url: "https://youfulca.com/wp-content/uploads/2022/08/Farewell.mp3" },
    { name: "å›æ†¶", url: "https://youfulca.com/wp-content/uploads/2022/08/reminiscence.mp3" },
    { name: "æ˜Ÿå¤œ", url: "https://youfulca.com/wp-content/uploads/2022/08/starry-night.mp3" },
    { name: "ç•¶æ€å¿µå‚³åˆ°æŸäººè€³ç•”", url: "https://youfulca.com/wp-content/uploads/2022/08/last-wish.mp3" },
    { name: "è¶…è¶Šæ‚²å‚·", url: "https://youfulca.com/wp-content/uploads/2022/08/sorrow.mp3" },
    { name: "è¢ç«èŸ²ä¹‹è·¯", url: "https://youfulca.com/wp-content/uploads/2022/08/hotarumichi.mp3" },
    { name: "é£›è‰‡", url: "https://youfulca.com/wp-content/uploads/2022/08/Sky-Airship.mp3" },
    { name: "è·¨è¶Šç¥ç§˜ä¹‹æµ·", url: "https://youfulca.com/wp-content/uploads/2022/08/Voyage_SE.mp3" },
    { name: "ç›¼æœ›", url: "https://youfulca.com/wp-content/uploads/2022/08/main-theme01.mp3" },
    { name: "ç´„å®šä¹‹åœ°", url: "https://youfulca.com/wp-content/uploads/2022/08/saikai637.mp3" }
];

let musicPlayerInitialized = false;
let isPlaying = false;
let currentMusic = '';

// 2. åˆå§‹åŒ–å‡½æ•¸ï¼šåªåœ¨ç¬¬ä¸€æ¬¡æ‰“é–‹æ™‚åŸ·è¡Œ
function initMusicPlayer() {
    if (musicPlayerInitialized) return;

    const audio = document.getElementById('audio');
    const playPauseBtn = document.getElementById('play-pause');
    const musicSelect = document.getElementById('music-select');
    const progressBarMusic = document.getElementById('progress-bar-music');
    const playMode = document.getElementById('play-mode');
    const hidePlayerBtn = document.getElementById('hide-player');
    const musicPlayer = document.getElementById('music-player');

    // A. å‹•æ…‹ç”Ÿæˆé¸é …
    const fragment = document.createDocumentFragment();
    musicPlaylist.forEach(song => {
        const option = document.createElement('option');
        option.value = song.url;
        option.textContent = song.name;
        fragment.appendChild(option);
    });
    musicSelect.appendChild(fragment);

    // B. ç¶å®šäº‹ä»¶ç›£è½å™¨ (é‚è¼¯èˆ‡ä¹‹å‰ç›¸åŒ)
    
    // éŸ³æ¨‚é¸æ“‡
    musicSelect.addEventListener('change', function() {
        const selectedMusic = this.value;
        if (selectedMusic) {
            audio.src = selectedMusic;
            audio.load();
            currentMusic = selectedMusic;
            audio.play().then(() => {
                isPlaying = true;
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            }).catch(error => console.error('è‡ªå‹•æ’­æ”¾å¤±æ•—:', error));
        }
    });

    // ç¢ºä¿å¯ä»¥æ’­æ”¾æ™‚è‡ªå‹•æ’­æ”¾
    audio.addEventListener('canplay', function() {
        if (isPlaying) audio.play();
    });

    // æ’­æ”¾/æš«åœæŒ‰éˆ•
    playPauseBtn.addEventListener('click', function() {
        if (isPlaying) {
            audio.pause();
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        } else {
            if (currentMusic) {
                audio.play();
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                alert('è«‹å…ˆé¸æ“‡éŸ³æ¨‚');
            }
        }
        isPlaying = !isPlaying;
    });

    // é€²åº¦æ¢æ›´æ–°
    audio.addEventListener('timeupdate', function() {
        if (!audio.duration) return;
        const progress = (audio.currentTime / audio.duration) * 100;
        progressBarMusic.value = progress;
    });

    progressBarMusic.addEventListener('input', function() {
        const time = (this.value / 100) * audio.duration;
        audio.currentTime = time;
    });

    // è‡ªå‹•æ’­æ”¾ä¸‹ä¸€é¦–é‚è¼¯
    audio.addEventListener('ended', function() {
        if (playMode.value === 'loop') {
            audio.currentTime = 0;
            audio.play();
        } else if (playMode.value === 'next') {
            const options = musicSelect.options;
            for (let i = 0; i < options.length; i++) {
                if (options[i].value === currentMusic) {
                    let nextIndex = (i + 1) % options.length;
                    if (nextIndex === 0) nextIndex = 1;
                    currentMusic = options[nextIndex].value;
                    musicSelect.value = currentMusic;
                    audio.src = currentMusic;
                    audio.load();
                    audio.play();
                    break;
                }
            }
        }
    });

    // éš±è—æ’­æ”¾å™¨
    hidePlayerBtn.addEventListener('click', function() {
        musicPlayer.style.display = 'none';
    });

    musicPlayerInitialized = true;
    console.log("éŸ³æ¨‚æ’­æ”¾å™¨å·²åˆå§‹åŒ– (Lazy Load)");
}

	// åˆ‡æ›éŸ³æ¨‚æ’­æ”¾å™¨é¡¯ç¤º/éš±è— (åŒ…å« Lazy Loading è§¸ç™¼)
function toggleMusicPlayer() {
    // 1. åœ¨é¡¯ç¤ºå‰ï¼Œå…ˆå˜—è©¦åˆå§‹åŒ– (å¦‚æœå·²ç¶“åˆå§‹åŒ–éï¼Œå…§éƒ¨æœƒè‡ªå‹•è·³é)
    if (typeof initMusicPlayer === 'function') {
        initMusicPlayer();
    }

    const musicPlayer = document.getElementById('music-player');
    
    if (musicPlayer.style.display === 'none' || musicPlayer.style.display === '') {
        musicPlayer.style.display = 'flex';
    } else {
        musicPlayer.style.display = 'none';
    }
    
    // æ”¶èµ·å´é‚Šé¸å–®
    const sideMenu = document.getElementById('sideMenu');
    if (sideMenu) {
        sideMenu.classList.remove('active');
        document.getElementById('sideMenuToggle').classList.remove('active');
    }
}

// === å„ªåŒ–ç‰ˆï¼šå¸¶å‹•ç•«çš„è¿”å›ä¸»é  ===
const performReturnToHomeLogic = window.returnToHome || function() {}; // å‚™ä»½èˆŠé‚è¼¯å¼•ç”¨(å¦‚æœæœ‰çš„è©±)

// === å„ªåŒ–ç‰ˆï¼šå¸¶å‹•ç•«çš„è¿”å›ä¸»é  (ä¿®å¾©æ»¾å‹•é–å®šèˆ‡è¦–çª—æ®˜ç•™) ===
// === å„ªåŒ–ç‰ˆï¼šå¸¶å‹•ç•«çš„è¿”å›ä¸»é  (å·²ä¿®å¾©ï¼šåŠ å…¥ featuredContainer éš±è—) ===
window.returnToHome = function() {
    // 1. æ‰¾å‡ºç•¶å‰æ­£åœ¨é¡¯ç¤ºçš„å®¹å™¨ (åŠ å…¥ featuredContainer)
    const activeContainer = document.querySelector(
        '#writingContainer[style*="display: block"], ' +
        '#readingContainer[style*="display: block"], ' +
        '#booksContainer[style*="display: block"], ' +
        '#expandContainer[style*="display: block"], ' +
        '#argumentContainer[style*="display: block"], ' +
        '#historyContainer[style*="display: block"], ' +
        '#toolsContainer2[style*="display: flex"], ' + 
        '#studentCloudModal[style*="display: block"], ' + 
        '#featuredContainer[style*="display: block"]' // <--- â˜…â˜…â˜… é—œéµï¼šåŠ å…¥é€™è¡Œåµæ¸¬ â˜…â˜…â˜…
    );

    // 2. å¦‚æœæ‰¾åˆ°äº†æ­£åœ¨é¡¯ç¤ºçš„é é¢ï¼Œå…ˆæ’­å‹•ç•«
    if (activeContainer) {
        activeContainer.classList.add('page-exit-shrink');

        // 3. ç­‰å¾…å‹•ç•«æ’­å®Œå†åŸ·è¡Œæ¸…ç†
        setTimeout(() => {
            // A. éš±è—æ‰€æœ‰ä¸»è¦åŠŸèƒ½å®¹å™¨ (åŠ å…¥ featuredContainer)
            const containers = [
                'writingContainer', 
                'readingContainer', 
                'booksContainer', 
                'expandContainer', 
                'argumentContainer', 
                'historyContainer', 
                'toolsContainer2',
                'studentCloudModal',
                'featuredContainer' // <--- â˜…â˜…â˜… é—œéµï¼šåŠ å…¥é€™å€‹ ID åˆ°éš±è—åˆ—è¡¨ â˜…â˜…â˜…
            ];
            
            containers.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.display = "none";
                    el.classList.remove('page-exit-shrink');
                    el.style.opacity = "";
                    el.style.transform = "";
                }
            });

            // B. è§£é–é é¢æ²å‹•
            document.body.style.overflow = 'auto'; 
            document.body.style.height = 'auto'; 

            // C. æ¢å¾©ä¸»é èƒŒæ™¯
            document.body.style.backgroundImage = `url('${scenes['home']}')`;
            document.body.style.backgroundColor = '';

            // D. é¡¯ç¤ºä¸»é å…ƒç´ 
            document.querySelector('.title-container').style.display = 'block';
            document.getElementById('hitokoto-container').style.display = 'block';
            document.getElementById('mainMenuBox').style.display = 'block';
            
            // E. é¡¯ç¤º DSE å€’æ•¸
            const dseBox = document.getElementById('dse-countdown-box');
            if (dseBox) dseBox.style.display = 'flex';

            // F. éš±è—è¿”å›æŒ‰éˆ•
            document.getElementById('sideMenuHomeBtn').style.display = 'none';
            document.getElementById('homeBtn').style.display = 'none';

            // G. ç§»é™¤å¡ç‰‡ active ç‹€æ…‹
            document.querySelectorAll('.anime-card').forEach(card => card.classList.remove('active'));

            // H. æ”¶èµ·å´é‚Šé¸å–®
            const sideMenu = document.getElementById('sideMenu');
            if (sideMenu) {
                sideMenu.classList.remove('active');
                document.getElementById('sideMenuToggle').classList.remove('active');
            }
            
            // I. éš±è—å„²å­˜æŒ‰éˆ•
            hideAllSaveHtmlButtons();

            // J. ç¢ºä¿èˆŠç‰ˆå·¥å…·ç®±éš±è—
            const toolsBox = document.getElementById('toolsBox');
            if (toolsBox) toolsBox.style.display = 'none';

            // K. éš±è—å…¶ä»–æ¨¡æ…‹è¦–çª—
            const historyModal = document.getElementById('historyModal');
            if (historyModal) historyModal.style.display = 'none';
            
            const outlineModal = document.getElementById('outline-editor-modal');
            if (outlineModal) outlineModal.style.display = 'none';

            const previewModal = document.getElementById('previewModal');
            if (previewModal) {
                previewModal.style.display = 'none';
                const iframe = document.getElementById('previewIframe');
                if (iframe) iframe.src = 'about:blank';
            }

            const videoModal = document.getElementById('videoModal');
            if (videoModal) {
                videoModal.style.display = 'none';
                const vIframe = document.getElementById('videoIframe');
                if (vIframe) vIframe.src = '';
            }
            
            // L. é—œé–‰æ–‡èƒè©³æƒ…é  (ç¢ºä¿ä¸‹æ¬¡æ‰“é–‹æ˜¯åˆ—è¡¨)
            const featuredDetail = document.getElementById('featuredDetailView');
            if (featuredDetail) featuredDetail.style.display = 'none';
            const featuredList = document.getElementById('featuredListView');
            if (featuredList) featuredList.style.display = 'block';

            // M. æ»¾å‹•åˆ°é ‚éƒ¨
            window.scrollTo({ top: 0, behavior: 'instant' });

            // N. è§¸ç™¼ä¸»é é€²å ´å‹•ç•«
            const mainMenu = document.getElementById('mainMenuBox');
            const dse = document.getElementById('dse-countdown-box');
            
            if (mainMenu) {
                mainMenu.classList.remove('home-enter-pop');
                void mainMenu.offsetWidth; 
                mainMenu.classList.add('home-enter-pop');
            }
            if (dse) {
                dse.classList.remove('home-enter-pop');
                void dse.offsetWidth;
                dse.classList.add('home-enter-pop');
            }

        }, 350); 
        
    } else {
        // å¦‚æœæ²’æœ‰åµæ¸¬åˆ°æ´»å‹•é é¢ï¼Œä¿éšªèµ·è¦‹è§£é–æ»¾å‹•ä¸¦é‡æ•´
        document.body.style.overflow = 'auto'; 
        location.reload(); 
    }
};
// ==========================================
// === IndexedDB æ­·å²ç´€éŒ„ç³»çµ± (V2 å±¤ç´šç‰ˆ + è³‡æºå¿«å–) ===
// ==========================================

const DB_NAME = 'SansiDB';
const DB_VERSION = 2; // â˜… ä¿®æ”¹ï¼šç‰ˆæœ¬è™Ÿå‡ç´šç‚º 2 ä»¥è§¸ç™¼çµæ§‹æ›´æ–°
const STORE_NAME = 'history';
const ASSET_STORE_NAME = 'assets'; // â˜… æ–°å¢ï¼šè³‡æºå„²å­˜å€åç¨±

// å®šç¾©å±¤ç´šçµæ§‹ (ä¿æŒä¸è®Š)
const HISTORY_STRUCTURE = {
    "é–±è®€": ["é»è©•", "æŒ‡å¼•"],
    "æ•˜äº‹æŠ’æƒ…": ["æ–‡ç« é»è©•", "å¤§ç¶±é»è©•", "è§£é¡ŒæŒ‡å¼•", "æ•˜äº‹ç‰©è±¡"],
    "è­°è«–": ["æ–‡ç« é»è©•", "å¤§ç¶±é»è©•", "æŒ‡å¼•"],
    "æ•´åˆæ‹“å±•": ["é»è©•", "æŒ‡å¼•"]
};

// 1. åˆå§‹åŒ–è³‡æ–™åº« (ä¿®è¨‚ç‰ˆï¼šåŠ å…¥ assets å„²å­˜å€)
function openHistoryDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onupgradeneeded = function(event) {
            const db = event.target.result;
            
            // å»ºç«‹æ­·å²ç´€éŒ„å„²å­˜å€ (æ—¢æœ‰é‚è¼¯)
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                store.createIndex('timestamp', 'timestamp', { unique: false });
                store.createIndex('category', 'category', { unique: false });
                store.createIndex('subFunction', 'subFunction', { unique: false });
            }

            // â˜… æ–°å¢ï¼šå»ºç«‹è³‡æºå¿«å–å„²å­˜å€ (è‹¥ä¸å­˜åœ¨å‰‡å»ºç«‹)
            if (!db.objectStoreNames.contains(ASSET_STORE_NAME)) {
                db.createObjectStore(ASSET_STORE_NAME); 
            }
        };
        
        request.onsuccess = function(event) { resolve(event.target.result); };
        request.onerror = function(event) { reject(event.target.error); };
    });
}

// â˜… æ–°å¢ï¼šèƒŒæ™¯åœ–ç‰‡å¿«å–è¼‰å…¥é‚è¼¯ (V2 çµ‚æ¥µé˜²å‘†ç‰ˆ - å« CSP æª¢æ¸¬)
async function loadAndCacheBackground() {
    const bgImageUrl = 'èƒŒæ™¯.png'; 
    const bgKey = 'main_background_image';

    try {
        const db = await openHistoryDB();
        
        // 1. å˜—è©¦å¾ IndexedDB è®€å–
        const tx = db.transaction([ASSET_STORE_NAME], 'readonly');
        const store = tx.objectStore(ASSET_STORE_NAME);
        const request = store.get(bgKey);

        request.onsuccess = async (e) => {
            const cachedBlob = e.target.result;

            if (cachedBlob && cachedBlob.size > 0) {
                // A. å‘½ä¸­å¿«å–ï¼šé€²è¡Œã€Œé è¼‰æ¸¬è©¦ã€
                const imgUrl = URL.createObjectURL(cachedBlob);
                
                // å»ºç«‹ä¸€å€‹éš±å½¢çš„åœ–ç‰‡ç‰©ä»¶ä¾†æ¸¬è©¦è¼‰å…¥
                const testImg = new Image();
                
                testImg.onload = function() {
                    // æ¸¬è©¦æˆåŠŸï¼šä»£è¡¨ CSP é€šéä¸”åœ–ç‰‡æ­£å¸¸ï¼Œé€™æ‰å¥—ç”¨åˆ°èƒŒæ™¯
                    document.body.style.backgroundImage = `url('${imgUrl}')`;
                    console.log("âš¡ [Cache] èƒŒæ™¯åœ–ç‰‡å·²ç¢ºèªæœ‰æ•ˆä¸¦è¼‰å…¥");
                };

                testImg.onerror = function() {
                    // æ¸¬è©¦å¤±æ•—ï¼šå¯èƒ½æ˜¯ CSP é˜»æ“‹æˆ– Blob æå£
                    // ä»€éº¼éƒ½ä¸åšï¼è®“ç¶²é ç¶­æŒ CSS åŸæœ¬è¨­å®šçš„ä¼ºæœå™¨åœ–ç‰‡
                    console.warn("âš ï¸ [Cache] æœ¬åœ°åœ–ç‰‡è¼‰å…¥å¤±æ•— (å¯èƒ½æ˜¯ CSP é˜»æ“‹)ï¼Œå·²è‡ªå‹•é€€å›ä¼ºæœå™¨åŸåœ–ã€‚");
                    URL.revokeObjectURL(imgUrl); // é‡‹æ”¾å…§å­˜
                };

                // é–‹å§‹æ¸¬è©¦
                testImg.src = imgUrl;

            } else {
                // B. ç„¡å¿«å–ï¼šåŸ·è¡ŒèƒŒæ™¯ä¸‹è¼‰ (ä¸å½±éŸ¿ç•¶å‰ç•«é¢)
                console.log("ğŸ“¥ [Cache] èƒŒæ™¯ä¸‹è¼‰ä¸­...");
                try {
                    const response = await fetch(bgImageUrl);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const blob = await response.blob();

                    const writeTx = db.transaction([ASSET_STORE_NAME], 'readwrite');
                    writeTx.objectStore(ASSET_STORE_NAME).put(blob, bgKey);
                    console.log("âœ… [Cache] èƒŒæ™¯å·²å¯«å…¥ IndexedDB (ä¸‹æ¬¡ç”Ÿæ•ˆ)");
                } catch (fetchErr) {
                    console.warn("èƒŒæ™¯ä¸‹è¼‰å¤±æ•—", fetchErr);
                }
            }
        };
    } catch (err) {
        console.warn("å¿«å–ç³»çµ±å•Ÿå‹•å¤±æ•— (ä½¿ç”¨é è¨­èƒŒæ™¯):", err);
    }
}
	
// 2. â˜… æ ¸å¿ƒè¼”åŠ©ï¼šæ•æ‰ HTML ä¸¦å°‡ Canvas è½‰ç‚ºåœ–ç‰‡ â˜…
// â˜… æ ¸å¿ƒè¼”åŠ©ï¼šæ•æ‰ HTML (ä¿®è¨‚ç‰ˆï¼šåªæ•æ‰çµæ§‹ï¼Œä¸è½‰åœ–ç‰‡) â˜…
function captureContainerHTML(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return "";

    // 1. è¤‡è£½ç¯€é»
    const clone = container.cloneNode(true);

    // 2. è™•ç† Canvasï¼šä¿ç•™æ¨™ç±¤ï¼Œä½†å¼·åˆ¶è¨­å®šé«˜åº¦ï¼Œé¿å…åœ¨æ­·å²ç´€éŒ„ä¸­å¡Œé™·
    const canvases = clone.querySelectorAll('canvas');
    canvases.forEach(canvas => {
        // é—œéµï¼šçµ¦äºˆæ˜ç¢ºçš„é«˜åº¦ï¼Œç¢ºä¿ Chart.js ç¨å¾Œæœ‰ç©ºé–“ç¹ªåœ–
        canvas.setAttribute('style', 'width: 100%; height: 350px; display: block;');
        // ç§»é™¤ id å±¬æ€§ï¼Œé¿å…èˆ‡ä¸»é é¢çš„åœ–è¡¨ ID è¡çª (æœƒåœ¨æŸ¥çœ‹æ™‚å‹•æ…‹è™•ç†)
        canvas.removeAttribute('id'); 
        // æ·»åŠ ä¸€å€‹é€šç”¨ class æ–¹ä¾¿è­˜åˆ¥
        canvas.classList.add('history-radar-canvas');
    });

    // 3. æ•æ‰é€²åº¦æ¢ (è—è‰² BAR) çš„å¯¬åº¦
    const progressBars = clone.querySelectorAll('.progress-bar-fill');
    const originalBars = container.querySelectorAll('.progress-bar-fill');
    for (let i = 0; i < progressBars.length; i++) {
        if (originalBars[i]) {
            progressBars[i].style.width = originalBars[i].style.width;
        }
    }

    // 4. è™•ç†è¡¨å–®å…ƒç´  (Textarea / Input)
    const textareas = clone.querySelectorAll('textarea');
    const originalTextareas = container.querySelectorAll('textarea');
    for (let i = 0; i < textareas.length; i++) {
        if (originalTextareas[i]) {
            textareas[i].textContent = originalTextareas[i].value;
        }
    }

    const inputs = clone.querySelectorAll('input');
    const originalInputs = container.querySelectorAll('input');
    for (let i = 0; i < inputs.length; i++) {
        if (originalInputs[i]) {
            inputs[i].setAttribute('value', originalInputs[i].value);
        }
    }

    return clone.innerHTML;
}




	
// ==========================================
// === ä¿®è¨‚ç‰ˆï¼šå„²å­˜ç´€éŒ„ (ä¿ç•™èŠå¤©ä»‹é¢çµæ§‹) ===
// ==========================================
async function saveToHistory(category, subFunction, title, userContent, aiContent, scoreData = null) {
    try {
        // 1. æ¸…ç† HTML
        if (aiContent && typeof aiContent === 'string') {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = aiContent;
            
            // A. ç§»é™¤èˆŠç‰ˆ/æš«æ™‚æ€§è¼¸å…¥æ¡†
            const tempToRemove = tempDiv.querySelectorAll('#writingGuideChatInputContainer, #writingChatInputContainer, #argumentChatInputContainer, #chatInputContainer');
            tempToRemove.forEach(el => el.remove());
 
            // B. ç§»é™¤ä¸€èˆ¬æ“ä½œæŒ‰éˆ•ï¼Œä½†ä¿ç•™ç™¼é€éµ (.canvas-send-btn)
            const buttonsToRemove = tempDiv.querySelectorAll('button:not(.canvas-send-btn), .btn-icon-action');
            buttonsToRemove.forEach(el => el.remove());
 
            // C. æ¸…ç©ºè¼¸å…¥æ¡†å…§å®¹ä½†ä¿ç•™å…ƒç´ 
            const chatInputs = tempDiv.querySelectorAll('.canvas-input-area textarea');
            chatInputs.forEach(el => { el.value = ''; el.innerHTML = ''; });
 
            aiContent = tempDiv.innerHTML;
        }
 
        const db = await openHistoryDB();
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const ts = new Date().getTime();
        
        // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šé€™è£¡ç›´æ¥æ›´æ–°å…¨åŸŸè®Šæ•¸ â˜…â˜…â˜…
        // ç¢ºä¿å‰›ç”Ÿæˆçš„å…§å®¹ ID è¢«ç³»çµ±è¨˜ä½ï¼Œè®“è¿½å•åŠŸèƒ½å¯ä»¥æ‰¾åˆ°é€™ç­†è³‡æ–™
        lastGeneratedTimestamp = ts;
 
        const record = {
            category: category,
            subFunction: subFunction,
            title: title || "ç„¡æ¨™é¡Œ",
            userContent: userContent,
            aiContent: aiContent,
            scoreData: scoreData,
            timestamp: ts,
            dateStr: new Date().toLocaleString('zh-HK', { hour12: false }),
            
            // åˆå§‹ç‹€æ…‹
            isSynced: false,       
            hasBeenSynced: false   
        };
 
        // å¯«å…¥ä¸¦ç²å– ID
        const generatedId = await new Promise((resolve, reject) => {
            const req = store.add(record);
            req.onsuccess = (e) => {
                resolve(e.target.result);
            };
            req.onerror = reject;
        });
        record.id = generatedId;
        console.log(`æœ¬åœ°ç´€éŒ„å·²å»ºç«‹ (ID: ${generatedId})`);
        
        // åŸ·è¡Œè¼•é‡ä¸Šå‚³
        const s = JSON.parse(localStorage.getItem('studentProfile'));
        if (s) {
            quickUploadToFirebase(record);
        }
    } catch (error) {
        console.error("å„²å­˜ç´€éŒ„å¤±æ•—:", error);
    }
}


// ==========================================
// === ä¿®å¾©ç‰ˆï¼šè¼•é‡ç´šä¸Šå‚³ (ID æ›´æ–°ä¿è­·) ===
// ==========================================
async function quickUploadToFirebase(record) {
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    if (!s) return;
    const recordKey = record.timestamp.toString();
    const path = `students/${s.grade}/${s.class}/${s.name}/history/${recordKey}`;
    // æº–å‚™ä¸Šå‚³é›²ç«¯çš„ç‰©ä»¶ (æ³¨æ„ï¼šé›²ç«¯ä¸éœ€è¦å­˜æœ¬åœ° IDï¼Œæ‰€ä»¥å¯ä»¥éæ¿¾æ‰ï¼Œæˆ–è€…ä¿ç•™ä¹Ÿæ²’é—œä¿‚)
    // é€™è£¡æˆ‘å€‘ç›´æ¥ä¸Šå‚³æ•´å€‹ record
    const recordToUpload = {
        ...record,
        isSynced: true,
        hasBeenSynced: true
    };
    try {
        // 1. ä¸Šå‚³ Firebase (update)
        const updates = {};
        updates[path] = recordToUpload;
        await database.ref().update(updates);
        
        console.log(`âœ… [çœæµæ¨¡å¼] å–®ç­†ä¸Šå‚³æˆåŠŸ`);
        // 2. æ›´æ–°æœ¬åœ° IndexedDB ç‹€æ…‹
        // â˜…â˜…â˜… é—œéµï¼šç¢ºä¿ä½¿ç”¨åŸæœ¬çš„ ID é€²è¡Œæ›´æ–° (Put) â˜…â˜…â˜…
        if (record.id) {
            const db = await openHistoryDB();
            const tx = db.transaction([STORE_NAME], 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            
            // é€™è£¡å‚³å…¥çš„ record å¿…é ˆåŒ…å« 'id' æ¬„ä½
            // IndexedDB çœ‹åˆ°æœ‰ idï¼Œå°±æœƒåŸ·è¡Œ Update è€Œä¸æ˜¯ Insert
            store.put(recordToUpload);
        } else {
            console.warn("âš ï¸ è­¦å‘Šï¼šä¸Šå‚³å‡½å¼æ”¶åˆ°ç„¡ ID çš„ç´€éŒ„ï¼Œè·³éæœ¬åœ°ç‹€æ…‹æ›´æ–°ä»¥é˜²é‡è¤‡");
        }
    } catch (e) {
        console.error("å–®ç­†ä¸Šå‚³å¤±æ•— (å°‡åœ¨ä¸‹æ¬¡å…¨é‡åŒæ­¥æ™‚è£œå‚³):", e);
    }
}

	
	
// ==========================================
// === 1. åˆä½µç®—æ³• (ä¿®å¾©ï¼šåš´æ ¼é›™å‘åŒæ­¥èˆ‡åˆªé™¤) ===
// ==========================================
function mergeHistoryRecords(localRecords, cloudRecords) {
    console.log("--- [Logic] åŸ·è¡Œæ™ºèƒ½åˆä½µ ---");
    const mergedMap = new Map();
    
    // è¼”åŠ©ï¼šç”Ÿæˆå”¯ä¸€éµå€¼ (åŸºæ–¼æ™‚é–“æˆ³ï¼Œé€™æ˜¯å”¯ä¸€çš„ ID)
    const generateKey = (r) => {
        const ts = r.timestamp ? Number(r.timestamp) : 0;
        return `${ts}`; // ç°¡åŒ– Keyï¼Œå› ç‚ºæ™‚é–“æˆ³åœ¨ç³»çµ±ä¸­æ˜¯å”¯ä¸€çš„
    };

    // A. å»ºç«‹é›²ç«¯è³‡æ–™ç´¢å¼• (é›²ç«¯æ˜¯æœ€é«˜æ¬Šå¨)
    // é›²ç«¯å­˜åœ¨çš„è³‡æ–™ï¼Œæˆ‘å€‘å…ˆå…¨éƒ¨æ”¾é€² Map
    cloudRecords.forEach(record => {
        const key = generateKey(record);
        mergedMap.set(key, record);
    });

    // B. è™•ç†æœ¬åœ°è³‡æ–™
    localRecords.forEach(localRecord => {
        if (!localRecord) return;
        const key = generateKey(localRecord);
        
        // --- æƒ…æ³ 1ï¼šé›²ç«¯ä¹Ÿæœ‰é€™ç­†è³‡æ–™ ---
        if (mergedMap.has(key)) {
            // é—œéµé‚è¼¯ï¼šå¦‚æœæœ¬åœ°æ¨™è¨˜ç‚ºã€ŒæœªåŒæ­¥ (isSynced: false)ã€ï¼Œä»£è¡¨æœ¬åœ°æœ‰æ–°ä¿®æ”¹ (å¦‚èŠå¤©è¿½å•ã€ç·¨è¼¯)
            // é€™æ™‚å€™æˆ‘å€‘è¦ç”¨ã€Œæœ¬åœ°ã€è¦†è“‹ã€Œé›²ç«¯ã€
            if (localRecord.isSynced === false) {
                // ç¹¼æ‰¿æœ¬åœ°çš„æœ€æ–°å…§å®¹ï¼Œä½†ä¿ç•™ hasBeenSynced å±¬æ€§ä»¥é˜²é‚è¼¯éŒ¯èª¤
                localRecord.hasBeenSynced = true; 
                mergedMap.set(key, localRecord);
                console.log(`[åŒæ­¥] æœ¬åœ°æœ‰æ–°ä¿®è¨‚ï¼Œè¦†è“‹é›²ç«¯ç‰ˆæœ¬: ${localRecord.title}`);
            }
            // å¦å‰‡ï¼Œå¦‚æœæœ¬åœ° isSynced: trueï¼Œæˆ‘å€‘ä¿¡ä»»é›²ç«¯ç‰ˆæœ¬ (å·²åœ¨ map ä¸­)ï¼Œä¸åšå‹•ä½œ
        } 
        // --- æƒ…æ³ 2ï¼šé›²ç«¯ã€æ²’æœ‰ã€‘é€™ç­†è³‡æ–™ (åˆªé™¤ vs æ–°å¢) ---
        else {
            // â˜…â˜…â˜… æ ¸å¿ƒåˆ¤æ–·ï¼šæ˜¯ã€Œæ–°è‰ç¨¿ã€é‚„æ˜¯ã€Œè¢«åˆªé™¤ã€ï¼Ÿ â˜…â˜…â˜…
            
            // å¦‚æœ hasBeenSynced ç‚º trueï¼Œä»£è¡¨é€™ç­†è³‡æ–™æ›¾ç¶“ä¸Šå‚³éé›²ç«¯ã€‚
            // ç¾åœ¨é›²ç«¯æ²’äº†ï¼Œå”¯ä¸€çš„è§£é‡‹å°±æ˜¯ã€Œè¢«è€å¸«/å…¶ä»–è£ç½®åˆªé™¤äº†ã€ã€‚
            if (localRecord.hasBeenSynced === true) {
                console.log(`[åŒæ­¥] åµæ¸¬åˆ°é›²ç«¯å·²åˆªé™¤ç´€éŒ„: ${localRecord.title}ï¼ŒåŸ·è¡Œæœ¬åœ°åŒæ­¥åˆªé™¤ã€‚`);
                // ä¸å°‡å…¶åŠ å…¥ mergedMapï¼Œå³ä»£è¡¨åœ¨æ¥ä¸‹ä¾†çš„æ­¥é©Ÿä¸­æœƒè¢«åˆªé™¤
            } 
            // å¦‚æœ hasBeenSynced ç‚º false (æˆ– undefined)ï¼Œä»£è¡¨é€™æ˜¯å‰›ç”Ÿæˆã€é‚„æ²’ä¾†å¾—åŠä¸Šå‚³çš„æ–°è³‡æ–™
            // æˆ‘å€‘å¿…é ˆä¿ç•™å®ƒä¸¦æº–å‚™ä¸Šå‚³
            else {
                console.log(`[åŒæ­¥] ç™¼ç¾æœªä¸Šå‚³çš„æ–°ç´€éŒ„: ${localRecord.title}ï¼Œæº–å‚™ä¸Šå‚³ã€‚`);
                mergedMap.set(key, localRecord);
            }
        }
    });

    // C. æ’åºå›å‚³ (æŒ‰æ™‚é–“å€’åº)
    return Array.from(mergedMap.values()).sort((a, b) => b.timestamp - a.timestamp);
}
// ==========================================
// === [æ™ºèƒ½çœæµç‰ˆ] æ ¸å¿ƒåŒæ­¥å‡½æ•¸ (å¢é‡æ›´æ–° + æ–·é»çºŒå‚³) ===
// ==========================================
// ==========================================
// === 2. çœæµåŒæ­¥ç³»çµ± (Smart Sync V4 - ID åˆä½µä¿®å¾©ç‰ˆ) ===
// ==========================================
 
async function smartSyncHistory() {
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    const user = firebase.auth().currentUser;
    
    if (!s || !user) return;
 
    // console.log("ğŸš€ [Smart Sync] é–‹å§‹åŒæ­¥æª¢æŸ¥...");
 
    try {
        const db = await openHistoryDB();
        const token = await user.getIdToken();
        const basePath = `students/${s.grade}/${s.class}/${s.name}/history`;
        const dbUrl = "https://sansidata-default-rtdb.firebaseio.com";
 
        // 1. ç²å–æœ¬åœ°æ‰€æœ‰è³‡æ–™ (å»ºç«‹ Timestamp -> å…§éƒ¨ ID çš„ç´¢å¼•)
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const localData = await new Promise(resolve => {
            const req = store.getAll();
            req.onsuccess = e => resolve(e.target.result);
        });
 
        // Map: Timestamp (String) -> Record Object
        // ç”¨ä¾†æª¢æŸ¥é‡è¤‡å’Œå–å¾—èˆŠ ID
        const localTimestampMap = new Map();
        localData.forEach(r => {
            if (r.timestamp) {
                localTimestampMap.set(String(r.timestamp), r);
            }
        });
 
        // 2. ç²å–é›²ç«¯ ID åˆ—è¡¨
        const response = await fetch(`${dbUrl}/${basePath}.json?shallow=true&auth=${token}`);
        const cloudKeysData = await response.json();
        const cloudKeys = cloudKeysData ? Object.keys(cloudKeysData) : [];
        const cloudIdsSet = new Set(cloudKeys);
 
        console.log(`ğŸ“Š [Sync] æœ¬åœ°:${localData.length} / é›²ç«¯:${cloudKeys.length}`);
 
        // ==================================================
        // æ­¥é©Ÿ A: æ¸…ç†æœ¬åœ°ã€Œå¹½éˆæª”æ¡ˆã€ & ã€Œé‡è¤‡æª”æ¡ˆã€
        // ==================================================
        const toDeleteLocally = [];
        const seenTimestamps = new Set();
 
        localData.forEach(record => {
            const keyStr = String(record.timestamp);
            
            // æª¢æŸ¥ 1: é‡è¤‡æª”æ¡ˆæ¸…ç† (å¦‚æœåŒä¸€å€‹ timestamp å‡ºç¾å…©æ¬¡)
            if (seenTimestamps.has(keyStr)) {
                console.warn(`ğŸ—‘ï¸ ç™¼ç¾é‡è¤‡ç´€éŒ„ (Timestamp: ${keyStr})ï¼Œæ¨™è¨˜åˆªé™¤ ID: ${record.id}`);
                toDeleteLocally.push(record.id); // åˆªé™¤å¤šé¤˜çš„å‰¯æœ¬
                return;
            }
            seenTimestamps.add(keyStr);
 
            // æª¢æŸ¥ 2: é›²ç«¯åˆªé™¤åŒæ­¥
            if (!cloudIdsSet.has(keyStr)) {
                if (record.hasBeenSynced === true) {
                    toDeleteLocally.push(record.id);
                }
            }
        });
 
        if (toDeleteLocally.length > 0) {
            console.log(`ğŸ—‘ï¸ [Cleanup] æ¸…ç† ${toDeleteLocally.length} ç­†ç„¡æ•ˆ/é‡è¤‡ç´€éŒ„...`);
            const delTx = db.transaction([STORE_NAME], 'readwrite');
            const delStore = delTx.objectStore(STORE_NAME);
            toDeleteLocally.forEach(id => delStore.delete(id));
            await new Promise(resolve => delTx.oncomplete = resolve);
        }
 
        // ==================================================
        // æ­¥é©Ÿ B: ä¸Šå‚³æœ¬åœ°æ–°è³‡æ–™
        // ==================================================
        const toUpload = localData.filter(r => r.isSynced === false && !toDeleteLocally.includes(r.id));
        
        if (toUpload.length > 0) {
            console.log(`â¬†ï¸ [Upload] ä¸Šå‚³ ${toUpload.length} ç­†...`);
            const updates = {};
            const upTx = db.transaction([STORE_NAME], 'readwrite');
            const upStore = upTx.objectStore(STORE_NAME);
 
            toUpload.forEach(record => {
                record.isSynced = true;
                record.hasBeenSynced = true;
                updates[`${basePath}/${record.timestamp}`] = record;
                upStore.put(record);
            });
            await database.ref().update(updates);
            await new Promise(resolve => upTx.oncomplete = resolve);
        }
 
        // ==================================================
        // æ­¥é©Ÿ C: ä¸‹è¼‰ç¼ºå¤±è³‡æ–™ (å« ID åˆä½µé‚è¼¯)
        // ==================================================
        // æª¢æŸ¥é›²ç«¯æœ‰ï¼Œä½†æœ¬åœ° Map è£¡æ²’æœ‰çš„ key
       // ==================================================
// æ­¥é©Ÿ C: ä¸‹è¼‰ç¼ºå¤±è³‡æ–™ (å« ID åˆä½µé‚è¼¯ + å³æ™‚é·ç§»)
// ==================================================
const missingLocally = cloudKeys.filter(key => !localTimestampMap.has(key));
 
if (missingLocally.length > 0) {
    console.log(`â¬‡ï¸ [Download] ä¸‹è¼‰ ${missingLocally.length} ç­†...`);
    const downloadedRecords = [];
    
    // ç”¨ä¾†æ”¶é›†ã€Œé·ç§»æŒ‡ä»¤ã€çš„ç‰©ä»¶ (åŒæ™‚åˆªèˆŠ + å»ºæ–°)
    const migrationUpdates = {};
 
    // é€ç­†ä¸‹è¼‰
    await Promise.all(missingLocally.map(async (key) => {
        try {
            const snap = await database.ref(`${basePath}/${key}`).once('value');
            const r = snap.val();
            if (r) {
                const keyNum = Number(key);
                let isMigrationNeeded = false;
 
                // â˜…â˜…â˜… å…¼å®¹æ€§é·ç§»é‚è¼¯ (Migration Logic) â˜…â˜…â˜…
                if (keyNum > 1600000000000) {
                    // --- æƒ…æ³ A: æ–°æ ¼å¼ (æ­£å¸¸ä¸‹è¼‰) ---
                    r.timestamp = keyNum;
                    r.isSynced = true;
                    r.hasBeenSynced = true;
                }
                else {
                    // --- æƒ…æ³ B: èˆŠæ ¼å¼ (å³æ™‚é·ç§») ---
                    console.log(`ğŸ”§ [Migration] ç™¼ç¾èˆŠæ ¼å¼ Key: ${key}ï¼Œæ­£åœ¨å³æ™‚è½‰æ›...`);
                    
                    // 1. è£œå…¨æ™‚é–“æˆ³
                    if (!r.timestamp) r.timestamp = new Date().getTime();
                    
                    // 2. â˜…é—œéµä¿®æ”¹â˜…ï¼šå› ç‚ºæˆ‘å€‘é¦¬ä¸Šå°±è¦æ‰‹å‹•ä¸Šå‚³äº†ï¼Œæ‰€ä»¥æœ¬åœ°æ¨™è¨˜ç‚ºã€Œå·²åŒæ­¥ã€
                    // é€™æ¨£ä¸‹æ¬¡åŒæ­¥æ™‚ï¼Œæ­¥é©Ÿ B å°±ä¸æœƒé‡è¤‡ä¸Šå‚³å®ƒ
                    r.isSynced = true;
                    r.hasBeenSynced = true;
 
                    // 3. æº–å‚™ Firebase æŒ‡ä»¤ï¼šåˆªé™¤èˆŠ Key
                    migrationUpdates[`${basePath}/${key}`] = null;
 
                    // 4. æº–å‚™ Firebase æŒ‡ä»¤ï¼šå¯«å…¥æ–° Key
                    migrationUpdates[`${basePath}/${r.timestamp}`] = r;
                    
                    isMigrationNeeded = true;
                }
 
                // ... ID åˆä½µé‚è¼¯ (ä¿æŒä¸è®Š) ...
                const existingLocal = localTimestampMap.get(String(r.timestamp));
                if (existingLocal && existingLocal.id) {
                    r.id = existingLocal.id;
                } else {
                    delete r.id;
                }
                
                downloadedRecords.push(r);
            }
        } catch (err) {
            console.error(`ä¸‹è¼‰å¤±æ•— Key: ${key}`, err);
        }
    }));
 
    // â˜…â˜…â˜… åŸ·è¡Œå³æ™‚é·ç§» (Atomic Update) â˜…â˜…â˜…
    // å¦‚æœæœ‰èˆŠè³‡æ–™éœ€è¦è½‰æ›ï¼Œé€™è£¡æœƒä¸€æ¬¡éç™¼é€ã€Œåˆªé™¤èˆŠ+å¯«å…¥æ–°ã€çš„æŒ‡ä»¤
    if (Object.keys(migrationUpdates).length > 0) {
        console.log(`ğŸš€ [Migration] æ­£åœ¨åŸ·è¡Œé›²ç«¯å³æ™‚é·ç§» (${Object.keys(migrationUpdates).length / 2} ç­†)...`);
        await database.ref().update(migrationUpdates);
        console.log("âœ… [Migration] é›²ç«¯é·ç§»å®Œæˆ");
    }
 
    // å¯«å…¥æœ¬åœ°è³‡æ–™åº«
    if (downloadedRecords.length > 0) {
        const writeTx = db.transaction([STORE_NAME], 'readwrite');
        const writeStore = writeTx.objectStore(STORE_NAME);
        downloadedRecords.forEach(r => writeStore.put(r));
        await new Promise(resolve => writeTx.oncomplete = resolve);
    }
}
 
        // ==================================================
        // æ­¥é©Ÿ D: åˆ·æ–°ä»‹é¢
        // ==================================================
        if (toDeleteLocally.length > 0 || missingLocally.length > 0) {
            if (document.getElementById('historyLevel3').style.display !== 'none' && typeof currentSubFunctionFilter !== 'undefined') {
                 const themeIndex = typeof currentThemeIndex !== 'undefined' ? currentThemeIndex : 1;
                 enterHistoryList(currentSubFunctionFilter, themeIndex);
            }
            console.log("âœ… [Sync] åŒæ­¥å®Œæˆ (å·²ä¿®æ­£é‡è¤‡)");
        } else {
            console.log("âœ… [Sync] è³‡æ–™å·²ä¸€è‡´");
        }
 
    } catch (e) {
        console.error("åŒæ­¥å¤±æ•—:", e);
    }
}
	
// ==========================================
// === 2. æ›´æ–°æœ¬åœ°è³‡æ–™åº« (ä¿®å¾©ï¼šé–å®šåŒæ­¥ç‹€æ…‹) ===
// ==========================================
async function updateLocalHistoryWithMergedData(mergedRecords, db) {
    let localDb = db;
    if (!localDb) {
        localDb = await openHistoryDB();
    }

    try {
        const transaction = localDb.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        
        // A. æ¸…ç©ºæœ¬åœ°ï¼šç¢ºä¿è¢«åˆ¤å®šåˆªé™¤çš„è³‡æ–™çœŸçš„å¾ IndexedDB æ¶ˆå¤±
        await new Promise((resolve, reject) => {
            const req = store.clear();
            req.onsuccess = resolve;
            req.onerror = reject;
        });

        // B. å¯«å…¥åˆä½µå¾Œçš„è³‡æ–™
        for (const record of mergedRecords) {
            // ç§»é™¤èˆŠ IDï¼Œè®“ IndexedDB é‡æ–°åˆ†é… (é¸ç”¨ï¼Œè¦–ä¹ä½ çš„ ID ä¾è³´æ€§ï¼Œé€šå¸¸ä¿ç•™è¼ƒå¥½ï¼Œä½†é‡æ–°åˆ†é…å¯é¿å… key è¡çª)
            // è‹¥ä½ çš„ç³»çµ±åš´é‡ä¾è³´ id ä¾†åš DOM æ“ä½œï¼Œå»ºè­°ä¿ç•™ idï¼š
            // if (!record.id) delete record.id; 
            
            // â˜…â˜…â˜… é—œéµè¨­å®šï¼šæœ¬åœ°é–å®š â˜…â˜…â˜…
            // å› ç‚ºé€™æ˜¯èˆ‡é›²ç«¯å”å•†å¾Œçš„æœ€çµ‚çµæœï¼š
            record.isSynced = true;       // æœ¬åœ°å…§å®¹ = é›²ç«¯å…§å®¹
            record.hasBeenSynced = true;  // é€™ç­†è³‡æ–™å·²åœ¨é›²ç«¯æ›è™Ÿ
            
            store.put(record); 
        }
        
        return new Promise((resolve) => {
            transaction.oncomplete = resolve;
        });
    } catch(e) {
        console.error("æœ¬åœ°è³‡æ–™åº«æ›´æ–°éŒ¯èª¤", e);
    }
}

// ==========================================
// === 4. è‡ªå‹•åŒæ­¥ç›£è½å™¨ (ä¿®å¾©ç‰ˆ) ===
// ==========================================
 
// ==========================================
// === ä¿®æ­£ç‰ˆï¼šè‡ªå‹•åŒæ­¥ç›£è½å™¨ (ä½¿ç”¨ Smart Sync) ===
// ==========================================
// å®šç¾©å…¨åŸŸè®Šæ•¸ä»¥å„²å­˜ç›£è½å™¨åƒç…§
let autoSyncListenerRef = null;    
let autoProfileListenerRef = null;
let isSyncingLock = false;         
function startAutoSyncListener() {
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    if (!s) return;
    // --- éƒ¨åˆ† Aï¼šæ­·å²ç´€éŒ„åŒæ­¥ç›£è½ ---
    if (autoSyncListenerRef) {
        autoSyncListenerRef.off();
    }
    const historyPath = `students/${s.grade}/${s.class}/${s.name}/history`;
    autoSyncListenerRef = database.ref(historyPath);
    // ç›£è½ 'value' äº‹ä»¶ (ç•¶é›²ç«¯æœ‰ä»»ä½•å¢åˆªæ”¹æ™‚è§¸ç™¼)
    autoSyncListenerRef.on('value', (snapshot) => {
        
        if (isSyncingLock) return;
        console.log("âš¡ åµæ¸¬åˆ°é›²ç«¯æ­·å²è®Šæ›´ï¼Œè§¸ç™¼çœæµåŒæ­¥...");
        
        isSyncingLock = true;
        // â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šå‘¼å«æ–°çš„çœæµåŒæ­¥ â˜…â˜…â˜…
        smartSyncHistory().then(() => {
            setTimeout(() => {
                isSyncingLock = false;
            }, 2000);
        });
    });
    // --- éƒ¨åˆ† Bï¼šèº«ä»½ç‹€æ…‹ç›£è½ (ä¿æŒä¸è®Š) ---
    if (autoProfileListenerRef) autoProfileListenerRef.off();
    const profilePath = `students/${s.grade}/${s.class}/${s.name}/profile`;
    autoProfileListenerRef = database.ref(profilePath);
    autoProfileListenerRef.on('value', (snapshot) => {
        const val = snapshot.val();
        if (val === null) {
            autoProfileListenerRef.off();
            if (autoSyncListenerRef) autoSyncListenerRef.off();
            findStudentNewLocation(s.name);
        } else if (!val.number || val.number === "") {
            promptForNewClassNumber(s, profilePath);
        }
    });
    console.log("âœ… é›™é‡ç›£è½å™¨ (æ­·å² + èº«ä»½) å·²å•Ÿå‹•");
}
	
// è®Šæ•¸å„²å­˜ç•¶å‰å°èˆªç‹€æ…‹
let currentCategoryFilter = null;
let currentSubFunctionFilter = null;

// 4. é–‹å•Ÿæ­·å²é é¢ (é€²å…¥ç¬¬ä¸€å±¤)
// 4. é–‹å•Ÿæ­·å²é é¢ (å·²ä¿®å¾©ï¼šåŠ å…¥æ–‡èƒéš±è—)
function openHistoryContainer() {
    // 1. å®šç¾©è¦éš±è—çš„æ‰€æœ‰å®¹å™¨
    const containers = [
        'writingContainer', 'readingContainer', 'booksContainer', 
        'expandContainer', 'argumentContainer', 'mainMenuBox', 
        'hitokoto-container', 'dse-countdown-box', 'toolsBox',
        'toolsContainer2',      
        'studentCloudModal',
        'featuredContainer'     // <--- â˜…â˜…â˜… é—œéµï¼šåŠ å…¥æ–‡èƒå®¹å™¨ â˜…â˜…â˜…
    ];
    
    containers.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
    });
    document.querySelector('.title-container').style.display = 'none';
    
    // 2. è§£é–æ²å‹•
    document.body.style.overflow = 'auto'; 

    // 3. é¡¯ç¤ºæ­·å²å®¹å™¨
    const historyContainer = document.getElementById('historyContainer');
    historyContainer.style.display = 'block';
    
    // 4. æŒ‰éˆ•ç‹€æ…‹èª¿æ•´
    const homeBtn = document.getElementById('sideMenuHomeBtn');
    if (homeBtn) homeBtn.style.display = 'flex';
    
    const cloudBtn = document.getElementById('sideMenuCloudBtn');
    if (cloudBtn) cloudBtn.style.display = 'flex';

    document.getElementById('sideMenu').classList.remove('active');
    document.getElementById('sideMenuToggle').classList.remove('active');

    // æ¸²æŸ“ç¬¬ä¸€å±¤
    renderHistoryCategories();
    
    // å¼·åˆ¶æ»¾å‹•åˆ°é ‚éƒ¨ (é˜²æ­¢è¦–çª—é‚„åœç•™åœ¨ä¸‹æ–¹)
    window.scrollTo({ top: 0, behavior: 'instant' });
}
// 5. æ¸²æŸ“ç¬¬ä¸€å±¤ï¼šä¸»ç¯„ç–‡
// ==========================================
// === æ­·å²ç´€éŒ„ UI æ¸²æŸ“é‚è¼¯ (ä¿®è¨‚ç‰ˆ) ===
// ==========================================

// å®šç¾©ç¯„ç–‡èˆ‡åœ–ç‰‡çš„å°æ‡‰é—œä¿‚ (ç¢ºä¿èˆ‡ä¸»é ä¸€è‡´)
const CATEGORY_ASSETS = {
    "é–±è®€": { img: 'éƒµç­’.png', en: 'READING' },
    "æ•˜äº‹æŠ’æƒ…": { img: 'ç›¸æ©Ÿ.png', en: 'NARRATIVE' },
    "è­°è«–": { img: 'ç­†.png', en: 'ARGUMENT' },
    "æ•´åˆæ‹“å±•": { img: 'ç«è»Š.png', en: 'EXPAND' },
    "èª²å¤–æ›¸ç±": { img: 'æ›¸.png', en: 'LIBRARY' },
    "å­¸ç¿’å ±å‘Š": { img: 'æ›¸.png', en: 'REPORT' } // <--- â˜…â˜…â˜… æ–°å¢é€™ä¸€è¡Œ (æš«ç”¨æ›¸.png æˆ–æ‚¨å¯æŒ‡å®šå…¶ä»–åœ–ç‰‡) â˜…â˜…â˜…
};

// 5. æ¸²æŸ“ç¬¬ä¸€å±¤ï¼šä¸»ç¯„ç–‡ (å‹•æ¼«å¡ç‰‡é¢¨æ ¼)
// 5. æ¸²æŸ“ç¬¬ä¸€å±¤ï¼šä¸»ç¯„ç–‡ (å‹•æ¼«å¡ç‰‡é¢¨æ ¼)
function renderHistoryCategories() {
    // --- æ–°å¢ï¼šéš±è—æ—¥æœŸæœå°‹æŒ‰éˆ• (å› ç‚ºç¬¬ä¸€å±¤ä¸éœ€è¦æœå°‹) ---
    const searchContainer = document.getElementById('historyDateSearchContainer');
    if (searchContainer) searchContainer.style.display = 'none';

    // é¡¯ç¤º/éš±è—å±¤ç´šå®¹å™¨
    document.getElementById('historyLevel1Wrapper').style.display = 'flex'; // Wrapper éœ€è¦ flex
    document.getElementById('historyLevel2').style.display = 'none';
    document.getElementById('historyLevel3').style.display = 'none';

	 // â˜…â˜…â˜… æ–°å¢é€™ä¸€è¡Œï¼šè§¸ç™¼ç¬¬ä¸€å±¤çš„é€²å ´å‹•ç•« â˜…â˜…â˜…
    playEntryAnimation('historyLevel1Wrapper');
    
    // éš±è—éºµåŒ…å±‘ (ç¬¬ä¸€å±¤ä¸éœ€è¦)
    document.getElementById('historyBreadcrumb').style.display = 'none';
    
    const container = document.getElementById('historyLevel1');
    const categories = Object.keys(HISTORY_STRUCTURE); // ["é–±è®€", "æ•˜äº‹æŠ’æƒ…", "è­°è«–", "æ•´åˆæ‹“å±•"]
    
    let html = '';

    categories.forEach(cat => {
        const asset = CATEGORY_ASSETS[cat] || { img: 'èƒŒæ™¯.png', en: 'RECORD' };
        
        // ç”Ÿæˆèˆ‡ä¸»é å®Œå…¨ä¸€è‡´çš„å¡ç‰‡ HTML
        // æ³¨æ„ï¼šé€™è£¡ç§»é™¤äº† id å±¬æ€§ä»¥é¿å…è¡çªï¼Œæ”¹ç”¨ onclick ç›´æ¥è§¸ç™¼æ­·å²åŠŸèƒ½
        html += `
            <div class="anime-card" style="--bg-img: url('${asset.img}');" onclick="enterHistoryCategory('${cat}')">
                <div class="card-overlay"></div>
                <div class="card-border-effect"></div>
                <div class="card-content">
                    <div class="card-text">
                        <span class="card-zh">${cat}</span>
                        <span class="card-en">${asset.en}</span>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// === æ–°å¢å…¨åŸŸè®Šæ•¸ï¼Œç”¨æ–¼å‚³éé¡è‰²ä¸»é¡Œ ===
let currentThemeIndex = 1; 

// 6. é€²å…¥ç¬¬äºŒå±¤ï¼šå­åŠŸèƒ½ (ä¿®æ”¹ç‰ˆï¼šåˆ†é…é¡è‰²)
function enterHistoryCategory(category) {
    const searchContainer = document.getElementById('historyDateSearchContainer');
    if (searchContainer) searchContainer.style.display = 'none';

    currentCategoryFilter = category;
    
    document.getElementById('historyLevel1Wrapper').style.display = 'none';
    document.getElementById('historyLevel2').style.display = 'grid';
    document.getElementById('historyLevel3').style.display = 'none';

	 // â˜…â˜…â˜… æ–°å¢é€™ä¸€è¡Œï¼šè§¸ç™¼ç¬¬äºŒå±¤çš„é€²å ´å‹•ç•« â˜…â˜…â˜…
    playEntryAnimation('historyLevel2');

    // éºµåŒ…å±‘
    const breadcrumb = document.getElementById('historyBreadcrumb');
    breadcrumb.style.display = 'flex';
    document.getElementById('breadcrumb-sep-1').style.display = 'inline';
    const catSpan = document.getElementById('breadcrumb-category');
    catSpan.textContent = category;
    catSpan.style.display = 'inline';
    document.getElementById('breadcrumb-sep-2').style.display = 'none';
    document.getElementById('breadcrumb-sub').style.display = 'none';

    const container = document.getElementById('historyLevel2');
    const subFunctions = HISTORY_STRUCTURE[category] || [];
    
    let html = '';
    
    const subIcons = {
        "æ–‡ç« é»è©•": "fa-file-alt",
        "å¤§ç¶±é»è©•": "fa-list-ol",
        "æ•˜äº‹ç‰©è±¡": "fa-tree",
        "è§£é¡ŒæŒ‡å¼•": "fa-compass",
        "æŒ‡å¼•": "fa-lightbulb",
        "é»è©•": "fa-comment-dots"
    };

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šç‚ºæ¯å€‹å­åŠŸèƒ½åˆ†é…ä¸€å€‹å›ºå®šçš„é¡è‰²ç´¢å¼• (1-5) â˜…â˜…â˜…
    subFunctions.forEach((sub, index) => {
        // ä½¿ç”¨ index % 5 + 1 ç¢ºä¿é¡è‰²åœ¨ 1~5 ä¹‹é–“å¾ªç’°ï¼Œä¸¦è®“ä¸åŒæŒ‰éˆ•é¡è‰²ä¸åŒ
        const themeIndex = (index % 5) + 1;
        
        // åœ¨ onclick ä¸­å‚³é themeIndex
        html += `
            <div class="history-folder-btn history-theme-${themeIndex}" onclick="enterHistoryList('${sub}', ${themeIndex})">
                <i class="fas ${subIcons[sub] || 'fa-file'}"></i>
                <span>${sub}</span>
            </div>
        `;
    });

    if (subFunctions.length === 0) {
        html = '<p style="grid-column: 1/-1; text-align:center; color: #666;">æ­¤ç¯„ç–‡æš«ç„¡å­åŠŸèƒ½å®šç¾©ã€‚</p>';
    }

    container.innerHTML = html;
}

// 7. é€²å…¥ç¬¬ä¸‰å±¤ï¼šç´€éŒ„åˆ—è¡¨ (ä¿®æ”¹ç‰ˆï¼šæ¥æ”¶ä¸¦å„²å­˜é¡è‰²)
async function enterHistoryList(subFunction, themeIndex) {
    currentSubFunctionFilter = subFunction;
    
    // â˜…â˜…â˜… å„²å­˜å‚³å…¥çš„é¡è‰²ç´¢å¼•ï¼Œä¾›æ¸²æŸ“åˆ—è¡¨æ™‚ä½¿ç”¨ â˜…â˜…â˜…
    // å¦‚æœæ˜¯å¾éºµåŒ…å±‘è¿”å›ï¼ŒthemeIndex å¯èƒ½ç‚º undefinedï¼Œå‰‡ä¿æŒåŸå€¼æˆ–é è¨­ç‚º 1
    if (themeIndex) {
        currentThemeIndex = themeIndex;
    }

    document.getElementById('historyLevel1Wrapper').style.display = 'none';
    document.getElementById('historyLevel2').style.display = 'none';
    document.getElementById('historyLevel3').style.display = 'flex';

	// â˜…â˜…â˜… æ–°å¢é€™ä¸€è¡Œï¼šè§¸ç™¼ç¬¬ä¸‰å±¤çš„é€²å ´å‹•ç•« â˜…â˜…â˜…
    playEntryAnimation('historyLevel3');
    
    const searchContainer = document.getElementById('historyDateSearchContainer');
    if (searchContainer) searchContainer.style.display = 'block';

    // éºµåŒ…å±‘é‚è¼¯ (æ¨£å¼å·²åœ¨ CSS ä¿®æ”¹ç‚ºè«è˜­è¿ªè‰²)
    const breadcrumb = document.getElementById('historyBreadcrumb');
    breadcrumb.style.display = 'flex';

    const homeSpan = breadcrumb.querySelector('span[onclick="renderHistoryCategories()"]');
    homeSpan.innerHTML = '<i class="fas fa-home"></i> ä¸»ç¯„ç–‡';
    
    document.getElementById('breadcrumb-sep-1').style.display = 'inline';
    
    const catSpan = document.getElementById('breadcrumb-category');
    catSpan.textContent = currentCategoryFilter;
    catSpan.style.display = 'inline';
    catSpan.setAttribute('onclick', `enterHistoryCategory('${currentCategoryFilter}')`);
    
    document.getElementById('breadcrumb-sep-2').style.display = 'inline';
    
    const subSpan = document.getElementById('breadcrumb-sub');
    subSpan.textContent = subFunction;
    subSpan.style.display = 'inline';

    const listContainer = document.getElementById('historyLevel3');
    listContainer.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>';

    try {
        const db = await openHistoryDB();
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const index = store.index('timestamp');
        const request = index.openCursor(null, 'prev');

        const records = [];
        request.onsuccess = function(event) {
            const cursor = event.target.result;
            if (cursor) {
                const r = cursor.value;
                if (r.category === currentCategoryFilter && r.subFunction === subFunction) {
                    records.push(r);
                }
                cursor.continue();
            } else {
                renderFilteredRecords(records);
            }
        };
    } catch (error) {
        console.error("è®€å–å¤±æ•—:", error);
        listContainer.innerHTML = '<p>è®€å–å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚</p>';
    }
}

// 8. æ¸²æŸ“åˆ—è¡¨å¡ç‰‡ (ä¿®æ”¹ç‰ˆï¼šçµ±ä¸€é¡è‰²)
// === å„ªåŒ–ç‰ˆï¼šæ¸²æŸ“åˆ—è¡¨å¡ç‰‡ (æ•´å¼µå¡ç‰‡å¯é»æ“Š) ===
function renderFilteredRecords(records) {
    const listContainer = document.getElementById('historyLevel3');
    listContainer.innerHTML = '';

    if (records.length === 0) {
        listContainer.innerHTML = `
            <div style="text-align:center; color:#999; margin-top:40px; grid-column: 1/-1; font-family: 'Noto Serif TC', serif;">
                <i class="far fa-file-alt" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
                <p>æ­¤è™•å°šç„¡ç´€éŒ„ï¼Œéœå¾…è½ç­†ã€‚</p>
            </div>`;
        listContainer.style.display = 'flex';
        listContainer.style.justifyContent = 'center';
        return;
    } else {
        listContainer.style.display = 'grid';
    }

    records.forEach((record) => {
        const accentClass = `history-theme-${currentThemeIndex}`;

        const dateObj = new Date(record.timestamp);
        const dateStr = dateObj.toLocaleDateString('zh-HK', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit' 
        }).replace(/\//g, '-');

        const card = document.createElement('div');
        card.className = `history-card ${accentClass}`;
        card.setAttribute('data-timestamp', record.timestamp);
        
        // â˜…â˜…â˜… é—œéµä¿®æ”¹ 1ï¼šå°‡é»æ“Šäº‹ä»¶ç§»åˆ°æœ€å¤–å±¤å®¹å™¨ â˜…â˜…â˜…
        // é€™æ¨£é»æ“Šå¡ç‰‡çš„ä»»ä½•ç•™ç™½è™•éƒ½èƒ½æ‰“é–‹è¦–çª—
        card.setAttribute('onclick', `viewHistoryDetail(${record.id})`);

        card.innerHTML = `
            <!-- â˜…â˜…â˜… é—œéµä¿®æ”¹ 2ï¼šç§»é™¤é€™è£¡å…§å±¤ div çš„ onclickï¼Œæ”¹ç‚ºç´”ä½ˆå±€å®¹å™¨ â˜…â˜…â˜… -->
            <div style="flex-grow: 1;">
                <div class="history-meta">
                    <span class="history-tag">${record.subFunction}</span>
                    <span class="history-date">${dateStr}</span>
                </div>
                
                <!-- 
                    æ¨™é¡Œä¿ç•™è‡ªå·±çš„ onclick/ondblclick é‚è¼¯ã€‚
                    å› ç‚º handleTitleClick è£¡é¢æœ‰ event.stopPropagation()ï¼Œ
                    æ‰€ä»¥é»æ¨™é¡Œæ™‚ä¸æœƒè§¸ç™¼å¤–å±¤çš„ç›´æ¥æ‰“é–‹ï¼Œè€Œæ˜¯åŸ·è¡Œæ¨™é¡Œå°ˆå±¬çš„ã€Œå»¶é²åˆ¤æ–·é›™æ“Šã€é‚è¼¯ã€‚
                -->
                <h4 class="history-title" 
                    onclick="handleTitleClick(event, ${record.id})"
                    ondblclick="handleTitleDblClick(this, ${record.id})"
                    title="å–®æ“ŠæŸ¥çœ‹è©³æƒ…ï¼Œé›™æ“Šç›´æ¥ä¿®æ”¹æ¨™é¡Œ">
                    ${record.title}
                </h4>
            </div>
            
            <div class="history-actions">
    <!-- ä¸‹è¼‰æŒ‰éˆ• (æ–°å¢) -->
    <button class="btn-download-history" id="download-btn-${record.id}" onclick="event.stopPropagation(); downloadHistoryHTML(${record.id})" title="ä¸‹è¼‰ HTML æª”æ¡ˆ">
    <i class="fas fa-file-code"></i>
</button>

    <!-- åˆªé™¤æŒ‰éˆ• -->
    <button class="btn-delete-history" onclick="event.stopPropagation(); deleteHistoryItem(${record.id})" title="åˆªé™¤æ­¤ç´€éŒ„">
        <i class="fas fa-trash-alt"></i>
    </button>
</div>
        `;

        listContainer.appendChild(card);
    });
}


// === æ–°å¢ï¼šä¸‹è¼‰æ­·å²ç´€éŒ„ç‚º PDF ===
// === [100% å®Œç¾å¾©åˆ» + å¼·åˆ¶ç½®ä¸­ä¿®å¾©ç‰ˆ] ä¸‹è¼‰æ­·å²ç´€éŒ„ç‚º HTML ===
async function downloadHistoryHTML(id) {
    const btn = document.getElementById(`download-btn-${id}`);
    if (!btn) return;
    
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    const resetBtn = () => {
        btn.innerHTML = originalContent;
        btn.disabled = false;
    };

    try {
        const db = await openHistoryDB();
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);

        request.onsuccess = async function(event) {
            const record = event.target.result;
            if (!record) { alert("æ‰¾ä¸åˆ°ç´€éŒ„"); resetBtn(); return; }

            // 1. å»ºç«‹å½±å­å®¹å™¨ (è¨­å®šç‚º 900pxï¼Œé€™æ˜¯é›»è…¦ç‰ˆçš„æ¨™æº–å¯¬åº¦)
            const shadowContainer = document.createElement('div');
            shadowContainer.style.cssText = `
                position: absolute; left: -9999px; top: 0; 
                width: 900px; 
                background-color: #fff; 
                visibility: hidden;
                box-sizing: border-box;
            `;
            document.body.appendChild(shadowContainer);

            // 2. === é‡å»º HTML çµæ§‹ ===
            
            let themeIndex = 1;
            if (record.category && typeof HISTORY_STRUCTURE !== 'undefined') {
                const subIndex = HISTORY_STRUCTURE[record.category]?.indexOf(record.subFunction);
                if (subIndex !== -1 && subIndex !== undefined) themeIndex = (subIndex % 5) + 1;
            }
            const themeClass = `history-theme-context-${themeIndex}`;
            const colorVar = `var(--m-color-${themeIndex})`;

            let contentHTML = `
                <div style="padding: 40px 40px 30px 40px; border-bottom: 1px solid #eee; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #2A9689; font-size: 28px; font-family: 'Noto Serif TC', serif; text-align: left;">
                        ${record.title}
                    </h2>
                    <div style="color: #888; font-size: 14px; margin-top: 15px; text-align: center;">
                        <span style="background-color:${colorVar}; color:white; padding: 2px 8px; border-radius: 4px; font-weight:bold;">${record.category}</span>
                        <span style="margin: 0 5px;">/</span>
                        <span>${record.subFunction}</span>
                        <span style="margin-left: 15px;">ğŸ“… ${record.dateStr}</span>
                    </div>
                </div>
                <div style="padding: 0 40px 40px 40px;">
            `;

            if (record.userContent) {
                const rawText = record.userContent;
                const lines = rawText.split('\n');
                let parsedHTML = `<div class="history-parsed-container ${themeClass}">`;
                let currentLabel = 'è¼¸å…¥å…§å®¹'; 
                let currentContent = [];
                const labelRegex = /^(.{2,10}?)[ï¼š:](.*)$/;

                lines.forEach((line) => {
                    const match = line.match(labelRegex);
                    if (match) {
                        if (currentContent.length > 0) {
                            parsedHTML += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${currentContent.join('\n')}</div></div>`;
                        }
                        currentLabel = match[1].trim(); 
                        const restOfLine = match[2].trim();
                        currentContent = restOfLine ? [restOfLine] : []; 
                    } else {
                        if (line.trim() !== "") currentContent.push(line);
                    }
                });
                if (currentContent.length > 0 || lines.length === 0) { 
                     const finalContent = currentContent.length > 0 ? currentContent.join('\n') : rawText;
                     parsedHTML += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${finalContent}</div></div>`;
                }
                parsedHTML += '</div>';
                
                contentHTML += `
                    <div style="background:#fff; padding:25px; border-radius:12px; margin-bottom:30px; border:1px solid #e0ddd7; box-shadow: 0 4px 15px rgba(0,0,0,0.03);">
                        ${parsedHTML}
                    </div>`;
            }

            if (record.aiContent) {
                contentHTML += `<div class="ai-output-area">${record.aiContent}</div>`;
            }

            contentHTML += `</div>`; 
            shadowContainer.innerHTML = contentHTML;

            // 3. === æ¸…ç†èˆ‡å‡çµ ===
            shadowContainer.querySelectorAll('.canvas-chat-container, .canvas-input-area, button, .action-buttons-container, .history-save-btn, input[type="text"], textarea').forEach(el => {
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    const span = document.createElement('div');
                    span.innerText = el.value;
                    span.style.cssText = "white-space: pre-wrap; background: #fffcf6; padding: 10px; border: 1px solid #ddd; border-radius: 4px; color: #333; font-size: 16px; font-family: 'Noto Serif TC', serif;";
                    el.parentNode.replaceChild(span, el);
                } else {
                    el.remove();
                }
            });

            shadowContainer.querySelectorAll('.progress-bar-fill').forEach(bar => {
                const w = bar.style.width; 
                bar.setAttribute('style', `width: ${w} !important; background-color: #007bff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;`);
            });

            // 4. === è™•ç†åœ–è¡¨ ===
            if (record.scoreData && record.scoreData.radar) {
                let canvasEl = shadowContainer.querySelector('canvas');
                if (!canvasEl) {
                    const radarContainer = shadowContainer.querySelector('.radar-chart-container') || shadowContainer.querySelector('.ai-output-area');
                    if (radarContainer) {
                        if (radarContainer.classList.contains('radar-chart-container')) radarContainer.innerHTML = ''; 
                        canvasEl = document.createElement('canvas');
                        canvasEl.width = 500;
                        canvasEl.height = 350;
                        if (radarContainer.firstChild) {
                            radarContainer.insertBefore(canvasEl, radarContainer.firstChild);
                        } else {
                            radarContainer.appendChild(canvasEl);
                        }
                    }
                }

                if (canvasEl) {
                    const ctx = canvasEl.getContext('2d');
                    await new Promise((resolve) => {
                        new Chart(ctx, {
                            type: 'radar',
                            data: {
                                labels: ['ç«‹æ„', 'å–æ', 'æ‰£é¡Œ', 'è©³ç•¥', 'è©å½™', 'æ–‡å­¸æ€§'],
                                datasets: [{
                                    label: 'èƒ½åŠ›è©•ä¼°',
                                    data: [
                                        record.scoreData.radar.ç«‹æ„ || 0,
                                        record.scoreData.radar.å–æ || 0,
                                        record.scoreData.radar.æ‰£é¡Œ || 0,
                                        record.scoreData.radar.è©³ç•¥ || 0,
                                        record.scoreData.radar.è©å½™ || 0,
                                        record.scoreData.radar.æ–‡å­¸æ€§ || 0
                                    ],
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 2,
                                    pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                                }]
                            },
                            options: {
                                animation: false,
                                responsive: false,
                                scales: {
                                    r: {
                                        angleLines: { display: true },
                                        suggestedMin: 0, suggestedMax: 10,
                                        pointLabels: { font: { size: 14, family: "'Noto Serif TC', serif" } },
                                        ticks: { stepSize: 2, display: false }
                                    }
                                },
                                plugins: { legend: { display: false } }
                            }
                        });
                        setTimeout(resolve, 300);
                    });

                    const imgUrl = canvasEl.toDataURL('image/png');
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    img.style.cssText = "width: 100%; max-width: 500px; display: block; margin: 0 auto;";
                    canvasEl.parentNode.replaceChild(img, canvasEl);
                }
            }

            // 5. === æå–å…¨ç«™ CSS ===
            let cssRules = "";
            Array.from(document.querySelectorAll('style')).forEach(style => { cssRules += style.innerHTML + "\n"; });
            let externalLinks = "";
            Array.from(document.querySelectorAll('link[rel="stylesheet"]')).forEach(link => { externalLinks += link.outerHTML + "\n"; });

            // 6. === çµ„åˆæœ€çµ‚ HTML (å¼·åˆ¶è¦†å¯« Body æ¨£å¼) ===
            const finalHtmlSource = `
<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${record.title} - ç¥æ€ç´€éŒ„</title>
    ${externalLinks}
    <style>
        ${cssRules}
        
        /* === é—œéµä¿®æ­£ï¼šå¼·åˆ¶è¦†å¯«åŸæœ‰ç¶²ç«™ CSS å° Body çš„é™åˆ¶ === */
        
        body { 
            /* 1. å¼·åˆ¶é‡ç½® Body å¯¬åº¦èˆ‡èƒŒæ™¯ï¼Œè¦†è“‹åŸç¶²ç«™çš„ max-width: 800px */
            max-width: 100% !important; 
            width: 100% !important;
            margin: 0 !important;
            padding: 40px 0 !important;
            
            /* 2. ä½¿ç”¨ Flexbox ç¢ºä¿å…§å®¹å¡ç‰‡çµ•å°ç½®ä¸­ */
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important; /* æ°´å¹³ç½®ä¸­ */
            
            background-color: #f2f4f7 !important;
            background-image: none !important;
            min-height: 100vh !important;
            overflow-y: auto !important;
        }

        /* å…§å®¹å®¹å™¨ï¼šé€™å¼µã€Œç´™ã€ */
        .export-wrapper {
            /* 3. è¨­å®šå›ºå®šå¯¬åº¦ 900px (é›»è…¦ç‰ˆ)ï¼Œé…åˆ Body çš„ Flex ç½®ä¸­ */
            width: 900px !important;
            
            /* 4. éŸ¿æ‡‰å¼ä¿è­·ï¼šåœ¨å°è¢å¹•ä¸Šç¸®æ”¾ */
            max-width: 95% !important; 
            
            background-color: #ffffff !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08) !important;
            border-radius: 12px !important;
            box-sizing: border-box !important;
            overflow: hidden !important;
            position: relative !important;
            margin: 0 !important; /* Margin 0ï¼Œå› ç‚º Body å·²ç¶“è² è²¬ç½®ä¸­äº† */
        }

        /* ä¿®å¾© Grid æ’ç‰ˆ (è©•åˆ†è¡¨ + é›·é”åœ–) */
        .grading-grid { 
            display: grid !important; 
            grid-template-columns: 1fr 1fr !important; 
            gap: 20px !important; 
            width: 100% !important;
        }
        .grading-scores, .grading-radar {
            width: 100% !important;
            box-sizing: border-box !important;
            margin: 0 !important;
        }

        /* æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
        @media (max-width: 768px) {
            body {
                padding: 0 !important; 
                background-color: #fff !important;
                display: block !important; /* æ‰‹æ©Ÿç‰ˆæ”¹å› Blockï¼Œè®“å…§å®¹è‡ªç„¶æµå‹• */
            }
            .export-wrapper {
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }
            .grading-grid {
                grid-template-columns: 1fr !important;
            }
        }

        button { display: none !important; }
    </style>
</head>
<body>
    <div class="export-wrapper">
        ${shadowContainer.innerHTML}
    </div>
    
    <div style="text-align: center; color: #aaa; font-size: 12px; margin-top: 30px; font-family: sans-serif; width: 100%;">
        Generated by ç¥æ€ SANSI AI System
    </div>
</body>
</html>`;

            // 7. æ¸…ç†èˆ‡ä¸‹è¼‰
            document.body.removeChild(shadowContainer);

            const blob = new Blob([finalHtmlSource], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const safeTitle = record.title.replace(/[\\/:*?"<>|]/g, '_').substring(0, 15);
            const dateSuffix = new Date().toISOString().slice(0, 10);
            a.href = url;
            a.download = `ç¥æ€ç´€éŒ„_${safeTitle}_${dateSuffix}.html`;
            
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                resetBtn();
            }, 100);
        };

        request.onerror = function() { alert("è®€å–ç´€éŒ„å¤±æ•—"); resetBtn(); };

    } catch (e) {
        console.error("ä¸‹è¼‰ HTML éŒ¯èª¤:", e);
        alert("ä¸‹è¼‰å¤±æ•—ï¼Œè«‹é‡è©¦");
        resetBtn();
    }
}
	
	
// ==========================================
// === ä¿®æ­£ç‰ˆï¼šåˆªé™¤ç´€éŒ„ (æ‰‹è¡“åˆ€å¼ - ä¸æœƒå½±éŸ¿å…¶ä»– Key) ===
// ==========================================
async function deleteHistoryItem(id) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™æ¢ç´€éŒ„å—ï¼Ÿ\n(æ³¨æ„ï¼šé›²ç«¯å‚™ä»½ä¹ŸæœƒåŒæ­¥åˆªé™¤)")) return;
    
    const s = JSON.parse(localStorage.getItem('studentProfile'));
 
    try {
        const db = await openHistoryDB();
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        
        // 1. å…ˆç²å–é€™ç­†è³‡æ–™ (ç‚ºäº†æ‹¿åˆ° Timestamp)
        const getReq = store.get(id);
        
        getReq.onsuccess = async function(e) {
            const record = e.target.result;
            
            // 2. åˆªé™¤æœ¬åœ°
            store.delete(id);
            
            // 3. åˆªé™¤é›²ç«¯ (ç²¾æº–åˆªé™¤)
            if (s && record && record.timestamp) {
                const cloudKey = record.timestamp.toString();
                // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šç›´æ¥æŒ‡å‘è©² Key é€²è¡Œåˆªé™¤ï¼Œä¸å½±éŸ¿æ—é‚Šçš„è³‡æ–™ â˜…â˜…â˜…
                const path = `students/${s.grade}/${s.class}/${s.name}/history/${cloudKey}`;
                
                await database.ref(path).remove();
                console.log(`ğŸ—‘ï¸ é›²ç«¯ Key [${cloudKey}] å·²ç²¾æº–ç§»é™¤`);
            } else if (s && (!record || !record.timestamp)) {
                console.warn("æ‰¾ä¸åˆ° Timestampï¼Œç„¡æ³•åˆªé™¤é›²ç«¯å°æ‡‰è³‡æ–™ (å¯èƒ½å·²æ˜¯å¹½éˆæª”æ¡ˆ)");
            }
 
            // 4. åˆ·æ–°ä»‹é¢
            // (ä½¿ç”¨ setTimeout ç¢ºä¿ DB åˆªé™¤å‹•ä½œå·²å®Œæˆ)
            setTimeout(() => {
                if (document.getElementById('historyLevel3').style.display !== 'none' && typeof currentSubFunctionFilter !== 'undefined') {
                    // å¦‚æœæ­£åœ¨åˆ—è¡¨é ï¼Œé‡æ–°è®€å–
                    const themeIndex = typeof currentThemeIndex !== 'undefined' ? currentThemeIndex : 1;
                    enterHistoryList(currentSubFunctionFilter, themeIndex);
                }
            }, 100);
        };
        
    } catch (e) {
        console.error("åˆªé™¤å¤±æ•—:", e);
        alert("åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
    }
}
	
// ==========================================
// === ä¿®æ­£ç‰ˆï¼šæ¸…ç©ºæ‰€æœ‰ç´€éŒ„ (ç›´æ¥è¨­ç‚ºç©ºç‰©ä»¶) ===
// ==========================================
async function clearAllHistory() {
    if (!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿ")) return;
    
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    const level3 = document.getElementById('historyLevel3');
 
    // UI åé¥‹
    if (level3 && level3.style.display !== 'none') {
        level3.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#999;"><i class="fas fa-circle-notch fa-spin"></i> æ­£åœ¨æ¸…ç©º...</div>';
    }
 
    try {
        const db = await openHistoryDB();
        
        // 1. æ¸…ç©ºæœ¬åœ°
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        store.clear();
 
        // 2. æ¸…ç©ºé›²ç«¯ (è¨­ç‚º null å³å¯å®Œå…¨ç§»é™¤ç¯€é»ï¼Œä¸æœƒç•™ä¸‹ array çµæ§‹)
        if (s) {
            const path = `students/${s.grade}/${s.class}/${s.name}/history`;
            await database.ref(path).remove(); // ä½¿ç”¨ remove() æ¯” set([]) æ›´ä¹¾æ·¨
            console.log("é›²ç«¯åŒæ­¥æ¸…ç©ºæˆåŠŸ");
        }
 
        // 3. åˆ·æ–°ä»‹é¢
        setTimeout(() => {
            if (document.getElementById('historyLevel3').style.display !== 'none') {
                const themeIndex = typeof currentThemeIndex !== 'undefined' ? currentThemeIndex : 1;
                if (typeof currentSubFunctionFilter !== 'undefined') {
                    enterHistoryList(currentSubFunctionFilter, themeIndex);
                } else {
                    renderHistoryCategories();
                }
            } else {
                renderHistoryCategories();
            }
            alert("âœ… æ‰€æœ‰ç´€éŒ„å·²æ¸…ç©º");
        }, 200);
 
    } catch (e) {
        console.error("æ¸…ç©ºéŒ¯èª¤:", e);
        alert("æ¸…ç©ºå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
        // æ¢å¾©ç•«é¢
        if (typeof currentSubFunctionFilter !== 'undefined') {
             enterHistoryList(currentSubFunctionFilter);
        }
    }
}
// ==========================================================================
// === 3. [å­¸ç”Ÿç«¯] æ­·å²è©³æƒ…ä¿®å¾©ï¼šåŠ å…¥å­¸ç¿’å ±å‘Šé›·é”åœ–çš„é‡ç¹ªé‚è¼¯ (ä¿®å¾©ç‰ˆ) ===
// ==========================================================================
async function viewHistoryDetail(id) {
    try {
        const db = await openHistoryDB();
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);
        request.onsuccess = function(event) {
            const record = event.target.result;
            if (record) {
                // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šé–å®šç•¶å‰ç´€éŒ„çš„æ™‚é–“æˆ³ â˜…â˜…â˜…
                // é€™æ¨£ç¨å¾Œå¦‚æœåœ¨è¦–çª—å…§é€²è¡Œ AI è¿½å•ï¼Œç³»çµ±æ‰çŸ¥é“è¦æ›´æ–°å“ªä¸€ç­†ç´€éŒ„
                lastGeneratedTimestamp = record.timestamp;
 
                // 1. è¨ˆç®—ä¸»é¡Œè‰²
                let themeIndex = 1;
                if (HISTORY_STRUCTURE[record.category]) {
                    const subIndex = HISTORY_STRUCTURE[record.category].indexOf(record.subFunction);
                    if (subIndex !== -1) {
                        themeIndex = (subIndex % 5) + 1;
                    }
                }
                const themeClass = `history-theme-context-${themeIndex}`;
                const colorVar = `var(--m-color-${themeIndex})`;
                // 2. è¨­å®šæ¨™é¡Œ
                document.getElementById('historyModalTitle').innerHTML =
                    `<i class="fas fa-book-open" style="color:${colorVar}"></i>
                     <span style="color:#333">${record.category}</span>
                     <span style="font-size:0.8em; color:#bbb; margin: 0 5px;">/</span>
                     <span style="color:${colorVar}; font-weight:bold;">${record.subFunction}</span>`;
                
                const dateElement = document.getElementById('historyModalDate');
                if (dateElement) dateElement.style.display = "none";
                
                let contentHTML = '';
                // 3. è™•ç†ä½¿ç”¨è€…è¼¸å…¥å…§å®¹
                if (record.category !== "å­¸ç¿’å ±å‘Š" && record.userContent) {
                    const rawText = record.userContent;
                    const lines = rawText.split('\n');
                    
                    // åˆ¤æ–·æ˜¯å¦ç‚ºè­°è«–æŒ‡å¼•ï¼Œå¦‚æœæ˜¯ï¼ŒåŠ å…¥å°ˆå±¬ class
                    let specificLayoutClass = "";
                    if (record.category === "è­°è«–" && record.subFunction === "æŒ‡å¼•") {
                        specificLayoutClass = "argument-guide-layout";
                    }
                    
                    let parsedHTML = `<div class="history-parsed-container ${themeClass} ${specificLayoutClass}">`;
                    
                    let currentLabel = 'è¼¸å…¥å…§å®¹';
                    let currentContent = [];
                    const labelRegex = /^(.{2,10}?)[ï¼š:](.*)$/;
 
                    lines.forEach((line) => {
                        const match = line.match(labelRegex);
                        if (match) {
                            if (currentContent.length > 0) {
                                parsedHTML += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${currentContent.join('\n')}</div></div>`;
                            }
                            currentLabel = match[1].trim();
                            const restOfLine = match[2].trim();
                            currentContent = restOfLine ? [restOfLine] : [];
                        } else {
                            if (line.trim() !== "") currentContent.push(line);
                        }
                    });
 
                    if (currentContent.length > 0 || lines.length === 0) {
                         const finalContent = currentContent.length > 0 ? currentContent.join('\n') : rawText;
                         parsedHTML += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${finalContent}</div></div>`;
                    }
                    parsedHTML += '</div>';
                    
                    contentHTML += `
                        <div id="edit-user-content-${record.id}"
                             ondblclick="enableHistoryEdit(this)"
                             title="é›™æ“Šå³å¯ä¿®è¨‚å…§å®¹"
                             style="background:#fff; padding:20px; border-radius:12px; margin-bottom:25px; border:1px solid #eee; box-shadow: 0 4px 20px rgba(0,0,0,0.04);">
                            ${parsedHTML}
                        </div>`;
                }
                // 4. è™•ç† AI ç”Ÿæˆå…§å®¹
                if (record.aiContent) {
                    contentHTML += `
                        <div id="edit-ai-content-${record.id}"
                             ondblclick="enableHistoryEdit(this)"
                             title="é›™æ“Šå³å¯ä¿®è¨‚å…§å®¹"
                             class="ai-output-area"
                             style="margin-top: 15px;">
                            ${record.aiContent}
                        </div>`;
                }
                
                // 5. é¡¯ç¤ºç¹³äº¤æŒ‰éˆ• (å­¸ç¿’å ±å‘Šé™¤å¤–)
                const s = JSON.parse(localStorage.getItem('studentProfile'));
                if (s && record.category !== "å­¸ç¿’å ±å‘Š") {
                    contentHTML += `
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 2px dashed #eee; text-align: right; display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
                            <button class="btn-action btn-morandi"
                                    onclick="openSubmitSelector(${record.id})">
                                <i class="fas fa-paper-plane"></i> ç¹³äº¤
                            </button>
                        </div>
                    `;
                }
                // 6. æ³¨å…¥æ‡¸æµ®å„²å­˜éµ
                contentHTML += `
                    <button id="history-save-btn-${record.id}"
                            class="morandi-save-float-btn"
                            onclick="saveHistoryEdits(${record.id})">
                        <i class="fas fa-save"></i>
                    </button>
                `;
                // 7. æ³¨å…¥ Modal
                const modalContent = document.getElementById('historyModalContent');
                modalContent.innerHTML = contentHTML;
                document.getElementById('historyModal').style.display = 'flex';
                // 8. é‡ç¹ªåœ–è¡¨é‚è¼¯ (å«å­¸ç¿’å ±å‘Š)
                setTimeout(() => {
                    if (record.category !== "å­¸ç¿’å ±å‘Š" && record.scoreData && record.scoreData.radar) {
                        const canvasEl = modalContent.querySelector('.radar-chart-container canvas') || modalContent.querySelector('canvas');
                        if (canvasEl) {
                            renderSingleRadarChart(canvasEl, record.scoreData.radar);
                        }
                    }
                    else if (record.category === "å­¸ç¿’å ±å‘Š" && record.scoreData) {
                        if (record.scoreData["æ•˜äº‹æŠ’æƒ…"] && record.scoreData["æ•˜äº‹æŠ’æƒ…"].radar) {
                            const narrBadge = modalContent.querySelector('.badge-narrative');
                            if (narrBadge) {
                                const section = narrBadge.closest('.report-section');
                                const narrCanvas = section ? section.querySelector('canvas') : null;
                                if (narrCanvas) renderReportRadarChart(narrCanvas, record.scoreData["æ•˜äº‹æŠ’æƒ…"].radar);
                            }
                        }
                        if (record.scoreData["è­°è«–"] && record.scoreData["è­°è«–"].radar) {
                            const argBadge = modalContent.querySelector('.badge-argument');
                            if (argBadge) {
                                const section = argBadge.closest('.report-section');
                                const argCanvas = section ? section.querySelector('canvas') : null;
                                if (argCanvas) renderReportRadarChart(argCanvas, record.scoreData["è­°è«–"].radar);
                            }
                        }
                    }
                }, 150);
            }
        };
    } catch (e) { console.error(e); }
}
	
// è¼”åŠ©å‡½å¼ï¼šç¹ªè£½å–®ç¯‡é›·é”åœ–
function renderSingleRadarChart(canvasEl, radarData) {
    const dataValues = [
        radarData.ç«‹æ„ || 0, radarData.å–æ || 0, radarData.æ‰£é¡Œ || 0,
        radarData.è©³ç•¥ || 0, radarData.è©å½™ || 0, radarData.æ–‡å­¸æ€§ || 0
    ];
    new Chart(canvasEl.getContext('2d'), {
        type: 'radar',
        data: {
            labels: ['ç«‹æ„', 'å–æ', 'æ‰£é¡Œ', 'è©³ç•¥', 'è©å½™', 'æ–‡å­¸æ€§'],
            datasets: [{
                label: 'èƒ½åŠ›è©•ä¼°',
                data: dataValues,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 10, ticks: { stepSize: 2, display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });
}

// è¼”åŠ©å‡½å¼ï¼šç¹ªè£½å­¸ç¿’å ±å‘Šé›·é”åœ–
function renderReportRadarChart(canvasEl, radarDataArray) {
    // å­¸ç¿’å ±å‘Šçš„ radarData å·²ç¶“æ˜¯ä¸€å€‹é™£åˆ— [ç«‹æ„, å–æ...]
    new Chart(canvasEl.getContext('2d'), {
        type: 'radar',
        data: {
            labels: ['ç«‹æ„', 'å–æ', 'æ‰£é¡Œ', 'è©³ç•¥', 'è©å½™', 'æ–‡å­¸æ€§'],
            datasets: [{
                label: 'å¹³å‡èƒ½åŠ›',
                data: radarDataArray,
                backgroundColor: 'rgba(94, 112, 103, 0.4)',
                borderColor: '#5e7067',
                borderWidth: 2,
                pointBackgroundColor: '#5e7067'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: { suggestedMin: 0, suggestedMax: 10, ticks: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });
}

	function enableHistoryEdit(element) {
    // å•Ÿç”¨ç·¨è¼¯
    element.contentEditable = "true";
    element.focus();
    
    // æ‰¾å‡ºç›®å‰ç´€éŒ„çš„ ID
    const parts = element.id.split('-');
    const recordId = parts[parts.length - 1];
    
    // é¡¯ç¤ºå°æ‡‰çš„æ‡¸æµ®å„²å­˜æŒ‰éˆ•
    const saveBtn = document.getElementById(`history-save-btn-${recordId}`);
    if (saveBtn) {
        saveBtn.style.display = 'flex'; // é¡¯ç¤ºåœ“å½¢æŒ‰éˆ•
        
        // æ‰‹æ©Ÿéœ‡å‹•å›é¥‹
        if (navigator.vibrate) navigator.vibrate(15);
    }
}

// ==========================================
// === æ ¸å¿ƒä¿®å¾©ï¼šå„²å­˜ä¿®è¨‚ä¸¦è¦†è“‹èˆŠæª” ===
// ==========================================

// è¼”åŠ©å‡½å¼ï¼šæ ¹æ“šæ™‚é–“æˆ³è¨˜æ‰¾å›æ–° ID
function findIdByTimestamp(timestamp) {
    return new Promise(async (resolve) => {
        try {
            const db = await openHistoryDB();
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const index = store.index('timestamp');
            const request = index.get(timestamp);
            
            request.onsuccess = function(event) {
                const record = event.target.result;
                resolve(record ? record.id : null);
            };
            request.onerror = () => resolve(null);
        } catch (e) {
            resolve(null);
        }
    });
}


// ==========================================
// === 4. å„²å­˜ä¿®è¨‚ (ä¿®å¾©ï¼šUIå›é¥‹å„ªåŒ–ç‰ˆ) ===
// ==========================================
async function saveHistoryEdits(id) {
    const userContentEl = document.getElementById(`edit-user-content-${id}`);
    const aiContentEl = document.getElementById(`edit-ai-content-${id}`);
    const saveBtn = document.getElementById(`history-save-btn-${id}`);
    
    // å‚™ä»½åŸå§‹æŒ‰éˆ•å…§å®¹ä»¥ä¾¿é‚„åŸ
    const originalIcon = saveBtn ? saveBtn.innerHTML : '<i class="fas fa-save"></i>';
    
    if (saveBtn) {
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        saveBtn.disabled = true;
    }

    try {
        const db = await openHistoryDB();
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        
        const getRequest = store.get(id);
        
        getRequest.onsuccess = function(event) {
            const record = event.target.result;
            if (record) {
                // 1. è¨˜éŒ„èˆŠçš„æ™‚é–“æˆ³
                const oldTimestamp = record.timestamp;
                
                // 2. æ›´æ–°å…§å®¹
                if (userContentEl) record.userContent = userContentEl.innerText;
                if (aiContentEl) record.aiContent = aiContentEl.innerHTML;
                
                // 3. æ›´æ–°æ™‚é–“æˆ³ (è¦–ç‚ºæ–°ç‰ˆ)
                const newTimestamp = new Date().getTime();
                record.timestamp = newTimestamp;
                record.dateStr = new Date().toLocaleString('zh-HK', { hour12: false });
                
                // 4. è¨­å®šåŒæ­¥ç‹€æ…‹
                record.isSynced = false;
                record.hasBeenSynced = false;
                
                // 5. å¯«å…¥æœ¬åœ°è³‡æ–™åº«
                const putRequest = store.put(record);
                
                putRequest.onsuccess = async function() {
                    console.log("æœ¬åœ°ç´€éŒ„å·²ä¿®è¨‚ï¼Œæº–å‚™åŒæ­¥...");
                    const s = JSON.parse(localStorage.getItem('studentProfile'));
                    
                    if (s) {
                        try {
                            const oldPath = `students/${s.grade}/${s.class}/${s.name}/history/${oldTimestamp}`;
                            await database.ref(oldPath).remove();
                        } catch (cloudErr) {
                            console.error("é›²ç«¯èˆŠæª”ç§»é™¤å¤±æ•—:", cloudErr);
                        }
                    }
                    
                    // èƒŒæ™¯åŸ·è¡ŒåŒæ­¥ï¼Œä¸é˜»æ“‹ UI
                    smartSyncHistory(); 
                    
                    // 6. å°‹æ‰¾æ–° ID ä¸¦åˆ·æ–°ä»‹é¢
                    const newId = await findIdByTimestamp(newTimestamp);
                    if (newId) {
                        lastGeneratedTimestamp = newTimestamp;
                        
                        // â˜…â˜…â˜… é—œéµï¼šé‡æ–°è¼‰å…¥è©³æƒ…ï¼Œé€™æœƒé‡å»º DOMï¼Œå¾è€Œç§»é™¤è½‰åœˆçš„æŒ‰éˆ• â˜…â˜…â˜…
                        await viewHistoryDetail(newId);
                        
                        // åˆ·æ–°åˆ—è¡¨ (å¦‚æœåœ¨èƒŒæ™¯é–‹å•Ÿ)
                        if (typeof currentSubFunctionFilter !== 'undefined' &&
                            document.getElementById('historyLevel3').style.display !== 'none') {
                            const themeIndex = typeof currentThemeIndex !== 'undefined' ? currentThemeIndex : 1;
                            enterHistoryList(currentSubFunctionFilter, themeIndex);
                        }
                        
                        alert("âœ… ä¿®è¨‚å·²å„²å­˜ï¼");
                    }
                };
            } else {
                alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åŸå§‹ç´€éŒ„ã€‚");
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalIcon;
                }
            }
        };
    } catch (e) {
        console.error("å„²å­˜å¤±æ•—:", e);
        alert("å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalIcon;
        }
    }
}
	
function closeHistoryModal() {
    document.getElementById('historyModal').style.display = 'none';
}


// === æ–°å¢ï¼šæ—¥æœŸæœå°‹åŠŸèƒ½ ===

// è§¸ç™¼æ—¥æœŸé¸æ“‡å™¨ (ç‚ºäº†ç¾è§€ï¼Œç”¨æŒ‰éˆ•è§¸ç™¼éš±è—çš„ input)
function triggerDatePicker() {
    const picker = document.getElementById('historyDatePicker');
    if (picker) {
        // å˜—è©¦é¡¯ç¤ºåŸç”Ÿæ—¥æœŸé¸æ“‡å™¨
        try {
            picker.showPicker(); 
        } catch (e) {
            picker.click(); // èˆŠç‰ˆç€è¦½å™¨ fallback
        }
    }
}

// åŸ·è¡Œæ²å‹•å®šä½é‚è¼¯
function scrollToHistoryDate(inputElement) {
    const selectedDateStr = inputElement.value; // æ ¼å¼: YYYY-MM-DD
    if (!selectedDateStr) return;

    // å°‡é¸æ“‡çš„æ—¥æœŸè½‰ç‚ºç•¶å¤©çš„çµæŸæ™‚é–“æˆ³ (23:59:59)
    // å› ç‚ºåˆ—è¡¨æ˜¯å¾æ–°åˆ°èˆŠæ’åˆ— (Descending)ï¼Œæˆ‘å€‘è¦æ‰¾çš„ç¬¬ä¸€å€‹ç´€éŒ„æ‡‰è©²æ˜¯
    // æ™‚é–“æˆ³å°æ–¼æˆ–ç­‰æ–¼ã€Œè©²æ—¥çµæŸã€çš„ç´€éŒ„
    const selectedDateEnd = new Date(selectedDateStr).setHours(23, 59, 59, 999);
    
    // ç²å–æ‰€æœ‰å·²æ¸²æŸ“çš„å¡ç‰‡
    const cards = document.querySelectorAll('#historyLevel3 .history-card');
    let targetCard = null;

    // ç§»é™¤æ‰€æœ‰èˆŠçš„é«˜äº®
    cards.forEach(c => c.classList.remove('highlighted'));

    // éæ­·å¡ç‰‡å°‹æ‰¾ç›®æ¨™
    for (let card of cards) {
        const timestamp = parseInt(card.getAttribute('data-timestamp'));
        
        // é‚è¼¯ï¼šå› ç‚ºå¡ç‰‡æ˜¯æŒ‰æ™‚é–“å€’åºæ’åˆ— (æœ€æ–°çš„åœ¨ä¸Šé¢)
        // æˆ‘å€‘è¦æ‰¾çš„æ˜¯ç¬¬ä¸€å€‹æ™‚é–“æˆ³ã€Œå°æ–¼æˆ–ç­‰æ–¼ã€é¸å®šæ—¥æœŸçµæŸæ™‚é–“çš„å¡ç‰‡
        // é€™ä»£è¡¨å®ƒæ˜¯è©²æ—¥æœŸ(æˆ–è©²æ—¥æœŸä¹‹å‰)æœ€æ–°çš„ä¸€æ¢ç´€éŒ„
        if (timestamp <= selectedDateEnd) {
            targetCard = card;
            break; // æ‰¾åˆ°å¾Œç«‹å³åœæ­¢
        }
    }

    if (targetCard) {
        // æ²å‹•åˆ°è©²å¡ç‰‡
        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // æ·»åŠ é«˜äº®æ•ˆæœ
        targetCard.classList.add('highlighted');
        
        // æª¢æŸ¥æ˜¯å¦å®Œå…¨åŒ¹é…ç•¶å¤© (ç”¨æ–¼æç¤º)
        const targetDate = new Date(parseInt(targetCard.getAttribute('data-timestamp')));
        const checkDateStr = targetDate.toISOString().split('T')[0];
        
        if (checkDateStr !== selectedDateStr) {
            // å¦‚æœæ‰¾åˆ°çš„å¡ç‰‡ä¸æ˜¯é¸å®šç•¶å¤©çš„(ä»£è¡¨é‚£å¤©æ²’ç´€éŒ„)ï¼Œæç¤ºä½¿ç”¨è€…
            // alert(`æ‰¾ä¸åˆ° ${selectedDateStr} çš„ç´€éŒ„ï¼Œå·²å®šä½è‡³æœ€æ¥è¿‘çš„éå¾€ç´€éŒ„ (${checkDateStr})ã€‚`);
            // ä¸Šæ–¹ alert å¯ä¾éœ€æ±‚é–‹å•Ÿæˆ–é—œé–‰ï¼Œé€šå¸¸ç›´æ¥å®šä½å³å¯
        }
    } else {
        alert("æ‰¾ä¸åˆ°è©²æ—¥æœŸæˆ–æ›´æ—©ä¹‹å‰çš„ç´€éŒ„ã€‚");
    }
}

	// === æ­·å²ç´€éŒ„ï¼šæ¨™é¡ŒåŸåœ°ç·¨è¼¯é‚è¼¯ ===

/**
 * å•Ÿç”¨æ¨™é¡Œç·¨è¼¯æ¨¡å¼
 * @param {HTMLElement} titleEl - è¢«é›™æ“Šçš„ h4 å…ƒç´ 
 * @param {number} id - ç´€éŒ„çš„ ID
 */
function enableTitleEditing(titleEl, id) {
    // é˜²æ­¢é‡è¤‡è§¸ç™¼ (å¦‚æœå·²ç¶“æ˜¯ input å°±ä¸å‹•ä½œ)
    if (titleEl.querySelector('input')) return;

    const currentText = titleEl.innerText;
    
    // å‰µå»º input å…ƒç´ 
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentText;
    input.className = 'history-title-input';
    
    // é»æ“Š input æ™‚ä¹Ÿè¦é˜²æ­¢å†’æ³¡ï¼Œä»¥å…è§¸ç™¼æŸ¥çœ‹è©³æƒ…
    input.onclick = (e) => e.stopPropagation();
    input.ondblclick = (e) => e.stopPropagation();

    // æ¸…ç©ºåŸæœ¬çš„æ¨™é¡Œæ–‡å­—ï¼Œæ”¾å…¥ input
    titleEl.innerHTML = '';
    titleEl.appendChild(input);
    input.focus();

    // å®šç¾©å„²å­˜ä¸¦é‚„åŸçš„é‚è¼¯
    const saveAndRevert = async () => {
        const newTitle = input.value.trim() || currentText; // å¦‚æœæ˜¯ç©ºçš„ï¼Œé‚„åŸèˆŠæ¨™é¡Œ
        
        if (newTitle !== currentText) {
            // å¦‚æœæ¨™é¡Œæœ‰è®Šæ›´ï¼Œå„²å­˜åˆ° DB
            await updateHistoryTitleInDB(id, newTitle);
        }
        
        // é‚„åŸç‚ºæ–‡å­—é¡¯ç¤º
        titleEl.innerText = newTitle;
    };

    // äº‹ä»¶ç›£è½ï¼šå¤±å»ç„¦é» (Blur) æˆ– æŒ‰ä¸‹ Enter éµæ™‚å„²å­˜
    input.addEventListener('blur', saveAndRevert);
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            this.blur(); // è§¸ç™¼ blur ä¾†å„²å­˜
        } else if (e.key === 'Escape') {
            // æŒ‰ Esc å–æ¶ˆç·¨è¼¯ï¼Œé‚„åŸèˆŠæ–‡å­—
            titleEl.innerText = currentText; 
        }
    });
}

// ==========================================
// === 3. èŠå¤©å®¤/è¿½å• å³æ™‚å­˜æª” (ä¿®å¾©ï¼šä¿ç•™è¼¸å…¥ä»‹é¢) ===
// ==========================================
async function updateHistoryChat() {
    if (!lastGeneratedTimestamp) {
        console.warn("æœªè¨­å®šæ™‚é–“æˆ³ï¼Œç„¡æ³•å„²å­˜å°è©±ã€‚");
        return;
    }
 
    // å°‹æ‰¾å…§å®¹ä¾†æº (å…¼å®¹ç•«å¸ƒèˆ‡æ­·å²è©³æƒ…è¦–çª—)
    let sourceElement = document.getElementById("resultCanvasBody");
    const isCanvasHidden = !sourceElement || sourceElement.style.display === 'none' || sourceElement.offsetParent === null || sourceElement.innerHTML.trim() === "";
    
    if (isCanvasHidden) {
        sourceElement = document.getElementById("historyModalContent");
    }
 
    if (!sourceElement) return;
    
    // è¤‡è£½ HTML é€²è¡Œæ¸…ç†
    const clone = sourceElement.cloneNode(true);
 
    // --- [ä¿®å¾©é‡é» A]ï¼šåªç§»é™¤ã€ŒèˆŠç‰ˆã€æˆ–ã€Œæš«æ™‚æ€§ã€çš„è¼¸å…¥æ¡†ï¼Œä¿ç•™ .canvas-input-area ---
    const tempInputAreas = clone.querySelectorAll('#writingGuideChatInputContainer, #writingChatInputContainer, #argumentChatInputContainer, #chatInputContainer');
    tempInputAreas.forEach(el => el.remove());
    
    // --- [ä¿®å¾©é‡é» B]ï¼šé‡å°ç•«å¸ƒèŠå¤©å®¤çš„è¼¸å…¥æ¡†ï¼Œåªæ¸…ç©ºæ•¸å€¼ï¼Œä¸ç§»é™¤å…ƒç´  ---
    const canvasInputs = clone.querySelectorAll('.canvas-input-area textarea');
    canvasInputs.forEach(el => {
        el.value = '';      // æ¸…ç©ºè¼¸å…¥å€¼
        el.innerHTML = '';  // æ¸…ç©º HTML å…§å®¹
        el.removeAttribute('disabled'); // ç¢ºä¿ä¸‹æ¬¡æ‰“é–‹å¯è¼¸å…¥
    });
 
    // --- [ä¿®å¾©é‡é» C]ï¼šç§»é™¤å…¶ä»–åŠŸèƒ½æŒ‰éˆ•ï¼Œä½†ã€Œä¿ç•™ã€ç™¼é€éµ (.canvas-send-btn) ---
    // é€™è£¡ä½¿ç”¨ :not() é¸æ“‡å™¨ä¾†æ’é™¤ç™¼é€æŒ‰éˆ•å’Œæ‡¸æµ®å„²å­˜æŒ‰éˆ•
    const buttons = clone.querySelectorAll('button:not(.canvas-send-btn):not(.morandi-save-float-btn), .btn-icon-action, .history-save-btn');
    buttons.forEach(el => el.remove());
 
    // ç¢ºä¿ç™¼é€æŒ‰éˆ•æ˜¯å•Ÿç”¨ç‹€æ…‹
    const sendBtns = clone.querySelectorAll('.canvas-send-btn');
    sendBtns.forEach(btn => btn.disabled = false);
 
    // è™•ç† Canvas åœ–è¡¨ (ä¿æŒä¸è®Š)
    const clonedCanvases = clone.querySelectorAll('canvas');
    clonedCanvases.forEach((canvas) => {
        canvas.style.width = '100%';
        canvas.style.height = '350px';
        canvas.style.display = 'block';
        canvas.removeAttribute('id');
    });
 
    const newAiContent = clone.innerHTML;
 
    try {
        const db = await openHistoryDB();
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const index = store.index('timestamp');
 
        const request = index.get(lastGeneratedTimestamp);
 
        request.onsuccess = function(event) {
            const data = event.target.result;
            if (data) {
                // A. æ›´æ–°å…§å®¹ (å¯«å…¥åŒ…å«æ–°æ°£æ³¡çš„ HTML)
                data.aiContent = newAiContent;
                
                // B. è¨­å®šåŒæ­¥ç‹€æ…‹
                data.isSynced = false;       // æ¨™è¨˜ç‚ºæœ¬åœ°è¼ƒæ–°
                data.hasBeenSynced = true;   // é˜²æ­¢è¢«èª¤åˆª
 
                const updateRequest = store.put(data);
                
                updateRequest.onsuccess = function() {
                    console.log("èŠå¤©ç´€éŒ„å·²æ›´æ–° (æº–å‚™ä¸Šå‚³)");
                    
                    // ç«‹å³è§¸ç™¼éœé»˜åŒæ­¥ï¼Œå°‡æœ€æ–°çš„å°è©±æ¨é€åˆ°é›²ç«¯
                    // æ³¨æ„ï¼šæ­¤è™•èª¿ç”¨ smartSyncHistory è€Œé syncHistoryToFirebase
                    if (typeof smartSyncHistory === 'function') {
                        smartSyncHistory();
                    }
                };
            }
        };
    } catch (e) {
        console.error("æ›´æ–°èŠå¤©ç´€éŒ„å¤±æ•—:", e);
    }
}

	
// === é›™æ“Š/å–®æ“Š è¡çªè§£æ±ºæ–¹æ¡ˆ ===
let titleClickTimer = null;

/**
 * è™•ç†æ¨™é¡Œçš„å–®æ“Šäº‹ä»¶ (å»¶é²è§¸ç™¼æŸ¥çœ‹)
 */
function handleTitleClick(event, id) {
    // 1. é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¸ç™¼çˆ¶å±¤çš„ç«‹å³æŸ¥çœ‹
    event.stopPropagation();

    // 2. å¦‚æœå·²ç¶“æœ‰è¨ˆæ™‚å™¨ï¼Œè¡¨ç¤ºé€™å¯èƒ½æ˜¯é›™æ“Šéç¨‹ä¸­çš„ç¬¬äºŒæ¬¡é»æ“Šï¼Œä¸åšè™•ç†
    if (titleClickTimer) return;

    // 3. è¨­å®šå»¶é²ï¼Œå¦‚æœ 250ms å…§æ²’æœ‰ç™¼ç”Ÿé›™æ“Šï¼Œæ‰æ‰“é–‹è¦–çª—
    titleClickTimer = setTimeout(() => {
        viewHistoryDetail(id);
        titleClickTimer = null;
    }, 250); 
}

/**
 * è™•ç†æ¨™é¡Œçš„é›™æ“Šäº‹ä»¶ (å–æ¶ˆæŸ¥çœ‹ï¼Œé€²å…¥ç·¨è¼¯)
 */
function handleTitleDblClick(element, id) {
    // 1. é˜»æ­¢äº‹ä»¶å†’æ³¡
    event.stopPropagation();

    // 2. é—œéµï¼šæ¸…é™¤å–®æ“Šç”¢ç”Ÿçš„è¨ˆæ™‚å™¨ï¼é€™æ¨£å°±ä¸æœƒå½ˆå‡ºè¦–çª—äº†
    if (titleClickTimer) {
        clearTimeout(titleClickTimer);
        titleClickTimer = null;
    }

    // 3. é€²å…¥ç·¨è¼¯æ¨¡å¼
    enableTitleEditing(element, id);
}




// 2. [ç™¼é€ç«¯åŠŸèƒ½] è€å¸«ç™¼é€é€šçŸ¥çš„å‡½å¼
// ç‚ºäº†å®‰å…¨ï¼Œå°‡ API KEY æ‹†åˆ†æ··æ·†ï¼Œé¿å…ç°¡å–®çš„çˆ¬èŸ²ç›´æ¥æŠ“å–
const _p1 = "os_v2_app_";
const _p2 = "7bo2joflvzgf5dnzzh2gh7eycxk5kn45q25uwymlyhqbq746uburtgfhd3xfyyxullklptksmnddfdwgpechno4byssraz7yysuusrq";
const _OS_KEY = _p1 + _p2;

/**
 * ç™¼é€æ¨æ’­é€šçŸ¥çµ¦æŒ‡å®šç­ç´š (è«‹åœ¨è€å¸«ç™¼ä½ˆèª²æ¥­çš„ä»£ç¢¼ä¸­èª¿ç”¨æ­¤å‡½å¼)
 * @param {string} targetGrade - å¹´ç´š (å¦‚ "4")
 * @param {string} targetClass - ç­åˆ¥ (å¦‚ "A")
 * @param {string} title - é€šçŸ¥æ¨™é¡Œ
 * @param {string} message - é€šçŸ¥å…§å®¹
 */
/**
* ç™¼é€æ¨æ’­é€šçŸ¥ (ç¶“ç”± GAS å¾Œç«¯ä»£ç†ï¼Œè§£æ±º CORS èˆ‡éš±ç§å•é¡Œ)
* @param {string} targetGrade - å¹´ç´š (å¦‚ "4")
* @param {string} targetClass - ç­åˆ¥ (å¦‚ "A")
* @param {string} title - é€šçŸ¥æ¨™é¡Œ
* @param {string} message - é€šçŸ¥å…§å®¹
*/
async function sendClassNotification(targetGrade, targetClass, title, message) {
    // 1. ç²å– Firebase Token (å› ç‚ºå¾Œç«¯æœ‰ verifyAuth ä¿è­·)
    const user = firebase.auth().currentUser;
    if (!user) {
        console.error("ç„¡æ³•ç™¼é€é€šçŸ¥ï¼šæœªç™»å…¥");
        return;
    }
    const token = await user.getIdToken();
 
    // 2. æ§‹å»º OneSignal çš„æ¨™æº– Payload
    const oneSignalData = {
        app_id: "f85da4b8-abae-4c5e-8db9-c9f463fc9815",
        headings: { en: title, zh: title },
        contents: { en: message, zh: message },
        // éæ¿¾æ¢ä»¶
        filters: [
            { field: "tag", key: "grade", relation: "=", value: targetGrade },
            { operator: "AND" },
            { field: "tag", key: "class", relation: "=", value: targetClass }
        ],
        // é»æ“Šé€šçŸ¥å¾Œæ‰“é–‹çš„ç¶²å€
        url: window.location.href
    };
 
    // 3. æ§‹å»ºç™¼é€çµ¦ GAS çš„ Payload
    const requestBody = {
        token: token,             // é€šéå¾Œç«¯é©—è­‰
        action: 'onesignal_proxy',// å‘Šè¨´å¾Œç«¯åŸ·è¡Œ OneSignal è½‰ç™¼
        data: oneSignalData       // å¯¦éš›è¦è½‰ç™¼çš„è³‡æ–™
    };
 
    // 4. ç™¼é€è«‹æ±‚åˆ°æ‚¨çš„ GAS (API_URL å·²ç¶“åœ¨æ‚¨çš„ä»£ç¢¼ä¸­å®šç¾©ç‚º CLOUDFLARE_WORKER_URL)
    // è¨»ï¼šé€™è£¡å‡è¨­ API_URL æŒ‡å‘çš„æ˜¯æ‚¨çš„ GAS Web App ç¶²å€
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // GAS æ…£ç”¨ text/plain ä»¥é¿å… OPTIONS é æª¢
            body: JSON.stringify(requestBody)
        });
 
        const data = await response.json();
        
        if (data.id) {
            console.log('OneSignal ç™¼é€æˆåŠŸ (Via Backend):', data);
        } else if (data.error) {
            console.error('OneSignal ç™¼é€å¤±æ•— (Backend Error):', data.error);
        } else {
            console.log('OneSignal å›æ‡‰:', data);
        }
 
    } catch (err) {
        console.error('é€£ç·š GAS å¾Œç«¯å¤±æ•—:', err);
    }
}

/**
 * ç™¼é€æ¨æ’­é€šçŸ¥çµ¦ç‰¹å®šå­¸ç”Ÿ (è«‹åœ¨è€å¸«ç™¼é‚„è©•èªçš„ä»£ç¢¼ä¸­èª¿ç”¨æ­¤å‡½å¼)
 * æ³¨æ„ï¼šé€™éœ€è¦ OneSignal çš„ External User ID åŠŸèƒ½ï¼Œæˆ–åˆ©ç”¨ Tag æ¨™è¨˜å€‹åˆ¥å­¸ç”Ÿ
 * é€™è£¡æ¼”ç¤ºåˆ©ç”¨ Tag æ¨™è¨˜å€‹åˆ¥å­¸ç”Ÿ (å‡è¨­ Tag åŒ…å« studentName)
 */
async function sendStudentNotification(studentName, title, message) {
    // æ‚¨éœ€è¦åœ¨ bindStudentIdentity ä¸­å¢åŠ  studentName çš„ Tag æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½
    // é€™è£¡åƒ…ä½œç¤ºä¾‹
}

	

// ==========================================
// === 1. é›²ç«¯æŒ‰éµ (ç™½é›²) èˆ‡ è¦–çª—æ§åˆ¶ ===
// ==========================================
 
// æ‰“é–‹ã€Œå­¸ç”Ÿé›²ç«¯ä¸­å¿ƒã€
function openStudentLoginModal() {
    const modal = document.getElementById('studentCloudModal');
    if (modal) {
        // 1. å¼·åˆ¶é—œé–‰å…¶ä»–å…¨è¢å¹•ä»‹é¢
        const containers = ['historyContainer', 'toolsContainer2', 'featuredContainer'];
        containers.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        });
 
        // éš±è—ä¸»é èƒŒæ™¯å…ƒç´ 
        document.querySelector('.title-container').style.display = 'none';
        document.getElementById('hitokoto-container').style.display = 'none';
        document.getElementById('mainMenuBox').style.display = 'none';
        document.getElementById('dse-countdown-box').style.display = 'none';
 
        // 2. é¡¯ç¤ºè¦–çª—
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // 3. åŸ·è¡Œç™»å…¥æª¢æŸ¥ & è¼‰å…¥èª²æ¥­ (ä½†ä¸åŒæ­¥æ­·å²)
        checkStudentLogin();
 
        // 4. UI æŒ‰éˆ•ç‹€æ…‹èª¿æ•´
        const cloudBtn = document.getElementById('sideMenuCloudBtn');
        if (cloudBtn) cloudBtn.style.display = 'none'; // åœ¨é›²ç«¯é é¢æ™‚éš±è—é›²ç«¯æŒ‰éˆ•
 
        const homeBtn = document.getElementById('sideMenuHomeBtn');
        if (homeBtn) homeBtn.style.display = 'flex';
 
        const floatHomeBtn = document.getElementById('homeBtn');
        if (floatHomeBtn) floatHomeBtn.style.display = 'none';
 
        // æ”¶èµ·å´é‚Šé¸å–®
        const sideMenu = document.getElementById('sideMenu');
        if (sideMenu) {
            sideMenu.classList.remove('active');
            document.getElementById('sideMenuToggle').classList.remove('active');
        }
    }
}
// === 2. ä¿®æ”¹é—œé–‰ã€Œå­¸ç”Ÿé›²ç«¯ä¸­å¿ƒã€çš„å‡½å¼ ===
function closeStudentCloudModal() {
    // ç›´æ¥å‘¼å« returnToHome()ï¼Œå®ƒæœƒè² è²¬ï¼š
    // 1. æ’­æ”¾é€€å ´å‹•ç•«
    // 2. éš±è—é›²ç«¯è¦–çª—
    // 3. é‡æ–°é¡¯ç¤ºä¸»é é¸å–®ã€æ¨™é¡Œã€DSEå€’æ•¸
    // 4. è§£é–é é¢æ²å‹•
    returnToHome();
}

// ==========================================
// === å…¨æ–°ä¿®è¨‚ï¼šå­¸ç”Ÿèº«ä»½è‡ªå‹•åŒæ­¥èˆ‡è½‰ç­è™•ç† ===
// ==========================================

// æª¢æŸ¥å­¸ç”Ÿç™»å…¥ç‹€æ…‹ & å•Ÿå‹•èª²æ¥­ç›£è½
async function checkStudentLogin() {
    // å˜—è©¦è®€å–æœ¬åœ°å­¸ç”Ÿæª”æ¡ˆ (ç™»å‡ºæ™‚ä¸å†åˆªé™¤æ­¤æª”æ¡ˆï¼Œæ‰€ä»¥é€šå¸¸æœƒæœ‰)
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    
    if (!s) {
        // å¦‚æœå®Œå…¨æ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºç™»å…¥è¡¨å–®
        document.getElementById('studentIdentityForm').style.display = 'block';
        document.getElementById('studentCloudPanel').style.display = 'none';
        return;
    }
 
    // æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºé›²ç«¯é¢æ¿
    document.getElementById('studentIdentityForm').style.display = 'none';
    document.getElementById('studentCloudPanel').style.display = 'block';
    updateWelcomeMessage(s);
    
    // æª¢æŸ¥ Firebase Auth ç‹€æ…‹ (æ˜¯å¦éæœŸ)
    // æˆ‘å€‘åªåœ¨ Auth æº–å‚™å¥½æ™‚è§¸ç™¼ã€Œèª²æ¥­è¼‰å…¥ã€
    // â˜…â˜…â˜… é—œéµï¼šé€™è£¡åªè¼‰å…¥èª²æ¥­ï¼Œä¸åŒæ­¥æ­·å² â˜…â˜…â˜…
    try {
        // å¦‚æœ Auth æœªåˆå§‹åŒ–ï¼Œç­‰å¾…ä¸€ä¸‹
        let authWait = 0;
        while (!auth.currentUser && authWait < 5) {
            await new Promise(r => setTimeout(r, 200));
            authWait++;
        }
 
        if (auth.currentUser) {
            // å·²é€£ç·šï¼šè¼‰å…¥èª²æ¥­åˆ—è¡¨
            await loadAssignments(s.grade, s.class);
            
            // å•Ÿå‹•ç´…é»ç›£è½ (å¦‚æœæœ‰æœªäº¤åŠŸèª²)
            monitorPendingAssignments();
            
            // â˜…â˜…â˜… é€™è£¡å•Ÿå‹•ã€ŒçœæµåŒæ­¥ã€ï¼Œåªåœ¨èƒŒæ™¯åŸ·è¡Œï¼Œä¸é˜»æ“‹ UI â˜…â˜…â˜…
            smartSyncHistory();
        } else {
            console.log("è™•æ–¼é›¢ç·šæˆ–æœªé©—è­‰ç‹€æ…‹ï¼Œé¡¯ç¤ºæœ¬åœ°ç·©å­˜çš„ä»‹é¢");
            // å³ä½¿æ²’é€£ç·šï¼Œä¹Ÿå¯ä»¥é¡¯ç¤ºä»‹é¢ï¼Œä½†ä¸è¼‰å…¥æ–°èª²æ¥­
        }
 
    } catch (err) {
        console.error("ç™»å…¥æª¢æŸ¥éŒ¯èª¤:", err);
    }
}

	
// 2. è¼”åŠ©å‡½å¼ï¼šæ›´æ–°æ­¡è¿æ–‡å­—
// 2. è¼”åŠ©å‡½å¼ï¼šæ›´æ–°æ­¡è¿æ–‡å­— (å„ªåŒ–é¡¯ç¤ºç‰ˆ)
function updateWelcomeMessage(profile) {
    let displayStr = '';
    
    // å¦‚æœæ˜¯è€å¸« (System/Test)ï¼Œé¡¯ç¤ºç‰¹æ®Šæ ¼å¼
    if (profile.grade === 'System') {
        displayStr = `ç³»çµ±æ¸¬è©¦ - ${profile.name}`;
    } else {
        // å¦‚æœæ˜¯å­¸ç”Ÿï¼Œé¡¯ç¤ºæ­£å¸¸æ ¼å¼
        const numDisplay = profile.number ? `(${profile.number})` : '';
        displayStr = `${profile.grade}${profile.class} ${numDisplay} - ${profile.name}`;
    }

    document.getElementById('welcomeText').innerHTML = 
        `ä½ å¥½ï¼Œ${displayStr} 
         <span style="font-size:0.8em; color:#ccc; margin-left:5px;" id="syncStatusIcon"></span>`;
}

// 3. ã€æ ¸å¿ƒæ–°å¢ã€‘é©—è­‰å­¸ç”Ÿç‹€æ…‹ (åŒæ­¥è³‡æ–™ + è™•ç†è½‰ç­ + è™•ç†å¸³è™Ÿå¤±æ•ˆ)
// === 1. åš´æ ¼é©—è­‰å‡½å¼ (é˜²æ­¢å¯«å…¥å¹½éˆè³‡æ–™) ===
async function verifyStudentStatus(localProfile) {
    const statusIcon = document.getElementById('syncStatusIcon');
    if(statusIcon) statusIcon.innerHTML = '<i class="fas fa-sync fa-spin"></i>'; 

    // è·¯å¾‘ï¼šstudents/Grade/Class/Name/profile
    const path = `students/${localProfile.grade}/${localProfile.class}/${localProfile.name}/profile`;

    try {
        const snapshot = await database.ref(path).once('value');
        const cloudData = snapshot.val();

        if (cloudData) {
            // A. è³‡æ–™å­˜åœ¨ï¼Œæª¢æŸ¥ç­è™Ÿæ˜¯å¦ç‚ºç©º
            if (!cloudData.number || cloudData.number === "") {
                // â˜…â˜…â˜… è§¸ç™¼ï¼šç­è™Ÿè¼¸å…¥è«‹æ±‚ â˜…â˜…â˜…
                promptForNewClassNumber(localProfile, path);
            } 
            else if (cloudData.number != localProfile.number) {
                // ç­è™Ÿå­˜åœ¨ä½†ä¸ä¸€æ¨£ (ä¾‹å¦‚è€å¸«æ‰‹å‹•æ”¹äº†)ï¼ŒåŒæ­¥æœ¬åœ°
                localProfile.number = cloudData.number;
                localStorage.setItem('studentProfile', JSON.stringify(localProfile));
                updateWelcomeMessage(localProfile);
            }
            if(statusIcon) statusIcon.innerHTML = ''; 
        } else {
            // B. è³‡æ–™ä¸å­˜åœ¨ (å¯èƒ½å‡ç­äº†)ï¼ŒåŸ·è¡Œå…¨æ ¡æœå°‹
            console.warn("åŸè·¯å¾‘æ‰¾ä¸åˆ°è³‡æ–™ï¼Œå•Ÿå‹•å…¨æ ¡æœå°‹...");
            findStudentNewLocation(localProfile.name);
        }
    } catch (error) {
        console.error("åŒæ­¥æª¢æŸ¥å¤±æ•—:", error);
    }
}

// === æ–°å¢ï¼šç­è™Ÿè¼¸å…¥ä»‹é¢ ===
// === 1. æš«å­˜è®Šæ•¸ï¼Œç”¨æ–¼è·¨å‡½å¼å‚³éè³‡æ–™ ===
let pendingUpdateProfile = null;
let pendingUpdatePath = null;

// === 2. é¡¯ç¤ºç­è™Ÿæ›´æ–°è¦–çª— (å–ä»£åŸæœ¬çš„ prompt) ===
function promptForNewClassNumber(profile, firebasePath) {
    // å„²å­˜è³‡æ–™ä»¥ä¾¿ç¢ºèªæ™‚ä½¿ç”¨
    pendingUpdateProfile = profile;
    pendingUpdatePath = firebasePath;

    // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–® (1-35)
    const select = document.getElementById('newClassNumberSelect');
    select.innerHTML = '';
    for (let i = 1; i <= 35; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.innerText = i;
        select.appendChild(opt);
    }

    // é¡¯ç¤ºè¦–çª— (å¼·åˆ¶æœ€ä¸Šå±¤)
    const modal = document.getElementById('classNumberUpdateModal');
    if (modal) {
        // â˜… å¼·åˆ¶æ¬é‹åˆ° body æœ€å¤–å±¤ï¼Œé˜²æ­¢è¢«é®æ“‹ â˜…
        document.body.appendChild(modal);
        
        modal.style.display = 'flex';
    }
}

// === 3. ç¢ºèªæ›´æ–°ç­è™Ÿ (é»æ“ŠæŒ‰éˆ•è§¸ç™¼) ===
async function confirmClassNumberUpdate() {
    const select = document.getElementById('newClassNumberSelect');
    const newNum = select.value;
    const modal = document.getElementById('classNumberUpdateModal');
    const btn = modal.querySelector('button');

    // UI é–å®š
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ›´æ–°ä¸­...';

    try {
        // å¯«å…¥ Firebase
        await database.ref(pendingUpdatePath).update({ number: newNum });
        
        // æ›´æ–°æœ¬åœ°å„²å­˜
        pendingUpdateProfile.number = newNum;
        localStorage.setItem('studentProfile', JSON.stringify(pendingUpdateProfile));
        
        // åˆ·æ–°æ­¡è¿èª
        updateWelcomeMessage(pendingUpdateProfile);

        // é—œé–‰è¦–çª—
        modal.style.display = 'none';
        alert(`âœ… ç­è™Ÿå·²æ›´æ–°ç‚ºï¼š${newNum}`);

    } catch (err) {
        alert("æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡ã€‚\n" + err.message);
    } finally {
        btn.disabled = false;
        btn.innerText = 'ç¢ºèªæ›´æ–°';
    }
}

// (èˆŠçš„ fallbackï¼Œå‚™ç”¨)
function fallbackPrompt(profile, firebasePath) {
    let newNum = window.prompt(`ğŸ‘‹ æ–°å­¸å¹´å¥½ï¼\nè«‹è¼¸å…¥æ‚¨åœ¨ ${profile.grade}${profile.class} ç­çš„æ–°ç­è™Ÿ (1-35)ï¼š`);
    if (newNum && !isNaN(newNum)) {
        database.ref(firebasePath).update({ number: newNum });
        profile.number = newNum;
        localStorage.setItem('studentProfile', JSON.stringify(profile));
        updateWelcomeMessage(profile);
        alert("âœ… ç­è™Ÿå·²æ›´æ–°ï¼");
    }
}

// === 2. å…¨æ ¡æœå°‹å‡½å¼ (è™•ç†å‡ç­èˆ‡åˆªé™¤) ===
// ===============================================================
// === [æ ¸å¿ƒä¿®å¾©] è‡ªå‹•è½‰ç­èˆ‡ç­è™Ÿè¦–çª—å³æ™‚å½ˆå‡ºé‚è¼¯ ===
// ===============================================================

// 1. è¦†å¯«ï¼šå…¨æ ¡æœå°‹å‡½å¼ (ç§»é™¤é‡æ–°æ•´ç†ï¼Œæ”¹ç‚ºå³æ™‚å½ˆçª—)
// === ä¿®æ­£ç‰ˆï¼šæœå°‹å­¸ç”Ÿæ–°ä½ç½® (åªæŸ¥ç´¢å¼•ï¼Œç¦æ­¢å…¨åº«æƒæ) ===
async function findStudentNewLocation(studentName) {
    // å› ç‚ºæˆ‘å€‘ç„¡æ³•å†é€²è¡Œå…¨æ ¡æƒæ (Rules å·²ç¦æ­¢)ï¼Œ
    // æˆ‘å€‘åªèƒ½ä¾è³´ email_mappingã€‚å¦‚æœ email_mapping ä¹Ÿæ²’è³‡æ–™ï¼Œ
    // å°±åªèƒ½æç¤ºå­¸ç”Ÿé‡æ–°ç™»å…¥ä¸¦è¼¸å…¥æ­£ç¢ºè³‡æ–™ã€‚
    
    // å˜—è©¦å¾æœ¬åœ°ç·©å­˜çš„ Profile ä¸­ç²å–é›»éƒµä¾†æŸ¥ç´¢å¼•
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    
    if (s && s.email) {
        const newProfile = await findProfileByEmail(s.email);
        
        if (newProfile) {
            // åœ¨ç´¢å¼•ä¸­æ‰¾åˆ°äº† (å¯èƒ½æ˜¯åˆ¥è™•ç™»å…¥éå»ºç«‹äº†ç´¢å¼•)
            localStorage.setItem('studentProfile', JSON.stringify(newProfile));
            
            // æ¸…ç©ºèˆŠçš„æœ¬åœ°ç´€éŒ„
            try {
                const db = await openHistoryDB();
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.clear();
            } catch (e) {}
 
            alert(`ğŸ‘‹ æ­¡è¿å›ä¾†ï¼\nç³»çµ±åµæ¸¬åˆ°æ‚¨çš„è³‡æ–™ä½ç½®å·²æ›´æ–°ã€‚\n\næ–°ä½ç½®ï¼š${newProfile.grade}${newProfile.class} ç­\n(èˆŠç´€éŒ„å·²å°å­˜)`);
            
            updateWelcomeMessage(newProfile);
            loadAssignments(newProfile.grade, newProfile.class);
            monitorPendingAssignments();
            startAutoSyncListener();
            
            // å½ˆå‡ºç­è™Ÿç¢ºèª
            const newPath = `students/${newProfile.grade}/${newProfile.class}/${newProfile.name}/profile`;
            promptForNewClassNumber(newProfile, newPath);
            return;
        }
    }
 
    // å¦‚æœç´¢å¼•ä¹Ÿæ²’æœ‰ (çœŸçš„æ‰¾ä¸åˆ°)ï¼Œå‰‡æç¤ºé‡æ–°ç™»å…¥
    console.warn("ç„¡æ³•å®šä½å­¸ç”Ÿä½ç½® (å…¨åº«æƒæå·²ç¦ç”¨)ã€‚");
    alert("âš ï¸ ç³»çµ±è³‡æ–™åº«å·²æ›´æ–°æˆ–æ‰¾ä¸åˆ°æ‚¨çš„ä½ç½®ã€‚\n\nè«‹é‡æ–°ç™»å…¥ï¼Œä¸¦ç¢ºä¿é¸æ“‡æ­£ç¢ºçš„ã€Œå¹´ç´šã€èˆ‡ã€Œç­åˆ¥ã€ã€‚");
    handleStudentLogout();
}
// 2. è¦†å¯«ï¼šè‡ªå‹•åŒæ­¥ç›£è½å™¨ (æ–°å¢ Profile ç›£è½ï¼Œå¯¦ç¾è‡ªå‹•è§¸ç™¼);


	
// 1. åˆå§‹åŒ–ç­è™Ÿé¸é … (è«‹æ”¾åœ¨ initDSECalendar æˆ– DOMContentLoaded å…§åŸ·è¡Œï¼Œæˆ–æ˜¯ç›´æ¥æ”¾åœ¨ script æœ€å¾Œ)
function initClassNumbers() {
    const select = document.getElementById('studentNumber');
    if (!select) return;
    select.innerHTML = '';
    for (let i = 1; i <= 32; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.innerText = i; // é¡¯ç¤ºæ•¸å­—
        select.appendChild(opt);
    }
}
// å‘¼å«åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initClassNumbers);




// === æ–°å¢ï¼šå­¸æ ¡é›»éƒµç™»å…¥è™•ç†å‡½å¼ ===
async function handleSchoolLogin() {
    // 1. ç²å–ç”¨æˆ¶è¼¸å…¥çš„è³‡æ–™
    const manualName = document.getElementById('studentNameInput').value.trim();
    const grade = document.getElementById('studentGrade').value;
    const cls = document.getElementById('studentClass').value;
    const number = document.getElementById('studentNumber').value;
    
    // 2. é©—è­‰å§“å
    if (!manualName) {
        alert("è«‹å‹™å¿…å¡«å¯«æ‚¨çš„ã€Œä¸­æ–‡å§“åã€æ‰èƒ½é€²è¡Œè¨»å†Šï¼");
        document.getElementById('studentNameInput').focus();
        return;
    }

    const btn = event ? (event.target.tagName === 'BUTTON' ? event.target : event.target.closest('button')) : null;
    let originalContent = "";
    if (btn) {
        originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é©—è­‰ä¸­...';
        btn.disabled = true;
    }

    // æš«å­˜è³‡æ–™
    const tempStudentData = { manualName, grade, cls, number };
    sessionStorage.setItem('sansi_temp_student_data', JSON.stringify(tempStudentData));

    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    try {
        // â˜… æ ¸å¿ƒä¿®è¨‚ï¼šè¨­å®šæŒä¹…åŒ–ï¼Œç¢ºä¿ç™»å…¥ç‹€æ…‹å¯«å…¥ç¡¬ç¢Ÿ
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        // ä½¿ç”¨ Popup ç™»å…¥
        const result = await auth.signInWithPopup(provider);
        await processLoginResult(result.user, btn, originalContent);

    } catch (error) {
        console.error("ç™»å…¥éŒ¯èª¤:", error);
        if (error.code === 'auth/popup-blocked') {
            alert("âš ï¸ ç™»å…¥è¦–çª—è¢«ç€è¦½å™¨é˜»æ“‹ã€‚\n\nè«‹å…è¨±æ­¤ç¶²ç«™é¡¯ç¤ºå½ˆå‡ºå¼è¦–çª—ï¼Œæˆ–å˜—è©¦ä½¿ç”¨ Chrome ç€è¦½å™¨ã€‚");
        } else if (error.code !== 'auth/popup-closed-by-user') {
            alert("ç™»å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
        }
        if (btn) {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }
}


// === [ä¿®æ­£ç‰ˆ] å…¨æ ¡é›»éƒµæœå°‹å‡½å¼ (åªæŸ¥ç´¢å¼•è¡¨ï¼Œæ¥µé€Ÿä¸”çœæµé‡) ===
async function findProfileByEmail(targetEmail) {
    try {
        // 1. å°‡é›»éƒµè½‰ç‚º Base64 (å› ç‚ºä½ çš„ email_mapping æ˜¯ç”¨ Base64 ç•¶ Key)
        const emailKey = btoa(targetEmail);
        
        // 2. ç›´æ¥è®€å– email_mapping ä¸‹çš„ç‰¹å®šç¯€é»
        // é€™åªæœƒä¸‹è¼‰è©²ç”¨æˆ¶çš„ Profileï¼Œä¸æœƒä¸‹è¼‰ Historyï¼Œä¹Ÿä¸æœƒä¸‹è¼‰å…¶ä»–äººçš„è³‡æ–™
        const snapshot = await database.ref(`email_mapping/${emailKey}`).once('value');
        const profile = snapshot.val();
        
        if (profile) {
            console.log("âœ… é€éç´¢å¼•è¡¨å¿«é€Ÿæ‰¾åˆ°ç”¨æˆ¶:", profile.name);
            return profile; // å›å‚³è©²å­¸ç”Ÿçš„åŸºæœ¬è³‡æ–™
        }
 
        // 3. å¦‚æœç´¢å¼•è¡¨æ‰¾ä¸åˆ°ï¼Œæˆ‘å€‘ **çµ•å°ä¸è¦** æƒæå…¨æ ¡è³‡æ–™åº« ('students')
        // ç›´æ¥å›å‚³ nullï¼Œè®“ç³»çµ±æ”¹ç”¨ã€Œæ‰‹å‹•è¼¸å…¥çš„ç­ç´šå§“åã€å»å˜—è©¦ç™»å…¥
        console.log("ç´¢å¼•è¡¨ä¸­æœªæ‰¾åˆ°æ­¤é›»éƒµï¼Œè¦–ç‚ºæ–°ç”¨æˆ¶æˆ–éœ€æ‰‹å‹•é©—è­‰ã€‚");
        return null;
 
    } catch (error) {
        console.error("æœå°‹é›»éƒµå¤±æ•—:", error);
        return null;
    }
}

	

// === ä¿®æ­£ç‰ˆï¼šè™•ç†ç™»å…¥çµæœ (å·²æ›´æ›ç‚º Smart Sync) ===
async function processLoginResult(user, btn, originalContent) {
    let manualName, grade, cls, number;
    const storedData = sessionStorage.getItem('sansi_temp_student_data');
    if (storedData) {
        const data = JSON.parse(storedData);
        manualName = data.manualName; grade = data.grade; cls = data.cls; number = data.number;
    } else {
        manualName = document.getElementById('studentNameInput')?.value.trim();
        grade = document.getElementById('studentGrade')?.value;
        cls = document.getElementById('studentClass')?.value;
        number = document.getElementById('studentNumber')?.value;
    }
    
    if (!manualName) {
        alert("è³‡æ–™éºå¤±ï¼Œè«‹é‡æ–°è¼¸å…¥å§“åã€‚");
        if (btn) { btn.innerHTML = originalContent; btn.disabled = false; }
        return;
    }
 
    const email = user.email;
    let isTeacher = false;
    let isSpecialUser = false;
 
    try {
        const safeEmailKey = email.replace(/\./g, ',');
 
        const [teacherSnap, specialSnap] = await Promise.all([
            database.ref(`teachers/${safeEmailKey}`).once('value'),
            database.ref(`special_users/${safeEmailKey}`).once('value')
        ]);
 
        if (teacherSnap.exists() && teacherSnap.val() === true) {
            isTeacher = true;
        } else if (specialSnap.exists() && specialSnap.val() === true) {
            isSpecialUser = true;
            grade = "Special";
            cls = "User";
        }
        else {
            const DEBUG_USER = atob('a2VuY2hhbjIwMTQxQGdtYWlsLmNvbQ==');
            if (email === DEBUG_USER) {
                isTeacher = true;
            }
        }
 
        if (!isTeacher && !isSpecialUser) {
            if (!email.endsWith('@ccckyc.edu.hk')) {
                await auth.signOut();
                alert("â›” é©—è­‰å¤±æ•—ï¼\næ­¤é›»éƒµä¸åœ¨å…è¨±åå–®å…§ã€‚");
                sessionStorage.removeItem('sansi_temp_student_data');
                if (btn) { btn.innerHTML = originalContent; btn.disabled = false; }
                return;
            }
        }
 
    } catch (err) {
        console.error("æ¬Šé™æª¢æŸ¥éŒ¯èª¤:", err);
        if (!email.endsWith('@ccckyc.edu.hk')) {
            alert("ç³»çµ±é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•é©—è­‰æ¬Šé™ã€‚");
            if (btn) { btn.innerHTML = originalContent; btn.disabled = false; }
            return;
        }
    }
 
    if (isTeacher) { grade = "System"; cls = "Test"; number = "99"; alert("ğŸ‘‹ è€å¸«æ‚¨å¥½ï¼Œé€²å…¥æ¸¬è©¦ç­ã€‚"); }
    if (isSpecialUser) { alert("ğŸ‘‹ æ­¡è¿ç‰¹è¨±ç”¨å®¶ã€‚"); }
 
    // --- æœå°‹èˆŠè³‡æ–™ ---
    let existingProfile = await findProfileByEmail(email);
    
    if (!existingProfile) {
        const inputPath = `students/${grade}/${cls}/${manualName}/profile`;
        try {
            const snap = await database.ref(inputPath).once('value');
            if (snap.exists() && snap.val().email === email) {
                existingProfile = snap.val();
                database.ref('email_mapping/' + btoa(email)).set(existingProfile);
            }
        } catch(e) {}
    }
 
    if (existingProfile) {
        const oldLocation = `${existingProfile.grade}${existingProfile.class}`;
        const newLocation = `${grade}${cls}`;
        
        if (oldLocation !== newLocation && !isTeacher && !isSpecialUser) {
            alert(`âš ï¸ åµæ¸¬åˆ°æ­¤é›»éƒµå·²è¨»å†Šæ–¼ã€${oldLocation}ç­ã€‘ã€‚\nç³»çµ±å°‡ç™»å…¥æ‚¨çš„åŸæœ‰å¸³è™Ÿã€‚`);
        }
        
        if ((isTeacher && (existingProfile.grade !== "System" || existingProfile.class !== "Test")) ||
            (isSpecialUser && (existingProfile.grade !== "Special" || existingProfile.class !== "User"))) {
             await bindStudentIdentity(grade, cls, number, manualName, email, user.uid);
        } else {
             localStorage.setItem('studentProfile', JSON.stringify(existingProfile));
             updateWelcomeMessage(existingProfile);
             // ç™»å…¥å¾Œè¼‰å…¥èª²æ¥­ (ä¸å«æ­·å²)
             loadAssignments(existingProfile.grade, existingProfile.class);
        }
        
        sessionStorage.removeItem('sansi_temp_student_data');
        document.getElementById('studentIdentityForm').style.display = 'none';
        document.getElementById('studentCloudPanel').style.display = 'block';
        monitorPendingAssignments();
        
        // â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šæ”¹ç‚ºå‘¼å«æ–°çš„çœæµåŒæ­¥ â˜…â˜…â˜…
        await smartSyncHistory();
        
        startAutoSyncListener();
    } else {
        // æ–°ç”¨æˆ¶è¨»å†Š
        await bindStudentIdentity(grade, cls, number, manualName, email, user.uid);
        sessionStorage.removeItem('sansi_temp_student_data');
        
        // â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šæ”¹ç‚ºå‘¼å«æ–°çš„çœæµåŒæ­¥ â˜…â˜…â˜…
        await smartSyncHistory();
        
        startAutoSyncListener();
    }
}

// === æ–°å¢ï¼šå­¸ç”Ÿç™»å‡ºè™•ç†å‡½å¼ ===
async function handleStudentLogout() {
    if (!confirm("ç¢ºå®šè¦ç™»å‡ºå­¸ç”Ÿå¸³è™Ÿå—ï¼Ÿ\n(ç™»å‡ºå¾Œä¸‹æ¬¡éœ€è¦é‡æ–°è¼¸å…¥å§“åé©—è­‰)")) {
        return;
    }

	 // â˜…â˜…â˜… [æ–°å¢] OneSignal æ¨™ç±¤ç§»é™¤ â˜…â˜…â˜…
    if (window.OneSignalDeferred) {
        window.OneSignalDeferred.push(function(OneSignal) {
            // ç§»é™¤å¹´ç´šå’Œç­åˆ¥æ¨™ç±¤ï¼Œåœæ­¢æ¥æ”¶è©²ç­é€šçŸ¥
            OneSignal.User.removeTags(["grade", "class"]);
        });
    }
    // â˜…â˜…â˜… [æ–°å¢çµæŸ] â˜…â˜…â˜…


	 // â˜…â˜…â˜… æ–°å¢ï¼šç§»é™¤ç´…é»ç›£è½ â˜…â˜…â˜…
    if (pendingMonitorRef) {
        pendingMonitorRef.off();
        pendingMonitorRef = null;
    }
    const badge = document.getElementById('notifBadge');
    if(badge) badge.style.display = 'none';
    // â˜…â˜…â˜… æ–°å¢çµæŸ â˜…â˜…â˜…

    try {
        // 1. Firebase ç™»å‡º
        await firebase.auth().signOut();
    } catch (e) {
        console.error("Firebase ç™»å‡ºéŒ¯èª¤ (å¯å¿½ç•¥):", e);
    }

    // 2. æ¸…é™¤æœ¬åœ°å­¸ç”Ÿè³‡æ–™
    localStorage.removeItem('studentProfile');
    
    // 3. æ¸…é™¤ç›¸é—œçš„èª²æ¥­ç·©å­˜ (é€™è£¡ä½¿ç”¨è¬ç”¨å­—å…ƒæ¸…é™¤è©²ä½¿ç”¨è€…çš„ç·©å­˜è¼ƒé›£ï¼Œæš«æ™‚æ¸…é™¤ç•¶å‰é é¢ç‹€æ…‹å³å¯)
    // è‹¥æ‚¨æœ‰ç‰¹å®šçš„ç·©å­˜å‘½åè¦å‰‡ï¼Œå¯åœ¨é€™è£¡ä¸€ä½µç§»é™¤

    // 4. UI ç•Œé¢é‡ç½®
    document.getElementById('studentCloudPanel').style.display = 'none';
    document.getElementById('studentIdentityForm').style.display = 'block';
    
    // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
    const loginBtn = document.querySelector('#studentIdentityForm button');
    if (loginBtn) {
        loginBtn.innerHTML = '<i class="fab fa-google"></i> å­¸æ ¡å¸³è™Ÿç™»å…¥';
        loginBtn.disabled = false;
    }

    // é‡ç½®è¼¸å…¥æ¡† (é¸æ“‡æ€§)
    document.getElementById('studentNameInput').value = '';
    
    // 5. æç¤ºè¨Šæ¯
    alert("å·²æˆåŠŸç™»å‡ºï¼");
}

	
// === ä¿®æ­£ç‰ˆï¼šç¶å®šå­¸ç”Ÿè³‡æ–™ (å·²æ›´æ›ç‚º Smart Sync) ===
async function bindStudentIdentity(grade, cls, number, name, email, uid) {
    const path = `students/${grade}/${cls}/${name}/profile`;
    const emailKey = btoa(email);
    const profileData = {
        name: name, grade: grade, class: cls, number: number, email: email, uid: uid,
        last_login: new Date().toLocaleString('zh-HK'), status: 'active'
    };
    try {
        const updates = {};
        updates[path] = profileData;
        updates[`email_mapping/${emailKey}`] = profileData;
        await database.ref().update(updates);
        localStorage.setItem('studentProfile', JSON.stringify(profileData));
        if (window.OneSignalDeferred) {
            window.OneSignalDeferred.push(function(OneSignal) {
                OneSignal.User.addTags({ grade: grade, class: cls, userType: 'student' });
            });
        }
        alert(`âœ… é©—è­‰æˆåŠŸï¼\n\næ­¡è¿ä½ ï¼Œ${name}ã€‚`);
        document.getElementById('studentIdentityForm').style.display = 'none';
        document.getElementById('studentCloudPanel').style.display = 'block';
        updateWelcomeMessage(profileData);
        loadAssignments(grade, cls);
    } catch (error) {
        console.error("è³‡æ–™åº«å¯«å…¥å¤±æ•—:", error);
        alert("è³‡æ–™åº«éŒ¯èª¤ï¼Œè«‹é‡è©¦: " + error.message);
    }
}
	
// 3. è¼”åŠ©å‡½å¼ï¼šå®Œæˆç™»å…¥ (æ›´æ–°æœ¬åœ°å„²å­˜)
function finishLogin(grade, cls, number, name) {
    const profile = { grade, class: cls, number, name };
    localStorage.setItem('studentProfile', JSON.stringify(profile));
    checkStudentLogin();
    
    // é‡ç½®æŒ‰éˆ•
    const btn = document.querySelector('#studentIdentityForm button');
    if(btn) { btn.innerHTML = 'ç¶å®šèº«ä»½'; btn.disabled = false; }
}


async function loadAssignments(grade, cls) {
    const listDiv = document.getElementById('assignmentList');
    
    // 1. é¡¯ç¤ºè¼‰å…¥ä¸­ (åƒ…åœ¨ç¬¬ä¸€æ¬¡)
    if (listDiv.innerHTML.trim() === "" || listDiv.innerHTML.includes("è¼‰å…¥ä¸­")) {
        listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#8fa398;"><i class="fas fa-circle-notch fa-spin"></i> æ­£åœ¨æ›´æ–°èª²æ¥­ç‹€æ…‹...</div>';
    }
 
    try {
        const path = `assignments/${grade}/${cls}`;
        
        // ä½¿ç”¨ .on() é€²è¡Œå¯¦æ™‚ç›£è½
        // å„ªé»ï¼šåªæœƒåœ¨æ•¸æ“šè®Šæ›´æ™‚ä¸‹è¼‰ Deltaï¼Œä¸ç”¨æ¯æ¬¡é‡æ–°ä¸‹è¼‰å…¨éƒ¨
        database.ref(path).on('value', (snapshot) => {
            const assignmentsData = snapshot.val();
 
            if (!assignmentsData) {
                listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">ç›®å‰æ²’æœ‰æ–°èª²æ¥­</div>';
                return;
            }
 
            // æ›´æ–°å…¨åŸŸè®Šæ•¸ (ä¾›åˆ†é ç”¨)
            allAssignmentTasks = Object.entries(assignmentsData).sort((a, b) => b[1].timestamp - a[1].timestamp);
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨ (é€™æœƒè‡ªå‹•æª¢æŸ¥ assignments_submissions çš„ç‹€æ…‹)
            // é€™è£¡æˆ‘å€‘é‡ç½®è¨ˆæ•¸ä¸¦é‡æ–°è¼‰å…¥ç¬¬ä¸€æ‰¹ï¼Œç¢ºä¿ç‹€æ…‹æœ€æ–°
            currentLoadedCount = 0;
            listDiv.innerHTML = '';
            loadNextBatchAssignments();
        });
 
    } catch (error) {
        console.error("èª²æ¥­è¼‰å…¥å¤±æ•—:", error);
        listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#d69a92;">é€£ç·šå•é¡Œï¼Œç„¡æ³•æ›´æ–°èª²æ¥­ç‹€æ…‹ (ä½†æ‚¨ä»å¯æŸ¥çœ‹æ­·å²ç´€éŒ„)</div>';
    }
}
	// === æ ¸å¿ƒï¼šåˆ†æ‰¹è¼‰å…¥è©³ç´°æ•¸æ“š ===
async function loadNextBatchAssignments() {
    const listDiv = document.getElementById('assignmentList');
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    
    // 1. æª¢æŸ¥æ˜¯å¦é‚„æœ‰æ›´å¤šè³‡æ–™
    if (currentLoadedCount >= allAssignmentTasks.length) {
        return; 
    }

    // 2. é¡¯ç¤ºå±€éƒ¨ Loading (æ”¾åœ¨åˆ—è¡¨åº•éƒ¨)
    let loadingDiv = document.createElement('div');
    loadingDiv.id = 'batchLoading';
    loadingDiv.style.cssText = "text-align:center; padding:10px; color:#aaa; font-size:0.9em;";
    loadingDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> è®€å–ä¸­...';
    listDiv.appendChild(loadingDiv);

    // 3. åˆ‡ç‰‡ï¼šå–å‡ºæ¥ä¸‹ä¾†çš„ 5 ä»½ (ä¾‹å¦‚ 0-5, 5-10)
    const nextBatch = allAssignmentTasks.slice(currentLoadedCount, currentLoadedCount + BATCH_SIZE);

    try {
        // 4. ä¸¦è¡ŒæŸ¥è©¢ï¼šåªä¸‹è¼‰é€™ 5 ä»½çš„æäº¤ç‹€æ…‹ (HTML å…§å®¹)
        const results = await Promise.all(nextBatch.map(async ([key, task]) => {
            const subPath = `assignments_submissions/${key}/${s.name}`;
            const subSnap = await database.ref(subPath).once('value');
            const submission = subSnap.val(); 
            return { key, task, submission };
        }));

        // ç§»é™¤ Loading
        if (loadingDiv) loadingDiv.remove();

        // 5. æ¸²æŸ“é€™ 5 ä»½ (å‚³å…¥ true ä»£è¡¨ append)
        renderAssignmentList(results, false, true); // æ³¨æ„ï¼šéœ€ä¿®æ”¹ renderAssignmentList æ”¯æ´ append

        // 6. æ›´æ–°è¨ˆæ•¸å™¨
        currentLoadedCount += nextBatch.length;

        // 7. æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºã€Œè¼‰å…¥æ›´å¤šã€æŒ‰éˆ•
        manageLoadMoreButton();

    } catch (error) {
        console.error("åˆ†æ‰¹è®€å–éŒ¯èª¤", error);
        if (loadingDiv) loadingDiv.innerHTML = "è®€å–å¤±æ•—ï¼Œè«‹é‡è©¦";
    }
}

// === ç®¡ç†ã€Œè¼‰å…¥æ›´å¤šã€æŒ‰éˆ•çš„é¡¯ç¤º ===
function manageLoadMoreButton() {
    const listDiv = document.getElementById('assignmentList');
    
    // å…ˆç§»é™¤èˆŠæŒ‰éˆ•
    const existingBtn = document.getElementById('loadMoreAssignmentsBtn');
    if (existingBtn) existingBtn.remove();

    // å¦‚æœé‚„æœ‰å‰©é¤˜è³‡æ–™ï¼Œå°±åŠ å›æŒ‰éˆ•
    if (currentLoadedCount < allAssignmentTasks.length) {
        const remaining = allAssignmentTasks.length - currentLoadedCount;
        
        const btn = document.createElement('button');
        btn.id = 'loadMoreAssignmentsBtn';
        // ä½¿ç”¨è«è˜­è¿ªç°è‰²ç³»æ¨£å¼
        btn.style.cssText = "width:100%; padding:10px; margin-top:10px; background:#e0e0e0; color:#555; border:none; border-radius:8px; cursor:pointer; font-weight:bold;";
        btn.innerHTML = `é¡¯ç¤ºè¼ƒèˆŠçš„èª²æ¥­ (${remaining})`;
        
        btn.onclick = function() {
            this.disabled = true; // é˜²æ­¢é€£é»
            loadNextBatchAssignments();
        };

        listDiv.appendChild(btn);
    }
}

	
// === è¼”åŠ©å‡½æ•¸ï¼šæ¸²æŸ“åˆ—è¡¨ HTML (é˜²é‡è¤‡é¡¯ç¤ºä¿®å¾©ç‰ˆ) ===
// åƒæ•¸: dataArray (è³‡æ–™é™£åˆ—), isSyncing (åŒæ­¥ä¸­?), isAppend (æ˜¯å¦é™„åŠ )
function renderAssignmentList(dataArray, isSyncing, isAppend = false) {
    const listDiv = document.getElementById('assignmentList');
    
    // å¦‚æœä¸æ˜¯ Append æ¨¡å¼ï¼Œæ‰æ¸…ç©ºåˆ—è¡¨
    if (!isAppend) {
        listDiv.innerHTML = '';
    }

    // è«è˜­è¿ªè‰²ç³»
    const morandiPalette = ['#8fa398', '#94a7b5', '#b6a6ca', '#d69a92', '#c7b299'];

    if (isSyncing) {
        // å¦‚æœæ˜¯åŒæ­¥ä¸­ï¼Œä¸”åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œæ‰é¡¯ç¤º ...
        if (listDiv.children.length === 0) {
            listDiv.innerHTML += `<div>...</div>`;
        }
        return;
    }

    dataArray.forEach((item, index) => {
        const key = item.key; // ç²å–èª²æ¥­çš„å”¯ä¸€ ID (Firebase Key)
        
        // â˜…â˜…â˜… [æ ¸å¿ƒä¿®å¾©] é˜²é‡è¤‡æª¢æŸ¥ â˜…â˜…â˜…
        // å¦‚æœç•«é¢ä¸Šå·²ç¶“æœ‰é€™å€‹ ID çš„å¡ç‰‡ï¼Œç›´æ¥è·³éï¼Œä¸é‡è¤‡æ¸²æŸ“
        if (document.getElementById(`task-card-${key}`)) {
            return;
        }

        const task = item.task;
        const submission = item.submission;
        
        // ç‚ºäº†è¦–è¦ºç¾è§€ï¼Œä½¿ç”¨éš¨æ©Ÿæˆ–è¼ªæ›¿é¡è‰²
        const themeColor = morandiPalette[index % morandiPalette.length];

        let uiClass = '';
        let statusIcon = '';
        let statusText = '';
        let clickHandler = null; 
        let dateDisplay = new Date(task.timestamp).toLocaleDateString('zh-HK', {month:'2-digit', day:'2-digit'});

        if (submission && submission.teacherFeedback && submission.teacherFeedback.status === 'returned') {
            uiClass = 'status-returned';
            statusIcon = '<i class="fas fa-envelope-open-text"></i>';
            statusText = 'æŸ¥çœ‹è©•èª';
            submission.topic = task.topic; 
            const submissionStr = encodeURIComponent(JSON.stringify(submission));
            clickHandler = function() { showTeacherFeedback(submissionStr); };
        }
        else if (submission) {
            uiClass = 'status-submitted';
            statusIcon = '<i class="fas fa-check-circle" style="color:#5e7067;"></i>';
            statusText = '<span style="color:#5e7067;">å·²ç¹³äº¤</span>';
            submission.topic = task.topic;
            submission.isPending = true; 
            const submissionStr = encodeURIComponent(JSON.stringify(submission));
            clickHandler = function() { showTeacherFeedback(submissionStr); };
        }
        else {
            uiClass = 'status-pending';
            statusIcon = '<i class="fas fa-pen"></i>'; 
            statusText = 'æœªç¹³äº¤';
            clickHandler = function() { goToHistoryForAssignment(task.topic); };
        }

        // å»ºç«‹ DOM å…ƒç´ 
        const cardDiv = document.createElement('div');
        
        // â˜…â˜…â˜… [æ ¸å¿ƒä¿®å¾©] è¨­å®šå”¯ä¸€ ID â˜…â˜…â˜…
        // é€™æ¨£ä¸Šé¢çš„ if æª¢æŸ¥æ‰èƒ½ç”Ÿæ•ˆ
        cardDiv.id = `task-card-${key}`; 
        
        cardDiv.className = `task-card ${uiClass}`;
        cardDiv.onclick = clickHandler; 
        
        cardDiv.style.setProperty('--theme-color', themeColor);
        cardDiv.innerHTML = `
            <div class="task-info">
               <div class="task-topic" style="color: ${themeColor};">${task.topic}</div>
                <div class="task-meta">
                    <span class="task-type-tag" style="background-color: ${themeColor}; color: white; border:none;">${task.type}</span>
                    <span><i class="far fa-clock"></i> ${dateDisplay}</span>
                </div>
            </div>
            <div class="task-status">
                ${statusIcon} <span style="margin-left:5px;">${statusText}</span>
            </div>
        `;
        
        listDiv.appendChild(cardDiv);
    });
}

	
	// === æ–°å¢ï¼šå¾æœªç¹³äº¤èª²æ¥­è·³è½‰è‡³æ­·å²ç´€éŒ„ ===
// === æ–°å¢ï¼šå¾æœªç¹³äº¤èª²æ¥­è·³è½‰è‡³æ­·å²ç´€éŒ„ (ç„¡æç¤ºç‰ˆ) ===
function goToHistoryForAssignment(topic) {
    // 1. é—œé–‰ã€Œå­¸ç”Ÿé›²ç«¯ä¸­å¿ƒã€å½ˆçª—
    document.getElementById('studentCloudModal').style.display = 'none';
    
    // 2. æ‰“é–‹ã€Œæ­·å²ç´€éŒ„ã€å®¹å™¨ (é€™æœƒè‡ªå‹•é¡¯ç¤ºç¬¬ä¸€å±¤çš„äº”å€‹ç¯„ç–‡å¡ç‰‡)
    openHistoryContainer();
    
    // 3. æ»¾å‹•åˆ°é é¢é ‚éƒ¨
    window.scrollTo({ top: 0, behavior: 'instant' });
}
// === é¡¯ç¤ºè€å¸«å›é¥‹ (å½ˆçª—) ===
// === æœ€çµ‚ä¿®è¨‚ç‰ˆï¼šé¡¯ç¤ºè€å¸«å›é¥‹ (éš±è—å³ä¸Šè§’æ—¥æœŸ + å¤§åœ°è‰²ç³») ===
function showTeacherFeedback(submissionStr) {
    let record;
    try {
        record = JSON.parse(decodeURIComponent(submissionStr));
    } catch (e) {
        console.error("è§£æå¤±æ•—", e);
        return alert("è³‡æ–™è®€å–éŒ¯èª¤");
    }

    const feedback = record.teacherFeedback || {};
    const isPending = record.isPending === true;

    // 1. æ±ºå®šä¸»é¡Œé¡è‰²
    let themeIndex = 1;
    if (record.category && HISTORY_STRUCTURE[record.category]) {
        const subIndex = HISTORY_STRUCTURE[record.category].indexOf(record.subFunction);
        if (subIndex !== -1) {
            themeIndex = (subIndex % 5) + 1;
        }
    }
    const themeClass = `history-theme-context-${themeIndex}`;

    // 2. æ§‹å»ºã€Œè€å¸«å›é¥‹ã€å€å¡Š
    let teacherFeedbackHTML = '';
    
    if (isPending) {
        // å¾…æ‰¹æ”¹
        teacherFeedbackHTML = `
            <div style="background:#f4f8f6; border:2px dashed #8fa398; border-radius:12px; padding:20px; text-align:center;">
                <h3 style="color:#5e7067; margin-top:0;"><i class="fas fa-check-circle"></i> ä½œæ¥­å·²ç¹³äº¤</h3>
                <p style="color:#666; margin-bottom:5px;">è€å¸«å°šæœªæ‰¹æ”¹é€™ä»½ä½œæ¥­ã€‚</p>
                <small style="color:#999;">ç¹³äº¤æ—¥æœŸï¼š${record.submittedAt ? record.submittedAt.split(' ')[0] : 'æœªçŸ¥'}</small>
            </div>
        `;
    } else {
        // å·²ç™¼é‚„
        const scoreDisplay = feedback.score ? `<div class="teacher-score-badge">${feedback.score}</div>` : '';
        const dateObj = feedback.timestamp ? new Date(feedback.timestamp) : null;
        const dateStr = dateObj ? dateObj.toLocaleDateString('zh-HK') : 'æœªçŸ¥';
        const commentText = feedback.comment ? feedback.comment.trim() : "ï¼ˆæ²’æœ‰æ–‡å­—è©•èªï¼‰";

        teacherFeedbackHTML = `
            <div class="teacher-feedback-section">
                <div class="teacher-feedback-header">
                    <div class="teacher-feedback-title">
                        <i class="fas fa-chalkboard-teacher"></i> è€å¸«å›é¥‹
                    </div>
                    ${scoreDisplay}
                </div>
                <div class="teacher-comment-content">${commentText}</div>
                
                <div style="text-align:right; margin-top:15px; font-size:0.85em; color:#a1887f;">
                    <i class="far fa-calendar-alt"></i> æ‰¹æ”¹æ—¥æœŸï¼š${dateStr}
                </div>
            </div>
        `;
    }

    // 3. æ§‹å»ºæ•´é«”å…§å®¹ HTML
    let contentHTML = teacherFeedbackHTML;

    // å¦‚æœæœ‰å­¸ç”Ÿå…§å®¹ï¼ŒåŠ å…¥åˆ†éš”ç·š
    if (record.userContent || record.aiContent) {
        contentHTML += `<div class="feedback-separator"></div>`;
    }

    // 4. æ§‹å»ºã€Œå­¸ç”ŸåŸç¨¿ã€å€å¡Š
    if (record.userContent) {
        const rawText = record.userContent;
        const lines = rawText.split('\n');
        let parsedHTML = `<div class="history-parsed-container ${themeClass}">`;
        let currentLabel = 'è¼¸å…¥å…§å®¹'; 
        let currentContent = [];
        const labelRegex = /^(.{2,10}?)[ï¼š:](.*)$/;

        lines.forEach((line) => {
            const match = line.match(labelRegex);
            if (match) {
                if (currentContent.length > 0) {
                    parsedHTML += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${currentContent.join('\n')}</div></div>`;
                }
                currentLabel = match[1].trim(); 
                const restOfLine = match[2].trim();
                currentContent = restOfLine ? [restOfLine] : []; 
            } else {
                if (line.trim() !== "") currentContent.push(line);
            }
        });

        if (currentContent.length > 0 || lines.length === 0) { 
             const finalContent = currentContent.length > 0 ? currentContent.join('\n') : rawText;
             parsedHTML += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${finalContent}</div></div>`;
        }
        parsedHTML += '</div>';
        
        contentHTML += `<div style="background:#fff; padding:20px; border-radius:12px; margin-bottom:25px; border:1px solid #eee; box-shadow: 0 4px 20px rgba(0,0,0,0.04);">
                            ${parsedHTML}
                        </div>`;
    }

    // åŠ å…¥ AI åˆ†æçµæœ (é€™è£¡é€šå¸¸åŒ…å« HTML çµæ§‹ï¼Œä½†ä¸åŒ…å«æ´»çš„ Canvas)
    if (record.aiContent) {
        contentHTML += `<div class="ai-output-area" style="margin-top: 15px;">${record.aiContent}</div>`;
    }

    // 5. é¡¯ç¤º Modal
    const historyModal = document.getElementById('historyModal');
    const modalTitle = document.getElementById('historyModalTitle');
    const modalContent = document.getElementById('historyModalContent');
    const modalDate = document.getElementById('historyModalDate');

    modalTitle.innerHTML = `<span style="color:#2A9689; font-weight:bold;">${record.topic || "èª²æ¥­ç´€éŒ„"}</span>`;
    
    if (modalDate) {
        modalDate.style.display = 'none'; 
    }

    modalContent.innerHTML = contentHTML;
    historyModal.style.display = 'flex';

    // 6. â˜…â˜…â˜… [æ ¸å¿ƒä¿®å¾©] é›·é”åœ–é‡ç¹ªé‚è¼¯ â˜…â˜…â˜…
    // ä½¿ç”¨ setTimeout ç¢ºä¿ DOM æ¸²æŸ“å®Œæˆå¾Œå†ç¹ªåœ–
    setTimeout(() => {
        // æª¢æŸ¥æ˜¯å¦æœ‰åˆ†æ•¸æ•¸æ“š
        if (record.scoreData && record.scoreData.radar) {
            
            // A. å˜—è©¦åœ¨ AI è¼¸å‡ºå€åŸŸå°‹æ‰¾ç¾æœ‰çš„ Canvas
            let canvasEl = modalContent.querySelector('canvas');

            // B. å¦‚æœæ‰¾ä¸åˆ° (ä¾‹å¦‚èˆŠè³‡æ–™çš„ aiContent è£¡æ²’æœ‰ Canvas æ¨™ç±¤)ï¼Œå‰‡å‹•æ…‹å»ºç«‹ä¸€å€‹
            if (!canvasEl) {
                const aiOutputArea = modalContent.querySelector('.ai-output-area');
                if (aiOutputArea) {
                    // å»ºç«‹åœ–è¡¨å®¹å™¨
                    const chartWrapper = document.createElement('div');
                    chartWrapper.style.width = '100%';
                    chartWrapper.style.maxWidth = '500px';
                    chartWrapper.style.height = '350px';
                    chartWrapper.style.margin = '20px auto';
                    chartWrapper.style.position = 'relative';
                    
                    // å»ºç«‹ Canvas
                    const newCanvas = document.createElement('canvas');
                    chartWrapper.appendChild(newCanvas);
                    
                    // å°‡åœ–è¡¨æ’å…¥åˆ° AI å…§å®¹çš„æœ€ä¸Šæ–¹
                    aiOutputArea.insertBefore(chartWrapper, aiOutputArea.firstChild);
                    
                    canvasEl = newCanvas;
                }
            }

            // C. åŸ·è¡Œ Chart.js ç¹ªåœ–
            if (canvasEl) {
                const radarData = [
                    record.scoreData.radar.ç«‹æ„ || 0,
                    record.scoreData.radar.å–æ || 0,
                    record.scoreData.radar.æ‰£é¡Œ || 0,
                    record.scoreData.radar.è©³ç•¥ || 0,
                    record.scoreData.radar.è©å½™ || 0,
                    record.scoreData.radar.æ–‡å­¸æ€§ || 0
                ];

                new Chart(canvasEl.getContext('2d'), {
                    type: 'radar',
                    data: {
                        labels: ['ç«‹æ„', 'å–æ', 'æ‰£é¡Œ', 'è©³ç•¥', 'è©å½™', 'æ–‡å­¸æ€§'],
                        datasets: [{
                            label: 'èƒ½åŠ›è©•ä¼°',
                            data: radarData,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                            pointBorderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // é—œéµï¼šå…è¨±å¡«æ»¿é«˜åº¦
                        scales: {
                            r: {
                                angleLines: { display: true },
                                suggestedMin: 0,
                                suggestedMax: 10,
                                pointLabels: {
                                    font: { size: 14, family: "'Noto Serif TC', serif" }
                                },
                                ticks: { stepSize: 2, display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }
    }, 100); // å»¶é² 100ms ç¢ºä¿ HTML å·²æ³¨å…¥
}
// === åŸ·è¡Œæœªç¹³äº¤èª²æ¥­å‹•ä½œ (ç°¡åŒ–ç‰ˆ) ===
function doAssignment(type, topic) {
    document.getElementById('studentCloudModal').style.display = 'none';
    
    // è·³è½‰é‚è¼¯ (èˆ‡ä¹‹å‰ç›¸åŒ)
    if (type === 'æ•˜äº‹' || type === 'æ•˜äº‹æŠ’æƒ…') {
        document.getElementById('writingBtn').click();
        setTimeout(() => {
            const select = document.getElementById('writingType');
            if (select) { select.value = 'ç‰‡æ®µæå¯«'; toggleWritingType(); }
            const btn = document.querySelector('#topicSelectionArea .btn-custom');
            if(btn) btn.click();
            const titleInput = document.getElementById('customTitle') || document.getElementById('customTopic');
            if (titleInput) {
                titleInput.value = topic;
                titleInput.focus();
                alert(`é¡Œç›®ã€Œ${topic}ã€å·²æº–å‚™å°±ç·’ï¼Œè«‹é–‹å§‹å¯«ä½œã€‚`);
            }
        }, 800);
    } else if (type === 'è­°è«–') {
        document.getElementById('argumentBtn').click();
        setTimeout(() => {
            const select = document.getElementById('argumentType');
            if (select) { select.value = 'writing'; toggleArgumentType(); }
            const btn = document.querySelector('#argumentTopicSelectionArea .btn-custom');
            if(btn) btn.click();
            const titleInput = document.getElementById('argumentCustomTopic');
            if (titleInput) {
                titleInput.value = topic;
                setArgumentCustomTopic();
                alert(`é¡Œç›®ã€Œ${topic}ã€å·²é–å®šã€‚`);
            }
        }, 800);
    }
    // å¯ç¹¼çºŒæ“´å……å…¶ä»–é¡å‹...
}

// === æ ¸å¿ƒï¼šåŒæ­¥ IndexedDB åˆ° Firebase ===



// 1. æ‰“é–‹é¸æ“‡è¦–çª—ï¼Œåˆ—å‡ºè©²ç­ç´šçš„æœ‰æ•ˆä½œæ¥­
// === ç¹³äº¤é‚è¼¯ 1: æ‰“é–‹é¸æ“‡è¦–çª— ===
function openSubmitSelector(recordId) {
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    if (!s) return alert("è«‹å…ˆåœ¨ã€Œé›²ç«¯åŒæ­¥ã€ä¸­ç¶å®šèº«ä»½ï¼");

    // å°‡ç´€éŒ„ ID å­˜å…¥éš±è—æ¬„ä½ï¼Œç¨å¾Œç¹³äº¤æ™‚ä½¿ç”¨
    document.getElementById('pendingRecordId').value = recordId;
    document.getElementById('submitAssignmentModal').style.display = 'flex';
    
    const listDiv = document.getElementById('activeAssignmentList');
    listDiv.innerHTML = '<div style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è®€å–è€å¸«çš„èª²æ¥­åˆ—è¡¨...</div>';

    // å¾ Firebase è®€å–è©²ç­ç´šçš„ä½œæ¥­
    database.ref(`assignments/${s.grade}/${s.class}`).once('value', (snapshot) => {
        const data = snapshot.val();
        listDiv.innerHTML = '';

        if (!data) {
            listDiv.innerHTML = '<p style="color:#999; text-align:center;">ç›®å‰è€å¸«æ²’æœ‰æ´¾ç™¼ä»»ä½•èª²æ¥­ã€‚</p>';
            return;
        }

        const keys = Object.keys(data).reverse(); // æ–°çš„åœ¨ä¸Šé¢
        
        keys.forEach(key => {
            const task = data[key];
            const item = document.createElement('div');
            item.style.cssText = "padding: 15px; margin-bottom: 10px; background: #fff; border: 2px solid #eee; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between;";
            
            item.innerHTML = `
                <div>
                    <div style="font-weight:bold; color:#333; font-size: 1.1rem; margin-bottom: 5px;">${task.topic}</div>
                    <div style="font-size:0.85em; color:#666;">
                        <span style="background:#e0f7fa; color:#006064; padding:2px 8px; border-radius:4px; font-weight:bold;">${task.type}</span>
                        ${new Date(task.timestamp).toLocaleDateString()}
                    </div>
                </div>
                <div style="color: #2A9689; font-size: 1.2rem;"><i class="fas fa-upload"></i></div>
            `;
            
            // æ»‘é¼ æ•ˆæœ
            item.onmouseover = function() { 
                this.style.borderColor = "#2A9689"; 
                this.style.background = "#f0fdfc"; 
                this.style.transform = "translateY(-2px)";
            };
            item.onmouseout = function() { 
                this.style.borderColor = "#eee"; 
                this.style.background = "#fff"; 
                this.style.transform = "translateY(0)";
            };
            
            // é»æ“Šå³ç¹³äº¤
            item.onclick = function() { confirmAndSubmitAssignment(key, task.topic); };
            
            listDiv.appendChild(item);
        });
    });
}

// ==========================================
// === æœ€çµ‚ä¿®å¾©ï¼šç¹³äº¤èª²æ¥­ + åˆ·æ–°èƒŒæ™¯åˆ—è¡¨ ===
// ==========================================
 
async function confirmAndSubmitAssignment(assignmentId, assignmentTopic) {
    // ç¢ºä¿ ID æ˜¯æ•´æ•¸
    const recordId = parseInt(document.getElementById('pendingRecordId').value);
    const s = JSON.parse(localStorage.getItem('studentProfile'));
 
    if (!confirm(`ç¢ºå®šè¦å°‡é€™ä»½ç´€éŒ„ç¹³äº¤ç‚ºã€Œ${assignmentTopic}ã€å—ï¼Ÿ\n(æ³¨æ„ï¼šé€™å°‡æœƒè¦†è“‹ä½ ä¹‹å‰å°æ­¤åŠŸèª²çš„ç¹³äº¤å…§å®¹)`)) return;
 
    try {
        const db = await openHistoryDB();
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(recordId);
 
        request.onsuccess = function(e) {
            const record = e.target.result;
            
            if (!record) return alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åŸå§‹ç´€éŒ„ (ID: " + recordId + ")ï¼Œè«‹é‡æ–°æ‰“é–‹ç´€éŒ„ã€‚");
 
            // ä¸Šå‚³è·¯å¾‘
            const submitPath = `assignments_submissions/${assignmentId}/${s.name}`;
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            const modalBody = document.getElementById('activeAssignmentList');
            modalBody.innerHTML = '<div style="text-align:center; color:#2A9689; padding:20px;"><i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>æ­£åœ¨å‘ˆäº¤çµ¦è€å¸«...</div>';
 
            database.ref(submitPath).set({
                ...record, // åŒ…å«ä¿®è¨‚å¾Œçš„ userContent å’Œ aiContent
                submittedAt: new Date().toLocaleString('zh-HK'),
                studentName: s.name,
                studentClass: s.class,
                studentGrade: s.grade
            }, async (error) => {
                if (error) {
                    alert("ç¹³äº¤å¤±æ•—ï¼š" + error.message);
                    document.getElementById('submitAssignmentModal').style.display = 'none';
                } else {
                    alert(`ğŸ‰ ç¹³äº¤æˆåŠŸï¼\n\nå·²æˆåŠŸå°‡æ­¤ç´€éŒ„å‘ˆäº¤ç‚ºã€Œ${assignmentTopic}ã€ã€‚`);
                    document.getElementById('submitAssignmentModal').style.display = 'none';
                    
                    // 1. åŸ·è¡ŒåŒæ­¥ (é€™æœƒå°è‡´ ID è®Šæ›´)
                    await syncHistoryToFirebase(true);
 
                    // 2. â˜…â˜…â˜… é—œéµæ–°å¢ï¼šåˆ·æ–°èƒŒæ™¯åˆ—è¡¨ â˜…â˜…â˜…
                    // é€™æ¨£å¡ç‰‡çš„ ID æ‰æœƒæ›´æ–°ï¼Œæ‚¨é—œé–‰è¦–çª—å¾Œé»æ“Šå¡ç‰‡æ‰ä¸æœƒå ±éŒ¯
                    if (typeof currentSubFunctionFilter !== 'undefined' &&
                        document.getElementById('historyLevel3').style.display !== 'none') {
                        
                        const themeIndex = typeof currentThemeIndex !== 'undefined' ? currentThemeIndex : 1;
                        
                        // éœé»˜åˆ·æ–°åˆ—è¡¨
                        enterHistoryList(currentSubFunctionFilter, themeIndex);
                    }
                }
            });
        };
    } catch (err) {
        console.error(err);
        alert("ç³»çµ±éŒ¯èª¤ï¼Œç„¡æ³•è®€å–ç´€éŒ„ã€‚");
    }
}


// ==========================================
// === å­¸ç¿’å ±å‘Šé¸å–®é‚è¼¯ (æ–°å¢) ===
// ==========================================

function openReportMenu() {
    document.getElementById('reportMenuModal').style.display = 'flex';
}

function closeReportMenu(event) {
    // é»æ“ŠèƒŒæ™¯æ‰é—œé–‰ï¼Œé»æ“Šå…§å®¹ä¸é—œé–‰
    if (event.target.id === 'reportMenuModal') {
        document.getElementById('reportMenuModal').style.display = 'none';
    }
}

function viewPastReports() {
    // 1. é—œé–‰é¸å–®
    document.getElementById('reportMenuModal').style.display = 'none';
    
    // 2. ç›´æ¥å°èˆªåˆ°ã€Œå­¸ç¿’å ±å‘Šã€ç¯„ç–‡ -> ã€Œç¶œåˆåˆ†æã€åˆ—è¡¨
    // å‡è¨­æˆ‘å€‘åœ¨ HISTORY_STRUCTURE å®šç¾©äº† "å­¸ç¿’å ±å‘Š"
    // å‚³å…¥ 5 ä»£è¡¨ä½¿ç”¨ç¬¬ 5 ç¨®ä¸»é¡Œè‰² (å¥¶èŒ¶æ£•)
    enterHistoryCategory('å­¸ç¿’å ±å‘Š'); 
    setTimeout(() => {
        enterHistoryList('ç¶œåˆåˆ†æ', 5);
    }, 100);
}

// ==========================================
// === å…¨æ–°åŠŸèƒ½ï¼šç”Ÿæˆæ™ºèƒ½å­¸ç¿’å ±å‘Š (V7 - æ•¸æ“šåŒ–å­˜æª”ç‰ˆ) ===
// ==========================================

async function generateHistoryReport() {
    // é—œé–‰é¸å–®
    document.getElementById('reportMenuModal').style.display = 'none';

    const btn = document.querySelector('button[title="å­¸ç¿’å ±å‘Š"]');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }

    console.log("1. é–‹å§‹ç”Ÿæˆæ·±åº¦å ±å‘Š...");

    try {
        const db = await openHistoryDB();
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();

        request.onsuccess = async function(event) {
            const records = event.target.result;

            if (!records || records.length === 0) {
                alert("ç›®å‰æ²’æœ‰è¶³å¤ çš„æ­·å²ç´€éŒ„ä¾†ç”Ÿæˆå ±å‘Šï¼Œè«‹å…ˆå¤šåšç·´ç¿’ï¼");
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-chart-pie"></i>'; }
                return;
            }

            // === 1. æ•¸æ“šèšåˆ ===
            const stats = {
                "æ•˜äº‹æŠ’æƒ…": { count: 0, scores: { content: 0, expression: 0, structure: 0 }, radar: { ç«‹æ„: 0, å–æ: 0, æ‰£é¡Œ: 0, è©³ç•¥: 0, è©å½™: 0, æ–‡å­¸æ€§: 0 }, snippets: [] },
                "è­°è«–": { count: 0, scores: { content: 0, expression: 0, structure: 0 }, radar: { ç«‹æ„: 0, å–æ: 0, æ‰£é¡Œ: 0, è©³ç•¥: 0, è©å½™: 0, æ–‡å­¸æ€§: 0 }, snippets: [] },
                "é–±è®€": { snippets: [] },
                "æ•´åˆæ‹“å±•": { snippets: [] }
            };

            const parser = new DOMParser();

            records.forEach(r => {
                if (!r.aiContent) return;
                // æå–æ‘˜è¦
                const cleanText = r.aiContent.replace(/<[^>]*>?/gm, ' ');
                let snippet = "";
                const critiqueIndex = cleanText.indexOf("é»è©•");
                const suggestionIndex = cleanText.indexOf("å»ºè­°");
                if (critiqueIndex !== -1) snippet += "[è©•]" + cleanText.substring(critiqueIndex + 3, critiqueIndex + 60).trim();
                if (suggestionIndex !== -1) snippet += " [è­°]" + cleanText.substring(suggestionIndex + 3, suggestionIndex + 60).trim();
                const summary = `æ—¥æœŸ:${r.dateStr}|é¡Œç›®:${r.title}|${snippet}`;
                if (stats[r.category]) {
                    stats[r.category].snippets.push(summary);
                }

                // æå–åˆ†æ•¸ (é‡å°æ•˜äº‹å’Œè­°è«–)
                if (r.category === "æ•˜äº‹æŠ’æƒ…" || r.category === "è­°è«–") {
                    try {
                        // å„ªå…ˆä½¿ç”¨çµæ§‹åŒ–å­˜å„²çš„ scoreData
                        if (r.scoreData) {
                            stats[r.category].count++;
                            const c = r.scoreData.content || 0;
                            const e = r.scoreData.expression || 0;
                            const s = r.scoreData.structure || 0;
                            stats[r.category].scores.content += c;
                            stats[r.category].scores.expression += e;
                            stats[r.category].scores.structure += s;
                            
                            if (r.scoreData.radar) {
                                stats[r.category].radar.ç«‹æ„ += (r.scoreData.radar.ç«‹æ„ || 0);
                                stats[r.category].radar.å–æ += (r.scoreData.radar.å–æ || 0);
                                stats[r.category].radar.æ‰£é¡Œ += (r.scoreData.radar.æ‰£é¡Œ || 0);
                                stats[r.category].radar.è©³ç•¥ += (r.scoreData.radar.è©³ç•¥ || 0);
                                stats[r.category].radar.è©å½™ += (r.scoreData.radar.è©å½™ || 0);
                                stats[r.category].radar.æ–‡å­¸æ€§ += (r.scoreData.radar.æ–‡å­¸æ€§ || 0);
                            }
                        } else {
                            // èˆŠæ•¸æ“šå›é€€æ©Ÿåˆ¶ï¼šå˜—è©¦å¾ HTML è§£æ input value
                            const doc = parser.parseFromString(r.aiContent, 'text/html');
                            const contentInput = doc.querySelector('input[id*="ContentScore"]');
                            if (contentInput) {
                                stats[r.category].count++;
                                const c = parseInt(contentInput.value || 5);
                                const e = parseInt(doc.querySelector('input[id*="ExpressionScore"]')?.value || 5);
                                const s = parseInt(doc.querySelector('input[id*="StructureScore"]')?.value || 5);
                                stats[r.category].scores.content += c;
                                stats[r.category].scores.expression += e;
                                stats[r.category].scores.structure += s;
                                // èˆŠæ•¸æ“šä¼°ç®—é›·é”
                                stats[r.category].radar.ç«‹æ„ += (c * 0.6 + s * 0.4);
                                stats[r.category].radar.å–æ += (c * 0.8 + e * 0.2);
                                stats[r.category].radar.æ‰£é¡Œ += (c * 0.7 + s * 0.3);
                                stats[r.category].radar.è©³ç•¥ += (s * 0.7 + c * 0.3);
                                stats[r.category].radar.è©å½™ += e;
                                stats[r.category].radar.æ–‡å­¸æ€§ += e;
                            }
                        }
                    } catch (e) { console.error("Parse Error", e); }
                }
            });

            // === 2. è¨ˆç®—å¹³å‡å€¼ & ç¶œåˆç­‰ç´š ===
            const finalStats = {};
            let globalTotalScore = 0;
            let globalCount = 0;

            ["æ•˜äº‹æŠ’æƒ…", "è­°è«–"].forEach(cat => {
                const s = stats[cat];
                if (s.count > 0) {
                    finalStats[cat] = {
                        content: Math.round(s.scores.content / s.count),
                        expression: Math.round(s.scores.expression / s.count),
                        structure: Math.round(s.scores.structure / s.count),
                        radar: [
                            parseFloat((s.radar.ç«‹æ„ / s.count).toFixed(1)),
                            parseFloat((s.radar.å–æ / s.count).toFixed(1)),
                            parseFloat((s.radar.æ‰£é¡Œ / s.count).toFixed(1)),
                            parseFloat((s.radar.è©³ç•¥ / s.count).toFixed(1)),
                            parseFloat((s.radar.è©å½™ / s.count).toFixed(1)),
                            parseFloat((s.radar.æ–‡å­¸æ€§ / s.count).toFixed(1))
                        ]
                    };
                    const totalScore = (finalStats[cat].content * 4) + (finalStats[cat].expression * 3) + (finalStats[cat].structure * 2) + 8; // +5+3
                    finalStats[cat].total = Math.min(totalScore, 100);
                    finalStats[cat].level = determineGrade(finalStats[cat].total);
                    globalTotalScore += finalStats[cat].total * s.count;
                    globalCount += s.count;
                }
            });

            let overallLevel = "å¾…å®š";
            if (globalCount > 0) {
                const avgGlobalScore = globalTotalScore / globalCount;
                overallLevel = determineGrade(avgGlobalScore);
            }

            // === 3. æ§‹å»º Prompt ===
            let promptData = "";
            let hasData = false;
            for (const [cat, data] of Object.entries(stats)) {
                if (data.snippets.length > 0) {
                    hasData = true;
                    promptData += `\nã€${cat}ã€‘(æœ€è¿‘ç´€éŒ„):\n${data.snippets.slice(-5).join('\n')}\n`;
                }
            }

            if (!hasData) {
                alert("æ‰¾ä¸åˆ°æœ‰æ•ˆçš„æ–‡å­—ç´€éŒ„ã€‚");
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-chart-pie"></i>'; }
                return;
            }

            showLoading("é™³SIR æ­£åœ¨ç”Ÿæˆå­¸ç¿’å ±å‘Š...");

            const prompt = `ä½ ç¾åœ¨æ‰®æ¼”ä¸€ä½è³‡æ·±çš„ä¸­æ–‡ç§‘è€å¸«ã€Œé™³SIRã€ã€‚è«‹æ ¹æ“šå­¸ç”Ÿä»¥ä¸‹çš„æ­·å²ç´€éŒ„ï¼Œç”Ÿæˆä¸€ä»½ã€Œå­¸ç¿’æ¦‚æ³å ±å‘Šã€ã€‚

### å­¸ç”Ÿæ­·å²ç´€éŒ„æ‘˜è¦ï¼š
${promptData}

### ä½ çš„ä»»å‹™ï¼š
ç¶œåˆåˆ†ææ•¸æ“šã€‚**ä¸è¦ä½¿ç”¨åˆ—é»**ï¼Œç›´æ¥ç”¨æµæš¢ã€æº«æš–ã€å°ˆæ¥­çš„æ®µè½æ–‡å­—åˆ†æã€‚

### è¼¸å‡ºæ ¼å¼è¦æ±‚ (åš´æ ¼éµå®ˆ HTML)ï¼š
è«‹ç›´æ¥è¼¸å‡ºä»¥ä¸‹ HTMLï¼Œä¸è¦ç”¨ Markdownã€‚

1. **æ•´é«”è©•èª** (æ³¨æ„ï¼šè«‹å°‡ç¶œåˆè©•ç´š ${overallLevel} å¡«å…¥ä¸‹æ–¹æŒ‡å®šä½ç½®)ï¼š
   <div class="report-section">
       <div class="report-category-badge badge-general">
           <div class="badge-general-title"><i class="fas fa-user-graduate"></i> æ•´é«”å­¸ç¿’æ¦‚æ³</div>
           <div class="overall-grade-tag">
               <span class="overall-grade-label">ç¶œåˆè©•ç´š</span>
               <span>${overallLevel}</span>
           </div>
       </div>
       <div class="report-text-card">
           <p>(ç´„100å­—æ•´é«”é¼“å‹µæ€§è©•èªï¼Œè«‹æåŠå­¸ç”Ÿç›®å‰çš„ç¶œåˆæ°´å¹³ ${overallLevel})</p>
       </div>
   </div>
   
   <div class="report-separator"></div>

2. **åˆ†ç¯„ç–‡åˆ†æ**ï¼š(é‡å°æœ‰æ•¸æ“šçš„ç¯„ç–‡)
   <div class="report-section">
       <div class="report-category-badge badge-[narrative/argument/reading/expand]"><i class="fas fa-book"></i> [ç¯„ç–‡åç¨±]</div>
       <div class="report-text-card">
           <p>(è©³ç´°åˆ†æè©²ç¯„ç–‡çš„å¼·é …èˆ‡å¼±é …)</p>
       </div>
   </div>
   *badge class: badge-narrative, badge-argument, badge-reading, badge-expand*

3. **é™³SIRå¯„èª**ï¼š
   <div class="report-quote-card">
       <div class="report-quote-content">ã€Œ(é‡‘å¥å…§å®¹)ã€</div>
       <div class="report-quote-author">â€”â€” é™³SIR</div>
   </div>`;

            const reportHTML = await callReadingAPI(prompt);

            // === 4. çµ„åˆèˆ‡æ¸²æŸ“ ===
            openResultCanvas("å­¸ç¿’æ­·ç¨‹å ±å‘Š");
            const resultBody = document.getElementById("resultCanvasBody");
            const today = new Date().toLocaleDateString('zh-HK');
            let finalOutput = `<div style="text-align:right; margin-bottom:20px; color:#aaa; font-size:0.9em;">å ±å‘Šæ—¥æœŸï¼š${today}</div>`;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = reportHTML;

            // æ’å…¥åœ–è¡¨çµæ§‹
            ["æ•˜äº‹æŠ’æƒ…", "è­°è«–"].forEach(cat => {
                const badgeClass = cat === "æ•˜äº‹æŠ’æƒ…" ? ".badge-narrative" : ".badge-argument";
                const aiHeader = tempDiv.querySelector(badgeClass);
                
                if (finalStats[cat] && aiHeader) {
                    const sectionDiv = aiHeader.closest('.report-section');
                    const textCard = sectionDiv.querySelector('.report-text-card');
                    const aiText = textCard ? textCard.innerHTML : "";
                    const uniqueId = cat === "æ•˜äº‹æŠ’æƒ…" ? "reportNarrative" : "reportArgument";

                    const chartHTML = `
                    <div class="report-section">
                        ${aiHeader.outerHTML}
                        <div class="report-radar-wrapper">
                            <div class="grading-container" style="margin:0; border:none; padding:0;">
                                <div class="grading-grid">
                                    <div class="grading-scores" style="padding:15px;">
                                        <h3>ç¶œåˆèƒ½åŠ›è©•ä¼° (å¹³å‡)</h3>
                                        <div class="score-item"><label>å…§å®¹ (40)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${finalStats[cat].content * 10}%" class="progress-bar-fill"></div></div><span class="score-display">${finalStats[cat].content * 4}</span></div></div>
                                        <div class="score-item"><label>è¡¨é” (30)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${finalStats[cat].expression * 10}%" class="progress-bar-fill"></div></div><span class="score-display">${finalStats[cat].expression * 3}</span></div></div>
                                        <div class="score-item"><label>çµæ§‹ (20)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${finalStats[cat].structure * 10}%" class="progress-bar-fill"></div></div><span class="score-display">${finalStats[cat].structure * 2}</span></div></div>
                                        <div class="score-item"><label>æ¨™é»å­—é«” (10)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:50%" class="progress-bar-fill"></div></div><span class="score-display">5</span></div></div>
                                        <div class="score-item"><label>éŒ¯åˆ¥å­— (+3)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:100%" class="progress-bar-fill"></div></div><span class="score-display">3</span></div></div>
                                        <div class="total-score-container">
                                            <span style="font-size:1.1em; color:#555;">å¹³å‡ç¸½åˆ†: ${finalStats[cat].total} / 100</span>
                                            <span style="font-size:2em; font-weight:bold; color:#d9534f; margin-left:auto;">${finalStats[cat].level}</span>
                                        </div>
                                    </div>
                                    <div class="grading-radar" style="padding:15px;">
                                        <h3>èƒ½åŠ›åˆ†ä½ˆ</h3>
                                        <!-- æ³¨æ„ï¼šé€™è£¡çš„ canvas æ˜¯ç©ºçš„ï¼Œéœ€è¦JSç¹ªè£½ -->
                                        <div class="radar-chart-container" style="height:250px;">
                                            <canvas id="${uniqueId}Chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="report-text-card">
                            ${aiText}
                        </div>
                    </div>`;
                    sectionDiv.outerHTML = chartHTML;
                }
            });

            resultBody.innerHTML = finalOutput + tempDiv.innerHTML;

            // === 5. æ¸²æŸ“ç•¶å‰ç•«é¢çš„åœ–è¡¨ä¸¦å­˜æª” ===
            setTimeout(() => {
                // A. æ¸²æŸ“ç•¶å‰ä½¿ç”¨è€…çœ‹åˆ°çš„ç•«é¢
                ["æ•˜äº‹æŠ’æƒ…", "è­°è«–"].forEach(cat => {
                    if (finalStats[cat]) {
                        const uniqueId = cat === "æ•˜äº‹æŠ’æƒ…" ? "reportNarrative" : "reportArgument";
                        const ctxEl = document.getElementById(`${uniqueId}Chart`);
                        if (ctxEl) {
                            renderReportRadarChart(ctxEl, finalStats[cat].radar);
                        }
                    }
                });

                // B. å­˜æª”ï¼šé€™è£¡æœ€é‡è¦ï¼
                // æˆ‘å€‘ä½¿ç”¨ captureContainerHTML å„²å­˜ HTML çµæ§‹
                // ä¸¦ä¸”å°‡ finalStats ä½œç‚ºæœ€å¾Œä¸€å€‹åƒæ•¸å‚³å…¥ saveToHistory
                setTimeout(() => {
                    const htmlToSave = captureContainerHTML('resultCanvasBody');
                    saveToHistory(
                        "å­¸ç¿’å ±å‘Š", 
                        "ç¶œåˆåˆ†æ", 
                        `å­¸ç¿’å ±å‘Š (${today})`, 
                        `ç³»çµ±è‡ªå‹•ç”Ÿæˆä¹‹å­¸ç¿’æ­·ç¨‹åˆ†æã€‚\nç¶œåˆè©•ç´šï¼š${overallLevel}`, 
                        htmlToSave,
                        finalStats // â˜…â˜…â˜… é—œéµï¼šé€™å°‡æˆç‚º record.scoreData â˜…â˜…â˜…
                    );
                    console.log("å ±å‘Šå·²è‡ªå‹•å­˜æª”ä¸¦åŒæ­¥ (å«çµ±è¨ˆæ•¸æ“š)ã€‚");
                }, 500);

            }, 100);

            hideAllSaveHtmlButtons();
            
            // å¼·åˆ¶é¡¯ç¤º
            const canvas = document.getElementById("resultCanvas");
            const loadingOverlay = document.getElementById("loadingOverlay");
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            if (canvas) {
                canvas.style.display = 'block';
                canvas.style.zIndex = '99999';
                document.body.style.overflow = 'hidden';
            }

        };

        request.onerror = function(e) { console.error("DB Error:", e); alert("è®€å–å¤±æ•—"); hideLoading(); };

    } catch (error) {
        console.error("Report Error:", error);
        alert("ç”Ÿæˆå¤±æ•—ï¼š" + error.message);
        hideLoading();
    } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-chart-pie"></i>'; }
    }
}
	
	
</script>

<footer class="copyright-footer">
<p>Copyright Â© 2025 é™³å† å¥. All rights reserved.</p>
</footer>

<!-- === å¤§ç¶±ç·¨è¼¯æ‡¸æµ®è¦–çª— (ä¿®æ­£ç‰ˆ) === -->
<!-- === å¤§ç¶±ç·¨è¼¯æ‡¸æµ®è¦–çª— (ä¿®æ­£ç‰ˆ) === -->
<div id="outline-editor-modal" class="outline-modal-overlay">
    <div class="outline-modal-content">
        <h3 id="modal-title">ç·¨è¼¯å…§å®¹</h3>
        
        <!-- â˜…â˜…â˜… æ–°å¢ï¼šæ‡¸æµ®è¦–çª—å…§çš„ç¯„æ–‡é¸æ“‡å™¨ (é è¨­éš±è—) â˜…â˜…â˜… -->
        <select id="modal-template-select" style="display: none; margin-bottom: 10px; padding: 8px; font-size: 16px; border: 1px solid #2A9689; border-radius: 5px; background-color: #f0fdfc;">
            <option value="">æŒ‡å®šç¯„æ–‡</option>
        </select>
        <!-- â˜…â˜…â˜… æ–°å¢çµæŸ â˜…â˜…â˜… -->

        <textarea id="modal-textarea" rows="15"></textarea>
        <div class="modal-buttons">
            <button id="modal-ocr-btn" class="btn-action" style="background-color: #17a2b8;">OCR</button>
            <button id="modal-save-btn" class="btn-action">è¼¸å…¥</button>
        </div>
        <button id="modal-close-btn" class="preview-close-btn" title="é—œé–‰">&times;</button>
    </div>
</div>
	<!-- ç…™èŠ±ç‰¹æ•ˆç•«å¸ƒ -->
<canvas id="fireworksCanvas"></canvas>
<!-- å­¸ç”Ÿé›²ç«¯ä¸­å¿ƒ (ä¿®è¨‚ç‰ˆï¼šåŠ å…¥å§“åè¼¸å…¥èˆ‡æŒ‡å¼•) -->
<div id="studentCloudModal" class="books-modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeStudentCloudModal()">&times;</span>

        <!-- èº«ä»½è¨­å®šè¡¨å–® -->
        <div id="studentIdentityForm">
            
            <!-- æ–°å¢ï¼šæ¨™é¡Œèˆ‡æŒ‡å¼•å€å¡Š -->
       <div style="margin-bottom: 20px; border-bottom: 2px dashed #b0bec5; padding-bottom: 15px; text-align: center;">
    <h3 style="color: #546e7a; margin: 0 0 15px 0; font-size: 1.5em;">è¨»å†Šå¸³è™Ÿ</h3>
    
    <div style="background-color: #e8ecef; padding: 15px; border-radius: 8px; text-align: center; color: #78909c; font-size: 0.95em; line-height: 1.6;">
        <div style="font-weight: bold; margin-bottom: 8px;">
            <i class="fas fa-info-circle"></i> æŒ‡å¼•ï¼š
        </div>
        <div style="text-align: left; margin-top: 5px;">
            è«‹å…ˆè¼¸å…¥æ‚¨çš„<strong>ä¸­æ–‡å§“å</strong>ï¼Œä¸¦é¸æ“‡æ­£ç¢ºçš„<strong>å¹´ç´šã€ç­åˆ¥åŠç­è™Ÿ</strong>ï¼Œç¢ºèªç„¡èª¤å¾Œï¼Œå†é»æ“Šä¸‹æ–¹çš„ã€Œå­¸æ ¡å¸³è™Ÿç™»å…¥ã€æŒ‰éˆ•ã€‚
        </div>
    </div>
</div>

            <!-- æ–°å¢ï¼šå§“åè¼¸å…¥æ¬„ä½ -->
            <label style="font-weight: bold; color: #455a64;">å§“åï¼š</label>
            <input type="text" id="studentNameInput" class="no-modal-editor" placeholder="è«‹è¼¸å…¥æ‚¨çš„ä¸­æ–‡å…¨å (ä¾‹å¦‚ï¼šé™³å¤§æ–‡)" 
                   style="width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 1.1em;">

            <!--åŸæœ‰çš„é¸å–® -->
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label style="font-weight: bold; color: #455a64;">å¹´ç´šï¼š</label>
                    <select id="studentGrade" class="no-modal-editor">
                        <option value="1">ä¸­ä¸€</option><option value="2">ä¸­äºŒ</option><option value="3">ä¸­ä¸‰</option>
                        <option value="4">ä¸­å››</option><option value="5">ä¸­äº”</option><option value="6">ä¸­å…­</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="font-weight: bold; color: #455a64;">ç­åˆ¥ï¼š</label>
                    <select id="studentClass" class="no-modal-editor">
                        <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
                    </select>
                </div>
            </div>

            <label style="font-weight: bold; color: #455a64;">ç­è™Ÿï¼š</label>
            <select id="studentNumber" class="no-modal-editor">
                <!-- JS æœƒè‡ªå‹•å¡«å…¥é¸é … -->
            </select>

            <!-- ç™»å…¥æŒ‰éˆ•å€å¡Š -->
            <div style="margin-top: 25px; padding: 20px; background: #fff; border: 2px solid #607d8b; border-radius: 12px; text-align: center;">
                <p style="color: #78909c; margin-bottom: 15px; font-size: 0.9em;">
                    ç³»çµ±å°‡é©—è­‰æ‚¨çš„ @ccckyc.edu.hk å­¸æ ¡é›»éƒµ
                </p>
                
                <button class="btn-action" onclick="handleSchoolLogin()" 
                        style="width: 100%; background-color: #607d8b; border: none; padding: 12px; font-size: 1.1em; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(96, 125, 139, 0.3);">
                    <i class="fab fa-google"></i> å­¸æ ¡å¸³è™Ÿç™»å…¥
                </button>
            </div>
        </div>

       <!-- ç™»å…¥å¾Œé¡¯ç¤ºå€åŸŸ -->
<div id="studentCloudPanel" style="display:none; margin-top:15px;">
    
    <!-- ä¿®æ”¹è™•ï¼šå°‡æ­¡è¿æ–‡å­—èˆ‡ç™»å‡ºæŒ‰éˆ•æ”¾åœ¨åŒä¸€å€‹å®¹å™¨å…§ -->
    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
        <p id="welcomeText" style="font-weight:bold; color:#555; font-size:1.1em; margin: 0;"></p>
        
        <!-- æ–°å¢ï¼šåœ–æ¡ˆè¨­è¨ˆçš„ç™»å‡ºéµ -->
        <button class="logout-icon-btn" onclick="handleStudentLogout()" title="ç™»å‡ºå¸³è™Ÿ">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>

    <div style="border-top: 1px dashed #ccc; margin: 15px 0; padding-top:10px;">
        <h4 style="margin-top:0; color:#2A9689;"><i class="fas fa-tasks"></i> ä½ çš„èª²æ¥­ç‹€æ…‹</h4>
        <div id="assignmentList" style="max-height: 250px; overflow-y:auto; padding-right:5px;">
            è¼‰å…¥ä¸­...
        </div>
    </div>
</div>
    </div>
</div>

      
        </div>
    </div>
</div>

<!-- ç¹³äº¤åŠŸèª²é¸æ“‡è¦–çª— -->
<div id="submitAssignmentModal" class="books-modal" style="z-index: 2200;">
    <div class="modal-content" style="max-width: 400px;">
        <span class="close-modal-btn" onclick="document.getElementById('submitAssignmentModal').style.display='none'">&times;</span>
        <h3 style="color: #2A9689; border-bottom: 2px solid #eee; padding-bottom: 10px;">
            <i class="fas fa-paper-plane"></i> ç¹³äº¤èª²æ¥­
        </h3>
        <p>è«‹é¸æ“‡é€™ä»½ç´€éŒ„å±¬æ–¼å“ªä¸€ä»½èª²æ¥­ï¼š</p>
        
        <!-- é€™è£¡æœƒå‹•æ…‹è¼‰å…¥è€å¸«é–‹è¨­çš„åŠŸèª² -->
        <div id="activeAssignmentList" style="margin: 15px 0; max-height: 200px; overflow-y: auto;">
            è¼‰å…¥ä¸­...
        </div>

        <input type="hidden" id="pendingRecordId"> <!-- æš«å­˜è¦ç¹³äº¤çš„ç´€éŒ„ ID -->
    </div>
</div>

	<!-- === åŠ è¼‰å‹•ç•«è¦†è“‹å±¤ (æ–°å¢) === -->
<!-- === åŠ è¼‰å‹•ç•«è¦†è“‹å±¤ (å«å–æ¶ˆåŠŸèƒ½) === -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <!-- åŠ è¼‰å‹•ç•«åœ–ç‰‡ -->
        <img src="ç”Ÿæˆä¸­.gif" alt="Loading" class="loading-gif" id="loadingImage">
        <div class="loading-text" id="loadingText">æ­£åœ¨æ€è€ƒä¸­...</div>
 
        <!-- 1. ç´”åœ–ç¤ºå–æ¶ˆéµ (ä½èª¿å„ªé›…) -->
        <button id="cancelLoadingBtn" onclick="openCancelModal()" class="cancel-icon-btn" title="å–æ¶ˆç”Ÿæˆ">
            <i class="fas fa-times"></i>
        </button>
    </div>
 
    <!-- 2. è«è˜­è¿ªé¢¨æ ¼ç¢ºèªè¦–çª— (é è¨­éš±è—) -->
    <div id="cancelConfirmModal" class="morandi-modal-overlay">
        <div class="morandi-modal-card">
            <h3 class="morandi-title">ä¸­æ–·æ€è€ƒï¼Ÿ</h3>
            <p class="morandi-text">ç›®å‰çš„ç”Ÿæˆé€²åº¦å°‡æœƒéºå¤±ï¼Œ<br>ä½†æ‚¨è¼¸å…¥çš„å…§å®¹æœƒä¿ç•™ã€‚</p>
            <div class="morandi-btn-group">
                <!-- ç¹¼çºŒç­‰å¾… (ç°è‰²) -->
                <button onclick="closeCancelModal()" class="morandi-btn btn-gray">ç¹¼çºŒç­‰å¾…</button>
                <!-- ç¢ºèªå–æ¶ˆ (è«è˜­è¿ªç´…) -->
                <button onclick="confirmCancel()" class="morandi-btn btn-red">ç¢ºèªå–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢çš„ç•«å¸ƒ HTML -->
<div id="resultCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #fdfcf8; z-index: 30000; display: none; overflow-y: auto; font-family: 'Noto Serif TC', serif;">
    <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 2px solid #2A9689; margin-bottom: 20px; position: sticky; top: 0; background: #fdfcf8; z-index: 10;">
            <span id="resultCanvasTitle" style="font-size: 1.4rem; font-weight: bold; color: #2A9689;">ç”Ÿæˆçµæœ</span>
            <button onclick="closeResultCanvas()" style="background-color: #d9534f; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold;">
                <i class="fas fa-times"></i> 
            </button>
        </div>
        <div id="resultCanvasBody">
            <!-- å…§å®¹æ³¨å…¥è™• -->
        </div>
    </div>
</div>

	<script>
// ==========================================
// === ç´…é»é‚è¼¯ä¿®å¾©è£œä¸ (Fix Badge Logic) ===
// ==========================================

// 1. å®šç¾©ä¸€å€‹å…¨åŸŸè®Šæ•¸ä¾†è¨˜ä½æ˜¯å¦æœ‰æœªäº¤åŠŸèª²
window.hasPendingWork = false;

// 2. å»ºç«‹ä¸€å€‹ã€Œçµ±ä¸€ã€çš„ç´…é»æ›´æ–°å‡½å¼
// é‚è¼¯ï¼šåªè¦ (æœ‰æœªç¹³äº¤åŠŸèª² OR æœ‰æ¨æ’­é€šçŸ¥å¡ç‰‡)ï¼Œç´…é»å°±æ‡‰è©²äº®èµ·
function refreshGlobalBadge() {
    const badge = document.getElementById('notifBadge');
    const notifContainer = document.getElementById('notifContainer');
    
    if (!badge) return;

    // æª¢æŸ¥ A: ç•«é¢ä¸Šæ˜¯å¦æœ‰æ¨æ’­é€šçŸ¥å¡ç‰‡
    const hasVisibleNotifs = notifContainer && notifContainer.querySelectorAll('.sansi-notification').length > 0;

    // æª¢æŸ¥ B: æ˜¯å¦æœ‰æœªç¹³äº¤åŠŸèª² (ç”± monitorPendingAssignments æ›´æ–° window.hasPendingWork)
    const shouldShow = window.hasPendingWork || hasVisibleNotifs;

    if (shouldShow) {
        badge.style.display = 'block';
        
        // å„ªåŒ–æç¤ºæ–‡å­— (Tooltip)
        if (window.hasPendingWork && hasVisibleNotifs) {
            badge.title = "æ‚¨æœ‰æ–°é€šçŸ¥åŠæœªç¹³äº¤çš„èª²æ¥­ï¼";
        } else if (window.hasPendingWork) {
            badge.title = "æ‚¨æœ‰æœªç¹³äº¤çš„èª²æ¥­ï¼";
        } else {
            badge.title = "æ‚¨æœ‰æ–°é€šçŸ¥ï¼";
        }
    } else {
        badge.style.display = 'none';
    }
}

// 3. è¦†å¯«åŸæœ‰çš„ updateNotifBadge å‡½å¼
// è®“æ¨æ’­ç³»çµ±ä¸å†ç›´æ¥é—œé–‰ç´…é»ï¼Œè€Œæ˜¯é€éçµ±ä¸€å‡½å¼æª¢æŸ¥
window.updateNotifBadge = function() {
    refreshGlobalBadge();
};

// 4. è¦†å¯«åŸæœ‰çš„ monitorPendingAssignments å‡½å¼
// æ”¹ç‚ºæ›´æ–°å…¨åŸŸç‹€æ…‹è®Šæ•¸ï¼Œç„¶å¾Œå‘¼å«çµ±ä¸€å‡½å¼
if (typeof pendingMonitorRef !== 'undefined' && pendingMonitorRef) {
    pendingMonitorRef.off(); // å…ˆç§»é™¤èˆŠçš„ç›£è½å™¨é˜²æ­¢é‡è¤‡
}

window.monitorPendingAssignments = function() {
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    
    // å¦‚æœæ²’æœ‰ç™»å…¥è³‡æ–™ï¼Œå°±ä¸ç›£è½
    if (!s) return;

    // ç§»é™¤èˆŠçš„ç›£è½ (å¦‚æœå­˜åœ¨)
    if (typeof pendingMonitorRef !== 'undefined' && pendingMonitorRef) {
        pendingMonitorRef.off();
    }

    // è¨­å®šç›£è½è·¯å¾‘
    pendingMonitorRef = database.ref(`assignments/${s.grade}/${s.class}`);

    pendingMonitorRef.on('value', async (snapshot) => {
        const assignments = snapshot.val();
        
        // å¦‚æœå®Œå…¨æ²’æœ‰åŠŸèª²è³‡æ–™
        if (!assignments) {
            window.hasPendingWork = false;
            refreshGlobalBadge();
            return;
        }

        const assignmentKeys = Object.keys(assignments);
        
        // ä¸¦è¡Œæª¢æŸ¥æ¯ä¸€ä»½åŠŸèª²çš„ç¹³äº¤ç‹€æ…‹
        const checkPromises = assignmentKeys.map(async (key) => {
            const subSnap = await database.ref(`assignments_submissions/${key}/${s.name}`).once('value');
            return subSnap.exists(); // true = å·²äº¤, false = æœªäº¤
        });

        const results = await Promise.all(checkPromises);

        // æ›´æ–°å…¨åŸŸç‹€æ…‹ï¼šåªè¦æœ‰ä¸€å€‹æ˜¯ falseï¼Œå°±ä»£è¡¨æœ‰å¾…è¾¦äº‹é …
        window.hasPendingWork = results.includes(false);

        // è§¸ç™¼ UI æ›´æ–°
        refreshGlobalBadge();
    });
};

// 5. ç¢ºä¿åœ¨é é¢é‡æ–°æ•´ç†æˆ–ç™»å…¥å¾Œç«‹å³é‡æ–°å•Ÿå‹•ç›£è½
// (å»¶é²åŸ·è¡Œä»¥ç¢ºä¿ Firebase å·²å°±ç·’)
setTimeout(() => {
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    if (s) {
        monitorPendingAssignments();
    }
}, 1500);

</script>



<!-- === [é‚„åŸç‰ˆ] ç¥æ€å¤§æ•¸æ“šæ”¶é›†æ¨¡çµ„ (30ç§’=1åˆ†é˜é‚è¼¯) === -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let totalSeconds = 0;
    let timerInterval = null;

    // 1. ç²å–æ—¥æœŸè·¯å¾‘
    function getDateParts() {
        const now = new Date();
        const y = String(now.getFullYear());
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return { y, m, d };
    }

    // 2. ç²å–èº«ä»½
   // 1. ç²å–æ¨™æº–åŒ–èº«ä»½ (ç¢ºä¿è·¯å¾‘çµ•å°æ­£ç¢º)
function getIdentity() {
    const rawProfile = localStorage.getItem('studentProfile');
    let s = null;
    try { if(rawProfile) s = JSON.parse(rawProfile); } catch (e) {}

    if (s && s.grade && s.class) {
        // â˜… å¼·åˆ¶éæ¿¾ç‰¹æ®Šå­—ç¬¦ï¼Œç¢ºä¿è·¯å¾‘åˆæ³• (èˆ‡ç®¡ç†ç«¯é‚è¼¯ä¸€è‡´)
        const safeName = s.name.replace(/[.#$/[\]]/g, '_'); 
        return { 
            type: 'student', 
            id: s.uid || `stu_${s.grade}${s.class}_${safeName}`, // UID
            nameKey: safeName, // ç”¨æ–¼è·¯å¾‘çš„å­¸ç”Ÿåå­—
            grade: s.grade, 
            class: s.class 
        };
    } else {
        let guestID = localStorage.getItem('sansi_guest_uuid');
        if (!guestID) {
            guestID = 'guest_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('sansi_guest_uuid', guestID);
        }
        return { type: 'guest', id: guestID, grade: 'Guest', class: 'Visitor', nameKey: 'Guest' };
    }
}

// === 3. è¨˜éŒ„è¨ªå• (Log Visit) - é«˜æ•ˆåˆ†æµç‰ˆ ===
// 2. è¨˜éŒ„è¨ªå• (Log Visit) - å®¹éŒ¯ç‰ˆ
async function logVisitOnce() {
    if (typeof firebase === 'undefined' || !database) return;
    
    // ç²å–æ—¥æœŸèˆ‡èº«ä»½
    const now = new Date();
    const y = String(now.getFullYear());
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    
    const identity = getIdentity();
    const uid = identity.id;

    // Session é– (é˜²æ­¢åˆ·æ–°é é¢é‡è¤‡è¨ˆæ•¸)
    const sessionKey = `sansi_visit_logged_${y}${m}${d}_${uid}`;
    if (sessionStorage.getItem(sessionKey)) return; 

    // --- æŸ¥é‡é‚è¼¯ (ç¨ç«‹åŒ…è£¹ï¼Œå¤±æ•—ä¸å½±éŸ¿å¾ŒçºŒ) ---
    let isFirstTimeToday = false;
    try {
        const trackingRef = database.ref(`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`);
        const snap = await trackingRef.once('value');
        // å¦‚æœä¸å­˜åœ¨ï¼Œä»£è¡¨æ˜¯ä»Šæ—¥é¦–æ¬¡
        isFirstTimeToday = !snap.exists();
    } catch (e) {
        // â˜… é—œéµä¿®æ­£ï¼šå¦‚æœæŸ¥é‡å¤±æ•— (æ¬Šé™æˆ–ç¶²çµ¡)ï¼Œé»˜èªç‚º false (å¯§å¯å°‘è¨ˆ Unique ä¹Ÿä¸è¦å ±éŒ¯å´©æ½°)
        // ä½†æˆ‘å€‘ä¾ç„¶æœƒåŸ·è¡Œä¸‹é¢çš„ visits å¯«å…¥
        console.warn("[Stats] æŸ¥é‡å¤±æ•—ï¼Œå°‡è·³é Unique çµ±è¨ˆï¼Œä½†ç¹¼çºŒè¨˜éŒ„ Visitsã€‚", e);
        isFirstTimeToday = false; 
    }

    // --- æº–å‚™å¯«å…¥æ•¸æ“š ---
    const updates = {};
    const increment1 = firebase.database.ServerValue.increment(1);
    
    // è·¯å¾‘è®Šæ•¸
    const classKey = `${identity.grade}${identity.class}`;
    const studentNameKey = identity.nameKey; 

    // 1. å…¨åŸŸç¸½è¦½ (Global)
    const globalPath = `stats_global/${y}/${m}/${d}`;
    updates[`${globalPath}/visits`] = increment1;
    if (isFirstTimeToday) updates[`${globalPath}/unique`] = increment1;

    // 2. å­¸ç”Ÿè©³ç´°æ•¸æ“š (åƒ…å­¸ç”Ÿ)
    if (identity.type === 'student') {
        // A. å­¸æ ¡ç¸½è¦½ (School)
        const schoolPath = `stats_school/${y}/${m}/${d}`;
        updates[`${schoolPath}/visits`] = increment1;
        if (isFirstTimeToday) updates[`${schoolPath}/unique`] = increment1;

        // B. ç­ç´š (Classes)
        const classPath = `stats_classes/${classKey}/${y}/${m}/${d}`;
        updates[`${classPath}/visits`] = increment1;
        if (isFirstTimeToday) updates[`${classPath}/unique`] = increment1;

        // C. å€‹äºº (Students)
        const studentPath = `stats_students/${classKey}/${studentNameKey}/${y}/${m}/${d}`;
        updates[`${studentPath}/visits`] = increment1;
        if (isFirstTimeToday) updates[`${studentPath}/unique`] = increment1;
        
        // D. å¯«å…¥è¿½è¹¤æ¨™è¨˜ (é˜²æ­¢é‡è¤‡)
        if (isFirstTimeToday) {
            updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
        }
    }

    // --- åŸ·è¡Œå¯«å…¥ ---
    try {
        await database.ref().update(updates);
        sessionStorage.setItem(sessionKey, 'true'); // æ¨™è¨˜ Session å·²è¨˜éŒ„
        console.log(`ğŸ“ [Stats] è¨ªå•è¨˜éŒ„æˆåŠŸ (FirstTime: ${isFirstTimeToday})`);
    } catch (e) {
        console.error("âŒ [Stats] è¨ªå•å¯«å…¥å¤±æ•—:", e);
    }
}

// 4. ä¸Šå‚³ 1 åˆ†é˜ (åˆ†æµç‰ˆ)
// 3. ä¸Šå‚³ 1 åˆ†é˜ (Upload Duration) - å®¹éŒ¯ç‰ˆ
function uploadOneMinute() {
    if (typeof firebase === 'undefined' || !database) return;
    
    // ç¢ºä¿è¨ªå•è¨˜éŒ„å·²åŸ·è¡Œ
    logVisitOnce(); 

    const now = new Date();
    const y = String(now.getFullYear());
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    
    const identity = getIdentity();
    const classKey = `${identity.grade}${identity.class}`;
    const studentNameKey = identity.nameKey; 

    const updates = {};
    const increment60 = firebase.database.ServerValue.increment(60); // å¢åŠ  60 ç§’

    // 1. å…¨åŸŸ (Global)
    updates[`stats_global/${y}/${m}/${d}/duration`] = increment60;

    // 2. å­¸ç”Ÿè©³ç´°æ•¸æ“š
    if (identity.type === 'student') {
        // A. å…¨æ ¡
        updates[`stats_school/${y}/${m}/${d}/duration`] = increment60;
        // B. ç­ç´š
        updates[`stats_classes/${classKey}/${y}/${m}/${d}/duration`] = increment60;
        // C. å€‹äºº
        updates[`stats_students/${classKey}/${studentNameKey}/${y}/${m}/${d}/duration`] = increment60;
    }

    // åŸ·è¡Œå¯«å…¥ (ä¸ç­‰å¾…çµæœï¼ŒèƒŒæ™¯åŸ·è¡Œ)
    database.ref().update(updates)
        .then(() => {
            // â˜…â˜…â˜… åŠ å›é€™è¡Œï¼Œæ–¹ä¾¿æ‚¨æ¸¬è©¦æ™‚ç¢ºèª â˜…â˜…â˜…
            console.log("âœ… [Stats] æ™‚é•·ä¸Šå‚³æˆåŠŸ (+60s)");
        })
        .catch(e => {
            console.error("âŒ [Stats] æ™‚é•·ä¸Šå‚³å¤±æ•— (æ¬Šé™æˆ–ç¶²çµ¡å•é¡Œ):", e);
        });
}
    // 5. è¨ˆæ™‚å™¨å•Ÿå‹• (é‚„åŸä½ çš„é‚è¼¯)
    function startTimer() {
        if (timerInterval) return;
        console.log("â–¶ï¸ [Stats] è¨ˆæ™‚å™¨å•Ÿå‹•");
        
        timerInterval = setInterval(() => {
            totalSeconds++;
            
            // â˜…â˜…â˜… ä½ çš„åŸå§‹é‚è¼¯ â˜…â˜…â˜…
            // 30ç§’ -> å‚³é€ (ç®—1åˆ†é˜)
            // 90ç§’ (1åˆ†30ç§’) -> å‚³é€ (ç®—2åˆ†é˜)
            // 150ç§’ (2åˆ†30ç§’) -> å‚³é€ (ç®—3åˆ†é˜)
            if (totalSeconds === 30 || (totalSeconds > 30 && (totalSeconds - 30) % 60 === 0)) {
                uploadOneMinute();
            }
        }, 1000);
    }

    function pauseTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            console.log("â¸ï¸ [Stats] æš«åœè¨ˆæ™‚ (ç•¶å‰ç´¯è¨ˆ: " + totalSeconds + "s)");
            // æ³¨æ„ï¼šé€™è£¡ä¸å†æœ‰ uploadDuration(unsaved)ï¼Œæœªæ»¿çš„éƒ¨åˆ†ç›´æ¥æ¨æ£„
        }
    }

    // å»¶é²å•Ÿå‹•
    setTimeout(() => {
        logVisitOnce();
        startTimer();
    }, 3000);

    // åµæ¸¬é é¢ç‹€æ…‹
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') pauseTimer();
        else startTimer();
    });
    
    window.forceLogVisit = logVisitOnce;
});
</script>

	
<!-- â˜…â˜…â˜… è«‹åœ¨é€™è£¡åŠ å…¥å‡çµæŒ‰éˆ•çš„ç¨‹å¼ç¢¼ â˜…â˜…â˜… -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ç²å–é›²ç«¯åŒæ­¥æŒ‰éˆ•
    const cloudBtn = document.getElementById('sideMenuCloudBtn');
    
    if (cloudBtn) {
        // 1. é é¢è¼‰å…¥æ™‚ç«‹å³å‡çµ (å¥—ç”¨è®Šç°ã€ç„¡æ³•é»æ“Šçš„æ¨£å¼)
        cloudBtn.classList.add('btn-frozen');
        
        // (é¸ç”¨) æš«æ™‚æ”¹è®Š title æç¤º
        const originalTitle = cloudBtn.getAttribute('title') || 'é›²ç«¯åŒæ­¥';
        cloudBtn.setAttribute('title', 'ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™...');

        // 2. è¨­å®š 5 ç§’å¾Œè§£å‡
        setTimeout(() => {
            // ç§»é™¤å‡çµæ¨£å¼ï¼Œæ¢å¾©é¡è‰²èˆ‡é»æ“ŠåŠŸèƒ½
            cloudBtn.classList.remove('btn-frozen');
            
            // æ¢å¾©åŸæœ¬çš„æç¤ºæ–‡å­—
            cloudBtn.setAttribute('title', originalTitle);
        }, 5000); // 5000 æ¯«ç§’ = 5 ç§’
    }
});
</script>
<!-- â˜…â˜…â˜… åŠ å…¥çµæŸ â˜…â˜…â˜… -->


<!-- === [ä¿®æ­£ç‰ˆ] å…¨å±€éœ‡å‹•å›é¥‹ (åŠ å¼·åŠ›åº¦ + è§¸æ§å„ªå…ˆ) === -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // å®šç¾©éœ‡å‹•å‡½æ•¸
    function triggerVibration() {
        // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
        if (!navigator.vibrate) {
            console.log("æ­¤è¨­å‚™/ç€è¦½å™¨ä¸æ”¯æ´éœ‡å‹• API (å¦‚: iPhone)");
            return;
        }
        
        // å˜—è©¦éœ‡å‹• 50 æ¯«ç§’ (æ¯” 10ms æ›´æ˜é¡¯)
        // æœ‰äº›æ‰‹æ©Ÿéœ€è¦ç”¨æˆ¶æ›¾ç¶“é»æ“Šéé é¢è‡³å°‘ä¸€æ¬¡æ‰æœƒé–‹å•Ÿéœ‡å‹•æ¬Šé™
        try {
            navigator.vibrate(35);
            console.log("è§¸ç™¼éœ‡å‹•æŒ‡ä»¤");
        } catch (e) {
            console.error("éœ‡å‹•å¤±æ•—", e);
        }
    }
 
    // å®šç¾©ç›®æ¨™å…ƒç´ 
  const interactiveSelectors = [
     
        '.anime-card',             // ä¸»é å‹•æ¼«å¡ç‰‡
        '.side-menu-item',         // å´é‚Šé¸å–®é …ç›®
        '#homeBtn',                // æ‡¸æµ®è¿”å›ä¸»é éµ
        '.btn',                    // ç”Ÿæˆ/è‡ªè¨‚é¡Œç›®æŒ‰éˆ•
        '.btn-action',             // æäº¤/åŸ·è¡ŒæŒ‰éˆ•
        '.btn-icon-action',        // åœ–ç¤ºæ“ä½œæŒ‰éˆ• (å„²å­˜/æ¸…ç©ºç­‰)
        '.btn-icon-confirm',       // åœ“å½¢ç¢ºèªæŒ‰éˆ•
        '.btn-save-html',          // ä¸‹è¼‰ HTML æŒ‰éˆ•
        '.history-folder-btn',     // æ­·å²ç´€éŒ„è³‡æ–™å¤¾
        '.history-card',           // æ­·å²ç´€éŒ„å¡ç‰‡
        '.task-card',              // é›²ç«¯èª²æ¥­å¡ç‰‡
        '.logout-icon-btn',        // ç™»å‡ºæŒ‰éˆ•
        'select'                   // ä¸‹æ‹‰é¸å–®
    ];

 
    // ä½¿ç”¨ 'touchstart' (æ‰‹æŒ‡æŒ‰ä¸‹ç¬é–“) è€Œä¸æ˜¯ 'click'ï¼Œåæ‡‰æœƒæ›´å¿«
    // åŒæ™‚ç›£è½ 'mousedown' ä»¥ç›¸å®¹é›»è…¦æ»‘é¼ æ¸¬è©¦
    const triggerEvents = ['touchstart', 'mousedown'];
 
    triggerEvents.forEach(eventType => {
        document.body.addEventListener(eventType, function(e) {
            // æª¢æŸ¥é»æ“Šç›®æ¨™
            for (let selector of interactiveSelectors) {
                if (e.target.closest(selector)) {
                    triggerVibration();
                    // ä¸ä½¿ç”¨ breakï¼Œç¢ºä¿è¤‡åˆå…ƒç´ ä¹Ÿèƒ½è§¸ç™¼
                    return;
                }
            }
        }, { passive: true }); // passive: true å„ªåŒ–æ»¾å‹•æ•ˆèƒ½
    });
});
</script>

	<script>
// ==========================================
// === [ä¿®è¨‚ç‰ˆ] æ¬Šé™æ””æˆªå™¨ & éŒ¯èª¤è¨Šæ¯éœéŸ³ ===
// ==========================================
(function() {
    // 1. å®šç¾©ä¸€å€‹å…¨åŸŸæ——æ¨™ï¼Œç”¨ä¾†æ¨™è¨˜ã€Œå‰›å‰›æ˜¯å¦è§¸ç™¼äº†æœƒå“¡é˜»æ“‹ã€
    window._isGuestBlockActive = false;

    // 2. å‡ç´š window.alert (æ””æˆªå†—é¤˜éŒ¯èª¤)
    // æˆ‘å€‘ä¿å­˜ç›®å‰é é¢ä¸Šå·²ç¶“å­˜åœ¨çš„ Alert å‡½å¼ (åŒ…å«è«è˜­è¿ªæ¨£å¼)
    const existingAlert = window.alert;

    window.alert = function(msg) {
        // â˜… æ ¸å¿ƒé‚è¼¯ï¼šå¦‚æœè™•æ–¼ã€ŒéœéŸ³æ¨¡å¼ã€ï¼Œç›´æ¥å¿½ç•¥é€™æ¬¡å ±éŒ¯
        // é€™æ¨£å°±ä¸æœƒè“‹åœ¨ã€Œæœƒå“¡é™å®šã€è¦–çª—ä¸Šé¢
        if (window._isGuestBlockActive) {
            console.log("å·²è‡ªå‹•éæ¿¾å†—é¤˜çš„éŒ¯èª¤æç¤º:", msg);
            return; 
        }
        // å¦å‰‡ï¼Œæ­£å¸¸åŸ·è¡ŒåŸæœ¬çš„ Alert
        existingAlert(msg);
    };

    // 3. è¦†å¯«æ¬Šé™æª¢æŸ¥å‡½å¼
    window.checkGuestUsage = function() {
        // A. æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        const s = JSON.parse(localStorage.getItem('studentProfile'));
        
        // B. å¦‚æœæœ‰è³‡æ–™ -> æ”¾è¡Œ (return true)
        if (s) {
            return true; 
        }

        // C. å¦‚æœæ²’è³‡æ–™ -> åŸ·è¡Œé˜»æ“‹
        console.warn("[Permission] æœªç™»å…¥ç”¨æˆ¶å˜—è©¦ä½¿ç”¨ï¼Œå·²æ””æˆªã€‚");
        
        // --- æ­¥é©Ÿ 1ï¼šé–‹å•ŸéœéŸ³æ¨¡å¼ ---
        // è¨­å®šç‚º trueï¼ŒæŒçºŒ 1.5 ç§’ã€‚é€™æ®µæ™‚é–“å…§çš„ã€Œç”Ÿæˆå¤±æ•—ã€ã€ã€Œè«‹é‡è©¦ã€Alert éƒ½æœƒè¢«åƒæ‰ã€‚
        window._isGuestBlockActive = true;
        
        // 1.5ç§’å¾Œè‡ªå‹•æ¢å¾© Alert åŠŸèƒ½
        setTimeout(() => { window._isGuestBlockActive = false; }, 1500);

        // --- æ­¥é©Ÿ 2ï¼šå„ªåŒ– UI é«”é©— ---
        // å˜—è©¦æ”¶èµ·å´é‚Šé¸å–®ï¼Œé¿å…é®æ“‹
        const sideMenu = document.getElementById('sideMenu');
        if (sideMenu) sideMenu.classList.remove('active');
        const sideMenuToggle = document.getElementById('sideMenuToggle');
        if (sideMenuToggle) sideMenuToggle.classList.remove('active');

        // æ‰‹æ©Ÿéœ‡å‹•å›é¥‹
        if (navigator.vibrate) navigator.vibrate(50);

        // --- æ­¥é©Ÿ 3ï¼šé¡¯ç¤ºæ¼‚äº®çš„æœƒå“¡é™å®šè¦–çª— ---
        const modal = document.getElementById('loginRequiredModal');
        
        if (modal) {
            modal.style.display = 'flex';
        } else {
            // é˜²å‘†ï¼šè¬ä¸€æ‰¾ä¸åˆ°è¦–çª—ï¼Œæ‰å‹‰å¼·ç”¨ Alert (éœ€æš«æ™‚è§£é™¤éœéŸ³æ‰èƒ½é¡¯ç¤º)
            let tempState = window._isGuestBlockActive;
            window._isGuestBlockActive = false; 
            existingAlert("âš ï¸ æ­¤åŠŸèƒ½åƒ…é™ç™»å…¥ç”¨æˆ¶ä½¿ç”¨ã€‚\nè«‹å…ˆç™»å…¥å­¸æ ¡å¸³è™Ÿã€‚");
            window._isGuestBlockActive = tempState;
            
            if (typeof openStudentLoginModal === 'function') openStudentLoginModal();
        }

        // å›å‚³ false ä»¥ä¸­æ–· API é€£ç·š (é€™æœƒè§¸ç™¼ catch blockï¼Œä½† alert æœƒè¢«ä¸Šé¢çš„é‚è¼¯åƒæ‰)
        return false; 
    };
})();;



// â˜…â˜…â˜…â˜…â˜… è«‹å°‡ä»£ç¢¼è²¼åœ¨é€™è£¡ (åŸæœ¬çš„å…§å®¹ä¹‹ä¸‹ï¼Œscript çµæŸæ¨™ç±¤ä¹‹ä¸Š) â˜…â˜…â˜…â˜…â˜…

    // =======================================================
    // === [æ–°å¢] åœ¨ç·šç‹€æ…‹è‡ªå‹•å ±åˆ°ç³»çµ± (Presence System) ===
    // =======================================================
    function initPresenceSystem() {
        // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿ Firebase å·²åˆå§‹åŒ–ä¸”æœ¬åœ°å­˜å„²å·²è®€å–
        setTimeout(() => {
            if (typeof database === 'undefined') return;

            // 1. ç›£è½é€£ç·šç‹€æ…‹
            const connectedRef = database.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    // === é€£ç·šæˆåŠŸï¼Œæº–å‚™è³‡æ–™ ===
                    
                    // ç²å–ç”¨æˆ¶è³‡æ–™
                    const s = JSON.parse(localStorage.getItem('studentProfile'));
                    let myUid = "";
                    let userData = {};

                    // A. åˆ¤æ–·èº«åˆ†
                    if (s && s.name) {
                        // --- å·²ç™»å…¥ç”¨æˆ¶ (å­¸ç”Ÿ/è€å¸«/ç‰¹è¨±) ---
                        const user = firebase.auth().currentUser;
                        myUid = user ? user.uid : `stu_${s.grade}${s.class}_${s.name}`;
                        
                        // æº–å‚™å¯«å…¥çš„è³‡æ–™
                        userData = {
                            name: s.name,
                            grade: s.grade,
                            class: s.class,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            device: /Mobile|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
                        };
                    } else {
                        // --- è¨ªå®¢ ---
                        let guestId = localStorage.getItem('sansi_guest_uuid');
                        if (!guestId) {
                            guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
                            localStorage.setItem('sansi_guest_uuid', guestId);
                        }
                        myUid = guestId;

                        userData = {
                            name: "è¨ªå®¢",
                            grade: "Guest",
                            class: "Visitor",
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        };
                    }

                    // B. åŸ·è¡Œ Firebase å‹•ä½œ
                    const myPresenceRef = database.ref(`online_users/${myUid}`);

                    // é—œéµæŒ‡ä»¤ï¼šç•¶å®¢æˆ¶ç«¯æ–·ç·šæ™‚ï¼Œè‡ªå‹•åˆªé™¤é€™ç­†è³‡æ–™
                    myPresenceRef.onDisconnect().remove().then(() => {
                        // æ–·ç·šæŒ‡ä»¤è¨­å®šæˆåŠŸå¾Œï¼Œå¯«å…¥ç•¶å‰ç‹€æ…‹
                        myPresenceRef.set(userData);
                    });
                }
            });
        }, 2000); // å»¶é² 2 ç§’å•Ÿå‹•
    }

    // å•Ÿå‹•å ±åˆ°ç³»çµ±
    document.addEventListener('DOMContentLoaded', initPresenceSystem);





		
</script>


<script>




let allArticles = [];       // å„²å­˜æ‰€æœ‰æ–‡ç« 
let filteredArticles = [];  // å„²å­˜æœå°‹å¾Œçš„æ–‡ç« 
let currentArticlePage = 1;
const ARTICLES_PER_PAGE = 10;


// 1. å…¨åŸŸè®Šæ•¸
let isBookmarkMode = false;

// 2. åŸºç¤å­˜å–åŠŸèƒ½
function getBookmarkedTitles() {
    const stored = localStorage.getItem('sansi_bookmarked_articles');
    return stored ? JSON.parse(stored) : [];
}


function isArticleBookmarked(title) {
    const bookmarks = getBookmarkedTitles();
    return bookmarks.includes(title);
}

function toggleBookmarkStorage(title) {
    let bookmarks = getBookmarkedTitles();
    const index = bookmarks.indexOf(title);
    
    // å¦‚æœä¸åœ¨æ¸…å–®ä¸­ -> åŠ å…¥ (return true ä»£è¡¨ç¾åœ¨æ˜¯æ”¶è—ç‹€æ…‹)
    if (index === -1) {
        bookmarks.push(title);
        if (navigator.vibrate) navigator.vibrate(20); // è¼•å¾®éœ‡å‹•
        localStorage.setItem('sansi_bookmarked_articles', JSON.stringify(bookmarks));
        return true; 
    } 
    // å¦‚æœå·²åœ¨æ¸…å–®ä¸­ -> ç§»é™¤ (return false ä»£è¡¨ç¾åœ¨æ˜¯æœªæ”¶è—ç‹€æ…‹)
    else {
        bookmarks.splice(index, 1);
        if (navigator.vibrate) navigator.vibrate(10);
        localStorage.setItem('sansi_bookmarked_articles', JSON.stringify(bookmarks));
        return false;
    }
}


// === [æ–°å¢] æª¢æŸ¥ç™»å…¥ç‹€æ…‹æ‰èƒ½é€²å…¥æ–‡èƒ ===
function checkFeaturedAccess() {
    // æª¢æŸ¥æ˜¯å¦æœ‰å­¸ç”Ÿè³‡æ–™
    const s = JSON.parse(localStorage.getItem('studentProfile'));
    
    if (s) {
        // å·²ç™»å…¥ï¼Œæ­£å¸¸é–‹å•Ÿ
        openFeaturedArticles();
    } else {
        // æœªç™»å…¥ï¼Œé¡¯ç¤ºè«è˜­è¿ªé¢¨æ ¼æç¤ºçª—
        // æ”¶èµ·å´é‚Šé¸å–®
        document.getElementById('sideMenu').classList.remove('active');
        document.getElementById('sideMenuToggle').classList.remove('active');
        
        // é¡¯ç¤ºæç¤º
        document.getElementById('loginRequiredModal').style.display = 'flex';
        if (navigator.vibrate) navigator.vibrate(30); // è¼•å¾®éœ‡å‹•å›é¥‹
    }
}



	// 1. æ‰“é–‹ç²¾é¸æ–‡ç« é é¢ (ä¿®è¨‚ç‰ˆï¼šé‡ç½®æ›¸ç±¤æ¨¡å¼)
async function openFeaturedArticles() {
    // éš±è—å…¶ä»–å®¹å™¨
    const containers = ['writingContainer', 'readingContainer', 'booksContainer', 'expandContainer', 'argumentContainer', 'historyContainer', 'toolsContainer2', 'studentCloudModal', 'mainMenuBox', 'hitokoto-container', 'dse-countdown-box', 'toolsBox'];
    containers.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
    });
    document.querySelector('.title-container').style.display = 'none';
    
    // é¡¯ç¤ºæœ¬å®¹å™¨
    const container = document.getElementById('featuredContainer');
    container.style.display = 'block';
    
    // é‡ç½®æ›¸ç±¤æ¨¡å¼ç‚ºé—œé–‰
    isBookmarkMode = false;
    const bookmarkBtn = document.getElementById('bookmarkFilterBtn');
    if (bookmarkBtn) {
        bookmarkBtn.classList.remove('active-mode');
        bookmarkBtn.innerHTML = '<i class="fas fa-bookmark"></i>'; // å¯¦å¿ƒåœ–ç¤ºä½†ç°è‰²
    }

    // æ¢å¾©åˆ—è¡¨è¦–åœ–
    backToArticleList();
    
    // æ”¶èµ·å´é‚Šæ¬„
    document.getElementById('sideMenu').classList.remove('active');
    document.getElementById('sideMenuToggle').classList.remove('active');
    
    // é¡¯ç¤ºè¿”å›ä¸»é æŒ‰éˆ•
    document.getElementById('sideMenuHomeBtn').style.display = 'flex';

    // è¼‰å…¥è³‡æ–™ (å¦‚æœå°šæœªè¼‰å…¥)
    if (allArticles.length === 0) {
        await fetchArticles();
    } else {
        // å¦‚æœå·²æœ‰è³‡æ–™ï¼Œç¢ºä¿é¡¯ç¤ºå…¨éƒ¨æ–‡ç« 
        searchArticles(); 
    }
}


// 3. ä¸»é åˆ—è¡¨ï¼šåˆ‡æ›ã€Œåªçœ‹æ›¸ç±¤ã€æ¨¡å¼
function toggleBookmarkMode() {
    const btn = document.getElementById('bookmarkFilterBtn');
    isBookmarkMode = !isBookmarkMode; // åˆ‡æ›é–‹é—œ

    if (isBookmarkMode) {
        // --- é»äº®æŒ‰éˆ• (ç¥ç€è‰²) ---
        btn.classList.add('active-mode');
        
        // åŸ·è¡Œç¯©é¸ï¼šåªé¡¯ç¤ºå·²æ”¶è—çš„æ–‡ç« 
        const bookmarks = getBookmarkedTitles();
        
        // ç‚ºäº†è®“æœå°‹åŠŸèƒ½å’Œæ›¸ç±¤éæ¿¾èƒ½å…±å­˜ï¼Œæˆ‘å€‘åŸºæ–¼ allArticles é€²è¡Œéæ¿¾
        filteredArticles = allArticles.filter(a => bookmarks.includes(a.title));
        
        // å¦‚æœåŒæ™‚æœ‰æœå°‹æ–‡å­—ï¼Œå†ç–ŠåŠ æœå°‹æ¢ä»¶
        const searchInput = document.getElementById('articleSearchInput');
        if (searchInput && searchInput.value.trim() !== "") {
            const query = searchInput.value.trim().toLowerCase();
            filteredArticles = filteredArticles.filter(a => 
                a.title.toLowerCase().includes(query) || 
                a.author.toLowerCase().includes(query)
            );
        }
    } else {
        // --- ç†„æ»…æŒ‰éˆ• (è®Šå›åŸè‰²) ---
        btn.classList.remove('active-mode');
        
        // æ¢å¾©æ­£å¸¸é¡¯ç¤º (åŸ·è¡Œä¸€æ¬¡æœå°‹é‚è¼¯å³å¯é‡ç½® filteredArticles)
        searchArticles(); 
    }

    // é‡ç½®é ç¢¼ä¸¦é‡æ–°æ¸²æŸ“åˆ—è¡¨
    currentArticlePage = 1;
    renderArticleList();
}

// æ³¨æ„ï¼šè«‹ç¢ºä¿ä½ å·²ç¶“å¼•å…¥äº† Firebase SDK ä¸¦åŸ·è¡Œäº† firebase.initializeApp()
// é€™æ®µç¨‹å¼ç¢¼æ‡‰è©²æ”¾åœ¨ firebase.auth().onAuthStateChanged ç›£è½å™¨å…§ï¼Œæˆ–ç¢ºèªä½¿ç”¨è€…å·²ç™»å…¥å¾ŒåŸ·è¡Œ
 
// âœ…ã€è«‹è²¼ä¸Šé€™ä¸€æ®µ (Firebase å®‰å…¨ç‰ˆ)ã€‘âœ…
 
// 2. å¾ Firebase ç²å–å®‰å…¨é€£çµä¸¦ä¸‹è¼‰è³‡æ–™
async function fetchArticles() {
    const listContainer = document.getElementById('articleListContainer');
    listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#8fa398;"><i class="fas fa-circle-notch fa-spin"></i> æ­£åœ¨å®‰å…¨é€£ç·šä¸­...</div>';
 
    try {
        // 1. å¾ Firebase ç²å–ã€ŒAPI ç¶²å€ã€å’Œã€Œé€šé—œå¯†ç¢¼ã€
        // (åªæœ‰ @ccckyc ç™»å…¥è€…æ‰èƒ½è®€å–é€™ä¸€æ­¥)
        const snapshot = await database.ref('/secured_config').once('value');
        const config = snapshot.val();
 
        if (!config || !config.api_url || !config.api_token) {
            throw new Error("ç„¡æ³•ç²å–å®‰å…¨é…ç½®ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚");
        }
 
        console.log("âœ… é©—è­‰æˆåŠŸï¼Œå–å¾—é‡‘é‘°");
 
        // 2. çµ„åˆå¸¶å¯†ç¢¼çš„ç¶²å€
        // æ ¼å¼ï¼š ç¶²å€ + ?token=å¯†ç¢¼
        const secureUrl = `${config.api_url}?token=${config.api_token}`;
 
        // 3. ç™¼é€è«‹æ±‚ (GAS è¨­ç‚º Anyoneï¼Œæ‰€ä»¥é€™è£¡ä¸æœƒæœ‰ CORS éŒ¯èª¤)
        const response = await fetch(secureUrl);
        const textData = await response.text();
 
        // 4. æª¢æŸ¥ GAS æ˜¯å¦å›å‚³äº†éŒ¯èª¤è¨Šæ¯
        if (textData.startsWith("ERROR:")) {
            throw new Error("ä¼ºæœå™¨æ‹’çµ•å­˜å–ï¼š" + textData);
        }
 
        // 5. è§£æ CSV
        allArticles = parseCSV(textData).reverse();
        console.log("ã€æ–‡ç« æ•¸é‡ã€‘:", allArticles.length);
 
        filteredArticles = allArticles;
        currentArticlePage = 1;
        renderArticleList();
 
    } catch (error) {
        console.error("è¼‰å…¥å¤±æ•—:", error);
        let errorMsg = error.message;
        
        if (error.code === 'PERMISSION_DENIED') {
             errorMsg = "æ¬Šé™ä¸è¶³ï¼šæ‚¨å¿…é ˆä½¿ç”¨ @ccckyc.edu.hk å¸³è™Ÿç™»å…¥æ‰èƒ½è§£é–å…§å®¹ã€‚";
        }
 
        listContainer.innerHTML = `<div style="text-align:center; color:#d69a92; padding:20px;">
            <i class="fas fa-lock"></i><br>
            ${errorMsg}
        </div>`;
    }
}
 
/**
* (ç¯„ä¾‹) ç°¡å–®çš„ CSV è§£æèˆ‡é¡¯ç¤ºå‡½æ•¸
* è«‹æ›¿æ›æˆä½ åŸæœ¬å°ˆæ¡ˆè£¡çš„é‚è¼¯
*/
function parseAndDisplayCSV(text) {
  // é€™è£¡æ”¾ä½ åŸæœ¬è™•ç† CSV è½‰ JSON æˆ– HTML çš„ä»£ç¢¼
  // ä¾‹å¦‚ PapaParse æˆ–è€…ä½ è‡ªå·±å¯«çš„ split é‚è¼¯
  console.log("CSV å…§å®¹é è¦½:", text.substring(0, 100));
  
  // ç¯„ä¾‹ï¼šç°¡å–®é¡¯ç¤ºåœ¨ console
  // ä½ æ‡‰è©²æŠŠé€™è£¡æ¥å›ä½ çš„ UI æ¸²æŸ“å‡½æ•¸ (ä¾‹å¦‚ renderFeaturedArticles)
}

	
// 3. ä¿®æ­£ç‰ˆ CSV è§£æå™¨ (æ–°å¢è®€å–ç¬¬ 5 æ¬„ï¼šè³æ)
function parseCSV(text) {
    const rows = [];
    let currentRow = [];
    let currentCell = '';
    let inQuote = false;

    // çµ±ä¸€æ›è¡Œç¬¦è™Ÿ
    text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1];

        if (inQuote) {
            if (char === '"' && nextChar === '"') {
                currentCell += '"';
                i++; // è·³éä¸‹ä¸€å€‹å¼•è™Ÿ
            } else if (char === '"') {
                inQuote = false;
            } else {
                currentCell += char;
            }
        } else {
            if (char === '"') {
                inQuote = true;
            } else if (char === ',') {
                currentRow.push(currentCell.trim());
                currentCell = '';
            } else if (char === '\n') {
                currentRow.push(currentCell.trim());
                
                // â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šæ–°å¢è®€å–ç¬¬ 5 æ¬„ (Index 4) ç‚ºè³æ â˜…â˜…â˜…
                if (currentRow.length >= 3) {
                    rows.push({
                        date: currentRow[0],        // ç¬¬ä¸€æ¬„ï¼šæ—¥æœŸ
                        title: currentRow[1],       // ç¬¬äºŒæ¬„ï¼šæ¨™é¡Œ
                        author: currentRow[2] || 'ä½šå', // ç¬¬ä¸‰æ¬„ï¼šä½œè€…
                        content: currentRow[3] || '',    // ç¬¬å››æ¬„ï¼šæ­£æ–‡
                        analysis: currentRow[4] || ''    // ç¬¬äº”æ¬„ï¼šè³æ (æ–°å¢)
                    });
                }
                currentRow = [];
                currentCell = '';
            } else {
                currentCell += char;
            }
        }
    }

    // è™•ç†æœ€å¾Œä¸€è¡Œ
    if (currentCell || currentRow.length > 0) {
        currentRow.push(currentCell.trim());
        if (currentRow.length >= 3) {
            rows.push({
                date: currentRow[0],
                title: currentRow[1],
                author: currentRow[2] || 'ä½šå',
                content: currentRow[3] || '',
                analysis: currentRow[4] || '' // ç¢ºä¿æœ€å¾Œä¸€è¡Œä¹Ÿè®€å–
            });
        }
    }

    // ç§»é™¤æ¨™é¡Œåˆ— (Header)
    return rows.slice(1);
}

// === è«è˜­è¿ªè‰²ç³»å®šç¾© (ç”¨æ–¼æ¨™é¡Œè¼ªæ›¿) ===
const MORANDI_TITLES = [
    '#5e7067', // æ·±ç°ç¶ 
    '#7da3c0', // éœ§éœ¾è—
    '#a692c2', // é¦™èŠ‹ç´«
    '#d69a92', // è±†æ²™ç´…
    '#c7b299', // å¥¶èŒ¶æ£•
    '#6a7a7d'  // éµç°è—
];

// 4. æ¸²æŸ“æ–‡ç« åˆ—è¡¨ (è¦–è¦ºåŒ–å·²è®€ç‰ˆ - èƒŒæ™¯è®Šè‰² + ç´”å‹¾è™Ÿ)
function renderArticleList() {
    const listContainer = document.getElementById('articleListContainer');
    listContainer.innerHTML = '';
 
    if (filteredArticles.length === 0) {
        listContainer.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æ‰¾ä¸åˆ°ç›¸é—œæ–‡ç« ã€‚</div>';
        updatePagination(0);
        return;
    }
 
    const start = (currentArticlePage - 1) * ARTICLES_PER_PAGE;
    const end = start + ARTICLES_PER_PAGE;
    const pageItems = filteredArticles.slice(start, end);
 
    // ç²å–æœ€æ–°çš„å·²è®€åˆ—è¡¨
    const readList = getReadArticles();
 
    pageItems.forEach((article, index) => {
        const realIndex = start + index;
        const titleColor = MORANDI_TITLES[realIndex % MORANDI_TITLES.length];
        
        // â˜…â˜…â˜… æª¢æŸ¥æ˜¯å¦å·²è®€ â˜…â˜…â˜…
        const isRead = readList.includes(article.title);
        
        // 1. å¦‚æœå·²è®€ï¼ŒåŠ å…¥ 'read' class (é€™æœƒè§¸ç™¼ CSS è®Šæ›´èƒŒæ™¯è‰²)
        const itemClass = `article-item ${isRead ? 'read' : ''}`;
        
        // 2. å¦‚æœå·²è®€ï¼Œåªé¡¯ç¤ºå‹¾è™Ÿåœ–ç¤ºï¼Œä¸é¡¯ç¤ºæ–‡å­—
        const tickIconHtml = isRead
            ? `<i class="fas fa-check read-icon-only" title="å·²è®€"></i>`
            : '';
 
        const item = document.createElement('div');
        item.className = itemClass;
        item.onclick = () => showArticleDetail(realIndex);

		// â˜…â˜…â˜… æ–°å¢ï¼šå³éµ/é•·æŒ‰ åˆ‡æ›å·²è®€ç‹€æ…‹ â˜…â˜…â˜…
item.oncontextmenu = function(e) {
    e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­é¸å–®
    e.stopPropagation();
    manualToggleReadStatus(article.title);
    return false;
};
        
        // æ³¨æ„ï¼špadding-left åœ¨ CSS ä¸­é‡å° .read æœ‰é¡å¤– border-left è¨­å®š
        item.innerHTML = `
            <div class="article-left-group" style="width: calc(100% - 100px); min-width: 0;">
                <div class="article-item-title auto-fit-title" style="color: ${titleColor}; margin-bottom: 0;">
                    ${article.title}
                </div>
                
                <div style="margin-top: 5px; display: flex; align-items: center;">
                    <span class="list-author-tag">
                        ${article.author}
                    </span>
                    
                    <!-- â˜…â˜…â˜… æ’å…¥ç´”å‹¾è™Ÿ â˜…â˜…â˜… -->
                    ${tickIconHtml}
                </div>
            </div>
 
            <div class="article-item-date">
                ${article.date}
            </div>
        `;
        listContainer.appendChild(item);
    });
 
    updatePagination(Math.ceil(filteredArticles.length / ARTICLES_PER_PAGE));
 
    setTimeout(() => {
        const titles = document.querySelectorAll('#articleListContainer .auto-fit-title');
        titles.forEach(el => {
            fitTextToContainer(el, 16, 22);
        });
    }, 50);
}



	// 1. åˆ‡æ›å·²è®€ç‹€æ…‹çš„é‚è¼¯å‡½å¼
function manualToggleReadStatus(title) {
    let readList = getReadArticles();
    const index = readList.indexOf(title);
    
    let msg = "";
    if (index !== -1) {
        // å·²è®€ -> æœªè®€ (ç§»é™¤)
        readList.splice(index, 1);
        msg = "å·²æ¨™è¨˜ç‚ºæœªè®€";
    } else {
        // æœªè®€ -> å·²è®€ (åŠ å…¥)
        readList.push(title);
        msg = "å·²æ¨™è¨˜ç‚ºå·²è®€";
    }
    
    localStorage.setItem('sansi_read_articles_list', JSON.stringify(readList));
    
// è§¸ç™¼éœ‡å‹•å›é¥‹
    if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
    
    // é¡¯ç¤ºä¸€å€‹æ¥µçŸ­çš„æç¤º (ä½¿ç”¨æ‚¨ç¾æœ‰çš„ Alert ç³»çµ±)
    // alert(msg);  <-- å°‡æ­¤è¡Œåˆªé™¤æˆ–è¨»è§£æ‰å³å¯å–æ¶ˆå½ˆçª—
    
    // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°é¡è‰²å’Œå‹¾è™Ÿ
    renderArticleList();
}


// === [æ–°å¢] è§¸ç™¼é ç¢¼è¼¸å…¥æ¨¡å¼ ===
function triggerPageJump() {
    const indicator = document.getElementById('pageIndicator');
    const totalPages = Math.ceil(filteredArticles.length / ARTICLES_PER_PAGE) || 1;
    
    // é¿å…é‡è¤‡é»æ“Šç”Ÿæˆå¤šå€‹è¼¸å…¥æ¡†
    if (indicator.querySelector('input')) return;

    // æš«å­˜ç›®å‰çš„é¡¯ç¤ºæ–‡å­—ï¼Œä»¥ä¾¿å–æ¶ˆæ™‚æ¢å¾©
    const originalText = indicator.innerText;

    // æ›¿æ›ç‚ºè¼¸å…¥æ¡†
    indicator.innerHTML = `<input type="number" id="jumpInput" class="page-jump-input" min="1" max="${totalPages}" value="${currentArticlePage}"> <span style="font-size:0.9em; color:#aaa;">/ ${totalPages}</span>`;
    
    const input = document.getElementById('jumpInput');
    input.focus();
    input.select(); // è‡ªå‹•å…¨é¸æ•¸å­—ï¼Œæ–¹ä¾¿ç›´æ¥è¼¸å…¥

    // ç¶å®šäº‹ä»¶ï¼šæŒ‰ä¸‹ Enter è·³è½‰ï¼Œå¤±å»ç„¦é»(Blur) å‰‡å–æ¶ˆ
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            executePageJump(this.value, totalPages);
        } else if (e.key === 'Escape') {
            indicator.innerText = originalText; // å–æ¶ˆ
        }
    });

    // å¤±å»ç„¦é»æ™‚è‡ªå‹•æ¢å¾©åŸç‹€ (å»¶é²ä¸€é»é»ä»¥å…èˆ‡ Enter è¡çª)
    input.addEventListener('blur', function() {
        setTimeout(() => {
            // å¦‚æœé‚„æ²’è·³è½‰ (é é¢æ²’åˆ·æ–°)ï¼Œå°±æ¢å¾©æ–‡å­—
            if (document.getElementById('jumpInput')) {
                indicator.innerText = originalText;
            }
        }, 100);
    });
}


/**
 * === [æ–°å¢] é é¢åˆ‡æ›è¦–è¦ºæ§åˆ¶å™¨ ===
 * @param {Function} updateLogic - å¯¦éš›æ›´æ–°é ç¢¼çš„é‚è¼¯å‡½å¼
 */
async function performPageTransition(updateLogic) {
    const listContainer = document.getElementById('articleListContainer');
    const containerTop = document.getElementById('featuredContainer');

    // 1. ã€é€€å ´ã€‘åˆ—è¡¨æ·¡å‡ºä¸¦ä¸‹æ²‰
    listContainer.classList.add('list-fade-out');

    // 2. ç­‰å¾…é€€å ´å‹•ç•«å®Œæˆ (300ms)
    await new Promise(resolve => setTimeout(resolve, 300));

    // 3. ã€æ»¾å‹•ã€‘å¹³æ»‘æ»¾å‹•å›é ‚éƒ¨ (è¶ç•«é¢ç©ºç™½æ™‚æ»¾å‹•ï¼Œé«”é©—æœ€å¥½)
    if (containerTop) {
        containerTop.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // 4. ã€é¡¯ç¤º Loadingã€‘æ¸…ç©ºåˆ—è¡¨ä¸¦é¡¯ç¤ºè½‰åœˆåœˆ (çµ¦äºˆè¦–è¦ºå›é¥‹)
    listContainer.innerHTML = `
        <div class="pagination-loading">
            <i class="fas fa-circle-notch pagination-spinner"></i>
            <span>æ­£åœ¨ç¿»é ...</span>
        </div>
    `;
    
    // 5. ã€åŸ·è¡Œé‚è¼¯ã€‘æ›´æ–°é ç¢¼è®Šæ•¸ (é€™æ˜¯å‚³å…¥çš„ callback)
    updateLogic();

    // 6. ã€å»¶é²æ¸²æŸ“ã€‘çµ¦äºˆä¸€é»é» "æ€è€ƒæ™‚é–“" (400ms)ï¼Œè®“ä½¿ç”¨è€…çœ‹æ¸…æ¥šè½‰åœˆï¼Œå¢åŠ å„€å¼æ„Ÿ
    setTimeout(() => {
        // æ¸²æŸ“æ–°åˆ—è¡¨ (é€™æœƒè¦†è“‹æ‰ Loading)
        renderArticleList();

        // 7. ã€é€²å ´ã€‘ç§»é™¤é€€å ´ classï¼Œè§¸ç™¼ CSS transition å›å¾©åŸç‹€
        // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª (Reflow) ä»¥ç¢ºä¿å‹•ç•«è§¸ç™¼
        void listContainer.offsetWidth; 
        
        listContainer.classList.remove('list-fade-out');
    }, 400);
}

// ==========================================
// === ä¸‹æ–¹æ˜¯æ‚¨åŸæœ¬çš„å‡½å¼ï¼Œè«‹ç”¨é€™äº›æ–°ç‰ˆæœ¬æ›¿æ› ===
// ==========================================

// 6. æ›é é‚è¼¯ (æ›´æ–°ç‰ˆï¼šåŠ å…¥è¦–è¦ºéæ¸¡)
function changeArticlePage(delta) {
    performPageTransition(() => {
        currentArticlePage += delta;
    });
}

// [æ–°å¢] ä¸€éµå›åˆ°ç¬¬ 1 é  (æ›´æ–°ç‰ˆï¼šåŠ å…¥è¦–è¦ºéæ¸¡)
function goToFirstPage() {
    if (currentArticlePage === 1) return;
    
    performPageTransition(() => {
        currentArticlePage = 1;
    });
}

// [æ–°å¢] åŸ·è¡Œè·³è½‰é‚è¼¯ (æ›´æ–°ç‰ˆï¼šåŠ å…¥è¦–è¦ºéæ¸¡)
function executePageJump(val, maxPage) {
    let pageNum = parseInt(val);
    
    if (isNaN(pageNum)) return; 
    if (pageNum < 1) pageNum = 1;
    if (pageNum > maxPage) pageNum = maxPage;

    if (pageNum !== currentArticlePage) {
        performPageTransition(() => {
            currentArticlePage = pageNum;
        });
    } else {
        // å¦‚æœé ç¢¼æ²’è®Šï¼Œåªæ¢å¾©æ–‡å­—é¡¯ç¤ºï¼Œä¸åŸ·è¡Œå‹•ç•«
        updatePagination(maxPage);
    }
}

	
	
// [ä¿®è¨‚ç‰ˆ] æ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹ (æ§åˆ¶å›é¦–é æŒ‰éˆ•çš„é¡¯ç¤º)
function updatePagination(totalPages) {
    const indicator = document.getElementById('pageIndicator');
    if (indicator) {
        indicator.innerText = `${currentArticlePage} / ${totalPages || 1}`;
    }

    document.getElementById('prevPageBtn').disabled = (currentArticlePage <= 1);
    document.getElementById('nextPageBtn').disabled = (currentArticlePage >= totalPages || totalPages === 0);

    // â˜…â˜…â˜… æ–°å¢æ§åˆ¶ï¼šåªæœ‰ç•¶é æ•¸ > 1 æ™‚ï¼Œæ‰é¡¯ç¤ºã€Œå›é¦–é ã€æŒ‰éˆ• â˜…â˜…â˜…
    const firstPageBtn = document.getElementById('firstPageBtn');
    if (firstPageBtn) {
        if (currentArticlePage > 1) {
            firstPageBtn.style.display = 'inline-flex'; // é¡¯ç¤ºé›™ç®­é ­
            // åŠ å…¥æ·¡å…¥å‹•ç•«
            firstPageBtn.style.opacity = '0';
            setTimeout(() => firstPageBtn.style.opacity = '0.7', 10);
        } else {
            firstPageBtn.style.display = 'none'; // éš±è—
        }
    }
}



// 7. æœå°‹é‚è¼¯ (ä¿®è¨‚ï¼šåŒæ™‚æœå°‹æ¨™é¡Œèˆ‡ä½œè€…)
// 7. æœå°‹é‚è¼¯ (ä¿®è¨‚ï¼šé˜²æ­¢å½ˆçª—å¹²æ“¾ + åŒæ™‚æœå°‹æ¨™é¡Œèˆ‡ä½œè€…)
function searchArticles() {
    // 1. ç²å–è¼¸å…¥æ¡†
    const searchInput = document.getElementById('articleSearchInput');
    if (!searchInput) return;

    // 2. ç²å–è¼¸å…¥å€¼ (è½‰å°å¯«)
    const query = searchInput.value.trim().toLowerCase();
    
    // 3. ç¢ºä¿æœ‰è³‡æ–™å¯æœ
    if (!allArticles || allArticles.length === 0) {
        return;
    }

    // 4. åŸ·è¡Œæœå°‹
    if (!query) {
        // å¦‚æœæ¸…ç©ºäº†æœå°‹æ¡†ï¼Œé¡¯ç¤ºå…¨éƒ¨
        filteredArticles = allArticles;
    } else {
        // åŒæ™‚æ¯”å°æ¨™é¡Œ OR ä½œè€…
        filteredArticles = allArticles.filter(article => {
            const title = String(article.title || "").toLowerCase();
            const author = String(article.author || "").toLowerCase();
            
            // åªè¦æ¨™é¡Œæˆ–ä½œè€…å…¶ä¸­ä¸€å€‹åŒ…å«é—œéµå­—ï¼Œå°±ä¿ç•™
            return title.includes(query) || author.includes(query);
        });
    }
    
    // 5. é‡ç½®å›ç¬¬ä¸€é ä¸¦æ¸²æŸ“
    currentArticlePage = 1; 
    renderArticleList();
}


// 4. è©³æƒ…é ï¼šè™•ç†é»æ“Šæ›¸ç±¤æŒ‰éˆ•
function handleDetailBookmarkClick(encodedTitle) {
    const title = decodeURIComponent(encodedTitle);
    
    // åŸ·è¡Œå­˜å–å‹•ä½œï¼Œä¸¦ç²å–æœ€æ–°ç‹€æ…‹ (true=å·²æ”¶è—, false=æœªæ”¶è—)
    const isNowBookmarked = toggleBookmarkStorage(title);
    
    const btn = document.getElementById('detailBookmarkBtn');
    // å¦‚æœæ˜¯å¯¦å¿ƒåœ–ç¤ºï¼Œåˆ‡æ› class å³å¯ï¼›å¦‚æœæ˜¯ FontAwesome 5ï¼Œå»ºè­°ä¿æŒ fas fa-bookmark
    const icon = btn.querySelector('i'); 
    
    if (isNowBookmarked) {
        // --- é»äº® (è®Šç¥ç€è‰²å¯¦å¿ƒ) ---
        btn.classList.add('bookmarked');
        // åŠ å…¥ä¸€å€‹è¼•å¾®çš„å½ˆè·³å‹•ç•«æ•ˆæœ
        btn.style.transform = "scale(1.2)";
        setTimeout(() => btn.style.transform = "scale(1.1)", 200);
    } else {
        // --- ç†„æ»… (è®Šå›åŠé€æ˜ç™½è‰²) ---
        btn.classList.remove('bookmarked');
        btn.style.transform = "scale(1)";
    }
}



// === [æ›´æ–°] æ‡¸ç©ºè½æ¬¾å‹•ç•«é‚è¼¯ (å«è“‹ç« éŸ³æ•ˆ + æ¶ˆå¤±æ•ˆæœ) ===
function toggleFeaturedChat() {
    const btn = document.getElementById('showFeaturedChatBtn');
    const chatArea = document.getElementById('featuredChatArea');
    const toggleContainer = document.getElementById('chatToggleButtonContainer');
    const hintText = toggleContainer.querySelector('div');
    
    if (btn && chatArea && toggleContainer) {
        
        // --- 0. æ’­æ”¾è½æ¬¾éŸ³æ•ˆ ---
        const stampSound = new Audio('è½æ¬¾.mp3');
        stampSound.volume = 1.0; 
        // å˜—è©¦æ’­æ”¾ (ä½¿ç”¨è€…æœ‰é»æ“Šå‹•ä½œï¼Œé€šå¸¸ä¸æœƒè¢«ç€è¦½å™¨é˜»æ“‹)
        stampSound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±æ•— (è«‹æª¢æŸ¥ CSP è¨­å®š):", e));

        // 1. éš±è—ä¸‹æ–¹çš„æç¤ºæ–‡å­—
        if(hintText) hintText.style.opacity = '0';

        // 2. åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹ (æº–å‚™è½ä¸‹)
        btn.style.transition = 'none'; 
        btn.style.opacity = '0'; // å…ˆéš±è—ï¼Œé…åˆ keyframe çš„èµ·å§‹ç‹€æ…‹
        
        // 3. åŸ·è¡Œã€Œè½æ¬¾ã€å‹•ç•«
        setTimeout(() => {
            // å¥—ç”¨ CSS å‹•ç•« (0.5ç§’å®Œæˆ)
            btn.style.animation = 'stamp-slam 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards';
            
            // åŒæ­¥æ”¹è®Šæ¨£å¼ï¼šè®Šæˆå¯¦å¿ƒç´…åº•
            btn.style.backgroundColor = '#d69a92';
            btn.style.color = '#fff';
            btn.style.borderColor = '#d69a92';
            btn.style.boxShadow = '0 0 0 2px rgba(255,255,255,0.3), 0 0 15px rgba(214, 154, 146, 0.6)'; 
            
            // æ‰‹æ©Ÿéœ‡å‹•å›é¥‹ (é…åˆéŸ³æ•ˆæ›´æœ‰æ„Ÿ)
            if (navigator.vibrate) navigator.vibrate(50);
        }, 50);

        // 4. å‹•ç•«çµæŸå¾Œï¼Œè®“å°ç« æ¶ˆå¤±ä¸¦é¡¯ç¤ºå…§å®¹
        // 50ms (å•Ÿå‹•) + 500ms (å‹•ç•«) + 250ms (å®šæ ¼åœç•™) = 800ms
        setTimeout(() => {
            // A. å°ç« å®¹å™¨æ·¡å‡º
            toggleContainer.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
            toggleContainer.style.opacity = '0';
            toggleContainer.style.transform = 'scale(0.9)'; 

            // B. ç­‰å¾…æ·¡å‡ºå®Œæˆå¾Œï¼Œç§»é™¤æŒ‰éˆ•ä¸¦é¡¯ç¤ºå°è©±
            setTimeout(() => {
                toggleContainer.style.display = 'none'; 
                chatArea.style.display = 'block'; 
                
                // è‡ªå‹•æ²å‹•
                chatArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 400);

        }, 800); 
    }
}


// === [çµ‚æ¥µä¿®å¾©] æ–‡èƒè©³æƒ…é ç½®é ‚åŠŸèƒ½ (åŸåœ°é‡ç”Ÿæ³•) ===
// === [ä¿®è¨‚] æ–‡èƒè©³æƒ…é ç½®é ‚åŠŸèƒ½ (å»¶é²é‡ç”Ÿæ³•) ===
function scrollToArticleTop() {
    const detailView = document.getElementById('featuredDetailView');
    if (detailView) {
        detailView.scrollTo({ top: 0, behavior: 'smooth' });
    }

    const btn = document.getElementById('detailTopBtn');
    if (btn) {
        // 1. ç‚ºäº†ç¢ºä¿æ‚¨çœ‹å¾—åˆ°ç¶ è‰²å›é¥‹ï¼Œæˆ‘å€‘å…ˆä»€éº¼éƒ½ä¸åšï¼Œè®“ CSS çš„ :active/:hover ç”Ÿæ•ˆ
        // ä¸¦ä¸»å‹•ç§»é™¤ç„¦é»ï¼Œé¿å…é‚Šæ¡†æ®˜ç•™
        btn.blur();

        // 2. è¨­å®š 300 æ¯«ç§’çš„å»¶é²
        // é€™æ®µæ™‚é–“è¶³å¤ è®“æ‚¨çœ‹åˆ°æŒ‰éˆ•è®Šç¶ ï¼ˆè¦–è¦ºå›é¥‹ï¼‰
        setTimeout(() => {
            // 3. å»¶é²çµæŸå¾Œï¼ŒåŸ·è¡Œã€ŒåŸåœ°é‡ç”Ÿã€
            // é€™æœƒå¼·åˆ¶ç€è¦½å™¨å¿˜è¨˜åŸæœ¬å¡ä½çš„ç¶ è‰² hover ç‹€æ…‹
            const newBtn = btn.cloneNode(true);
            if (btn.parentNode) {
                btn.parentNode.replaceChild(newBtn, btn);
            }
        }, 300); // 0.3ç§’å¾ŒåŸ·è¡Œé‡ç½®
    }
}

// === [ä¿®æ”¹] è‡ªå‹•æ»¾å‹•è‡³è³æå€å¡Š (åŠ å…¥é˜²èª¤åˆ¤é‚è¼¯) ===
function scrollToAnalysis() {
    const analysisSection = document.getElementById('articleAnalysisSection');
    
    if (analysisSection) {
        // â˜…â˜…â˜… æ­¥é©Ÿ A: é–‹å•Ÿé–å®šï¼Œå‘Šè¨´ç³»çµ±é€™æ˜¯ã€Œè‡ªå‹•æ»¾å‹•ã€ â˜…â˜…â˜…
        // é€™æ¨£ onscroll äº‹ä»¶åµæ¸¬åˆ°æ™‚ï¼Œå°±ä¸æœƒè§¸ç™¼ã€Œå·²è®€ã€
        isAutoScrollingToAnalysis = true;
 
        analysisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // â˜…â˜…â˜… æ­¥é©Ÿ B: 1ç§’å¾Œè§£é– (çµ¦äºˆè¶³å¤ æ™‚é–“ç­‰å¾…æ»¾å‹•å‹•ç•«çµæŸ) â˜…â˜…â˜…
        setTimeout(() => {
            isAutoScrollingToAnalysis = false;
        }, 1000);
    } else {
        alert("æ­¤æ–‡ç« æš«ç„¡è³æå…§å®¹ã€‚");
    }
}

// === [ä¿®è¨‚ V10] é¡¯ç¤ºæ–‡ç« è©³æƒ… (ä¿®å¾©åº•éƒ¨æ®˜ç•™å•é¡Œ) ===
function showArticleDetail(index) {
    try {
        const article = filteredArticles[index];
        if (!article) return;
    
        currentReadingArticleTitle = article.title;
        
        // 1. éš±è—åˆ—è¡¨é  (é—œéµä¿®æ­£)
        const listView = document.getElementById('featuredListView');
        if (listView) listView.style.display = 'none';

        // 2. é¡¯ç¤ºè©³æƒ…é å®¹å™¨
        const detailView = document.getElementById('featuredDetailView');
        if (!detailView) return;

        // ... (ä»¥ä¸‹æ˜¯åŸæœ¬çš„å…§å®¹ç”Ÿæˆé‚è¼¯ï¼Œç‚ºäº†ç¯€çœç¯‡å¹…ï¼Œä¿ç•™æ‚¨çš„æ ¸å¿ƒè®Šæ•¸) ...
        const isSaved = isArticleBookmarked(article.title);
        const bookmarkClass = isSaved ? 'bookmarked' : '';
        const titleColor = MORANDI_TITLES[index % MORANDI_TITLES.length];
        
        currentContextContent = `ã€æ–‡ç« æ¨™é¡Œã€‘${article.title}\nã€ä½œè€…ã€‘${article.author}\n\nã€æ–‡ç« æ­£æ–‡ã€‘\n${article.content}\n\nã€æ–‡ç« è³æã€‘\n${article.analysis || "ï¼ˆç„¡è³æè³‡æ–™ï¼‰"}`;
        currentContextType = 'featured_discussion';
        currentContextReview = "ï¼ˆé€™æ˜¯ç²¾é¸æ–‡ç« çš„é–±è®€è¨è«–ï¼‰";
        
        // è™•ç†æ­£æ–‡ (è©©æ­Œ/æ•£æ–‡)
        const isPoetry = /^\s*<br\s*\/?>/i.test(article.content);
        let contentHtml = '';
        if (isPoetry) {
            let cleanContent = article.content.replace(/^\s*<br\s*\/?>/i, '').trim().replace(/\\n/g, '\n');
            contentHtml = `<div style="width: 100%; display: flex; justify-content: center;"><div id="poetryContent" style="white-space: pre; word-wrap: normal; display: inline-block; text-align: left; line-height: 1.7; font-family: 'Noto Serif TC', serif; margin-top: 0px;">${cleanContent}</div></div>`;
        } else {
            contentHtml = article.content.split('\n').filter(p => p.trim()).map((p, i) => {
                return `<p style="margin-bottom: 1.5em; ${i === 0 ? 'margin-top:0;' : ''}">${p}</p>`;
            }).join('');
        }
    
        // è™•ç†è³æ
        let analysisHtmlBlock = '';
        const hasAnalysis = article.analysis && article.analysis.trim() !== '';
        if (hasAnalysis) {
            const analysisText = article.analysis.split('\n').filter(p => p.trim()).map((p, i) => {
                return `<p style="margin-bottom: 1.5em; ${i === 0 ? 'margin-top:0;' : ''}">${p}</p>`;
            }).join('');
            analysisHtmlBlock = `
            <div id="articleAnalysisSection" class="analysis-container" style="margin-top: 50px !important; padding-top: 40px !important; border-top: 1px dashed #d1cdc5;">
                <div class="analysis-header" style="text-align: center; font-size: 1.4rem; font-weight: bold; color: #8d6e63; margin-bottom: 20px !important; line-height: 1.2; letter-spacing: 2px;">æ–‡ç« è³æ</div>
                <div class="analysis-body" style="margin-top: 0 !important; font-size: 1.05rem !important;">${analysisText}</div>
            </div>`;
        }
    
        // æŒ‰éˆ•å€
        const analysisBtnHtml = hasAnalysis ? `<button class="detail-float-btn scroll-hide-target" onclick="scrollToAnalysis()" title="è·³è‡³è³æ"><i class="fas fa-comment-dots"></i></button>` : '';
        const disclaimerHtml = `<div style="margin-top: 60px; padding-top: 20px; border-top: 1px solid #eee; color: #aaa; font-size: 0.85rem; text-align: center; font-family: 'Noto Serif TC', serif;">æœ¬æ–‡åƒ…ä¾›æ ¡å…§æ•™å­¸ç ”ç¿’ä¹‹ç”¨ã€‚<br>åŸæ–‡ç‰ˆæ¬Šæ­¸åŸä½œè€…/å‡ºç‰ˆç¤¾æ‰€æœ‰ã€‚</div>`;
        const safeContent = encodeURIComponent(article.content);
        const safeTitle = encodeURIComponent(article.title);
    
        // é˜²ç¡æŒ‰éˆ•é‚è¼¯
        const isFocusUnlocked = localStorage.getItem('sansi_focus_permission') === 'true';
        let focusBtnHTML = '';
        if (isFocusUnlocked) {
            focusBtnHTML = `<button id="focusMonitorBtn" class="detail-float-btn scroll-hide-target" onclick="toggleFocusMonitor()" title="é–‹å•Ÿé˜²ç¡ç›£å¯Ÿ"><i class="fas fa-eye-slash"></i></button>`;
            if (typeof focusMonitorState !== 'undefined') {
                focusMonitorState.isActive = false;
                if (focusMonitorState.checkInterval) clearInterval(focusMonitorState.checkInterval);
            }
        } else {
            focusBtnHTML = `<button id="focusMonitorBtn" class="detail-float-btn scroll-hide-target focus-status-green" onclick="toggleFocusMonitor()" title="é˜²ç¡ç›£å¯Ÿä¸­ (é»æ“Šé—œé–‰)"><i class="fas fa-eye"></i></button>`;
            if (typeof activateFocusMonitor === 'function') {
                setTimeout(() => { const btn = document.getElementById('focusMonitorBtn'); if(btn) activateFocusMonitor(btn); }, 500);
            }
        }
    
        let chatHTML = getCanvasChatHTML('featured_discussion');
        chatHTML = chatHTML.replace('é–±å·å“¡è¿½å•å€', 'èˆ‡é™³SIRè¨è«–').replace('å°æ–¼å‰›æ‰çš„é»è©•æˆ–æ”¹å¯«ï¼Œæœ‰ç”šéº¼æƒ³é€²ä¸€æ­¥äº†è§£çš„å—ï¼Ÿ', 'çœ‹å®Œé€™ç¯‡æ–‡ç« ï¼Œæœ‰ç”šéº¼æƒ³å’Œæˆ‘è¨è«–å—ï¼Ÿ');

        // æ³¨å…¥ HTML
        detailView.innerHTML = `
            <style>
                @keyframes stamp-slam { 0% { opacity: 0; transform: scale(3) rotate(-5deg); } 60% { opacity: 1; transform: scale(0.9) rotate(-3deg); } 80% { transform: scale(1.05) rotate(-3deg); } 100% { opacity: 1; transform: scale(1) rotate(-3deg); } }
                #fullArticleBody b, #fullArticleBody strong, #poetryContent b, #poetryContent strong { font-weight: bold !important; color: #2c3e50 !important; text-shadow: none !important; font-family: 'Noto Serif TC', serif; }
            </style>
            <div id="readingProgressBarContainer"><div id="readingProgressBar"></div></div>
            <div class="detail-action-group">
                <button id="detailBookmarkBtn" class="detail-float-btn scroll-hide-target ${bookmarkClass}" onclick="handleDetailBookmarkClick('${safeTitle}')" title="åŠ å…¥/ç§»é™¤æ›¸ç±¤"><i class="fas fa-bookmark"></i></button>
                ${analysisBtnHtml}
                <button class="detail-float-btn scroll-hide-target" onclick="startSlowRead('${safeContent}')" title="é–‹å§‹æ…¢è®€"><i class="fas fa-book-reader"></i></button>
                <button class="detail-float-btn scroll-hide-target" onclick="openReaderSettings()" title="æ…¢è®€è¨­å®š"><i class="fas fa-cog"></i></button>
                ${focusBtnHTML}
                <button id="detailTopBtn" class="detail-float-btn" onclick="scrollToArticleTop()" title="è¿”å›é ‚éƒ¨" style="display: none;"><i class="fas fa-arrow-up"></i></button>
                <button class="detail-float-btn close-mode" onclick="backToArticleList()" title="è¿”å›åˆ—è¡¨"><i class="fas fa-times"></i></button>
            </div>
            <div class="read-mode-container">
                <div class="detail-header-group" style="display: flex; flex-direction: column; align-items: center; border-bottom: 2px dashed #e0ddd7; margin-bottom: 25px !important; padding-bottom: 15px !important;">
                    <div class="detail-title-text auto-fit-title" id="detailTitleText" style="color: ${titleColor}; font-weight: bold; margin-bottom: 20px; text-align: center; width: 100%;">
                        ${article.title}
                    </div>
                    <div class="detail-author-box" style="display: inline-block; padding: 6px 20px; background-color: #f5f5f5; border-radius: 4px; margin-bottom: 10px;">
                        <span class="detail-author-text" style="color: #5d4037; font-weight: bold;">${article.author}</span>
                    </div>
                    <div class="detail-date" style="color: #9e9e9e; font-family: 'Courier New', monospace; font-size: 0.9rem;">${article.date}</div>
                </div>
                <div class="article-body" id="fullArticleBody" style="font-size: 1.15rem; color: #4a4a4a; text-align: justify; line-height: 1.8;">
                    ${contentHtml}
                </div>
                ${analysisHtmlBlock}
                ${disclaimerHtml}
                <div style="margin-top: 80px; margin-bottom: 30px;">
                    <div id="chatToggleButtonContainer" style="text-align: center;">
                        <div style="height: 1px; background: linear-gradient(to right, transparent, #e0ddd7, transparent); width: 50%; margin: 0 auto 30px auto;"></div>
                        <button id="showFeaturedChatBtn" onclick="toggleFeaturedChat()"
                            style="width: 60px; height: 60px; background-color: transparent; color: #d69a92; border: 3px solid #d69a92; border-radius: 8px; font-family: 'Noto Serif TC', serif; font-size: 1.1rem; font-weight: 900; line-height: 1; padding: 0; transform: rotate(-3deg); cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center;"
                            title="é»æ“Šè½æ¬¾">è¨è«–</button>
                        <div style="margin-top: 15px; color: #a1887f; font-size: 0.8rem; font-family: 'Noto Serif TC', serif; opacity: 0.6; letter-spacing: 2px; transform: scale(0.9); transition: opacity 0.5s;">[ é» æ“Š è½ æ¬¾ ]</div>
                    </div>
                    <div id="featuredChatArea" style="display: none; text-align: left; animation: fadeIn 1s ease; margin-top: 30px;">
                        <div style="height: 1px; background: linear-gradient(to right, transparent, #e0ddd7, transparent); width: 80%; margin: 0 auto 30px auto;"></div>
                        ${chatHTML}
                    </div>
                </div>
            </div>
        `;
    
        // é¡¯ç¤º
        detailView.style.display = 'block';
        void detailView.offsetWidth; 
        document.body.style.overflow = 'hidden';
    
        // æ–‡å­—ç¸®æ”¾
        setTimeout(() => {
            const titleEl = document.getElementById('detailTitleText');
            if (titleEl) fitTextToContainer(titleEl, 24, 38);
            if (isPoetry) {
                const poetryEl = document.getElementById('poetryContent');
                if (poetryEl) {
                    let fontSize = 1.25 * 16;
                    poetryEl.style.fontSize = fontSize + 'px';
                    const containerWidth = poetryEl.parentElement.clientWidth;
                    let safety = 0;
                    while (poetryEl.scrollWidth > containerWidth && fontSize > 11 && safety < 100) {
                        fontSize -= 0.5;
                        poetryEl.style.fontSize = fontSize + 'px';
                        safety++;
                    }
                }
            }
        }, 50);
    
        // æ»¾å‹•èˆ‡é˜²ç¡ UI æ§åˆ¶
        detailView.onscroll = function() {
            const scrollTop = detailView.scrollTop;
            const docHeight = detailView.scrollHeight;
            const winHeight = detailView.clientHeight;
            const scrollPercent = (scrollTop / (docHeight - winHeight)) * 100;
            
            const progressBar = document.getElementById('readingProgressBar');
            const progressContainer = document.getElementById('readingProgressBarContainer');
            if(progressBar) progressBar.style.width = scrollPercent + "%";
            if(progressContainer) progressContainer.style.opacity = scrollTop > 10 ? '1' : '0';
     
            const hideTargets = document.querySelectorAll('.scroll-hide-target');
            const topBtn = document.getElementById('detailTopBtn');
            
            if (scrollTop > 100) {
                if (topBtn) topBtn.style.display = 'flex';
                hideTargets.forEach(btn => {
                    if (btn.id === 'focusMonitorBtn') {
                        if (focusMonitorState && focusMonitorState.isActive) {
                            btn.style.display = 'flex';
                            btn.classList.add('minimized');
                        } else {
                            btn.style.display = 'none';
                            btn.classList.remove('minimized');
                        }
                    } else {
                        btn.style.display = 'none';
                    }
                });
            } else {
                if (topBtn) topBtn.style.display = 'none';
                hideTargets.forEach(btn => {
                    btn.style.display = 'flex';
                    if (btn.id === 'focusMonitorBtn') {
                        btn.classList.remove('minimized');
                    }
                });
            }
     
            // å·²è®€æ¨™è¨˜
            const analysisSection = document.getElementById('articleAnalysisSection');
            if (analysisSection && !isAutoScrollingToAnalysis) {
                const rect = analysisSection.getBoundingClientRect();
                if (rect.top <= winHeight * 0.8 && rect.bottom >= 0) {
                    markArticleAsRead(currentReadingArticleTitle);
                }
            }
        };

    } catch (err) {
        console.error("é–‹å•Ÿæ–‡ç« è©³æƒ…å¤±æ•—:", err);
        alert("ç„¡æ³•é–‹å•Ÿæ–‡ç« ï¼Œè«‹é‡æ–°æ•´ç†é é¢è©¦è©¦ã€‚");
    }
}

// === [ä¿®è¨‚ V2] è¿”å›åˆ—è¡¨ (ä¿®å¾©ï¼šæ¢å¾©åˆ—è¡¨é¡¯ç¤º) ===
function backToArticleList() {
    // 1. éš±è—è©³æƒ…é 
    const detailView = document.getElementById('featuredDetailView');
    if (detailView) detailView.style.display = 'none';
    
    // 2. é¡¯ç¤ºåˆ—è¡¨é  (é—œéµ)
    const listView = document.getElementById('featuredListView');
    if (listView) listView.style.display = 'block';

    // æ¢å¾© Body æ²å‹•
    document.body.style.overflow = 'auto';
    
    // åœæ­¢é˜²ç¡
    if (typeof stopFocusMonitor === 'function') stopFocusMonitor();

    // é‡æ–°éæ¿¾åˆ—è¡¨
    if (isBookmarkMode) {
        const bookmarks = getBookmarkedTitles();
        filteredArticles = allArticles.filter(a => bookmarks.includes(a.title));
        
        const searchInput = document.getElementById('articleSearchInput');
        if (searchInput && searchInput.value.trim() !== "") {
            const query = searchInput.value.trim().toLowerCase();
            filteredArticles = filteredArticles.filter(a => 
                a.title.toLowerCase().includes(query) || 
                a.author.toLowerCase().includes(query)
            );
        }
    }
    
    // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°ã€Œå·²è®€ã€ç‹€æ…‹
    renderArticleList();
}
// =======================================================
// === [ä¿®è¨‚ V5] é˜²å…¥ç¡å¤±ç¥ç›£å¯Ÿç³»çµ± (400ms è¼•éœ‡ç‰ˆ) ===
// =======================================================
 
// =======================================================
// === [ä¿®è¨‚ V6] é˜²å…¥ç¡å¤±ç¥ç›£å¯Ÿç³»çµ± (Web Audio API ç‰ˆ) ===
// =======================================================
// ç›£å¯Ÿç³»çµ±å…¨åŸŸç‹€æ…‹ (ç§»é™¤ audio ç‰©ä»¶ï¼Œæ”¹ç”¨ SansiAudio)
let focusMonitorState = {
    isActive: false,        
    lastActivityTime: 0,    
    checkInterval: null,    
    currentState: 'green'
};
// æª¢æŸ¥æœ¬åœ°æ˜¯å¦å·²ç¶“è§£é–éæ¬Šé™
let isFocusPermissionUnlocked = localStorage.getItem('sansi_focus_permission') === 'true';
function toggleFocusMonitor() {
    const btn = document.getElementById('focusMonitorBtn');
    if (!btn) return;
    if (!focusMonitorState.isActive) {
        // === [é–‹å•Ÿ] ===
        // â˜… é—œéµï¼šåœ¨é€™è£¡è§£é– iOS éŸ³è¨Š
        SansiAudio.unlock();
        activateFocusMonitor(btn);
    } else {
        // === [é—œé–‰] ===
        if (isFocusPermissionUnlocked) {
            stopFocusMonitor();
            if (navigator.vibrate) navigator.vibrate([30]);
            console.log("é˜²ç¡ç›£å¯Ÿå·²é—œé–‰ (å·²æˆæ¬Š)");
        } else {
            openFocusUnlockModal();
        }
    }
}
 
function activateFocusMonitor(btn) {
    // 1. é‡è¦ï¼šç”±é»æ“Šäº‹ä»¶ç›´æ¥è§¸ç™¼è§£é–
    SansiAudio.init();
    SansiAudio.unlock();
    
    focusMonitorState.isActive = true;
    focusMonitorState.lastActivityTime = Date.now();
    focusMonitorState.currentState = 'green';
    
    btn.innerHTML = '<i class="fas fa-eye"></i>';
    btn.classList.remove('minimized');
    btn.classList.add('focus-status-green');
    btn.title = "é˜²ç¡ç›£å¯Ÿä¸­ (é»æ“Šé—œé–‰)";
    
    // å•Ÿå‹•ç›£è½é‚è¼¯
    startFocusListeners();
    if (focusMonitorState.checkInterval) clearInterval(focusMonitorState.checkInterval);
    focusMonitorState.checkInterval = setInterval(checkFocusStatus, 1000);
    
    if(navigator.vibrate) navigator.vibrate([50]);
    console.log("âœ… é˜²ç¡ç›£å¯Ÿå·²å•Ÿå‹•ï¼ŒéŸ³è¨Šç®¡é“å·²æ›è¼‰");
}

 
// === [æ–°å¢] å¯†ç¢¼è¦–çª—æ§åˆ¶å‡½å¼ ===
 
function openFocusUnlockModal() {
    const modal = document.getElementById('focusUnlockModal');
    const input = document.getElementById('focusUnlockInput');
    
    if (modal) {
        modal.style.display = 'flex';
        input.value = ''; // æ¸…ç©ºèˆŠè¼¸å…¥
        setTimeout(() => input.focus(), 100); // è‡ªå‹•èšç„¦
    }
}
 
function closeFocusUnlockModal() {
    document.getElementById('focusUnlockModal').style.display = 'none';
}
 
// ==========================================
// === [é›²ç«¯è®€å–ç‰ˆ] å¯†ç¢¼é©—è­‰ ===
// ==========================================
async function verifyFocusPassword() {
    const input = document.getElementById('focusUnlockInput');
    const pwd = input.value.trim();
    const btn = event.target.closest('button');
    const user = firebase.auth().currentUser;
    
    if (!user) return alert("è«‹å…ˆç™»å…¥");

    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    try {
        const token = await user.getIdToken();
        
        // ç™¼é€è«‹æ±‚åˆ° GAS å¾Œç«¯é€²è¡Œé©—è­‰
        const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({
                token: token,
                action: 'verify_focus_password',
                data: { password: pwd }
            })
        });

        const result = await response.json();

        if (result.success) {
            // --- é©—è­‰æˆåŠŸ ---
            isFocusPermissionUnlocked = true;
            // é—œéµï¼šé€™è¡Œä¿è­‰äº†æ°¸ä¹…ä¸éœ€è¦å†è¼¸å…¥ï¼ˆé™¤éæ¸…é™¤ç€è¦½å™¨ç·©å­˜ï¼‰
            localStorage.setItem('sansi_focus_permission', 'true');
            
            alert("âœ… é©—è­‰æˆåŠŸï¼æ¬Šé™å·²é–‹é€šã€‚");
            closeFocusUnlockModal();
            stopFocusMonitor(); 
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error("é©—è­‰å¤±æ•—:", error);
        input.style.border = "1px solid #d69a92";
        input.value = "";
        input.placeholder = "å¯†ç¢¼éŒ¯èª¤";
        input.focus();
        setTimeout(() => { input.style.border = "1px solid #e0ddd7"; }, 2000);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
 
// åœæ­¢ä¸¦é‡ç½®ç›£å¯Ÿç³»çµ±
function stopFocusMonitor() {
    focusMonitorState.isActive = false;
    
    if (focusMonitorState.checkInterval) {
        clearInterval(focusMonitorState.checkInterval);
        focusMonitorState.checkInterval = null;
    }
    
    removeFocusListeners();
    stopAlarm(); // åœæ­¢ Web Audio
    if (typeof LeaveWarningSystem !== 'undefined') {
        LeaveWarningSystem.resetSystem();
    }
    
    const btn = document.getElementById('focusMonitorBtn');
    if (btn) {
        btn.className = "detail-float-btn scroll-hide-target";
        btn.innerHTML = '<i class="fas fa-eye-slash"></i>';   
        btn.title = "é–‹å•Ÿé˜²ç¡ç›£å¯Ÿ";
        btn.style.transform = "";
        btn.style.display = 'flex';
    }
}
 
// ==========================================
// === [ä¿®è¨‚] ä¸€èˆ¬æ¨¡å¼ç‹€æ…‹æª¢æŸ¥ (æ¥é€šæ–°éŸ³æ•ˆå¼•æ“) ===
// ==========================================
function checkFocusStatus() {
    if (!focusMonitorState.isActive) return;
    const now = Date.now();
    const idleTime = now - focusMonitorState.lastActivityTime;
    const btn = document.getElementById('focusMonitorBtn');
    
    const isMobile = window.innerWidth < 768;
    const LIMIT_ORANGE = isMobile ? 30000 : 60000;
    const LIMIT_RED    = isMobile ? 80000 : 100000;

    if (idleTime >= LIMIT_RED) {
        if (focusMonitorState.currentState !== 'red') {
            focusMonitorState.currentState = 'red';
            if (btn) {
                btn.classList.remove('focus-status-green', 'focus-status-orange');
                btn.classList.add('focus-status-red');
                if (!btn.classList.contains('minimized')) btn.innerHTML = '<i class="fas fa-bell"></i>';
            }
            // â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå‘¼å«æ–°å¼•æ“æ’­æ”¾
            console.log("ğŸš¨ [ä¸€èˆ¬è­¦å ±] è§¸ç™¼è²éŸ³æ’­æ”¾");
            SansiAudio.play('sleep_warning', true);
        }
        if (navigator.vibrate) navigator.vibrate(400);
        
    } else if (idleTime >= LIMIT_ORANGE) {
        if (focusMonitorState.currentState !== 'orange') {
            focusMonitorState.currentState = 'orange';
            if (btn) {
                btn.classList.remove('focus-status-green', 'focus-status-red');
                btn.classList.add('focus-status-orange');
                if (!btn.classList.contains('minimized')) btn.innerHTML = '<i class="fas fa-exclamation"></i>';
            }
            SansiAudio.stop('sleep_warning'); // æ©™ç‡ˆä¸éŸ¿
        }
    } else {
        if (focusMonitorState.currentState !== 'green') {
            focusMonitorState.currentState = 'green';
            if (btn) {
                btn.classList.remove('focus-status-orange', 'focus-status-red');
                btn.classList.add('focus-status-green');
                if (!btn.classList.contains('minimized')) btn.innerHTML = '<i class="fas fa-eye"></i>';
            }
            SansiAudio.stop('sleep_warning'); // ç¶ ç‡ˆä¸éŸ¿
        }
    }
}
 
// 3. ç”¨æˆ¶æ´»å‹•ç›£è½ (é‡ç½®è¨ˆæ™‚å™¨)
function resetFocusTimer() {
    if (!focusMonitorState.isActive) return;
    
    // æ›´æ–°æœ€å¾Œæ´»å‹•æ™‚é–“
    focusMonitorState.lastActivityTime = Date.now();
    
    // å¦‚æœè™•æ–¼ç´…ç‡ˆè­¦å ±ç‹€æ…‹ï¼Œä»»ä½•æ“ä½œæ‡‰ç«‹å³åœæ­¢è­¦å ±ä¸¦æ¢å¾©ç¶ ç‡ˆ
    if (focusMonitorState.currentState === 'red') {
        stopAlarm();
        checkFocusStatus(); // å¼·åˆ¶ç«‹å³åŸ·è¡Œä¸€æ¬¡æª¢æŸ¥ï¼Œå°‡ UI è®Šå›ç¶ è‰²
    }
}
 
function startFocusListeners() {
    // ç›£è½å„ç¨®ç”¨æˆ¶æ“ä½œ
    const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'touchmove', 'click'];
    events.forEach(evt => {
        document.addEventListener(evt, resetFocusTimer, { passive: true });
    });
    
    // é‡å°é–±è®€å®¹å™¨çš„å…§éƒ¨æ»¾å‹•
    const detailView = document.getElementById('featuredDetailView');
    if (detailView) {
        detailView.addEventListener('scroll', resetFocusTimer, { passive: true });
    }
}
 
function removeFocusListeners() {
    const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'touchmove', 'click'];
    events.forEach(evt => {
        document.removeEventListener(evt, resetFocusTimer);
    });
    
    const detailView = document.getElementById('featuredDetailView');
    if (detailView) {
        detailView.removeEventListener('scroll', resetFocusTimer);
    }
}
 
// ==========================================
// === [ä¿®è¨‚] å…¨å±€åœæ­¢è­¦å ± (ç¢ºä¿å¾¹åº•æ–·é–‹éŸ³è¨Š) ===
// ==========================================
function stopAlarm() {
    // â˜… ä¿®æ”¹ï¼šåŒæ™‚åœæ­¢å…©é¡è­¦å ±
    SansiAudio.stop('sleep_warning');
    SansiAudio.stop('leave_warning');
    
    if (navigator.vibrate) navigator.vibrate(0);
}
 
// === [é‡è¦] è¿”å›æ–‡ç« åˆ—è¡¨æ™‚ï¼Œå¼·åˆ¶åœæ­¢ç›£å¯Ÿ ===
const originalBackToArticleList = window.backToArticleList;
window.backToArticleList = function() {
    stopFocusMonitor(); 
    
    if (typeof originalBackToArticleList === 'function') {
        originalBackToArticleList();
    } else {
        const detailView = document.getElementById('featuredDetailView');
        if(detailView) detailView.style.display = 'none';
        document.body.style.overflow = 'auto';
        if (typeof renderArticleList === 'function') renderArticleList();
        const listView = document.getElementById('featuredListView');
        if(listView) listView.style.display = 'block';
    }
};
 
 
 

	
// 6. ä¿®è¨‚ï¼šè¿”å›åˆ—è¡¨æ™‚åˆ·æ–° (ç¢ºä¿å·²è®€ç‹€æ…‹ç«‹å³æ›´æ–°)
function backToArticleList() {
    const detailView = document.getElementById('featuredDetailView');
    detailView.style.display = 'none';
    
    // â˜…â˜…â˜… é—œéµï¼šæ¢å¾© Body æ²å‹• â˜…â˜…â˜…
    document.body.style.overflow = 'auto';
    
    // åœæ­¢é˜²ç¡åŠŸèƒ½ (å¦‚æœæ˜¯è‡ªå‹•é–‹å•Ÿçš„)
    if (typeof stopFocusMonitor === 'function') stopFocusMonitor();
 
    // é‡æ–°éæ¿¾ä¸¦æ¸²æŸ“åˆ—è¡¨ (ä¿æŒåŸæœ‰é‚è¼¯)
    if (isBookmarkMode) {
        const bookmarks = getBookmarkedTitles();
        filteredArticles = allArticles.filter(a => bookmarks.includes(a.title));
        
        const searchInput = document.getElementById('articleSearchInput');
        if (searchInput && searchInput.value.trim() !== "") {
            const query = searchInput.value.trim().toLowerCase();
            filteredArticles = filteredArticles.filter(a =>
                a.title.toLowerCase().includes(query) ||
                a.author.toLowerCase().includes(query)
            );
        }
    }
    
    renderArticleList();
    document.getElementById('featuredListView').style.display = 'block';
}
 
// æ›´æ–°ï¼šåœ¨å…¨åŸŸçš„ returnToHome å‡½å¼ä¸­åŠ å…¥éš±è— featuredContainer
// è«‹è¨˜å¾—åœ¨ä½ çš„ window.returnToHome = function() {...} è£¡é¢çš„ containers é™£åˆ—åŠ å…¥ 'featuredContainer'

	
</script>


<script>


// =======================================================
// === [æ–°å¢] æ…¢è®€åŠŸèƒ½æ ¸å¿ƒé‚è¼¯ (æ•´åˆç‰ˆ) ===
// =======================================================

let readerState = {
    segments: [],
    currentIndex: 0,
    timerSeconds: 7, // é è¨­ 7 ç§’
    timerInterval: null,
    isReading: false,
    pressTimer: null,
    visualPauseTimer: null,
    lastTouchTime: 0
};

// 1. åˆå§‹åŒ–æ…¢è®€è¨­å®š (é é¢è¼‰å…¥æ™‚åŸ·è¡Œä¸€æ¬¡)
document.addEventListener('DOMContentLoaded', () => {
    initSlowReaderEvents();
});


// =======================================================
// === [ä¿®è¨‚ç‰ˆ] æ…¢è®€å°ˆç”¨é˜²ç¡ç®¡ç†å™¨ (1åˆ†é˜/1åˆ†åŠé˜ç‰ˆ) ===
// =======================================================
const SlowReaderFocusManager = {
    checkTimer: null,
    warningTimer: null,
    isPrompting: false,
    
    // æ™‚é–“è¨­å®šï¼š
    // 60,000ms = 1åˆ†é˜ (è®Šæ©™è‰²)
    // 30,000ms = å†é30ç§’å³ç¸½å…±1åˆ†åŠé˜ (è®Šç´…è‰² + éŸ¿éˆ´)
    INTERVAL_MS: 60 * 1000, 
    WARNING_MS: 30 * 1000,
    
    initUI: function() {
        let indicator = document.getElementById('slowReaderFocusIndicator');
        if (!indicator) {
            indicator = document.createElement('button');
            indicator.id = 'slowReaderFocusIndicator';
            indicator.innerHTML = '';
            
            // é»æ“Šç‡ˆè™Ÿé‚è¼¯ï¼šæ…¢è®€æ™‚é»æ“Šå³ç¿»é ä¸¦é‡ç½®é˜²ç¡
            indicator.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (readerState.isReading) {
                    this.handleUserActivity(); // é‡ç½®é˜²ç¡
                    if (typeof goToNextReaderPage === 'function') goToNextReaderPage();
                    if (typeof startReaderAutoPage === 'function') startReaderAutoPage();
                    return;
                }
                
                // éæ…¢è®€ç‹€æ…‹ä¸‹çš„é»æ“Šè™•ç†
                if (this.isPrompting) {
                    this.handleUserActivity();
                } else {
                    this.toggle();
                }
            };
            document.body.appendChild(indicator);
        }
    },

    // å•Ÿå‹•ç›£å¯Ÿ
    start: function() {
        this.initUI();
        const indicator = document.getElementById('slowReaderFocusIndicator');
        
        if (typeof focusMonitorState !== 'undefined' && focusMonitorState.isActive) {
            console.log("ğŸ”Š æ…¢è®€é˜²ç¡ï¼šå•Ÿå‹•ç›£å¯Ÿ (60s Check)");
            indicator.style.display = 'block';
            this.resetMainTimer();
            
            // é—œé–‰ä¸€èˆ¬æ¨¡å¼çš„è¨ˆæ™‚å™¨ï¼Œé¿å…äº’ç›¸è¡çª
            if (focusMonitorState.checkInterval) {
                clearInterval(focusMonitorState.checkInterval);
                focusMonitorState.checkInterval = null;
            }
        } else {
            indicator.style.display = 'none';
            this.stop();
        }
    },

    // åœæ­¢ç›£å¯Ÿ
    stop: function() {
        clearTimeout(this.checkTimer);
        clearTimeout(this.warningTimer);
        this.isPrompting = false;
        
        const indicator = document.getElementById('slowReaderFocusIndicator');
        if(indicator) indicator.style.display = 'none';

        // åœæ­¢æ‰€æœ‰è­¦å ±éŸ³
        if (typeof SansiAudio !== 'undefined') {
            SansiAudio.stop('sleep_warning');
        }
        
        // æ¢å¾©ä¸€èˆ¬æ¨¡å¼çš„èƒŒæ™¯ç›£æ¸¬ (å¦‚æœé˜²ç¡ç¸½é–‹é—œä»æ˜¯é–‹å•Ÿçš„)
        if (typeof focusMonitorState !== 'undefined' && focusMonitorState.isActive) {
            focusMonitorState.checkInterval = setInterval(checkFocusStatus, 1000);
            focusMonitorState.lastActivityTime = Date.now();
        }
    },

    // é‡ç½®è¨ˆæ™‚å™¨ (ä½¿ç”¨è€…æ“ä½œå¾Œå‘¼å«)
    resetMainTimer: function() {
        clearTimeout(this.checkTimer);
        clearTimeout(this.warningTimer);
        this.isPrompting = false;
        
        // åœæ­¢å¯èƒ½æ­£åœ¨æ’­æ”¾çš„è²éŸ³
        if (typeof SansiAudio !== 'undefined') {
            SansiAudio.stop('sleep_warning');
        }
        
        const indicator = document.getElementById('slowReaderFocusIndicator');
        if(indicator) {
            indicator.className = 'status-green';
            indicator.innerHTML = '';
        }

        // å•Ÿå‹•ç¬¬ä¸€éšæ®µè¨ˆæ™‚ (1åˆ†é˜)
        this.checkTimer = setTimeout(() => {
            this.showPrompt();
        }, this.INTERVAL_MS);
    },

    // é¡¯ç¤ºæ©™è‰²æç¤º (é€²å…¥1åˆ†é˜é–’ç½®)
    showPrompt: function() {
        this.isPrompting = true;
        const indicator = document.getElementById('slowReaderFocusIndicator');
        if(indicator) {
            indicator.className = 'status-prompt';
        }
        console.log("ğŸ“ æ…¢è®€é˜²ç¡ï¼š1åˆ†é˜å·²åˆ°ï¼Œè½‰æ©™ç‡ˆ");

        // å•Ÿå‹•ç¬¬äºŒéšæ®µè¨ˆæ™‚ (å†é30ç§’ï¼Œç¸½å…±1åˆ†åŠ)
        this.warningTimer = setTimeout(() => {
            this.triggerAlarm();
        }, this.WARNING_MS);
    },

    // è§¸ç™¼ç´…è‰²è­¦å ± (é€²å…¥1åˆ†åŠé–’ç½®)
    triggerAlarm: function() {
        const indicator = document.getElementById('slowReaderFocusIndicator');
        if(indicator) {
            indicator.className = 'status-red';
        }
        console.log("ğŸš¨ æ…¢è®€é˜²ç¡ï¼š1åˆ†åŠå·²åˆ°ï¼Œè§¸ç™¼è­¦å ±");
        
        // æ’­æ”¾è­¦å‘ŠéŸ³ (ä½¿ç”¨ iOS å‹å–„çš„æ–°å¼•æ“)
        if (typeof SansiAudio !== 'undefined') {
            SansiAudio.play('sleep_warning', true);
        }
        
        // åŸ·è¡Œéœ‡å‹•æ‡²ç½°
        if (navigator.vibrate) {
            navigator.vibrate([400, 200, 400, 200, 400]);
        }
    },
    
    // çµ±ä¸€çš„ä½¿ç”¨è€…æ´»å‹•å›é¥‹
    handleUserActivity: function() {
        this.resetMainTimer();
    },

    // ç¸½é–‹é—œåˆ‡æ›
    toggle: function() {
        if (focusMonitorState.isActive) {
            focusMonitorState.isActive = false;
            this.stop();
            const globalBtn = document.getElementById('focusMonitorBtn');
            if(globalBtn) {
                globalBtn.className = "detail-float-btn scroll-hide-target";
                globalBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
            }
            alert("é˜²ç¡ç›£å¯Ÿå·²é—œé–‰");
        } else {
            // é–‹å•Ÿæ™‚å…ˆè§£é–éŸ³è»Œç®¡é“ (iOS å¿…è¦)
            if (typeof SansiAudio !== 'undefined') {
                SansiAudio.unlock();
            }
            focusMonitorState.isActive = true;
            this.start();
        }
    }
};

	
function initSlowReaderEvents() {
    const overlay = document.getElementById('slowReaderOverlay');
    if (!overlay) return;

    // ç¶å®šè§¸æ§/æ»‘é¼ äº’å‹•
    overlay.addEventListener('mousedown', handleReaderInteractStart);
    overlay.addEventListener('mouseup', handleReaderInteractEnd);
    overlay.addEventListener('touchstart', handleReaderInteractStart, {passive: false});
    overlay.addEventListener('touchend', handleReaderInteractEnd, {passive: false});
    
    // é˜²æ­¢å³éµé¸å–®
    overlay.addEventListener('contextmenu', (e) => { e.preventDefault(); e.stopPropagation(); return false; });
}

// 2. å•Ÿå‹•æ…¢è®€ (ä¿®å¾©ç‰ˆï¼šæ¸…é™¤ HTML æ¨™ç±¤)
function startSlowRead(encodedContent) {
    let rawContent = decodeURIComponent(encodedContent);
    
    // === [æ–°å¢] æ¸…æ´— HTML æ¨™ç±¤é‚è¼¯ ===
    
    // 1. ç§»é™¤é–‹é ­çš„è©©æ­Œæ¨™è¨˜ <br> (ä¸åˆ†å¤§å°å¯«)
    rawContent = rawContent.replace(/^\s*<br\s*\/?>/i, '');

    // 2. å°‡æ–‡ä¸­å…¶é¤˜çš„ <br> è½‰æ›ç‚ºæ›è¡Œç¬¦è™Ÿ \n
    // é€™æ¨£æ…¢è®€ç³»çµ±æœƒå°‡å…¶è¦–ç‚ºæ®µè½åˆ†éš”ï¼Œè®€èµ·ä¾†æœƒåœé “ï¼Œç¬¦åˆè©©æ­Œç¯€å¥
    rawContent = rawContent.replace(/<br\s*\/?>/gi, '\n');

    // 3. ç§»é™¤ç²—é«”æ¨™ç±¤ <b>, </b>, <strong>, </strong>
    // æ…¢è®€å¼·èª¿æ–‡å­—æœ¬èº«ï¼Œç›´æ¥ç§»é™¤æ¨™ç±¤ç¢¼ä»¥å…é¡¯ç¤ºå‡ºä¾†
    rawContent = rawContent.replace(/<\/?b>/gi, '').replace(/<\/?strong>/gi, '');

    // === [æ¸…æ´—çµæŸ] ===

    // A. æ–·å¥è™•ç† (åƒè€ƒ Slow Reader é‚è¼¯)
    // çµ±ä¸€å¼•è™Ÿä¸¦åŠ å…¥æ®µè½æ¨™è¨˜
    const correctedText = rawContent.replace(/â€œ/g, 'ã€Œ').replace(/â€/g, 'ã€');
    const textWithMarkers = '__NEW_PARA__' + correctedText.replace(/\n\s*/g, '__NEW_PARA__');
    
    // åŸ·è¡Œåˆ‡åˆ†
    segmentTextForReader(textWithMarkers);
    
    if (readerState.segments.length === 0) {
        alert("æ–‡ç« å…§å®¹éçŸ­ï¼Œç„¡æ³•æ…¢è®€ã€‚");
        return;
    }

    // B. é‡ç½®ç‹€æ…‹
    readerState.currentIndex = 0;
    readerState.isReading = true;
    
    // C. é¡¯ç¤ºä»‹é¢
    const overlay = document.getElementById('slowReaderOverlay');
    overlay.style.display = 'flex';
    
    // D. é–‹å§‹æ’­æ”¾
    displayReaderSegment(0);
    startReaderAutoPage();

   // â˜…â˜…â˜… [æ–°å¢] å•Ÿå‹•é˜²ç¡ç®¡ç†å™¨ â˜…â˜…â˜…
    SlowReaderFocusManager.start();

	
}

// 3. é—œé–‰æ…¢è®€
function closeSlowRead() {
    stopReaderAutoPage();
	    // â˜…â˜…â˜… [æ–°å¢] åœæ­¢é˜²ç¡ç®¡ç†å™¨ â˜…â˜…â˜…
    SlowReaderFocusManager.stop();
    document.getElementById('slowReaderOverlay').style.display = 'none';
    
    // é‡ç½® pointer-events (ç‚ºäº†ä¸‹æ¬¡é–‹å•Ÿæ­£å¸¸é‹ä½œ)
    const displayWrapper = document.getElementById('reader-display-wrapper');
    if(displayWrapper) displayWrapper.style.pointerEvents = "none";

    // â˜…â˜…â˜… æ–°å¢ï¼šåˆ¤æ–·æ˜¯å¦è®€å®Œï¼Œè®€å®Œå‰‡æ»¾å‹•åˆ°è³æ â˜…â˜…â˜…
    // é‚è¼¯ï¼šå¦‚æœç›®å‰ç´¢å¼•å·²åˆ°é”æœ€å¾Œä¸€æ®µ
    if (readerState.segments.length > 0 && readerState.currentIndex >= readerState.segments.length - 1) {
        
        const analysisSec = document.getElementById('articleAnalysisSection');
        if (analysisSec) {
            // çµ¦äºˆä¸€é»å»¶é²ï¼Œè®“æ…¢è®€é®ç½©å®Œå…¨æ¶ˆå¤±å¾Œå†æ»¾å‹•ï¼Œé«”é©—æ›´é †æš¢
            setTimeout(() => {
                analysisSec.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }

    readerState.isReading = false;
}

// 4. è¨­å®šè¦–çª—æ§åˆ¶
function openReaderSettings() {
    document.getElementById('readerSettingsModal').style.display = 'flex';
    document.getElementById('readerSettingDisplay').innerText = readerState.timerSeconds;
}

function adjustReaderTimer(delta) {
    let newSec = readerState.timerSeconds + delta;
    if (newSec < 3) newSec = 3; // æœ€å° 3 ç§’
    if (newSec > 60) newSec = 60;
    readerState.timerSeconds = newSec;
    document.getElementById('readerSettingDisplay').innerText = newSec;
}

// 5. æ–·å¥æ ¸å¿ƒé‚è¼¯ (ç§»æ¤è‡ª Slow Reader)
function segmentTextForReader(text) {
    const segments = [];
    const paragraphs = text.split('__NEW_PARA__');
    let pCounter = 1;

    paragraphs.forEach(para => {
        if (!para) return;
        
        // ç¬¦è™Ÿåˆ†å‰²
        let temp = para.replace(/([ã€‚ï¼Ÿï¼\.])/g, "$1|SPLIT|");
        let sentences = temp.split('|SPLIT|');
        let currentParaSentences = [];

        // åˆä½µå­¤å…’å¼•è™Ÿ
        for (let i = 0; i < sentences.length; i++) {
            let s = sentences[i];
            if (!s || s.trim() === '') continue;
            
            const badStartRegex = /^(["â€'ã€ã€\)ã€‚ï¼Ÿï¼\.]+)(.*)/s;
            const match = s.match(badStartRegex);
            
            if (match && currentParaSentences.length > 0) {
                currentParaSentences[currentParaSentences.length - 1] += match[1];
                if (match[2] && match[2].trim()) {
                    currentParaSentences.push(match[2]);
                }
            } else {
                currentParaSentences.push(s);
            }
        }

        // é€—è™Ÿéå¤šåˆ†å‰² (æ¯é æœ€å¤š 5 å€‹é€—è™Ÿ)
        currentParaSentences.forEach((sentence, idx) => {
            const commaCount = (sentence.match(/[ï¼Œ,]/g) || []).length;
            if (commaCount <= 4) {
                segments.push({
                    text: sentence,
                    paraNumber: idx === 0 ? pCounter++ : null
                });
            } else {
                const parts = splitReaderSentenceByCommas(sentence, 5);
                parts.forEach((part, partIdx) => {
                    segments.push({
                        text: part,
                        paraNumber: (idx === 0 && partIdx === 0) ? pCounter++ : null
                    });
                });
            }
        });
    });
    readerState.segments = segments;
}

function splitReaderSentenceByCommas(sentence, max) {
    const result = [];
    let currentPart = '';
    let commaCount = 0;
    let quoteStack = [];

    for (let i = 0; i < sentence.length; i++) {
        const char = sentence[i];
        currentPart += char;

        if (['ã€Œ','ã€','ï¼ˆ','[','{'].includes(char)) quoteStack.push(char);
        else if (['ã€','ã€','ï¼‰',']','}'].includes(char)) quoteStack.pop();
        else if (['ï¼Œ',','].includes(char) && quoteStack.length === 0) {
            commaCount++;
            if (commaCount >= max) {
                result.push(currentPart);
                currentPart = '';
                commaCount = 0;
            }
        }
    }
    if (currentPart.trim()) result.push(currentPart);
    return result;
}

// 6. é¡¯ç¤ºé‚è¼¯
function displayReaderSegment(index) {
    const displayWrapper = document.getElementById('reader-display-wrapper');
    const paraNum = document.getElementById('reader-para-num');
    const textDisplay = document.getElementById('reader-text');
    const progressBar = document.getElementById('reader-progress-bar');

    if (index >= 0 && index < readerState.segments.length) {
        const seg = readerState.segments[index];
        
        displayWrapper.classList.add('fade-out');
        
        setTimeout(() => {
            paraNum.textContent = seg.paraNumber !== null ? seg.paraNumber : '';
            textDisplay.textContent = seg.text;
            displayWrapper.classList.remove('fade-out');
            
            // æ›´æ–°é€²åº¦æ¢
            const perc = ((index + 1) / readerState.segments.length) * 100;
            progressBar.style.width = `${perc}%`;
        }, 600);
    }
}

// 7. è‡ªå‹•ç¿»é æ§åˆ¶
function startReaderAutoPage() {
    stopReaderAutoPage();
    readerState.timerInterval = setInterval(() => {
        if (readerState.isReading) {
            goToNextReaderPage();
        }
    }, readerState.timerSeconds * 1000);
}

function stopReaderAutoPage() {
    if (readerState.timerInterval) {
        clearInterval(readerState.timerInterval);
        readerState.timerInterval = null;
    }
}

function goToNextReaderPage() {
    // é€™è£¡ç§»é™¤äº† SlowReaderFocusManager.handleUserActivity();
    // é€™æ¨£è‡ªå‹•ç¿»é å°±ä¸æœƒè¢«è¦–ç‚ºç”¨æˆ¶æ´»èº

    if (readerState.currentIndex < readerState.segments.length - 1) {
        readerState.currentIndex++;
        displayReaderSegment(readerState.currentIndex);
    } else {
        stopReaderAutoPage();
        
        const displayWrapper = document.getElementById('reader-display-wrapper');
        const paraNum = document.getElementById('reader-para-num');
        const textDisplay = document.getElementById('reader-text');
        
        displayWrapper.classList.add('fade-out');
        
        setTimeout(() => {
            paraNum.textContent = '';
            textDisplay.innerHTML = `
                <div style="text-align: center; width: 100%; margin-top: 20px;">
                    <span style="font-family: 'Noto Serif TC', serif; color: #a1887f; font-size: 1.2rem; letter-spacing: 0.5em; opacity: 0.8; display: block; margin-bottom: 20px;">
                        â€” å®Œ â€”
                    </span>
                    <button onclick="closeSlowRead()" style="pointer-events: auto; background-color: transparent; border: 1px solid #a1887f; color: #a1887f; padding: 8px 20px; border-radius: 20px; font-family: 'Noto Serif TC', serif; cursor: pointer; transition: all 0.3s;">
                        çµæŸé–±è®€
                    </button>
                </div>
            `;
            
            displayWrapper.style.pointerEvents = "auto";
            displayWrapper.classList.remove('fade-out');
            document.getElementById('reader-progress-bar').style.width = '100%';
        }, 600);
    }
}

function goToPrevReaderPage() {
    // æ‰‹å‹•é»æ“Šä¸Šä¸€é ï¼Œè¦–ç‚ºæ´»èº
    if (typeof SlowReaderFocusManager !== 'undefined') {
        SlowReaderFocusManager.handleUserActivity();
    }

    if (readerState.currentIndex > 0) {
        readerState.currentIndex--;
        displayReaderSegment(readerState.currentIndex);
    }
}

	
function handleReaderInteractStart(e) {
    if (e.target.closest('button')) return;
    if (e.type === 'touchstart') e.preventDefault();
    if (!readerState.isReading) return;

    // æ‰‹æŒ‡æŒ‰ä¸‹ï¼Œè¦–ç‚ºæ´»èº
    if (typeof SlowReaderFocusManager !== 'undefined') {
        SlowReaderFocusManager.handleUserActivity();
    }

    stopReaderAutoPage();
    readerState.pressTimer = Date.now();
    
    readerState.visualPauseTimer = setTimeout(() => {
        document.getElementById('reader-pause-indicator').style.opacity = '1';
    }, 250); 
}

// 9. äº’å‹•æ§åˆ¶ (é•·æŒ‰æš«åœã€é»æ“Šç¿»é )
function handleReaderInteractStart(e) {
    // å¿½ç•¥æŒ‰éˆ•é»æ“Š
    if (e.target.closest('button')) return;
    
    if (e.type === 'touchstart') e.preventDefault();
    if (!readerState.isReading) return;

    stopReaderAutoPage();
    readerState.pressTimer = Date.now();
    
    readerState.visualPauseTimer = setTimeout(() => {
        document.getElementById('reader-pause-indicator').style.opacity = '1';
    }, 250); // é•·æŒ‰é–¾å€¼
}

function handleReaderInteractEnd(e) {
    if (e.target.closest('button')) return;
    if (e.type === 'touchend') e.preventDefault();
    if (!readerState.isReading || !readerState.pressTimer) return;

    // æ‰‹æŒ‡æ”¾é–‹ï¼Œè¦–ç‚ºæ´»èº
    if (typeof SlowReaderFocusManager !== 'undefined') {
        SlowReaderFocusManager.handleUserActivity();
    }

    if (readerState.visualPauseTimer) {
        clearTimeout(readerState.visualPauseTimer);
        readerState.visualPauseTimer = null;
    }
    document.getElementById('reader-pause-indicator').style.opacity = '0';

    const duration = Date.now() - readerState.pressTimer;
    readerState.pressTimer = null;

    // çŸ­æŒ‰ï¼šç¿»é 
    if (duration < 250) {
        const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
        const screenWidth = window.innerWidth;
        
        if (clientX < screenWidth / 2) {
            goToPrevReaderPage();
        } else {
            // æ‰‹å‹•é»æ“Šä¸‹ä¸€é 
            goToNextReaderPage(); 
            startReaderAutoPage(); 
        }
    } 
}

	

/**
 * è‡ªå‹•ç¸®æ”¾æ–‡å­—å¤§å°å‡½æ•¸ (ä¿®æ­£ç‰ˆï¼šç¸®å° -> æ›è¡Œï¼Œä¸é¡¯ç¤ºçœç•¥è™Ÿ)
 * @param {HTMLElement} element - è¦èª¿æ•´çš„ DOM å…ƒç´ 
 * @param {number} minSize - æœ€å°å­—é«”å¤§å° (px)
 * @param {number} maxSize - æœ€å¤§(åŸå§‹)å­—é«”å¤§å° (px)
 */
function fitTextToContainer(element, minSize, maxSize) {
    // 1. é‡ç½®ç‚ºåˆå§‹ç‹€æ…‹ï¼šå–®è¡Œã€æœ€å¤§å­—é«”
    element.style.fontSize = maxSize + "px";
    element.classList.remove('auto-fit-wrap');
    
    // 2. ç²å–å®¹å™¨å¯¬åº¦ (clientWidth) èˆ‡ å…§å®¹å¯¦éš›å¯¬åº¦ (scrollWidth)
    // ç¨å¾®æ¸›å» 2px ç·©è¡ï¼Œé¿å…é‚Šç·£èª¤å·®å°è‡´æ›è¡Œ
    let containerWidth = element.clientWidth;
    let currentSize = maxSize;

    // 3. è¿´åœˆç¸®å°å­—é«” (ç•¶ å…§å®¹å¯¬åº¦ > å®¹å™¨å¯¬åº¦ ä¸” å­—é«” > æœ€å°å€¼)
    while (element.scrollWidth > containerWidth && currentSize > minSize) {
        currentSize--; 
        element.style.fontSize = currentSize + "px";
    }

    // 4. æœ€çµ‚åˆ¤æ–·
    // å¦‚æœç¸®åˆ°æœ€å°å­—é«”äº†ï¼Œå…§å®¹é‚„æ˜¯æ¯”å®¹å™¨å¯¬ï¼Œé‚£å°±å…è¨±æ›è¡Œ
    if (element.scrollWidth > containerWidth) {
        element.style.fontSize = minSize + "px"; // é–å®šåœ¨æœ€å°å­—é«”
        element.classList.add('auto-fit-wrap');  // åŠ å…¥æ›è¡Œæ¨£å¼
    } else {
        // å¦‚æœç¸®å°å¾Œå¡å¾—ä¸‹ï¼Œç¢ºä¿æ–‡å­—å¯è¦‹ (é›–ç„¶é è¨­ overflow:hidden ä½†ç‚ºäº†ä¿éšª)
        element.style.overflow = "visible";
    }
}

	
</script>

<script>



// === [æ–°å¢] é–±è®€è³‡æºé¸å–®é‚è¼¯ ===

// 1. æ‰“é–‹é¸å–®
function openBookResourceMenu() {
    // å…ˆæ”¶èµ·å´é‚Šæ¬„
    const sideMenu = document.getElementById('sideMenu');
    if (sideMenu) {
        sideMenu.classList.remove('active');
        document.getElementById('sideMenuToggle').classList.remove('active');
    }
    // é¡¯ç¤ºé¸æ“‡è¦–çª—
    document.getElementById('bookResourceModal').style.display = 'flex';
}

// 2. é—œé–‰é¸å–® (é»æ“ŠèƒŒæ™¯é—œé–‰)
function closeBookResourceMenu(event) {
    if (event.target.id === 'bookResourceModal') {
        document.getElementById('bookResourceModal').style.display = 'none';
    }
}

// 3. é€²å…¥ã€Œèª²å¤–æ›¸ç±è¨è«–ã€
function enterBooksChatFromMenu() {
    document.getElementById('bookResourceModal').style.display = 'none';
    
    // ç›´æ¥å‘¼å«åŸæœ¬çš„å®¹å™¨é¡¯ç¤ºå‡½å¼
    showContainer('booksContainer');
}

// 4. é€²å…¥ã€Œç²¾é¸æ–‡ç« ã€
function enterFeaturedFromMenu() {
    document.getElementById('bookResourceModal').style.display = 'none';
    
    // å‘¼å«åŸæœ¬çš„æ¬Šé™æª¢æŸ¥èˆ‡é€²å…¥å‡½å¼
    checkFeaturedAccess();
}
	
</script>
	


<!-- === æ–°å¢ï¼šé–±è®€è³‡æºé¸æ“‡è¦–çª— (äºŒåˆä¸€) === -->
<div id="bookResourceModal" class="report-menu-overlay" onclick="closeBookResourceMenu(event)" style="z-index: 20005;">
    <div class="report-menu-content">
        <div class="report-menu-title" style="color: #5d4037;">é–±è®€è³‡æºé¸æ“‡</div>
        
        <div class="report-options-grid">
            
            <!-- é¸é … 1ï¼šèª²å¤–æ›¸ç±è¨è«– -->
            <div class="report-option-card" onclick="enterBooksChatFromMenu()">
                <!-- é€™è£¡ä½¿ç”¨æ›¸æœ¬åœ–ç¤ºé…åˆè«è˜­è¿ªç¶ è‰² -->
                <i class="fas fa-comments report-option-icon" style="color: #8fa398;"></i>
                <span class="report-option-text">æ›¸ç±è¨è«–</span>

            </div>

            <!-- é¸é … 2ï¼šç²¾é¸æ–‡ç«  (æ–‡èƒ) -->
            <div class="report-option-card" onclick="enterFeaturedFromMenu()">
                <!-- é€™è£¡ä½¿ç”¨ç¾½æ¯›ç­†åœ–ç¤ºé…åˆè«è˜­è¿ªç´…è‰² -->
                <i class="fas fa-book-open report-option-icon" style="color: #d69a92;"></i>
                <span class="report-option-text">ä½œå®¶æ–‡ç²¹</span>
                
            </div>

        </div>
    </div>
</div>


	


<!-- === æ–°å¢ï¼šç­è™Ÿå¼·åˆ¶æ›´æ–°è¦–çª— (è«è˜­è¿ªé¢¨æ ¼) === -->
<div id="classNumberUpdateModal" class="books-modal" style="z-index: 200000; background-color: rgba(253, 252, 248, 0.95); backdrop-filter: blur(5px);">
    <!-- â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šåŠ å…¥ width: 85%; ä»¥åŠ margin: auto; ç¢ºä¿æ‰‹æ©Ÿç‰ˆå·¦å³ç•™ç™½ â˜…â˜…â˜… -->
    <div class="modal-content" style="width: 85%; max-width: 350px; text-align: center; border: 1px solid #e0ddd7; border-radius: 16px; box-shadow: 0 10px 30px rgba(141, 110, 99, 0.15); margin: auto;">
        
        <div style="margin-bottom: 20px;">
            <i class="fas fa-user-edit" style="font-size: 3rem; color: #8fa398; margin-bottom: 10px;"></i>
            <h3 style="color: #5e5e5e; margin: 0; font-size: 1.4rem;">æ›´æ–°ç­è™Ÿ</h3>
            <p style="color: #888; font-size: 0.95rem; margin-top: 10px;">æ–°å­¸å¹´é–‹å§‹ï¼Œè«‹è¼¸å…¥æ‚¨çš„æ–°ç­è™Ÿã€‚</p>
        </div>
 
        <!-- ç­è™Ÿé¸æ“‡å™¨ -->
        <select id="newClassNumberSelect" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 1.2rem; text-align: center; margin-bottom: 25px; background-color: #fff;">
            <!-- JS æœƒè‡ªå‹•å¡«å…¥ 1-35 -->
        </select>
 
        <button onclick="confirmClassNumberUpdate()" class="btn-action" style="width: 100%; justify-content: center; font-size: 1.1rem; padding: 12px; background-color: #8fa398; border: none; box-shadow: 0 4px 10px rgba(143, 163, 152, 0.4);">
            ç¢ºèªæ›´æ–°
        </button>
    </div>
</div>


<!-- === API æ•…éšœå‚™ç”¨ç·šè·¯æç¤ºè¦–çª— === -->
<div id="backupAlertModal" class="backup-alert-overlay">
    <div class="backup-alert-card">
        <div class="backup-alert-icon">
            <i class="fas fa-wifi"></i>
        </div>
        <div class="backup-alert-title">é€£ç·šä¸ç©©</div>
        <div class="backup-alert-desc">
            ç³»çµ±åµæ¸¬åˆ°å¤šæ¬¡é€£ç·šç•°å¸¸ã€‚<br>
            å»ºè­°åˆ‡æ›è‡³å‚™ç”¨ç·šè·¯ä»¥ç¢ºä¿é«”é©—ã€‚
        </div>
        <div class="backup-btn-group">
            <button class="backup-btn btn-stay" onclick="closeBackupAlert()">ç¨å¾Œ</button>
            <button class="backup-btn btn-switch" onclick="window.open('https://sansi.vercel.app/', '_blank'); closeBackupAlert();">
                <i class="fas fa-external-link-alt"></i> å‰å¾€
            </button>
        </div>
    </div>
</div>


<!-- === [æ–°å¢] é–±è®€é€²åº¦æ¢ (å°‡æœƒè¢« JS æ’å…¥æˆ–æ§åˆ¶) === -->
<!-- è¨»ï¼šæ­¤å…ƒç´ å¯¦éš›ä¸Šæœƒé€é JS å‹•æ…‹æ§åˆ¶ï¼Œé€™è£¡å…ˆé å‚™è¦–çª—çµæ§‹ -->
<div id="loginRequiredModal" class="backup-alert-overlay">
    <div class="backup-alert-card">
        <div class="backup-alert-icon" style="color: #7da3c0;"> <!-- æ”¹ç‚ºç°è—è‰²åœ–ç¤º -->
            <i class="fas fa-lock"></i>
        </div>
        <div class="backup-alert-title" style="color: #546e7a;">æœƒå“¡é™å®š</div>
        <div class="backup-alert-desc">
            æ­¤åŠŸèƒ½ç‚ºæœƒå“¡å°ˆå±¬ã€‚<br>
            è«‹å…ˆç™»å…¥æˆ–è¨»å†Šå­¸æ ¡å¸³è™Ÿä»¥é–±è¦½ã€‚
        </div>
        <div class="backup-btn-group">
            <button class="backup-btn btn-stay" onclick="document.getElementById('loginRequiredModal').style.display='none'">ç¨å¾Œ</button>
            <button class="backup-btn" style="background-color: #7da3c0; color: white; box-shadow: 0 4px 12px rgba(125, 163, 192, 0.4);" onclick="document.getElementById('loginRequiredModal').style.display='none'; openStudentLoginModal();">
                <i class="fas fa-sign-in-alt"></i> ç™»å…¥
            </button>
        </div>
    </div>
</div>


<!-- === [æ–°å¢] æ…¢è®€åŠŸèƒ½ä»‹é¢ === -->

<!-- 1. æ…¢è®€å…¨è¢å¹•é¡¯ç¤ºå±¤ -->
<div id="slowReaderOverlay">
    <div id="reader-progress-bar"></div>
    <div id="reader-pause-indicator">æš«åœ</div>
    
    <!-- æ…¢è®€å³ä¸Šè§’é—œé–‰éµ -->
    <button class="detail-float-btn close-mode" 
            style="position: fixed; top: 20px; right: 25px; z-index: 30005;" 
            onclick="closeSlowRead()" title="é—œé–‰æ…¢è®€">
        <i class="fas fa-times"></i>
    </button>

    <div id="reader-display-wrapper">
        <div id="reader-para-num"></div>
        <div id="reader-text"></div>
    </div>
</div>

<!-- 2. ç¿»é ç§’æ•¸è¨­å®šè¦–çª— -->
<div id="readerSettingsModal" onclick="if(event.target === this) this.style.display='none'">
    <div class="settings-card">
        <h3 style="margin:0 0 10px 0; color:#5d4037;">ç¿»é é€Ÿåº¦è¨­å®š</h3>
        <p style="color:#999; font-size:0.9rem; margin:0;">(ç§’/é )</p>
        
        <div class="timer-adjuster">
            <button class="timer-btn" onclick="adjustReaderTimer(-1)"><i class="fas fa-minus"></i></button>
            <span id="readerSettingDisplay" class="timer-display">7</span>
            <button class="timer-btn" onclick="adjustReaderTimer(1)"><i class="fas fa-plus"></i></button>
        </div>
        
     <div style="text-align: center; margin-top: 15px;">
     <button onclick="document.getElementById('readerSettingsModal').style.display='none'" 
            style="background: #8fa398; border: none; color: white; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(143, 163, 152, 0.4); font-size: 1.1rem; transition: transform 0.2s; display: inline-flex; align-items: center; justify-content: center;">
        <i class="fas fa-play" style="padding-left: 4px;"></i>
    </button>
</div>
    </div>
</div>


<!-- ç¢ºä¿é€™æ®µè©±åœ¨ </body> ä¹‹å‰ï¼Œä¸”è¢« <script> åŒ…è£¹ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (auth) {
        // å¼·åˆ¶è¨­å®šç‚ºæœ¬åœ°æŒä¹…åŒ–
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
            // ç›£è½ Auth ç‹€æ…‹æ”¹è®Š
            auth.onAuthStateChanged(async (user) => {
                const s = JSON.parse(localStorage.getItem('studentProfile'));
                if (user && s) {
                    console.log("âœ… èªè­‰å·²æ¢å¾©:", user.email);
                    checkStudentLogin(); 
                } else if (!user && !s) {
                    console.log("â„¹ï¸ è¨ªå®¢ç‹€æ…‹ï¼šé¡¯ç¤ºç™»å…¥è¡¨å–®");
                    const form = document.getElementById('studentIdentityForm');
                    if (form) form.style.display = 'block';
                } else if (user && !s) {
                    // Firebase æœ‰ç™»å…¥ä½†æœ¬åœ°æ²’è³‡æ–™ï¼Œå˜—è©¦è‡ªå‹•æ‰¾å›
                    const profile = await findProfileByEmail(user.email);
                    if (profile) {
                        localStorage.setItem('studentProfile', JSON.stringify(profile));
                        checkStudentLogin();
                    }
                }
            });
        });
    }
});
</script>



<script>
// =======================================================
// === [åš´å²ç‰ˆ] ä½œå®¶æ–‡ç²¹ï¼šé›¢é–‹è­¦å ±ç³»çµ± (è«è˜­è¿ªæ¥µç°¡é–å®š) ===
// =======================================================
const LeaveWarningSystem = {
    checkTimer: null,
    lockInterval: null,
    isLocked: false,
    leaveTimestamp: 0, 
    wasHiddenWhileLocked: false, // æ¨™è¨˜æ˜¯å¦åœ¨é–å®šæœŸé–“é€ƒèµ°

    vibratePattern: [400, 200, 400, 200, 400],

    init: function() {
        document.addEventListener('visibilitychange', () => {
            this.handleVisibilityChange();
        });
    },

    handleVisibilityChange: function() {
        if (typeof focusMonitorState === 'undefined' || !focusMonitorState.isActive) {
            this.resetSystem();
            return;
        }
        
        const detailView = document.getElementById('featuredDetailView');
        if (!detailView || detailView.style.display === 'none') {
            this.resetSystem();
            return;
        }

        if (document.hidden) {
            // --- ã€é›¢é–‹é é¢æ™‚ã€‘ ---
            this.leaveTimestamp = Date.now();
            console.log("ğŸ“ [Leave] é›¢é–‹é é¢");

            if (this.isLocked) {
                // å¦‚æœå·²ç¶“åœ¨é–å®šä¸­ï¼Œåªè¦é›¢é–‹ä¸€ç§’éƒ½ç®—é•è¦
                this.wasHiddenWhileLocked = true;
                // é›¢é–‹æ™‚åœæ­¢ç•¶å‰è¨ˆæ™‚å™¨ï¼Œå›ä¾†å†é‡ç®—
                if (this.lockInterval) clearInterval(this.lockInterval);
            } else {
                // å°šæœªé–å®šï¼Œå•Ÿå‹• 5 ç§’å¯¬é™è¨ˆæ™‚
                if (this.checkTimer) clearTimeout(this.checkTimer);
                this.checkTimer = setTimeout(() => {
                    this.triggerAlarmSound(); 
                }, 5000);
            }
        } else {
            // --- ã€å›åˆ°é é¢æ™‚ã€‘ ---
            console.log("ğŸ“ [Back] å›åˆ°é é¢");
            
            // â˜… é—œéµï¼šè§£é– iOS éŸ³è¨Šç®¡é“
            if (typeof SansiAudio !== 'undefined') {
                SansiAudio.unlock();
            }

            if (this.isLocked) {
                // æƒ…æ³ Aï¼šåœ¨é–å®šæœŸé–“é€ƒèµ°å¾Œå›ä¾†
                if (this.wasHiddenWhileLocked) {
                    console.log("ğŸš¨ [Violation] é–å®šä¸­å†æ¬¡é›¢é–‹ï¼Œé‡æ–°é–‹å§‹ 10 ç§’æ‡²ç½°");
                    this.wasHiddenWhileLocked = false;
                    
                    // é‡æ–°ä¾†éï¼šé‡ç½®è²éŸ³èˆ‡è¨ˆæ™‚
                    this.stopSoundOnly();
                    this.triggerAlarmSound();
                    this.enforcePenalty(); 
                } else {
                    // åªæ˜¯æ­£å¸¸çš„é é¢åˆ·æ–°æˆ–èª¤è§¸ï¼Œç¹¼çºŒå€’æ•¸
                    this.enforcePenalty(); 
                }
            } else {
                // æƒ…æ³ Bï¼šå°šæœªé–å®šæ™‚çš„å›ä¾†åˆ¤å®š
                const now = Date.now();
                const timeAway = now - this.leaveTimestamp;
                
                if (this.leaveTimestamp > 0 && timeAway > 5000) {
                    console.log("ğŸš¨ [Violation] é›¢é–‹è¶…é 5 ç§’ï¼Œè§¸ç™¼é–å®š");
                    this.triggerAlarmSound();
                    this.enforcePenalty();
                } else {
                    // 5 ç§’å…§å›ä¾†ï¼Œå–æ¶ˆè­¦å ±
                    this.stopSoundOnly();
                }
            }
            this.leaveTimestamp = 0; 
        }
    },

    triggerAlarmSound: function() {
        console.log("ğŸ”Š æ’­æ”¾è­¦å‘ŠéŸ³èˆ‡éœ‡å‹•");
        if (typeof SansiAudio !== 'undefined') {
            SansiAudio.stop('leave_warning'); // å…ˆå¼·åˆ¶åœæ­¢èˆŠçš„
            SansiAudio.play('leave_warning', true); // å¾ªç’°æ’­æ”¾
        }
        if (navigator.vibrate) {
            navigator.vibrate(this.vibratePattern);
        }
    },

    enforcePenalty: function() {
        const overlay = document.getElementById('penaltyLockOverlay');
        const countSpan = document.getElementById('penaltyCountdown');
        if (!overlay || !countSpan) return;
        
        overlay.style.display = 'flex';
        this.isLocked = true;
        
        // â˜… å¼·åˆ¶é‡ç½®ç‚º 10 ç§’
        let timeLeft = 10;
        countSpan.innerText = timeLeft;
        
        if (this.lockInterval) clearInterval(this.lockInterval);
        
        this.lockInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft < 0) timeLeft = 0; // é˜²æ­¢å‡ºç¾è² æ•¸
            countSpan.innerText = timeLeft;
            
            // é–å®šæœŸé–“æ¯ 2 ç§’è£œä¸€æ¬¡éœ‡å‹•ï¼Œç¢ºä¿å¨æ‡¾åŠ›
            if (timeLeft % 2 === 0 && navigator.vibrate) {
                navigator.vibrate(this.vibratePattern);
            }

            if (timeLeft <= 0) {
                this.releasePenalty();
            }
        }, 1000);
    },

    releasePenalty: function() {
        const overlay = document.getElementById('penaltyLockOverlay');
        if (overlay) overlay.style.display = 'none';
        
        if (this.lockInterval) { clearInterval(this.lockInterval); this.lockInterval = null; }
        
        this.isLocked = false;
        this.wasHiddenWhileLocked = false;
        if (navigator.vibrate) navigator.vibrate(0);
        this.stopSoundOnly();
        
        // é‡ç½®é˜²ç¡ç›£å¯Ÿæ´»å‹•æ™‚é–“
        if (typeof focusMonitorState !== 'undefined') {
            focusMonitorState.lastActivityTime = Date.now();
        }
    },

    stopSoundOnly: function() {
        if (typeof SansiAudio !== 'undefined') {
            SansiAudio.stop('leave_warning');
        }
        if (this.checkTimer) { clearTimeout(this.checkTimer); this.checkTimer = null; }
    },

    resetSystem: function() {
        this.stopSoundOnly();
        this.releasePenalty();
        this.leaveTimestamp = 0;
        this.wasHiddenWhileLocked = false;
    }
};

// å•Ÿå‹•ç›£è½
document.addEventListener('DOMContentLoaded', () => {
    LeaveWarningSystem.init();
});
</script>
 




<!-- === [æ–°å¢] æ™ºèƒ½é˜²éºå¤±ç³»çµ± (V4 å…¨å±€æ•æ‰ç‰ˆ) === -->
<script>
(function() {
    const STORAGE_PREFIX = 'sansi_autosave_';
    const TRACKING_KEY = 'sansi_current_editing_id'; // ç”¨ä¾†è¨˜ä½ç•¶å‰æ­£åœ¨ç·¨è¼¯å“ªå€‹ ID

    // 1. ã€æ ¸å¿ƒä¿®æ­£ã€‘æ””æˆªé»æ“Šäº‹ä»¶ï¼Œè¨˜ä½ã€ŒåŸæœ¬çš„æ ¼å­æ˜¯èª°ã€
    // ä½¿ç”¨ capture: true (æ•ç²éšæ®µ)ï¼Œç¢ºä¿åœ¨åŸæœ¬çš„è¦–çª—æ‰“é–‹å‰å…ˆæŠ“åˆ° ID
    document.body.addEventListener('click', function(e) {
        const t = e.target;
        // åˆ¤æ–·æ˜¯å¦ç‚ºè¼¸å…¥æ¡† (Textarea æˆ– Input Text)
        const isInput = (t.tagName === 'TEXTAREA' || (t.tagName === 'INPUT' && t.type === 'text'));
        // æ’é™¤æ‡¸æµ®è¦–çª—æœ¬èº«ï¼ŒåªæŠ“èƒŒå¾Œçš„æ ¼å­
        const isNotModal = t.id !== 'modal-textarea';
        
        if (isInput && isNotModal && t.id) {
            // ç«‹å³è¨˜ä½é€™å€‹ ID åˆ°ç€è¦½å™¨æš«å­˜ï¼Œèª°ä¹Ÿæ‹¿ä¸èµ°
            sessionStorage.setItem(TRACKING_KEY, t.id);
            // console.log('é–å®šç·¨è¼¯å°è±¡:', t.id);
        }
    }, true); 

    // 2. å„²å­˜é‚è¼¯ï¼šç›£è½æ‰“å­—å‹•ä½œ
    document.body.addEventListener('input', function(e) {
        const target = e.target;
        let idToSave = target.id;
        let valueToSave = target.value;

        // å¦‚æœæ­£åœ¨æ‡¸æµ®è¦–çª—æ‰“å­—
        if (target.id === 'modal-textarea') {
            // å¾æš«å­˜ä¸­å–å‡ºã€ŒåŸæœ¬æ ¼å­ã€çš„ ID
            const originalId = sessionStorage.getItem(TRACKING_KEY);
            if (originalId) {
                idToSave = originalId; // å·å¤©æ›æ—¥ï¼ŒæŠŠå­˜æª”ç›®æ¨™æ”¹æˆåŸæœ¬çš„æ ¼å­
                
                // é †ä¾¿å˜—è©¦æ›´æ–°èƒŒå¾Œçš„ DOM å…ƒç´  (å¦‚æœå®ƒé‚„åœ¨ç•«é¢ä¸Šçš„è©±)
                const originalEl = document.getElementById(originalId);
                if (originalEl) originalEl.value = valueToSave;
            }
        }

        // åŸ·è¡Œå„²å­˜ (0ç§’å»¶é²)
        if (idToSave && idToSave !== 'modal-textarea') {
            sessionStorage.setItem(STORAGE_PREFIX + idToSave, valueToSave);
        }
    });

    // 3. æ¢å¾©é‚è¼¯ (é€šç”¨å‡½å¼)
    function restoreValue(element) {
        if (!element.id || element.id === 'modal-textarea') return;

        const savedValue = sessionStorage.getItem(STORAGE_PREFIX + element.id);
        // åªæœ‰ç•¶æ ¼å­æ˜¯ç©ºçš„ï¼Œä¸”æœ‰å­˜æª”æ™‚æ‰æ¢å¾© (é¿å…è¦†è“‹é è¨­å€¼)
        if (savedValue !== null && element.value === '') {
            element.value = savedValue;
            // è§¸ç™¼è¼¸å…¥äº‹ä»¶ï¼Œè®“å­—æ•¸çµ±è¨ˆç­‰åŠŸèƒ½çŸ¥é“å­—å›ä¾†äº†
            element.dispatchEvent(new Event('input', { bubbles: true }));
        }
    }

    // 4. åˆå§‹åŒ–æ¢å¾©ï¼šé é¢å‰›è¼‰å…¥æ™‚
    // å»¶é² 500ms åŸ·è¡Œï¼Œç­‰å¾…æ‚¨çš„ä¸»ç¨‹å¼å»ºç«‹å¥½ä»‹é¢
    setTimeout(() => {
        document.querySelectorAll('textarea, input[type="text"]').forEach(restoreValue);
    }, 500);

    // 5. å‹•æ…‹å…ƒç´ æ¢å¾©ï¼šç›£æ¸¬ DOM è®Šå‹• (é‡å°ç”Ÿæˆçš„å¤§ç¶±è¡¨æ ¼)
    // ç•¶æ‚¨åˆ‡æ›åˆ°ã€Œå¤§ç¶±ã€æˆ–é»æ“Šã€Œç”Ÿæˆã€æ™‚ï¼Œè¡¨æ ¼æ˜¯æ–°é•·å‡ºä¾†çš„ï¼Œé€™è£¡è² è²¬å¡«å­—
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // å…ƒç´ ç¯€é»
                    if (node.tagName === 'TEXTAREA' || (node.tagName === 'INPUT' && node.type === 'text')) {
                        restoreValue(node);
                    } else {
                        // æª¢æŸ¥å­å…ƒç´  (ä¾‹å¦‚è¡¨æ ¼è¡Œè£¡çš„ textarea)
                        const inputs = node.querySelectorAll('textarea, input[type="text"]');
                        inputs.forEach(restoreValue);
                    }
                }
            });
        });
    });
    observer.observe(document.body, { childList: true, subtree: true });

    // 6. æ¸…é™¤é‚è¼¯ï¼šæŒ‰åƒåœ¾æ¡¶æ™‚åŒæ­¥æ¸…é™¤æš«å­˜
    document.body.addEventListener('click', function(e) {
        const clearBtn = e.target.closest('.btn-clear-icon');
        if (clearBtn) {
            setTimeout(() => {
                Object.keys(sessionStorage).forEach(key => {
                    if (key.startsWith(STORAGE_PREFIX)) {
                        sessionStorage.removeItem(key);
                    }
                });
                console.log('å·²æ¸…é™¤æ‰€æœ‰è‡ªå‹•æš«å­˜');
            }, 100);
        }
    });
})();
</script>

	

	

<!-- Live2D ç•«å¸ƒå®¹å™¨ -->
<canvas id="live2d-canvas"></canvas>


<!-- === æ–°å¢ï¼šè²“å’ªé¸æ“‡è¦–çª— (æ²¿ç”¨é–±è®€è³‡æºæ¨£å¼) === -->
<div id="catSelectionModal" class="report-menu-overlay" onclick="closeCatMenu(event)" style="z-index: 20010;">
    <!-- å¢åŠ  max-width è®“å››å€‹é¸é …åœ¨é›»è…¦ç‰ˆèƒ½ä¸¦æ’ -->
    <div class="report-menu-content" style="max-width: 800px;">
        <div class="report-menu-title" style="color: #5d4037;">é¸æ“‡ä½ çš„è²“æ›¸åƒ®</div>
        
        <!-- ä½¿ç”¨ grid ä½ˆå±€ï¼Œé›»è…¦ç‰ˆ 4 æ¬„ï¼Œæ‰‹æ©Ÿç‰ˆ 2 æ¬„ -->
        <div class="report-options-grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
            
            <!-- é¸é … 1ï¼šéš±è— -->
            <div class="report-option-card" onclick="selectCatMode('none')">
                <i class="fas fa-ban report-option-icon" style="color: #ccc;"></i>
                <span class="report-option-text">éš±è—</span>
            </div>

            <!-- é¸é … 2ï¼šé»‘è²“ -->
            <div class="report-option-card" onclick="selectCatMode('hijiki')">
                <i class="fas fa-cat report-option-icon" style="color: #333;"></i>
                <span class="report-option-text">é»‘è²“ (Hijiki)</span>
            </div>

            <!-- é¸é … 3ï¼šç™½è²“ -->
            <div class="report-option-card" onclick="selectCatMode('tororo')">
                <i class="fas fa-cat report-option-icon" style="color: #f0f0f0; text-shadow: 0 0 2px #999;"></i>
                <span class="report-option-text">ç™½è²“ (Tororo)</span>
            </div>

            <!-- é¸é … 4ï¼šé›™è²“ -->
            <div class="report-option-card" onclick="selectCatMode('both')">
                <div style="display:flex; gap:5px; justify-content:center; margin-bottom:5px;">
                    <i class="fas fa-cat" style="font-size: 1.5rem; color: #333;"></i>
                    <i class="fas fa-cat" style="font-size: 1.5rem; color: #f0f0f0; text-shadow: 0 0 2px #999;"></i>
                </div>
                <span class="report-option-text">å°æœ‹å‹æ‰é¸æ“‡ï¼Œ<br>å¤§äººéƒ½è¦ã€‚</br></span>
            </div>

        </div>
    </div>
</div>



<!-- === [æ–°å¢] é•è¦æ‡²ç½°é–å®šç•«é¢ === -->
<!-- === [æ–°å¢] é•è¦æ‡²ç½°é–å®šç•«é¢ (æ¥µç°¡è«è˜­è¿ªç‰ˆ) === -->
<div id="penaltyLockOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #d69a92; z-index: 2147483647; flex-direction: column; justify-content: center; align-items: center; color: #fff; font-family: 'Noto Serif TC', serif;">
    
    <!-- æ¥µç°¡é–é ­åœ–ç¤º -->
    <i class="fas fa-lock" style="font-size: 2.5rem; margin-bottom: 20px; opacity: 0.8;"></i>
    
    <!-- è¶…å¤§å€’æ•¸æ•¸å­— -->
    <div style="font-size: 8rem; font-weight: 300; line-height: 1; letter-spacing: -5px;">
        <span id="penaltyCountdown">10</span>
    </div>
    
    <!-- ç°¡æ½”ç‹€æ…‹æ–‡å­— -->
    <div style="margin-top: 15px; font-size: 1rem; letter-spacing: 5px; opacity: 0.9;">
        é–å®šä¸­
    </div>
</div>







	<!-- === [æ–°å¢] é˜²ç¡æ¨¡å¼è§£é–è¦–çª— (æ¥µç°¡è«è˜­è¿ªç‰ˆ) === -->
<div id="focusUnlockModal" class="morandi-modal-overlay" style="z-index: 30010;">
    <div class="morandi-modal-card" style="width: 80%; max-width: 280px; padding: 35px 25px;">
        
        <!-- æ¥µç°¡é–é ­åœ–ç¤º -->
        <div style="color: #8fa398; font-size: 2.2rem; margin-bottom: 25px;">
            <i class="fas fa-lock"></i>
        </div>
        
        <!-- è¼¸å…¥æ¡† (åœ“è§’è¨­è¨ˆ) -->
        <input type="password" id="focusUnlockInput" placeholder="è¼¸å…¥å¯†ç¢¼" 
               style="width: 100%; padding: 12px; border: 1px solid #e0ddd7; border-radius: 50px; margin-bottom: 25px; text-align: center; font-size: 1rem; outline: none; background-color: #fcfcfc; color: #555; letter-spacing: 1px; font-family: 'Noto Serif TC', serif;">
        
        <!-- æŒ‰éˆ•ç¾¤çµ„ -->
        <div class="morandi-btn-group" style="gap: 10px;">
            <button onclick="closeFocusUnlockModal()" class="morandi-btn btn-gray" style="padding: 8px 20px; border-radius: 50px; font-size: 0.9rem;">å–æ¶ˆ</button>
            <button onclick="verifyFocusPassword()" class="morandi-btn" style="padding: 8px 20px; background-color: #8fa398; color: white; box-shadow: 0 4px 10px rgba(143, 163, 152, 0.3); border-radius: 50px; font-size: 0.9rem;">ç¢ºèª</button>
        </div>
    </div>
</div>
 
	
	
	


</body>
</html>
