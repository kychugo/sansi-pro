

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>題孳</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
    --primary-gray: #4B5563;
    --secondary-gray: #6B7280;
    --accent-gray: #9CA3AF;
    --primary-blue: #1F2937;
    --secondary-blue: #374151;
    --accent-blue: #4B5563;
    --primary-purple: #6D28D9;
    --secondary-purple: #7C3AED;
    --accent-purple: #8B5CF6;
    --primary-green: #065F46;
    --secondary-green: #047857;
    --accent-green: #34D399;
    --primary-rose: #9F1239;
    --secondary-rose: #BE123C;
    --accent-rose: #F43F5E;
    --primary-amber: #B45309;
    --secondary-amber: #D97706;
    --accent-amber: #F59E0B;
    --primary-indigo: #3730A3;
    --secondary-indigo: #4338CA;
    --accent-indigo: #4F46E5;
    --primary-cyan: #0E7490;
    --secondary-cyan: #0891B2;
    --accent-cyan: #06B6D4;
    --divider-color: #9CA3AF;
}

body {
    font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
    font-size: 18px;
    background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
    background-attachment: fixed;
    overflow-x: hidden;
    padding-bottom: 100px; /* 增加底部邊距 */
}

* {
    box-sizing: border-box;
}


@media (max-width: 767px) {
    .text-center {
        display: flex;
        flex-wrap: nowrap; /* 防止換行 */
        justify-content: center; /* 水平置中 */
        gap: 10px; /* 按鍵間距 */
        padding: 0 10px; /* 左右邊距 */
    }
    .text-center button {
        flex: 1 1 auto; /* 按鍵寬度自適應 */
        min-width: 100px; /* 最小寬度 */
        max-width: 120px; /* 最大寬度，避免過寬 */
        padding: 10px 12px; /* 調整內距 */
        font-size: 14px; /* 縮小字體 */
        margin: 0; /* 移除原始外距 */
    }
}


.question-number {
    background: linear-gradient(135deg, #45b39d , #2471a3);
}


.btn-pdf {
    background: linear-gradient(135deg, #73c6b6   0%, #117a65 100%); /* 綠色漸變 */
    color: white;
    border-radius: 16px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
}



/* 響應式PDF輸出優化 */
@media print {
    html, body {
        width: 794px !important; /* A4寬度，96dpi */
        height: 1123px !important; /* A4高度，96dpi */
        margin: 0 !important;
        padding: 0 !important;
        overflow: visible !important; /* 確保內容不被截斷 */
        background: #ffffff !important; /* 純白背景 */
        color: #000000 !important; /* 純黑文字 */
        -webkit-print-color-adjust: exact !important; /* 強制精確顏色 */
        print-color-adjust: exact !important; /* 標準屬性 */
        font-size: 12pt !important; /* 提高可讀性 */
        line-height: 1.5 !important; /* 調整行距 */
    }

    /* 內容區域適應A4 */
    #questionsDisplay {
        width: 100% !important;
        max-width: 754px !important; /* 保留20px邊距 */
        margin: 0 auto !important;
        padding: 20px !important;
    }

    /* 問題卡片樣式 */
    .question-card {
        width: 754px !important;
        height: auto !important;
        margin: 20px auto !important;
        padding: 20px !important;
        background: #ffffff !important;
        color: #000000 !important;
        page-break-inside: avoid !important; /* 避免跨頁 */
        box-sizing: border-box !important;
        border: 1px solid #000000 !important; /* 深色邊框 */
    }

    /* 強制文字與背景高對比 */
    .question-title, .answer-section, .steps-section, 
    p, span, div, h1, h2, h3, h4, h5, h6 {
        background: #ffffff !important;
        color: #000000 !important;
        opacity: 1 !important; /* 移除透明度 */
    }

    /* 表格清晰度 */
    table, th, td {
        border: 1px solid #000000 !important;
        background: #ffffff !important;
        color: #000000 !important;
    }

    /* 移除不需要的元素 */
    .floating-header, .floating-generate-btn, 
    .copyright-footer, .btn-primary, .btn-secondary, 
    .btn-accent, button {
        display: none !important;
    }

    /* 移除漸變與透明度 */
    [style*="linear-gradient"], [style*="opacity"], [style*="rgba"] {
        background: #ffffff !important;
        opacity: 1 !important;
        color: #000000 !important;
    }

    /* 確保所有文字為黑色 */
    * {
        color: #000000 !important;
    }
}

/* 設備適應性CSS */
@media screen and (max-width: 768px) {
    .question-card {
        font-size: 16px !important;
        padding: 15px !important;
    }
}

@media screen and (min-width: 1200px) {
    .question-card {
        font-size: 18px !important;
        padding: 25px !important;
    }
}




.progress-bar-container {
    position: relative;
    width: 100%;
    height: 100%;
    background-color: #e6e6e6;
    border-radius: 999px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(135deg, #76d7c4 0%, #45b39d 100%);
    transition: width 0.4s ease-in-out;
}



.practical-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

.practical-table th, .practical-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

.practical-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}


.copyright-footer {
    position: fixed;
    bottom: 0;
    right: 0;
    padding: 5px 10px;
    background-color: #f1f1f1;
    z-index: 1000;
}

.copyright-footer p {
    margin: 0;
    font-size: 14px;
}

.divider {
    height: 1px;
    background: linear-gradient(135deg, #a9cce3 0%, #d4e6f1 100%);
    border-radius: 999px;
    margin: 2rem 0;
}

.h-1.bg-gradient-to-r {
    background: linear-gradient(135deg, #a9cce3 0%, #d4e6f1 100%);
}

.glass-card {
    backdrop-filter: blur(20px);
    background: rgba(255, 255, 255, 0.85);
    border: 2px solid rgba(75, 85, 99, 0.2);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border-radius: 24px;
}

.sidebar-card {
	margin-top: 3rem; /* 新增：增加與標題的距離 */
    backdrop-filter: blur(15px);
    background: linear-gradient(135deg, rgba(107, 114, 128, 0.1) 0%, rgba(55, 65, 81, 0.1) 100%);
    border: 2px solid rgba(75, 85, 99, 0.3);
    box-shadow: 0 20px 40px rgba(75, 85, 99, 0.15);
    border-radius: 20px;
}

.question-card {
    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    border-left: 6px solid var(--primary-gray);
    border-radius: 20px;
    transition: all 0.4s ease;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.question-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
}

.btn-primary {
    background: linear-gradient(135deg, #cd6155 0%, #a93226 100%);
    color: white;
    border-radius: 16px;
    padding: 14px 28px;
    font-weight: 700;
    font-size: 20px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    box-shadow: 0 8px 25px rgba(75, 85, 99, 0.3);
}

.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(75, 85, 99, 0.4);
    background: linear-gradient(135deg, var(--secondary-gray) 0%, var(--accent-gray) 100%);
}

.btn-secondary {
    background: linear-gradient(135deg, #2471a3 0%, #a2d9ce  100%);
    color: white;
    border-radius: 16px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-accent {
    background: linear-gradient(135deg, #d98880 0%, #cb4335 100%);
    color: white;
    border-radius: 16px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.type-selector-btn {
    cursor: pointer;
    transition: all 0.4s ease;
    border: 3px solid transparent;
    border-radius: 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    position: relative;
    overflow: hidden;
}

.type-selector-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(75, 85, 99, 0.2), transparent);
    transition: left 0.5s ease;
}

.type-selector-btn:hover::before {
    left: 100%;
}

.type-selector-btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 15px 35px rgba(75, 85, 99, 0.2);
    border-color: var(--accent-gray);
}

.type-selector-btn.selected {
    border: none; /* 移除邊框 */
    background: linear-gradient(135deg, #a9cce3 0%, rgba(213, 245, 227, 0.8) 100%);
    box-shadow: 0 10px 30px rgba(75, 85, 99, 0.25);
}

.quantity-control {
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: 2px solid var(--accent-gray);
    border-radius: 12px;
    overflow: hidden;
    width: auto;
    max-width: 150px;
    margin: 0 auto;
    padding: 0;
    gap: 0;
}

.quantity-btn {
    background: linear-gradient(135deg, #a9cce3 0%, #d4e6f1 100%);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    flex-shrink: 0;
    margin: 0;
    padding: 0;
}

.quantity-input {
    border: none;
    width: 60px;
    text-align: center;
    font-weight: 700;
    font-size: 18px;
    color: var(--primary-gray);
    background: transparent;
    flex-shrink: 0;
    margin: 0;
    padding: 0;
    height: 40px;
    line-height: 40px;
}

/* 平板設備 */
@media (max-width: 1023px) {
    .quantity-control {
        max-width: 120px;
        height: 40px;
    }

    .quantity-btn {
        width: 35px;
        height: 35px;
        font-size: 16px;
    }

    .quantity-input {
        width: 50px;
        font-size: 16px;
        height: 35px;
        line-height: 35px;
    }
}

/* 手機設備 */
@media (max-width: 767px) {
    .quantity-control {
        max-width: 100px;
        height: 35px;
    }

    .quantity-btn {
        width: 30px;
        height: 30px;
        font-size: 14px;
    }

    .quantity-input {
        width: 40px;
        font-size: 14px;
        height: 30px;
        line-height: 30px;
    }
}

.toggle-switch {
    position: relative;
    width: 70px;
    height: 36px;
    background: #e2e8f0;
    border-radius: 18px;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.toggle-switch.active {
    background: linear-gradient(135deg, #a9cce3 0%, #d4e6f1 100%);
}

.toggle-slider {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 30px;
    height: 30px;
    background: white;
    border-radius: 50%;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.toggle-switch.active .toggle-slider {
    transform: translateX(34px);
}

.floating-generate-btn {
    position: fixed;
    bottom: 50px; /* 修訂為50px，從30px上移 */
    right: 30px;
    z-index: 1001; /* 修訂為1001，高於FOOTER的1000 */
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-rose) 0%, var(--secondary-rose) 100%);
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 15px 35px rgba(225, 29, 72, 0.4);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
}

/* 平板設備 */
@media (max-width: 1023px) and (min-width: 768px) {
    .floating-generate-btn {
        bottom: 35px; /* 平板上移至35px */
        width: 70px;
        height: 70px;
        font-size: 24px;
    }
}

/* 手機設備 */
@media (max-width: 767px) {
    .floating-generate-btn {
        bottom: 40px; /* 手機上移至40px */
        right: 20px;
        width: 60px;
        height: 60px;
        font-size: 20px;
    }
}

/* 更小的手機設備 */
@media (max-width: 480px) {
    .floating-generate-btn {
        bottom: 50px; /* 超小屏幕上移至50px */
        right: 15px;
        width: 50px;
        height: 50px;
        font-size: 18px;
    }
}

.progress-ring {
    transform: rotate(-90deg);
}

.progress-ring-circle {
    transition: stroke-dasharray 0.4s ease-in-out;
}

.fade-in {
    opacity: 0;
    animation: fadeIn 0.8s ease-in forwards;
}

@keyframes fadeIn {
    to { opacity: 1; }
}

.slide-up {
    transform: translateY(30px);
    opacity: 0;
    animation: slideUp 1s ease-out forwards;
}

@keyframes slideUp {
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.floating-header {
    position: sticky;
    top: 0;
    z-index: 50;
    backdrop-filter: blur(15px);
    background: linear-gradient(135deg, var(--primary-gray) 0%, var(--primary-blue) 100%);
    border-bottom: 3px solid var(--accent-gray);
    padding: 15px 0; /* 原為 py-10 (40px)，減小到 15px */
    transition: display 0.3s ease; /* 添加平滑過渡 */
}

/* 調整標題文字大小 */
.floating-header h1 {
    font-size: 2.5rem; /* 原為 5xl (約 3.75rem)，減小到 2.5rem */
}

.result-page {
    background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
    min-height: 100vh;
}

.question-number {
    color: #1F2937;
}

.question-title {
    background: linear-gradient(135deg, var(--primary-amber) 0%, var(--secondary-amber) 100%);
    color: #1F2937;
    padding: 12px 20px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 20px;
}

.answer-section {
    background: linear-gradient(135deg, #d0ece7 0%, #73c6b6 100%);
    border: 2px solid #4B5563;
    border-radius: 16px;
    padding: 20px;
    margin-top: 16px;
}

.steps-section {
    background: linear-gradient(135deg, #d4e6f1 0%, #7fb3d5 100%);
    border: 2px solid #4B5563;
    border-radius: 16px;
    padding: 20px;
    margin-top: 16px;
    color: #1F2937;
}

textarea, input[type="text"] {
    min-height: 150px !important;
    font-size: 16px;
    line-height: 1.6;
}

#targetPassage {
    min-height: 300px !important;
}

.reference-qa textarea {
    min-height: 180px !important;
}

.question-type-container {
    max-width: 600px;
    margin: 0 auto;
}

.text-library-selector {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border: 3px solid #e2e8f0;
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.text-library-selector:hover {
    border-color: #a9cce3;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.text-library-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    max-height: 400px;
    overflow-y: auto;
}

.text-item {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.text-item:hover {
    border-color: #a9cce3;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.text-item.selected {
    background: linear-gradient(135deg, #a2d9ce   0%, #2980b9 100%);
    box-shadow: 0 10px 30px rgba(75, 85, 99, 0.25);
}

.text-item-title {
    font-weight: 700;
    font-size: 18px;
    color: #1F2937;
    margin-bottom: 8px;
}

.text-item-info {
    font-size: 14px;
    color: #6B7280;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.text-category {
    background: linear-gradient(135deg, #a9cce3 0%, #d4e6f1 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

/* 响应式设计 - 桌面端 */
.container {
    max-width: 100%;
    margin: 0 auto;
    padding: 0 1.5rem;
}

/* 平板端优化 (768px - 1023px) */
@media (max-width: 1023px) and (min-width: 768px) {
    body {
        font-size: 16px;
    }
    
    .container {
        padding: 0 1rem;
    }
    
    .floating-header h1 {
        font-size: 3rem;
    }
    
    .glass-card, .sidebar-card {
        padding: 1.5rem;
    }
    
    .question-type-container {
        max-width: 100%;
    }
    
    .grid {
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    .xl\:col-span-1, .xl\:col-span-2 {
        grid-column: span 1;
    }
    
    .type-selector-btn {
        padding: 1rem;
    }
    
    .floating-generate-btn {
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        font-size: 20px;
    }
    
    .quantity-control {
        max-width: 140px;
    }
    
    .quantity-btn {
        width: 35px;
        height: 35px;
    }
    
    .quantity-input {
        width: 50px;
        font-size: 16px;
    }
    
    .toggle-switch {
        width: 60px;
        height: 32px;
    }
    
    .toggle-slider {
        width: 26px;
        height: 26px;
    }
    
    .toggle-switch.active .toggle-slider {
        transform: translateX(28px);
    }
    
    .text-library-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
}

/* 手机端优化 (max-width: 767px) */
@media (max-width: 767px) {
    body {
        font-size: 14px;
        padding: 0;
        margin: 0;
    }
    
    * {
        box-sizing: border-box;
    }
    
    .container {
        padding: 0 0.75rem;
        max-width: 100vw;
        overflow-x: hidden;
    }
    
    .floating-header {
        padding: 1rem 0;
    }
    
    .floating-header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .floating-header .container {
        padding: 0 1rem;
    }
    
    /* 主要布局调整 - 单列布局 */
    .grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .xl\:col-span-1, .xl\:col-span-2 {
        grid-column: span 1;
    }
    
    /* 侧边栏卡片调整 - 减少AI擬题系統占比 */
    .sidebar-card {
        padding: 1rem;
        margin-bottom: 1rem;
        position: static;
    }
    
    .sidebar-card h2 {
        font-size: 1.25rem;
       margin-bottom: 1.5rem; /* 原為mb-10，現減少為1.5rem */
    }
    
    /* 主要配置区域调整 */
    .glass-card {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .glass-card h3 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    /* 题型选择器优化 */
    .type-selector-btn {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    
    .type-selector-btn i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .type-selector-btn div {
        font-size: 0.875rem;
    }
    
    /* 题型选择网格 */
    .question-type-container .grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
    
    .md\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    /* 题型选择项优化 */
    .question-type-selection {
        padding: 0.75rem;
        border-radius: 1rem;
        width: 100%;
        max-width: 100%;
    }
    
    .question-type-selection .flex {
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }
    
    .question-type-selection .toggle-switch {
        width: 50px;
        height: 28px;
        margin: 0;
    }
    
    .question-type-selection .toggle-slider {
        width: 22px;
        height: 22px;
        top: 3px;
        left: 3px;
    }
    
    .question-type-selection.active .toggle-slider {
        transform: translateX(22px);
    }
    
    /* 数量控制器优化 - 修正宽度问题 */
    .quantity-control {
        width: auto;
        max-width: 120px;
        margin: 0.5rem auto 0;
        justify-content: center;
    }
    
    .quantity-btn {
        width: 30px;
        height: 30px;
        flex-shrink: 0;
    }
    
    .quantity-input {
        width: 40px;
        font-size: 14px;
        text-align: center;
        flex-shrink: 0;
    }
    
    /* 浮动生成按钮 */
    .floating-generate-btn {
        bottom: 15px;
        right: 15px;
        width: 50px;
        height: 50px;
        font-size: 18px;
    }
    
    /* 文本库网格 */
    .text-library-grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
        max-height: 300px;
    }
    
    .text-item {
        padding: 0.75rem;
    }
    
    .text-item-title {
        font-size: 1rem;
    }
    
    .text-item-info {
        font-size: 0.75rem;
    }
    
    /* 表单元素 */
    textarea, input[type="text"], select {
        font-size: 16px;
        padding: 0.75rem;
        border-radius: 0.75rem;
        width: 100%;
        max-width: 100%;
    }
    
    #targetPassage {
        min-height: 200px !important;
    }
    
    .reference-qa textarea {
        min-height: 120px !important;
    }
    
    /* 按钮调整 */
    .btn-primary, .btn-secondary, .btn-accent {
        padding: 0.75rem 1rem;
        font-size: 1rem;
        width: 100%;
        max-width: 200px;
        margin: 0 auto;
        display: block;
    }
    
    /* 参考题目控制按钮 */
    .reference-qa .flex {
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .reference-qa .w-14 {
        width: 2.5rem;
        height: 2.5rem;
    }
    
    /* 问题卡片 */
    .question-card {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .question-title {
        font-size: 1rem;
        padding: 0.75rem 1rem;
    }
    
    .answer-section, .steps-section {
        padding: 0.75rem;
        margin-top: 0.75rem;
    }
    
    /* 进度模态框 */
    .progress-ring {
        width: 80px;
        height: 80px;
    }
    
    #progressPercent {
        font-size: 1.25rem;
    }
    
    #timeRemaining {
        font-size: 1rem;
    }
    
    /* 结果页面 */
    .result-page .btn-primary, .result-page .btn-secondary {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        margin: 0.25rem;
        width: auto;
        min-width: 120px;
    }
    
    /* 版权信息 */
    .copyright-footer {
        font-size: 10px;
        padding: 3px 6px;
    }
    
    /* 确保没有横向滚动 */
    .overflow-x-hidden {
        overflow-x: hidden;
    }
    
    /* 标签和标题调整 */
    label {
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    
    /* 空间和边距优化 */
    .space-y-4 > * + * {
        margin-top: 0.75rem;
    }
    
    .space-y-6 > * + * {
        margin-top: 1rem;
    }
    
    .space-y-10 > * + * {
        margin-top: 1.5rem;
    }
    
    .mb-10 {
        margin-bottom: 1.5rem;
    }
    
    .mb-8 {
        margin-bottom: 1rem;
    }
    
    .mb-6 {
        margin-bottom: 0.75rem;
    }
    
    .py-12 {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
    }
    
    .p-10 {
        padding: 1rem;
    }
    
    .p-8 {
        padding: 0.75rem;
    }
    
    .p-6 {
        padding: 0.5rem;
    }
    
    /* 自定义题型区域 */
    .col-span-full {
        grid-column: 1 / -1;
    }
    
    /* 长文写作配置 */
    .range-slider {
        width: 100%;
        margin: 0.5rem 0;
    }
    
    /* 实用文配置 */
    select option {
        font-size: 16px;
    }
}

/* 超小屏幕优化 (max-width: 480px) */
@media (max-width: 480px) {
    .container {
        padding: 0 0.5rem;
    }
    
    .floating-header h1 {
        font-size: 1.75rem;
    }
    
    .glass-card, .sidebar-card {
        padding: 0.75rem;
        border-radius: 1rem;
    }
    
    .question-type-selection {
        padding: 0.5rem;
    }
    
    .quantity-control {
        max-width: 100px;
    }
    
    .quantity-btn {
        width: 25px;
        height: 25px;
    }
    
    .quantity-input {
        width: 35px;
        font-size: 12px;
    }
    
    .floating-generate-btn {
        width: 45px;
        height: 45px;
        font-size: 16px;
        bottom: 10px;
        right: 10px;
    }
}

/* 横屏模式优化 */
@media (max-height: 500px) and (orientation: landscape) {
    .floating-header {
        position: relative;
    }
    
    .floating-header h1 {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
    }
    
    .py-12 {
        padding-top: 1rem;
        padding-bottom: 1rem;
    }
    
    .sidebar-card {
        position: static;
        margin-bottom: 1rem;
    }
}

/* 确保内容区域不会超出视口 */
@media (max-width: 767px) {
    .min-h-screen {
        min-height: 100vh;
        width: 100vw;
        max-width: 100vw;
        overflow-x: hidden;
    }
    
    body, html {
        overflow-x: hidden;
        max-width: 100vw;
    }
    
    * {
        max-width: 100%;
        word-wrap: break-word;
    }
}


/* 修改後的代碼 (修正 Class 名稱) */
.keyword-input-section input[type="text"] {
    height: 40px !important;      /* 稍微增加一點高度讓文字垂直置中更好看 */
    min-height: 40px !important;  /* 強制覆蓋全域的 150px 設定 */
    padding: 4px 8px !important;
    font-size: 14px !important;
    line-height: 1.2 !important;
}

.keyword-inputs input[type="number"] {
    height: 32px !important;
    min-height: 32px !important;
    padding: 4px 8px !important;
    font-size: 14px !important;
    line-height: 1.2 !important;
}

.custom-text-item {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 2px solid #cbd5e0;
    border-radius: 12px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.custom-text-item:hover {
    border-color: #a0aec0;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.custom-text-item.selected {

    background: linear-gradient(135deg, #f4d03f 0%, #cb4335 100%);
}

#essayConfig, #practicalConfig {
    width: 95%; /* 或指定像素值，如 1200px */
	margin: 0 auto;
}

	    @media (min-width: 1280px) {
    #essayConfig, #practicalConfig {
        width: 95%;
    }
}
@media (max-width: 1279px) {
    #essayConfig, #practicalConfig {
        width: 95%;
    }
}
	
button.bg-gradient-to-r.from-green-500.to-teal-500 {
    background: linear-gradient(135deg, #7dcea0, #148f77 ); /* 綠色到青色 */
}

button.bg-gradient-to-r.from-red-500.to-pink-500 {
    background: linear-gradient(135deg, #f1948a, #b03a2e); /* 紅色到粉紅 */
}

	    .text-center button {
    background: none;
    border: none;
    padding: 10px; /* 縮減內距，顯得緊湊 */
    cursor: pointer;
}

.text-center button i {
    font-size: 24px;
    color: #1890ff; /* 保留現有藍色 */
}

.text-center button:hover i {
    color: #40a9ff; /* 懸停時變亮 */
}

	    @media (max-width: 767px) {
    body {
        padding-bottom: 50px;
    }
}


/* --- 通用輸入框懸浮視窗 (CSS) --- */

/* 1. 讓所有符合條件的輸入框看起來可以點擊 */
textarea:not(.no-modal-editor),
input[type="text"]:not(.no-modal-editor) {
    cursor: pointer; /* 滑鼠變成手形指標 */
    background-color: #f0f8ff; /* 淡藍色背景提示 */
    transition: background-color 0.2s;
}

/* 2. 當滑鼠懸停時，背景色稍深一點 */
textarea:not(.no-modal-editor):hover,
input[type="text"]:not(.no-modal-editor):hover {
    background-color: #e6f2ff;
}

/* 3. 懸浮視窗本身的樣式 */
.outline-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.65);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    padding: 1rem;
    box-sizing: border-box;
}

.outline-modal-content {
    background-color: #fdfdfd;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 700px;
    position: relative;
    animation: fadeIn 0.3s;
    display: flex;
    flex-direction: column;
    max-height: 90vh; /* 【核心修訂】限制視窗最大高度為螢幕可視高度的90% */
}

/* 動畫效果 */
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

.outline-modal-content h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #333;
    font-size: 1.2em;
    font-weight: 700;
}

#modal-textarea {
    width: 100%;
    box-sizing: border-box;
    font-size: 1.3em;
    line-height: 1.6;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px;
    flex-grow: 1;
    min-height: 150px; /* 【優化修訂】減少最小高度，使其在小螢幕上更靈活 */
    resize: vertical; /* 確保用戶仍然可以手動調整 */
}

.outline-modal-content .modal-buttons {
    text-align: right;
    margin-top: 15px;
}

/* 關閉按鈕的樣式 (直接引用自您的CSS庫) */
.preview-close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.7);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s, color 0.3s;
    z-index: 2010;
}
.preview-close-btn:hover {
    color: #fff;
    background-color: #d32f2f;
}

/* 按鈕樣式 (直接引用自您的CSS庫) */
.btn-action {
    display: inline-block;
    padding: 10px 20px;
    margin: 5px; 
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    color: white;
    background-color: rgba(31, 122, 85, 0.8);
    backdrop-filter: blur(5px);
    text-align: center;
    text-decoration: none;
}
.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    filter: brightness(110%);
}
		
    </style>

  <link rel="manifest" href="../psadc-manifest.json">
</head>
<body class="min-h-screen">
    <!-- 主要配置區域 --><div id="mainContainer">

        <!-- Header -->
        <header class="floating-header text-white py-10 shadow-2xl">
            <div class="container mx-auto px-6">
                <div class="text-center">
                    <h1 class="text-5xl md:text-6xl font-bold mb-4">
                        <i class="fas fa-graduation-cap mr-4"></i>題孳
                    </h1>
                </div>
            </div>
        </header>

        <!-- 主體內容區域 -->
       <div class="container mx-auto px-6 py-12">
            <div class="flex flex-col xl:flex-row gap-10">
                <!-- 左側配置面板 -->
                <div class="xl:w-1/4">
                    <div class="sidebar-card p-10 mb-10 fade-in sticky top-32">
                        <h2 class="text-3xl font-bold mb-10 text-gray-800 flex items-center">
                            <i class="fas fa-sliders-h mr-4 text-teal-700"></i>配置選項
                        </h2>
                        <!-- 擬題範疇選擇 -->
                        <div class="mb-10">
                            <label class="block text-xl font-semibold text-gray-700 mb-6">
                                <i class="fas fa-list-alt mr-3"></i>選擇擬題範疇
                            </label>
                            <div class="space-y-4">
                                <div class="relative">
                                    <input type="radio" id="reading" name="generatorType" value="reading" class="sr-only" checked>
                                    <label for="reading" class="type-selector-btn block p-6 cursor-pointer text-center">
                                        <i class="fas fa-book-open text-4xl text-teal-600 mb-4 block"></i>
                                        <div class="font-bold text-xl text-gray-700">閱讀理解</div>
                                        <div class="text-base text-gray-500 mt-2">多元題型設計</div>
                                    </label>
                                </div>
                                <div class="relative">
                                    <input type="radio" id="essay" name="generatorType" value="essay" class="sr-only">
                                    <label for="essay" class="type-selector-btn block p-6 cursor-pointer text-center">
                                        <i class="fas fa-pen-fancy text-4xl text-blue-600 mb-4 block"></i>
                                        <div class="font-bold text-xl text-gray-700">長文寫作</div>
                                        <div class="text-base text-gray-500 mt-2">創意思維培養</div>
                                    </label>
                                </div>
                                <div class="relative">
                                    <input type="radio" id="practical" name="generatorType" value="practical" class="sr-only">
                                    <label for="practical" class="type-selector-btn block p-6 cursor-pointer text-center">
                                        <i class="fas fa-file-alt text-4xl text-green-600 mb-4 block"></i>
                                        <div class="font-bold text-xl text-gray-700">實用寫作</div>
                                        <div class="text-base text-gray-500 mt-2">語文應用訓練</div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側主要配置區域 -->
                <div class="xl:w-3/4 flex flex-col xl:flex-row gap-10">
                    <div id="configContainer" class="space-y-10 flex-1">
                        <!-- 閱讀配置 -->
                        <div id="readingConfig" class="config-panel">
                            <div class="glass-card p-10 slide-up">
                                <h3 class="text-3xl font-bold mb-8 text-gray-800 flex items-center">
                                    <i class="fas fa-book mr-4 text-teal-600"></i>閱讀理解配置
                                </h3>
                                <!-- 擬題篇章選擇 -->
                                <div class="h-1 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full my-8"></div>
                                <div>
                                    <label class="block text-xl font-semibold text-gray-700 mb-6">
                                        <i class="fas fa-scroll mr-3"></i>擬題篇章選擇
                                    </label>
                                    <div class="text-library-selector mb-6">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="text-lg font-bold text-gray-800 flex items-center">
                                                <i class="fas fa-book-open mr-3 text-blue-600"></i>範文庫選擇
                                            </h4>
                                        </div>
                                        <div id="textLibraryGrid" class="text-library-grid">
                                            <!-- 範文庫內容將通過 JavaScript 生成 -->
                                        </div>
                                    </div>
					 <div class="h-1 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full my-8"></div>
                                    <div>
                                        <label for="targetPassage" class="block text-lg font-semibold text-gray-700 mb-4">
                                            <i class="fas fa-edit mr-3"></i>篇章內容
                                        </label>
                                        <textarea id="targetPassage" class="w-full p-8 border-3 border-teal-200 rounded-2xl focus:border-teal-400 focus:ring-0 transition-colors duration-300 resize-vertical bg-white" placeholder="在此輸入擬題篇章內容，或從上方範文庫選擇"></textarea>
                                    </div>
                                </div>
				     <div class="h-1 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full my-8"></div>
                                <!-- 題型選擇和數量設定 -->
                                <div class="mb-10" id="dynamicQuestionTypes">
                                    <label class="block text-xl font-semibold text-gray-700 mb-6">
                                        <i class="fas fa-tasks mr-3"></i>題型選擇及數量設定
                                    </label>
                                    <div id="questionTypeContainer">
                                        <div class="bg-gray-100 p-6 rounded-xl text-center text-gray-500">
                                            <i class="fas fa-info-circle text-3xl mb-3"></i>
                                            <p>請先選擇擬題篇章</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                           
                        </div>

                        <!-- 長文配置 -->
                        <div id="essayConfig" class="config-panel hidden">
                            <div class="glass-card p-4 slide-up">
                                <h3 class="text-3xl font-bold mb-8 text-gray-800 flex items-center">
                                    <i class="fas fa-pen-fancy mr-4 text-blue-600"></i>長文寫作配置
                                </h3>
                                <div class="mb-10">
                                    <label class="block text-xl font-semibold text-gray-700 mb-6">
                                        <i class="fas fa-tasks mr-3"></i>題目記錄管理
                                    </label>
                                </div>
                                <div class="flex space-x-4 items-center">
                                    <button onclick="showQuestionHistory()" class="btn-secondary px-6 py-3 text-base">
                                        <i class="fas fa-eye mr-2"></i> 紀錄
                                    </button>
                                    <button onclick="clearGeneratedQuestions()" class="btn-accent px-6 py-3 text-lg">
                                        <i class="fas fa-trash mr-3"></i> 清除
                                    </button>
                                </div>
                                <div class="h-1 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full my-8"></div>
                                <div class="question-type-container">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- 敘事題型 -->
                                        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-blue-300 transition-all duration-300" data-type="敘事">
                                            <div class="flex items-center justify-between mb-4">
                                                <div class="flex items-center">
                                                    <div class="toggle-switch mr-4" onclick="toggleWritingQuestionType(this, '敘事')">
                                                        <div class="toggle-slider"></div>
                                                    </div>
                                                    <div>
                                                        <i class="fas fa-book-open text-orange-500 text-2xl mr-3"></i>
                                                        <span class="font-bold text-lg">敘事</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="quantity-control mt-4" style="display: none;">
                                                <button type="button" class="quantity-btn" onclick="adjustQuantity('敘事', -1)">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" id="quantity-敘事" min="1" max="10" value="1" class="quantity-input" readonly>
                                                <button type="button" class="quantity-btn" onclick="adjustQuantity('敘事', 1)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- 開放題型 -->
                                        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-blue-300 transition-all duration-300" data-type="開放">
                                            <div class="flex items-center justify-between mb-4">
                                                <div class="flex items-center">
                                                    <div class="toggle-switch mr-4" onclick="toggleWritingQuestionType(this, '開放')">
                                                        <div class="toggle-slider"></div>
                                                    </div>
                                                    <div>
                                                        <i class="fas fa-unlock text-green-500 text-2xl mr-3"></i>
                                                        <span class="font-bold text-lg">開放</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="quantity-control mt-4" style="display: none;">
                                                <button type="button" class="quantity-btn" onclick="adjustQuantity('開放', -1)">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" id="quantity-開放" min="1" max="10" value="1" class="quantity-input" readonly>
                                                <button type="button" class="quantity-btn" onclick="adjustQuantity('開放', 1)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- 議論題型 -->
                                        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-blue-300 transition-all duration-300" data-type="議論">
                                            <div class="flex items-center justify-between mb-4">
                                                <div class="flex items-center">
                                                    <div class="toggle-switch mr-4" onclick="toggleWritingQuestionType(this, '議論')">
                                                        <div class="toggle-slider"></div>
                                                    </div>
                                                    <div>
                                                        <i class="fas fa-balance-scale text-purple-500 text-2xl mr-3"></i>
                                                        <span class="font-bold text-lg">議論</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="quantity-control mt-4" style="display: none;">
                                                <button type="button" class="quantity-btn" onclick="adjustQuantity('議論', -1)">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" id="quantity-議論" min="1" max="10" value="1" class="quantity-input" readonly>
                                                <button type="button" class="quantity-btn" onclick="adjustQuantity('議論', 1)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- 自訂題型 -->
                                        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-blue-300 transition-all duration-300 col-span-full" data-type="自訂">
                                            <div class="flex items-center justify-center">
                                                <div class="toggle-switch mr-4" onclick="toggleWritingQuestionType(this, '自訂')">
                                                    <div class="toggle-slider"></div>
                                                </div>
                                                <div>
                                                    <i class="fas fa-edit text-gray-500 text-2xl mr-3"></i>
                                                    <span class="font-bold text-lg">自訂</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 自訂配置區域 -->
                            <div id="customEssayConfig" class="hidden">
                                <div class="h-1 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full my-8"></div>
                                <label class="block text-xl font-semibold text-gray-700 mb-4">
                                    <i class="fas fa-clipboard-list mr-3"></i>請選擇自訂類型：
                                </label>
                                <div class="custom-essay-container mt-6 mb-8 p-6 bg-white border rounded-lg">
                                    <div class="flex space-x-4">
                                        <div class="p-4 border rounded-lg flex-1">
                                            <label class="flex items-center">
                                                <input type="radio" name="customEssayType" value="narrative" class="mr-2">
                                                <i class="fas fa-book-open mr-2"></i>敘事
                                            </label>
                                            <p class="text-sm text-gray-600 mt-2">敘事文著重於講述故事或事件。</p>
                                        </div>
                                        <div class="p-4 border rounded-lg flex-1">
                                            <label class="flex items-center">
                                                <input type="radio" name="customEssayType" value="argumentative" class="mr-2">
                                                <i class="fas fa-gavel mr-2"></i>議論
                                            </label>
                                            <p class="text-sm text-gray-600 mt-2">議論文著重於表達觀點並提供論據支持。</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="h-1 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full my-8"></div>
                                <div>
                                    <label class="block text-xl font-semibold text-gray-700 mb-6">
                                        <i class="fas fa-clipboard-list mr-3"></i>參考題目設定
                                    </label>
                                    <div id="essayReferenceList" class="space-y-6">
                                        <div class="essay-reference">
                                            <div class="flex items-start space-x-4 bg-white p-8 rounded-2xl border-3 border-blue-200">
                                                <span class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-full flex items-center justify-center font-bold text-lg question-number">1</span>
                                                <textarea class="flex-1 p-6 border-2 border-blue-200 rounded-xl focus:border-blue-400 focus:ring-0 transition-colors duration-300 resize-vertical" placeholder="在此輸入參考題目"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex justify-center space-x-6 mt-8">
                                        <button onclick="addEssayReference()" class="w-14 h-14 bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white rounded-full flex items-center justify-center transition-all duration-300 text-xl">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <button onclick="removeEssayReference()" class="w-14 h-14 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-full flex items-center justify-center transition-all duration-300 text-xl">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <button onclick="clearEssayReference()" class="w-14 h-14 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white rounded-full flex items-center justify-center transition-all duration-300 text-xl">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 實用文配置 -->
                        <div id="practicalConfig" class="config-panel hidden">
                            <div class="glass-card p-4 slide-up">
                                <h3 class="text-3xl font-bold mb-8 text-gray-800 flex items-center">
                                    <i class="fas fa-file-alt mr-4 text-green-600"></i>實用寫作配置
                                </h3>
                                <div class="space-y-10">
                                    <div>
                                        <label for="topicSelect" class="block text-xl font-semibold text-gray-700 mb-6">
                                            <i class="fas fa-tag mr-3"></i>主題選擇
                                        </label>
                                        <select id="topicSelect" class="w-full p-6 border-3 border-green-200 rounded-2xl focus:border-green-400 focus:ring-0 transition-colors duration-300 bg-white text-lg">
                                            <option value="random">隨機主題</option>
                                            <option value="custom">自訂主題</option>
                                            <option value="運動">運動</option>
                                            <option value="生涯規劃">生涯規劃</option>
                                            <option value="責任">責任</option>
                                            <option value="教育">教育</option>
                                            <option value="文化">文化</option>
                                            <option value="社會">社會</option>
                                            <option value="歷史">歷史</option>
                                            <option value="地理">地理</option>
                                            <option value="藝術">藝術</option>
                                            <option value="體育">體育</option>
                                            <option value="法律">法律</option>
                                            <option value="健康">健康</option>
                                            <option value="心理">心理</option>
                                            <option value="家庭">家庭</option>
                                            <option value="友誼">友誼</option>
                                            <option value="愛情">愛情</option>
                                            <option value="就業">就業</option>
                                            <option value="經濟">經濟</option>
                                            <option value="生態">生態</option>
                                            <option value="能源">能源</option>
                                            <option value="資源">資源</option>
                                            <option value="安全">安全</option>
                                            <option value="網路">網路</option>
                                            <option value="媒體">媒體</option>
                                            <option value="資訊">資訊</option>
                                            <option value="道德">道德</option>
                                            <option value="誠信">誠信</option>
                                            <option value="公平">公平</option>
                                            <option value="自由">自由</option>
                                            <option value="權利">權利</option>
                                            <option value="義務">義務</option>
                                            <option value="隱私">隱私</option>
                                            <option value="禮儀">禮儀</option>
                                            <option value="榜樣">榜樣</option>
                                            <option value="創新">創新</option>
                                            <option value="創業">創業</option>
                                            <option value="消費">消費</option>
                                            <option value="儲蓄">儲蓄</option>
                                            <option value="民族">民族</option>
                                            <option value="語言">語言</option>
                                            <option value="宗教">宗教</option>
                                            <option value="傳統">傳統</option>
                                            <option value="現代">現代</option>
                                            <option value="城鄉">城鄉</option>
                                            <option value="社區">社區</option>
                                            <option value="公益">公益</option>
                                            <option value="慈善">慈善</option>
                                            <option value="災害">災害</option>
                                            <option value="醫療">醫療</option>
                                            <option value="疾病">疾病</option>
                                            <option value="飲食">飲食</option>
                                            <option value="旅遊">旅遊</option>
                                            <option value="建築">建築</option>
                                            <option value="娛樂">娛樂</option>
                                            <option value="音樂">音樂</option>
                                            <option value="電影">電影</option>
                                            <option value="文學">文學</option>
                                            <option value="人口">人口</option>
                                            <option value="性別">性別</option>
                                            <option value="年齡">年齡</option>
                                            <option value="職業">職業</option>
                                            <option value="學業">學業</option>
                                            <option value="考試">考試</option>
                                            <option value="升學">升學</option>
                                            <option value="校園">校園</option>
                                            <option value="師生">師生</option>
                                            <option value="同學">同學</option>
                                            <option value="課外">課外</option>
                                            <option value="社團">社團</option>
                                            <option value="競賽">競賽</option>
                                            <option value="志願">志願</option>
                                            <option value="壓力">壓力</option>
                                            <option value="自律">自律</option>
                                            <option value="時間">時間</option>
                                            <option value="興趣">興趣</option>
                                            <option value="習慣">習慣</option>
                                            <option value="遊戲">遊戲</option>
                                            <option value="睡眠">睡眠</option>
                                            <option value="氣候">氣候</option>
                                            <option value="汙染">汙染</option>
                                            <option value="閱讀">閱讀</option>
                                        </select>
                                    </div>
                                    

<div id="customTopicGroup" class="hidden">
<label for="customTopic" class="block text-xl font-semibold text-gray-700 mb-6">
<i class="fas fa-edit mr-3"></i>自訂主題內容
</label>
<input type="text" id="customTopic" class="w-full p-6 border-3 border-green-200 rounded-2xl focus:border-green-400 focus:ring-0 transition-colors duration-300 bg-white text-lg" placeholder="請輸入自訂主題">
</div>



<!-- 在主題選擇代碼後添加 -->
<div class="mb-10">
    <label clas"block text-xl font-semibold text-gray-700 mb-6">
        <i class="fas fa-file-alt mr-3"></i>體裁選擇
    </label>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- 書信 -->
        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-green-300 transition-all duration-300" data-type="書信">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="toggle-switch mr-4" onclick="togglePracticalType(this, '書信')">
                        <div class="toggle-slider"></div>
                    </div>
                    <div>
                        <i class="fas fa-envelope text-blue-500 text-2xl mr-3"></i>
                        <span class="font-bold text-lg">書信</span>
                    </div>
                </div>
            </div>
            <div class="quantity-control mt-4" style="display: none;">
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('書信', -1)">
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" id="quantity-書信" min="1" max="10" value="1" class="quantity-input" readonly>
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('書信', 1)">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <!-- 演講辭 -->
        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-green-300 transition-all duration-300" data-type="演講辭">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="toggle-switch mr-4" onclick="togglePracticalType(this, '演講辭')">
                        <div class="toggle-slider"></div>
                    </div>
                    <div>
                        <i class="fas fa-microphone text-red-500 text-2xl mr-3"></i>
                        <span class="font-bold text-lg">演講辭</span>
                    </div>
                </div>
            </div>
            <div class="quantity-control mt-4" style="display: none;">
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('演講辭', -1)">
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" id="quantity-演講辭" min="1" max="10" value="1" class="quantity-input" readonly>
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('演講辭', 1)">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <!-- 報告 -->
        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-green-300 transition-all duration-300" data-type="報告">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="toggle-switch mr-4" onclick="togglePracticalType(this, '報告')">
                        <div class="toggle-slider"></div>
                    </div>
                    <div>
                        <i class="fas fa-file-alt text-purple-500 text-2xl mr-3"></i>
                        <span class="font-bold text-lg">報告</span>
                    </div>
                </div>
            </div>
            <div class="quantity-control mt-4" style="display: none;">
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('報告', -1)">
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" id="quantity-報告" min="1" max="10" value="1" class="quantity-input" readonly>
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('報告', 1)">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <!-- 建議書 -->
        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-green-300 transition-all duration-300" data-type="建議書">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="toggle-switch mr-4" onclick="togglePracticalType(this, '建議書')">
                        <div class="toggle-slider"></div>
                    </div>
                    <div>
                        <i class="fas fa-lightbulb text-yellow-500 text-2xl mr-3"></i>
                        <span class="font-bold text-lg">建議書</span>
                    </div>
                </div>
            </div>
            <div class="quantity-control mt-4" style="display: none;">
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('建議書', -1)">
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" id="quantity-建議書" min="1" max="10" value="1" class="quantity-input" readonly>
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('建議書', 1)">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <!-- 評論 -->
        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-green-300 transition-all duration-300" data-type="評論">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="toggle-switch mr-4" onclick="togglePracticalType(this, '評論')">
                        <div class="toggle-slider"></div>
                    </div>
                    <div>
                        <i class="fas fa-comment-dots text-orange-500 text-2xl mr-3"></i>
                        <span class="font-bold text-lg">評論</span>
                    </div>
                </div>
            </div>
            <div class="quantity-control mt-4" style="display: none;">
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('評論', -1)">
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" id="quantity-評論" min="1" max="10" value="1" class="quantity-input" readonly>
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('評論', 1)">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <!-- 專題文章 -->
        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-green-300 transition-all duration-300" data-type="專題文章">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="toggle-switch mr-4" onclick="togglePracticalType(this, '專題文章')">
                        <div class="toggle-slider"></div>
                    </div>
                    <div>
                        <i class="fas fa-newspaper text-green-500 text-2xl mr-3"></i>
                        <span class="font-bold text-lg">專題文章</span>
                    </div>
                </div>
            </div>
            <div class="quantity-control mt-4" style="display: none;">
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('專題文章', -1)">
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" id="quantity-專題文章" min="1" max="10" value="1" class="quantity-input" readonly>
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('專題文章', 1)">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <!-- 自訂 -->
        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-green-300 transition-all duration-300" data-type="自訂">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="toggle-switch mr-4" onclick="togglePracticalType(this, '自訂')">
                        <div class="toggle-slider"></div>
                    </div>
                    <div>
                        <i class="fas fa-edit text-gray-500 text-2xl mr-3"></i>
                        <span class="font-bold text-lg">自訂</span>
                    </div>
                </div>
            </div>
            <div class="quantity-control mt-4" style="display: none;">
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('自訂', -1)">
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" id="quantity-自訂" min="1" max="10" value="1" class="quantity-input" readonly>
                <button type="button" class="quantity-btn" onclick="adjustPracticalQuantity('自訂', 1)">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="customPracticalConfig" class="hidden">
    <div class="divider"></div>
    <div>
        <label class="block text-xl font-semibold text-gray-700 mb-6">
            <i class="fas fa-clipboard-list mr-3"></i>自訂參考內容
        </label>
        <div class="space-y-6">
            <div>
                <label for="customRefQuestion" class="block text-lg font-medium text-gray-700 mb-2">參考題目</label>
                <textarea id="customRefQuestion" class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-0" rows="4" placeholder="輸入自訂的參考題目"></textarea>
            </div>
            <div>
                <label for="customRefMaterial1" class="block text-lg font-medium text-gray-700 mb-2">參考資料一</label>
                <textarea id="customRefMaterial1" class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-0" rows="4" placeholder="輸入自訂的參考資料一"></textarea>
            </div>
            <div>
                <label for="customRefMaterial2" class="block text-lg font-medium text-gray-700 mb-2">參考資料二</label>
                <textarea id="customRefMaterial2" class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-0" rows="4" placeholder="輸入自訂的參考資料二"></textarea>
            </div>
        </div>
    </div>
</div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 浮動生成按鈕 -->
    <button id="generateBtn" class="floating-generate-btn" title="開始智能生成">
        <i class="fas fa-rocket"></i>
    </button>

    <!-- 進度顯示區域 -->
    <div id="progressModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
    <div class="glass-card p-12 max-w-2xl w-full mx-6 text-center fade-in">
        <div class="mb-10">
            <div class="relative w-32 h-8 mx-auto mb-8">
                <div class="progress-bar-container w-full h-full bg-gray-200 rounded-full overflow-hidden">
                    <div id="progressBar" class="progress-bar h-full bg-gradient-to-r from-teal-400 to-blue-500" style="width: 0%;"></div>
                </div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <span id="progressPercent" class="text-2xl font-bold" style="color: var(--primary-teal);">0%</span>
                </div>
            </div>
            <h3 class="text-3xl font-bold text-gray-800 mb-4">AI擬題中......</h3>
        </div>
        <div class="text-center">
            <div id="timeRemaining" class="text-3xl font-bold" style="color: var(--primary-blue);">--</div>
            <div class="text-gray-500 mt-2 font-semibold">剩餘時間</div>
        </div>
    </div>
</div>

    <!-- 結果顯示頁面 -->
    <div id="resultContainer" class="hidden result-page">
    <div class="min-h-screen py-12">
        <div class="container mx-auto px-6">
            <!-- 操作按鈕 -->
          <div class="text-center mb-12 slide-up">
    <button onclick="goBack()" title="返回" class="btn-secondary px-12 py-5 rounded-2xl font-bold mr-8 text-xl transform hover:-translate-y-2 transition-all duration-300">
        <i class="fas fa-arrow-left"></i>
    </button>
    <button onclick="regenerate()" title="重新生成" class="btn-primary px-12 py-5 rounded-2xl font-bold text-xl transform hover:-translate-y-2 transition-all duration-300">
        <i class="fas fa-redo"></i>
    </button>
    <button onclick="exportToPDF()" title="輸出PDF" class="btn-pdf px-12 py-5 rounded-2xl font-bold text-xl transform hover:-translate-y-2 transition-all duration-300 ml-8">
        <i class="fas fa-file-pdf"></i>
    </button>
</div>
            <!-- 題目內容 -->
            <div id="questionsDisplay" class="space-y-10 max-w-6xl mx-auto">
                <!-- 題目會在這裡動態生成 -->
            </div>
        </div>
    </div>
</div>



	

    <script>


window.addEventListener('scroll', function() {
    const header = document.querySelector('.floating-header');
    if (window.scrollY > 0) {
        header.style.display = 'none'; /* 滾動時隱藏 */
    } else {
        header.style.display = 'block'; /* 最上方時顯示 */
    }
});


var selectedPracticalTypes = new Set();


async function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const A4_WIDTH = 794; // A4寬度（像素，96dpi）
    const A4_HEIGHT = 1123; // A4高度（像素，96dpi）
    
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'px',
        format: [A4_WIDTH, A4_HEIGHT],
        compress: true // 禁用壓縮以提升質量
    });

    const questionsContainer = document.getElementById('questionsDisplay');
    const questionCards = questionsContainer.querySelectorAll('.question-card');
    
    if (questionCards.length === 0) {
        alert('沒有可輸出的題目內容');
        return;
    }

    // 進度提示
    const progressDiv = document.createElement('div');
    progressDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000; font-size: 18px; text-align: center; min-width: 300px;
    `;
    progressDiv.innerHTML = `
        <div>正在生成PDF...</div>
        <div id="pdfProgress" style="margin-top: 10px; font-size: 14px; color: #666;">準備中...</div>
    `;
    document.body.appendChild(progressDiv);

    try {
        for (let i = 0; i < questionCards.length; i++) {
            const card = questionCards[i];
            document.getElementById('pdfProgress').textContent = 
                `正在處理第 ${i + 1} 題，共 ${questionCards.length} 題...`;

            // 保存原始樣式並強化文字
            const originalStyles = enhanceTextForPDF(card);
            
            // 設置A4適應樣式
            const originalStyle = card.getAttribute('style') || '';
            card.style.cssText = `
                position: relative !important;
                width: 754px !important;
                height: auto !important;
                margin: 0 auto !important;
                padding: 20px !important;
                background: #ffffff !important;
                color: #000000 !important;
                page-break-inside: avoid !important;
                border: 1px solid #000000 !important;
            `;

            // 等待樣式應用
            await new Promise(resolve => setTimeout(resolve, 100));

            const canvas = await html2canvas(card, {
                scale: 3, // 提升解析度
                useCORS: true,
                backgroundColor: '#ffffff',
                width: 754,
                height: card.scrollHeight,
                windowWidth: 794,
                windowHeight: A4_HEIGHT,
                onclone: function(clonedDoc) {
                    const clonedCard = clonedDoc.querySelector(`[data-card-index="${i}"]`) || 
                                     clonedDoc.querySelectorAll('.question-card')[0];
                    if (clonedCard) {
                        enhanceClonedElementForPDF(clonedCard);
                    }
                }
            });

            // 還原樣式
            card.setAttribute('style', originalStyle);
            restoreOriginalStyles(card, originalStyles);

            const imgWidth = A4_WIDTH - 40; // 留邊距
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            if (i > 0) doc.addPage();
            const imgData = canvas.toDataURL('image/png', 1.0); // 最高質量PNG
            doc.addImage(imgData, 'PNG', 20, 20, imgWidth, Math.min(imgHeight, A4_HEIGHT - 40));
            card.setAttribute('data-card-index', i);
        }

        document.body.removeChild(progressDiv);
        doc.save('generated_questions.pdf');
    } catch (error) {
        console.error('PDF生成失敗：', error);
        document.body.removeChild(progressDiv);
        alert('PDF生成失敗，請稍後重試');
    }
}// 修訂：新增函數來強化PDF轉換前的文字樣式
function enhanceTextForPDF(element) {
    const originalStyles = new Map();
    
    // 強化所有文字元素的顏色和對比度
    const textElements = element.querySelectorAll('*');
    textElements.forEach((el, index) => {
        const computedStyle = window.getComputedStyle(el);
        const originalColor = computedStyle.color;
        const originalBackgroundColor = computedStyle.backgroundColor;
        
        // 儲存原始樣式
        originalStyles.set(index, {
            element: el,
            color: el.style.color,
            backgroundColor: el.style.backgroundColor,
            opacity: el.style.opacity,
            filter: el.style.filter
        });
        
        // 強化文字顏色
        if (originalColor && originalColor !== 'rgba(0, 0, 0, 0)') {
            const rgb = parseRGBA(originalColor);
            if (rgb && (rgb.r + rgb.g + rgb.b) / 3 > 127) {
                // 淺色文字改為深色
                el.style.color = '#000000 !important';
            } else {
                // 深色文字保持或加深
                el.style.color = '#000000 !important';
            }
        }
        
        // 移除可能影響顏色的效果
        el.style.opacity = '1 !important';
        el.style.filter = 'none !important';
    });
    
    return originalStyles;
}

// 修訂：新增函數來處理克隆元素
function enhanceClonedElementForPDF(clonedElement) {
    const style = document.createElement('style');
    style.textContent = `
        * {
            color: #000000 !important;
            background-color: #ffffff !important;
            opacity: 1 !important;
            -webkit-print-color-adjust: exact !important;
        }
        .question-card {
            width: 555px !important;
            margin-bottom: 20px !important;
            page-break-inside: avoid !important;
        }
    `;
    clonedElement.appendChild(style);
}

// 修訂：新增函數來還原原始樣式
function restoreOriginalStyles(element, originalStyles) {
    originalStyles.forEach((styleData, index) => {
        const el = styleData.element;
        el.style.color = styleData.color;
        el.style.backgroundColor = styleData.backgroundColor;
        el.style.opacity = styleData.opacity;
        el.style.filter = styleData.filter;
    });
}

// 修訂：新增解析RGBA顏色的輔助函數
function parseRGBA(colorStr) {
    const match = colorStr.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
    if (match) {
        return {
            r: parseInt(match[1]),
            g: parseInt(match[2]),
            b: parseInt(match[3]),
            a: match[4] ? parseFloat(match[4]) : 1
        };
    }
    return null;
}


function toggleAnswer(button) {
    const answerContent = button.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (answerContent.classList.contains('hidden')) {
        answerContent.classList.remove('hidden');
        button.innerHTML = '<i class="fas fa-eye-slash mr-4"></i>隱藏詳細答案';
        // 修訂：移除動態顏色變更，使用固定深色
        button.style.color = '#2d3748';
        answerContent.style.maxHeight = answerContent.scrollHeight + 'px';
    } else {
        answerContent.classList.add('hidden');
        button.innerHTML = '<i class="fas fa-eye mr-4"></i>顯示詳細答案';
        // 修訂：移除動態顏色變更，使用固定深色
        button.style.color = '#2d3748';
        answerContent.style.maxHeight = '0';
    }
}




function togglePracticalType(toggleElement, practicalType) {
    const isActive = toggleElement.classList.contains('active');
    const quantityControl = toggleElement.closest('.question-type-selection').querySelector('.quantity-control');
    
    if (isActive) {
        toggleElement.classList.remove('active');
        selectedPracticalTypes.delete(practicalType);
        if (quantityControl) {
            quantityControl.style.display = 'none';
        }
        if (practicalType === '自訂') {
            document.getElementById('customPracticalConfig').classList.add('hidden');
        }
    } else {
        toggleElement.classList.add('active');
        selectedPracticalTypes.add(practicalType);
        if (quantityControl) {
            quantityControl.style.display = 'flex';
        }
        if (practicalType === '自訂') {
            document.getElementById('customPracticalConfig').classList.remove('hidden');
        }
    }
}

function adjustPracticalQuantity(practicalType, delta) {
    const input = document.getElementById(`quantity-${practicalType}`);
    if (input) {
        let currentValue = parseInt(input.value) || 1;
        currentValue += delta;
        if (currentValue < 1) currentValue = 1;
        if (currentValue > 10) currentValue = 10;
        input.value = currentValue;
    }
}



        // 全局變量
        var selectedQuestionTypes = new Set();
        var selectedTextId = null;

        // API 配置
// === API 配置 ===
const CLOUDFLARE_WORKER_URL = "https://script.google.com/macros/s/AKfycbzaAnSXaaCohL8b92B7bRzhMk3cMr7hhoQc1icKSr_Oy1JLFUPV32jbouJIKfEIgUepeA/exec";

// 移除原有的 questionBank, writingQuestionBank, practicalQuestionBank 常量定義
// 保留 textLibrary 變數定義，但設為空，等待初始化
let textLibrary = { texts: [] }; 

// 移除 MODEL 定義，或保持不變 (後端已有默認值)
const MODEL = "gemini";
const PRACTICAL_MODEL = "gemini";


		// 頁面初始化時抓取範文庫
// 頁面初始化時抓取範文庫
async function fetchTextLibrary() {
    try {
        const response = await fetch(CLOUDFLARE_WORKER_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'get_library_data' })
        });
        const result = await response.json();
        if (result.success && result.data) {
            textLibrary = result.data;
            generateTextLibrary(); // 數據回來後再渲染界面
        }
    } catch (e) {
        // 修改處：這裡保持安靜，不再彈出 showError
        console.warn("未登入或無法連接範文庫，已忽略錯誤 (這是正常的)");
        // 我們可以給一個空的範文列表，確保介面不壞掉
        textLibrary = { texts: [] };
        generateTextLibrary();
    }
}

// 修改 DOMContentLoaded 事件
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    updateConfigPanel();
    setupQuantityControls();
    // generateTextLibrary(); // 移除這行直接調用
    fetchTextLibrary(); // 改為從後端獲取
});





// 動態模型選擇
function getModelByType(type) {
    if (type === 'practical') {
        return 'gemini';  // 實用寫作專用模型
    }
    return 'gemini';  // 其他題型使用默認模型
}

		 function getRandomApiKey() {
            const randomIndex = Math.floor(Math.random() * API_KEYS.length);
            return API_KEYS[randomIndex];
        }

        // DOM 元素
        const generatorTypeRadios = document.querySelectorAll('input[name="generatorType"]');
        const generateBtn = document.getElementById('generateBtn');
        const progressModal = document.getElementById('progressModal');
        const resultContainer = document.getElementById('resultContainer');
        const mainContainer = document.getElementById('mainContainer');

        // 進度追踪變量
        let progressTimer = null;
        let startTime = null;
        let currentProgress = 0;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            updateConfigPanel();
            setupQuantityControls();
            generateTextLibrary();
        });

        function parseFormatting(text) {
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/(?:^|\n)\s*-\s+(.*?)(?=\n|$)/g, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)+/g, '<ul>$&</ul>');
            text = text.replace(/(?:^|\n)\s*\d+\.\s+(.*?)(?=\n|$)/g, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)+/g, '<ol>$&</ol>');
            text = text.replace(/(?:^|\n)>\s*(.*?)(?=\n|$)/g, '<div class="indent">$1</div>');
            text = text.replace(/(?:^|\n)>>\s*(.*?)(?=\n|$)/g, '<blockquote>$1</blockquote>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

function initializeEventListeners() {
    // 範疇選擇事件
    generatorTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const newType = this.value;
            resetStateOnSwitch(newType);  // **先重置狀態**
            updateConfigPanel();          // **再更新配置面板**
        });
    });

    // 主題選擇事件（保持不變）
    const topicSelect = document.getElementById('topicSelect');
    if (topicSelect) {
        topicSelect.addEventListener('change', () => {
            const customTopicGroup = document.getElementById('customTopicGroup');
            if (topicSelect.value === 'custom') {
                customTopicGroup.classList.remove('hidden');
            } else {
                customTopicGroup.classList.add('hidden');
            }
        });
    }

    // 數量滑桿同步（保持不變）
    const quantityRange = document.getElementById('quantityRange');
    const quantityInput = document.getElementById('quantity');
    if (quantityRange && quantityInput) {
        quantityRange.addEventListener('input', () => {
            quantityInput.value = quantityRange.value;
        });
    }

    // 生成按鈕事件（保持不變）
    generateBtn.addEventListener('click', handleGenerate);
}



        function setupQuantityControls() {
            // 設定所有數量控制
            const questionTypes = ['複述', '分析', '印證', '闡明', '意見', '比較'];
            questionTypes.forEach(type => {
                const input = document.getElementById(`quantity-${type}`);
                if (input) {
                    input.addEventListener('change', () => {
                        if (parseInt(input.value) < 1) input.value = 1;
                        if (parseInt(input.value) > 10) input.value = 10;
                    });
                }
            });
        }

       function generateTextLibrary() {
    const grid = document.getElementById('textLibraryGrid');
    grid.innerHTML = '';

    // 添加自訂篇章選項
    const customItem = document.createElement('div');
    customItem.className = 'text-item custom-text-item';
    customItem.onclick = () => toggleCustomText(customItem);
    customItem.innerHTML = `
        <div class="text-item-title">自訂篇章</div>
        <div class="text-item-info">
            <span>用戶自訂 · 自由</span>
            <span class="text-category">自訂</span>
        </div>
    `;
    grid.appendChild(customItem);

    // 添加原有範文
    textLibrary.texts.forEach(text => {
        const item = document.createElement('div');
        item.className = 'text-item';
        item.onclick = () => selectText(text.id, item);
        
        item.innerHTML = `
            <div class="text-item-title">${text.title}</div>
            <div class="text-item-info">
                <span>${text.author} · ${text.length}</span>
                <span class="text-category">${text.category}</span>
            </div>
        `;
        
        grid.appendChild(item);
    });
}

function toggleCustomText(element) {
    const targetPassage = document.getElementById('targetPassage');
    const isSelected = element.classList.contains('selected');
    
    if (isSelected) {
        // 取消選中自訂篇章
        element.classList.remove('selected');
        targetPassage.style.display = 'block';
        targetPassage.value = '';
        // 清除所有範文選擇
        document.querySelectorAll('.text-item').forEach(item => {
            if (item !== element) item.classList.remove('selected');
        });
        updateSelectedTexts([]);
        // 顯示提示信息
        const questionTypeContainer = document.getElementById('questionTypeContainer');
        questionTypeContainer.innerHTML = `
            <div class="bg-gray-100 p-6 rounded-xl text-center text-gray-500">
                <i class="fas fa-info-circle text-3xl mb-3"></i>
                <p>請先選擇擬題篇章，系統將為每篇篇章提供獨立的題型設定</p>
            </div>
        `;
        // 隱藏參考題目設定
        document.getElementById('customReadingConfig').classList.add('hidden');
    } else {
        // 選中自訂篇章
        document.querySelectorAll('.text-item').forEach(item => {
            item.classList.remove('selected');
        });
        element.classList.add('selected');
        targetPassage.style.display = 'block';
        targetPassage.value = '';
        targetPassage.placeholder = '請在此輸入自訂篇章內容';
        // 清除範文選擇記錄
        updateSelectedTexts([]);
        // 為自訂篇章生成題型選擇
        generateCustomTextQuestionTypes();
        // 不自動顯示參考題目設定
    }
}

function generateCustomTextQuestionTypes() {
    const questionTypeContainer = document.getElementById('questionTypeContainer');

    const selectorsHTML = `
        <div class="p-6 bg-white rounded-xl border-2 border-teal-200">
            <h4 class="text-lg font-bold mb-4 text-teal-700">
                <i class="fas fa-edit mr-2"></i>自訂篇章題型選擇
            </h4>
            <div class="question-type-container">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${generateQuestionTypeButtons('custom')}
                </div>
            </div>
        </div>
    `;

    const customConfigHTML = `
        <div id="customConfig-custom" class="hidden mt-6">
            <div class="divider"></div>
            <div>
                <label class="block text-xl font-semibold text-gray-700 mb-6">
                    <i class="fas fa-clipboard-list mr-3"></i>自訂篇章的參考題目設定
                </label>
                <div id="referenceQAList-custom" class="space-y-6">
                    <div class="reference-qa">
                        <div class="flex items-start space-x-4 bg-white p-8 rounded-2xl border-3 border-teal-200">
                            <span class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-teal-500 to-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg question-number">1</span>
                            <textarea class="flex-1 p-6 border-2 border-teal-200 rounded-xl focus:border-teal-400 focus:ring-0 transition-colors duration-300 resize-vertical" placeholder="在此輸入參考題目"></textarea>
                        </div>
                    </div>
                </div>
                <div class="flex justify-center space-x-6 mt-8">
                    <button onclick="addReferenceQA('custom')" class="w-14 h-14 bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white rounded-full flex items-center justify-center transition-all duration-300 text-xl">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button onclick="removeReferenceQA('custom')" class="w-14 h-14 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-full flex items-center justify-center transition-all duration-300 text-xl">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button onclick="clearReferenceQA('custom')" class="w-14 h-14 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white rounded-full flex items-center justify-center transition-all duration-300 text-xl">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

    questionTypeContainer.innerHTML = selectorsHTML + customConfigHTML;

    window.customTextSelections = new Set();
}



     

 function selectText(textId, element) {
    // 1. 處理自訂篇章的互斥邏輯 (加入安全檢查)
    const customItem = document.querySelector('.custom-text-item');
    if (customItem && customItem.classList.contains('selected')) {
        customItem.classList.remove('selected');
        // 清除自訂篇章的選擇狀態
        if (window.customTextSelections) window.customTextSelections.clear();
    }

    // 2. 處理當前點擊的邏輯
    if (element.classList.contains('selected')) {
        // --- 取消選擇 ---
        element.classList.remove('selected');
        
        const selectedTexts = getSelectedTexts();
        const index = selectedTexts.findIndex(text => text.id === textId);
        if (index !== -1) {
            selectedTexts.splice(index, 1);
            updateSelectedTexts(selectedTexts);
        }
        
        // 隱藏對應的參考題目設定 (加入安全檢查)
        const customConfig = document.getElementById(`customConfig-${textId}`);
        if (customConfig) {
            customConfig.classList.add('hidden');
        }

    } else {
        // --- 進行選擇 ---
        element.classList.add('selected');
        
        const selectedText = textLibrary.texts.find(text => text.id === textId);
        if (selectedText) {
            const selectedTexts = getSelectedTexts();
            selectedTexts.push(selectedText);
            updateSelectedTexts(selectedTexts);
        }
        // 選中時不自動顯示參考題目設定，需等待使用者開啟具體題型
    }
    
    // 3. 安全隱藏自訂配置區 (加入安全檢查，這是最常報錯的地方)
    const customReadingConfig = document.getElementById('customReadingConfig');
    if (customReadingConfig) {
        customReadingConfig.classList.add('hidden');
    }

    // 4. 更新輸入框內容
    updateTargetPassage();
}

function getSelectedTexts() {
    return JSON.parse(sessionStorage.getItem('selectedTexts') || '[]');
}


function updateSelectedTexts(texts) {
    // 不使用 localStorage，改用 sessionStorage，頁面離開後自動清除
    sessionStorage.setItem('selectedTexts', JSON.stringify(texts));
}


window.addEventListener('beforeunload', function() {
    // 頁面卸載時清除選擇狀態
    sessionStorage.removeItem('selectedTexts');
});

// 頁面載入時重置狀態
document.addEventListener('DOMContentLoaded', function() {
    sessionStorage.removeItem('selectedTexts');
    initializeEventListeners();
    updateConfigPanel();
    setupQuantityControls();
    generateTextLibrary();
});


function updateTargetPassage() {
    const selectedTexts = getSelectedTexts();
    const targetPassage = document.getElementById('targetPassage');
    const questionTypeContainer = document.getElementById('questionTypeContainer');
    
    if (selectedTexts.length === 0) {
        targetPassage.value = '';
        // 顯示提示信息
        questionTypeContainer.innerHTML = `
            <div class="bg-gray-100 p-6 rounded-xl text-center text-gray-500">
                <i class="fas fa-info-circle text-3xl mb-3"></i>
                <p>請先選擇擬題篇章，系統將為每篇篇章提供獨立的題型設定</p>
            </div>
        `;
    } else {
        // 將選中的範文內容合併
        const combinedContent = selectedTexts.map(text => 
            `【${text.title}】（${text.author}）\n${text.content}`
        ).join('\n\n─────────────\n\n');
        targetPassage.value = combinedContent;
        
        // 生成獨立的題型選擇
        generateIndependentQuestionTypes(selectedTexts);
    }
}

function generateIndependentQuestionTypes(selectedTexts) {
    const questionTypeContainer = document.getElementById('questionTypeContainer');
    questionTypeContainer.innerHTML = '';

    selectedTexts.forEach((text, index) => {
        const containerDiv = document.createElement('div');
        containerDiv.className = 'passage-config-container mb-8';

        // 題型選擇區塊
        const textSectionHTML = `
            <div class="p-6 bg-white rounded-xl border-2 border-teal-200">
                <h4 class="text-lg font-bold mb-4 text-teal-700">
                    <i class="fas fa-book mr-2"></i>篇章${index + 1}：${text.title}
                </h4>
                <div class="question-type-container">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="textTypes-${text.id}">
                        ${generateQuestionTypeButtons(text.id)}
                    </div>
                </div>
            </div>
        `;

        // 與此篇章對應的參考題目設定區塊 (預設隱藏)
        const customConfigHTML = `
            <div id="customConfig-${text.id}" class="hidden mt-6">
                <div class="divider"></div>
                <div>
                    <label class="block text-xl font-semibold text-gray-700 mb-6">
                        <i class="fas fa-clipboard-list mr-3"></i>篇章 《${text.title}》 的參考題目設定
                    </label>
                    <div id="referenceQAList-${text.id}" class="space-y-6">
                        <div class="reference-qa">
                            <div class="flex items-start space-x-4 bg-white p-8 rounded-2xl border-3 border-teal-200">
                                <span class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-teal-500 to-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg question-number">1</span>
                                <textarea class="flex-1 p-6 border-2 border-teal-200 rounded-xl focus:border-teal-400 focus:ring-0 transition-colors duration-300 resize-vertical" placeholder="在此輸入參考題目"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-center space-x-6 mt-8">
                        <button onclick="addReferenceQA('${text.id}')" class="w-14 h-14 bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white rounded-full flex items-center justify-center transition-all duration-300 text-xl">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button onclick="removeReferenceQA('${text.id}')" class="w-14 h-14 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-full flex items-center justify-center transition-all duration-300 text-xl">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button onclick="clearReferenceQA('${text.id}')" class="w-14 h-14 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white rounded-full flex items-center justify-center transition-all duration-300 text-xl">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        containerDiv.innerHTML = textSectionHTML + customConfigHTML;
        questionTypeContainer.appendChild(containerDiv);
    });
}



// === 修復：補上缺失的 generateQuestionTypeButtons 函數 ===

function generateQuestionTypeButtons(textId) {
    // 定義閱讀理解的題型列表
    const types = [
        { name: '複述', icon: 'fa-copy', color: 'text-blue-500' },
        { name: '分析', icon: 'fa-search', color: 'text-purple-500' },
        { name: '印證', icon: 'fa-check-circle', color: 'text-green-500' },
        { name: '闡明', icon: 'fa-lightbulb', color: 'text-yellow-500' },
        { name: '意見', icon: 'fa-comment', color: 'text-red-500' },
        { name: '比較', icon: 'fa-balance-scale', color: 'text-indigo-500' },
        { name: '選擇', icon: 'fa-list-ul', color: 'text-teal-500' },
        { name: '自訂', icon: 'fa-edit', color: 'text-gray-500' }
    ];

    // 生成每個題型的 HTML 卡片
    return types.map(type => `
        <div class="question-type-selection bg-white p-6 rounded-2xl border-3 border-transparent hover:border-blue-300 transition-all duration-300" data-type="${type.name}">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <!-- 開關按鈕：綁定 toggleIndependentQuestionType -->
                    <div class="toggle-switch mr-4" onclick="toggleIndependentQuestionType(this, '${type.name}', '${textId}')">
                        <div class="toggle-slider"></div>
                    </div>
                    <div>
                        <i class="fas ${type.icon} ${type.color} text-2xl mr-3"></i>
                        <span class="font-bold text-lg">${type.name}</span>
                    </div>
                </div>
                <!-- 關鍵詞/分數設定按鈕 (自訂題型除外) -->
                ${type.name !== '自訂' ? `
                <button class="text-gray-400 hover:text-blue-500 transition-colors" onclick="toggleKeywordInput('${type.name}', '${textId}')" title="設定關鍵詞及分數">
                    <i class="fas fa-cog"></i>
                </button>
                ` : ''}
            </div>
            
            <!-- 數量控制與關鍵詞區域 (預設隱藏，啟用後顯示) -->
            ${type.name !== '自訂' ? `
            <div class="quantity-control mt-4" style="display: none;">
                <button type="button" class="quantity-btn" onclick="adjustIndependentQuantity('${type.name}', '${textId}', -1)">
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" id="quantity-${type.name}-${textId}" min="1" max="10" value="1" class="quantity-input" readonly>
                <button type="button" class="quantity-btn" onclick="adjustIndependentQuantity('${type.name}', '${textId}', 1)">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="keywords-${type.name}-${textId}" class="keyword-input-section mt-4 hidden space-y-2">
                <!-- 關鍵詞輸入框將通過 JS updateKeywordInputs 動態生成 -->
            </div>
            ` : ''}
        </div>
    `).join('');
}


		
		
async function generateQuestionsForText(questionType, textContent, textId, textTitle = '') {
    // 1. 獲取數量
    const quantityInput = document.getElementById(`quantity-${questionType}-${textId}`) || 
                          document.getElementById(`quantity-${questionType}`);
    
    let quantity = parseInt(quantityInput?.value || 1);
    let customRefQAs = [];
    let specialInstructions = '';

    // 2. 處理自訂題型
    if (questionType === '自訂') {
        customRefQAs = Array.from(document.querySelectorAll(`#referenceQAList-${textId} .reference-qa textarea`))
            .map(el => el.value.trim())
            .filter(val => val);
        quantity = customRefQAs.length;
    }

    // 3. 處理關鍵詞與分數
    let keywordInstructions = '';
    const keywords = [];
    const scores = [];
    for (let i = 1; i <= quantity; i++) {
        keywords.push(getKeywordsForQuestion(questionType, textId, i));
        scores.push(getScoreForQuestion(questionType, textId, i));
    }

    const validKeywords = keywords.filter(k => k && k.length > 0);
    const validScores = scores.filter(s => s && s.length > 0);

    if (validKeywords.length > 0 || validScores.length > 0) {
        keywordInstructions = `\n\n特別要求：\n`;
        for (let i = 0; i < quantity; i++) {
            if (keywords[i] && keywords[i].length > 0) {
                keywordInstructions += `第${i + 1}題必須包含關鍵詞「${keywords[i]}」`;
            }
            if (scores[i] && scores[i].length > 0) {
                keywordInstructions += `${keywords[i] && keywords[i].length > 0 ? '，' : `第${i + 1}題`}分數設定為${scores[i]}分`;
            }
            if ((keywords[i] && keywords[i].length > 0) || (scores[i] && scores[i].length > 0)) {
                keywordInstructions += `\n`;
            }
        }
    }

    // 4. 重試機制與 API 調用
    let parsed = [];
    let retryCount = 0;
    const maxRetries = 3;

    while (retryCount < maxRetries) {
        try {
            const payload = {
                action: 'generate_reading',
                data: {
                    questionType: questionType,
                    textContent: textContent,
                    quantity: quantity,
                    textTitle: textTitle,
                    specialInstructions: specialInstructions,
                    keywordInstructions: keywordInstructions,
                    customRefQAs: customRefQAs
                },
                // ★★★ 修正處：補上模型參數 ★★★
                model: typeof MODEL !== 'undefined' ? MODEL : 'gemini',
                temperature: 0.7
            };

            updateProgressBar(20);
            
            const response = await fetch(CLOUDFLARE_WORKER_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            updateProgressBar(60);

            const data = await response.json();
            logProviderInfo(data, "ReadingGen");

            if (data.error) throw new Error(data.error);
            if (!data.choices || !data.choices[0]) throw new Error('API 返回格式錯誤');

            const generatedContent = removeThinkingTags(data.choices[0].message.content);
            
            parsed = questionType === '選擇' ? 
                parseChoiceResponse(generatedContent, quantity) : 
                parseReadingResponse(generatedContent, quantity);

            const hasFailure = parsed.some(item => 
                item.question.includes('生成失敗') || 
                item.answer.includes('生成失敗') ||
                item.question.includes('未生成')
            );

            if (!hasFailure) break;
            retryCount++;
            console.log(`${questionType}題型第${retryCount}次重試`);

        } catch (error) {
            console.error(error);
            if (error.message.includes("Login Required")) {
                hideProgress();
                return []; 
            }
            retryCount++;
        }
    }

    if (parsed.length === 0) {
         parsed = Array(quantity).fill().map((_, i) => ({
            question: `題目${i+1}生成失敗，請檢查網絡並重試`,
            answer: `答案${i+1}生成失敗`,
            steps: `步驟${i+1}生成失敗`
        }));
    }

    parsed.forEach(item => {
        item.type = questionType;
        item.textTitle = textTitle;
    });

    return parsed;
}


function toggleIndependentQuestionType(toggleElement, questionType, textId) {
    const isActive = toggleElement.classList.contains('active');
    const quantityControl = toggleElement.closest('.question-type-selection').querySelector('.quantity-control');
    const keywordSection = toggleElement.closest('.question-type-selection').querySelector('.keyword-input-section');

    // 處理自訂篇章的題型選擇
    if (textId === 'custom') {
        if (!window.customTextSelections) {
            window.customTextSelections = new Set();
        }
        if (isActive) {
            window.customTextSelections.delete(questionType);
        } else {
            window.customTextSelections.add(questionType);
        }
    }

    if (isActive) {
        toggleElement.classList.remove('active');
        if (quantityControl && questionType !== '自訂') quantityControl.style.display = 'none';
        if (keywordSection) keywordSection.style.display = 'none';
        removeFromIndependentSelection(questionType, textId);

        // 如果是自訂題型，隱藏對應的參考題目設定
        if (questionType === '自訂') {
            const customConfig = document.getElementById(`customConfig-${textId}`);
            if(customConfig) customConfig.classList.add('hidden');
        }
    } else {
        toggleElement.classList.add('active');
        if (quantityControl && questionType !== '自訂') quantityControl.style.display = 'flex';
        if (keywordSection) keywordSection.style.display = 'block';
        addToIndependentSelection(questionType, textId);

        // 如果是自訂題型，顯示對應的參考題目設定
        if (questionType === '自訂') {
            const customConfig = document.getElementById(`customConfig-${textId}`);
            if(customConfig) customConfig.classList.remove('hidden');
        } else {
            updateKeywordInputs(questionType, textId, 1);
        }
    }
}

function adjustIndependentQuantity(questionType, textId, delta) {
    const input = document.getElementById(`quantity-${questionType}-${textId}`);
    if (input) {
        let currentValue = parseInt(input.value) || 1;
        currentValue += delta;
        if (currentValue < 1) currentValue = 1;
        if (currentValue > 10) currentValue = 10;
        input.value = currentValue;
        updateKeywordInputs(questionType, textId, currentValue);
    }
}

function addToIndependentSelection(questionType, textId) {
    if (!window.independentSelections) {
        window.independentSelections = {};
    }
    if (!window.independentSelections[textId]) {
        window.independentSelections[textId] = new Set();
    }
    window.independentSelections[textId].add(questionType);
}

function removeFromIndependentSelection(questionType, textId) {
    if (window.independentSelections && window.independentSelections[textId]) {
        window.independentSelections[textId].delete(questionType);
    }
}


function toggleKeywordInput(questionType, textId) {
    const keywordInputs = document.getElementById(`keywords-${questionType}-${textId}`);
    if (keywordInputs.classList.contains('hidden')) {
        keywordInputs.classList.remove('hidden');
    } else {
        keywordInputs.classList.add('hidden');
    }
}

function updateKeywordInputs(questionType, textId, quantity) {
    const keywordContainer = document.getElementById(`keywords-${questionType}-${textId}`);
    if (!keywordContainer) return;
    
    keywordContainer.innerHTML = '';
    for (let i = 1; i <= quantity; i++) {
        const keywordInput = document.createElement('div');
        keywordInput.className = 'flex items-center mb-2';
        keywordInput.innerHTML = `
            <span class="text-sm mr-2">第${i}題：</span>
            <input type="text" 
                   id="keyword-${questionType}-${textId}-${i}" 
                   class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm mr-2" 
                   style="max-width: 120px; width: 120px;" 
                   placeholder="關鍵詞（可選）">
            <input type="number" 
                   id="score-${questionType}-${textId}-${i}" 
                   class="px-2 py-1 border border-gray-300 rounded text-sm" 
                   style="width: 50px;" 
                   placeholder="分"
                   min="1" 
                   max="10">
        `;
        keywordContainer.appendChild(keywordInput);
    }
}


function getScoreForQuestion(questionType, textId, questionIndex) {
    const scoreInput = document.getElementById(`score-${questionType}-${textId}-${questionIndex}`);
    return scoreInput ? scoreInput.value.trim() : '';
}


function getKeywordsForQuestion(questionType, textId, questionIndex) {
    const keywordInput = document.getElementById(`keyword-${questionType}-${textId}-${questionIndex}`);
    return keywordInput ? keywordInput.value.trim() : '';
}




        function toggleQuestionType(toggleElement, questionType) {
            const isActive = toggleElement.classList.contains('active');
            const quantityControl = toggleElement.closest('.question-type-selection').querySelector('.quantity-control');
            
            if (isActive) {
                // 取消選中
                toggleElement.classList.remove('active');
                selectedQuestionTypes.delete(questionType);
                if (quantityControl) {
                    quantityControl.style.display = 'none';
                }
                
                // 隱藏自訂配置
                if (questionType === '自訂') {
                    document.getElementById('customReadingConfig').classList.add('hidden');
                }
            } else {
                // 選中
                toggleElement.classList.add('active');
                selectedQuestionTypes.add(questionType);
                if (quantityControl) {
                    quantityControl.style.display = 'flex';
                }
                
                // 顯示自訂配置
                if (questionType === '自訂') {
                    document.getElementById('customReadingConfig').classList.remove('hidden');
                }
            }
        }

        function adjustQuantity(questionType, delta) {
            const input = document.getElementById(`quantity-${questionType}`);
            if (input) {
                let currentValue = parseInt(input.value) || 1;
                currentValue += delta;
                if (currentValue < 1) currentValue = 1;
                if (currentValue > 10) currentValue = 10;
                input.value = currentValue;
            }
        }

        function adjustEssayQuantity(delta) {
            const input = document.getElementById('quantity');
            const slider = document.getElementById('quantityRange');
            if (input && slider) {
                let currentValue = parseInt(input.value) || 3;
                currentValue += delta;
                if (currentValue < 1) currentValue = 1;
                if (currentValue > 10) currentValue = 10;
                input.value = currentValue;
                slider.value = currentValue;
            }
        }

       function updateConfigPanel() {
    const selectedType = document.querySelector('input[name="generatorType"]:checked').value;
    
    // 隱藏所有配置面板
    document.getElementById('readingConfig').classList.add('hidden');
    document.getElementById('essayConfig').classList.add('hidden');
    document.getElementById('practicalConfig').classList.add('hidden');
    
    // **重要修訂：根據選擇的範疇控制題型選擇區域顯示**
    const dynamicQuestionTypes = document.getElementById('dynamicQuestionTypes');
    if (dynamicQuestionTypes) {
        if (selectedType === 'reading') {
            dynamicQuestionTypes.style.display = 'block';
        } else {
            dynamicQuestionTypes.style.display = 'none';
        }
    }
    
    // 顯示對應的配置面板
    document.getElementById(selectedType + 'Config').classList.remove('hidden');

    // 更新選中狀態的視覺效果
    document.querySelectorAll('input[name="generatorType"]').forEach(radio => {
        const label = radio.nextElementSibling;
        if (radio.checked) {
            label.classList.add('selected');
        } else {
            label.classList.remove('selected');
        }
    });
}



        // 參考題目相關函數
       // 參考題目相關函數
function addReferenceQA(textId) {
    const list = document.getElementById(`referenceQAList-${textId}`);
    const currentCount = list.querySelectorAll('.reference-qa').length;
    const newQA = document.createElement('div');
    newQA.className = 'reference-qa fade-in';
    newQA.innerHTML = `
    <div class="flex items-start space-x-4 bg-white p-8 rounded-2xl border-3 border-teal-200">
        <span class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-teal-500 to-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg question-number">${currentCount + 1}</span>
        <textarea class="flex-1 p-6 border-2 border-teal-200 rounded-xl focus:border-teal-400 focus:ring-0 transition-colors duration-300 resize-vertical" placeholder="在此輸入參考題目"></textarea>
    </div>
    `;
    list.appendChild(newQA);
    updateReferenceNumbers(textId);
}

function removeReferenceQA(textId) {
    const list = document.getElementById(`referenceQAList-${textId}`);
    const items = list.querySelectorAll('.reference-qa');
    if (items.length > 1) {
        items[items.length - 1].remove();
        updateReferenceNumbers(textId);
    }
}

function clearReferenceQA(textId) {
    const textareas = document.querySelectorAll(`#referenceQAList-${textId} .reference-qa textarea`);
    textareas.forEach(textarea => {
        textarea.value = '';
    });
}

function updateReferenceNumbers(textId) {
    const items = document.querySelectorAll(`#referenceQAList-${textId} .reference-qa`);
    items.forEach((item, index) => {
        const numberSpan = item.querySelector('span');
        numberSpan.textContent = index + 1;
    });
}

   


        // 進度顯示函數
        function showProgress() {
            progressModal.classList.remove('hidden');
            startTime = Date.now();
            currentProgress = 0;
            updateProgressBar(currentProgress);
            
            progressTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                
                // 模擬進度更新
                if (currentProgress < 90) {
                    currentProgress += Math.random() * 2;
                    updateProgressBar(currentProgress);
                }
                
                // 更新預計剩餘時間
                if (currentProgress > 10) {
                    const estimated = (elapsed / currentProgress) * (100 - currentProgress);
                    document.getElementById('timeRemaining').textContent = Math.round(estimated) + '秒';
                }
            }, 1000);
        }

        function hideProgress() {
            progressModal.classList.add('hidden');
            if (progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
        }

        function updateProgressDisplay() {
            const steps = [
                '正在分析您的配置需求...',
                '正在連接AI智能引擎...',
                '正在生成專業題目內容...',
                '正在優化題目格式與排版...'
            ];
            
            const currentStepIndex = Math.floor(currentProgress / 25);
            const status = steps[Math.min(currentStepIndex, steps.length - 1)];
            
            document.getElementById('progressStatus').textContent = status;
            document.getElementById('currentStep').textContent = `${Math.min(currentStepIndex + 1, 4)}/4`;
        }

       function updateProgressBar(progress) {
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    
    const clampedProgress = Math.min(100, Math.max(0, progress));
    
    // 更新進度條寬度
    progressBar.style.width = clampedProgress + '%';
    
    // 更新百分比
    progressPercent.textContent = Math.round(clampedProgress) + '%';
}

        // 主要生成函數
        async function handleGenerate() {
            const selectedType = document.querySelector('input[name="generatorType"]:checked').value;
            
            try {
                if (!validateInput(selectedType)) {
                    return;
                }
                
                showProgress();
                
                if (selectedType === 'reading') {
                    await generateReadingQuestions();
                } else if (selectedType === 'essay') {
                    await generateEssayQuestions();
                } else if (selectedType === 'practical') {
                    await generatePracticalQuestions();
                }
                
            } catch (error) {
                console.error('生成錯誤：', error);
                showError('生成過程中發生錯誤，請稍後重試');
                hideProgress();
            }
        }

     function validateInput(type) {
    if (type === 'reading') {
        const selectedTexts = getSelectedTexts();
        const targetPassage = document.getElementById('targetPassage').value.trim();
        
        // 檢查是否選擇了範文或輸入了自訂內容
        if (selectedTexts.length === 0 && !targetPassage) {
            showError('請選擇範文或輸入自訂篇章內容');
            return false;
        }
        
        // 檢查是否選擇了題型
        let hasSelectedTypes = false;
        if (selectedTexts.length > 0) {
            // 檢查範文的題型選擇
            if (window.independentSelections) {
                for (const textId of Object.keys(window.independentSelections)) {
                    if (window.independentSelections[textId].size > 0) {
                        hasSelectedTypes = true;
                        break;
                    }
                }
            }
        } else {
            // 檢查自訂篇章的題型選擇
            const customSelections = document.querySelectorAll('[data-text-id="custom"] .toggle-switch.active');
            hasSelectedTypes = customSelections.length > 0;
        }
        
        if (!hasSelectedTypes) {
            showError('請至少選擇一種題型');
            return false;
        }
    } else if (type === 'essay') {

        if (selectedWritingTypes.size === 0) {
            showError('請至少選擇一種題型');
            return false;
        }
        
        if (selectedWritingTypes.has('自訂')) {
            const refQuestions = Array.from(document.querySelectorAll('.essay-reference textarea')).map(el => el.value.trim()).filter(val => val);
            if (refQuestions.length === 0) {
                showError('自訂模式下請輸入至少一個參考題目');
                return false;
            }
        }
    } else if (type === 'practical') {
        // 檢查是否選擇了體裁
        if (selectedPracticalTypes.size === 0) {
            showError('請至少選擇一種體裁');
            return false;
        }
        
        // 檢查自訂主題
        const selectedTopic = document.getElementById('topicSelect').value;
        if (selectedTopic === 'custom') {
            const customTopic = document.getElementById('customTopic').value.trim();
            if (!customTopic) {
                showError('請輸入自訂主題內容');
                return false;
            }
        }
        
        // 檢查自訂體裁的參考內容
        if (selectedPracticalTypes.has('自訂')) {
            const refQuestion = document.getElementById('customRefQuestion').value.trim();
            const refMaterial1 = document.getElementById('customRefMaterial1').value.trim();
            const refMaterial2 = document.getElementById('customRefMaterial2').value.trim();
            if (!refQuestion || !refMaterial1 || !refMaterial2) {
                showError('自訂體裁模式下請完整輸入參考題目及兩個資料');
                return false;
            }
        }
    }
    
    return true;
}


        // 具體生成函數
      async function generateReadingQuestions() {
    const selectedTexts = getSelectedTexts();
    let allQuestions = [];
    
    if (selectedTexts.length === 0) {
        // 處理自訂篇章
        const targetPassage = document.getElementById('targetPassage').value.trim();
        if (!targetPassage) {
            showError('請選擇範文或輸入自訂篇章內容');
            hideProgress();
            return;
        }
        
        // 獲取自訂篇章的題型選擇
        const customSelections = document.querySelectorAll('[data-text-id="custom"] .toggle-switch.active');
        const selectedTypes = [];
        customSelections.forEach(toggle => {
            const questionTypeDiv = toggle.closest('.question-type-selection');
            if (questionTypeDiv) {
                const questionType = questionTypeDiv.getAttribute('data-type');
                selectedTypes.push(questionType);
            }
        });
        
        // 為自訂篇章生成題目
        for (const questionType of selectedTypes) {
            const questions = await generateQuestionsForText(questionType, targetPassage, 'custom');
            allQuestions = allQuestions.concat(questions);
        }
    } else {

        // 處理選中的範文
        for (const text of selectedTexts) {
            if (window.independentSelections && window.independentSelections[text.id]) {
                for (const questionType of window.independentSelections[text.id]) {
                    const questions = await generateQuestionsForText(questionType, text.content, text.id, text.title);
                    allQuestions = allQuestions.concat(questions);
                }
            }
        }
    }
    
    displayReadingQuestions(allQuestions);
}

// ==========================================
// === 前端修復：generateQuestionsForText ===
// ==========================================

async function generateQuestionsForText(questionType, textContent, textId, textTitle = '') {
    // 1. 獲取數量
    const quantityInput = document.getElementById(`quantity-${questionType}-${textId}`) || 
                          document.getElementById(`quantity-${questionType}`);
    
    let quantity = parseInt(quantityInput?.value || 1);
    let customRefQAs = [];
    let specialInstructions = '';

    // 2. 處理自訂題型 (只負責收集用戶輸入的資料，不負責找範例)
    if (questionType === '自訂') {
        customRefQAs = Array.from(document.querySelectorAll(`#referenceQAList-${textId} .reference-qa textarea`))
            .map(el => el.value.trim())
            .filter(val => val);
        quantity = customRefQAs.length;
    }

    // 3. 處理關鍵詞與分數 (構建 keywordInstructions 字串傳給後端)
    let keywordInstructions = '';
    // 只有非自訂題型才需要處理這部分，或者自訂題型也想支援關鍵詞亦可
    const keywords = [];
    const scores = [];
    for (let i = 1; i <= quantity; i++) {
        keywords.push(getKeywordsForQuestion(questionType, textId, i));
        scores.push(getScoreForQuestion(questionType, textId, i));
    }

    const validKeywords = keywords.filter(k => k && k.length > 0);
    const validScores = scores.filter(s => s && s.length > 0);

    if (validKeywords.length > 0 || validScores.length > 0) {
        keywordInstructions = `\n\n特別要求：\n`;
        for (let i = 0; i < quantity; i++) {
            if (keywords[i] && keywords[i].length > 0) {
                keywordInstructions += `第${i + 1}題必須包含關鍵詞「${keywords[i]}」`;
            }
            if (scores[i] && scores[i].length > 0) {
                keywordInstructions += `${keywords[i] && keywords[i].length > 0 ? '，' : `第${i + 1}題`}分數設定為${scores[i]}分`;
            }
            if ((keywords[i] && keywords[i].length > 0) || (scores[i] && scores[i].length > 0)) {
                keywordInstructions += `\n`;
            }
        }
    }

    // 4. 重試機制與 API 調用
    let parsed = [];
    let retryCount = 0;
    const maxRetries = 3;

    while (retryCount < maxRetries) {
        try {
            // ★★★ 修改重點：不再前端構建 Prompt，而是發送 Action 和 Data ★★★
            const payload = {
                action: 'generate_reading', // 對應後端 PROMPT_TEMPLATES 的 key
                data: {
                    questionType: questionType,
                    textContent: textContent,
                    quantity: quantity,
                    textTitle: textTitle,
                    specialInstructions: specialInstructions, // 選擇題的特殊格式要求已在後端處理，這裡留空或傳入額外指示
                    keywordInstructions: keywordInstructions,
                    customRefQAs: customRefQAs // 如果是自訂題，把參考題目傳過去
                }
            };

            // 使用 fetch 發送請求 (因為我們傳的是 payload 結構，不是標準的 openai messages 結構)
            // 這裡直接模擬 callAPI 的行為，但傳入的是 payload
            updateProgressBar(20);
            
            const response = await fetch(CLOUDFLARE_WORKER_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            updateProgressBar(60);

            const data = await response.json();
            logProviderInfo(data, "ReadingGen"); // 使用您的 Log 函數

            if (data.error) throw new Error(data.error);
            if (!data.choices || !data.choices[0]) throw new Error('API 返回格式錯誤');

            const generatedContent = removeThinkingTags(data.choices[0].message.content);
            
            // 解析回應
            parsed = questionType === '選擇' ? 
                parseChoiceResponse(generatedContent, quantity) : 
                parseReadingResponse(generatedContent, quantity);

            // 驗證是否生成失敗
            const hasFailure = parsed.some(item => 
                item.question.includes('生成失敗') || 
                item.answer.includes('生成失敗') ||
                item.question.includes('未生成')
            );

            if (!hasFailure) break;
            retryCount++;
            console.log(`${questionType}題型第${retryCount}次重試`);

        } catch (error) {
            console.error(error);
            retryCount++;
        }
    }

    // 失敗處理
    if (parsed.length === 0) {
         parsed = Array(quantity).fill().map((_, i) => ({
            question: `題目${i+1}生成失敗，請檢查網絡並重試`,
            answer: `答案${i+1}生成失敗`,
            steps: `步驟${i+1}生成失敗`
        }));
    }

    // 標記題型屬性
    parsed.forEach(item => {
        item.type = questionType;
        item.textTitle = textTitle;
    });

    return parsed;
}


function parseChoiceResponse(response, count) {
	const cleanResponse = removeThinkingTags(response);
	const lines = cleanResponse.split('\n').filter(line => line.trim() !== '');
	
	const parsed = [];
	
	for (let i = 1; i <= count; i++) {
		let question = '';
		let options = [];
		let answer = '';
		let steps = '';
		
		let questionFound = false;
		let optionsFound = false;
		let answerFound = false;
		let stepsFound = false;
		
		for (let j = 0; j < lines.length; j++) {
			const line = lines[j].trim();
			
			// 解析題目
			if (line.startsWith(`題目${i}：`)) {
				question = line.replace(`題目${i}：`, '').trim();
				questionFound = true;
				continue;
			}
			
			// 解析選項容器
			if (line === '選擇題選項容器：' && questionFound && !optionsFound) {
				let k = j + 1;
				options = [];
				while (k < lines.length) {
					const optionLine = lines[k].trim();
					if (optionLine.match(/^[A-D]\.\s/)) {
						options.push(optionLine);
						k++;
					} else {
						break;
					}
				}
				optionsFound = true;
				j = k - 1;
				continue;
			}
			
			// 解析答案
			if (line.startsWith(`答案${i}：`) && questionFound) {
				answer = line.replace(`答案${i}：`, '').trim();
				answerFound = true;
				continue;
			}
			
			// 解析步驟
			if (line.startsWith(`步驟${i}：`) && questionFound) {
				steps = line.replace(`步驟${i}：`, '').trim();
				stepsFound = true;
				continue;
			}
		}
		
		// 修訂處：改為更寬鬆的錯誤處理
		if (!questionFound || !question.trim()) {
			question = `選擇題${i}題目`;
		}
		if (!optionsFound || options.length < 4) {
			options = [`A. 選項A`, `B. 選項B`, `C. 選項C`, `D. 選項D`];
		}
		if (!answerFound || !answer.trim()) {
			answer = `A 選項A`;
		}
		if (!stepsFound || !steps.trim()) {
			steps = `請分析題目要求，逐一檢視各選項內容，找出最符合題意的答案。`;
		}
		
		// 構建完整的題目內容：題目 + 選項
		let fullQuestion = question;
		if (options.length > 0) {
			fullQuestion += '\n\n選項：\n' + options.join('\n');
		}
		
		parsed.push({ 
			question: fullQuestion, 
			answer, 
			steps 
		});
	}
	
	return parsed;
}



// ==========================================
// === [修訂] 長文生成函式 (加入 Token) ===
// ==========================================
async function generateEssayQuestions() {
    let allQuestions = [];
    const customEssayType = document.querySelector('input[name="customEssayType"]:checked')?.value;
    
    for (const questionType of selectedWritingTypes) {
        let quantity;
        let customRefQuestions = [];
        
        const existingQuestions = getGeneratedQuestions(questionType);
        let existingKeywordsText = '';
        if (existingQuestions.length > 0) {
            const allExistingKeywords = existingQuestions.flatMap(q => q.keywords);
            existingKeywordsText = `已出過的主題關鍵詞：${allExistingKeywords.join('、')}`;
        }

        if (questionType === '自訂') {
            if (!customEssayType) {
                showError('請選擇自訂類型');
                hideProgress();
                return;
            }
            customRefQuestions = Array.from(document.querySelectorAll('.essay-reference textarea'))
                .map(el => el.value.trim()).filter(val => val);
            quantity = customRefQuestions.length || 3; 
        } else {
            const quantityInput = document.getElementById(`quantity-${questionType}`);
            quantity = parseInt(quantityInput.value);
        }

        let successfulQuestions = [];
        let retryCount = 0;
        
        while (successfulQuestions.length < quantity && retryCount < 3) {
            try {
                const user = firebase.auth().currentUser;
                const token = user ? await user.getIdToken() : "";

                const payload = {
                    token: token, 
                    action: 'generate_essay',
                    data: {
                        questionType: questionType,
                        quantity: quantity - successfulQuestions.length,
                        customEssayType: customEssayType,
                        customRefQuestions: customRefQuestions,
                        existingKeywordsText: existingKeywordsText
                    },
                    // ★★★ 修正處：補上模型參數 ★★★
                    model: typeof MODEL !== 'undefined' ? MODEL : 'gemini',
                    temperature: 0.7
                };

                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                logProviderInfo(data, "EssayGen");
                
                if (data.error) throw new Error(data.error);

                const generatedContent = removeThinkingTags(data.choices[0].message.content);
                const parsed = parseWritingResponse(generatedContent, quantity - successfulQuestions.length);

                for (let item of parsed) {
                    if (!item.question.includes('失敗')) {
                        const newKeywords = extractKeywords(item.question);
                        let isDuplicate = false;
                        for (let existingQ of existingQuestions) {
                            if (isTopicSimilar(newKeywords, existingQ.keywords)) { isDuplicate = true; break; }
                        }
                        for (let successQ of successfulQuestions) {
                            const successKeywords = extractKeywords(successQ.question);
                            if (isTopicSimilar(newKeywords, successKeywords)) { isDuplicate = true; break; }
                        }
                        if (!isDuplicate) {
                            item.type = questionType;
                            successfulQuestions.push(item);
                            saveGeneratedQuestion(questionType, item.question);
                        }
                    }
                }
                
                if (successfulQuestions.length >= quantity) break;
                retryCount++;

            } catch (e) { 
                console.error("生成長文題目時發生錯誤:", e); 
                if (e.message.includes("Login Required")) {
                    hideProgress();
                    return;
                }
                retryCount++; 
            }
        }
        
        while (successfulQuestions.length < quantity) {
             successfulQuestions.push({ 
                 question: '生成失敗，請稍後重試', 
                 solution: '', 
                 direction: '', 
                 type: questionType 
             });
        }
        allQuestions = allQuestions.concat(successfulQuestions);
    }
    
    displayWritingQuestions(allQuestions);
}
		
// 解析長文寫作回應
function parseWritingResponse(response, count) {
    const cleanResponse = removeThinkingTags(response);
    const lines = cleanResponse.split('\n').filter(line => line.trim() !== '');
    
    const parsed = [];
    
    for (let i = 1; i <= count; i++) {
        let question = '生成失敗，請檢查輸入內容並重試';
        let solution = '生成失敗，請檢查輸入內容並重試';
        let direction = '生成失敗，請檢查輸入內容並重試';
        
        for (let j = 0; j < lines.length; j++) {
            const line = lines[j].trim();
            
            if (line.startsWith(`題目${i}：`)) {
                question = line.replace(`題目${i}：`, '').trim();
            }
            
            if (line.startsWith(`題解${i}：`)) {
                solution = line.replace(`題解${i}：`, '').trim();
            }

            if (line.startsWith(`方向${i}：`)) {
                direction = line.replace(`方向${i}：`, '').trim();
            }
        }
        
        parsed.push({ question, solution, direction });
    }
    
    return parsed;
}

// 顯示長文寫作結果
function displayWritingQuestions(allQuestions) {
    hideProgress();
    
    const questionsDisplay = document.getElementById('questionsDisplay');
    questionsDisplay.innerHTML = '';

    allQuestions.forEach((item, index) => {
        const questionCard = createWritingQuestionCard(
            `第${index + 1}題`,
            item.question,
            item.solution,
            item.direction,
            item.type || 'essay'
        );
        questionsDisplay.appendChild(questionCard);
    });

    showResult();
}

// 創建長文寫作題目卡片
function createWritingQuestionCard(title, content, solution, direction, type) {
    const card = document.createElement('div');
    card.className = 'question-card p-10 shadow-2xl slide-up mb-12';

    const typeColors = {
        '敘事': '#D4909F',
        '開放': '#B496EB',
        '議論': '#722F3E',
        'essay': 'var(--primary-blue)'
    };

    const typeColor = typeColors[type] || 'var(--primary-blue)';

    // **修訂處：添加 formattedContent 的宣告和處理**
    let formattedContent = content;
    // 長文寫作內容通常包含換行，進行處理以確保在HTML中正確顯示
    formattedContent = formattedContent.replace(/\n/g, '<br>');

    let cardHTML = `
    <div class="flex items-center justify-between mb-8">
        <div class="question-title" style="background: linear-gradient(135deg, ${typeColor} 0%, ${typeColor}80 100%);">
            <i class="fas fa-question-circle mr-4"></i>
            ${title}
        </div>
        <span class="px-6 py-3 rounded-full text-base font-bold text-white" style="background: linear-gradient(135deg, ${typeColor} 0%, ${typeColor}CC 100%);">${type}</span>
    </div>
    <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl p-8 mb-8 border-2 border-gray-100">
`;

    // 根據內容判斷是否需要HTML解析
    // **修訂處：使用處理後的 formattedContent**
    if (formattedContent.includes('<table') || formattedContent.includes('<div')) {
        cardHTML += `<div class="text-gray-800 leading-relaxed text-lg font-medium">${formattedContent}</div>`;
    } else {
        // **修訂處：使用處理後的 formattedContent**
        cardHTML += `<div class="text-gray-800 leading-relaxed whitespace-pre-wrap text-lg font-medium">${formattedContent}</div>`;
    }
    cardHTML += `
    </div>
`;

    if (solution && direction) {
        cardHTML += `
            <div class="border-t-4 pt-8" style="border-color: var(--divider-color);">
                <button onclick="toggleWritingAnswer(this, '${typeColor}')" class="flex items-center font-bold mb-6 transition-colors duration-300 text-xl hover:transform hover:scale-105" style="color: ${typeColor};">
                    <i class="fas fa-eye mr-4"></i>顯示題解及方向
                </button>
                <div class="answer-content hidden">
                    <div class="answer-section mb-6">
                        <h4 class="font-bold mb-6 flex items-center text-xl" style="color: var(--primary-green);">
                            <i class="fas fa-lightbulb mr-4"></i>題解
                        </h4>
                        <div class="leading-relaxed whitespace-pre-wrap text-gray-700 text-lg">${solution}</div>
                    </div>
                    <div class="steps-section">
                        <h4 class="font-bold mb-6 flex items-center text-xl" style="color: #7fb3d5;">
                            <i class="fas fa-compass mr-4"></i>方向
                        </h4>
                        <div class="leading-relaxed whitespace-pre-wrap text-gray-700 text-lg">${direction}</div>
                    </div>
                </div>
            </div>
        `;
    }

    card.innerHTML = cardHTML;
    return card;
}

// 切換長文寫作答案顯示
function toggleWritingAnswer(button, typeColor) {
    const answerContent = button.nextElementSibling;
    
    if (answerContent.classList.contains('hidden')) {
        answerContent.classList.remove('hidden');
        button.innerHTML = '<i class="fas fa-eye-slash mr-4"></i>隱藏題解及方向';
        button.style.color = typeColor;
        answerContent.style.maxHeight = answerContent.scrollHeight + 'px';
    } else {
        answerContent.classList.add('hidden');
        button.innerHTML = '<i class="fas fa-eye mr-4"></i>顯示題解及方向';
        button.style.color = typeColor;
        answerContent.style.maxHeight = '0';
    }
}


// ==========================================
// === [修訂] 實用文生成函式 (加入 Token) ===
// ==========================================
async function generatePracticalQuestions() {
    const selectedTopic = document.getElementById('topicSelect').value;
    let topicInstruction = '';
    
    if (selectedTopic === 'custom') {
        const customTopic = document.getElementById('customTopic').value.trim();
        if (!customTopic) { showError('請輸入自訂主題'); hideProgress(); return; }
        topicInstruction = `請以「${customTopic}」為主題。`;
    } else if (selectedTopic === 'random') {
        topicInstruction = '請隨機選擇一個主題...'; 
    } else {
        topicInstruction = `請以「${selectedTopic}」為主題。`;
    }

    let allQuestions = [];
    for (const practicalType of selectedPracticalTypes) {
        const quantityInput = document.getElementById(`quantity-${practicalType}`);
        const quantity = parseInt(quantityInput.value);
        let customRefData = null;

        if (practicalType === '自訂') {
            customRefData = {
                question: document.getElementById('customRefQuestion').value.trim(),
                material1: document.getElementById('customRefMaterial1').value.trim(),
                material2: document.getElementById('customRefMaterial2').value.trim()
            };
            if (!customRefData.question) { showError('請輸入完整資料'); return; }
        }

        for (let i = 0; i < quantity; i++) {
            try {
                const user = firebase.auth().currentUser;
                const token = user ? await user.getIdToken() : "";

                const payload = {
                    token: token,
                    action: 'generate_practical',
                    data: {
                        practicalType: practicalType,
                        topicInstruction: topicInstruction,
                        customRefData: customRefData
                    },
                    // ★★★ 修正處：補上模型參數 ★★★
                    model: typeof MODEL !== 'undefined' ? MODEL : 'gemini',
                    temperature: 0.7
                };

                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                logProviderInfo(data, "PracticalGen");

                if (data.error) throw new Error(data.error);
                
                const generatedContent = removeThinkingTags(data.choices[0].message.content);
                const parsed = parsePracticalResponse(generatedContent);
                parsed.type = practicalType;
                allQuestions.push(parsed);

            } catch (error) {
                console.error(error);
                if (error.message.includes("Login Required")) {
                    hideProgress();
                    return;
                }
                allQuestions.push({ question: '生成失敗', type: practicalType });
            }
        }
    }
    displayPracticalQuestions(allQuestions);
}


        // API 調用函數
// API 調用函數 (GAS 代理 + 美化 Log 版)
async function callAPI(requestBody, modelOverride = null) {
    updateProgressBar(20);
    
    // 【修改重點】移除手動檢查，讓攔截器去處理
    const user = firebase.auth().currentUser;
    const token = user ? await user.getIdToken() : ""; 

    const effectiveModel = modelOverride || MODEL;
    const payload = {
        token: token,
        action: requestBody.action || null, 
        data: requestBody.data || null,
        messages: requestBody.messages, 
        model: effectiveModel,
        max_tokens: requestBody.max_tokens || 64000,
        temperature: 0.7
    };

    // 這裡的 fetch 會被攔截
    const response = await fetch(CLOUDFLARE_WORKER_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
    });
    
    updateProgressBar(60);

    if (!response.ok) {
        const errorText = await response.text();
        console.error('API錯誤響應:', errorText);
        throw new Error(`API請求失敗，狀態碼：${response.status}`);
    }

    const data = await response.json();
    
    updateProgressBar(90);

    logProviderInfo(data, "TextGen");

    if (data.error) {
        if (data.trace) {
            data.trace.forEach(t => console.warn("Backend Trace:", t));
        }
        console.error('後端返回錯誤:', data.error);
        throw new Error(`生成失敗: ${data.error}`);
    }

    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
        console.error('API返回數據格式錯誤:', data);
        throw new Error('API返回數據格式不正確');
    }

    let generatedContent = data.choices[0].message.content;
    generatedContent = removeThinkingTags(generatedContent);
    
    updateProgressBar(100);
    
    return generatedContent;
}


		// ★★★ 新增：統一處理 Log 顏色的輔助函數 ★★★
function logProviderInfo(dataOrResponse, apiName) {
    let provider = null;
    let debugTrace = null;

    // 1. 判斷資料來源
    if (dataOrResponse._provider_log) {
        // [情況 A] 新版 GAS：從 JSON 本體讀取
        provider = dataOrResponse._provider_log;
        // 如果後端有回傳 trace 陣列，也可在此讀取 (目前後端成功時未回傳 trace，但預留接口)
        if (Array.isArray(dataOrResponse.trace)) {
            debugTrace = dataOrResponse.trace;
        }
    } else if (dataOrResponse.headers && typeof dataOrResponse.headers.get === 'function') {
        // [情況 B] 舊版/Worker：從 Header 讀取
        provider = dataOrResponse.headers.get('X-Provider-Log');
        const traceStr = dataOrResponse.headers.get('X-Debug-Trace');
        if (traceStr) {
            try { debugTrace = JSON.parse(traceStr); } catch(e) {}
        }
    }

    // 2. 顯示失敗的嘗試 (如果有 Trace)
    if (debugTrace && Array.isArray(debugTrace)) {
        debugTrace.forEach(trace => {
            console.log(`%c[${apiName} Fail] ${trace}`, "color: #ffeb3b; background: #333; padding: 2px 5px;");
        });
    }

    // 3. 顯示成功的調用 (顏色設定)
    if (provider) {
        if (provider.includes("OFFICIAL DEEPSEEK")) {
            // 官方 DeepSeek：橙紅風格
            console.log(`%c🚀 [${apiName}] SUCCESS via ${provider}`, "color: #fff; background: #e64a19; padding: 4px 8px; border-radius: 4px; font-weight: bold;");
        } else {
            // Pollinations 或其他：藍綠風格
            console.log(`%c🌿 [${apiName}] SUCCESS via ${provider}`, "color: #fff; background: #009688; padding: 4px 8px; border-radius: 4px; font-weight: bold;");
        }
    }
}

        // 輔助函數
        function removeThinkingTags(content) {
            if (typeof content !== 'string') {
                return content;
            }
            return content.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
        }

        function parseReadingResponse(response, count) {
            const cleanResponse = removeThinkingTags(response);
            const lines = cleanResponse.split('\n').filter(line => line.trim() !== '');
            
            const parsed = [];
            
            for (let i = 1; i <= count; i++) {
                let question = '生成失敗，請檢查輸入內容並重試';
                let answer = '生成失敗，請檢查輸入內容並重試';
                let steps = '生成失敗，請檢查輸入內容並重試';
                
                for (let j = 0; j < lines.length; j++) {
                    const line = lines[j].trim();
                    
                    if (line.startsWith(`題目${i}：`)) {
                        question = line.replace(`題目${i}：`, '').trim();
                        if (!question && j + 1 < lines.length) {
                            const nextLine = lines[j + 1].trim();
                            if (!nextLine.startsWith('答案') && !nextLine.startsWith('題目') && !nextLine.startsWith('步驟')) {
                                question = nextLine;
                            }
                        }
                    }
                    
                    if (line.startsWith(`答案${i}：`)) {
                        answer = line.replace(`答案${i}：`, '').trim();
                        if ((!answer || answer.length < 10) && j + 1 < lines.length) {
                            let answerContent = answer;
                            let k = j + 1;
                            while (k < lines.length) {
                                const nextLine = lines[k].trim();
                                if (nextLine.startsWith('題目') || nextLine.startsWith('答案') || nextLine.startsWith('步驟')) {
                                    break;
                                }
                                if (nextLine) {
                                    answerContent += (answerContent ? '\n' : '') + nextLine;
                                }
                                k++;
                            }
                            if (answerContent) {
                                answer = answerContent.trim();
                            }
                        }
                    }

                    if (line.startsWith(`步驟${i}：`)) {
                        steps = line.replace(`步驟${i}：`, '').trim();
                        if ((!steps || steps.length < 5) && j + 1 < lines.length) {
                            let stepsContent = steps;
                            let k = j + 1;
                            while (k < lines.length) {
                                const nextLine = lines[k].trim();
                                if (nextLine.startsWith('題目') || nextLine.startsWith('答案') || nextLine.startsWith('步驟')) {
                                    break;
                                }
                                if (nextLine) {
                                    stepsContent += (stepsContent ? '\n' : '') + nextLine;
                                }
                                k++;
                            }
                            if (stepsContent) {
                                steps = stepsContent.trim();
                            }
                        }
                    }
                }
                
                if (!question || question === answer) {
                    question = `題目${i}生成失敗，請檢查輸入內容並重試`;
                }
                if (!answer || answer === question) {
                    answer = `答案${i}生成失敗，請檢查輸入內容並重試`;
                }
                if (!steps || steps === question || steps === answer) {
                    steps = `步驟${i}生成失敗，請檢查輸入內容並重試`;
                }
                
                parsed.push({ question, answer, steps });
            }
            
            return parsed;
        }
function parsePracticalResponse(response) {
    const cleanResponse = removeThinkingTags(response);
    let question = '未生成';
    let material1 = '未生成';
    let material2 = '未生成';
    
    // 處理題目
    const questionMatch = cleanResponse.match(/題目：([\s\S]*?)(?=資料一：|$)/);
    if (questionMatch && questionMatch[1]) {
        question = questionMatch[1].trim();
        // 只替換非HTML內容的換行
        if (!/<[a-z][\s\S]*>/i.test(question)) {
            question = question.replace(/\n/g, '<br>');
        }
    }
    
    // 處理資料一 - 重點修訂部分
    const material1Match = cleanResponse.match(/資料一：([\s\S]*?)(?=資料二：|$)/);
    if (material1Match && material1Match[1]) {
        let rawMaterial1 = material1Match[1].trim();
        // 判斷是否包含HTML標籤（特別是表格）
        if (/<[a-z][\s\S]*>/i.test(rawMaterial1)) {
            // 保留HTML格式，僅移除前後空白和多餘的空行
            material1 = rawMaterial1.replace(/^\s+|\s+$/g, '').replace(/\n\s*\n\s*\n+/g, '\n\n');
        } else {
            // 非HTML內容，正常替換換行
            material1 = rawMaterial1.replace(/\n/g, '<br>');
        }
    }
    
    // 處理資料二
    const material2Match = cleanResponse.match(/資料二：([\s\S]*)/);
    if (material2Match && material2Match[1]) {
        let rawMaterial2 = material2Match[1].trim();
        // 處理HTML內容
        if (/<[a-z][\s\S]*>/i.test(rawMaterial2)) {
            material2 = rawMaterial2.replace(/^\s+|\s+$/g, '').replace(/\n\s*\n\s*\n+/g, '\n\n');
        } else {
            material2 = rawMaterial2.replace(/\n/g, '<br>');
        }
    }
    
    // 備用解析邏輯
    if ((question === '未生成' || material1 === '未生成' || material2 === '未生成') && cleanResponse.includes('題目：')) {
        const parts = cleanResponse.split('題目：');
        if (parts.length > 1) {
            const questionPart = parts[1];
            const material1Index = questionPart.indexOf('資料一：');
            const material2Index = questionPart.indexOf('資料二：');
            
            if (material1Index !== -1) {
                question = questionPart.substring(0, material1Index).trim();
                if (!/<[a-z][\s\S]*>/i.test(question)) {
                    question = question.replace(/\n/g, '<br>');
                }
                
                const material1Part = questionPart.substring(material1Index + 4);
                if (material2Index !== -1 && material2Index > material1Index) {
                    const rawMaterial1 = material1Part.substring(0, material2Index - material1Index - 4).trim();
                    if (/<[a-z][\s\S]*>/i.test(rawMaterial1)) {
                        material1 = rawMaterial1.replace(/^\s+|\s+$/g, '').replace(/\n\s*\n\s*\n+/g, '\n\n');
                    } else {
                        material1 = rawMaterial1.replace(/\n/g, '<br>');
                    }
                    
                    const rawMaterial2 = questionPart.substring(material2Index + 4).trim();
                    if (/<[a-z][\s\S]*>/i.test(rawMaterial2)) {
                        material2 = rawMaterial2.replace(/^\s+|\s+$/g, '').replace(/\n\s*\n\s*\n+/g, '\n\n');
                    } else {
                        material2 = rawMaterial2.replace(/\n/g, '<br>');
                    }
                } else {
                    const rawMaterial1 = material1Part.trim();
                    if (/<[a-z][\s\S]*>/i.test(rawMaterial1)) {
                        material1 = rawMaterial1.replace(/^\s+|\s+$/g, '').replace(/\n\s*\n\s*\n+/g, '\n\n');
                    } else {
                        material1 = rawMaterial1.replace(/\n/g, '<br>');
                    }
                }
            }
        }
    }
    
    return { question, material1, material2 };
}

        // 顯示結果函數
        function displayReadingQuestions(allQuestions) {
            hideProgress();
            
            const questionsDisplay = document.getElementById('questionsDisplay');
            questionsDisplay.innerHTML = '';

            allQuestions.forEach((item, index) => {
                const questionCard = createQuestionCard(
                    `第${index + 1}題`,
                    item.question,
                    item.answer,
                    item.steps,
                    item.type || 'reading'
                );
                questionsDisplay.appendChild(questionCard);
            });

            showResult();
        }

        function displayEssayQuestions(questions) {
            hideProgress();
            
            const questionsDisplay = document.getElementById('questionsDisplay');
            questionsDisplay.innerHTML = '';

            const trimmedQuestions = questions.trim();
            const questionList = trimmedQuestions.split('\n').filter(q => q.trim());

            questionList.forEach((question, index) => {
                const questionCard = createQuestionCard(
                    `第${index + 1}題`,
                    question.trim(),
                    null,
                    null,
                    'essay'
                );
                questionsDisplay.appendChild(questionCard);
            });

            showResult();
        }
function displayPracticalQuestions(allQuestions) {
    hideProgress();

    const questionsDisplay = document.getElementById('questionsDisplay');
    questionsDisplay.innerHTML = '';

    allQuestions.forEach((item, index) => {
        const titleCard = createQuestionCard(`第${index + 1}題 - 題目`, item.question, null, null, item.type);
        questionsDisplay.appendChild(titleCard);

        const material1Card = createQuestionCard(`第${index + 1}題 - 資料一`, item.material1, null, null, item.type);
        questionsDisplay.appendChild(material1Card);

        const material2Card = createQuestionCard(`第${index + 1}題 - 資料二`, item.material2, null, null, item.type);
        questionsDisplay.appendChild(material2Card);
    });

    showResult();
}

        function createQuestionCard(title, content, answer = null, steps = null, type = 'default') {
    const card = document.createElement('div');
    card.className = 'question-card p-10 shadow-2xl slide-up mb-12';
    
   // **修訂處：格式化選擇題內容，正確處理HTML標籤**
    let formattedContent = content;
    if (type === '選擇') {
        // 先處理換行符為HTML換行
        formattedContent = content.replace(/\n/g, '<br>');
        // 為選擇題選項添加特殊樣式
        formattedContent = formattedContent.replace(/選項：<br>/g, '<div class="choice-options-container"><h4 class="choice-options-title">選項：</h4>');
        formattedContent = formattedContent.replace(/([A-D]\.\s[^<]+?)(?=<br>|$)/g, '<div class="choice-option">$1</div>');
        if (formattedContent.includes('choice-options-container')) {
            formattedContent += '</div>';
        }
    }

    // 設定題型顏色
    const typeColors = {
        'reading': 'var(--primary-teal)',
        'essay': 'var(--primary-blue)',
        'practical': 'var(--primary-green)',
        '複述': '#D4909F',
        '分析': '#B496EB',
        '印證': '#722F3E',
        '闡明': '#EA928F',
        '意見': '#8B6455',
        '比較': '#3EE1C2',
        '選擇': '##55A193'  // 為選擇題添加特殊顏色
    };
    
    const typeColor = typeColors[type] || 'var(--primary-teal)';
    
    let cardHTML = `
        <div class="flex items-center justify-between mb-8">
            <div class="question-title" style="background: linear-gradient(135deg, ${typeColor} 0%, ${typeColor}80 100%);">
                <i class="fas fa-question-circle mr-4"></i>
                ${title}
            </div>
            <span class="px-6 py-3 rounded-full text-base font-bold text-white" style="background: linear-gradient(135deg, ${typeColor} 0%, ${typeColor}CC 100%);">${type}</span>
        </div>
    `;

    // 選擇題需要特殊的樣式
    if (type === '選擇') {
        cardHTML += `
            <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl p-8 mb-8 border-2 border-gray-100">
                <div class="text-gray-800 leading-relaxed text-lg font-medium">${formattedContent}</div>
            </div>
            <style>
                .choice-options-container {
                    margin-top: 20px;
                    padding: 20px;
                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                    border-radius: 15px;
                    border-left: 5px solid ${typeColor};
                }
                .choice-options-title {
                    font-weight: bold;
                    color: ${typeColor};
                    margin-bottom: 15px;
                    font-size: 18px;
                }
                .choice-option {
                    padding: 10px 15px;
                    margin: 8px 0;
                    background: white;
                    border-radius: 8px;
                    border-left: 3px solid #dee2e6;
                    font-weight: 500;
                    transition: all 0.3s ease;
                }
                .choice-option:hover {
                    border-left-color: ${typeColor};
                    transform: translateX(5px);
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
            </style>
        `;
    } else {
        cardHTML += `
            <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl p-8 mb-8 border-2 border-gray-100">
                <div class="text-gray-800 leading-relaxed whitespace-pre-wrap text-lg font-medium">${formattedContent}</div>
            </div>
        `;
    }

    if (answer) {
        cardHTML += `
            <div class="border-t-4 pt-8" style="border-color: var(--divider-color);">
                <button onclick="toggleAnswer(this)" class="flex items-center font-bold mb-6 transition-colors duration-300 text-xl hover:transform hover:scale-105" style="color: ${typeColor};">
                    <i class="fas fa-eye mr-4"></i>顯示詳細答案
                </button>
                <div class="answer-content hidden">
                    <div class="answer-section mb-6">
                        <h4 class="font-bold mb-6 flex items-center text-xl" style="color: var(--primary-green);">
                            <i class="fas fa-lightbulb mr-4"></i>參考答案
                        </h4>
                        <div class="leading-relaxed whitespace-pre-wrap text-gray-700 text-lg">${answer}</div>
                    </div>
        `;
        
        if (steps) {
            cardHTML += `
                    <div class="steps-section">
                        <h4 class="font-bold mb-6 flex items-center text-xl" style="color: #7fb3d5;">
                            <i class="fas fa-list-ol mr-4"></i>答題步驟
                        </h4>
                        <div class="leading-relaxed whitespace-pre-wrap text-gray-700 text-lg">${steps}</div>
                    </div>
            `;
        }
        
        cardHTML += `
                </div>
            </div>
        `;
    }

    card.innerHTML = cardHTML;
    return card;
}

       function showResult() {
    const selectedType = document.querySelector('input[name="generatorType"]:checked').value;
    
    // 隱藏主容器
    mainContainer.classList.add('hidden');
    
    // 如果是長文寫作或實用文體，隱藏配置面板
    if (selectedType === 'essay' || selectedType === 'practical') {
        document.getElementById('essayConfig').classList.add('hidden');
        document.getElementById('practicalConfig').classList.add('hidden');
    }
    
    resultContainer.classList.remove('hidden');
    
    // 添加動畫延遲
    const cards = document.querySelectorAll('.question-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.15}s`;
    });
}


     function toggleAnswer(button, typeColor) {
    const answerContent = button.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (answerContent.classList.contains('hidden')) {
        answerContent.classList.remove('hidden');
        button.innerHTML = '<i class="fas fa-eye-slash mr-4"></i>隱藏詳細答案';
        // 修訂處：移除顏色切換，保持 typeColor
        button.style.color = typeColor;
        answerContent.style.maxHeight = answerContent.scrollHeight + 'px';
    } else {
        answerContent.classList.add('hidden');
        button.innerHTML = '<i class="fas fa-eye mr-4"></i>顯示詳細答案';
        // 修訂處：移除顏色切換，保持 typeColor
        button.style.color = typeColor;
        answerContent.style.maxHeight = '0';
    }
}



        function goBack() {
    const selectedType = document.querySelector('input[name="generatorType"]:checked').value;
    
    resultContainer.classList.add('hidden');
    mainContainer.classList.remove('hidden');
    
    // 如果是長文寫作或實用文體，重新顯示配置面板
    if (selectedType === 'essay') {
        document.getElementById('essayConfig').classList.remove('hidden');
    } else if (selectedType === 'practical') {
        document.getElementById('practicalConfig').classList.remove('hidden');
    }
}

function resetStateOnSwitch(newType) {
    // 重置閱讀理解相關狀態
    if (newType !== 'reading') {
        // 清除範文選擇
        document.querySelectorAll('.text-item').forEach(item => {
            item.classList.remove('selected');
        });
        updateSelectedTexts([]);
        
        // 重置篇章內容
        const targetPassage = document.getElementById('targetPassage');
        if (targetPassage) {
            targetPassage.value = '';
        }
        
        // **重要修訂：強制隱藏閱讀理解專用的題型選擇區域**
        const dynamicQuestionTypes = document.getElementById('dynamicQuestionTypes');
        if (dynamicQuestionTypes) {
            dynamicQuestionTypes.style.display = 'none';
        }
        
        // 重置題型選擇容器
        const questionTypeContainer = document.getElementById('questionTypeContainer');
        if (questionTypeContainer) {
            questionTypeContainer.innerHTML = '';
        }
        
        // 隱藏自訂配置
        const customReadingConfig = document.getElementById('customReadingConfig');
        if (customReadingConfig) {
            customReadingConfig.classList.add('hidden');
        }
        
        // 重置獨立選擇狀態
        if (window.independentSelections) {
            window.independentSelections = {};
        }
    } else {
        // **重要修訂：切換回閱讀理解時重新顯示題型選擇區域**
        const dynamicQuestionTypes = document.getElementById('dynamicQuestionTypes');
        if (dynamicQuestionTypes) {
            dynamicQuestionTypes.style.display = 'block';
        }
    }
    
    // 重置長文寫作相關狀態
    if (newType !== 'essay') {
        selectedWritingTypes.clear();
        
        // 重置所有寫作題型開關
        document.querySelectorAll('#essayConfig .toggle-switch').forEach(toggle => {
            toggle.classList.remove('active');
        });
        
        // 隱藏所有數量控制
        document.querySelectorAll('#essayConfig .quantity-control').forEach(control => {
            control.style.display = 'none';
        });
        
        // 隱藏自訂配置
        const customEssayConfig = document.getElementById('customEssayConfig');
        if (customEssayConfig) {
            customEssayConfig.classList.add('hidden');
        }
    }
    
    // 重置實用文體相關狀態
    if (newType !== 'practical') {
        selectedPracticalTypes.clear();
        
        // 重置所有實用文體型開關
        document.querySelectorAll('#practicalConfig .toggle-switch').forEach(toggle => {
            toggle.classList.remove('active');
        });
        
        // 隱藏所有數量控制
        document.querySelectorAll('#practicalConfig .quantity-control').forEach(control => {
            control.style.display = 'none';
        });
        
        // 重置主題選擇
        const topicSelect = document.getElementById('topicSelect');
        if (topicSelect) {
            topicSelect.value = 'random';
        }
        
        // 隱藏自訂主題
        const customTopicGroup = document.getElementById('customTopicGroup');
        if (customTopicGroup) {
            customTopicGroup.classList.add('hidden');
        }
        
        // 隱藏自訂配置
        const customPracticalConfig = document.getElementById('customPracticalConfig');
        if (customPracticalConfig) {
            customPracticalConfig.classList.add('hidden');
        }
    }
}




        function regenerate() {
            handleGenerate();
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-8 right-8 p-8 rounded-2xl shadow-2xl z-50 fade-in text-white max-w-md';
            errorDiv.style.background = 'linear-gradient(135deg, var(--primary-rose) 0%, var(--secondary-rose) 100%)';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-4 text-2xl"></i>
                    <span class="text-lg font-semibold flex-1">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-6 text-white hover:text-gray-200 text-2xl transition-colors duration-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 6000);
        }


// 新增全域變數
var selectedWritingTypes = new Set();

// 長文寫作題型切換函數
function toggleWritingQuestionType(toggleElement, questionType) {
    const isActive = toggleElement.classList.contains('active');
    const quantityControl = toggleElement.closest('.question-type-selection').querySelector('.quantity-control');
    
    if (isActive) {
        // 取消選中
        toggleElement.classList.remove('active');
        selectedWritingTypes.delete(questionType);
        if (quantityControl) {
            quantityControl.style.display = 'none';
        }
        
        // 隱藏自訂配置
        if (questionType === '自訂') {
            document.getElementById('customEssayConfig').classList.add('hidden');
        }
    } else {
        // 選中
        toggleElement.classList.add('active');
        selectedWritingTypes.add(questionType);
        if (quantityControl) {
            quantityControl.style.display = 'flex';
        }
        
        // 顯示自訂配置
        if (questionType === '自訂') {
            document.getElementById('customEssayConfig').classList.remove('hidden');
        }
    }
}

// 長文寫作參考題目管理函數
function addEssayReference() {
    const list = document.getElementById('essayReferenceList');
    const currentCount = list.querySelectorAll('.essay-reference').length;
    const newRef = document.createElement('div');
    newRef.className = 'essay-reference fade-in';
    newRef.innerHTML = `
        <div class="flex items-start space-x-4 bg-white p-8 rounded-2xl border-3 border-blue-200">
            <span class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-full flex items-center justify-center font-bold text-lg question-number">${currentCount + 1}</span>
            <textarea class="flex-1 p-6 border-2 border-blue-200 rounded-xl focus:border-blue-400 focus:ring-0 transition-colors duration-300 resize-vertical" placeholder="在此輸入參考題目"></textarea>
        </div>
    `;
    list.appendChild(newRef);
    updateEssayReferenceNumbers();
}

function removeEssayReference() {
    const list = document.getElementById('essayReferenceList');
    const items = list.querySelectorAll('.essay-reference');
    if (items.length > 1) {
        items[items.length - 1].remove();
        updateEssayReferenceNumbers();
    }
}

function clearEssayReference() {
    const textareas = document.querySelectorAll('.essay-reference textarea');
    textareas.forEach(textarea => {
        textarea.value = '';
    });
}

function updateEssayReferenceNumbers() {
    const items = document.querySelectorAll('.essay-reference');
    items.forEach((item, index) => {
        const numberSpan = item.querySelector('span');
        numberSpan.textContent = index + 1;
    });
}




// 輔助函數：準備PDF輸出格式
function preparePDFLayout() {
    const questionsDisplay = document.getElementById('questionsDisplay');
    const cards = questionsDisplay.querySelectorAll('.question-card');
    
    cards.forEach((card, index) => {
        // 為每個卡片設置唯一標識
        card.setAttribute('data-pdf-page', index + 1);
        
        // 確保答案區域在PDF中可見
        const answerContent = card.querySelector('.answer-content');
        if (answerContent && answerContent.classList.contains('hidden')) {
            answerContent.classList.remove('hidden');
            answerContent.style.display = 'block';
            answerContent.style.maxHeight = 'none';
        }
        
        // 調整按鈕顯示
        const toggleButton = card.querySelector('button[onclick*="toggleAnswer"]');
        if (toggleButton) {
            toggleButton.style.display = 'none';
        }
    });
}

// 輔助函數：還原顯示格式
function restorePDFLayout() {
    const questionsDisplay = document.getElementById('questionsDisplay');
    const cards = questionsDisplay.querySelectorAll('.question-card');
    
    cards.forEach(card => {
        // 還原答案區域隱藏狀態
        const answerContent = card.querySelector('.answer-content');
        if (answerContent) {
            answerContent.classList.add('hidden');
            answerContent.style.maxHeight = '0';
        }
        
        // 還原按鈕顯示
        const toggleButton = card.querySelector('button[onclick*="toggleAnswer"]');
        if (toggleButton) {
            toggleButton.style.display = 'flex';
        }
    });
}


// LOCAL STORAGE 管理函數
function saveGeneratedQuestion(questionType, question) {
    const storageKey = 'generatedQuestions';
    let generatedQuestions = JSON.parse(localStorage.getItem(storageKey)) || {};
    
    if (!generatedQuestions[questionType]) {
        generatedQuestions[questionType] = [];
    }
    
    // 提取主題關鍵詞
    const keywords = extractKeywords(question);
    
    generatedQuestions[questionType].push({
        question: question,
        keywords: keywords,
        timestamp: new Date().getTime()
    });
    
    localStorage.setItem(storageKey, JSON.stringify(generatedQuestions));
}

function getGeneratedQuestions(questionType) {
    const storageKey = 'generatedQuestions';
    let generatedQuestions = JSON.parse(localStorage.getItem(storageKey)) || {};
    return generatedQuestions[questionType] || [];
}

function extractKeywords(question) {
    // 提取題目中的關鍵詞（主題詞）
    const keywordPatterns = [
        /「([^」]+)」/g,  // 引號內的詞
        /以「([^」]+)」為題/g,  // 以...為題
        /試以「([^」]+)」/g,   // 試以...
        /「([^」]+)」為首句/g,  // ...為首句
        /「([^」]+)」為末句/g   // ...為末句
    ];
    
    let keywords = [];
    keywordPatterns.forEach(pattern => {
        let match;
        while ((match = pattern.exec(question)) !== null) {
            keywords.push(match[1]);
        }
    });
    
    // 如果沒有找到引號內容，提取其他可能的主題詞
    if (keywords.length === 0) {
        const commonWords = ['以', '為題', '試', '寫作', '文章', '一篇', '根據', '描述'];
        const words = question.split(/[，。？！\s]+/);
        keywords = words.filter(word => 
            word.length >= 2 && 
            !commonWords.includes(word) &&
            !/^[0-9]+$/.test(word)
        ).slice(0, 3);
    }
    
    return keywords;
}

function clearGeneratedQuestions() {
    if (confirm('系統會自動記住已生成的題目，確保新題目主題不重複，確定要清除所有已生成的題目紀錄嗎？')) {
        localStorage.removeItem('generatedQuestions');
        alert('已清除所有題目記錄');
    }
}

function isTopicSimilar(newKeywords, existingKeywords) {
    // 檢查主題是否相似
    for (let newKeyword of newKeywords) {
        for (let existingKeyword of existingKeywords) {
            if (newKeyword === existingKeyword || 
                isSynonym(newKeyword, existingKeyword)) {
                return true;
            }
        }
    }
    return false;
}

function isSynonym(word1, word2) {
    // 定義近義詞組
    const synonymGroups = [
        ['沉默', '無聲', '寂靜', '安靜'],
        ['友誼', '友情', '朋友'],
        ['母愛', '母親', '媽媽'],
        ['夢想', '理想', '願望'],
        ['回憶', '記憶', '往事'],
        ['成長', '長大', '成熟'],
        ['堅持', '執著', '毅力'],
        ['勇氣', '勇敢', '膽量'],
        ['寬容', '包容', '體諒'],
        ['感恩', '感謝', '謝意']
    ];
    
    for (let group of synonymGroups) {
        if (group.includes(word1) && group.includes(word2)) {
            return true;
        }
    }
    return false;
}

function showQuestionHistory() {
    const storageKey = 'generatedQuestions';
    const generatedQuestions = JSON.parse(localStorage.getItem(storageKey)) || {};
    
    let historyHTML = '<div style="max-height: 400px; overflow-y: auto;">';
    let totalCount = 0;
    
    for (let [type, questions] of Object.entries(generatedQuestions)) {
        if (questions.length > 0) {
            historyHTML += `<h3 style="color: var(--primary-blue); margin: 15px 0 10px 0; font-weight: bold;">${type} (${questions.length}題)</h3>`;
            questions.forEach((q, index) => {
                const date = new Date(q.timestamp).toLocaleDateString();
                historyHTML += `
                    <div style="background: #f8f9fa; padding: 10px; margin: 8px 0; border-radius: 8px; border-left: 4px solid var(--primary-blue);">
                        <div style="font-weight: bold; margin-bottom: 5px;">第${index + 1}題 (${date})</div>
                        <div style="margin-bottom: 5px;">${q.question}</div>
                        <div style="font-size: 12px; color: #666;">關鍵詞：${q.keywords.join('、')}</div>
                    </div>
                `;
                totalCount++;
            });
        }
    }
    
    if (totalCount === 0) {
        historyHTML += '<p style="text-align: center; color: #666; margin: 20px;">尚無生成記錄</p>';
    }
    
    historyHTML += '</div>';
    
    // 創建模態框顯示記錄
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.7); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
    `;
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 80%; width: 600px; max-height: 80%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: var(--primary-blue);">
                    <i class="fas fa-history mr-3"></i>題目生成記錄 (共${totalCount}題)
                </h2>
                <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
            </div>
            ${historyHTML}
        </div>
    `;
    modal.className = 'modal';
    document.body.appendChild(modal);
}



    </script>

   <!-- Copyright Footer -->
   <footer class="copyright-footer">
        <p>Copyright © 2025 陳冠健. All rights reserved.</p>
    </footer>

	<!-- === 通用編輯懸浮視窗 (包含OCR功能) === -->
<div id="outline-editor-modal" class="outline-modal-overlay">
    <div class="outline-modal-content">
        <h3 id="modal-title">編輯內容</h3>
        <textarea id="modal-textarea" rows="15"></textarea>
        <div class="modal-buttons">
            <!-- OCR 按鈕 -->
            <button id="modal-ocr-btn" class="btn-action" style="background-color: #17a2b8;">OCR</button>
            
            <!-- 輸入/儲存按鈕 -->
            <button id="modal-save-btn" class="btn-action">輸入</button>
        </div>
        <button id="modal-close-btn" class="preview-close-btn" title="關閉">&times;</button>
    </div>
</div>

<script>
// =======================================================
// === 通用懸浮視窗編輯器與 OCR 整合邏輯 ===
// =======================================================
document.addEventListener('DOMContentLoaded', function() {

    // --- 懸浮視窗核心邏輯 ---
    const modal = document.getElementById('outline-editor-modal');
    const modalTextarea = document.getElementById('modal-textarea');
    const modalTitle = document.getElementById('modal-title');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const modalCloseBtn = document.getElementById('modal-close-btn');

    if (!modal || !modalTextarea || !modalSaveBtn || !modalCloseBtn) {
        console.error("懸浮視窗的 HTML 結構不完整或未找到！");
        return;
    }

    let currentEditingElement = null;

    function openModalEditor(element) {
        currentEditingElement = element;
        modalTextarea.value = currentEditingElement.value;

        // 嘗試尋找與輸入框關聯的 <label> 來設定標題
        let titleText = '編輯內容'; // 預設標題
        let associatedLabel = null;
        if (element.id) {
            associatedLabel = document.querySelector(`label[for="${element.id}"]`);
        }
        if (associatedLabel) {
            titleText = `編輯「${associatedLabel.textContent.trim().replace(/[:：]/g, '')}」`;
        }
        modalTitle.textContent = titleText;
        
        modal.style.display = 'flex';
        modalTextarea.focus();
    }

    function closeModalEditor() {
        modal.style.display = 'none';
        currentEditingElement = null;
    }

    function saveAndCloseEditor() {
        if (currentEditingElement) {
            currentEditingElement.value = modalTextarea.value;
            // 如果有字數統計等功能，可以在此處觸發更新
            // if (typeof updateCharCount === 'function') {
            //     updateCharCount();
            // }
        }
        closeModalEditor();
    }

    // 主事件監聽器：監聽頁面上所有符合條件的輸入框點擊
    document.body.addEventListener('click', function(event) {
        const target = event.target;
        
        const isTextInput = target.tagName === 'INPUT' && target.type === 'text';
        const isTextarea = target.tagName === 'TEXTAREA';

        // 條件：必須是文字輸入框或文本區域，且不能有 'no-modal-editor' class，也不能是懸浮視窗自己的輸入框
        if ((isTextInput || isTextarea) && !target.classList.contains('no-modal-editor') && target.id !== 'modal-textarea') {
            event.preventDefault(); // 阻止預設的點擊行為
            openModalEditor(target);
        }
    });

    // 為懸浮視窗的按鈕和外部區域綁定事件
    modalSaveBtn.addEventListener('click', saveAndCloseEditor);
    modalCloseBtn.addEventListener('click', closeModalEditor);
    modal.addEventListener('click', function(event) {
        if (event.target === modal) { // 如果點擊的是半透明的背景
            closeModalEditor();
        }
    });

    // --- OCR 整合邏輯 ---
    const ocrBtn = document.getElementById('modal-ocr-btn');
    let ocrWindow = null;
    const VERCEL_OCR_URL = 'https://gemini-ocr-proxy.vercel.app/'; // 您的 OCR 工具網址

    if (ocrBtn) {
        ocrBtn.addEventListener('click', function() {
            if (ocrWindow && !ocrWindow.closed) {
                ocrWindow.focus();
                return;
            }
            ocrWindow = window.open(VERCEL_OCR_URL, 'OCRWindow', 'width=650,height=850,scrollbars=yes,resizable=yes');
        });
    }

    // 監聽來自 OCR 子視窗的訊息
    window.addEventListener('message', function(event) {
        // 安全性檢查：確保訊息來自於您信任的 OCR 工具來源
        if (event.origin !== new URL(VERCEL_OCR_URL).origin) {
            console.warn('收到來源不明的訊息，已忽略:', event.origin);
            return;
        }

        // 檢查訊息格式是否正確
        if (event.data && event.data.type === 'ocrResult') {
            const ocrText = event.data.text;
            
            // 將辨識結果附加到懸浮視窗的輸入框中
            modalTextarea.value += (modalTextarea.value.trim() ? '\\n' : '') + ocrText;
            
            if (ocrWindow) {
                ocrWindow.close(); // 自動關閉 OCR 子視窗
            }
            
            modalTextarea.focus(); // 將焦點移回輸入框
        }
    });
});
</script>


<!-- === 1. Firebase SDK 引入 === -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<!-- === 2. Firebase 初始化與配置 (這裡修復了您漏掉的啟動碼) === -->
<!-- ======================================================= -->
<!-- === [最終版] Firebase 初始化、持久化與狀態同步 === -->
<!-- ======================================================= -->
<script>
    // 1. 定義 Firebase 設定
    const firebaseConfig = {
        apiKey: "AIzaSyBgwrgn2m343mRJb0WjzUhteiospegXhvI",
        authDomain: "sansidata.firebaseapp.com",
        projectId: "sansidata",
        storageBucket: "sansidata.firebasestorage.app",
        messagingSenderId: "580288358575",
        appId: "1:580288358575:web:35dcf4e79bcef530de4c5a",
        databaseURL: "https://sansidata-default-rtdb.firebaseio.com"
    };

    // 2. 初始化 Firebase (確保只執行一次)
    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    // 3. 定義全域變數 (讓所有功能都能存取)
    var database = firebase.database();
    var auth = firebase.auth();

    // 4. 啟動監聽與同步邏輯
    document.addEventListener('DOMContentLoaded', function() {
        if (auth) {
            // ★ 關鍵：設定 LOCAL 持久化，這能讓神思的登入狀態「傳染」給題孳
            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                // 監聽狀態改變
                auth.onAuthStateChanged(async (user) => {
                    const s = JSON.parse(localStorage.getItem('studentProfile'));

                    if (user) {
                        // === A. 已登入 ===
                        console.log("[TiZi] 🟢 偵測到有效登入:", user.email);

                        // 情況：有登入但本地沒資料 (例如剛從神思過來)
                        if (!s) {
                            console.log("[TiZi] 正在同步雲端身份...");
                            try {
                                const emailKey = btoa(user.email);
                                const snapshot = await database.ref('email_mapping/' + emailKey).once('value');
                                const profile = snapshot.val();

                                if (profile) {
                                    localStorage.setItem('studentProfile', JSON.stringify(profile));
                                    console.log("[TiZi] ✅ 身份同步成功:", profile.name);
                                    
                                    // 刷新頁面以套用身份 (可選)
                                    // window.location.reload();
                                }
                            } catch (e) {
                                console.error("[TiZi] 同步失敗:", e);
                            }
                        } else {
                            console.log("[TiZi] ✅ 身份驗證無誤:", s.name);
                        }
                    } else {
                        // === B. 未登入 (訪客或過期) ===
                        console.log("[TiZi] ⚪ 未偵測到登入");

                        if (s) {
                            // ★ 幽靈檔案清洗：本地有資料但 Auth 沒登入 -> 清除！
                            console.warn("[TiZi] ⚠️ 發現失效的身份資料，執行安全清除...");
                            localStorage.removeItem('studentProfile');
                            // 這裡不彈窗，以免嚇到用戶，靜默轉為訪客即可
                        }
                    }
                });
            })
            .catch((error) => {
                console.error("[TiZi] 持久化設定失敗:", error);
            });
        }
    });



// =======================================================
// === [核心修復] 全域請求攔截器 (Auto Token Injector) ===
// =======================================================
(function() {
    const originalFetch = window.fetch;
    const TARGET_URL_PART = "script.google.com"; // 攔截所有發往 GAS 的請求

    window.fetch = async function(url, options) {
        // 1. 檢查是否為發往後端的 POST 請求
        if (typeof url === 'string' && url.includes(TARGET_URL_PART) && options && options.method === 'POST') {
            
            console.log("[Interceptor] 偵測到後端請求，準備注入 Token...");

            // 2. 等待並獲取最新的 Firebase User (解決初始化時間差)
            const user = await new Promise((resolve) => {
                // 如果 currentUser 已存在，直接返回
                if (firebase.auth().currentUser) {
                    resolve(firebase.auth().currentUser);
                } else {
                    // 否則等待狀態變化 (最多等 2 秒)
                    const unsubscribe = firebase.auth().onAuthStateChanged(u => {
                        unsubscribe();
                        resolve(u);
                    });
                    // 超時機制：如果 2 秒沒反應，假設未登入
                    setTimeout(() => resolve(null), 2000);
                }
            });

            if (user) {
                try {
                    // 3. 強制刷新並獲取 Token
                    const token = await user.getIdToken(true);
                    
                    // 4. 解析原本的 Body 並注入 Token
                    let bodyData = JSON.parse(options.body);
                    bodyData.token = token; // ★ 強制注入
                    
                    // 5. 更新 Body
                    options.body = JSON.stringify(bodyData);
                    console.log("[Interceptor] Token 注入成功！");
                } catch (e) {
                    console.error("[Interceptor] Token 獲取失敗:", e);
                    // 這裡不阻擋請求，讓後端去報錯，或者你可以選擇在這裡 alert
                }
            } else {
                console.warn("[Interceptor] 用戶未登入，無法注入 Token");
                // 這裡可以選擇直接 return Promise.reject("未登入") 來阻止請求發送
            }
        }
        
        // 6. 執行原始請求
        return originalFetch(url, options);
    };
})();





	
</script>


<script>
// ===============================================================
// === [神思通用組件] 嚴格權限鎖 (精準生成觸發版) ===
// ===============================================================
(function() {
    // 防止重複注入
    if (window.SansiInterceptorLoaded) return;
    window.SansiInterceptorLoaded = true;

    // --- 1. 自動注入莫蘭迪 CSS (保持不變) ---
    const style = document.createElement('style');
    style.textContent = `
        /* 莫蘭迪遮罩 */
        .sansi-limit-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(253, 252, 248, 0.95);
            backdrop-filter: blur(8px);
            z-index: 9999999;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .sansi-limit-show { opacity: 1; }
        .sansi-limit-card {
            background: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 16px;
            padding: 35px 25px; width: 90%; max-width: 380px;
            box-shadow: 0 15px 40px rgba(141, 110, 99, 0.2);
            text-align: center; transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            font-family: 'Noto Serif TC', serif;
        }
        .sansi-limit-show .sansi-limit-card { transform: translateY(0); }
        .sansi-limit-icon { font-size: 3.5rem; color: #d69a92; margin-bottom: 20px; }
        .sansi-limit-title { color: #5d4037; font-size: 1.5rem; font-weight: bold; margin: 0 0 15px 0; }
        .sansi-limit-desc { color: #666; font-size: 1.1rem; line-height: 1.6; margin-bottom: 30px; }
        .sansi-btn-group { display: flex; gap: 12px; margin-top: 10px; }
        .sansi-limit-btn {
            border: none; padding: 12px 0; border-radius: 50px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            transition: all 0.2s; font-family: 'Noto Serif TC', serif;
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
            text-decoration: none;
        }
        .btn-primary { background: #8fa398; color: white; box-shadow: 0 4px 12px rgba(143, 163, 152, 0.4); }
        .btn-primary:hover { background-color: #7d9186; transform: translateY(-2px); }
        .btn-secondary { background: #f0f0f0; color: #777; }
        .btn-secondary:hover { background-color: #e5e5e5; }
    `;
    document.head.appendChild(style);

    // --- 2. 自動注入 HTML (保持不變) ---
    const modalHTML = `
        <div id="sansiLimitModal" class="sansi-limit-overlay">
            <div class="sansi-limit-card">
                <div class="sansi-limit-icon"><i class="fas fa-lock"></i></div>
                <div class="sansi-limit-title">會員限定功能</div>
                <div class="sansi-limit-desc">此功能僅開放給神思登入用戶。<br>請先登入學校帳號以繼續使用。</div>
                <div class="sansi-btn-group">
                    <button class="sansi-limit-btn btn-secondary" onclick="closeSansiLimitModal()">取消</button>
                    <button class="sansi-limit-btn btn-primary" onclick="window.location.href='../index2.html'"><i class="fas fa-sign-in-alt"></i> 前往登入</button>
                </div>
            </div>
        </div>
    `;
    const div = document.createElement('div');
    div.innerHTML = modalHTML;
    document.body.appendChild(div);

    window.closeSansiLimitModal = function() {
        const modal = document.getElementById('sansiLimitModal');
        if (modal) {
            modal.classList.remove('sansi-limit-show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
            if (typeof hideProgress === 'function') hideProgress(); 
            const disabledBtns = document.querySelectorAll('button:disabled');
            disabledBtns.forEach(btn => btn.disabled = false);
        }
    };

    // --- 3. 攔截器核心邏輯 (正面列表檢測) ---
    const originalFetch = window.fetch;
    
    window.fetch = async function(url, options) {
        // 只監控發往 AI 或 後端的請求
        if (typeof url === 'string' && (url.includes('pollinations.ai') || url.includes('script.google.com'))) {
            
            // 判斷這是否是一個「生成請求」
            // 我們檢查請求內容是否包含這三個關鍵動作指令
            let isGenerationRequest = false;
            if (options && options.body) {
                const bodyStr = String(options.body);
                if (bodyStr.includes('generate_reading') || 
                    bodyStr.includes('generate_essay') || 
                    bodyStr.includes('generate_practical')) {
                    isGenerationRequest = true;
                }
            }

            // 檢查登入狀態
            const s = localStorage.getItem('studentProfile');
            
            // ★★★ 核心邏輯修改 ★★★
            // 只有當：(1) 是生成請求 AND (2) 未登入 時，才彈出視窗
            if (isGenerationRequest && !s) {
                console.warn("🚫 [Sansi Security] 未登入嘗試生成，觸發攔截。");
                
                const modal = document.getElementById('sansiLimitModal');
                if (modal) {
                    modal.style.display = 'flex';
                    void modal.offsetWidth; 
                    modal.classList.add('sansi-limit-show');
                }

                if (typeof hideProgress === 'function') hideProgress();
                return Promise.reject(new Error("Login Required"));
            }
            
            // 其他請求（例如 get_library_data）即使沒登入也會放行
            // 它們會因為後端驗證失敗而默默失敗，但不會觸發視窗，也不會報錯（因為我們在 fetchTextLibrary 裡處理了 catch）
        }
        return originalFetch(url, options);
    };
    
    console.log("🔒 神思智能權限鎖 (僅攔截生成動作) 已啟動");
})();

</script>




	
<script>



// ★★★★★ 請將代碼貼在這裡 (原本的內容之下，script 結束標籤之上) ★★★★★

   // =======================================================
    // === [新增] 在線狀態自動報到系統 (Presence System) ===
    // =======================================================
    function initPresenceSystem() {
        // 延遲執行，確保 Firebase 已初始化且本地存儲已讀取
        setTimeout(() => {
            if (typeof database === 'undefined') return;

            // 1. 監聽連線狀態
            const connectedRef = database.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    // === 連線成功，準備資料 ===
                    
                    // 獲取用戶資料
                    const s = JSON.parse(localStorage.getItem('studentProfile'));
                    let myUid = "";
                    let userData = {};

                    // A. 判斷身分
                    if (s && s.name) {
                        // --- 已登入用戶 (學生/老師/特許) ---
                        const user = firebase.auth().currentUser;
                        myUid = user ? user.uid : `stu_${s.grade}${s.class}_${s.name}`;
                        
                        // 準備寫入的資料
                        userData = {
                            name: s.name,
                            grade: s.grade,
                            class: s.class,
                            current_tool: "題孳", // ★★★ [修訂] 標記來源為題孳 ★★★
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            device: /Mobile|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
                        };
                    } else {
                        // --- 訪客 ---
                        let guestId = localStorage.getItem('sansi_guest_uuid');
                        if (!guestId) {
                            guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
                            localStorage.setItem('sansi_guest_uuid', guestId);
                        }
                        myUid = guestId;

                        userData = {
                            name: "訪客",
                            grade: "Guest",
                            class: "Visitor",
                            current_tool: "題孳", // ★★★ [修訂] 標記來源為題孳 ★★★
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            device: /Mobile|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
                        };
                    }

                    // B. 執行 Firebase 動作
                    const myPresenceRef = database.ref(`online_users/${myUid}`);

                    // 關鍵指令：當客戶端斷線時，自動刪除這筆資料
                    myPresenceRef.onDisconnect().remove().then(() => {
                        // 斷線指令設定成功後，寫入當前狀態
                        myPresenceRef.set(userData);
                    }).catch(err => {
                        // 防止權限不足時報錯
                        console.warn("[Presence] Update failed:", err);
                    });
                }
            });
        }, 2000); // 延遲 2 秒啟動
    }

    // 啟動報到系統
    document.addEventListener('DOMContentLoaded', initPresenceSystem);



	
</script>



<!-- ======================================================= -->
<!-- === [修復 V2] 統一登入與狀態同步邏輯 (處理憑證過期) === -->
<!-- ======================================================= -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. 確保 Firebase Auth 已啟動
    if (typeof firebase !== 'undefined' && firebase.auth) {
        
        // 設定持久化 (確保刷新頁面後登入狀態不見)
        firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(() => {
            // 2. 監聽登入狀態改變
            firebase.auth().onAuthStateChanged(async (user) => {
                // 讀取本地身份
                const s = JSON.parse(localStorage.getItem('studentProfile'));

                if (user) {
                    // === 情況 A: Firebase 已登入 (正常) ===
                    console.log("[TiZi] 偵測到 Firebase 登入:", user.email);

                    // 如果已登入但本地沒資料 (罕見)，嘗試從雲端抓回
                    if (!s) {
                        console.log("[TiZi] 本地身份遺失，正在從雲端恢復...");
                        try {
                            const emailKey = btoa(user.email);
                            const snapshot = await firebase.database().ref('email_mapping/' + emailKey).once('value');
                            const profile = snapshot.val();

                            if (profile) {
                                localStorage.setItem('studentProfile', JSON.stringify(profile));
                                console.log("[TiZi] 身份已恢復:", profile.name);
                                
                                // 隱藏限制視窗
                                const limitModal = document.getElementById('sansiLimitModal');
                                if (limitModal) {
                                    limitModal.classList.remove('sansi-limit-show');
                                    limitModal.style.display = 'none';
                                }
                            }
                        } catch (e) {
                            console.error("[TiZi] 恢復身份失敗:", e);
                        }
                    } else {
                        console.log("[TiZi] 身份驗證通過 (本地+雲端):", s.name);
                    }
                } else {
                    // === 情況 B: Firebase 未登入 (訪客或憑證過期) ===
                    console.log("[TiZi] 未偵測到 Firebase 登入狀態");

                    if (s) {
                        // ★★★ 關鍵修復：幽靈檔案處理 ★★★
                        // 本地有資料 (s)，但 Firebase 沒登入 (!user)
                        // 代表憑證已過期或被強制登出，必須清除本地資料，否則會導致 API 權限錯誤
                        console.warn("[TiZi] ⚠️ 發現殘留身份資料但無有效憑證，視為已登出。");
                        
                        // 1. 清除殘留
                        localStorage.removeItem('studentProfile');
                        
                        // 2. 重置為訪客狀態
                        console.log("[TiZi] 已自動清理舊資料並切換為訪客模式");
                    } else {
                        console.log("[TiZi] 目前為訪客模式");
                    }
                }
            });
        });
    }
});

// =======================================================
// === [修復] 統一攔截器 (覆蓋舊有的限制邏輯) ===
// =======================================================
(function() {
    // 防止重複宣告 fetch
    if (window._sansiFetchOverridden) return;
    window._sansiFetchOverridden = true;

    const originalFetch = window.fetch;

    window.fetch = async function(url, options) {
        // 只攔截 AI 相關請求
        if (typeof url === 'string' && (url.includes('pollinations.ai') || url.includes('script.google.com'))) {
            
            // 1. 檢查是否已登入 (優先檢查 LocalStorage)
            const s = localStorage.getItem('studentProfile');
            
            if (s) {
                // 已登入：直接放行，不扣額度
                return originalFetch(url, options);
            }

            // 2. 未登入：執行訪客額度檢查
            const today = new Date().toLocaleDateString('zh-HK');
            const toolName = "TiZi"; 
            const storageKey = `sansi_guest_usage_${toolName}_${today}`;
            let currentCount = parseInt(localStorage.getItem(storageKey) || "0");

            // 3. 額度用盡 (限制 1 次)
            if (currentCount >= 1) {
                // 呼叫顯示彈窗 (如果有的話)
                const modal = document.getElementById('sansiLimitModal');
                if (modal) {
                    modal.style.display = 'flex';
                    // 強制重繪
                    void modal.offsetWidth; 
                    modal.classList.add('sansi-limit-show');
                } else {
                    alert("訪客每日體驗額度已耗盡。\n請前往「神思」主頁登入。");
                }
                
                // 隱藏 Loading 動畫
                if (typeof hideProgress === 'function') hideProgress();
                
                return Promise.reject(new Error("Guest Limit Exceeded"));
            }

            // 4. 訪客扣除額度並放行
            localStorage.setItem(storageKey, currentCount + 1);
            console.log(`[訪客] ${toolName} 使用第 ${currentCount + 1} 次`);
        }

        return originalFetch(url, options);
    };
    console.log("✅ [TiZi] 統一登入攔截器已啟動");
})();
</script>


<!-- === [還原版] 神思大數據收集模組 (30秒=1分鐘邏輯) === -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let totalSeconds = 0;
    let timerInterval = null;

    // 1. 獲取日期路徑
    function getDateParts() {
        const now = new Date();
        const y = String(now.getFullYear());
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return { y, m, d };
    }

    // 2. 獲取身份
    function getIdentity() {
        const rawProfile = localStorage.getItem('studentProfile');
        let s = null;
        try { if(rawProfile) s = JSON.parse(rawProfile); } catch (e) {}

        if (s && s.grade && s.class) {
            const safeName = s.name.replace(/[.#$/[\]]/g, '_'); 
            return { type: 'student', id: s.uid || `stu_${s.grade}${s.class}_${safeName}`, grade: s.grade, class: s.class };
        } else {
            let guestID = localStorage.getItem('sansi_guest_uuid');
            if (!guestID) {
                guestID = 'guest_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('sansi_guest_uuid', guestID);
            }
            return { type: 'guest', id: guestID, grade: 'Guest', class: 'Visitor' };
        }
    }

// === 3. 記錄訪問 (Log Visit) - 高效分流版 ===
// === 3. 記錄訪問 (Log Visit) - 高效分流版 (含 stats_school 邏輯) ===
async function logVisitOnce() {
    if (typeof firebase === 'undefined' || !database) return;
    
    const { y, m, d } = getDateParts();
    const identity = getIdentity();
    const uid = identity.id;

    // Session 鎖
    const sessionKey = `sansi_visit_logged_${y}${m}${d}_${uid}`;
    if (sessionStorage.getItem(sessionKey)) return; 

    // 檢查 Tracking (判斷是否為今日首次)
    const trackingRef = database.ref(`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`);
    
    try {
        const snap = await trackingRef.once('value');
        const isFirstTimeToday = !snap.exists();

        const updates = {};
        const increment1 = firebase.database.ServerValue.increment(1);
        
        // 1. 全校總覽路徑 (含訪客) - stats_global
        const globalPath = `stats_global/${y}/${m}/${d}`;
        updates[`${globalPath}/visits`] = increment1;

        // ★★★ 新增：純學校路徑 (僅學生) - stats_school ★★★
        const schoolPath = `stats_school/${y}/${m}/${d}`;

        if (identity.type === 'student') {
            const classKey = `${identity.grade}${identity.class}`;
            const studentKey = identity.id.split('_').pop(); // 名字

            // 學生同時寫入 stats_school
            updates[`${schoolPath}/visits`] = increment1;

            // 2. 班級路徑 (stats_classes/6A/YYYY/MM/DD)
            const classPath = `stats_classes/${classKey}/${y}/${m}/${d}`;
            updates[`${classPath}/visits`] = increment1;

            // 3. 學生路徑 (stats_students/6A/陳大文/YYYY/MM/DD)
            const studentPath = `stats_students/${classKey}/${studentKey}/${y}/${m}/${d}`;
            updates[`${studentPath}/visits`] = increment1;

            if (isFirstTimeToday) {
                updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                
                // 更新 global unique
                updates[`${globalPath}/unique`] = increment1;
                
                // ★ 更新 school unique (僅學生)
                updates[`${schoolPath}/unique`] = increment1;
                
                // 更新 class unique
                updates[`${classPath}/unique`] = increment1;
            }
        } else {
            // 訪客 (只寫入 global，不寫入 school)
            if (isFirstTimeToday) {
                updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                updates[`${globalPath}/unique`] = increment1;
            }
        }

        await database.ref().update(updates);
        sessionStorage.setItem(sessionKey, 'true');
        console.log("📍 [Stats] 訪問計數已分流上傳 (含 stats_school)");

    } catch (e) {
        console.error("Stats Error:", e);
    }
}

// 4. 上傳 1 分鐘 (分流版 - 除錯模式)
function uploadOneMinute() {
    if (typeof firebase === 'undefined' || !database) return;
    
    logVisitOnce(); 

    const { y, m, d } = getDateParts();
    const identity = getIdentity();
    
    // 獲取學生名稱 Key (防呆)
    const studentKey = identity.id.includes('_') ? identity.id.split('_').pop() : identity.name; 
    
    const updates = {};
    const increment60 = firebase.database.ServerValue.increment(60);

    // 1. 全域 (Global)
    updates[`stats_global/${y}/${m}/${d}/duration`] = increment60;

    // ★★★ 2. 學生身份判斷 ★★★
    if (identity.type === 'student') {
        const classKey = `${identity.grade}${identity.class}`;

        // Path A: 全校 (這是您缺少的)
        const pathSchool = `stats_school/${y}/${m}/${d}/duration`;
        updates[pathSchool] = increment60;

        // Path B: 班級
        const pathClass = `stats_classes/${classKey}/${y}/${m}/${d}/duration`;
        updates[pathClass] = increment60;
        
        // Path C: 個人
        const pathStudent = `stats_students/${classKey}/${studentKey}/${y}/${m}/${d}/duration`;
        updates[pathStudent] = increment60;

        // ★ 除錯訊息：請在 F12 Console 查看是否出現此行 ★
        console.log(`[Stats] 正在上傳時長... 目標包含: ${pathSchool}`);
    } else {
        console.log("[Stats] 當前為訪客身份，不寫入 stats_school");
    }

    database.ref().update(updates)
        .then(() => console.log("✅ [Stats] 時長上傳成功"))
        .catch(e => console.error("❌ [Stats] 上傳失敗 (請檢查 Rules):", e));
}

    // 5. 計時器啟動 (還原你的邏輯)
    function startTimer() {
        if (timerInterval) return;
        console.log("▶️ [Stats] 計時器啟動");
        
        timerInterval = setInterval(() => {
            totalSeconds++;
            
            // ★★★ 你的原始邏輯 ★★★
            // 30秒 -> 傳送 (算1分鐘)
            // 90秒 (1分30秒) -> 傳送 (算2分鐘)
            // 150秒 (2分30秒) -> 傳送 (算3分鐘)
            if (totalSeconds === 30 || (totalSeconds > 30 && (totalSeconds - 30) % 60 === 0)) {
                uploadOneMinute();
            }
        }, 1000);
    }

    function pauseTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            console.log("⏸️ [Stats] 暫停計時 (當前累計: " + totalSeconds + "s)");
            // 注意：這裡不再有 uploadDuration(unsaved)，未滿的部分直接捨棄
        }
    }

    // 延遲啟動
    setTimeout(() => {
        logVisitOnce();
        startTimer();
    }, 3000);

    // 偵測頁面狀態
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') pauseTimer();
        else startTimer();
    });
    
    window.forceLogVisit = logVisitOnce;
});
</script>




	
	
	
</body>
</html>
