<!DOCTYPE html>
<html>
    
<head>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>èªå¼ˆéŒ„</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>  

        .topic-btn {
    white-space: normal; /* å…è¨±æ–‡å­—æ›è¡Œ */
    word-wrap: break-word; /* é•·è©è‡ªå‹•æ›è¡Œ */
    height: auto; /* æŒ‰éˆ•é«˜åº¦è‡ªé©æ‡‰ */
    padding: 1rem; /* å¢åŠ å…§é‚Šè· */
}

.difficulty-icon {
    width: 140px;
    height: 140px;
    object-fit: cover;
    border-radius: 50%;
    border: 2px solid var(--gold);
    margin-bottom: 1rem;
}
        
.difficulty-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    max-width: 83%;
    margin: 0 auto;
}

.difficulty-card {
    background: rgba(45, 41, 38, 0.95);
    border: 2px solid var(--gold);
    border-radius: 10px;
    padding: 1rem;
    cursor: pointer;
    transition: transform 0.3s;
    text-align: center;
}

.difficulty-card:hover {
    transform: scale(1.05);
    border-color: #fff;
}

.difficulty-card.selected {
    border-color: #2ecc71 !important;
    box-shadow: 0 0 15px rgba(46,204,113,0.5);
}

        
#topicSelection {
    z-index: 10001; /* ç¢ºä¿é«˜æ–¼ç­‰å¾…é é¢ */
}
        .difficulty-btn {
    width: 100%;
    aspect-ratio: 1 / 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.single-player-btn {
    /* å•¡è‰²æ¸å˜ï¼Œè¿™é‡Œä½¿ç”¨äº† #A52A2A å’Œ #D2691E ä¸¤ç§å¸¸è§çš„å•¡è‰² */
    background: linear-gradient(45deg, #48d1cc, #20b2aa);
    /* è°ƒæ•´é˜´å½±é¢œè‰²ä»¥åŒ¹é…æ–°çš„èƒŒæ™¯è‰² */
    box-shadow: 0 5px 15px rgba(165, 42, 42, 0.4); 
    background: linear-gradient(45deg, #48d1cc, #20b2aa); 
    transition: background 0.3s ease; /* è¿‡æ¸¡æ•ˆæœï¼Œä½¿æ¸å˜æ›´å¹³æ»‘ */
}
        
.random-match-btn {
    background: linear-gradient(45deg, #f1c40f, #f1c40f); /* é»„è‰²æ¸å˜ */
    box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4); /* é˜´å½±æ•ˆæœ */
    background: linear-gradient(45deg, #f1c40f, #f1c40f); 
    transition: background 0.3s ease; /* è¿‡æ¸¡æ•ˆæœï¼Œä½¿æ¸å˜æ›´å¹³æ»‘ */
}

        .create-btn {
    background: linear-gradient(45deg, #c0392b, #e74c3c); /* åŸæœ‰çš„æ¸å˜æ•ˆæœ */
    box-shadow: 0 5px 15px rgba(199, 46, 46, 0.4); /* åŸæœ‰çš„é˜´å½±æ•ˆæœ */
    /* ä»¥ä¸‹æ˜¯æ–°å¢çš„æ¸å˜æ•ˆæœï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ */
    background: linear-gradient(45deg, #c0392b, #e74c3c); 
    transition: background 0.3s ease; /* è¿‡æ¸¡æ•ˆæœï¼Œä½¿æ¸å˜æ›´å¹³æ»‘ */
}


.rematch-buttons {
    margin-top: 30px;
    display: flex;
    gap: 20px;
    position: absolute; /* æ–°å¢å®šä½ */
    bottom: 30px;      /* å›ºå®šåœ¨åº•éƒ¨ */
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;     /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}

.rematch-buttons button {
    width: 150px;
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
    background: linear-gradient(45deg, #4CAF50, #45a049);
    border: 2px solid #2d662f;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.rematch-buttons button:last-child {
    background: linear-gradient(45deg, #f44336, #d32f2f);
    border-color: #b71c1c;
}

.rematch-buttons button:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
}

/* å¼¹å‡ºå›¾ç‰‡çš„åŠ¨ç”»å…³é”®å¸§ */
@keyframes popImage {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}

/* å¼¹å‡ºå›¾ç‰‡çš„æ ·å¼ç±» */
.popup-image {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 99999;
    animation: popImage 0.3s ease-out;
    display: none; /* åˆå§‹ç‹€æ…‹éš±è— */
}

.popup-image img {
    max-width: 80vw; /* é™åˆ¶å¯¬åº¦ç‚ºè¢å¹•å¯¬åº¦çš„80% */
    max-height: 80vh; /* é™åˆ¶é«˜åº¦ç‚ºè¢å¹•é«˜åº¦çš„80% */
}
        
        
@keyframes damageFloat {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-50px); opacity: 0; }
}

    /* è¡€æ¢è¡æ“Šæ³¢ç‰¹æ•ˆ */
    @keyframes healthWave {
        0% { transform: scaleX(1); opacity: 1; }
        100% { transform: scaleX(1.2); opacity: 0; }
    }

    .health-wave {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
        animation: healthWave 0.5s ease-out;
        transparent 0%, 
        rgba(255,255,255,0.4) 50%,  /* æé«˜äº®åº¦ */
        transparent 100%
    );
    filter: blur(2px); /* æ·»åŠ æ¨¡ç³Šæ•ˆæœ */
}

        /* ä¼˜åŒ–åŸæœ‰è¡€æ¡åŠ¨ç”» */
.health-fill {
    transition: width 0.5s ease, background-color 0.3s ease;
}
    }

    /* ç­”é¡Œå‘½ä¸­ç‰¹æ•ˆ */
    @keyframes hitMarker {
        0% { transform: scale(0); opacity: 0; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(1); opacity: 0; }
    }

    .hit-marker {
        position: absolute;
        color: #ff0000;
        font-size: 3rem;
        animation: hitMarker 0.3s ease-out;
        text-shadow: 0 0 10px rgba(255,0,0,0.5);
    }

        
        /* æ–°å¢å‹•ç•«æ•ˆæœ */
@keyframes damageFlash {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.5); }
    100% { filter: brightness(1); }
}

.damage-flash {
    animation: 
        damageFlash 0.3s ease-in-out,
        damageShake 0.3s ease-in-out; /* æ–°å¢æ­¤è¡Œ */
}

        /* æ–°å¢è‡³CSSå‹•ç•«å€å¡Š */
@keyframes damageShake {
    0% { transform: translateX(0); }
    25% { transform: translateX(3px); }
    75% { transform: translateX(-3px); }
    100% { transform: translateX(0); }
}
        
        /* æ–°å¢åŠ¨ç”»æ•ˆæœ */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes optionPop {
        0% { transform: scale(0); opacity: 0; }
        80% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
    }

    @keyframes pulseGlow {
        0% { box-shadow: 0 0 10px var(--gold); }
        50% { box-shadow: 0 0 20px var(--gold); }
        100% { box-shadow: 0 0 10px var(--gold); }
    }

        /* æ–°å¢é€‰æ‹©èŒä¸šåçš„ç¡®è®¤åŠ¨ç”» */
@keyframes selectionPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}



/* æ–°å¢èŒä¸šç‰¹æ•ˆåŠ¨ç”» */
@keyframes swordEffect {
    0% { opacity: 0; left: -100px; }
    50% { opacity: 1; left: 50%; }
    100% { opacity: 0; left: 100%; }
}

@keyframes shieldEffect {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.sword-animation {
    animation: swordEffect 0.8s ease-out;
}

.shield-animation {
    animation: shieldEffect 0.5s ease-out;
}

    /* ä¿®æ”¹ç°æœ‰å…ƒç´ æ ·å¼ */
    #roomControl {
    display: block; /* æ”¹ç‚ºåˆå§‹é¡¯ç¤º */
    position: relative;
    background: linear-gradient(45deg, rgba(45, 41, 38, 0.95), rgba(25, 22, 20, 0.95)),
                url('https://i.ibb.co/tM82mXtr/3.png');
    }

    #gameArea {
        animation: fadeInUp 0.5s ease-out; /* æ¸¸æˆåŒºæµ®ç°æ•ˆæœ */
    }

    #question {
        animation: fadeInUp 0.1s ease-out; /* é¢˜ç›®æµ®ç° */
        transition: all 0.1s;

       
/* æ•µæ–¹è¡€æ¢å®šä½ */
#enemyHealthContainer {
    position: absolute;
    top: 20px;
    left: 1rem;
    right: 1rem;
    z-index: 2;
}

/* å·±æ–¹è¡€æ¢å®šä½ */
#myHealthContainer {
    position: absolute;
    bottom: 80px; /* æ ¹æ“šç­”æ¡ˆå€é«˜åº¦èª¿æ•´ */
    left: 1rem;
    right: 1rem;
    z-index: 2;
}

/* å•é¡Œå€å¢åŠ åº•éƒ¨é–“è· */
#question {
    margin: 5rem 0 2rem; /* é ‚éƒ¨ç•™å‡ºæ•µæ–¹è¡€æ¢ç©ºé–“ */
}

/* ç­”æ¡ˆå€é™åˆ¶æœ€å¤§é«˜åº¦ */
#options {
    max-height: 50vh;
    overflow-y: auto;
}

        
    }

    /* ä¸ºæ¯ä¸ªé€‰é¡¹æ·»åŠ å»¶è¿Ÿ */
    #options button:nth-child(1) { animation-delay: 0.2s; }
    #options button:nth-child(2) { animation-delay: 0.2s; }
    #options button:nth-child(3) { animation-delay: 0.2s; }
    #options button:nth-child(4) { animation-delay: 0.2s; }

    /* æ–°å¢æŒ‰é’®ç‚¹å‡»åé¦ˆ */
    button:active {
        transform: scale(0.95) !important;
        filter: brightness(1.2);
    }

    /* ç­‰å¾…åŒºåŠ¨æ€æ•ˆæœ */
    #waitingArea {
        animation: pulseGlow 2s infinite;
    }
        
        :root {
            --gold: #d4af37;
            --dark-bg: #2d2926;
        }

        body {
            font-family: 'Times New Roman','WangHanZhongWeiBei', cursive;
            background: url('https://i.ibb.co/kgdHCJX8/image.png') center/cover fixed;
            color: white;
            min-height: 100vh;
            padding: 20px;
            font-size: 16px;
            margin: 0;
            position: relative;
            font-size: 16px;
        }

     #roomControl {
    position: relative;
    background: linear-gradient(45deg, rgba(45, 41, 38, 0.95), rgba(25, 22, 20, 0.95)),
                url('https://t.pimg.jp/076/481/852/1/76481852.jpg');
    background-size: cover;
    background-blend-mode: multiply;
    padding: 2rem 1rem; /* æ¸›å°‘å…§é‚Šè·ä»¥ç•™å‡ºæ›´å¤šç©ºé–“ */
    border-radius: 20px;
    box-shadow: 0 0 50px rgba(212, 175, 55, 0.5);
    border: 3px solid #695434;
    max-width: 90%; /* ä½¿ç”¨ç™¾åˆ†æ¯”å¯¬åº¦ï¼Œé©æ‡‰ä¸åŒè¢å¹• */
    width: 1000px; /* æ¡Œé¢ç«¯æœ€å¤§å¯¬åº¦å¢åŠ  */
    margin: 1rem auto; /* æ¸›å°‘å¤–é‚Šè· */
    overflow: hidden;
}

@media (max-width: 480px) {
    #roomControl {
        max-width: 95%; /* æ‰‹æ©Ÿç«¯é€²ä¸€æ­¥æ“´å±•å¯¬åº¦ */
        padding: 1.5rem 0.5rem; /* æ‰‹æ©Ÿç«¯æ¸›å°å…§é‚Šè· */
    }
}

        /* ç¢ºä¿ #roomControl çš„å­å…ƒç´ æœ‰ä¸€è‡´çš„èƒŒæ™¯å’Œä½ˆå±€ */
#roomControl .info-box,
#roomControl .input-group,
#roomControl .button-group,
#roomControl .footer {
    background: rgba(45, 41, 38, 0.95);
    padding: 1rem;
    border-radius: 10px;
    margin: 1rem auto;
    max-width: 600px;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
}

.button-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* è‡ªé©æ‡‰æŒ‰éˆ•å¯¬åº¦ */
    gap: 1rem;
}

/* å¦ä¸€è™•å®šç¾©ï¼ˆéœ€è¦åˆä½µï¼‰ */
.button-group {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    max-width: 500px;
    margin: 2rem auto;
}

/* ç¢ºä¿æ¨™é¡Œä¸è¢«èƒŒæ™¯å½±éŸ¿ */
.title-container {
    background: none;
    padding: 0;
}

.title-container {
    position: relative;
    margin-bottom: 3rem;
    text-align: center;
}

.dragon-icon {
    width: 120px;
    position: absolute;
    top: -50px;
    left: 50%;
    transform: translateX(-50%);
    filter: drop-shadow(0 0 10px #d4af37);
}

.title-text {
    display: block;
    font-size: 3rem;
    color: #d4af37;
    text-shadow: 3px 3px 0 #8b6914;
    letter-spacing: 4px;
    animation: titleFloat 3s ease-in-out infinite;
}

.subtitle {
    display: block;
    font-size: 1.2rem;
    color: #c0b090;
    margin-top: 0.5rem;
    letter-spacing: 2px;
}

.input-group {
    margin: 2rem 0;
}

.input-decor {
    position: relative;
    max-width: 400px;
    margin: 0 auto;
}

#roomId {
    width: 100%;
    padding: 1.2rem 2.5rem;
    font-size: 1.5rem;
    background: rgba(0,0,0,0.7);
    border: 2px solid #695434;
    border-radius: 15px;
    color: #d4af37;
    text-align: center;
    transition: all 0.3s;
}

#roomId:focus {
    outline: none;
    border-color: #d4af37;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
}

.icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #d4af37;
    opacity: 0.7;
}

.button-group {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    max-width: 500px;
    margin: 2rem auto;
}

.action-btn {
    position: relative;
    padding: 1.5rem 2rem;
    border: none;
    border-radius: 12px;
    font-size: 1.4rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    overflow: hidden;
}

        .story-btn {
    background: linear-gradient(45deg, #8e44ad, #9b59b6); /* ç´«è‰²æ¼¸è®Šï¼Œèˆ‡æ•…äº‹ç¥ç§˜æ„Ÿç›¸ç¬¦ */
    box-shadow: 0 5px 15px rgba(142, 68, 173, 0.4);
}

.story-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(142, 68, 173, 0.6);
}

.create-btn {
    background: linear-gradient(45deg, #b71c1c , #c62828);
    box-shadow: 0 5px 15px rgba(199, 46, 46, 0.4);
}

.join-btn {
    background: linear-gradient(45deg, #2c3e50, #3498db);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
}

.action-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.action-btn:active {
    transform: translateY(1px);
}

.btn-glow {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255,255,255,0.2) 50%, 
        transparent 100%
    );
    opacity: 0;
    transition: opacity 0.3s;
}

.action-btn:hover .btn-glow {
    opacity: 1;
}

.footer {
    margin-top: 3rem;
    text-align: center;
    color: #7a6a52;
}

.decor-line {
    height: 2px;
    background: linear-gradient(90deg, transparent 0%, #695434 50%, transparent 100%);
    margin: 1rem 0;
}

@keyframes titleFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}
        
#roomId {
    background: rgba(0,0,0,0.8);
    border: 1px solid rgba(212,175,55,0.3);
    max-width: 70%;
}

        
        input, button {
    font-family: 'WangHanZhongWeiBei', cursive;
    font-size: 1.4rem;
    padding: 0.6rem 1.2rem;
    margin: 0.3rem;
    border: 2px solid var(--gold);
    border-radius: 15px;
    background: rgba(0,0,0,0.7);
    color: white;
    transition: all 0.3s;
}

        button:hover {
            background: var(--main-red);
            transform: scale(1.05);
            cursor: pointer;
        }

        #gameArea {
            background: rgba(45, 41, 38, 0.95);
            border: 3px solid var(--gold);
            border-radius: 15px;
            padding: 1rem;
            max-width: 100%;
            margin: 1rem auto;
            min-height: calc(100vh - 40px);
            position: relative;
            display: none;
        }

        .health-bar {
            width: 100%;
            height: 40px;
            margin: 0.5rem 0;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            transform: translateZ(0);
        }

       .health-fill {
    height: 100%;
    transition: width 0.5s ease;
}

/* æ–°å¢å€åˆ†æ•µæˆ‘çš„é¡è‰² */
#myHealthBar {
    background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%); /* æˆ‘æ–¹ç¶ è‰²ç³» */
}

#opponentHealthBar {
    background: linear-gradient(90deg, #c0392b 0%, #e74c3c 100%); /* æ•µæ–¹ç´…è‰²ç³» */
}

        #question {
            font-size: 1.6rem;
            text-align: center;
            margin: 1rem 0;
            padding: 0.8rem;
             line-height: 1.4;
            background: rgba(0,0,0,0.5);
            border-left: 5px solid var(--gold);
        }

        #options {
            display: grid;
            gap: 0.8rem;
            grid-template-columns: repeat(1fr);
        }

        #options button {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            border: none;
            padding: 1.8rem 1.5rem;
            min-height: 70px; 
            line-height: 1.4; 
            font-size: 2.0rem;
            color: white;
        }

        #options button:hover {
            background: var(--main-red);
        }
        
        #timer {
            font-size: 3rem;
            position: fixed;
    top: 20px;  /* æ”¹åˆ°ä¸Šæ–¹ */
    right: 20px;
    z-index: 999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        }

        .decorative-border {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: url('https://wallfloor.jp/uploads/list_view/200101/image/LL-7386_1118354_220517_C_01.jpgg') repeat;
            opacity: 0.1;
        }

        #waitingArea {
            text-align: center;
            font-size: 1.8rem;
    max-width: 95%;
    padding: 1.5rem;
    margin: 1rem auto;
            color: var(--gold);
            display: none;
        }

        @keyframes bloodHit {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes screenShake {
            0% { transform: translate(0); }
            25% { transform: translate(-10px, 10px); }
            50% { transform: translate(10px, -10px); }
            75% { transform: translate(-10px, -10px); }
            100% { transform: translate(0); }
        }

        @keyframes victoryPulse {
            0% { opacity: 0; transform: scale(0); }
            80% { opacity: 1; transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .damage-effect {
            animation: bloodHit 0.3s ease-in-out;
        }

        .screen-shake {
            animation: screenShake 0.5s ease-in-out;
        }

        .victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .grade-btn, .topic-btn {
    width: 100%;
    padding: 1rem;
    font-size: 1.5rem;
    background: linear-gradient(45deg, #c0392b, #e74c3c);
    border: 2px solid #695434;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.grade-btn:hover, .topic-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
}

        .victory-text {
            font-size: 5rem;
            color: #d4af37;
            text-shadow: 0 0 20px #c3272b;
            animation: victoryPulse 1s ease-out;
        }

/* èŒä¸šé€‰æ‹©ç•Œé¢æ ·å¼ */
#classSelection {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    padding: 0rem;
    z-index: 9999;
    overflow-y: auto;
}

.class-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    max-width: 83%;
    margin: 0 auto;
}

.class-card {
    background: rgba(45, 41, 38, 0.95);
    border: 2px solid var(--gold);
    border-radius: 10px;
    padding: 1rem;
    cursor: pointer;
    transition: transform 0.3s;
    text-align: center;
}

        /* é€‰ä¸­çŠ¶æ€å¸¸äº® */
.class-card.selected {
    border-color: #2ecc71 !important;
    box-shadow: 0 0 15px rgba(46,204,113,0.5);
}

/* å‹¾å·æ ·å¼ */
.selected-tick {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    background: #2ecc71;
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    text-shadow: 0 0 5px rgba(0,0,0,0.5);
}


.class-card:hover {
    transform: scale(1.05);
    border-color: #fff;
}

.class-icon {
    width: 140px;
    height: 140px;
    object-fit: cover;
    border-radius: 50%;
    border: 2px solid var(--gold);
    margin-bottom: 1rem;
}

.class-stats {
    text-align: left;
    padding: 0;
    font-size: 0.9rem;
    list-style: none;
}

.class-stats li {
    margin: 0.5rem 0;
    padding: 0.5rem;
    background: rgba(255,255,255,0.1);
    border-radius: 5px;
}

/* å·²é€‰æ‹©èŒä¸šæç¤º */
#selectedClassInfo {
    text-align: center;
    font-size: 1.2rem;
    color: var(--gold);
    animation: pulseGlow 2s infinite;
}
        
        @media (max-width: 480px) {
            .music-control {
       bottom: 13px;  /* æ‰‹æœºç«¯æ›´è´´è¿‘åº•éƒ¨ */
        right: 8px;
        width: 50px;
        height: 50px;
        font-size: 2rem;
        border: 0px solid var(--gold); 
        background: rgba(255,255,255,0.1)

    }
            #options {
                grid-template-columns: 1fr;
            }
            input, button {
                width: 100%;
                margin: 0.5rem 0;
            }
            #options button {
        padding: 1rem !important;   /* é¸é …æŒ‰éˆ•å…§è·æ”¾å¤§ */
        font-size: 1.2rem !important; /* é¸é …æ–‡å­—æ”¾å¤§ */
    }
            #question {
                font-size: 1.4rem;
                margin: 0.8rem 0;
            }
            .victory-text {
                font-size: 3rem;
            }
        }


@keyframes swordSwipe {
    0% { 
        opacity: 0;
        left: -100px;
        transform: rotate(-45deg) scaleX(0);
    }
    50% { 
        opacity: 0.8;
        left: 50%;
        transform: rotate(-45deg) scaleX(1.2);
    }
    100% { 
        opacity: 0;
        left: 100%;
        transform: rotate(-45deg) scaleX(0);
    }
}

.sword-flash {
    position: fixed;
    width: 150px;
    height: 30px;
    background: linear-gradient(
        90deg,
        rgba(255,255,255,0) 0%,
        rgba(100,255,100,0.7) 50%,
        rgba(255,255,255,0) 100%
    );
    pointer-events: none;
    z-index: 999;
    animation: swordSwipe 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    filter: brightness(1.5);
    top: 50%; /* åˆå§‹å‚ç›´å±…ä¸­ */
}

/* æ–°å¢é—ªé¿æç¤ºåŠ¨ç”» */
@keyframes dodgeFade {
  0% { opacity: 0; transform: translate(-50%,-50%) scale(0.5); }
  50% { opacity: 1; transform: translate(-50%,-50%) scale(1.2); }
  100% { opacity: 0; transform: translate(-50%,-50%) scale(0.8); }
}

#dodgeText {
  animation: dodgeFade 1s ease-out;
  pointer-events: none;

        /* æ–°å¢æ²»ç–—æç¤ºåŠ¨ç”» */
@keyframes healFade {
  0% { opacity: 0; transform: translate(-50%,-50%) scale(0.8); }
  50% { opacity: 1; transform: translate(-50%,-50%) scale(1.1); }
  100% { opacity: 0; transform: translate(-50%,-50%) scale(1); }
}

#healText {
    display: none;
    position: absolute;
    bottom: 80px; /* æ ¹æ®å·±æ–¹è¡€æ¡ä½ç½®è°ƒæ•´ */
    right: 1rem; /* è°ƒæ•´åˆ°æ°”è¡€åé¢çš„ä½ç½® */
    font-size: 1.5rem; /* ç¼©å°å­—ä½“å¤§å° */
    color: #00ff00;
    text-shadow: 0 0 10px rgba(0,255,0,0.5);
}

    .shield-icon
    .shield-icon {
    font-size: 1.5rem; /* è°ƒæ•´å›¾æ ‡å¤§å° */
    margin-left: 5px; /* è°ƒæ•´å›¾æ ‡ä¸æ°”è¡€æ–‡å­—çš„é—´è· */
}

    /* æ–°å¢å‡ä¼¤æç¤ºåŠ¨ç”» */
@keyframes reduceDamageFade {
  0% { opacity: 0; transform: translate(-50%,-50%) translateY(20px); }
  50% { opacity: 1; transform: translate(-50%,-50%) translateY(0); }
  100% { opacity: 0; transform: translate(-50%,-50%) translateY(-20px); }
}


        
    </style>
</head>
<body>
   
    <button class="music-control" onclick="toggleMusic()">ğŸµ</button>
    

<div id="roomControl">


<div id="doubleTimeAnnouncement" style="display: none; text-align: center; margin: 1rem 0; padding: 1rem; background: rgba(255, 215, 0, 0.2); border: 2px solid gold; border-radius: 10px; color: gold; font-size: 1.2rem;">
        <i class="fas fa-star" style="color: #FFD700; margin-right: 0.5rem;"></i>
        <strong>é›™å€æ™‚æ®µå·²é–‹å§‹ï¼</strong> ç”±ç¾åœ¨è‡³20:00ï¼Œåƒèˆ‡å¤šäººæ¨¡å¼å¯ç²å¾—é›™å€ç©åˆ†å’Œç¶“é©—å€¼ï¼
        <i class="fas fa-star" style="color: #FFD700; margin-left: 0.5rem;"></i>
    </div>
    
    <!-- æ–°å¢è£é£¾æ€§é‚Šæ¡† -->
    <div class="main-border"></div>
    
    <!-- ä¿®æ”¹1: åœ¨ç”¨æˆ·ä¿¡æ¯éƒ¨åˆ†æ·»åŠ ç™¾åˆ†æ¯”å’Œå‡çº§æ‰€éœ€ -->
<div id="userInfo" class="info-box" style="display: none;">
    <span id="userName"></span> | ç©åˆ†: <span id="userScore">0</span> | ç­‰ç´š: <span id="userLevel">1</span>
    <div>ç¶“é©—å€¼: 
        <div id="expBar" style="width: 100px; height: 10px; background: #333; border-radius: 5px; display: inline-block;">
            <div id="expFill" style="height: 100%; background: #4CAF50; width: 0%; transition: width 0.5s ease;"></div>
        </div><span id="expText">0/0 (0.0%)</span>
        <div id="expRemaining" style="display: inline-block; margin-left: 0px;">å‡ç´šé‚„éœ€ï¼š0 ç¶“é©—å€¼</div>
    </div>
</div>
    
    <!-- å¼·åŒ–æ¨™é¡Œ -->
  <div class="title-container">
    <h1>
        <img src="https://i.ibb.co/jvwM2r5x/image.png" alt="Logo" style="width: 50px; height: 50px; margin-right: 10px; vertical-align: middle;">
        <span class="title-text">èªå¼ˆéŒ„</span>
        <span class="subtitle">é¾åŸèµ¤ç„é©šå¤©è®Šï¼Œèª°åŸ·æ˜Ÿæ£‹ç ´å¦„å¿ƒ</span>
    </h1>
</div>

    <div style="position:relative; width:100%; height:0px; padding-bottom:177.778%">
    <iframe allow="fullscreen;autoplay" allowfullscreen height="100%" src="https://streamable.com/e/wpx5r5?autoplay=1&loop=0&mute=0" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; overflow:hidden;"></iframe>
</div>
    
    <!-- ç¾åŒ–è¼¸å…¥æ¡†å€åŸŸ -->
    <div class="input-group">
        <div class="input-decor">
            <i class="fas fa-flag icon"></i>
            <input type="text" id="roomId" placeholder="è¼¸å…¥å››ä½æˆ°å ´ç·¨è™Ÿ">
            <div class="glow"></div>
        </div>
    </div>
    
    <!-- æŒ‰éˆ•å®¹å™¨ -->
    <div class="button-group">
        <button onclick="createRoom()" class="action-btn create-btn">
            <i class="fas fa-fist-raised"></i>
            <span>é–‹é—¢æˆ°å ´</span>
            <div class="btn-glow"></div>
        </button>
        <button onclick="joinRoom()" class="action-btn join-btn">
            <i class="fas fa-shield-alt"></i>
            <span>åŠ å…¥å¾ä¼</span>
            <div class="btn-glow"></div>
        </button>
        <button onclick="randomMatch()" class="action-btn random-match-btn">
            <i class="fas fa-random"></i>
            <span>éš¨æ©Ÿé…å°</span>
            <div class="btn-glow"></div>
        </button>
        <button onclick="startSinglePlayer()" class="action-btn single-player-btn">
    <i class="fas fa-user"></i>
    <span>å–®æ©Ÿæ¨¡å¼</span>
    <div class="btn-glow"></div>
</button>
    </div>

   
     
    <div class="input-group">
         <button id="registerBtn" class="action-btn" style="background: linear-gradient(45deg, #2ecc71, #27ae60);">
        <i class="fas fa-user-plus"></i>
        <span>è¨»å†Š</span>
    </button>
        <button id="loginBtn" class="action-btn" style="background: linear-gradient(45deg, #8e44ad, #9b59b6);">
            <i class="fas fa-user"></i>
            <span>ç™»å…¥</span>
        </button>
    </div>

    <div id="logoutContainer" style="display: none; margin-top: 1rem;">
        <button id="logoutBtn" class="action-btn" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
            <i class="fas fa-sign-out-alt"></i>
            <span>ç™»å‡º</span>
        </button>
    </div>

    <!-- æ–°å¢é è…³ -->
    <div class="footer">
        <div class="decor-line"></div>
        <p>âš”ï¸ é¸æ“‡ä½ çš„å¾æˆ°ä¹‹è·¯ âš”ï¸</p>
        <button id="showLeaderboardBtn" class="action-btn" style="background: linear-gradient(45deg, #f1c40f, #f39c12); margin-top: 1rem;">
            <i class="fas fa-trophy"></i>
            <span>æŸ¥çœ‹æ’è¡Œæ¦œ</span>
        </button>

<button onclick="showStoryBackground()" class="action-btn story-btn">
    <i class="fas fa-book-open"></i>
    <span>æ•…äº‹èƒŒæ™¯</span>
    <div class="btn-glow"></div>
</button>
        
    </div>
</div>

    <!-- æ•…äº‹èƒŒæ™¯å½ˆå‡ºè¦–çª— -->
<div id="storyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; overflow-y: auto;">
    <div style="background: rgba(45, 41, 38, 0.95); padding: 2rem; border: 3px solid var(--gold); border-radius: 15px; max-width: 800px; margin: 2rem auto; color: white;">
        <h2 style="text-align: center; color: var(--gold);">ã€Šèªå¼ˆéŒ„ã€‹æ•…äº‹èƒŒæ™¯</h2>
        <p style="font-size: 1.2rem; line-height: 1.6;">æ±Ÿæ¹–ç™¾å¹´ï¼Œæ­¦æ—ç´›çˆ­ä¸æ–·ï¼Œå¤©ä¸‹æ­¦å­¸çµ‚æ­¸å››è„ˆâ€”â€”<strong>éœ¸åˆ€æµ</strong>ä»¥åŠ›ç ´å·§ï¼Œ<strong>éµç”²å®—</strong>å›ºè‹¥é‡‘æ¹¯ï¼Œ<strong>å½±æµæ•™</strong>èº«æ³•è©­è­ï¼Œ<strong>ç„å¤©é–£</strong>è¡“æ³•é€šç„ã€‚å››æ´¾å› ä¸€å·ã€Šèªå¼ˆéŒ„ã€‹ç§˜å…¸é‡ç¾ï¼Œæ€èµ·æ»”å¤©å·¨æµªã€‚</p>
        <p style="font-size: 1.2rem; line-height: 1.6;">ç›¸å‚³ã€Šèªå¼ˆéŒ„ã€‹ä¹ƒå‰æœåœ‹å¸«æ‰€è‘—ï¼Œæ›¸ä¸­æš—è—ã€Œä»¥è¨€ç‚ºåˆƒã€ä»¥å¿ƒç‚ºæ£‹ã€çš„çµ•ä¸–æ­¦å­¸ï¼Œèƒ½çªºç ´å¤©ä¸‹æ‹›å¼ä¹‹ç ´ç¶»ï¼Œæ›´å¯æ“ç¸±äººå¿ƒæ–¼ç„¡å½¢ã€‚æ­¤æ›¸ä¸€å‡ºï¼Œå››æ´¾æŒé–€çš†é£å¼Ÿå­è¿½å°‹ï¼Œå»æœªæ–™ç§˜å…¸æ—©å·²è½å…¥å››åç¥ç§˜äººæ‰‹ä¸­ã€‚æ­¤å››äººè¡Œäº‹ä¹–å¼µï¼Œæ­¦åŠŸæ·±ä¸å¯æ¸¬ï¼Œè‡ªç¨±ã€Œå¹½å†¥å››ç…ã€ï¼Œå…¶åè™Ÿä»¤æ±Ÿæ¹–èé¢¨å–ªè†½â€”â€”</p>
        <ul style="list-style-type: none; padding: 0;">
            <li style="margin: 1rem 0; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 10px;">
                <strong style="color: #e74c3c;">å¸ƒé­¯è²“</strong>ï¼šéœ¸åˆ€æµå›å¾’ï¼ŒåŸç‚ºé–€ä¸­é¦–å¸­å¼Ÿå­ï¼Œå› ç—´è¿·ã€Šèªå¼ˆéŒ„ã€‹ä¸­ã€Œç‹‚åˆ€å™¬å¿ƒã€ä¹‹è¡“ï¼Œä¸æƒœå¼’å¸«å¥ªå…¸ã€‚ä»–èº«æŠ«ç„éµé‡ç”²ï¼Œæ‰‹æŒä¹ç’°é¬¼é ­åˆ€ï¼Œåˆ€æ³•æš´çƒˆå¦‚ç˜‹è™ï¼Œå»å› å¼·ç·´é‚ªåŠŸè€ŒåŠé¢æ½°çˆ›ï¼Œçµ‚æ—¥ä»¥éµé¢å…·é®é¡ã€‚å‚³èä»–æ¯é€¢æœˆåœ“ä¾¿å± æˆ®æ‘è½ï¼Œä»¥é®®è¡€æ¾†çŒåˆ€é‹’ï¼Œæ±Ÿæ¹–äººç¨±ã€Œè¡€é¢é–»ç¾…ã€ã€‚
            </li>
            <li style="margin: 1rem 0; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 10px;">
                <strong style="color: #3498db;">é›ªç¾½åƒå¤®</strong>ï¼šæ­¤å¥³ç™½é«®å¦‚é›ªï¼Œå®¹é¡ä¼¼å†°é›•ç‰ç¢ï¼Œä¹ƒå½±æµæ•™ç™¾å¹´é›£é‡çš„å¥‡æ‰ã€‚å¥¹å¹¼æ™‚è¢«æ£„æ–¼é›ªå±±ï¼Œç”±å½±æµä¸Šä»£æ•™ä¸»æ”¶é¤Šï¼Œç¿’å¾—ã€Œåƒå¹»ç„¡è¹¤æ­¥ã€ï¼Œèº«å½¢é£„å¿½å¦‚é¬¼é­…ã€‚ç„¶å…¶å¿ƒæ€§å†·åƒ»ï¼Œå› å·å­¸ç¦è¡“ã€Œå¯’é«“é‡ã€é­é€å‡ºå¸«é–€ï¼Œæ­¤å¾Œç¨è¡Œæ±Ÿæ¹–ï¼Œå°ˆæŒ‘åé–€æ­£æ´¾å¼Ÿå­ä¸‹æ‰‹ï¼Œä»¥éŠ€é‡åˆºå…¥å°æ‰‹ç™¾æœƒç©´ï¼Œå¥ªå…¶å…§åŠ›åŒ–ç‚ºå·±ç”¨ã€‚å‚³è¨€å¥¹è¢–ä¸­è—æœ‰ä¸‰ç™¾å…­åäº”æ ¹å†°é­„é‡ï¼Œé‡å‡ºå¿…è¦‹è¡€ã€‚
            </li>
            <li style="margin: 1rem 0; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 10px;">
                <strong style="color: #9b59b6;">é¶´æ£²æœ”</strong>ï¼šç„å¤©é–£æ£„å¾’ï¼Œä¸€é ­éŠ€çµ²å‚åœ°ï¼Œå¸¸ä¹˜ç™½é¶´é¨éŠé›²ç«¯ã€‚æ­¤äººæœ¬ç‚ºé–£ä¸­é•·è€ï¼Œç²¾é€šã€Œå¤ªè™›å¼•æ°£è¨£ã€ï¼Œå»å› ç§ç…‰ç¦è¡“ã€Œä¹è½‰å™¬é­‚é™£ã€è¢«é€ã€‚ä»–æ€§æƒ…å­¤å‚²ï¼Œä»¥ç‰ç¬›ç‚ºå…µåˆƒï¼Œç¬›è²èµ·æ™‚å¯å¼•å¤©åœ°ä¹‹æ°£åŒ–ç‚ºåˆ©åˆƒï¼Œæ›´æ“…ä½ˆé™£å›°æ•µï¼Œæ›¾ä»¥ä¸€é™£å›°æ®ºä¸ƒåäºŒåè¿½å…µï¼Œé™£ä¸­ç™½éª¨æˆå±±ã€‚æ±Ÿæ¹–å‚³è¨€ï¼Œå…¶ç¬›æ›²ã€Œé¶´å”³ä¹éœ„ã€èƒ½ä»¤äººå¿ƒæ™ºç›¡å¤±ï¼Œæ·ªç‚ºå‚€å„¡ã€‚
            </li>
            <li style="margin: 1rem 0; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 10px;">
                <strong style="color: #e67e22;">èµ¤æ·µç¶¾éŸ³</strong>ï¼šå››ç…ä¹‹é¦–ï¼Œèº«ä¸–æˆè¬ã€‚å¥¹èº«æŠ«èµ¤ç´‹é»‘è¢ï¼Œåº§ä¸‹ç„é¾çŒ™ç°ï¼Œé¾åŸè²éœ‡ç™¾é‡Œã€‚æ­¤å¥³ç²¾é€šå››æ´¾æ­¦å­¸ï¼Œå»åˆè‡ªå‰µã€Œèµ¤æ·µè¨£ã€ï¼Œèƒ½ä»¥è¡€ç‚ºåª’ï¼ŒåŒ–ä»–äººåŠŸåŠ›ç‚ºå·±ç”¨ã€‚å‚³èå¥¹æœ¬ç‚ºéµç”²å®—å®—ä¸»ä¹‹å¥³ï¼Œå› ç›®ç¹çˆ¶è¦ªé­åŒé–€æš—ç®—æ…˜æ­»ï¼Œä¸€å¤œç™½é ­ï¼Œè‡ªæ­¤å¢®å…¥é­”é“ã€‚å¥¹æ‰‹æŒã€Œæ­ƒè¡€éª¨é­ã€ï¼Œé­èº«ä»¥ç™¾åé«˜æ‰‹è„Šéª¨ç…‰è£½ï¼Œæ®å‹•æ™‚å†¤é­‚å“€åšï¼Œæ‰€éä¹‹è™•ç”Ÿæ©Ÿç›¡æ»…ã€‚
            </li>
        </ul>
        <p style="font-size: 1.2rem; line-height: 1.6;">å››ç…å¾—ã€Šèªå¼ˆéŒ„ã€‹å¾Œï¼Œé‡å¿ƒæ„ˆç†¾ã€‚å¸ƒé­¯è²“ç‡éœ¸åˆ€æµæ®˜éƒ¨ç›¤è¸ã€Œæ–·é­‚å¶ºã€ï¼Œä»¥é…·åˆ‘é€¼è¿«ä¿˜è™œä¿®ç¿’é‚ªåŠŸï¼›é›ªç¾½åƒå¤®éš±æ–¼ã€Œå¯’é¡æ¹–ã€ï¼Œæ¹–åº•æ²‰å±ç„¡æ•¸ï¼›é¶´æ£²æœ”ä½”ã€Œé›²æ¸ºå³°ã€ç‚ºå·¢ï¼Œå³°é ‚çµ‚å¹´æ¯’éœ§ç¹šç¹ï¼›èµ¤æ·µç¶¾éŸ³å‰‡åé®ã€Œç„šå¤©è°·ã€ï¼Œè°·ä¸­ç†”å²©ç¿»æ¹§ï¼Œç„é¾ç›¤è¸å…¶é–“ã€‚å››åœ°é™ç›¸å‘¼æ‡‰ï¼Œæ±Ÿæ¹–è…¥é¢¨è¡€é›¨ï¼Œæ­£æ´¾äººå£«å±¢æ¬¡åœå‰¿çš†æ…˜æ•—è€Œæ­¸ã€‚</p>
        <p style="font-size: 1.2rem; line-height: 1.6;">å€¼æ­¤å±å±€ï¼Œå››æ´¾æŒé–€ä¸å¾—ä¸æš«æ£„å‰å«Œï¼Œå…±æ¨ã€Œéµç”²å®—ã€å®—ä¸»å¶½æ“å±±ç‚ºç›Ÿä¸»ã€‚æ­¤äººå¹´éäº”æ—¬ï¼Œé¢å®¹å‰›æ¯…ï¼Œä¸€èº«ã€Œä¸å‹•æ˜ç‹åŠŸã€å·²è‡»åŒ–å¢ƒï¼Œæ›¾ä»¥è¡€è‚‰ä¹‹è»€ç¡¬æ¥éœ¸åˆ€æµåä¸‰é€£æ–¬è€Œæ¯«é«®ç„¡æã€‚ç„¶å…¶å­å¶½é•·æ²³å»å°çˆ¶è¦ªçš„ä¿å®ˆä½œé¢¨é —æœ‰ä¸æ»¿ï¼Œç§ä¸‹è¯åˆã€Œç„å¤©é–£ã€å¤©æ‰å¼Ÿå­é›²ç„¡æœˆï¼Œæ¬²ä»¥å¥‡æ‹›ç ´æ•µã€‚é›²ç„¡æœˆä¹ƒé–£ä¸»é–‰é–€å¼Ÿå­ï¼Œç²¾é€šã€Œæ˜Ÿç§»è¡“ã€ï¼Œå¯å€Ÿæ˜Ÿè¾°ä¹‹åŠ›ç¬ç§»ç™¾ä¸ˆï¼Œæ›´ç·´æˆå¤±å‚³ç™¾å¹´çš„ã€Œç’‡ç’£æŒ‡ã€ï¼Œä¸€æŒ‡é»å‡ºï¼Œé‡‘çŸ³ç‚ºé–‹ã€‚</p>
      <p style="font-size: 1.2rem; line-height: 1.6;">å½±æµæ•™å‰‡æ´¾å‡ºå¤œç„¡ç—•â€”â€”æ­¤å­èº«ä¸–å¦‚è¬ï¼Œè‡ªå¹¼è¢«ç‹¼ç¾¤é¤Šå¤§ï¼Œç¿’å¾—ã€Œç‹¼å½±ä¸ƒæ®ºã€å¾Œé‡æ­¸äººé–“ã€‚ä»–ä¸ç”¨å…µåˆƒï¼ŒåæŒ‡æŒ‡ç”²æ·¬æœ‰åŠ‡æ¯’ï¼Œæ‹›å¼ç‹ è¾£åˆé‘½ï¼Œå»å› ç¸æ€§æœªé¦´ï¼Œæ™‚å¸¸æ•µæˆ‘ä¸åˆ†ã€‚éœ¸åˆ€æµä»£è¡¨é›·ç ´è»ä¹ƒå¸ƒé­¯è²“å¸«å¼Ÿï¼Œæ‰‹æŒé–€ä¸­è–åˆ€ã€Œé©šé›·ã€ï¼Œåˆ€æ³•å¤§é–‹å¤§é—”ï¼Œå› å¸«å…„å›è®Šè€Œå¿ƒé­”çºèº«ï¼Œåˆ€é‹’å¸¸å¸¶æ‚²é³´ã€‚</p>
         <p style="font-size: 1.2rem; line-height: 1.6;"><strong>é©šä¸–çœŸç›¸ï¼š</strong>æ­£é‚ªå°å³™ä¹‹éš›ï¼Œæ±Ÿæ¹–å‚³å‡ºé©šäººæ¶ˆæ¯ï¼šã€Šèªå¼ˆéŒ„ã€‹çœŸæ­£å¥§ç¾©ä¸¦éæ­¦å­¸ï¼Œè€Œæ˜¯å‰æœåœ‹å¸«ç‚ºé®å£“ã€Œèµ¤æ·µã€é‚ªé¾æ‰€è¨­çš„å°å°ä¹‹è¡“ã€‚èµ¤æ·µç¶¾éŸ³å¾—ç§˜å…¸å¾Œï¼Œç«Ÿæ¬²ä»¥è¬äººè¡€ç¥­å–šé†’ç„é¾çœŸèº«ï¼Œè‹¥é‚ªé¾ç¾ä¸–ï¼Œå‰‡å¤©åœ°å‚¾è¦†ã€‚è‡³æ­¤ï¼Œå››æ´¾å¼Ÿå­ä¸åƒ…è¦èª…æ»…å››ç…ï¼Œæ›´éœ€å°‹å¾—åœ‹å¸«å¾Œäººï¼Œé‡å•Ÿå°å°â€¦â€¦</p>
        <p style="font-size: 1.2rem; line-height: 1.6; color: #d4af37;"><strong>äººç‰©å‘½é€”äº¤ç¹”ï¼š</strong>å¶½é•·æ²³èˆ‡é›²ç„¡æœˆå¤œæ¢ç„šå¤©è°·ï¼Œå»è¦‹èµ¤æ·µç¶¾éŸ³ç«‹æ–¼ç„é¾é¦–ç´šä¹‹ä¸Šï¼Œé»‘è¢çµçµä½œéŸ¿ã€‚å¥¹è¼•æ’«é¾è§’ä½èªï¼šã€Œé€™ä¸–é–“è² æˆ‘è€…ï¼Œçš†è©²åŒ–ä½œè¡€æ³¥ã€‚ã€èªç•¢ç”©é­æ²èµ·å²©æ¼¿ï¼Œè°·ä¸­é “æˆç«æµ·ï¼›å¤œç„¡ç—•è¿½æ®ºé›ªç¾½åƒå¤®è‡³å¯’é¡æ¹–ï¼Œè¦‹å¥¹èµ¤è¶³ç«‹æ–¼å†°é¢ï¼Œä¸‰ç™¾éŠ€é‡ç’°èº«é£›èˆï¼Œè­ç¬‘é“ï¼šã€Œé‡ç¸ä¹Ÿé…è«‡æ­¦é“ï¼Ÿã€ï¼›é›·ç ´è»ç¨ä¸Šæ–·é­‚å¶ºï¼Œèˆ‡å¸ƒé­¯è²“é›™åˆ€ç›¸æ“Šï¼Œç«èŠ±å››æ¿ºä¸­ï¼Œæ˜”æ—¥å¸«å…„é¢å…·å´©è£‚ï¼Œéœ²å‡ºåŠå¼µè…çˆ›è‡‰å­”ç‹‚ç¬‘ï¼šã€Œå¸«å¼Ÿï¼Œä½ çš„åˆ€æ…¢äº†ï¼ã€
äº‚ä¸–æ±Ÿæ¹–ï¼Œæ£‹å±€å·²é–‹ã€‚å››æ´¾å¼Ÿå­èƒ½å¦ç ´é™¤å¿ƒé­”ã€è¯æ‰‹æŠ—æ•µï¼Ÿã€Šèªå¼ˆéŒ„ã€‹ä¸­ç©¶ç«Ÿè—æœ‰ä½•ç¨®çœŸç›¸ï¼Ÿèµ¤æ·µç¶¾éŸ³çš„æ¨æ„åˆå°‡å¦‚ä½•äº†çµï¼Ÿä¸€åˆ‡çš†åœ¨ã€Œèªå¼ˆã€ä¹‹é–“â€”â€”ä»¥ç”Ÿæ­»ç‚ºæ³¨ï¼Œä»¥æ­¦é“ç‚ºå¼ˆã€‚
</p>
 <p style="font-size: 1.2rem; line-height: 1.6; color: #aed6f1;"><strong>è©©æ›°ï¼š</strong></p>
       <p style="font-size: 1.2rem; line-height: 1.6; color: #aed6f1;"><strong>å¹½å†¥å››ç…æ€è…¥é›¨ï¼Œç§˜å…¸ä¸€æ›¸å‹•æ­¦æ—ã€‚</strong></p>
<p style="font-size: 1.2rem; line-height: 1.6; color: #aed6f1;"><strong>åˆ€é¢¨è£‚å²³åƒé­‚æ³£ï¼Œéµå£å´©é›²è¬éª¨å–‘ã€‚</strong></p>
<p style="font-size: 1.2rem; line-height: 1.6; color: #aed6f1;"><strong>ç„ç”²ç©ºé¤˜æ®˜æœˆå†·ï¼ŒéŠ€é‡ç›¡æŸ“é›ªå±±é™°ã€‚</strong></p>
<p style="font-size: 1.2rem; line-height: 1.6; color: #aed6f1;"><strong>é¾åŸèµ¤ç„é©šå¤©è®Šï¼Œèª°åŸ·æ˜Ÿæ£‹ç ´å¦„å¿ƒï¼Ÿ</strong></p>

        
        <button onclick="document.getElementById('storyModal').style.display='none'" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #e74c3c; border: none; border-radius: 5px; color: white; cursor: pointer;">é—œé–‰</button>
    </div>
</div>



<!-- æ–°å¢è·æ¥­é¸æ“‡ç•Œé¢ -->
<div id="classSelection" style="display: none;">
    <h2 style="color: var(--gold); margin-bottom: 2rem;">é¸æ“‡ä½ çš„æ­¦é“æµæ´¾</h2>
    <div class="class-grid">
        <!-- æˆ°å£« -->
        <div class="class-card" onclick="selectClass('warrior')">
            <img src="https://i.ibb.co/XfWY2Lgc/1.png" class="class-icon">
            <div class="selected-tick">âœ“</div>
            <h3>éœ¸åˆ€æµ</h3>
            <p>æ”»æ“Š+20% é˜²ç¦¦-10%</p>
            <ul class="class-stats">
                <li>âš”ï¸ è£‚ç©ºæ“Šï¼šå‘½ä¸­å¾Œæœ‰30%æ©Ÿç‡é€ æˆé›™å€å‚·å®³</li>
            </ul>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/XfWY2Lgc/1.png" alt="éœ¸åˆ€æµå…¨åœ–">
            </div>
        </div>
        <!-- å¦å…‹ -->
        <div class="class-card" onclick="selectClass('tank')">
            <img src="https://i.ibb.co/ZR4Z2ZDT/image.png" class="class-icon">
            <div class="selected-tick">âœ“</div>
            <h3>éµç”²å®—</h3>
            <p>é˜²ç¦¦+20% æ”»æ“Š-10%</p>
            <ul class="class-stats">
                <li>ğŸ›¡ï¸ é‡‘é˜ç½©ï¼šæ¯å›åˆè‡ªå‹•æ¢å¾©2%æ°£è¡€</li>
            </ul>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/ZR4Z2ZDT/image.png" alt="éµç”²å®—å…¨åœ–">
            </div>
        </div>
        <!-- åˆºå®¢ -->
        <div class="class-card" onclick="selectClass('assassin')">
            <img src="https://i.ibb.co/W4V5bX8X/image.png" class="class-icon">
            <div class="selected-tick">âœ“</div>
            <h3>å½±æµæ•™</h3>
            <p>é–ƒé¿+30% é˜²ç¦¦-10%</p>
            <ul class="class-stats">
                <li>ğŸ¯ é¬¼å½±æ­¥ï¼š30%æ©Ÿç‡å®Œå…¨é–ƒé¿å‚·å®³</li>
            </ul>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/W4V5bX8X/image.png" alt="å½±æµæ•™å…¨åœ–">
            </div>
        </div>
        <!-- æ³•å¸« -->
        <div class="class-card" onclick="selectClass('mage')">
            <img src="https://i.ibb.co/tM82mXtr/3.png" class="class-icon">
            <div class="selected-tick">âœ“</div>
            <h3>ç„å¤©é–£</h3>
            <p>æ”»æ“Š+10%</p>
            <ul class="class-stats">
                <li>ğŸ”¥ é›¢ç«è¨£ï¼šéŒ¯ç­”å‚·å®³æ‰£æ¸›30%</li>
            </ul>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/tM82mXtr/3.png" alt="ç„å¤©é–£å…¨åœ–">
            </div>
        </div>
    </div>
    <div id="selectedClassInfo" style="margin-top: 2rem;"></div>
</div>
    
   <div id="waitingArea" style="
    text-align: center;
    font-size: 2rem;
    color: var(--gold);
    display: none;
    padding: 2rem;
    background: rgba(45, 41, 38, 0.95);
    border: 3px solid var(--gold);
    border-radius: 15px;
    max-width: 600px;
    margin: 2rem auto;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
">
    ğŸ¯ æˆ°é–£ <span id="displayRoomId" style="
        color: var(--main-red);
        font-weight: bold;
        text-shadow: 0 0 10px rgba(195, 39, 43, 0.8);
        padding: 0 0.5rem;
    ">0000</span> å·²é–‹å•Ÿï¼Œéœå€™ä¾†è€…...
</div>

    <div id="gameArea">
        <div class="decorative-border"></div>
        <!-- æ•µæ–¹è¡€æ¢ç§»è‡³é ‚éƒ¨ -->
    <div id="enemyHealthContainer">
        <div>ğŸ—¡ æ•µæ–¹æ°£è¡€: <span id="opponentHealth">100</span>
            <div class="health-bar"><div class="health-fill" id="opponentHealthBar"></div></div>
        </div>
    </div>

        <div id="topicSelection" style="display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(45, 41, 38, 0.95);
    padding: 2rem;
    border: none; /* ç§»é™¤é‚Šæ¡† */
    border-radius: 0; /* ç§»é™¤åœ“è§’ */
    z-index: 9999;
    overflow-y: auto; /* å…§å®¹éå¤šæ™‚å¯æ»¾å‹• */">
    <h2 style="color: #d4af37; text-align: center;">é¸æ“‡é¡Œåº«</h2>
    <div id="gradeSelection" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem; width: 300px;">
        <button onclick="selectGrade('ä¸­ä¸€')" class="grade-btn">ä¸­ä¸€</button>
        <button onclick="selectGrade('ä¸­äºŒ')" class="grade-btn">ä¸­äºŒ</button>
        <button onclick="selectGrade('ä¸­ä¸‰')" class="grade-btn">ä¸­ä¸‰</button>
        <button onclick="selectGrade('ä¸­å››')" class="grade-btn">ä¸­å››</button>
        <button onclick="selectGrade('ä¸­äº”')" class="grade-btn">ä¸­äº”</button>
        <button onclick="selectGrade('ã€ä¸­å²ã€‘')" class="grade-btn">ã€ä¸­å²ã€‘</button>
    </div>
    <div id="topicDetail" style="display: none; margin-top: 1rem;">
        <h3 id="selectedGrade" style="color: #d4af37; text-align: center;"></h3>
        <div id="topicList" style="display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem; margin-top: 1rem;"></div>
    </div>
</div>

    <!-- å•é¡Œèˆ‡é¸é …å€ -->
    <div id="question"></div>
    <div id="options"></div>

    <!-- å·±æ–¹è¡€æ¢ç§»è‡³ç­”æ¡ˆå€ä¸‹æ–¹ -->
    <div id="myHealthContainer">
        <div>ğŸ¹ ä½ çš„æ°£è¡€: <span id="myHealth">100</span>
            <div class="health-bar"><div class="health-fill" id="myHealthBar"></div></div>
        </div>
    </div>
    
    <div id="timer">ğŸ•’15</div>
</div>

<div id="skillEffect" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;"></div>


    

    <div class="victory-overlay">
        <div class="victory-text"></div>
    </div>
    
<div id="difficultySelection" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); padding: 0rem; z-index: 9999; overflow-y: auto;">
    <h2 style="color: var(--gold); margin-bottom: 2rem;">é¸æ“‡é›£åº¦</h2>
    <div class="difficulty-grid">
        <div class="difficulty-card" onclick="selectDifficulty('easy')">
            <img src="https://i.ibb.co/NdJSxqCJ/image-1.png" class="difficulty-icon">
            <div class="selected-tick">âœ“</div>
            <h3>å¸ƒé­¯è²“</h3>
            <p>æ•µæ–¹æ°£è¡€: 1000</p>
            <p>æ­£ç¢ºç‡: 30%</p>
            <p>ç­”é¡Œæ™‚é–“: 6ç§’</p>
            <p>å‹å‡ºçå‹µ: 10é»ç¶“é©—</p>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/NdJSxqCJ/image-1.png" alt="å®¹æ˜“é›£åº¦å…¨åœ–">
            </div>
        </div>
        <div class="difficulty-card" onclick="selectDifficulty('normal')">
            <img src="https://i.ibb.co/N0kzsd7/3.png" class="difficulty-icon">
            <div class="selected-tick">âœ“</div>
            <h3>é›ªç¾½åƒå¤®</h3>
            <p>æ•µæ–¹æ°£è¡€: 1500</p>
            <p>æ­£ç¢ºç‡: 50%</p>
            <p>ç­”é¡Œæ™‚é–“: 5ç§’</p>
            <p>å‹å‡ºçå‹µ: 30é»ç¶“é©—å€¼</p>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/N0kzsd7/3.png" alt="æ™®é€šé›£åº¦å…¨åœ–">
            </div>
        </div>
        <div class="difficulty-card" onclick="selectDifficulty('hard')">
            <img src="https://i.ibb.co/8Lr9D01n/image.png" class="difficulty-icon">
            <div class="selected-tick">âœ“</div>
            <h3>é¶´æ£²æœ”</h3>
            <p>æ•µæ–¹æ°£è¡€: 3500</p>
            <p>æ­£ç¢ºç‡: 70%</p>
            <p>ç­”é¡Œæ™‚é–“: 4ç§’</p>
            <p>å‹å‡ºçå‹µ: 100é»ç¶“é©—å€¼</p>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/8Lr9D01n/image.png" alt="å›°é›£é›£åº¦å…¨åœ–">
            </div>
        </div>
        <div class="difficulty-card" onclick="selectDifficulty('hell')">
            <img src="https://i.ibb.co/HLBDYQVJ/4.png" class="difficulty-icon">
            <div class="selected-tick">âœ“</div>
            <h3>èµ¤æ·µç¶¾éŸ³</h3>
            <p>æ•µæ–¹æ°£è¡€: 5000</p>
            <p>æ­£ç¢ºç‡: 90%</p>
            <p>ç­”é¡Œæ™‚é–“: 3ç§’</p>
            <p>å‹å‡ºçå‹µ: 200é»ç¶“é©—</p>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/HLBDYQVJ/4.png" alt="åœ°ç„é›£åº¦å…¨åœ–">
            </div>
        </div>
    </div>
    <div id="selectedDifficultyInfo" style="margin-top: 2rem;"></div>
</div>


    <!-- å–®æ©Ÿæ¨¡å¼è·æ¥­é¸æ“‡ç•Œé¢ -->
<div id="singlePlayerClassSelection" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); padding: 0rem; z-index: 9999; overflow-y: auto;">
    <h2 style="color: var(--gold); margin-bottom: 2rem;">é¸æ“‡ä½ çš„æ­¦é“æµæ´¾</h2>
    <div class="class-grid">
        <!-- æˆ°å£« -->
        <div class="class-card" onclick="selectSinglePlayerClass('warrior')">
            <img src="https://i.ibb.co/XfWY2Lgc/1.png" class="class-icon">
            <div class="selected-tick">âœ“</div>
            <h3>éœ¸åˆ€æµ</h3>
            <p>æ”»æ“Š+20% é˜²ç¦¦-10%</p>
            <ul class="class-stats">
                <li>âš”ï¸ è£‚ç©ºæ“Šï¼šå‘½ä¸­å¾Œæœ‰30%æ©Ÿç‡é€ æˆé›™å€å‚·å®³</li>
            </ul>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/XfWY2Lgc/1.png" alt="éœ¸åˆ€æµå…¨åœ–">
            </div>
        </div>
        <!-- å¦å…‹ -->
        <div class="class-card" onclick="selectSinglePlayerClass('tank')">
            <img src="https://i.ibb.co/ZR4Z2ZDT/image.png" class="class-icon">
            <div class="selected-tick">âœ“</div>
            <h3>éµç”²å®—</h3>
            <p>é˜²ç¦¦+20% æ”»æ“Š-10%</p>
            <ul class="class-stats">
                <li>ğŸ›¡ï¸ é‡‘é˜ç½©ï¼šæ¯å›åˆè‡ªå‹•æ¢å¾©2%æ°£è¡€</li>
            </ul>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/ZR4Z2ZDT/image.png" alt="éµç”²å®—å…¨åœ–">
            </div>
        </div>
        <!-- åˆºå®¢ -->
        <div class="class-card" onclick="selectSinglePlayerClass('assassin')">
            <img src="https://i.ibb.co/W4V5bX8X/image.png" class="class-icon">
            <div class="selected-tick">âœ“</div>
            <h3>å½±æµæ•™</h3>
            <p>é–ƒé¿+30% é˜²ç¦¦-10%</p>
            <ul class="class-stats">
                <li>ğŸ¯ é¬¼å½±æ­¥ï¼š30%æ©Ÿç‡å®Œå…¨é–ƒé¿å‚·å®³</li>
            </ul>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/W4V5bX8X/image.png" alt="å½±æµæ•™å…¨åœ–">
            </div>
        </div>
        <!-- æ³•å¸« -->
        <div class="class-card" onclick="selectSinglePlayerClass('mage')">
            <img src="https://i.ibb.co/tM82mXtr/3.png" class="class-icon">
            <div class="selected-tick">âœ“</div>
            <h3>ç„å¤©é–£</h3>
            <p>æ”»æ“Š+10%</p>
            <ul class="class-stats">
                <li>ğŸ”¥ é›¢ç«è¨£ï¼šéŒ¯ç­”å‚·å®³æ‰£æ¸›30%</li>
            </ul>
            <div class="popup-image" style="display: none;">
                <img src="https://i.ibb.co/tM82mXtr/3.png" alt="ç„å¤©é–£å…¨åœ–">
            </div>
        </div>
    </div>
    <div id="singlePlayerSelectedClassInfo" style="margin-top: 2rem;"></div>
</div>

<!-- å–®æ©Ÿæ¨¡å¼é¡Œåº«é¸æ“‡ç•Œé¢ -->
<div id="singlePlayerTopicSelection" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45, 41, 38, 0.95); padding: 2rem; border: none; border-radius: 0; z-index: 9999; overflow-y: auto;">
    <h2 style="color: #d4af37; text-align: center;">é¸æ“‡é¡Œåº«</h2>
    <div id="singlePlayerGradeSelection" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem; width: 300px;">
        <button onclick="selectSinglePlayerGrade('ä¸­ä¸€')" class="grade-btn">ä¸­ä¸€</button>
        <button onclick="selectSinglePlayerGrade('ä¸­äºŒ')" class="grade-btn">ä¸­äºŒ</button>
        <button onclick="selectSinglePlayerGrade('ä¸­ä¸‰')" class="grade-btn">ä¸­ä¸‰</button>
        <button onclick="selectSinglePlayerGrade('ä¸­å››')" class="grade-btn">ä¸­å››</button>
        <button onclick="selectSinglePlayerGrade('ä¸­äº”')" class="grade-btn">ä¸­äº”</button>
        <button onclick="selectSinglePlayerGrade('ã€ä¸­å²ã€‘')" class="grade-btn">ã€ä¸­å²ã€‘</button>
    </div>
    <div id="singlePlayerTopicDetail" style="display: none; margin-top: 1rem;">
        <h3 id="singlePlayerSelectedGrade" style="color: #d4af37; text-align: center;"></h3>
        <div id="singlePlayerTopicList" style="display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem; margin-top: 1rem;"></div>
    </div>
</div>

    
    
<script>


// æª¢æŸ¥æ˜¯å¦åœ¨é›™å€æ™‚æ®µ
function checkDoubleTime() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const isDoubleTime = (hours === 19 && minutes >= 0 && minutes < 60);
    
    const announcement = document.getElementById('doubleTimeAnnouncement');
    if (isDoubleTime) {
        announcement.style.display = 'block';
    } else {
        announcement.style.display = 'none';
    }
}

// é é¢åŠ è¼‰æ™‚ç«‹å³æª¢æŸ¥
checkDoubleTime();

// æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
setInterval(checkDoubleTime, 60000);
    

    function showStoryBackground() {
    document.getElementById('storyModal').style.display = 'block';
}

function hideStoryBackground() {
    document.getElementById('storyModal').style.display = 'none';
}

    // åœ¨ä»£ç å¼€å¤´å®šä¹‰ä¸åŒéš¾åº¦çš„ç»éªŒå¥–åŠ±
const expRewards = {
    easy: 10,
    normal: 30,
    hard: 100,
    hell: 200
};

    let damageInterval;




async function getIpAddress() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        console.error('Error fetching IP address:', error);
        return null;
    }
}

    
// åœ¨ä»£ç å¼€å¤´éƒ¨åˆ†ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„å˜é‡ç”¨äºå­˜å‚¨æç¤ºä¿¡æ¯çš„å…ƒç´ 
    let skillTriggered = false; // åœ¨å¤–éƒ¨è²æ˜ skillTriggered
let singlePlayerClass = null; // å–®æ©Ÿæ¨¡å¼é¸ä¸­çš„è·æ¥­
let singlePlayerSelectedGrade = null; // å–®æ©Ÿæ¨¡å¼é¸ä¸­çš„å¹´ç´š
    let selectedDifficulty = null;
let singlePlayerSelectedTopic = null; // å–®æ©Ÿæ¨¡å¼é¸ä¸­çš„é¡Œåº«
    
    let playerLevel = 1;  // é è¨­ç­‰ç´šç‚º 1
let playerExp = 0;    // é è¨­ç¶“é©—å€¼ç‚º 0
let opponentJoinedMessage = null;
    let isRematching = false;
let answered = false; 
let opponentDefense = 1.0; 
// æ–°å¢å˜é‡
let waitingForOpponent = false; 
    let isAnswered = false; 
    let answeredQuestions = new Set();
    let hasHealedThisTurn = false;
    let selectedGrade = null;
let selectedTopic = null;
let isSelectingTopic = false;

// åœ¨ä»£ç å¼€å¤´éƒ¨åˆ†ï¼Œè·å–æŒ‰é’®å’Œè¾“å…¥æ¡†å…ƒç´ 
const createRoomBtn = document.querySelector('button[onclick="createRoom()"]');
const joinRoomBtn = document.querySelector('button[onclick="joinRoom()"]');
const roomIdInput = document.getElementById('roomId');

    
// ä¿®æ”¹ createRoom å‡½æ•°çš„è°ƒç”¨æ–¹å¼
createRoomBtn.onclick = function() {
    const roomId = roomIdInput.value.trim();
    if (roomId !== "") {
        createRoomWithId(roomId);
    } else {
        joinWaitingQueue();
    }
};

joinRoomBtn.onclick = function() {
    const roomId = roomIdInput.value.trim();
    if (roomId !== "") {
        joinRoomWithId(roomId);
    } else {
        joinWaitingQueue();
    }
};

    
    
function selectClass(className) {
    const classData = {
        warrior: { attack: 1.2, defense: 0.9, dodge: 0, skill: 'doubleDamage' },
        tank: { attack: 0.9, defense: 1.2, dodge: 0, skill: 'heal', healPercentage: 0.02 },
        assassin: { attack: 1.0, defense: 0.9, dodge: 0.3, skill: 'dodge' },
        mage: { attack: 1.1, defense: 1, dodge: 0, skill: 'counter' }
    };

    playerClass = classData[className];
    playerClass.type = className;

    // æ ¹æ“šç­‰ç´šèª¿æ•´å±¬æ€§
    const user = auth.currentUser;
    if (user) {
        database.ref('users/' + user.uid).once('value', (snapshot) => {
            const userData = snapshot.val() || { level: 1, exp: 0 };
            playerLevel = userData.level;
            playerExp = userData.exp;
            playerClass.attack += (playerLevel - 1) * 0.1;  // æ¯ç´šå¢åŠ  0.1 æ”»æ“ŠåŠ›
            playerClass.defense += (playerLevel - 1) * 0.1;  // æ¯ç´šå¢åŠ  0.1 é˜²ç¦¦åŠ›
            const maxHealth = 1000 + (playerLevel - 1) * 100;  // æ¯ç´šå¢åŠ  100 æ°£è¡€
const playerPath = isHost ? 'player1' : 'player2';
database.ref(`rooms/${currentRoomId}/${playerPath}`).update({
    class: className,
    health: maxHealth,
    maxHealth: maxHealth,
    attack: playerClass.attack,
    defense: playerClass.defense,
    dodge: playerClass.dodge,
    level: playerLevel || 1 // ç¢ºä¿ç­‰ç´šè¢«å­˜å„²
});
        });
    }

    // é¸æ“‡åé¥‹ï¼ˆä¿æŒä¸è®Šï¼‰
    document.querySelectorAll('.class-card').forEach(card => {
        card.classList.remove('selected');
        card.querySelector('.selected-tick').style.display = 'none';
    });
    const selectedCard = document.querySelector(`.class-card[onclick="selectClass('${className}')"]`);
    selectedCard.classList.add('selected');
    selectedCard.querySelector('.selected-tick').style.display = 'flex';
    document.getElementById('selectedClassInfo').innerHTML = `
        <p style="font-size:1.5em;color:#2ecc71;">âœ“ å·²é¸æ“‡ï¼š${selectedCard.querySelector('h3').textContent}</p>
        <p>ç­‰å¾…å°æ‰‹é¸æ“‡æµæ´¾...</p>
    `;

    const popupImage = selectedCard.querySelector('.popup-image');
    popupImage.style.display = 'block';
    setTimeout(() => {
        popupImage.style.display = 'none';
    }, 500);
}

    
    function selectGrade(grade) {
    selectedGrade = grade;
    document.getElementById('selectedGrade').textContent = `é¸æ“‡ ${grade} é¡Œåº«`;
    document.getElementById('gradeSelection').style.display = 'none';
    document.getElementById('topicDetail').style.display = 'block';
    
    // æ ¹æ“šå¹´ç´šè¨­ç½®é¡Œåº«
    let topics;
    if (grade === 'ä¸­ä¸€') {
        topics = ['æ¥Šä¿®ä¹‹æ­»','èƒŒå½±','ç‡•è©©','å¾¡äººä¹‹å¦»','æ•…å®®åšç‰©é™¢','é¢¨é›ªä¸­çš„åŒ—å¹³'];
    } else if (grade === 'ä¸­äºŒ') {
        topics = ['å›å®¶','å·®ä¸å¤šå…ˆç”Ÿå‚³','åœ¨é¢¨ä¸­','æ¡ƒèŠ±æºè¨˜','ç‚ºå­¸ä¸€é¦–ç¤ºå­å§ª','æ„›è“®èªª'];
        } else if (grade === 'ä¸­ä¸‰') {
        topics = ['æ°´èª¿æ­Œé ­','çˆ¸çˆ¸çš„èŠ±å…’è½äº†','éˆ·é‰§æ½­è¨˜','æ¶ˆå¤±ä¸­çš„ç‰¹è‰²è¡—é“','å­”æ˜å€Ÿç®­','æœ€è‹¦èˆ‡æœ€æ¨‚'];
    } else if (grade === 'ä¸­å››') {
        topics = ['å±±å±…ç§‹æš','æœˆä¸‹ç¨é…Œ','ç™»æ¨“','è«–ä»è«–å­è«–å›å­','é­šæˆ‘æ‰€æ¬²ä¹Ÿ','å¸«èªª'];
    } else if (grade === 'ä¸­äº”') {
        topics = ['å¿µå¥´å¬Œ','è²è²æ…¢','é’ç‰æ¡ˆ','å²³é™½æ¨“è¨˜', 'å§‹å¾—è¥¿å±±å®´éŠè¨˜', 'å»‰é —è—ºç›¸å¦‚åˆ—å‚³', 'å‡ºå¸«è¡¨', 'é€é™éŠ'];
    } else if (grade === 'ã€ä¸­å²ã€‘') {
        topics = [
            'å–®å…ƒäºŒ ç¬¬äºŒç«  ã€å…©æ¼¢çš„æ”¿æ²»ç™¼å±•å°èˆ‡ä¸­å¤–æ–‡åŒ–äº¤æµã€‘',
            'å–®å…ƒä¸‰ ç¬¬ä¸€ç«  ã€é­æ™‰å—åŒ—æœçš„åˆ†è£‚èˆ‡æ”¿æ¬Šæ›´æ›¿ã€‘'
        ];
    } else {
        topics = []; // é è¨­ç©ºé™£åˆ—ï¼Œé˜²æ­¢æœªå®šç¾©
    }
    const topicList = document.getElementById('topicList');
    topicList.innerHTML = '';
    topics.forEach(topic => {
        const button = document.createElement('button');
        button.textContent = topic;
        button.className = 'topic-btn';
        button.onclick = () => selectTopic(topic);
        topicList.appendChild(button);
    });
}

function selectTopic(topic) {
    selectedTopic = topic;
    database.ref(`rooms/${currentRoomId}`).update({
        selectedGrade: selectedGrade,
        selectedTopic: selectedTopic,
        topicSelected: true
    }).then(() => {
        document.getElementById('topicSelection').style.display = 'none';
        // ç§»é™¤ä»»ä½•å¯èƒ½çš„ç­‰å¾…ä¿¡æ¯
        const waitingMessage = document.getElementById('waitingForTopic');
        if (waitingMessage) waitingMessage.remove();
        startCountdown();
    }).catch(error => {
        console.error('æ›´æ–°é¡Œåº«é¸æ“‡å¤±æ•—:', error);
    });
}
    
 function startCountdown() {
    database.ref(`rooms/${currentRoomId}`).once('value').then(snapshot => {
        const room = snapshot.val();
        // æ·»åŠ æª¢æŸ¥ï¼šç¢ºä¿é¡Œåº«å·²é¸æ“‡ä¸”éŠæˆ²æœªé–‹å§‹
        if (!room || room.countdownStarted || room.gameStarted || !room.topicSelected) {
            console.log('æœªæ»¿è¶³å€’æ•¸æ¢ä»¶ï¼š', {
                countdownStarted: room?.countdownStarted,
                gameStarted: room?.gameStarted,
                topicSelected: room?.topicSelected
            });
            return;
        }

        // è¨­ç½®å€’æ•¸è¨ˆæ™‚é–‹å§‹æ¨™èªŒ
        database.ref(`rooms/${currentRoomId}`).update({ countdownStarted: true });

        let countdown = 3;
        const countdownElement = document.createElement('div');
        countdownElement.id = 'countdown';
        countdownElement.style.position = 'fixed';
        countdownElement.style.top = '0';
        countdownElement.style.left = '0';
        countdownElement.style.width = '100%';
        countdownElement.style.height = '100%';
        countdownElement.style.display = 'flex';
        countdownElement.style.alignItems = 'center';
        countdownElement.style.justifyContent = 'center';
        countdownElement.style.background = 'rgba(45, 41, 38, 0.95)';
        countdownElement.style.color = 'var(--gold)';
        countdownElement.style.fontSize = '10rem';
        countdownElement.style.zIndex = '10001';
        document.body.appendChild(countdownElement);

        function updateCountdown() {
            if (countdown > 0) {
                countdownElement.textContent = countdown;
                countdown--;
                setTimeout(updateCountdown, 1000);
            } else {
                countdownElement.remove();
                // çµæŸå¾Œçµ±ä¸€è¨­ç½®éŠæˆ²é–‹å§‹ä¸¦é‡ç½®å€’æ•¸æ¨™èªŒ
                database.ref(`rooms/${currentRoomId}`).update({
                    gameStarted: true,
                    countdownStarted: false
                });
            }
        }
        updateCountdown();
    });
}

function displayQuestion(question) {
    
     // é‡ç½®ç­”é¢˜çŠ¶æ€
    isAnswered = false; 
    document.getElementById('question').textContent = question.question;

    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';

    question.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.textContent = option;

        // ç‚¹å‡»å¤„ç†é€»è¾‘
        button.onclick = () => {
            if (!isAnswered) {
                isAnswered = true; // è®¾ç½®ä¸ºå·²é€‰æ‹©çŠ¶æ€
                checkAnswer(index === question.correctIndex);
            }
        };

        optionsDiv.appendChild(button);
    });

    startTimer();
}

function checkAnswer(isCorrect, questionId) {
    console.log('checkAnswer called, isCorrect:', isCorrect, 'questionId:', questionId);
    // å¦‚æœå•é¡Œå·²å›ç­”ï¼Œå‰‡é€€å‡º
    if (answeredQuestions.has(questionId)) return;
    answeredQuestions.add(questionId);
    // å¦‚æœå·²å›ç­”æˆ–éŠæˆ²çµæŸï¼Œå‰‡é€€å‡º
    if (answered || gameOver) return;
    answered = true;
    clearInterval(timer);
    // æ¨£å¼è™•ç†ï¼šç¦ç”¨æŒ‰éˆ•ä¸¦é«˜äº®æ­£ç¢ºç­”æ¡ˆ
    const buttons = document.querySelectorAll('#options button');
    const correctIndex = window.currentQuestion.correctIndex;
    buttons.forEach((btn, index) => {
        btn.style.pointerEvents = 'none';
        if (index === correctIndex) {
            btn.style.cssText = `
                background: #2ecc71 !important;
                border: 2px solid #27ae60 !important;
                transform: scale(1.05);
            `;
        }
    });
    // å‚·å®³è¨ˆç®—
    let baseDamage;
    if (isCorrect) {
        baseDamage = Math.floor(Math.random() * 31) + 50; // 50-80 é»
    } else {
        // ä¿®æ”¹éƒ¨åˆ†ï¼šæ ¹æ“šç©å®¶ç­‰ç´šèª¿æ•´éŒ¯ç­”å‚·å®³
        const levelAdjustedBaseDamage = 50 + (playerLevel - 1) * 5; // æ¯ç´šå¢åŠ  5 é»
        baseDamage = Math.floor(Math.random() * 31) + levelAdjustedBaseDamage; // ä¿æŒéš¨æ©Ÿç¯„åœ
    }
    // éœ¸åˆ€é–€é›™å€æ”»æ“Šï¼ˆ30% æ¦‚ç‡ï¼‰
    if (playerClass.type === 'warrior' && isCorrect && Math.random() < 0.3) {
        baseDamage *= 2;
        const swordFlash = document.createElement('div');
        swordFlash.className = 'sword-flash';
        swordFlash.style.top = `${Math.random() * 40 + 30}%`;
        document.body.appendChild(swordFlash);
        setTimeout(() => swordFlash.remove(), 400);
        showSkillEffect();
        soundEffects.warriorSkill.play();
        skillTriggered = true;
    } else if (isCorrect) {
        soundEffects.attack.play();
    }
    // éœ‡å‹•æ•ˆæœ
    if (navigator.vibrate) {
        navigator.vibrate(200);
    }
    // å½±æµæ•™é–ƒé¿ï¼ˆ30% æ¦‚ç‡ï¼‰ï¼Œåœ¨ç­”éŒ¯æ™‚
    if (playerClass.type === 'assassin' && !isCorrect && Math.random() < 0.3) {
        baseDamage = 0;
        const dodgeDisplay = document.getElementById('dodgeText');
        dodgeDisplay.style.display = 'block';
        setTimeout(() => dodgeDisplay.style.display = 'none', 1000);
    }
    // å¾è³‡æ–™åº«ç²å–æˆ¿é–“æ•¸æ“šä¸¦è™•ç†æ°£è¡€æ›´æ–°
    database.ref('rooms/' + currentRoomId).once('value').then(snapshot => {
        const room = snapshot.val();
        if (!room) return;
        const playerPath = isHost ? 'player1' : 'player2';
        const opponentPath = isHost ? 'player2' : 'player1';
        const playerData = room[playerPath];
        const opponentData = room[opponentPath];
        const maxHealth = playerData.maxHealth;

        let playerHealth = playerData.health;
        let opponentHealth = opponentData.health;

        if (isCorrect) {
            let damageToOpponent = Math.floor(baseDamage * playerClass.attack / opponentData.defense);
            // å½±æµæ•™ç­”å°æ™‚æœ‰30%æ©Ÿç‡ä¸é€ æˆå‚·å®³ï¼ˆé–ƒé¿æ•ˆæœï¼‰
            if (playerClass.type === 'assassin' && Math.random() < 0.3) {
                damageToOpponent = 0;
                // è¨˜éŒ„é–ƒé¿äº‹ä»¶ä»¥é€šçŸ¥å°æ–¹é¡¯ç¤ºé–ƒé¿æç¤º
                database.ref(`rooms/${currentRoomId}/dodgeEvent`).set({
                    target: opponentPath, // ç›®æ¨™æ˜¯å°æ–¹
                    timestamp: Date.now()
                });
            }
            if (damageToOpponent > 0) {
                opponentHealth = Math.max(0, opponentHealth - damageToOpponent);
                showDamageAnimation(damageToOpponent, 'enemy');
            }
        } else {
            // å‹•æ…‹èª¿æ•´é˜²ç¦¦åŠ›ï¼šéµç”²å®—éŒ¯ç­”æ™‚ä½¿ç”¨1.0ï¼Œå…¶ä»–è·æ¥­ä½¿ç”¨åŸå§‹é˜²ç¦¦åŠ›
            const selfDefense = playerClass.type === 'tank' ? 1.0 : playerClass.defense;
            let damageToPlayer = Math.floor(baseDamage / selfDefense);
            if (playerClass.type === 'mage') {
                // é¡¯ç¤º reduceDamageText å’Œå‹•ç•«
                const reduceAnimation = document.getElementById('reduceDamageAnimation');
                reduceAnimation.style.display = 'block';
                // 2ç§’å¾Œéš±è— reduceDamageText å’Œå‹•ç•«
                setTimeout(() => {
                    reduceAnimation.style.display = 'none';
                }, 2000);
                damageToPlayer = Math.floor(damageToPlayer * 0.7);
            }
            // 1. å…ˆæ‰£æ¸›ç©å®¶çš„æ°£è¡€
            playerHealth = Math.max(0, playerHealth - damageToPlayer);
            showDamageAnimation(damageToPlayer, 'player');

            // 2. æª¢æŸ¥éŠæˆ²æ˜¯å¦å› ç©å®¶æ°£è¡€ä½æ–¼æˆ–ç­‰æ–¼0è€ŒçµæŸ
            if (playerHealth <= 0) {
                const updates = {
                    gameEnded: true,
                    winner: opponentPath // å°æ‰‹ç²å‹
                };
                database.ref('rooms/' + currentRoomId).update(updates);
                return; // çµ‚æ­¢å¾ŒçºŒé‚è¼¯
            }

            // 3. å¦‚æœéŠæˆ²æœªçµæŸï¼Œæ‡‰ç”¨éµç”²å®—çš„æ¢å¾©æ•ˆæœ
            if (playerClass.type === 'tank' && !hasHealedThisTurn) {
                hasHealedThisTurn = true;
                const healAmount = Math.round(maxHealth * 0.02);
                playerHealth = Math.min(maxHealth, playerHealth + healAmount);
                showHealAnimation(healAmount, 'player'); // é¡¯ç¤ºæ¢å¾©å‹•ç•«
                // UI æ›´æ–°ï¼šé¡¯ç¤ºè­·ç›¾åœ–æ¨™
                const myHealthElement = document.getElementById('myHealth');
                const shieldIcon = document.createElement('span');
                shieldIcon.className = 'shield-icon';
                shieldIcon.innerHTML = 'ğŸ›¡ï¸';
                myHealthElement.appendChild(shieldIcon);
                setTimeout(() => shieldIcon.remove(), 1000);
                console.log('Tank heal triggered, healAmount:', healAmount);
            }
        }

        // æ›´æ–°æ°£è¡€åˆ°è³‡æ–™åº«
        const updates = {};
        updates[`${playerPath}/health`] = playerHealth;
        updates[`${opponentPath}/health`] = opponentHealth;

        // å†æ¬¡æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸï¼ˆä¾‹å¦‚ï¼Œå°æ‰‹æ°£è¡€é™è‡³0ï¼‰
        if (opponentHealth <= 0) {
            updates['gameEnded'] = true;
            updates['winner'] = playerPath; // ç©å®¶ç²å‹
        }

        database.ref('rooms/' + currentRoomId).update(updates).then(() => {
            // å‹•ç•«æ•ˆæœ
            const targetElement = isCorrect ? document.getElementById('opponentHealthBar') : document.getElementById('myHealthBar');
            targetElement.classList.add('damage-flash');
            document.getElementById('gameArea').classList.add('screen-shake');
            document.querySelectorAll('.health-fill').forEach(bar => bar.classList.add('damage-effect'));
            // ç§»é™¤å‹•ç•«
            setTimeout(() => {
                targetElement.classList.remove('damage-flash');
                document.getElementById('gameArea').classList.remove('screen-shake');
                document.querySelectorAll('.health-fill').forEach(bar => bar.classList.remove('damage-effect'));
            }, 500);
            // ç‰¹æ•ˆå…ƒç´ 
            let effectElement = document.createElement('div');
            if (playerClass.type === 'warrior' && isCorrect) {
                effectElement.className = 'sword-animation';
                effectElement.style.background = 'linear-gradient(90deg, transparent 0%, rgba(255,215,0,0.7) 50%, transparent 100%)';
                effectElement.style.width = '150px';
                effectElement.style.height = '30px';
                effectElement.style.position = 'fixed';
                effectElement.style.top = '50%';
            } else if (playerClass.type === 'tank' && !isCorrect) {
                effectElement.className = 'shield-animation';
                effectElement.innerHTML = 'ğŸ›¡ï¸';
                effectElement.style.fontSize = '4rem';
                effectElement.style.position = 'fixed';
                effectElement.style.left = '50%';
                effectElement.style.transform = 'translateX(-50%)';
            }
            if (effectElement.className) {
                document.body.appendChild(effectElement);
                setTimeout(() => effectElement.remove(), 1000);
            }
            // å¾ŒçºŒç‰¹æ•ˆ
            setTimeout(() => {
                const buttons = document.querySelectorAll('#options button');
                const correctIndex = window.currentQuestion.correctIndex;
                if (buttons[correctIndex]) {
                    buttons[correctIndex].style.cssText = `
                        background: #2ecc71 !important;
                        border: 2px solid #27ae60 !important;
                        transform: scale(1.05);
                    `;
                }
            }, 50);
            const flash = document.createElement('div');
            flash.className = 'sword-flash';
            const startX = isHost ? '20%' : '80%';
            flash.style.left = startX;
            flash.style.top = `${Math.random() * 40 + 30}%`;
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 400);
            if (!isCorrect) {
                flash.style.background = `linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,100,100,0.7) 50%, rgba(255,255,255,0) 100%)`;
            }
            const gameArea = document.getElementById('gameArea');
            gameArea.style.boxShadow = `0 0 30px ${isCorrect ? '#2ecc71' : '#e74c3c'}`;
            setTimeout(() => gameArea.style.boxShadow = '0 0 20px var(--gold)', 300);
            const healthBar = isCorrect ? document.getElementById('opponentHealthBar') : document.getElementById('myHealthBar');
            const wave = document.createElement('div');
            wave.className = 'health-wave';
            wave.style.background = `linear-gradient(90deg, transparent 0%, ${isCorrect ? 'rgba(46,204,113,0.3)' : 'rgba(231,76,60,0.3)'} 50%, transparent 100%)`;
            healthBar.appendChild(wave);
            setTimeout(() => wave.remove(), 500);
        }).catch(error => {
            console.error('Failed to update room data:', error);
        });
    }).catch(error => {
        console.error('Failed to fetch room data:', error);
    });
    // é‡ç½®æŒ‰éˆ•ä¸¦åŠ è¼‰æ–°å•é¡Œ
    setTimeout(() => {
        const buttons = document.querySelectorAll('#options button');
        buttons.forEach(btn => {
            btn.style.cssText = '';
            btn.style.pointerEvents = 'auto';
        });
        answered = false;
        // åƒ…åœ¨éŠæˆ²æœªçµæŸæ™‚åŠ è¼‰æ–°å•é¡Œ
        database.ref('rooms/' + currentRoomId).once('value').then(snapshot => {
            const room = snapshot.val();
            if (!room.gameEnded) {
                loadNewQuestion();
            }
        });
    }, 700);
}

function showDodgeText() {
    const dodgeText = document.getElementById('dodgeText');
    const dodgeAnimation = document.getElementById('dodgeAnimation');
    
    dodgeText.style.display = 'block';      // é¡¯ç¤ºé–ƒé¿æ–‡å­—
    dodgeAnimation.style.display = 'block'; // åŒæ™‚é¡¯ç¤ºå‹•ç•«
    
    setTimeout(() => {
        dodgeText.style.display = 'none';      // 1ç§’å¾Œéš±è—æ–‡å­—
        dodgeAnimation.style.display = 'none'; // åŒæ™‚éš±è—å‹•ç•«
    }, 1300); // 1000æ¯«ç§’ = 1ç§’ï¼Œèˆ‡åŸæœ‰çš„å‹•ç•«æŒçºŒæ™‚é–“ä¸€è‡´
}


    

// å°‡è³‡æ–™åº«æ›´æ–°é‚è¼¯æå–ç‚ºç¨ç«‹å‡½æ•¸
function performDatabaseUpdate(updates) {
    console.log('Performing database update with:', updates);
    database.ref('rooms/' + currentRoomId).update(updates, (error) => {
        if (error) {
            console.error('Database update failed:', error);
            alert('æ›´æ–°éŠæˆ²ç‹€æ…‹å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
            // å³ä½¿æ›´æ–°å¤±æ•—ï¼Œä¹Ÿé‡ç½®æŒ‰éˆ•ä¸¦ç¹¼çºŒéŠæˆ²
            resetButtonsAndProceed();
            return;
        }
        console.log('Database update successful');
        checkGameOver();
        if (!gameOver) {
            resetButtonsAndProceed();
        }
    });
}

// é‡ç½®æŒ‰éˆ•ä¸¦åŠ è¼‰æ–°å•é¡Œ
function resetButtonsAndProceed() {
    console.log('Resetting button styles and answered state');
    const buttons = document.querySelectorAll('#options button');
    setTimeout(() => {
        buttons.forEach(btn => {
            btn.style.cssText = '';
            btn.style.pointerEvents = 'auto';
        });
        answered = false;
        loadNewQuestion();
    }, 700);
}

    
// å®šç¾© showSkillEffect å‡½æ•¸ï¼Œæ§åˆ¶ GIF é¡¯ç¤ºèˆ‡éš±è—
function showSkillEffect(damage) {
    // ç²å– skillEffect å’Œæ•µæ–¹æ°£è¡€å®¹å™¨å…ƒç´ 
    const skillEffect = document.getElementById('skillEffect');
    const enemyHealthContainer = document.getElementById('enemyHealthContainer');
    
    // ç²å–æ•µæ–¹æ°£è¡€å®¹å™¨çš„ä½ç½®
    const rect = enemyHealthContainer.getBoundingClientRect();
    
    // è¨­ç½® skillEffect çš„ä½ç½®ç‚ºçµ•å°å®šä½ï¼Œç§»åˆ°æ•µæ–¹æ°£è¡€é™„è¿‘
    skillEffect.style.position = 'absolute';
    skillEffect.style.top = `${rect.top + window.scrollY}px`; // è€ƒæ…®æ»¾å‹•åç§»
    skillEffect.style.center = `${rect.center + window.scrollX}px`;
    
    // é¡¯ç¤º GIF
    skillEffect.innerHTML = '<img src="https://i.ibb.co/LXNDBBgD/image.gif" alt="Skill Effect">';
    
    // é¡¯ç¤ºæ•ˆæœ
    skillEffect.style.display = 'block';
    
    // å®šæ™‚éš±è—ä¸¦æ¸…ç©ºå…§å®¹
    setTimeout(() => {
        skillEffect.style.display = 'none';
        skillEffect.innerHTML = ''; // æ¸…ç©ºå…§å®¹ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨
    }, 2300); // é¡¯ç¤º 1.3 ç§’ï¼Œå¯æ ¹æ“š GIF æ™‚é•·èª¿æ•´
}
    
    
// ä¿®æ”¹ updateHealthDisplay å‡½æ•¸
function updateHealthDisplay(room) {
    const user = auth.currentUser;
    if (!user) return;

    const playerPath = isHost ? 'player1' : 'player2';
    const opponentPath = isHost ? 'player2' : 'player1';

    const myMaxHealth = room[playerPath]?.maxHealth || 1000;
    const opponentMaxHealth = room[opponentPath]?.maxHealth || 1000;
    const myHealth = Math.max(room[playerPath]?.health || 0, 0);
    const opponentHealth = Math.max(room[opponentPath]?.health || 0, 0);

    const myHealthPercentage = (myHealth / myMaxHealth) * 100;
    const opponentHealthPercentage = (opponentHealth / opponentMaxHealth) * 100;

    // æ›´æ–°å·±æ–¹é¡¯ç¤º
    document.getElementById('myHealthContainer').innerHTML = `
        <div>${user.displayName || 'æœªçŸ¥ç©å®¶'} (ç­‰ç´š ${playerLevel || 1}) æ°£è¡€: <span id="myHealth">${myHealth} / ${myMaxHealth}</span></div>
        <div class="health-bar"><div class="health-fill" id="myHealthBar" style="width: ${myHealthPercentage}%"></div></div>
    `;

    // æ›´æ–°æ•µæ–¹é¡¯ç¤º
    const opponentData = room[opponentPath];
    if (opponentData && opponentData.userId) {
        // å¾ Firebase ç”¨æˆ¶æ•¸æ“šåº«ç²å–å°æ–¹åç¨±å’Œç­‰ç´š
        database.ref('users/' + opponentData.userId).once('value').then(snapshot => {
            const userData = snapshot.val() || {};
            const opponentName = userData.displayName || opponentData.name || 'æœªçŸ¥ç©å®¶';
            const opponentLevel = userData.level || opponentData.level || 1;

            document.getElementById('enemyHealthContainer').innerHTML = `
                <div>${opponentName} (ç­‰ç´š ${opponentLevel}) æ°£è¡€: <span id="opponentHealth">${opponentHealth} / ${opponentMaxHealth}</span></div>
                <div class="health-bar"><div class="health-fill" id="opponentHealthBar" style="width: ${opponentHealthPercentage}%"></div></div>
            `;
        }).catch(error => {
            console.error('ç²å–å°æ–¹ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
            document.getElementById('enemyHealthContainer').innerHTML = `
                <div>æœªçŸ¥ç©å®¶ (ç­‰ç´š 1) æ°£è¡€: <span id="opponentHealth">${opponentHealth} / ${opponentMaxHealth}</span></div>
                <div class="health-bar"><div class="health-fill" id="opponentHealthBar" style="width: ${opponentHealthPercentage}%"></div></div>
            `;
        });
    } else {
        document.getElementById('enemyHealthContainer').innerHTML = `
            <div>ç­‰å¾…ç©å®¶åŠ å…¥... æ°£è¡€: <span id="opponentHealth">${opponentHealth} / ${opponentMaxHealth}</span></div>
            <div class="health-bar"><div class="health-fill" id="opponentHealthBar" style="width: ${opponentHealthPercentage}%"></div></div>
        `;
    }
}
    

function stopDangerAlert() {
    document.getElementById('gameArea').classList.remove('danger-pulse');
    soundEffects.lowHealth.pause();
}

    
const firebaseConfig = {
  apiKey: "AIzaSyB6MC_t2CXC1HG-QLjZ7lYk-pYJFp3PSjw",
  authDomain: "for-test2-dd394.firebaseapp.com",
  databaseURL: "https://for-test2-dd394-default-rtdb.firebaseio.com",
  projectId: "for-test2-dd394",
  storageBucket: "for-test2-dd394.firebasestorage.app",
  messagingSenderId: "348250219431",
  appId: "1:348250219431:web:60631c8395154270568c82"


};
firebase.initializeApp(firebaseConfig);


    // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            // ç”¨æˆ¶å·²ç™»å…¥
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userName').textContent = user.displayName || 'æœªçŸ¥ç©å®¶';
            document.getElementById('logoutContainer').style.display = 'block';
            document.getElementById('loginBtn').parentElement.style.display = 'none';

            // æ›´æ–°ç¶“é©—å€¼é¡¯ç¤º
            updateExpDisplay();
        } else {
            // ç”¨æˆ¶æœªç™»å…¥
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('logoutContainer').style.display = 'none';
            document.getElementById('loginBtn').parentElement.style.display = 'block';
        }
    });

    // æ›´æ–°ç¶“é©—å€¼é¡¯ç¤ºçš„å‡½æ•¸
    function updateExpDisplay() {
        const user = firebase.auth().currentUser;
        if (!user) {
            console.log("ç”¨æˆ¶æœªç™»å…¥ï¼Œç„¡æ³•æ›´æ–°ç¶“é©—å€¼é¡¯ç¤º");
            return;
        }

        const userRef = firebase.database().ref('users/' + user.uid);
        userRef.once('value', (snapshot) => {
            const userData = snapshot.val();
            if (!userData) {
                console.log("ç”¨æˆ¶æ•¸æ“šä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜èªå€¼");
                return;
            }

            // å¾è³‡æ–™åº«ç²å–ç•¶å‰ç¶“é©—å€¼å’Œç­‰ç´šï¼Œè‹¥ç„¡æ•¸æ“šå‰‡è¨­ç‚ºé»˜èªå€¼
            const exp = userData.exp || 0;
            const level = userData.level || 1;

            // å‡è¨­æ¯ç´šæ‰€éœ€ç¶“é©—å€¼ç‚º 100 * ç­‰ç´šï¼ˆå¯æ ¹æ“šéœ€æ±‚èª¿æ•´ï¼‰
            const expRequired = 100 * level;

            // è¨ˆç®—ç¶“é©—å€¼ç™¾åˆ†æ¯”
            const percentage = (exp / expRequired) * 100;

            // è¨ˆç®—å‡ç´šé‚„éœ€çš„ç¶“é©—å€¼
            const remainingExp = expRequired - exp;

            // æ›´æ–°é é¢ä¸Šçš„é¡¯ç¤º
            document.getElementById('expText').textContent = `${exp}/${expRequired} (${percentage.toFixed(1)}%)`;
            document.getElementById('expRemaining').textContent = `å‡ç´šé‚„éœ€ï¼š${remainingExp} ç¶“é©—å€¼`;
            document.getElementById('expFill').style.width = `${percentage}%`;
        }).catch((error) => {
            console.error("ç²å–ç”¨æˆ¶æ•¸æ“šå¤±æ•—:", error);
        });
    }

// ã€Œç™»å…¥ã€æŒ‰éˆ•äº‹ä»¶
document.getElementById('loginBtn').onclick = function() {
    const email = prompt("è«‹è¼¸å…¥éƒµç®±");
    const password = prompt("è«‹è¼¸å…¥éŠæˆ²å¯†ç¢¼");
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            if (!user.displayName) {
                const displayName = prompt("è«‹è¨­ç½®æ‚¨çš„é¡¯ç¤ºåç¨±");
                if (displayName) {
                    user.updateProfile({
                        displayName: displayName
                    }).then(() => {
                        alert("ç™»å…¥æˆåŠŸï¼š" + displayName);
                    }).catch((error) => {
                        alert("è¨­ç½®é¡¯ç¤ºåç¨±å¤±æ•—ï¼š" + error.message);
                    });
                } else {
                    alert("é¡¯ç¤ºåç¨±ä¸èƒ½ç‚ºç©º");
                    return;
                }
            } else {
                alert("ç™»å…¥æˆåŠŸï¼š" + user.displayName);
            }
            document.getElementById('loginBtn').style.display = 'none';
        })
        .catch((error) => {
            alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
        });
};

// ã€Œæ³¨å†Šã€æŒ‰éˆ•äº‹ä»¶ï¼ˆæ–°ä½ç½®ï¼‰
document.getElementById('registerBtn').onclick = function() {
    const email = prompt("è«‹è¼¸å…¥éƒµç®±");
    const password = prompt("è«‹è¼¸å…¥å¯†ç¢¼");
    const displayName = prompt("è«‹è¼¸å…¥æ‚¨çš„é¡¯ç¤ºåç¨±");
    if (!email || !password || !displayName) {
        alert("éƒµç®±ã€å¯†ç¢¼å’Œé¡¯ç¤ºåç¨±ä¸èƒ½ç‚ºç©º");
        return;
    }

    const displayNamesRef = database.ref('displayNames');
    displayNamesRef.child(displayName).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                alert("è©²é¡¯ç¤ºåç¨±å·²è¢«ä½¿ç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–åç¨±");
                return Promise.reject("é¡¯ç¤ºåç¨±å·²å­˜åœ¨");
            } else {
                return auth.createUserWithEmailAndPassword(email, password);
            }
        })
        .then((userCredential) => {
            const user = userCredential.user;
            return user.updateProfile({
                displayName: displayName
            }).then(() => {
                // æ·»åŠ åˆ° users ç¯€é»
                return database.ref('users/' + user.uid).set({
                    displayName: displayName,
                    level: 1,
                    exp: 0,
                    score: 0
                }).then(() => {
                    return displayNamesRef.child(displayName).set(true);
                });
            });
        })
        .then(() => {
            alert("è¨»å†ŠæˆåŠŸï¼š" + displayName);
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('registerBtn').style.display = 'none';
            document.getElementById('logoutContainer').style.display = 'block';
        })
        .catch((error) => {
            if (error === "é¡¯ç¤ºåç¨±å·²å­˜åœ¨") {
                // å·²è™•ç†
            } else if (error.code === 'auth/email-already-in-use') {
                alert("è©²éƒµç®±å·²è¢«è¨»å†Š");
            } else {
                alert("è¨»å†Šå¤±æ•—ï¼š" + error.message);
            }
        });
};

// ç¨ç«‹çš„ç™»å‡ºé‚è¼¯ï¼ˆæ–°å¢ä½ç½®ï¼‰
document.getElementById('logoutBtn').onclick = function() {
    auth.signOut()
        .then(() => {
            alert("å·²ç™»å‡º");
            document.getElementById('loginBtn').style.display = 'inline-block';
            document.getElementById('registerBtn').style.display = 'inline-block';
            document.getElementById('logoutContainer').style.display = 'none';
        })
        .catch((error) => {
            alert("ç™»å‡ºå¤±æ•—ï¼š" + error.message);
        });
};

    


const auth = firebase.auth();
   auth.onAuthStateChanged((user) => {
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');
    const userScore = document.getElementById('userScore');
    const userLevel = document.getElementById('userLevel');
    const expFill = document.getElementById('expFill');

    if (user) {
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('registerBtn').style.display = 'none';
        document.getElementById('logoutContainer').style.display = 'block';
        userInfo.style.display = 'block';
        userName.textContent = user.displayName || 'æœªå‘½åç©å®¶';

        // å¾è³‡æ–™åº«ç²å–è³‡æ–™
      database.ref('users/' + user.uid).once('value', (snapshot) => {
    const userData = snapshot.val() || { level: 1, exp: 0 };
    playerLevel = userData.level; // è¨­ç½®å…¨å±€è®Šé‡
    userLevel.textContent = userData.level;
    const expPercentage = (userData.exp / (100 * userData.level)) * 100;
    expFill.style.width = expPercentage + '%';
});

        database.ref('leaderboard/' + user.uid).once('value', (snapshot) => {
            const data = snapshot.val();
            userScore.textContent = data ? data.score : 0;
        });
    } else {
        document.getElementById('loginBtn').style.display = 'inline-block';
        document.getElementById('registerBtn').style.display = 'inline-block';
        document.getElementById('logoutContainer').style.display = 'none';
        userInfo.style.display = 'none';
    }
});

const database = firebase.database();

    // ä¸Šå‚³å•é¡Œæ™‚æ›´æ–°è¨ˆæ•¸å™¨
function uploadQuestions(grade, topic, questions) {
    const totalQuestions = questions.length;
    database.ref(`questions/${grade}/${topic}/count`).set(totalQuestions);
    questions.forEach((question, index) => {
        database.ref(`questions/${grade}/${topic}/${index}`).set(question);
    });
}

let currentRoomId = null;
let isHost = false;
let timer;
let timeLeft = 15;
let gameOver = false;
let playerClass = null; // å­˜å‚¨ç©å®¶é€‰æ‹©çš„èŒä¸š

const bgMusic = new Audio('https://incompetech.com/music/royalty-free/mp3-royaltyfree/Clash%20Defiant.mp3');
let isMusicPlaying = false;
bgMusic.loop = true;
bgMusic.volume = 0.3;


const soundEffects = {
    attack: new Audio('https://taira-komori.jpn.org/sound_os2/jidaigeki01/Chinese_blade2.mp3'),
    victory: new Audio('https://taira-komori.jpn.org/sound_os2/event01/clapping_short2.mp3'),
    defeat: new Audio('https://taira-komori.jpn.org/sound_os2/jidaigeki01/Chinese_blade2.mp3'),
    warriorSkill: new Audio('https://taira-komori.jpn.org/sound_os2/monster01/dragon_roar.mp3')
};
    soundEffects.warriorSkill.volume = 0.5; // éŸ³é‡è¨­ç‚º 50%

    document.addEventListener('DOMContentLoaded', () => {
    soundEffects.warriorSkill.load();
});

    const difficultySettings = {
    easy: { enemyHealth: 1000, damageChance: 0.3, damageInterval: 6000 },
    normal: { enemyHealth: 1500, damageChance: 0.5, damageInterval: 5000 },
    hard: { enemyHealth: 3500, damageChance: 0.7, damageInterval: 4000 },
    hell: { enemyHealth: 5000, damageChance: 0.9, damageInterval: 3000 }
};

// ä¿®æ”¹é‡é» 2ï¼šåˆå§‹æŒ‰éˆ•æ–‡å­—è¨­å®š
document.querySelector('.music-control').textContent = 'ğŸ”‡';  // åŠ å…¥é€™è¡Œåˆå§‹åŒ–è¨­å®š

function toggleMusic() {
   isMusicPlaying = !isMusicPlaying;
    
    // ä¿®æ”¹é‡é» 3ï¼šåè½‰æ’­æ”¾/æš«åœé‚è¼¯
    isMusicPlaying ? bgMusic.play() : bgMusic.pause();
    
    // åè½‰æŒ‰éˆ•é¡¯ç¤ºæ–‡å­—
    document.querySelector('.music-control').textContent = isMusicPlaying ? 'ğŸµ' : '';
}

function createRoom() {
    const roomIdInput = document.getElementById('roomId').value.trim();
    if (roomIdInput.length !== 4) {
        alert('è«‹è¼¸å…¥å››ä½æˆ°å ´ç·¨è™Ÿ');
        return;
    }
    const userId = generateUserId();
    const player1Ref = database.ref('rooms/' + roomIdInput + '/player1');
    player1Ref.set({ userId: userId, health: 100, class: null, currentQuestion: null });
    player1Ref.onDisconnect().remove();
    currentRoomId = roomIdInput;
    isHost = true;
    document.getElementById('roomControl').style.display = 'none';
    document.getElementById('waitingArea').style.display = 'block';
    document.getElementById('displayRoomId').textContent = roomIdInput;
    document.getElementById('classSelection').style.display = 'block';
    listenToRoomChanges();
}

function joinRoom() {
    const roomId = document.getElementById('roomId').value.trim();
    if (roomId.length !== 4) {
        alert('è«‹è¼¸å…¥å››ä½æˆ°å ´ç·¨è™Ÿ');
        return;
    }
    const userId = generateUserId();
    const roomRef = database.ref('rooms/' + roomId);
    roomRef.once('value').then(snapshot => {
        if (snapshot.exists()) {
            const room = snapshot.val();
            if (room.player2) {
                alert('æˆ°å ´å·²æ»¿');
                return;
            }
            const player2Ref = database.ref('rooms/' + roomId + '/player2');
            player2Ref.set({ userId: userId, health: 100, class: null, currentQuestion: null });
            player2Ref.onDisconnect().remove();
            currentRoomId = roomId;
            isHost = false;
            document.getElementById('roomControl').style.display = 'none';
            document.getElementById('waitingArea').style.display = 'block';
            document.getElementById('displayRoomId').textContent = roomId;
            document.getElementById('classSelection').style.display = 'block';
            listenToRoomChanges();
        } else {
            alert('æˆ°å ´ä¸å­˜åœ¨');
        }
    });
}


async function getIpAddress() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        console.error('Error fetching IP address:', error);
        return null;
    }
}

    
   async function createRoomWithId(roomId) {
    const user = auth.currentUser;
    if (!user) {
        alert('è«‹å…ˆç™»å…¥ï¼');
        return;
    }

    const ip = await getIpAddress(); // ç²å–å‰µå»ºè€…çš„ IP åœ°å€
    if (!ip) {
        alert('ç„¡æ³•ç²å–IPåœ°å€ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        return;
    }

    currentRoomId = roomId;
    isHost = true;
    document.getElementById('roomControl').style.display = 'none';
    document.getElementById('classSelection').style.display = 'block';
    document.getElementById('waitingArea').style.display = 'block';
    document.getElementById('displayRoomId').textContent = currentRoomId;

    // è¨­ç½®æˆ¿é–“æ•¸æ“šï¼ŒåŒ…æ‹¬ creatorIp
    await database.ref('rooms/' + currentRoomId).set({
        player1: {
            userId: user.uid,
            name: user.displayName || 'æœªçŸ¥ç©å®¶',
            level: playerLevel || 1,
            health: 100,
            class: null,
            currentQuestion: null
        },
        player2: null,
        gameStarted: false,
        gameEnded: false,
        winner: null,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        creatorIp: ip // æ–°å¢å­—æ®µå­˜å„²å‰µå»ºè€… IP
    }).then(() => {
        // å°‡æˆ¿é–“åŠ å…¥ waitingRooms ä¸¦è¨˜éŒ„ hostId
        database.ref('waitingRooms').set({
            roomId: currentRoomId,
            hostId: user.uid,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });
    }).catch(error => {
        console.error('å‰µå»ºæˆ¿é–“å¤±æ•—:', error);
    });

    listenToRoomChanges();
}

async function joinRoomWithId(roomId) {
    const user = auth.currentUser;
    if (!user) {
        alert('è«‹å…ˆç™»å…¥ï¼');
        return;
    }

    const ip = await getIpAddress(); // ç²å–åŠ å…¥è€…çš„ IP åœ°å€
    if (!ip) {
        alert('ç„¡æ³•ç²å–IPåœ°å€ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        return;
    }

    // å…ˆç²å–æˆ¿é–“è³‡æ–™ä»¥æª¢æŸ¥ UID å’Œ IP
    const roomRef = database.ref('rooms/' + roomId);
    const snapshot = await roomRef.once('value');
    const room = snapshot.val();

    if (!room) {
        alert('æˆ°å ´ä¸å­˜åœ¨ï¼Œè«‹ç¢ºèªç·¨è™Ÿã€‚');
        return;
    }

    if (room.player1 && room.player1.userId === user.uid) {
        alert('ä¸èƒ½åŠ å…¥è‡ªå·±å‰µå»ºçš„æˆ¿é–“');
        return;
    }

    if (room.creatorIp === ip) {
        alert('ä¸èƒ½åŠ å…¥è‡ªå·±é–‹é—¢çš„æˆ°å ´ï¼');
        return;
    }

    if (room.player2) {
        alert('æ­¤æˆ°å ´å·²æ»¿ï¼Œè«‹é¸æ“‡å…¶ä»–æˆ°å ´ã€‚');
        return;
    }

    // åŠ å…¥æˆ¿é–“
    currentRoomId = roomId;
    isHost = false;
    document.getElementById('roomControl').style.display = 'none';
    document.getElementById('classSelection').style.display = 'block';
    listenToRoomChanges();

    const player2Ref = database.ref('rooms/' + currentRoomId + '/player2');
    await player2Ref.set({
        userId: user.uid,
        name: user.displayName || 'æœªçŸ¥ç©å®¶',
        level: playerLevel || 1,
        health: 100,
        class: null,
        currentQuestion: null
    }).then(() => {
        console.log('æˆåŠŸåŠ å…¥æˆ¿é–“:', roomId);
        // å¾ waitingRooms ç§»é™¤è©²æˆ¿é–“
        database.ref('waitingRooms').remove();
    }).catch((error) => {
        console.error("è¨­ç½® player2 å¤±æ•—:", error);
    });
}
    
    function joinWaitingQueue() {
    const user = firebase.auth().currentUser;
    if (!user) {
        alert("è«‹å…ˆç™»å…¥ï¼");
        return;
    }

    const waitingRef = database.ref('waitingRooms');
    const userId = user.uid;

}

   

function checkForMatch() {
    const waitingRef = database.ref('waitingRooms');
    waitingRef.orderByChild('timestamp').limitToFirst(2).once('value', (snapshot) => {
        const waitingPlayers = [];
        snapshot.forEach((childSnapshot) => {
            waitingPlayers.push(childSnapshot.key);
        });

        if (waitingPlayers.length >= 2) {
            const player1 = waitingPlayers[0];
            const player2 = waitingPlayers[1];

            // éš¨æ©Ÿç”Ÿæˆæˆ¿é–“ç·¨è™Ÿ
            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            const roomRef = database.ref('rooms/' + roomId);
            roomRef.set({
                player1: { userId: player1, health: 100, class: null, currentQuestion: null },
                player2: { userId: player2, health: 100, class: null, currentQuestion: null },
                gameStarted: false,
                gameEnded: false,
                winner: null
            });

            // ç§»é™¤é…å°æˆåŠŸçš„ç©å®¶
            waitingRef.child(player1).remove();
            waitingRef.child(player2).remove();

            // æ ¹æ“šç•¶å‰ç”¨æˆ¶é€²å…¥éŠæˆ²
            const userId = firebase.auth().currentUser.uid;
            if (userId === player1) {
                currentRoomId = roomId;
                isHost = true;
                startGameSession();
            } else if (userId === player2) {
                currentRoomId = roomId;
                isHost = false;
                startGameSession();
            }
        }
    });
}

function startGameSession() {
    document.getElementById('roomControl').style.display = 'none';
    document.getElementById('classSelection').style.display = 'block';
    document.getElementById('waitingArea').style.display = 'block';
    document.getElementById('displayRoomId').textContent = currentRoomId;
    listenToRoomChanges();
}


 async function randomMatch() {
    const user = auth.currentUser;
    if (!user) {
        alert('è«‹å…ˆç™»å…¥ï¼');
        return;
    }

    console.log("randomMatch called");
    const waitingRef = database.ref('waitingRooms');
    const userId = user.uid; // ä½¿ç”¨çœŸå¯¦ç”¨æˆ¶ ID

    // ç²å–ç•¶å‰ç©å®¶çš„ IP åœ°å€
    const ip = await getIpAddress();
    if (!ip) {
        alert('ç„¡æ³•ç²å–IPåœ°å€ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥ã€‚');
        return;
    }

    waitingRef.once('value', async (snapshot) => {
        console.log("Waiting data:", snapshot.val());
        const waitingData = snapshot.val();

        if (!waitingData || !waitingData.roomId) {
            // æ²’æœ‰ç­‰å¾…ä¸­çš„æˆ¿é–“ï¼Œå‰µå»ºæ–°æˆ¿é–“
            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            currentRoomId = roomId;
            isHost = true;

            // å°‡ IP åœ°å€å­˜å„²åœ¨æˆ¿é–“æ•¸æ“šä¸­
            database.ref('rooms/' + roomId).set({
                player1: { 
                    userId: userId, 
                    health: 100, 
                    class: null, 
                    currentQuestion: null, 
                    name: user.displayName || 'æœªçŸ¥ç©å®¶',
                    ip: ip // æ–°å¢ IP åœ°å€
                },
                player2: null,
                gameStarted: false,
                gameEnded: false,
                winner: null,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
            waitingRef.set({
                roomId: roomId,
                hostId: userId,
                hostIp: ip, // æ–°å¢ host çš„ IP åœ°å€
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });

            const roomRef = database.ref('rooms/' + roomId);
            roomRef.onDisconnect().remove();
            waitingRef.onDisconnect().remove();

            document.getElementById('roomControl').style.display = 'none';
            document.getElementById('waitingArea').style.display = 'block';
            document.getElementById('displayRoomId').textContent = 'ç­‰å¾…å°æ‰‹...';
            document.getElementById('classSelection').style.display = 'block';

            listenToRoomChanges();
        } else {
            // å­˜åœ¨ç­‰å¾…ä¸­çš„æˆ¿é–“ï¼Œæª¢æŸ¥ IP åœ°å€
            const hostIp = waitingData.hostIp;
            if (hostIp === ip) {
                alert('ä¸èƒ½åŠ å…¥è‡ªå·±å‰µå»ºçš„æˆ¿é–“ï¼ˆIPåœ°å€ç›¸åŒï¼‰');
                return;
            }

            const roomId = waitingData.roomId;
            const hostId = waitingData.hostId;

            // æª¢æŸ¥æˆ¿é–“çš„ hostId æ˜¯å¦èˆ‡ç•¶å‰ç”¨æˆ¶çš„ userId ç›¸åŒ
            if (hostId === userId) {
                alert('ä¸èƒ½åŠ å…¥è‡ªå·±å‰µå»ºçš„æˆ¿é–“');
                return;
            }

            currentRoomId = roomId;
            isHost = false;

            const player2Ref = database.ref('rooms/' + roomId + '/player2');
            player2Ref.set({
                userId: userId, 
                health: 100, 
                class: null, 
                currentQuestion: null, 
                name: user.displayName || 'æœªçŸ¥ç©å®¶',
                ip: ip // æ–°å¢ IP åœ°å€
            }).then(() => {
                waitingRef.remove();
            }).catch((error) => {
                console.error("è¨­ç½® player2 å¤±æ•—:", error);
            });

            player2Ref.onDisconnect().remove();

            document.getElementById('roomControl').style.display = 'none';
            document.getElementById('waitingArea').style.display = 'block';
            document.getElementById('displayRoomId').textContent = 'ç­‰å¾…è§’è‰²é¸æ“‡...';
            document.getElementById('classSelection').style.display = 'block';

            listenToRoomChanges();
        }
    });
}
    

function startNewGameSession() {


    // é‡ç½®æ¸¸æˆçŠ¶æ€
    gameOver = false;
    answered = false;

    database.ref(`rooms/${currentRoomId}/clientEntered`).set(false);

    // æ¸…é™¤æ—§é—®é¢˜æ˜¾ç¤º
    document.getElementById('question').textContent = '';
    document.getElementById('options').innerHTML = '';

    // é‡æ–°åŠ è½½é—®é¢˜
    loadNewQuestion();

    // å¼€å§‹æ–°çš„è®¡æ—¶
    startTimer();
}
    
function updateHealthDisplay(room) {
    const user = auth.currentUser;
    if (!user) return;

    const playerPath = isHost ? 'player1' : 'player2';
    const opponentPath = isHost ? 'player2' : 'player1';

    const myMaxHealth = room[playerPath]?.maxHealth || 1000;
    const opponentMaxHealth = room[opponentPath]?.maxHealth || 1000;
    const myHealth = Math.max(room[playerPath]?.health || 0, 0);
    const opponentHealth = Math.max(room[opponentPath]?.health || 0, 0);

    const myHealthPercentage = (myHealth / myMaxHealth) * 100;
    const opponentHealthPercentage = (opponentHealth / opponentMaxHealth) * 100;

    // æ›´æ–°å·±æ–¹é¡¯ç¤º
    document.getElementById('myHealthContainer').innerHTML = `
        <div>${user.displayName || 'æœªçŸ¥ç©å®¶'} (ç­‰ç´š ${playerLevel || 1}) æ°£è¡€: <span id="myHealth">${myHealth} / ${myMaxHealth}</span></div>
        <div class="health-bar"><div class="health-fill" id="myHealthBar" style="width: ${myHealthPercentage}%"></div></div>
    `;

    // æ›´æ–°æ•µæ–¹é¡¯ç¤º
    const opponentData = room[opponentPath];
    if (opponentData) {
        const opponentName = opponentData.name || 'æœªçŸ¥ç©å®¶';
        const opponentLevel = opponentData.level || 1;
        document.getElementById('enemyHealthContainer').innerHTML = `
            <div>${opponentName} (ç­‰ç´š ${opponentLevel}) æ°£è¡€: <span id="opponentHealth">${opponentHealth} / ${opponentMaxHealth}</span></div>
            <div class="health-bar"><div class="health-fill" id="opponentHealthBar" style="width: ${opponentHealthPercentage}%"></div></div>
        `;
    } else {
        document.getElementById('enemyHealthContainer').innerHTML = `
            <div>ç­‰å¾…ç©å®¶åŠ å…¥... æ°£è¡€: <span id="opponentHealth">${opponentHealth} / ${opponentMaxHealth}</span></div>
            <div class="health-bar"><div class="health-fill" id="opponentHealthBar" style="width: ${opponentHealthPercentage}%"></div></div>
        `;
    }
}

function startGame(room) {
    if (!room.player1 || !room.player2) {
        console.log('ç­‰å¾…å°æ‰‹åŠ å…¥...');
        return;
    }

    if (!room.topicSelected) {
        const selector = room.topicSelector;
        if (!selector) {
            const newSelector = Math.random() < 0.5 ? 'player1' : 'player2';
            database.ref(`rooms/${currentRoomId}`).update({
                topicSelector: newSelector
            });
            return;
        }

        if ((isHost && selector === 'player1') || (!isHost && selector === 'player2')) {
            isSelectingTopic = true;
            document.getElementById('topicSelection').style.display = 'block';
            // ç¢ºä¿ç§»é™¤å¯èƒ½å­˜åœ¨çš„ç­‰å¾…é é¢
            const existingWaitingMessage = document.getElementById('waitingForTopic');
            if (existingWaitingMessage) {
                existingWaitingMessage.remove();
            }
        } else {
            isSelectingTopic = false;
            // åƒ…åœ¨éé¡Œåº«é¸æ“‡è€…æ™‚é¡¯ç¤ºç­‰å¾…é é¢ï¼Œä¸”é¿å…é‡è¤‡å‰µå»º
            let waitingMessage = document.getElementById('waitingForTopic');
            if (!waitingMessage) {
                waitingMessage = document.createElement('div');
                waitingMessage.id = 'waitingForTopic';
                waitingMessage.style.position = 'fixed';
                waitingMessage.style.top = '0';
                waitingMessage.style.left = '0';
                waitingMessage.style.width = '100%';
                waitingMessage.style.height = '100%';
                waitingMessage.style.display = 'flex';
                waitingMessage.style.alignItems = 'center';
                waitingMessage.style.justifyContent = 'center';
                waitingMessage.style.background = 'rgba(45, 41, 38, 0.95)';
                waitingMessage.style.color = 'var(--gold)';
                waitingMessage.style.fontSize = '2rem';
                waitingMessage.style.textAlign = 'center';
                waitingMessage.style.padding = '2rem';
                waitingMessage.style.boxShadow = '0 0 20px rgba(212, 175, 55, 0.5)';
                waitingMessage.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.7)';
                waitingMessage.style.zIndex = '10000';
                waitingMessage.textContent = 'ç­‰å¾…ç©å®¶é¸æ“‡é¡Œåº«...';
                document.body.appendChild(waitingMessage);
            }
        }
   } else {
        // ç§»é™¤ç­‰å¾…é é¢
        const waitingMessage = document.getElementById('waitingForTopic');
        if (waitingMessage) waitingMessage.remove();

        document.getElementById('gameArea').style.display = 'block';
        const playerPath = isHost ? 'player1' : 'player2';
        const question = room[playerPath].currentQuestion;
        if (!question) {
            loadNewQuestion();
        } else {
            displayQuestion(question);
        }
    }
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function loadNewQuestion() {
    hasHealedThisTurn = false; // é‡ç½®æ¢å¾©ç‹€æ…‹ï¼Œç¢ºä¿æ¯å›åˆé‡æ–°è¨ˆç®—

    // å¾æ•¸æ“šåº«ç²å–é¸æ“‡çš„é¡Œåº«
    database.ref(`rooms/${currentRoomId}`).once('value').then(snapshot => {
        const room = snapshot.val();
        const grade = room.selectedGrade;
        const topic = room.selectedTopic;

        // ç²å–å•é¡Œç¸½æ•¸
        database.ref(`questions/${grade}/${topic}/count`).once('value').then(snapshot => {
            const totalQuestions = snapshot.val();
            if (!totalQuestions || totalQuestions <= 0) {
                console.error('é¡Œåº«ä¸­ç„¡å•é¡Œæˆ–è¨ˆæ•¸å™¨æœªè¨­ç½®');
                return;
            }

            // éš¨æ©Ÿé¸æ“‡ä¸€å€‹å•é¡Œ ID
            const randomId = Math.floor(Math.random() * totalQuestions);

            // åŠ è¼‰å–®å€‹å•é¡Œ
            database.ref(`questions/${grade}/${topic}/${randomId}`).once('value').then(snapshot => {
                const originalQuestion = snapshot.val();
                if (!originalQuestion) {
                    console.error('ç„¡æ³•æ‰¾åˆ°è©²å•é¡Œæ•¸æ“š');
                    return;
                }

                // è™•ç†å•é¡Œæ•¸æ“š
                const optionsCopy = [...originalQuestion.options];
                const correctAnswer = optionsCopy[originalQuestion.correctIndex];
                const shuffledOptions = shuffleArray(optionsCopy);
                const newCorrectIndex = shuffledOptions.indexOf(correctAnswer);

                const processedQuestion = {
                    question: originalQuestion.question,
                    options: shuffledOptions,
                    correctIndex: newCorrectIndex,
                    id: Date.now()
                };

                // æ›´æ–°ç•¶å‰å•é¡Œ
                currentQuestionId = processedQuestion.id;
                const playerPath = isHost ? 'player1' : 'player2';
                database.ref('rooms/' + currentRoomId + '/' + playerPath).update({
                    currentQuestion: processedQuestion
                });

                // é¡¯ç¤ºå•é¡Œ
                displayQuestion(processedQuestion);
            }).catch(error => {
                console.error('ä¸‹è¼‰å•é¡Œæ•¸æ“šæ™‚å‡ºéŒ¯:', error);
            });
        }).catch(error => {
            console.error('ç²å–å•é¡Œç¸½æ•¸æ™‚å‡ºéŒ¯:', error);
        });
    });
}

function displayQuestion(question) {
    this.answered = false; // é‡ç½®ç­”é¡Œç‹€æ…‹
    window.currentQuestion = question;
    document.getElementById('question').textContent = question.question;
    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';
    
    question.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.textContent = option;
        button.setAttribute('data-question-id', question.id); // è¨­ç½®å•é¡ŒID
        button.onclick = () => {
            if (!answeredQuestions.has(question.id)) { // æª¢æŸ¥æ˜¯å¦å·²å›ç­”
                checkAnswer(index === question.correctIndex, question.id);
            }
        };
        optionsDiv.appendChild(button);
    });
    startTimer();
}


function startTimer() {
    clearInterval(timer);
    // æ–°å¢ä»¥ä¸‹å…©è¡Œé‡ç½®å‹•ç•«ç‹€æ…‹
    document.getElementById('gameArea').classList.remove('screen-shake');
    document.querySelectorAll('.health-fill').forEach(bar => bar.classList.remove('damage-effect'));
    timeLeft = 15;
    document.getElementById('timer').textContent = `ğŸ•’${timeLeft}ç§’`;
    timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = `ğŸ•’${timeLeft}ç§’`;
        if (timeLeft <= 0) checkAnswer(false);
    }, 1000);
}

function checkGameOver() {
    const roomRef = database.ref('rooms/' + currentRoomId);
    roomRef.once('value').then(snapshot => {
        const room = snapshot.val();
        if (!room) return;

        // æ–°å¢è¡€é‡ä¸‹é™è™•ç†
        const player1Health = Math.max(room.player1?.health || 0, 0);
        const player2Health = Math.max(room.player2?.health || 0, 0);

        let winner = null;
        if (player1Health <= 0 || player2Health <= 0) {
            if (player1Health > player2Health) {
                winner = 'player1';
            } else if (player2Health > player1Health) {
                winner = 'player2';
            } else {
                winner = 'draw';
            }

            // æ–°å¢å¼·åˆ¶è¡€é‡æ­¸é›¶
            const updates = {
                gameEnded: true,
                winner: winner,
                'player1/health': player1Health,
                'player2/health': player2Health
            };

            roomRef.update(updates, () => {
                // æ–°å¢ç›´æ¥è§¸ç™¼çµæŸè™•ç†
                handleGameEnd(winner);
            });
        }
    });
}

function handleGameEnd(winnerType) {
    if (gameOver) return;
    gameOver = true;

    // ç²å–ç•¶å‰æ™‚é–“
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();

    // æª¢æŸ¥æ˜¯å¦åœ¨æ™šä¸Š7æ™‚è‡³8æ™‚ (19:00 - 20:00)
    const isDoubleTime = (hours === 19 && minutes >= 0 && minutes < 60);

    // å®šç¾©åŸºç¤ç©åˆ†å’Œç¶“é©—å€¼è®ŠåŒ–
    const currentPlayerPath = isHost ? 'player1' : 'player2';
    const opponentPath = isHost ? 'player2' : 'player1';
    const roomRef = database.ref('rooms/' + currentRoomId);

    roomRef.once('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) return;

        const currentPlayerLevel = room[currentPlayerPath]?.level || 1;
        const opponentLevel = room[opponentPath]?.level || 1;
        const levelDifference = Math.abs(currentPlayerLevel - opponentLevel);
        const isWinner = (winnerType === currentPlayerPath);

        // æ ¹æ“šç­‰ç´šå·®è·è¨ˆç®—åŸºç¤ç©åˆ†è®ŠåŒ–
        let baseScoreChange = 0;
        if (winnerType !== 'draw') {
            if (levelDifference <= 2) {
                baseScoreChange = isWinner ? 100 : -50;
            } else if (levelDifference >= 3 && levelDifference <= 5) {
                baseScoreChange = isWinner
                    ? (currentPlayerLevel >= opponentLevel ? 50 : 150)
                    : (currentPlayerLevel >= opponentLevel ? -150 : -20);
            } else if (levelDifference >= 6) {
                baseScoreChange = isWinner
                    ? (currentPlayerLevel >= opponentLevel ? 10 : 200)
                    : (currentPlayerLevel >= opponentLevel ? -200 : -10);
            }
        }

        // åŸºç¤ç¶“é©—å€¼è®ŠåŒ–
        let baseExpChange = isWinner ? 50 : 20;

        // æ‡‰ç”¨é›™å€é‚è¼¯ï¼ˆè¼¸çš„æƒ…æ³ä¸é›™å€ç©åˆ†æå¤±ï¼‰
        let scoreChange = baseScoreChange;
        let expChange = baseExpChange;
        if (isDoubleTime) {
            if (isWinner || winnerType === 'draw') {
                scoreChange = baseScoreChange * 2; // å‹åˆ©æˆ–å¹³å±€æ™‚ç©åˆ†é›™å€
                expChange = baseExpChange * 2;     // ç¶“é©—å€¼é›™å€
            } else {
                expChange = baseExpChange * 2;     // è¼¸æ™‚ç¶“é©—å€¼é›™å€ï¼Œç©åˆ†æå¤±ä¸è®Š
            }
        }

        // æ›´æ–°ç”¨æˆ¶æ•¸æ“š
        const user = auth.currentUser;
        if (!user) return;

        const userRef = database.ref('users/' + user.uid);
        userRef.transaction((userData) => {
            if (!userData) userData = { level: 1, exp: 0, score: 0 };

            // æ‡‰ç”¨ç©åˆ†è®ŠåŒ–
            userData.score = Math.max(0, (userData.score || 0) + scoreChange);

            // æ‡‰ç”¨ç¶“é©—å€¼è®ŠåŒ–
            userData.exp += expChange;

            // ç­‰ç´šæå‡é‚è¼¯
            const expRequired = 100 * userData.level;
            while (userData.exp >= expRequired) {
                userData.level += 1;
                userData.exp -= expRequired;
            }

            return userData;
        }).then(() => {
            userRef.once('value', (snapshot) => {
                const userData = snapshot.val();
                playerLevel = userData.level;
                playerExp = userData.exp;

                // æ›´æ–°æ’è¡Œæ¦œ
                const leaderboardRef = database.ref('leaderboard/' + user.uid);
                leaderboardRef.set({
                    name: user.displayName,
                    score: userData.score,
                    level: userData.level
                });

                // é¡¯ç¤ºçµ±è¨ˆå½ˆçª—
                const statsOverlay = document.createElement('div');
                statsOverlay.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: rgba(45, 41, 38, 0.95); padding: 2rem; border: 3px solid var(--gold);
                    border-radius: 15px; z-index: 10000; color: white; text-align: center;
                    width: 80%; max-width: 400px;
                `;

                const expRequired = 100 * userData.level;
                const expPercentage = (userData.exp / expRequired) * 100;
                statsOverlay.innerHTML = `
                    <h2>éŠæˆ²çµæŸ</h2>
                    <p>ç­‰ç´š: ${userData.level}</p>
                    <p>ç¶“é©—å€¼: ${userData.exp} / ${expRequired}</p>
                    <div style="width: 100%; height: 20px; background: #333; border-radius: 5px; margin: 1rem 0;">
                        <div style="height: 100%; background: #4CAF50; width: ${expPercentage}%; transition: width 1s ease;"></div>
                    </div>
                    <p>ç©åˆ†: ${userData.score || 0}</p>
                    ${isDoubleTime ? '<p style="color: #FFD700;">é›™å€çå‹µæœŸé–“ï¼</p>' : ''}
                `;
                if (userData.exp >= expRequired) {
                    statsOverlay.innerHTML += `<p style="color: #FFD700; font-size: 1.5rem; animation: levelUp 1s infinite;">æ­å–œå‡ç´šï¼</p>`;
                }
                document.body.appendChild(statsOverlay);

                setTimeout(() => statsOverlay.remove(), 5000);
            });
        });

        // é¡¯ç¤ºå‹åˆ©ç•«é¢
        const victoryOverlay = document.querySelector('.victory-overlay');
        const victoryText = document.querySelector('.victory-text');
        victoryText.textContent = winnerType === 'draw' ? "å¹³å±€ï¼" : (isWinner ? "å‹åˆ©ï¼" : "å¤±æ•—ï¼");
        victoryOverlay.style.display = 'flex';

        // æ·»åŠ é‡è³½æŒ‰éˆ•
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'rematch-buttons';
        const rematchBtn = document.createElement('button');
        rematchBtn.textContent = 'å†æˆ°æ±Ÿæ¹–';
        const mainMenuBtn = document.createElement('button');
        mainMenuBtn.textContent = 'æ­¸éš±å±±æ—';
        rematchBtn.onclick = () => handleRematchRequest();
        mainMenuBtn.onclick = () => {
            database.ref('rooms/' + currentRoomId).remove();
            window.location.reload();
        };
        buttonContainer.appendChild(rematchBtn);
        buttonContainer.appendChild(mainMenuBtn);
        victoryOverlay.appendChild(buttonContainer);
    });
}


    // å•Ÿå‹•å–®æ©Ÿæ¨¡å¼
function startSinglePlayer() {
    document.getElementById('roomControl').style.display = 'none';
    document.getElementById('difficultySelection').style.display = 'block';
}

// é¸æ“‡é›£åº¦ä¸¦å•Ÿå‹•éŠæˆ²
function selectDifficulty(difficulty) {
    selectedDifficulty = difficulty;
    const settings = difficultySettings[difficulty];
    if (!settings) return;

    const baseHealth = 1000;
    const healthPerLevel = 100;
    const user = auth.currentUser;
    if (user) {
        database.ref('users/' + user.uid).once('value', (snapshot) => {
            const userData = snapshot.val() || { level: 1, exp: 0 };
            playerLevel = userData.level;
            singlePlayerHealth = baseHealth + (playerLevel - 1) * healthPerLevel;
            enemyHealth = settings.enemyHealth;
            updateSinglePlayerHealthDisplay();
        });
    } else {
        singlePlayerHealth = baseHealth;
        enemyHealth = settings.enemyHealth;
        updateSinglePlayerHealthDisplay();
    }

    document.querySelectorAll('.difficulty-card').forEach(card => {
        card.classList.remove('selected');
        card.querySelector('.selected-tick').style.display = 'none'; // éš±è—å‹¾è™Ÿ
    });
    const selectedCard = document.querySelector(`.difficulty-card[onclick="selectDifficulty('${difficulty}')"]`);
    selectedCard.classList.add('selected');
    selectedCard.querySelector('.selected-tick').style.display = 'flex'; // é¡¯ç¤ºå‹¾è™Ÿ
    document.getElementById('selectedDifficultyInfo').innerHTML = `
        <p style="font-size:1.5em;color:#2ecc71;">âœ“ å·²é¸æ“‡ï¼š${selectedCard.querySelector('h3').textContent}</p>
    `;

    // æ·»åŠ å½ˆå‡ºæ•ˆæœ
    const popupImage = selectedCard.querySelector('.popup-image');
    popupImage.style.display = 'block';
    setTimeout(() => {
        popupImage.style.display = 'none';
        document.getElementById('difficultySelection').style.display = 'none';
        document.getElementById('singlePlayerClassSelection').style.display = 'block';
    }, 500);
}
    
function selectSinglePlayerClass(className) {
    const baseClassData = {
        warrior: { attack: 1.2, defense: 0.9, dodge: 0, skill: 'doubleDamage' }, // éœ¸åˆ€æµï¼šæ”»æ“Š+20%ï¼Œé˜²ç¦¦-10%
        tank: { attack: 0.9, defense: 1.2, dodge: 0, skill: 'heal', healPercentage: 0.02 }, // éµç”²å®—ï¼šæ”»æ“Š-10%ï¼Œé˜²ç¦¦+20%
        assassin: { attack: 1.0, defense: 0.9, dodge: 0.3, skill: 'dodge' }, // å½±æµæ•™ï¼šé˜²ç¦¦-10%ï¼Œé–ƒé¿+30%
        mage: { attack: 1.1, defense: 1.0, dodge: 0, skill: 'counter', damageReduction: 0.3 } // ç„å¤©é–£ï¼šæ”»æ“Š+10%ï¼ŒéŒ¯ç­”æ¸›å‚·30%
    };

    // æ ¹æ“šç­‰ç´šå‹•æ…‹èª¿æ•´æ”»æ“ŠåŠ›å’Œé˜²ç¦¦åŠ›
    singlePlayerClass = { ...baseClassData[className] };
    singlePlayerClass.attack *= (1 + (playerLevel - 1) * 0.05); // æ¯ç´šå¢åŠ 5%æ”»æ“ŠåŠ›
    singlePlayerClass.defense *= (1 + (playerLevel - 1) * 0.03); // æ¯ç´šå¢åŠ 3%é˜²ç¦¦åŠ›
    singlePlayerClass.type = className;

    // é¸æ“‡åé¥‹
    document.querySelectorAll('#singlePlayerClassSelection .class-card').forEach(card => {
        card.classList.remove('selected');
        card.querySelector('.selected-tick').style.display = 'none';
    });
    const selectedCard = document.querySelector(`#singlePlayerClassSelection .class-card[onclick="selectSinglePlayerClass('${className}')"]`);
    selectedCard.classList.add('selected');
    selectedCard.querySelector('.selected-tick').style.display = 'flex';
    document.getElementById('singlePlayerSelectedClassInfo').innerHTML = `
        <p style="font-size:1.5em;color:#2ecc71;">âœ“ å·²é¸æ“‡ï¼š${selectedCard.querySelector('h3').textContent}</p>
    `;

    const popupImage = selectedCard.querySelector('.popup-image');
    popupImage.style.display = 'block';
    setTimeout(() => {
        popupImage.style.display = 'none';
        document.getElementById('singlePlayerClassSelection').style.display = 'none';
        document.getElementById('singlePlayerTopicSelection').style.display = 'block';
        document.getElementById('singlePlayerGradeSelection').style.display = 'grid';
        document.getElementById('singlePlayerTopicDetail').style.display = 'none';
    }, 500);
}

    function selectSinglePlayerGrade(grade) {
    singlePlayerSelectedGrade = grade;
    document.getElementById('singlePlayerSelectedGrade').textContent = `é¸æ“‡ ${grade} é¡Œåº«`;
    document.getElementById('singlePlayerGradeSelection').style.display = 'none';
    document.getElementById('singlePlayerTopicDetail').style.display = 'block';

    // æ ¹æ“šå¹´ç´šè¨­ç½®é¡Œåº«
    let topics;
    if (grade === 'ä¸­ä¸€') {
        topics = ['æ¥Šä¿®ä¹‹æ­»','èƒŒå½±','ç‡•è©©','å¾¡äººä¹‹å¦»','æ•…å®®åšç‰©é™¢','é¢¨é›ªä¸­çš„åŒ—å¹³'];
     } else if (grade === 'ä¸­äºŒ') {
        topics = ['å›å®¶','å·®ä¸å¤šå…ˆç”Ÿå‚³','åœ¨é¢¨ä¸­','æ¡ƒèŠ±æºè¨˜','ç‚ºå­¸ä¸€é¦–ç¤ºå­å§ª','æ„›è“®èªª'];
    } else if (grade === 'ä¸­ä¸‰') {
        topics = ['æ°´èª¿æ­Œé ­','çˆ¸çˆ¸çš„èŠ±å…’è½äº†','éˆ·é‰§æ½­è¨˜','æ¶ˆå¤±ä¸­çš„ç‰¹è‰²è¡—é“','å­”æ˜å€Ÿç®­','æœ€è‹¦èˆ‡æœ€æ¨‚'];
    } else if (grade === 'ä¸­å››') {
        topics = ['å±±å±…ç§‹æš','æœˆä¸‹ç¨é…Œ','ç™»æ¨“','è«–ä»è«–å­è«–å›å­','é­šæˆ‘æ‰€æ¬²ä¹Ÿ','å¸«èªª'];
    } else if (grade === 'ä¸­äº”') {
        topics = ['å¿µå¥´å¬Œ','è²è²æ…¢','é’ç‰æ¡ˆ','å²³é™½æ¨“è¨˜','å§‹å¾—è¥¿å±±å®´éŠè¨˜', 'å»‰é —è—ºç›¸å¦‚åˆ—å‚³', 'å‡ºå¸«è¡¨', 'é€é™éŠ'];
    } else if (grade === 'ã€ä¸­å²ã€‘') {
        topics = [
            'å–®å…ƒäºŒ ç¬¬äºŒç«  ã€å…©æ¼¢çš„æ”¿æ²»ç™¼å±•å°èˆ‡ä¸­å¤–æ–‡åŒ–äº¤æµã€‘',
            'å–®å…ƒä¸‰ ç¬¬ä¸€ç«  ã€é­æ™‰å—åŒ—æœçš„åˆ†è£‚èˆ‡æ”¿æ¬Šæ›´æ›¿ã€‘'
        ];
    } else {
        topics = []; // é è¨­ç©ºé™£åˆ—ï¼Œé˜²æ­¢æœªå®šç¾©
    }
    const topicList = document.getElementById('singlePlayerTopicList');
    topicList.innerHTML = '';
    topics.forEach(topic => {
        const button = document.createElement('button');
        button.textContent = topic;
        button.className = 'topic-btn';
        button.onclick = () => selectSinglePlayerTopic(topic);
        topicList.appendChild(button);
    });
}

function selectSinglePlayerTopic(topic) {
    singlePlayerSelectedTopic = topic;
    document.getElementById('singlePlayerTopicSelection').style.display = 'none';
    startSinglePlayerCountdown();
}

  function startSinglePlayerCountdown() {
    console.log('Starting countdown');
    let countdown = 3;
    const countdownElement = document.createElement('div');
    countdownElement.id = 'countdown';
    countdownElement.style.position = 'fixed';
    countdownElement.style.top = '0';
    countdownElement.style.left = '0';
    countdownElement.style.width = '100%';
    countdownElement.style.height = '100%';
    countdownElement.style.display = 'flex';
    countdownElement.style.alignItems = 'center';
    countdownElement.style.justifyContent = 'center';
    countdownElement.style.background = 'rgba(45, 41, 38, 0.95)';
    countdownElement.style.color = 'var(--gold)';
    countdownElement.style.fontSize = '10rem';
    countdownElement.style.zIndex = '10001';
    document.body.appendChild(countdownElement);

    function updateCountdown() {
        if (countdown > 0) {
            countdownElement.textContent = countdown;
            countdown--;
            setTimeout(updateCountdown, 1000);
        } else {
            countdownElement.remove();
            document.getElementById('gameArea').style.display = 'block';
            document.querySelectorAll('#roomControl, #difficultySelection, #singlePlayerClassSelection, #singlePlayerTopicSelection, #waitingArea, #classSelection, #topicSelection').forEach(el => {
                el.style.display = 'none';
            });
            const settings = difficultySettings[selectedDifficulty];
            if (!settings) {
                console.error('é›£åº¦è¨­ç½®æœªæ‰¾åˆ°ï¼ŒselectedDifficulty:', selectedDifficulty);
                return;
            }
           damageInterval = setInterval(() => {
    if (Math.random() < settings.damageChance) {
        const baseDamage = 50 + Math.random() * 30 + (playerLevel - 1) * 5;
        const difficultyMultiplier = {
            easy: 0.8,
            normal: 1.0,
            hard: 3.5,
            hell: 4.25
        }[selectedDifficulty];
        let defenseMultiplier = singlePlayerClass.defense;

        // éµç”²å®—éŒ¯ç­”é˜²ç¦¦ç„¡æ•ˆï¼Œä½†é€™è£¡æ˜¯æ•µæ–¹æ”»æ“Šï¼Œä¿ç•™é˜²ç¦¦æ•ˆæœ
        let damageToPlayer = baseDamage * difficultyMultiplier / defenseMultiplier;
        if (singlePlayerClass.type === 'assassin' && Math.random() < singlePlayerClass.dodge) {
            showEffect('dodgeAnimation');
            damageToPlayer = 0;
        }

        damageToPlayer = Math.round(damageToPlayer);
        singlePlayerHealth = Math.max(singlePlayerHealth - damageToPlayer, 0);
        updateSinglePlayerHealthDisplay();
        if (damageToPlayer > 0) showDamageAnimation(damageToPlayer, 'player');

        if (singlePlayerHealth <= 0) {
            handleSinglePlayerGameOver(false);
        }
    }
}, settings.damageInterval);
            loadNewQuestionSinglePlayer();
        }
    }
    updateCountdown();
}

function updateSinglePlayerHealthDisplay() {
    const maxPlayerHealth = 1000 + (playerLevel - 1) * 100; // å‹•æ…‹è¨ˆç®—æœ€å¤§æ°£è¡€
    const maxEnemyHealth = difficultySettings[selectedDifficulty].enemyHealth;

    document.getElementById('myHealth').textContent = `${singlePlayerHealth} / ${maxPlayerHealth}`;
    document.getElementById('myHealthBar').style.width = `${(singlePlayerHealth / maxPlayerHealth) * 100}%`;

    document.getElementById('opponentHealth').textContent = `${enemyHealth} / ${maxEnemyHealth}`;
    document.getElementById('opponentHealthBar').style.width = `${(enemyHealth / maxEnemyHealth) * 100}%`;

    // æ·»åŠ å‹•ç•«æ•ˆæœ
    const healthBar = singlePlayerHealth < maxPlayerHealth * 0.3 ? 'myHealthBar' : 'opponentHealthBar';
    const wave = document.createElement('div');
    wave.className = 'health-wave';
    document.getElementById(healthBar).appendChild(wave);
    setTimeout(() => wave.remove(), 500);
}

    
   function loadNewQuestionSinglePlayer() {
    const grade = singlePlayerSelectedGrade;
    const topic = singlePlayerSelectedTopic;
    
    // ç²å–å•é¡Œç¸½æ•¸
    database.ref(`questions/${grade}/${topic}/count`).once('value').then(snapshot => {
        const totalQuestions = snapshot.val();
        if (!totalQuestions || totalQuestions <= 0) {
            console.error('é¡Œåº«ä¸­ç„¡å•é¡Œæˆ–è¨ˆæ•¸å™¨æœªè¨­ç½®');
            return;
        }
        
        // éš¨æ©Ÿé¸æ“‡ä¸€å€‹å•é¡Œ ID
        const randomId = Math.floor(Math.random() * totalQuestions);
        
        // åŠ è¼‰å–®å€‹å•é¡Œ
        database.ref(`questions/${grade}/${topic}/${randomId}`).once('value').then(snapshot => {
            const originalQuestion = snapshot.val();
            if (!originalQuestion) {
                console.error('ç„¡æ³•æ‰¾åˆ°è©²å•é¡Œæ•¸æ“š');
                return;
            }
            
            const optionsCopy = [...originalQuestion.options];
            const correctAnswer = optionsCopy[originalQuestion.correctIndex];
            const shuffledOptions = shuffleArray(optionsCopy);
            const newCorrectIndex = shuffledOptions.indexOf(correctAnswer);
            
            currentQuestion = {
                question: originalQuestion.question,
                options: shuffledOptions,
                correctIndex: newCorrectIndex,
                id: Date.now()
            };
            
            answered = false;
            displayQuestionSinglePlayer(currentQuestion);
        }).catch(error => {
            console.error('ä¸‹è¼‰å•é¡Œæ•¸æ“šæ™‚å‡ºéŒ¯:', error);
        });
    }).catch(error => {
        console.error('ç²å–å•é¡Œç¸½æ•¸æ™‚å‡ºéŒ¯:', error);
    });
}

    

// ç›£è½å–®æ©Ÿæ¨¡å¼æ°£è¡€
function listenToSinglePlayerHealth() {
    const roomRef = database.ref('rooms/' + currentRoomId);
    roomRef.on('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) return;

        const health = room.player1.health;
        document.getElementById('myHealth').textContent = Math.max(health, 0);
        document.getElementById('myHealthBar').style.width = Math.max(health, 0) + '%';

        if (health <= 0) {
            handleSinglePlayerGameOver();
        }
    });
}



// é¡¯ç¤ºå–®æ©Ÿæ¨¡å¼å•é¡Œ
function displayQuestionSinglePlayer(question) {
    console.log('Displaying question:', question); // æ·»åŠ æ—¥èªŒ
    window.currentQuestion = question;
    document.getElementById('question').textContent = question.question;
    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';

    question.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.textContent = option;
        button.setAttribute('data-question-id', question.id);
        button.onclick = () => {
            console.log('Option clicked:', index); // æ·»åŠ æ—¥èªŒ
            if (!answered) {
                checkAnswerSinglePlayer(index === question.correctIndex, question.id);
            }
        };
        optionsDiv.appendChild(button);
    });
    startTimer();
}

// å–®æ©Ÿæ¨¡å¼ç­”æ¡ˆæª¢æŸ¥
function checkAnswerSinglePlayer(isCorrect, questionId) {
    if (answeredQuestions.has(questionId) || answered || gameOver) return;
    answeredQuestions.add(questionId);
    answered = true;

    clearInterval(timer);

    const buttons = document.querySelectorAll('#options button');
    const correctIndex = currentQuestion.correctIndex;
    buttons.forEach((btn, index) => {
        btn.style.pointerEvents = 'none';
        if (index === correctIndex) {
            btn.style.cssText = `
                background: #2ecc71 !important;
                border: 2px solid #27ae60 !important;
                transform: scale(1.05);
            `;
        }
    });

    const maxPlayerHealth = 1000 + (playerLevel - 1) * 100;
    const difficultyMultiplier = {
        easy: 0.8,
        normal: 1.0,
        hard: 3.5,
        hell: 4.25
    }[selectedDifficulty];
    const baseDamage = 50 + Math.random() * 30 + (playerLevel - 1) * 5; // éš¨ç­‰ç´šå¢åŠ å‚·å®³

    if (isCorrect) {
        soundEffects.attack.play();
        if (navigator.vibrate) navigator.vibrate(200);

        let attackMultiplier = singlePlayerClass.attack;
        let skillTriggered = false;

        // è·æ¥­æŠ€èƒ½èˆ‡å‹•ç•«
        if (singlePlayerClass.type === 'warrior' && Math.random() < 0.3) {
            attackMultiplier *= 2;
            showEffect('sword-flash'); // éœ¸åˆ€æµé›™å€å‚·å®³å‹•ç•«
            skillTriggered = true;
        } else if (singlePlayerClass.type === 'assassin' && Math.random() < singlePlayerClass.dodge) {
            showEffect('dodgeAnimation'); // å½±æµæ•™é–ƒé¿å‹•ç•«
            skillTriggered = true;
        } else if (singlePlayerClass.type === 'mage') {
            showEffect('fireEffect'); // ç„å¤©é–£å‹•ç•«
        } else if (singlePlayerClass.type === 'tank') {
            showEffect('shieldEffect'); // éµç”²å®—å‹•ç•«
        }

        const damageToEnemy = Math.round(baseDamage * attackMultiplier);
        enemyHealth = Math.max(enemyHealth - damageToEnemy, 0);
        updateSinglePlayerHealthDisplay();
        showDamageAnimation(damageToEnemy, 'enemy');

        if (enemyHealth <= 0) {
            handleSinglePlayerGameOver(true);
            return;
        }
    } else {
        if (navigator.vibrate) navigator.vibrate(200);

        let defenseMultiplier = singlePlayerClass.defense;
        let damageToPlayer = baseDamage * difficultyMultiplier;

        // éµç”²å®—éŒ¯ç­”æ™‚é˜²ç¦¦ç„¡æ•ˆ
        if (singlePlayerClass.type === 'tank') {
            defenseMultiplier = 1.0; // éŒ¯ç­”æ™‚é˜²ç¦¦ç„¡æ•ˆ
        } else if (singlePlayerClass.type === 'mage') {
            damageToPlayer *= (1 - singlePlayerClass.damageReduction); // ç„å¤©é–£æ¸›å‚·
            showEffect('fireEffect');
        } else if (singlePlayerClass.type === 'assassin' && Math.random() < singlePlayerClass.dodge) {
            showEffect('dodgeAnimation');
            damageToPlayer = 0; // é–ƒé¿æˆåŠŸ
        }

        damageToPlayer = Math.round(damageToPlayer / defenseMultiplier);
        singlePlayerHealth = Math.max(singlePlayerHealth - damageToPlayer, 0);
        updateSinglePlayerHealthDisplay();
        showDamageAnimation(damageToPlayer, 'player');

        if (singlePlayerHealth <= 0) {
            handleSinglePlayerGameOver(false);
            return;
        }
    }

    // éµç”²å®—æ¯å›åˆæ¢å¾©
    if (singlePlayerClass.type === 'tank' && !hasHealedThisTurn) {
        hasHealedThisTurn = true;
        const healAmount = Math.round(maxPlayerHealth * singlePlayerClass.healPercentage);
        singlePlayerHealth = Math.min(singlePlayerHealth + healAmount, maxPlayerHealth);
        updateSinglePlayerHealthDisplay();
        showHealAnimation(healAmount, 'player');
        showEffect('shieldEffect');
    }

    setTimeout(() => {
        buttons.forEach(btn => {
            btn.style.cssText = '';
            btn.style.pointerEvents = 'auto';
        });
        answered = false;
        hasHealedThisTurn = false;
        if (!gameOver) loadNewQuestionSinglePlayer();
    }, 700);
}

    
function showDamageAnimation(damage, target) {
    const healthContainerId = target === 'enemy' ? 'enemyHealthContainer' : 'myHealthContainer';
    const healthContainer = document.getElementById(healthContainerId);
    const healthBar = healthContainer.querySelector('.health-bar');
    const rect = healthBar.getBoundingClientRect();

    const damageText = document.createElement('div');
    damageText.textContent = `-${damage}`;
    damageText.style.position = 'fixed';
    damageText.style.color = target === 'enemy' ? '#ff0000' : '#ff5555';
    damageText.style.fontSize = '2rem';
    damageText.style.fontWeight = 'bold';
    damageText.style.textShadow = '0 0 5px rgba(255, 0, 0, 0.5)';
    damageText.style.zIndex = '9999';
    damageText.style.animation = 'damageFloat 1s ease-out forwards';

    // è¨ˆç®—éš¨æ©Ÿæ°´å¹³ä½ç½®ï¼ˆåœ¨æ°£è¡€æ¢å¯¬åº¦ç¯„åœå…§ï¼‰
    const randomLeft = rect.left + Math.random() * rect.width;
    // å‚ç›´ä½ç½®ï¼šæ•µæ–¹é¡¯ç¤ºåœ¨æ°£è¡€æ¢ä¸Šæ–¹ï¼Œå·±æ–¹é¡¯ç¤ºåœ¨æ°£è¡€æ¢ä¸‹æ–¹
    const topPosition = target === 'enemy' ? rect.top - 30 : rect.bottom + 10;
    damageText.style.left = `${randomLeft}px`;
    damageText.style.top = `${topPosition}px`;

    document.body.appendChild(damageText);
    setTimeout(() => damageText.remove(), 1000);
}

    function showHealAnimation(healAmount, target) {

const healAnimation = document.createElement('img');
    healAnimation.src = 'https://i.ibb.co/CrGK4CR/image.gif';
    healAnimation.style.position = 'fixed';
    healAnimation.style.bottom = '100px'; // æ ¹æ“šå·±æ–¹è¡€æ¢ä½ç½®èª¿æ•´ï¼Œèˆ‡ #myHealthContainer çš„ bottom: 80px ç›¸è¿‘
    healAnimation.style.right = '1rem';   // é å³é¡¯ç¤ºï¼Œèˆ‡æ°£è¡€æ–‡å­—å°é½Š
    healAnimation.style.width = '100px';  // GIF å¯¬åº¦
    healAnimation.style.height = '100px'; // GIF é«˜åº¦
    healAnimation.style.zIndex = '10000'; // ç¢ºä¿é¡¯ç¤ºåœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š
    document.body.appendChild(healAnimation);
    setTimeout(() => healAnimation.remove(), 1000); // 2ç§’å¾Œç§»é™¤
        
    const healthContainerId = target === 'enemy' ? 'enemyHealthContainer' : 'myHealthContainer';
    const healthContainer = document.getElementById(healthContainerId);
    const healthBar = healthContainer.querySelector('.health-bar');
    const rect = healthBar.getBoundingClientRect();

    const healText = document.createElement('div');
    healText.textContent = `+${healAmount}`;
    healText.style.position = 'fixed';
    healText.style.color = '#00ff00'; // ç¶ è‰²è¡¨ç¤ºæ¢å¾©
    healText.style.fontSize = '2rem';
    healText.style.fontWeight = 'bold';
    healText.style.textShadow = '0 0 5px rgba(0, 255, 0, 0.5)';
    healText.style.zIndex = '9999';
    healText.style.animation = 'damageFloat 1s ease-out forwards'; // æ²¿ç”¨å‚·å®³çš„æµ®å‹•å‹•ç•«

    // éš¨æ©Ÿæ°´å¹³ä½ç½®ï¼Œä¸¦å°‡æ¢å¾©æ•¸å­—é¡¯ç¤ºåœ¨æ°£è¡€æ¢ä¸‹æ–¹
    const randomLeft = rect.left + Math.random() * rect.width;
    const topPosition = rect.bottom + 10; // é¡¯ç¤ºåœ¨æ°£è¡€æ¢ä¸‹æ–¹
    healText.style.left = `${randomLeft}px`;
    healText.style.top = `${topPosition}px`;

    document.body.appendChild(healText);
    setTimeout(() => healText.remove(), 1000);
}

    

// è¼”åŠ©å‡½æ•¸ï¼šé¡¯ç¤ºç‰¹æ•ˆ
function showEffect(className) {
    const effect = document.createElement('div');
    effect.className = className;
    document.body.appendChild(effect);
    setTimeout(() => effect.remove(), 400);
}

    function showEffect(className) {
    const effect = document.createElement('div');
    effect.className = className;
    effect.style.position = 'fixed';
    effect.style.top = '50%';
    effect.style.left = '50%';
    effect.style.transform = 'translate(-50%, -50%)';
    effect.style.zIndex = '9999';

    if (className === 'sword-flash') {
        effect.style.width = '150px';
        effect.style.height = '30px';
        effect.style.background = 'linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(100,255,100,0.7) 50%, rgba(255,255,255,0) 100%)';
        effect.style.animation = 'swordSwipe 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    } else if (className === 'shieldEffect') {
        effect.innerHTML = '<img src="https://i.ibb.co/cK6LJK1M/unscreen-1.gif" style="width:250px; height:250px;">';
        effect.style.animation = 'shieldEffect 0.5s ease-out';
    } else if (className === 'dodgeAnimation') {
        effect.innerHTML = '<img src="https://i.ibb.co/zTRVPR2Q/unscreen.gif" style="width:200px; height:200px;">';
        effect.style.animation = 'dodgeFade 1s ease-out';
    } else if (className === 'fireEffect') {
        effect.style.width = '100px';
        effect.style.height = '100px';
        effect.style.background = 'radial-gradient(circle, rgba(255,100,0,0.8) 0%, rgba(255,0,0,0) 70%)';
        effect.style.animation = 'hitMarker 0.3s ease-out';
    }

    document.body.appendChild(effect);
    setTimeout(() => effect.remove(), className === 'dodgeAnimation' ? 1000 : 400);
}

    function handleSinglePlayerGameOver(isWinner) {
    if (gameOver) return; // é¿å…é‡è¤‡è§¸ç™¼
    gameOver = true;

    // æ¸…é™¤è¨ˆæ™‚å™¨
    clearInterval(timer);          // æ¸…é™¤ç­”é¡Œè¨ˆæ™‚å™¨
    clearInterval(damageInterval); // æ¸…é™¤æ•µæ–¹æ‰£è¡€è¨ˆæ™‚å™¨

    // ç¦ç”¨é¸é …æŒ‰éˆ•
    document.querySelectorAll('#options button').forEach(btn => btn.disabled = true);

    // é¡¯ç¤ºå‹åˆ©æˆ–å¤±æ•—ç•«é¢
    const victoryOverlay = document.querySelector('.victory-overlay');
    const victoryText = document.querySelector('.victory-text');
    victoryText.textContent = isWinner ? "æ­¦é“æ˜Œéš†ï¼" : "é›–æ•—çŒ¶æ¦®ï¼";
    victoryOverlay.style.display = 'flex';

    // è™•ç†ç¶“é©—å€¼å’Œç­‰ç´šé‚è¼¯
    const user = auth.currentUser;
    if (user) {
        const userRef = database.ref('users/' + user.uid);
        userRef.once('value', (snapshot) => {
            const userData = snapshot.val() || { level: 1, exp: 0, score: 0 };
            const expRequired = 100 * userData.level; // æ¯ç´šæ‰€éœ€ç¶“é©—å€¼
            const expReward = isWinner ? expRewards[selectedDifficulty] : 0; // ç²å‹æ‰ç²å¾—ç¶“é©—å€¼
            const oldLevel = userData.level;

            if (isWinner) {
                userData.exp += expReward; // å¢åŠ ç¶“é©—å€¼
                while (userData.exp >= expRequired) {
                    userData.level += 1;   // å‡ç´š
                    userData.exp -= expRequired; // æ‰£é™¤æ‰€éœ€ç¶“é©—å€¼
                }
            }

            // æ›´æ–°ç”¨æˆ¶æ•¸æ“šåˆ°è³‡æ–™åº«
            userRef.set(userData);

            // æ·»åŠ çš„ä»£ç¢¼ï¼šæ›´æ–°æ’è¡Œæ¦œ
            const leaderboardRef = database.ref('leaderboard/' + user.uid);
            leaderboardRef.set({
                name: user.displayName,
                score: userData.score,
                level: userData.level
            });

            // åˆ›å»ºç»Ÿè®¡å¼¹çª—
            const statsOverlay = document.createElement('div');
            statsOverlay.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(45, 41, 38, 0.95); padding: 2rem; border: 3px solid var(--gold);
                border-radius: 15px; z-index: 10000; color: white; text-align: center;
                width: 80%; max-width: 400px;
            `;

            const currentExp = userData.exp;
            const expPercentage = ((currentExp / expRequired) * 100).toFixed(1);
            const remainingExp = expRequired - currentExp;
            
            statsOverlay.innerHTML = `
                <h2>éŠæˆ²çµæŸ</h2>
                <p>ç­‰ç´š: ${userData.level}</p>
                <p>ç¶“é©—å€¼: ${currentExp} / ${expRequired} (${expPercentage}%)</p>
                <p>å‡ç´šé‚„éœ€: ${remainingExp} ç¶“é©—</p>
                <div style="width: 100%; height: 20px; background: #333; border-radius: 5px; margin: 1rem 0;">
                    <div style="height: 100%; background: #4CAF50; width: ${expPercentage}%; transition: width 1s ease;"></div>
                </div>
            `;

            if (userData.level > oldLevel) {
                statsOverlay.innerHTML += `<p style="color: #FFD700; font-size: 1.5rem; animation: levelUp 1s infinite;">æ­å–œå‡ç´šï¼</p>`;
            } else if (isWinner) {
                statsOverlay.innerHTML += `<p style="color: #4CAF50; font-size: 1.2rem;">ç²å¾— ${expReward} ç¶“é©—å€¼</p>`;
            }

            document.body.appendChild(statsOverlay);

            // æ·»åŠ å…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'é—œé–‰';
            closeBtn.style.cssText = `
                margin-top: 1rem;
                padding: 0.5rem 1rem;
                background: #e74c3c;
                border: none;
                border-radius: 5px;
                color: white;
                cursor: pointer;
            `;
            closeBtn.onclick = () => statsOverlay.remove();
            statsOverlay.appendChild(closeBtn);

            // 5ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => statsOverlay.remove(), 5000);
        });
    }

    // æ·»åŠ é‡æ–°é–‹å§‹å’Œè¿”å›ä¸»èœå–®æŒ‰éˆ•
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'rematch-buttons';

    const restartBtn = document.createElement('button');
    restartBtn.textContent = 'å†æˆ°æ±Ÿæ¹–';
    const mainMenuBtn = document.createElement('button');
    mainMenuBtn.textContent = 'æ­¸éš±å±±æ—';

    restartBtn.onclick = () => resetSinglePlayerGame();
    mainMenuBtn.onclick = () => window.location.reload();

    buttonContainer.appendChild(restartBtn);
    buttonContainer.appendChild(mainMenuBtn);
    victoryOverlay.appendChild(buttonContainer);
}

    function resetSinglePlayerGame() {
clearInterval(damageInterval); // æ·»åŠ ï¼šç¢ºä¿æ¸…é™¤æ‰£è¡€è¨ˆæ™‚å™¨
        
    // é‡ç½®éŠæˆ²ç‹€æ…‹
    gameOver = false;
    answered = false;
    singlePlayerHealth = 1000 + (playerLevel - 1) * 100; // é‡ç½®ç©å®¶æ°£è¡€
    enemyHealth = difficultySettings[selectedDifficulty].enemyHealth; // é‡ç½®æ•µæ–¹æ°£è¡€
    updateSinglePlayerHealthDisplay();

    // æ¸…é™¤èˆŠå•é¡Œé¡¯ç¤º
    document.getElementById('question').textContent = '';
    document.getElementById('options').innerHTML = '';

    // éš±è—å‹åˆ©ç•«é¢ä¸¦ç§»é™¤æŒ‰éˆ•
    const victoryOverlay = document.querySelector('.victory-overlay');
    victoryOverlay.style.display = 'none';
    const buttons = victoryOverlay.querySelector('.rematch-buttons');
    if (buttons) buttons.remove();

    // é‡ç½®ç­”æ¡ˆæŒ‰éˆ•ç‹€æ…‹
    document.querySelectorAll('#options button').forEach(btn => {
        btn.disabled = false;
        btn.style.pointerEvents = 'auto';
        btn.style.opacity = '1';
    });

    // è¿”å›é›£åº¦é¸æ“‡ç•Œé¢
    document.getElementById('difficultySelection').style.display = 'block';
    document.getElementById('gameArea').style.display = 'none';
    document.getElementById('singlePlayerTopicSelection').style.display = 'none';
}

document.getElementById('showLeaderboardBtn').onclick = function() {
    const leaderboardRef = database.ref('leaderboard');
    leaderboardRef.orderByChild('score').limitToLast(10).once('value', (snapshot) => {
        const leaderboard = [];
        snapshot.forEach((childSnapshot) => {
            const data = childSnapshot.val();
            leaderboard.push(data);
        });
        leaderboard.reverse(); // é™åºæ’åˆ—

        // ä½¿ç”¨è¡¨æ ¼é¡¯ç¤ºæ’è¡Œæ¦œ
        let leaderboardHTML = `
            <h2 style="text-align: center; color: var(--gold);">ğŸ† æ’è¡Œæ¦œ - å‰åå</h2>
            <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                <thead>
                    <tr style="background: rgba(255,255,255,0.1);">
                        <th style="padding: 0.5rem; border-bottom: 2px solid var(--gold);">æ’å</th>
                        <th style="padding: 0.5rem; border-bottom: 2px solid var(--gold);">ç”¨æˆ¶åç¨±</th>
                        <th style="padding: 0.5rem; border-bottom: 2px solid var(--gold);">ç­‰ç´š</th>
                        <th style="padding: 0.5rem; border-bottom: 2px solid var(--gold);">ç©åˆ†</th>
                    </tr>
                </thead>
                <tbody>
        `;
        leaderboard.forEach((entry, index) => {
            const levelText = entry.level ? `Lv.${entry.level}` : 'Lv.1';
            leaderboardHTML += `
                <tr>
                    <td style="padding: 0.5rem; text-align: center;">${index + 1}</td>
                    <td style="padding: 0.5rem; text-align: center;">${entry.name}</td>
                    <td style="padding: 0.5rem; text-align: center;">${levelText}</td>
                    <td style="padding: 0.5rem; text-align: center;">${entry.score}</td>
                </tr>
            `;
        });
        leaderboardHTML += `
                </tbody>
            </table>
        `;

        const leaderboardDiv = document.createElement('div');
        leaderboardDiv.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(45, 41, 38, 0.95); padding: 2rem; border: 3px solid var(--gold);
            border-radius: 15px; width: 80%; max-width: 600px;
            z-index: 10000; color: white;
        `;
        leaderboardDiv.innerHTML = leaderboardHTML + `
            <button onclick="this.parentElement.remove()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #e74c3c; border: none; border-radius: 5px; color: white;">é—œé–‰</button>
        `;
        document.body.appendChild(leaderboardDiv);
    });
};
    
function handleRematchRequest() {
    if (isRematching) return;
    isRematching = true;

    // ç§»é™¤å‹åˆ©ç•«é¢
    const victoryOverlay = document.querySelector('.victory-overlay');
    victoryOverlay.style.display = 'none';
    const buttons = victoryOverlay.querySelector('.rematch-buttons');
    if (buttons) buttons.remove();

    // éš¨æ©Ÿæ±ºå®šæ–°çš„é¡Œåº«é¸æ“‡è€…
    const newSelector = Math.random() < 0.5 ? 'player1' : 'player2';

    // é‡ç½®æ•¸æ“šåº«ç‹€æ…‹
    const rematchField = isHost ? 'hostRematch' : 'clientRematch';
    const updates = {
        'player1/health': 100,
        'player2/health': 100,
        'player1/class': null,
        'player2/class': null,
        gameEnded: false,
        gameStarted: false,
        topicSelected: false,
        selectedGrade: null,
        selectedTopic: null,
        topicSelector: newSelector,
        hostRematch: false,
        clientRematch: false,
        [rematchField]: true
    };

    database.ref('rooms/' + currentRoomId).update(updates, (error) => {
        isRematching = false;
        if (error) {
            console.error('æ›´æ–°æ•¸æ“šåº«å¤±æ•—:', error);
            return;
        }

        // é‡ç½®æœ¬åœ°ç‹€æ…‹
        gameOver = false;
        answered = false;           // é‡ç½®å›ç­”ç‹€æ…‹ï¼Œè®“æ–°å•é¡Œå¯ä»¥è¢«å›ç­”
        answeredQuestions.clear();  // æ¸…ç©ºå·²å›ç­”å•é¡Œé›†åˆï¼Œé¿å…å•é¡Œé‡è¤‡åˆ¤å®š
        hasHealedThisTurn = false;  // é‡ç½®å›åˆæ¢å¾©ç‹€æ…‹ï¼ˆè‹¥é©ç”¨ï¼‰
        document.getElementById('gameArea').style.display = 'none';
        document.getElementById('classSelection').style.display = 'block';

        // é‡ç½® topicSelection çš„é¡¯ç¤ºç‹€æ…‹
        document.getElementById('topicSelection').style.display = 'none'; // ç¢ºä¿æ•´å€‹é¡Œåº«é¸æ“‡ç•Œé¢éš±è—
        document.getElementById('gradeSelection').style.display = 'grid'; // é¡¯ç¤ºå¹´ç´šé¸æ“‡
        document.getElementById('topicDetail').style.display = 'none';    // éš±è—é¡Œåº«é¸æ“‡
        document.getElementById('selectedGrade').textContent = '';       // æ¸…ç©ºé¸ä¸­å¹´ç´šæ–‡å­—
        document.getElementById('topicList').innerHTML = '';             // æ¸…ç©ºé¡Œåº«åˆ—è¡¨
    });
}

function listenToRoomChanges() {
    const roomRef = database.ref('rooms/' + currentRoomId);
    roomRef.off('value');

    roomRef.on('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) return;

        if (isHost) {
            opponentDefense = room.player2?.defense || 1.0;
        } else {
            opponentDefense = room.player1?.defense || 1.0;
        }

        // è¶…æ™‚æª¢æŸ¥
        if (isHost && room.player2 === null && !room.gameStarted) {
            const now = Date.now();
            const createdAt = room.createdAt || 0;
            if (now - createdAt > 30000) { // 30ç§’è¶…æ™‚
                alert('ç­‰å¾…å°æ‰‹è¶…æ™‚ï¼Œè«‹é‡æ–°å˜—è©¦åŒ¹é…ã€‚');
                database.ref('rooms/' + currentRoomId).remove();
                database.ref('waitingRooms').remove();
                window.location.reload();
            }
        }

        if (room.player1?.class && room.player2?.class) {
            document.getElementById('waitingArea').style.display = 'none';
        }

        if (room.gameEnded) {
            handleGameEnd(room.winner);
            return;
        }

        if (room.player1?.class && room.player2?.class) {
            document.getElementById('classSelection').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            startGame(room);
        }

        updateHealthDisplay(room);

        if (room.topicSelected && !room.gameStarted && !room.countdownStarted) {
            // ç§»é™¤ç­‰å¾…æ¶ˆæ¯ä¸¦é–‹å§‹å€’æ•¸è¨ˆæ™‚
            const waitingForTopic = document.getElementById('waitingForTopic');
            if (waitingForTopic) waitingForTopic.remove();
            startCountdown();
        }

        if (room.gameStarted) {
            document.getElementById('waitingArea').style.display = 'none';
            document.getElementById('classSelection').style.display = 'none';
            document.getElementById('topicSelection').style.display = 'none';
            const waitingForTopic = document.getElementById('waitingForTopic');
            if (waitingForTopic) waitingForTopic.remove();
            startGame(room);
        }

        // åœ¨ listenToRoomChanges å…§æ›¿æ›é‡é–‹ç›¸é—œé‚è¼¯
        if (room.hostRematch && room.clientRematch) {
            // é‡ç½®é‡é–‹æ¨™èªŒä¸¦é€²å…¥è·æ¥­é¸æ“‡
            database.ref('rooms/' + currentRoomId).update({
                hostRematch: false,
                clientRematch: false
            });

            // é¡¯ç¤ºè·æ¥­é¸æ“‡ç•Œé¢
            document.getElementById('classSelection').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';

            // é›™æ–¹éƒ½é¸æ“‡è·æ¥­å¾Œé€²å…¥é¡Œåº«é¸æ“‡
            if (room.player1?.class && room.player2?.class) {
                document.getElementById('classSelection').style.display = 'none';
                if (!room.topicSelected) {
                    const selector = room.topicSelector;
                    if ((isHost && selector === 'player1') || (!isHost && selector === 'player2')) {
                        document.getElementById('topicSelection').style.display = 'block';
                        document.getElementById('gradeSelection').style.display = 'grid'; // é¡¯ç¤ºå¹´ç´šé¸æ“‡
                        document.getElementById('topicDetail').style.display = 'none';    // éš±è—é¡Œåº«é¸æ“‡
                    } else {
                        let waitingMessage = document.createElement('div');
                        waitingMessage.id = 'waitingForTopic';
                        waitingMessage.style.position = 'fixed';
                        waitingMessage.style.top = '50%';
                        waitingMessage.style.left = '50%';
                        waitingMessage.style.transform = 'translate(-50%, -50%)';
                        waitingMessage.style.background = 'rgba(45, 41, 38, 0.95)';
                        waitingMessage.style.color = 'var(--gold)';
                        waitingMessage.style.fontSize = '2rem';
                        waitingMessage.style.padding = '2rem';
                        waitingMessage.style.border = '3px solid var(--gold)';
                        waitingMessage.style.borderRadius = '15px';
                        waitingMessage.style.zIndex = '10000';
                        waitingMessage.textContent = 'ç­‰å¾…ç©å®¶é¸æ“‡é¡Œåº«...';
                        document.body.appendChild(waitingMessage);
                    }
                }
            }
        }

        // ç©å®¶é‡æ–°é€²å…¥æç¤ºä¿æŒä¸è®Š
        const opponentReentered = isHost ? room.player2?.reentered : room.player1?.reentered;
        if (opponentReentered && !opponentJoinedMessage && (!room.gameStarted || room.gameEnded)) {
            opponentJoinedMessage = document.createElement('div');
            opponentJoinedMessage.style.cssText = `
                position: fixed; top: 10%; left: 50%; transform: translate(-50%, 0);
                background: rgba(0, 0, 0, 0.9); color: #fff; padding: 20px; 
                border-radius: 10px; z-index: 9999; font-size: 2rem; text-align: center;
                width: 80%; max-width: 300px; box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            `;
            opponentJoinedMessage.textContent = 'ğŸ®ç©å®¶å·²é€²å ´';
            document.body.appendChild(opponentJoinedMessage);

            setTimeout(() => {
                opponentJoinedMessage.remove();
                opponentJoinedMessage = null;
            }, 3000);
        }

        // æ–°å¢ï¼šç›£è½é–ƒé¿äº‹ä»¶
        if (room.dodgeEvent && room.dodgeEvent.target === (isHost ? 'player1' : 'player2')) {
            showDodgeText();
            // æ¸…é™¤é–ƒé¿äº‹ä»¶
            database.ref(`rooms/${currentRoomId}/dodgeEvent`).remove();
        }
    });
}



</script>

<!-- æ–°å¢æ²»ç–—æç¤º -->
<div id="healText" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-50%); font-size:2rem; color:#00ff00; text-shadow:0 0 10px rgba(0,255,0,0.5);">ğŸ›¡ï¸ æ°£è¡€æ¢å¾©2%</div>

<!-- æ–°å¢å‡ä¼¤æç¤º -->

<img id="reduceDamageAnimation" src="https://i.ibb.co/cK6LJK1M/unscreen-1.gif" style="display:none; position:fixed; top:40%; left:60%; transform:translate(-50%,-50%); width:250px; height:250px; z-index:10001;">


    
</body>

<div id="dodgeText" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:3rem; color:#00ff00; text-shadow:0 0 10px rgba(0,255,0,0.5);">é–ƒé¿ï¼</div>
<img id="dodgeAnimation" src="https://i.ibb.co/zTRVPR2Q/unscreen.gif" style="display:none; position:fixed; top:50%; left:60%; transform:translate(-50%,-50%); width:200px; height:200px; z-index:10001;">

    
</html>


