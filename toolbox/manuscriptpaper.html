
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­æ–‡å¯«ä½œ</title>
    <style>
        body {
            background-image: url('https://i.ibb.co/4wkfXh5s/image.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            padding-bottom: 100px;
            overflow: auto;
        }

.copyright-footer {
    position: fixed;
    top: 0;
    right: 0;
    padding: 5px 10px;
    background-color: #f1f1f1;
    z-index: 1000;  /* ç¢ºä¿é¡¯ç¤ºåœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
}

.copyright-footer p {
    margin: 0;
    font-size: 14px;
}

@media (max-width: 600px) {
    .copyright-footer p {
        font-size: 12px;
    }
}
        
        #controls {
            margin-top: 20px; /* æ·»åŠ  20px ä¸Šé‚Šè· */
            text-align: center;
            margin-bottom: 10px;
        }
        .button-group {
            margin-bottom: 10px;
        }
        .button-group button {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        .action-btn {
            background-color: #4CAF50;
            color: white;
        }
        .action-btn:hover {
            background-color: #45a049;
        }
        .copy-btn {
            background-color: #2196F3;
            color: white;
        }
        .copy-btn:hover {
            background-color: #1e87db;
        }
        .ask-btn {
            background-color: #FF5722;
            color: white;
            font-weight: bold;
            font-size: 16px;
            padding: 12px 24px;
        }
        .ask-btn:hover {
            background-color: #E64A19;
        }
        .page {
            margin: 0 auto 10px;
            padding: 10px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            width: 100%;
            max-width: 600px;
        }
        .page.eye-protection {
            background-color: #fdf5e6;
        }
        .title {
            text-align: center;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .grid {
            border-collapse: separate;
            border-spacing: 0 2px;
            width: 100%;
        }
        .grid td {
            width: 5%;
            aspect-ratio: 1 / 1;
            border: 1px solid #ccc;
            position: relative;
            box-sizing: border-box;
        }
        .grid input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 16px;
            outline: none;
            background: transparent;
            box-sizing: border-box;
            padding: 0;
            line-height: 1;
        }
        .grid input:focus {
            border: 1px solid #4CAF50;
        }
        #word-count {
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
        }
        #progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        #progress-box {
            background: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
        #eye-protection {
            background-color: #FFD700;
            color: #333;
            transition: none;
        }
        #ask-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1003;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        #ask-panel h2 {
            margin-top: 0;
            text-align: center;
            margin-bottom: 10px;
        }
        #ask-panel select, #ask-panel textarea {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #ask-panel .outline-buttons button {
            width: auto;
            padding: 5px 10px;
            font-size: 12px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-segment-btn {
            background-color: #FFA500 !important;
            color: white;
        }
        .add-segment-btn:hover {
            background-color: #e69500 !important;
        }
        .save-btn {
            background-color: #800080 !important;
            color: white;
        }
        .save-btn:hover {
            background-color: #660066 !important;
        }
        .clear-btn {
            background-color: #A52A2A !important;
            color: white;
        }
        .clear-btn:hover {
            background-color: #8B2323 !important;
        }
        #submit-question {
            background-color: #007bff !important;
            color: white;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #submit-question:hover {
            background-color: #0056b3 !important;
        }
        #close-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            font-size: 16px;
            background-color: #dc3545 !important;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
        }
        #close-panel:hover {
            background-color: #c82333 !important;
        }
        .outline-buttons {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
        }
        .response-container {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        .table-container table {
            width: 100%;
            border-collapse: collapse;
        }
        .table-container th, .table-container td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
            vertical-align: top;
            word-break: break-word;
        }
        .table-container th:first-child, .table-container td:first-child {
            min-width: 50px;
        }
        .table-container th:nth-child(2), .table-container td:nth-child(2),
        .table-container th:nth-child(3), .table-container td:nth-child(3) {
            min-width: 100px;
        }
        .table-container td textarea {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            resize: none;
            overflow: hidden;
        }
        #title-input {
            width: 300px;
            padding: 5px;
            margin-top: 10px;
        }
        #music-player {
            position: fixed;
            bottom: 50px;
            left: 0;
            width: 100%;
            background-color: #444;
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1002;
            box-sizing: border-box;
            font-size: 14px;
        }
        #music-player.hidden {
            display: none;
        }
        #music-player .controls {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        #music-player .controls button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin-right: 10px;
        }
        #music-player .controls select {
            background: #555;
            color: white;
            border: none;
            padding: 5px;
            border-radius: 3px;
            max-width: 150px;
        }
        #music-player .progress {
            flex: 1;
            margin: 0 10px;
            display: flex;
            align-items: center;
        }
        #music-player .progress input[type="range"] {
            width: 100%;
        }
        #music-player .mode {
            margin-left: 10px;
            flex-shrink: 0;
        }
        #music-player .mode select {
            background: #555;
            color: white;
            border: none;
            padding: 5px;
            border-radius: 3px;
        }
        #music-player .hide-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin-left: 10px;
        }
        #show-player {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #444;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1003;
            display: none;
            font-size: 16px;
        }
        @media (max-width: 600px) {
            #music-player {
                flex-wrap: wrap;
                padding: 5px;
            }
            #music-player .controls select {
                max-width: 100px;
                font-size: 12px;
            }
            #music-player .mode select {
                font-size: 12px;
            }
            .page {
        margin: 0 20px 10px 0; /* æ‰‹æ©Ÿç‰ˆä¹Ÿåå·¦ï¼Œå·¦é‚Šè· 0pxï¼Œå³é‚Šè· 20px */
        max-width: calc(100% - 20px);
    }
        }
        #timer-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: #444;
            padding: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        #timer-panel select, #timer-panel button {
            padding: 5px;
            font-size: 12px;
            margin: 0 2px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background: none;
            color: white;
        }
        #timer-panel select {
            background-color: #555;
        }
        #timer-panel button {
            font-size: 20px;
        }
        #timer-display {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            margin: 0 10px;
            font-family: 'Courier New', Courier, monospace;
        }
        #timer-message {
            font-size: 12px;
            color: #e63946;
            margin-left: 10px;
            font-weight: bold;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
      <div id="controls">
    <div class="button-group">
        <button id="save" class="action-btn">ğŸ’¾</button>
        <button id="clear" class="action-btn">ğŸ—‘ï¸</button>
        <button id="add-page" class="action-btn">ğŸ“„</button>
            <button id="copy-all" class="copy-btn">ä¸€éµè¤‡è£½å…¨æ–‡</button>
            <button id="export-pdf" class="action-btn" style="background-color: red;">å°å‡ºPDF</button>
            <button id="eye-protection" class="action-btn">è­·çœ¼æ¨¡å¼</button>
            <button id="ask-chen" class="ask-btn">ğŸ‘¨â€ğŸ«å‘é™³SIRç™¼å•</button>
        </div>
        <div style="text-align: center; margin-top: 10px;">
            <input type="text" id="title-input" placeholder="è«‹è¼¸å…¥é¡Œç›®">
        </div>
    </div>
    <div id="manuscript"></div>
    <div id="word-count">å­—æ•¸ï¼š0</div>
    <div id="progress-overlay">
        <div id="progress-box">
            <p>æ­£åœ¨å°å‡º PDF...</p>
            <progress id="progress-bar" value="0" max="100"></progress>
        </div>
    </div>
    <div id="ask-panel">
        <button id="close-panel">âœ•</button>
        <h2>å‘é™³SIRç™¼å•</h2>
        <label for="category">æ–‡é¡ï¼š</label>
        <select id="category" onchange="toggleCategory()">
            <option value="æ•˜äº‹æŠ’æƒ…">æ•˜äº‹æŠ’æƒ…</option>
            <option value="è­°è«–">è­°è«–</option>
        </select>
        <div id="narrative-structure" style="display: none;">
            <label for="structure">é¸æ“‡çµæ§‹ï¼š</label>
            <select id="structure" onchange="generateOutlineTable()">
                <option value="fourPart">èµ·æ‰¿è½‰åˆ</option>
                <option value="threeLine">ä¸‰ç·š</option>
            </select>
        </div>
        <label for="tone">èªæ°£ï¼š</label>
        <select id="tone">
            <option value="serious">åš´è‚…æ­£ç¶“</option>
            <option value="chen">é™³SIRèªæ°£</option>
        </select>
        <div id="outline-area"></div>
        <textarea id="question" rows="4" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å•é¡Œ..."></textarea>
        <button id="submit-question">æäº¤å•é¡Œ</button>
        <div id="response"></div>
    </div>
    <div id="music-player">
        <div class="controls">
            <select id="music-select">
                <option value="">é¸æ“‡éŸ³æ¨‚</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Battle-Abysswalker.mp3">The Abysswalker</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Battle-Rosemoon.mp3">æ­»ã›ã‚‹éƒ½ã®æˆ°ä¹™å¥³</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Battle-deadly.mp3">äº”å¤§ç½ª</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Battle-rapier.mp3">ç¹¼æ‰¿åŠçš„å°‘å¥³</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Ariadne-Battle.mp3">ä¸å±ˆæ„å¿—ä¹‹åˆƒ</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/battle-arms.mp3">è¥¿éƒ¨æˆ°é¬¥</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Battle.mp3">Battle Theme</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Wanderers-City.mp3">æµæµªåŸé®</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Remotest-Liblary.mp3">æ²‰ç¡çš„è¨˜æ†¶</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Nostalgia.mp3">éº¥ç”°æ‡·èˆŠ</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/sunbeams.mp3">æ”¾å­¸å¾Œ</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/village.mp3">é„‰æ‘ç”Ÿæ´»</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Take-a-Rest.mp3">ä¼‘æ¯ä¸€ä¸‹</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/winter-snow.mp3">é›ªé„‰</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Forgotten-Place.mp3">è¢«éºå¿˜çš„åœ°æ–¹</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Rest-in-Peace.mp3">å®‰æ¯</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Farewell.mp3">å‘Šåˆ¥</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/reminiscence.mp3">å›æ†¶</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/starry-night.mp3">æ˜Ÿå¤œ</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/last-wish.mp3">ç•¶æ€å¿µå‚³åˆ°æŸäººè€³ç•”</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/sorrow.mp3">è¶…è¶Šæ‚²å‚·</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/hotarumichi.mp3">è¢ç«èŸ²ä¹‹è·¯</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Sky-Airship.mp3">é£›è‰‡</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/Voyage_SE.mp3">è·¨è¶Šç¥ç§˜ä¹‹æµ·</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/main-theme01.mp3">ç›¼æœ›</option>
                <option value="https://youfulca.com/wp-content/uploads/2022/08/saikai637.mp3">ç´„å®šä¹‹åœ°</option>
            </select>
            <button id="play-pause">â–¶ï¸</button>
        </div>
        <div class="progress">
            <input type="range" id="progress-bar-music" value="0" min="0" max="100">
        </div>
        <div class="mode">
            <select id="play-mode">
                <option value="loop" selected>å–®æ›²å¾ªç’°</option>
                <option value="next">è‡ªå‹•æ’­æ”¾ä¸‹é¦–</option>
            </select>
        </div>
        <button class="hide-btn" id="hide-player">ğŸ”½</button>
    </div>
    <button id="show-player">ğŸµ</button>
    <audio id="audio" preload="auto"></audio>
    <div id="timer-panel">
        <select id="genre-select" onchange="toggleStructureSelect()">
            <option value="æ•˜äº‹æŠ’æƒ…">æ•˜äº‹æŠ’æƒ…</option>
            <option value="è­°è«–">è­°è«–</option>
        </select>
        <div id="structure-select-div" style="display: inline-block;">
            <select id="structure-select">
                <option value="èµ·æ‰¿è½‰åˆ">èµ·æ‰¿è½‰åˆ</option>
                <option value="ä¸‰ç·š">ä¸‰ç·š</option>
            </select>
        </div>
        <button id="toggle-timer" class="action-btn">â–¶ï¸</button>
        <button id="reset-timer" class="action-btn">ğŸ”„</button>
        <div id="timer-display">01:30:00</div>
        <div id="timer-message"></div>
    </div>




<!-- =============================================================== -->
<!-- 2. ç¥æ€åš´æ ¼æ¬Šé™é– (ç­‰å¾…æ©Ÿåˆ¶ä¿®å¾©ç‰ˆ) -->
<!-- =============================================================== -->
<script>
(function() {
    if (window.SansiInterceptorLoaded) return;
    window.SansiInterceptorLoaded = true;

    // --- æ³¨å…¥ CSS ---
    const style = document.createElement('style');
    style.textContent = `
        .sansi-limit-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(253, 252, 248, 0.95); backdrop-filter: blur(8px); z-index: 9999999; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .sansi-limit-show { opacity: 1; }
        .sansi-limit-card { background: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 16px; padding: 35px 25px; width: 90%; max-width: 380px; box-shadow: 0 15px 40px rgba(141, 110, 99, 0.2); text-align: center; transform: translateY(20px); transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); font-family: 'Noto Serif TC', serif; }
        .sansi-limit-show .sansi-limit-card { transform: translateY(0); }
        .sansi-limit-icon { font-size: 3.5rem; color: #d69a92; margin-bottom: 20px; }
        .sansi-limit-title { color: #5d4037; font-size: 1.5rem; font-weight: bold; margin: 0 0 15px 0; }
        .sansi-limit-desc { color: #666; font-size: 1.1rem; line-height: 1.6; margin-bottom: 30px; }
        .sansi-btn-group { display: flex; gap: 12px; margin-top: 10px; }
        .sansi-limit-btn { border: none; padding: 12px 0; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; font-family: 'Noto Serif TC', serif; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; }
        .btn-primary { background: #8fa398; color: white; box-shadow: 0 4px 12px rgba(143, 163, 152, 0.4); }
        .btn-primary:hover { background-color: #7d9186; transform: translateY(-2px); }
        .btn-secondary { background: #f0f0f0; color: #777; }
        .btn-secondary:hover { background-color: #e5e5e5; }
    `;
    document.head.appendChild(style);

    // --- æ³¨å…¥ HTML ---
    const modalHTML = `
        <div id="sansiLimitModal" class="sansi-limit-overlay">
            <div class="sansi-limit-card">
                <div class="sansi-limit-icon"><i class="fas fa-lock"></i></div>
                <div class="sansi-limit-title">æœƒå“¡é™å®šåŠŸèƒ½</div>
                <div class="sansi-limit-desc">
                    æ­¤åŠŸèƒ½åƒ…é–‹æ”¾çµ¦ç¥æ€ç™»å…¥ç”¨æˆ¶ã€‚<br>è«‹å…ˆç™»å…¥å­¸æ ¡å¸³è™Ÿä»¥ç¹¼çºŒä½¿ç”¨ã€‚
                </div>
                <div class="sansi-btn-group">
                    <button class="sansi-limit-btn btn-secondary" onclick="closeSansiLimitModal()">å–æ¶ˆ</button>
                    <button class="sansi-limit-btn btn-primary" onclick="window.location.href='../index2.html'">
                        <i class="fas fa-sign-in-alt"></i> å‰å¾€ç™»å…¥
                    </button>
                </div>
            </div>
        </div>
    `;
    const div = document.createElement('div');
    div.innerHTML = modalHTML;
    document.body.appendChild(div);

    window.closeSansiLimitModal = function() {
        const modal = document.getElementById('sansiLimitModal');
        if (modal) {
            modal.classList.remove('sansi-limit-show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
            if (typeof loading !== 'undefined') loading.style.display = 'none';
        }
    };

    // --- â˜…â˜…â˜… æ ¸å¿ƒæ””æˆªå™¨ (Waiting Logic Added) â˜…â˜…â˜… ---
    const originalFetch = window.fetch;
    
    window.fetch = async function(url, options) {
        if (typeof url === 'string' && url.includes('script.google.com') && options && options.method === 'POST') {
            
            console.log("[WenShu] æ””æˆªè«‹æ±‚ï¼Œæº–å‚™æª¢æŸ¥æ¬Šé™...");

            // 1. ç­‰å¾… Firebase åˆå§‹åŒ– (æœ€å¤šç­‰ 2 ç§’)
            // é€™ä¸€æ­¥æ˜¯è§£æ±ºå•é¡Œçš„é—œéµï¼
            const user = await new Promise((resolve) => {
                if (firebase.auth().currentUser) {
                    resolve(firebase.auth().currentUser);
                } else {
                    const unsubscribe = firebase.auth().onAuthStateChanged(u => {
                        unsubscribe();
                        resolve(u);
                    });
                    // 2ç§’è¶…æ™‚æ©Ÿåˆ¶ï¼Œé¿å…ç„¡é™ç­‰å¾…
                    setTimeout(() => resolve(null), 2000);
                }
            });

            // 2. å†æ¬¡æª¢æŸ¥ LocalStorage (é›™é‡é©—è­‰)
            const s = localStorage.getItem('studentProfile');

            if (!s) {
                console.warn("ğŸš« é˜»æ“‹ï¼šæœ¬åœ°ç„¡å­¸ç”Ÿè³‡æ–™");
                const modal = document.getElementById('sansiLimitModal');
                modal.style.display = 'flex';
                void modal.offsetWidth; 
                modal.classList.add('sansi-limit-show');
                
                const loadingEl = document.getElementById('loading');
                if(loadingEl) loadingEl.style.display = 'none';

                return Promise.reject(new Error("Login Required"));
            }

            // 3. æ³¨å…¥ Token (å¦‚æœ User å­˜åœ¨)
            if (user) {
                try {
                    const token = await user.getIdToken();
                    let bodyData = JSON.parse(options.body);
                    bodyData.token = token; 
                    options.body = JSON.stringify(bodyData);
                    console.log("âœ… Token æ³¨å…¥æˆåŠŸ");
                } catch (e) {
                    console.error("Token ç²å–å¤±æ•— (å¯èƒ½æ†‘è­‰å·²éæœŸ):", e);
                    // é€™è£¡ä¸é˜»æ“‹ï¼Œå˜—è©¦ç™¼é€ï¼Œè®“å¾Œç«¯æ±ºå®šæ˜¯å¦æ‹’çµ•
                }
            } else {
                console.warn("âš ï¸ æ³¨æ„ï¼šæœ‰å­¸ç”Ÿè³‡æ–™ä½† Firebase æœªé€£ç·š (Token æœªæ³¨å…¥)");
            }
        }
        
        return originalFetch(url, options);
    };
    
    console.log("ğŸ”’ æ–‡æ¨æ™ºèƒ½æ¬Šé™é–å·²å•Ÿå‹•");
})();
</script>


    
    <script>
        const manuscript = document.getElementById('manuscript');
        const wordCountDiv = document.getElementById('word-count');
        const progressOverlay = document.getElementById('progress-overlay');
        const progressBar = document.getElementById('progress-bar');
        const askPanel = document.getElementById('ask-panel');
        let pageCount = 0;
        let totalWords = 0;
        let isEyeProtection = false;

// --- 1. ä¿®æ”¹ API é…ç½® (ç§»é™¤åŸæœ¬çš„ API_KEYS é™£åˆ—) ---
const API_URL = "https://script.google.com/macros/s/AKfycbw3GLUM12ls3PhST5TkimLZvZwQx2H4RG8g2SbZiMJmuxg3HqsO_d13kPU4AnKpxi2P6A/exec";
const MODEL = "gemini"; // é è¨­æ¨¡å‹

        const audio = document.getElementById('audio');
        const playPauseBtn = document.getElementById('play-pause');
        const musicSelect = document.getElementById('music-select');
        const progressBarMusic = document.getElementById('progress-bar-music');
        const playMode = document.getElementById('play-mode');
        const hidePlayerBtn = document.getElementById('hide-player');
        const showPlayerBtn = document.getElementById('show-player');
        const musicPlayer = document.getElementById('music-player');

        let isPlaying = false;
        let currentMusic = '';

        let timerInterval;
        let totalTime = 5400;
        let remainingTime = totalTime;
        let isTimerRunning = false;
        let prompts = [];
        let promptIndex = 0;

        function getRows(page) {
            return page % 2 === 1 ? 15 : 20;
        }

        function getCols() {
            return 20;
        }

        function updateWordCount() {
            totalWords = 0;
            for (let page = 1; page <= pageCount; page++) {
                const rows = getRows(page);
                const cols = getCols();
                for (let row = 1; row <= rows; row++) {
                    for (let col = 1; col <= cols; col++) {
                        const input = document.querySelector(
                            `input[data-page="${page}"][data-row="${row}"][data-col="${col}"]`
                        );
                        if (input && input.value) totalWords++;
                    }
                }
            }
            wordCountDiv.textContent = `å­—æ•¸ï¼š${totalWords}`;
        }

        function addPage() {
            pageCount++;
            const rows = getRows(pageCount);
            const cols = getCols();
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            if (isEyeProtection) pageDiv.classList.add('eye-protection');
            pageDiv.dataset.page = pageCount;
            const title = document.createElement('div');
            title.className = 'title';
            const titleInput = document.getElementById('title-input');
            title.textContent = titleInput.value.trim() || 'ä¸­æ–‡å¯«ä½œ';
            pageDiv.appendChild(title);
            const table = document.createElement('table');
            table.className = 'grid';
            for (let row = 1; row <= rows; row++) {
                const tr = document.createElement('tr');
                for (let col = 1; col <= cols; col++) {
                    const td = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.dataset.page = pageCount;
                    input.dataset.row = row;
                    input.dataset.col = col;
                    input.addEventListener('compositionstart', function() { this.isComposing = true; });
                    input.addEventListener('compositionend', function() { this.isComposing = false; handleInput(this); });
                    input.addEventListener('input', function() { if (!this.isComposing) handleInput(this); });
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Backspace' && this.value === '') {
                            moveToPrevInput(this);
                            updateWordCount();
                        } else if (e.key === 'ArrowLeft') {
                            moveToLeftInput(this);
                        } else if (e.key === 'ArrowRight') {
                            moveToRightInput(this);
                        } else if (e.key === 'ArrowUp') {
                            moveToUpInput(this);
                        } else if (e.key === 'ArrowDown') {
                            moveToDownInput(this);
                        }
                    });
                    input.addEventListener('paste', function(e) {
                        e.preventDefault();
                        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                        const currentInput = this;
                        const allInputs = getAllInputs();
                        const N = allInputs.length;
                        const currentIndex = allInputs.indexOf(currentInput);
                        const pastedChars = pastedText.split('');
                        const M = pastedChars.length;
                        let insertIndex = currentIndex;
                        if (this.selectionStart === 1) insertIndex++;
                        const remainingSpace = N - insertIndex;
                        if (M > remainingSpace) {
                            const pagesToAdd = Math.ceil((M - remainingSpace) / (getRows(pageCount + 1) * getCols()));
                            for (let i = 0; i < pagesToAdd; i++) addPage();
                            allInputs = getAllInputs();
                        }
                        const arr = allInputs.map(input => input.value || '');
                        arr.splice(insertIndex, 0, ...pastedChars);
                        for (let i = 0; i < allInputs.length; i++) {
                            allInputs[i].value = arr[i] || '';
                        }
                        updateWordCount();
                        const newFocusIndex = Math.min(insertIndex + M, allInputs.length - 1);
                        allInputs[newFocusIndex].focus();
                    });
                    td.appendChild(input);
                    tr.appendChild(td);
                }
                table.appendChild(tr);
            }
            pageDiv.appendChild(table);
            manuscript.appendChild(pageDiv);
            updateWordCount();
        }

        function handleInput(currentInput) {
            const value = currentInput.value;
            if (value.length > 1) {
                const chars = value.split('');
                let input = currentInput;
                for (let i = 0; i < chars.length; i++) {
                    if (i > 0) {
                        let nextInput = getNextInput(input);
                        if (!nextInput) {
                            addPage();
                            nextInput = getNextInput(input);
                        }
                        let tempInput = nextInput;
                        let tempValue = tempInput.value;
                        while (tempInput) {
                            const nextTempInput = getNextInput(tempInput);
                            const currentValue = tempInput.value;
                            tempInput.value = tempValue;
                            tempValue = currentValue;
                            tempInput = nextTempInput;
                            if (!tempInput || tempValue === '') break;
                        }
                        input = nextInput;
                    }
                    input.value = chars[i];
                    updateWordCount();
                }
                if (input) input.focus();
            } else if (value.length === 1) {
                updateWordCount();
                let nextInput = getNextInput(currentInput);
                if (nextInput) nextInput.focus();
            } else {
                updateWordCount();
            }
        }

        function getNextInput(currentInput) {
            let currentPage = parseInt(currentInput.dataset.page);
            let currentRow = parseInt(currentInput.dataset.row);
            let currentCol = parseInt(currentInput.dataset.col);
            let nextCol = currentCol + 1;
            let nextRow = currentRow;
            let nextPage = currentPage;
            const cols = getCols();
            const rows = getRows(currentPage);
            if (nextCol > cols) {
                nextCol = 1;
                nextRow = currentRow + 1;
                if (nextRow > rows) {
                    nextRow = 1;
                    nextPage = currentPage + 1;
                    if (nextPage > pageCount) return null;
                }
            }
            return document.querySelector(
                `input[data-page="${nextPage}"][data-row="${nextRow}"][data-col="${nextCol}"]`
            );
        }

        function moveToPrevInput(currentInput) {
            const allInputs = getAllInputs();
            const currentIndex = allInputs.indexOf(currentInput);
            if (currentIndex > 0) {
                const prevInput = allInputs[currentIndex - 1];
                prevInput.value = '';
                for (let i = currentIndex; i < allInputs.length - 1; i++) {
                    allInputs[i].value = allInputs[i + 1].value;
                }
                allInputs[allInputs.length - 1].value = '';
                prevInput.focus();
            }
        }

        function moveToLeftInput(currentInput) {
            const allInputs = getAllInputs();
            const currentIndex = allInputs.indexOf(currentInput);
            if (currentIndex > 0) {
                allInputs[currentIndex - 1].focus();
            }
        }

        function moveToRightInput(currentInput) {
            const allInputs = getAllInputs();
            const currentIndex = allInputs.indexOf(currentInput);
            if (currentIndex < allInputs.length - 1) {
                allInputs[currentIndex + 1].focus();
            }
        }

        function moveToUpInput(currentInput) {
            const currentPage = parseInt(currentInput.dataset.page);
            const currentRow = parseInt(currentInput.dataset.row);
            const currentCol = parseInt(currentInput.dataset.col);
            let prevRow = currentRow - 1;
            let prevPage = currentPage;
            if (prevRow < 1) {
                prevPage = currentPage - 1;
                if (prevPage < 1) return;
                prevRow = getRows(prevPage);
            }
            const prevInput = document.querySelector(
                `input[data-page="${prevPage}"][data-row="${prevRow}"][data-col="${currentCol}"]`
            );
            if (prevInput) prevInput.focus();
        }

        function moveToDownInput(currentInput) {
            const currentPage = parseInt(currentInput.dataset.page);
            const currentRow = parseInt(currentInput.dataset.row);
            const currentCol = parseInt(currentInput.dataset.col);
            let nextRow = currentRow + 1;
            let nextPage = currentPage;
            const rows = getRows(currentPage);
            if (nextRow > rows) {
                nextPage = currentPage + 1;
                if (nextPage > pageCount) return;
                nextRow = 1;
            }
            const nextInput = document.querySelector(
                `input[data-page="${nextPage}"][data-row="${nextRow}"][data-col="${currentCol}"]`
            );
            if (nextInput) nextInput.focus();
        }

        function getAllInputs() {
            const allInputs = [];
            for (let page = 1; page <= pageCount; page++) {
                const rows = getRows(page);
                const cols = getCols();
                for (let row = 1; row <= rows; row++) {
                    for (let col = 1; col <= cols; col++) {
                        const input = document.querySelector(
                            `input[data-page="${page}"][data-row="${row}"][data-col="${col}"]`
                        );
                        allInputs.push(input);
                    }
                }
            }
            return allInputs;
        }

        addPage();

        document.getElementById('add-page').addEventListener('click', addPage);

        document.getElementById('save').addEventListener('click', function() {
            const data = [];
            for (let page = 1; page <= pageCount; page++) {
                const rows = getRows(page);
                const cols = getCols();
                const pageData = [];
                for (let row = 1; row <= rows; row++) {
                    const rowData = [];
                    for (let col = 1; col <= cols; col++) {
                        const input = document.querySelector(
                            `input[data-page="${page}"][data-row="${row}"][data-col="${col}"]`
                        );
                        rowData.push(input.value);
                    }
                    pageData.push(rowData);
                }
                data.push(pageData);
            }
            localStorage.setItem('manuscript', JSON.stringify(data));
            const title = document.getElementById('title-input').value;
            localStorage.setItem('title', title);
            alert('æ–‡ç« å·²å„²å­˜');
        });

        document.getElementById('clear').addEventListener('click', function() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ–‡å­—å—ï¼Ÿ')) {
                manuscript.innerHTML = '';
                pageCount = 0;
                addPage();
                localStorage.removeItem('manuscript');
                localStorage.removeItem('title');
                document.getElementById('title-input').value = '';
                updateWordCount();
            }
        });

        function loadManuscript() {
            const data = JSON.parse(localStorage.getItem('manuscript'));
            if (data) {
                data.forEach((pageData, pageIndex) => {
                    if (pageIndex > 0) addPage();
                    const rows = getRows(pageIndex + 1);
                    const cols = getCols();
                    for (let row = 1; row <= rows; row++) {
                        for (let col = 1; col <= cols; col++) {
                            const input = document.querySelector(
                                `input[data-page="${pageIndex + 1}"][data-row="${row}"][data-col="${col}"]`
                            );
                            input.value = pageData[row - 1][col - 1];
                        }
                    }
                });
                updateWordCount();
            }
            const savedTitle = localStorage.getItem('title');
            if (savedTitle) {
                document.getElementById('title-input').value = savedTitle;
                const titles = document.querySelectorAll('.title');
                titles.forEach(title => title.textContent = savedTitle);
            }
        }
        loadManuscript();

        document.getElementById('copy-all').addEventListener('click', function() {
            let text = '';
            let isNewParagraph = true;
            for (let page = 1; page <= pageCount; page++) {
                const rows = getRows(page);
                const cols = getCols();
                for (let row = 1; row <= rows; row++) {
                    let line = '';
                    let isEmptyFirstTwo = true;
                    for (let col = 1; col <= cols; col++) {
                        const input = document.querySelector(
                            `input[data-page="${page}"][data-row="${row}"][data-col="${col}"]`
                        );
                        const char = input.value || '';
                        line += char;
                        if (col <= 2 && char !== '') isEmptyFirstTwo = false;
                    }
                    line = line.trimEnd();
                    if (line) {
                        if (isNewParagraph && isEmptyFirstTwo) text += '\n';
                        text += line + '\n';
                        isNewParagraph = isEmptyFirstTwo;
                    } else {
                        text += '\n';
                        isNewParagraph = true;
                    }
                }
                if (page < pageCount) text += '\n';
            }
            navigator.clipboard.writeText(text).then(() => {
                alert('å…¨æ–‡å·²è¤‡è£½åˆ°å‰ªè²¼æ¿');
            }).catch(err => console.error('è¤‡è£½å¤±æ•—:', err));
        });

        const eyeProtectionBtn = document.getElementById('eye-protection');
        eyeProtectionBtn.addEventListener('click', function() {
            isEyeProtection = !isEyeProtection;
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                if (isEyeProtection) page.classList.add('eye-protection');
                else page.classList.remove('eye-protection');
            });
            localStorage.setItem('eyeProtection', isEyeProtection);
        });

        if (localStorage.getItem('eyeProtection') === 'true') {
            isEyeProtection = true;
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.add('eye-protection'));
        }

        document.getElementById('export-pdf').addEventListener('click', async function() {
            progressOverlay.style.display = 'flex';
            progressBar.value = 0;
            const pages = document.querySelectorAll('.page');
            const totalPages = pages.length;
            const originalBoxShadows = [];
            pages.forEach(page => {
                originalBoxShadows.push(page.style.boxShadow);
                page.style.boxShadow = 'none';
            });
            const pdf = new jspdf.jsPDF({ orientation: 'portrait', unit: 'px', format: 'a4' });
            for (let i = 0; i < totalPages; i++) {
                const page = pages[i];
                const canvas = await html2canvas(page, {
                    scale: 2,
                    useCORS: true,
                    width: page.offsetWidth,
                    height: page.offsetHeight
                });
                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pdfWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                if (i > 0) pdf.addPage([pdfWidth, imgHeight * (pdfHeight / imgHeight)]);
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                progressBar.value = ((i + 1) / totalPages) * 100;
            }
            pages.forEach((page, index) => page.style.boxShadow = originalBoxShadows[index]);
            pdf.save('manuscript.pdf');
            progressOverlay.style.display = 'none';
        });

        document.getElementById('ask-chen').addEventListener('click', function() {
            askPanel.style.display = 'block';
            toggleCategory();
        });

        document.getElementById('close-panel').addEventListener('click', function() {
            askPanel.style.display = 'none';
        });

        let isDragging = false;
        let offsetX, offsetY;
        askPanel.addEventListener('mousedown', function(e) {
            if (e.target === askPanel) {
                isDragging = true;
                offsetX = e.clientX - askPanel.getBoundingClientRect().left;
                offsetY = e.clientY - askPanel.getBoundingClientRect().top;
                askPanel.classList.add('drag');
            }
        });
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                askPanel.style.left = (e.clientX - offsetX) + 'px';
                askPanel.style.top = (e.clientY - offsetY) + 'px';
                askPanel.style.transform = 'none';
            }
        });
        document.addEventListener('mouseup', function() {
            isDragging = false;
            askPanel.classList.remove('drag');
        });

        function toggleCategory() {
            const category = document.getElementById('category').value;
            const narrativeStructure = document.getElementById('narrative-structure');
            if (category === 'æ•˜äº‹æŠ’æƒ…') {
                narrativeStructure.style.display = 'block';
                generateOutlineTable();
            } else {
                narrativeStructure.style.display = 'none';
                generateArgumentOutlineTable();
            }
        }


function autoSave() {
    const data = [];
    for (let page = 1; page <= pageCount; page++) {
        const rows = getRows(page);
        const cols = getCols();
        const pageData = [];
        for (let row = 1; row <= rows; row++) {
            const rowData = [];
            for (let col = 1; col <= cols; col++) {
                const input = document.querySelector(
                    `input[data-page="${page}"][data-row="${row}"][data-col="${col}"]`
                );
                rowData.push(input.value);
            }
            pageData.push(rowData);
        }
        data.push(pageData);
    }
    localStorage.setItem('manuscript', JSON.stringify(data));
    const title = document.getElementById('title-input').value;
    localStorage.setItem('title', title);
    console.log('è‡ªå‹•ä¿å­˜æˆåŠŸ');
}

        // æ‰‹å‹•å„²å­˜æŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
    document.getElementById('save').addEventListener('click', function() {
        autoSave();
        alert('æ–‡ç« å·²å„²å­˜');
    });


        
        function generateOutlineTable() {
            const structure = document.getElementById('structure').value;
            let parts = structure === 'fourPart' ? ['èµ·', 'æ‰¿', 'è½‰', 'åˆ'] : ['èµ·', 'ä¸€ç·š', 'äºŒç·š', 'ä¸‰ç·š', 'åˆ'];
            const savedData = localStorage.getItem('narrativeOutlineData');
            let outlineData = [];
            if (savedData) {
                try {
                    outlineData = JSON.parse(savedData);
                } catch (e) {
                    console.error('Error parsing narrativeOutlineData:', e);
                }
            }
            if (outlineData.length === 0 || outlineData.length !== parts.length) {
                outlineData = parts.map(part => ({ part, focus: '', plot: '' }));
            }
            let tableHTML = `
                <div class="table-container">
                    <table id="narrativeOutlineTable">
                        <tr><th>éƒ¨ä»½</th><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th></tr>`;
            outlineData.forEach((item, index) => {
                tableHTML += `
                    <tr>
                        <td>${item.part}</td>
                        <td><textarea id="narrativeFocus${index}" rows="3">${item.focus}</textarea></td>
                        <td><textarea id="narrativePlot${index}" rows="3">${item.plot}</textarea></td>
                    </tr>`;
            });
            tableHTML += `
                    </table>
                </div>
                <div class="outline-buttons">
                    <button class="save-btn" onclick="saveNarrativeOutline()">å„²å­˜</button>
                    <button class="clear-btn" onclick="clearNarrativeOutline()">æ¸…ç©º</button>
                </div>`;
            document.getElementById('outline-area').innerHTML = tableHTML;
        }

        function generateArgumentOutlineTable() {
            const savedData = localStorage.getItem('argumentOutlineData');
            let outlineData = [];
            if (savedData) {
                try {
                    outlineData = JSON.parse(savedData);
                } catch (e) {
                    console.error('Error parsing argumentOutlineData:', e);
                }
            }
            if (outlineData.length === 0) {
                outlineData = [
                    { part: 'èµ·', point: '', evidence: '' },
                    { part: 'çµæ§‹æ®µä¸€', point: '', evidence: '' },
                    { part: 'çµæ§‹æ®µäºŒ', point: '', evidence: '' },
                    { part: 'çµæ§‹æ®µä¸‰', point: '', evidence: '' },
                    { part: 'åˆ', point: '', evidence: '' }
                ];
            }
            let tableHTML = `
                <div class="table-container">
                    <table id="argumentOutlineTable">
                        <tr><th>éƒ¨ä»½</th><th>è«–é»</th><th>è«–æ“šåŠè«–è­‰</th></tr>`;
            outlineData.forEach((item, index) => {
                tableHTML += `
                    <tr>
                        <td>${item.part}</td>
                        <td><textarea id="argumentPoint${index}" rows="3">${item.point}</textarea></td>
                        <td><textarea id="argumentEvidence${index}" rows="3">${item.evidence}</textarea></td>
                    </tr>`;
            });
            tableHTML += `
                    </table>
                </div>
                <div class="outline-buttons">
                    <button class="add-segment-btn" onclick="addArgumentStructureSegment()">æ–°å¢çµæ§‹æ®µ</button>
                    <button class="save-btn" onclick="saveArgumentOutline()">å„²å­˜</button>
                    <button class="clear-btn" onclick="clearArgumentOutline()">æ¸…ç©º</button>
                </div>`;
            document.getElementById('outline-area').innerHTML = tableHTML;
        }

        function addArgumentStructureSegment() {
            const table = document.getElementById('argumentOutlineTable');
            const rows = table.rows;
            let structureSegmentCount = 0;
            for (let i = 1; i < rows.length - 1; i++) {
                if (rows[i].cells[0].innerText.startsWith('çµæ§‹æ®µ')) structureSegmentCount++;
            }
            const newSegmentNumber = structureSegmentCount + 1;
            const chineseNumbers = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'];
            const segmentName = `çµæ§‹æ®µ${chineseNumbers[newSegmentNumber - 1] || newSegmentNumber}`;
            const newRowIndex = rows.length - 1;
            const newRow = table.insertRow(newRowIndex);
            const cell1 = newRow.insertCell(0);
            const cell2 = newRow.insertCell(1);
            const cell3 = newRow.insertCell(2);
            cell1.innerText = segmentName;
            cell2.innerHTML = `<textarea id="argumentPoint${newRowIndex - 1}" rows="3"></textarea>`;
            cell3.innerHTML = `<textarea id="argumentEvidence${newRowIndex - 1}" rows="3"></textarea>`;
        }

        function saveNarrativeOutline() {
            const table = document.getElementById('narrativeOutlineTable');
            const rows = table.rows;
            const outlineData = [];
            for (let i = 1; i < rows.length; i++) {
                const part = rows[i].cells[0].innerText;
                const focusTextarea = rows[i].cells[1].querySelector('textarea');
                const plotTextarea = rows[i].cells[2].querySelector('textarea');
                const focus = focusTextarea ? focusTextarea.value.trim() : '';
                const plot = plotTextarea ? plotTextarea.value.trim() : '';
                outlineData.push({ part, focus, plot });
            }
            localStorage.setItem('narrativeOutlineData', JSON.stringify(outlineData));
            alert('å¤§ç¶±å·²å„²å­˜');
        }

        function clearNarrativeOutline() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºå¤§ç¶±å—ï¼Ÿ')) {
                const table = document.getElementById('narrativeOutlineTable');
                const rows = table.rows;
                for (let i = 1; i < rows.length; i++) {
                    document.getElementById(`narrativeFocus${i - 1}`).value = '';
                    document.getElementById(`narrativePlot${i - 1}`).value = '';
                }
                localStorage.removeItem('narrativeOutlineData');
            }
        }

        function saveArgumentOutline() {
            const table = document.getElementById('argumentOutlineTable');
            const rows = table.rows;
            const outlineData = [];
            for (let i = 1; i < rows.length; i++) {
                const part = rows[i].cells[0].innerText;
                const pointTextarea = rows[i].cells[1].querySelector('textarea');
                const evidenceTextarea = rows[i].cells[2].querySelector('textarea');
                const point = pointTextarea ? pointTextarea.value.trim() : '';
                const evidence = evidenceTextarea ? evidenceTextarea.value.trim() : '';
                outlineData.push({ part, point, evidence });
            }
            localStorage.setItem('argumentOutlineData', JSON.stringify(outlineData));
            alert('å¤§ç¶±å·²å„²å­˜');
        }

        function clearArgumentOutline() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºå¤§ç¶±å—ï¼Ÿ')) {
                const table = document.getElementById('argumentOutlineTable');
                const rows = table.rows;
                for (let i = 1; i < rows.length; i++) {
                    document.getElementById(`argumentPoint${i - 1}`).value = '';
                    document.getElementById(`argumentEvidence${i - 1}`).value = '';
                }
                localStorage.removeItem('argumentOutlineData');
            }
        }

        document.getElementById('submit-question').addEventListener('click', async function() {
            const category = document.getElementById('category').value;
            const tone = document.getElementById('tone').value;
            const question = document.getElementById('question').value.trim();
            if (!question) {
                alert('è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ');
                return;
            }

            const manuscriptContent = getManuscriptContent();
            const title = getTitleFromInput();

            let outlineData = '';
            if (category === 'æ•˜äº‹æŠ’æƒ…') outlineData = getNarrativeOutlineData();
            else if (category === 'è­°è«–') outlineData = getArgumentOutlineData();

            let prompt = `å­¸ç”Ÿæ­£åœ¨æ’°å¯«ä¸€ç¯‡${category}æ–‡ç« ï¼Œé¡Œç›®æ˜¯ã€Œ${title}ã€ã€‚ä»¥ä¸‹æ˜¯å­¸ç”Ÿå·²å¯«çš„å…§å®¹ï¼š\n${manuscriptContent}\n\nä»¥ä¸‹æ˜¯å¤§ç¶±å…§å®¹ï¼š\n${outlineData}\n\nå­¸ç”Ÿçš„å•é¡Œæ˜¯ï¼š${question}\n\nè«‹æ ¹æ“šå­¸ç”Ÿçš„å•é¡Œå’Œæ–‡ç« å…§å®¹ï¼Œæä¾›ç°¡æ½”çš„å›æ‡‰ï¼Œä¸è¶…é100å­—ã€‚`;

            if (category === 'æ•˜äº‹æŠ’æƒ…') {
                prompt += `\n\nåƒè€ƒç­†è¨˜ï¼šå¿…é ˆç”¨ç¹é«”å­—å›æ‡‰ï¼Œå¿…é ˆå› æ‡‰ç”¨å®¶é¸æ“‡çš„çµæ§‹ï¼ˆå³ã€Œèµ·æ‰¿è½‰åˆã€æˆ–ã€Œä¸‰ç·šã€ï¼‰å»å›æ‡‰ï¼Œç•¶ç”¨å®¶é¸æ“‡ã€Œèµ·æ‰¿è½‰åˆã€ï¼Œå‰‡ä¸è¦ä»¥ã€Œä¸‰ç·šã€æ€ç¶­å›æ‡‰ï¼Œåä¹‹äº¦ç„¶ã€‚æ•˜äº‹æŠ’æƒ…æ–‡ä½³ä½œæœ‰ä»¥ä¸‹ç‰¹é»ï¼šä¸€ã€çµæ§‹æ®µé‡é»èˆ‡é¡Œç›®æœ‰åš´è¬¹çš„é‚è¼¯é—œä¿‚ï¼›äºŒã€æƒ…ç¯€å¤§è¦èƒ½çªé¡¯çµæ§‹æ®µé‡é»ï¼›ä¸‰ï¼Œè©³ç•¥å‰ªè£æ°ç•¶ï¼›å››ï¼Œæ–‡å¥å¯†åº¦åˆé©ï¼ˆè©åŒ¯è±å¯Œã€å¯¦è©ç‚ºä¸»è€Œè™›è©ç‚ºå‰¯ï¼Œä½†éçŒ¶ä¸åŠï¼Œé©æ™‚éœ€è¦é‹ç”¨è™›è©ä»¤æ–‡å¥éŒ¯è½æœ‰è‡´ï¼‰ï¼›äº”ï¼Œé ˆé‹ç”¨è±å¯Œç‰©è±¡å¢å¼·æ•…äº‹ç”Ÿå‹•æ€§å’ŒçœŸå¯¦æ„Ÿï¼Œç‰©è±¡æ‡‰èˆ‡é¡Œç›®ç·Šå¯†ç›¸é—œï¼Œè¡¨é”æƒ…æ„Ÿèˆ‡ä¸»é¡Œã€‚æ‡‰äº¤æ›¿ä½¿ç”¨å°ç‰©ä»¶ã€å‹•ä½œã€å°è©±å’Œå…§å¿ƒç¨ç™½ï¼Œæ‡‰é¿å…ä»¥ä¸»è§’çš„èº«é«”éƒ¨ä»½ä½œç‚ºä¸»èªæˆ–å°ç‰©ä»¶ï¼Œè¦æé«˜æ–‡å¥å¯†åº¦ï¼Œä½†éœ€æ§åˆ¶è©³ç•¥ç¯€å¥ï¼Œè©³å¯«ç›¸é—œéƒ¨åˆ†ï¼Œç•¥å¯«æ¬¡è¦å…§å®¹ï¼›å…­ï¼Œä¸‰ç·šï¼Œå³æ‰€è¬‚ã€Œæ•£æ•˜ã€ï¼Œæœ‰ä»¥ä¸‹å››é»è¦æ³¨æ„ï¼šå…¶ä¸€ï¼Œä¸‰ç·šçš„åˆ†é¡ç¯„ç–‡ç›¸åŒï¼›å…¶äºŒï¼Œä¸‰ç·šæˆ–æœ‰å±¤éé—œä¿‚ï¼Œæˆ–èƒ½å¾ä¸‰å€‹è§’åº¦å‘ˆç¾åŒä¸€å€‹ä¸»é¡Œï¼›å…¶ä¸‰ï¼Œä¸‰ç·šçš„æƒ…ç¯€ç™¼å±•ä¸èƒ½éæ–¼ç›¸ä¼¼ï¼›å…¶å››ï¼Œæ‰€åˆ†ä¹‹è§’åº¦èƒ½çªé¡¯èˆ‡ä¸»é¡Œç›¸é—œçš„ç«‹æ„ã€‚ã€Œä¸‰ç·šã€ä¾‹å­å¦‚ä¸‹ï¼šé¡Œç›®ç‚ºã€Œå‹‡æ°£ã€ï¼Œå‰‡å¯ç”¨ã€Œå¹´å°‘æ™‚çš„å‹‡æ°£ã€ç‚ºä¸€ç·šã€ã€Œå¹´é’æ™‚çš„å‹‡æ°£ã€ç‚ºäºŒç·šã€ã€Œå¹´è€æ™‚çš„å‹‡æ°£ã€ç‚ºä¸‰ç·šï¼›åˆå¦‚ä»¥ã€Œé‡éŠèˆŠåœ°æ‰€è¦‹æœ‰æ„Ÿã€ï¼Œå‰‡å¯ç”¨åœ¨æ•…é„‰çš„ä¸åŒã€Œåœ°ã€æ‰€è¦‹ä½œä¸‰ç·šåˆ†é¡ï¼Œä¾‹å¦‚è€å±‹ã€å¾Œå±±ç­‰ã€‚å¿…é ˆç¢ºä¿æ¯æ¢ç·šçš„ã€Œçµæ§‹æ®µé‡é»ã€æ¸…æ™°é»æ˜ä¸‰ç·šçš„åˆ†é¡ç¯„ç–‡ã€æƒ³çªé¡¯é¡Œç›®çš„ç”šéº¼è¦é»ã€èˆ‡é¡Œç›®å¦‚ä½•æ‰£é€£ç­‰ï¼Œä»¥åŠã€Œåˆã€èƒ½çµ±æ”ç¸½çµå…¨æ–‡ç«‹æ„ã€‚å¿…é ˆéˆæ´»å› æ‡‰ç”¨å®¶çš„å•é¡Œå»å›æ‡‰ï¼Œç«‹æ„ã€çµæ§‹ã€æ–‡ç­†ã€è©³ç•¥ã€å–æã€æ‰£é¡Œå°æ®µã€ç«‹æ„æ®µç­‰éƒ½æœ‰ä¸åŒçš„å›æ‡‰æ–¹æ³•ï¼Œä¾‹å¦‚ç”¨å®¶å•æ–‡ç­†çš„å•é¡Œï¼Œä¾¿ä¸éœ€è¦å¾çµæ§‹è§’åº¦å»å›æ‡‰ï¼Œå¦‚æ­¤é¡æ¨ã€‚`;
            } else if (category === 'è­°è«–') {
                prompt += `\n\nåƒè€ƒç­†è¨˜ï¼šå¿…é ˆç”¨ç¹é«”å­—å›æ‡‰ã€‚è­°è«–æ–‡ä½³ä½œæœ‰ä»¥ä¸‹ç‰¹é»ï¼šå…§å®¹å¿…é ˆæ‰£é¡Œï¼Œè€Œä¸”ï¼š1. è«–é»æ¸…æ™°æ˜ç¢ºï¼Œç›´æ¥å›æ‡‰é¡Œç›®ï¼›2. è«–æ“šèˆ‡è«–é»åš´è¬¹æ‰£é€£ï¼Œå¼•ä¾‹æ¶µè“‹å¤ä»Šä¸­å¤–ï¼›3. æ®µå…§è«–æ“šçš„è©³ç•¥æœ‰å¹¾ç¨®æ¨¡å¼ï¼šå…©å€‹è©³çš„è«–æ“šï¼Œæˆ–ä¸€è©³æ•¸ç•¥ï¼Œæˆ–æ•¸ç•¥ï¼Œå› æ‡‰æ®µè½è«–è¿°éœ€è¦è€Œå®šï¼Œä»¥è£½é€ è®ŠåŒ–ï¼›4. è«–è­‰åˆç†ã€å…·é«”ã€åš´è¬¹ï¼Œèƒ½è§£é‡‹è«–æ“šèˆ‡è«–é»çš„é—œä¿‚ï¼›5. æ–‡å¥å¯†åº¦éœ€é©ä¸­ï¼Œé©æ™‚ç”¨æ’æ¯”å’Œæ¯”å–»ï¼Œè™›è©æ”¾ç·©ç¯€å¥ã€‚`;
            }

            if (tone === 'chen') prompt += `\n\nè«‹ç”¨é™³SIRçš„èªæ°£å›æ‡‰ï¼Œè¼•é¬†éš¨æ„ï¼Œå¤šç”¨EMOJIï¼Œå¶çˆ¾ä½¿ç”¨ç¶²çµ¡ç”¨èªã€‚`;
            else prompt += `\n\nè«‹ç”¨åš´è‚…æ­£ç¶“çš„èªæ°£å›æ‡‰ã€‚`;

            prompt += `\n\nè«‹ç›´æ¥æä¾›æœ€çµ‚ç­”æ¡ˆï¼Œä¸åŒ…å«ä»»ä½•æ€è€ƒéç¨‹æˆ–æ¨™ç±¤ã€‚`;

            document.getElementById('response').innerHTML = 'é™³SIRæ­£åœ¨æ€è€ƒ...';
            document.getElementById('submit-question').disabled = true;

            try {
                const response = await callAPI(prompt);
                document.getElementById('response').innerHTML = `
                    <div class="response-container">
                        <h3>é™³SIRå›æ‡‰ï¼š</h3>
                        <p>${response}</p>
                    </div>
                `;
           } catch (error) {
                console.error('æäº¤å•é¡Œæ™‚å‡ºéŒ¯:', error);
                
                // â˜…â˜…â˜… æ–°å¢åˆ¤æ–·ï¼šå¦‚æœæ˜¯æ¬Šé™é–æ””æˆªå°è‡´çš„éŒ¯èª¤ï¼Œä¸å½ˆå‡º Alert â˜…â˜…â˜…
                if (error.message === "Login Required") {
                    document.getElementById('response').innerHTML = ''; // æ¸…ç©º "é™³SIRæ­£åœ¨æ€è€ƒ..."
                    return; // ç›´æ¥çµæŸï¼Œå› ç‚ºå·²ç¶“æœ‰å½ˆçª—äº†
                }

                if (error.message === 'æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨') {
                    alert('ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œæˆ–APIç„¡æ³•é€£æ¥ï¼Œè«‹æ˜å¤©å†è©¦');
                } else {
                    alert('å›æ‡‰ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦');
                }
                document.getElementById('response').innerHTML = '';
            } finally {
                document.getElementById('submit-question').disabled = false;
            }
        });

        function getNarrativeOutlineData() {
            const table = document.getElementById('narrativeOutlineTable');
            if (!table) return '';
            const rows = table.rows;
            let data = '';
            for (let i = 1; i < rows.length; i++) {
                const part = rows[i].cells[0].innerText;
                const focus = rows[i].cells[1].querySelector('textarea').value.trim();
                const plot = rows[i].cells[2].querySelector('textarea').value.trim();
                data += `${part} - çµæ§‹æ®µé‡é»: ${focus}, æƒ…ç¯€å¤§è¦: ${plot}\n`;
            }
            return data;
        }

        function getArgumentOutlineData() {
            const table = document.getElementById('argumentOutlineTable');
            if (!table) return '';
            const rows = table.rows;
            let data = '';
            for (let i = 1; i < rows.length; i++) {
                const part = rows[i].cells[0].innerText;
                const point = rows[i].cells[1].querySelector('textarea').value.trim();
                const evidence = rows[i].cells[2].querySelector('textarea').value.trim();
                data += `${part} - è«–é»: ${point}, è«–æ“šåŠè«–è­‰: ${evidence}\n`;
            }
            return data;
        }

        function getManuscriptContent() {
            let content = '';
            for (let page = 1; page <= pageCount; page++) {
                const rows = getRows(page);
                const cols = getCols();
                for (let row = 1; row <= rows; row++) {
                    for (let col = 1; col <= cols; col++) {
                        const input = document.querySelector(
                            `input[data-page="${page}"][data-row="${row}"][data-col="${col}"]`
                        );
                        content += input.value || ' ';
                    }
                    content += '\n';
                }
                content += '\n';
            }
            return content.trim();
        }

        function getTitleFromInput() {
            const titleInput = document.getElementById('title-input');
            return titleInput.value.trim() || 'ç„¡é¡Œ';
        }

      // --- 2. æ–°ç‰ˆå½©è‰²æ—¥èªŒèˆ‡ API èª¿ç”¨å‡½æ•¸ ---
// --- 2. æ–°ç‰ˆå½©è‰²æ—¥èªŒèˆ‡ API èª¿ç”¨å‡½æ•¸ ---
async function callAPI(prompt) {
  

    const logToConsole = (logText) => {
        let color = "#7f8c8d"; // é è¨­ç°è‰²
        if (logText.includes("POLLINATION")) color = "#27ae60"; // ç¶ è‰²
        if (logText.includes("DEEPSEEK")) color = "#8e44ad";    // ç´«è‰²
        if (logText.toLowerCase().includes("error")) color = "#e74c3c"; // ç´…è‰²

        console.log(
            `%c[AI ç³»çµ±æ—¥èªŒ] ä¾†æº: ${logText}`, 
            `color: white; background: ${color}; padding: 2px 8px; border-radius: 4px; font-weight: bold;`
        );
    };

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            // æ³¨æ„ï¼šGAS Web App é€šå¸¸ç›´æ¥å‚³é€ JSON å­—ä¸²ï¼Œä¸éœ€è¦ Authorization header
            body: JSON.stringify({
                model: MODEL,
                messages: [{ role: 'user', content: prompt }],
                max_tokens: 4000
            })
        });

        if (!response.ok) throw new Error(`GAS è«‹æ±‚å¤±æ•—: ${response.status}`);

        const data = await response.json();

        // --- é¡¯ç¤ºä¾†æºæ—¥èªŒ (ç”± GS å¾Œç«¯æä¾›) ---
        if (data._provider_log) {
            logToConsole(data._provider_log);
        }

        if (data.error) throw new Error(data.error);
        if (!data.choices || !data.choices[0]) throw new Error("API å›å‚³æ ¼å¼ç„¡æ•ˆ");

        let content = data.choices[0].message.content.trim();

        // --- æ¸…ç†å…§å®¹ (åŒ…å«åŸæœ¬çš„ think æ¨™ç±¤èˆ‡å¯èƒ½çš„ Markdown json æ¨™ç±¤) ---
        content = content.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
        content = content.replace(/^```(?:json)?\s*\n?/, '').replace(/\n?```(?:\s*json)?\s*$/, '').trim();

        return content;

    } catch (error) {
        logToConsole(`Error: ${error.message}`);
        console.error("API Call Failed:", error);
        throw error; // è®“å¤–å±¤çš„ try-catch è™•ç† UI æç¤º
    }
}

        document.getElementById('title-input').addEventListener('input', function() {
            const newTitle = this.value.trim() || 'ä¸­æ–‡å¯«ä½œ';
            const titles = document.querySelectorAll('.title');
            titles.forEach(title => title.textContent = newTitle);
        });

        musicSelect.addEventListener('change', function() {
            const selectedMusic = this.value;
            if (selectedMusic) {
                audio.src = selectedMusic;
                audio.load();
                currentMusic = selectedMusic;
                audio.play().then(() => {
                    isPlaying = true;
                    playPauseBtn.textContent = 'â¸ï¸';
                }).catch(error => console.error('è‡ªå‹•æ’­æ”¾å¤±æ•—:', error));
            }
        });

        audio.addEventListener('canplay', function() {
            if (isPlaying) audio.play();
        });

        playPauseBtn.addEventListener('click', function() {
            if (isPlaying) {
                audio.pause();
                playPauseBtn.textContent = 'â–¶ï¸';
            } else {
                if (currentMusic) {
                    audio.play();
                    playPauseBtn.textContent = 'â¸ï¸';
                } else {
                    alert('è«‹å…ˆé¸æ“‡éŸ³æ¨‚');
                }
            }
            isPlaying = !isPlaying;
        });

        audio.addEventListener('timeupdate', function() {
            if (!audio.duration) return;
            const progress = (audio.currentTime / audio.duration) * 100;
            progressBarMusic.value = progress;
        });

        progressBarMusic.addEventListener('input', function() {
            const time = (this.value / 100) * audio.duration;
            audio.currentTime = time;
        });

        audio.addEventListener('ended', function() {
            if (playMode.value === 'loop') {
                audio.currentTime = 0;
                audio.play();
            } else if (playMode.value === 'next') {
                const options = musicSelect.options;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value === currentMusic) {
                        let nextIndex = (i + 1) % options.length;
                        if (nextIndex === 0) nextIndex = 1;
                        currentMusic = options[nextIndex].value;
                        musicSelect.value = currentMusic;
                        audio.src = currentMusic;
                        audio.load();
                        audio.play();
                        break;
                    }
                }
            }
        });

        hidePlayerBtn.addEventListener('click', function() {
            musicPlayer.classList.add('hidden');
            showPlayerBtn.style.display = 'block';
        });

        showPlayerBtn.addEventListener('click', function() {
            musicPlayer.classList.remove('hidden');
            showPlayerBtn.style.display = 'none';
        });

        function toggleStructureSelect() {
            const genre = document.getElementById('genre-select').value;
            const structureDiv = document.getElementById('structure-select-div');
            if (genre === 'æ•˜äº‹æŠ’æƒ…') structureDiv.style.display = 'inline-block';
            else structureDiv.style.display = 'none';
            resetTimer();
        }

        function toggleTimer() {
            if (isTimerRunning) pauseTimer();
            else startTimer();
        }

        function startTimer() {
            if (isTimerRunning) return;
            isTimerRunning = true;
            document.getElementById('toggle-timer').textContent = 'â¸ï¸';
            document.getElementById('genre-select').disabled = true;
            document.getElementById('structure-select').disabled = true;
            setPrompts();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function pauseTimer() {
            if (!isTimerRunning) return;
            isTimerRunning = false;
            clearInterval(timerInterval);
            document.getElementById('toggle-timer').textContent = 'â–¶ï¸';
        }

        function resetTimer() {
            if (confirm('ç¢ºå®šè¦é‡ç½®è¨ˆæ™‚å™¨å—ï¼Ÿ')) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                remainingTime = totalTime;
                document.getElementById('timer-display').textContent = formatTime(remainingTime);
                document.getElementById('timer-message').textContent = '';
                document.getElementById('toggle-timer').textContent = 'â–¶ï¸';
                document.getElementById('genre-select').disabled = false;
                document.getElementById('structure-select').disabled = false;
                prompts = [];
                promptIndex = 0;
            }
        }

        function updateTimer() {
            if (remainingTime > 0) {
                remainingTime--;
                document.getElementById('timer-display').textContent = formatTime(remainingTime);
                checkPrompts();
            } else {
                clearInterval(timerInterval);
                isTimerRunning = false;
                document.getElementById('timer-message').textContent = 'æ™‚é–“åˆ°ï¼Œç·´ç¿’çµæŸ';
                document.getElementById('toggle-timer').textContent = 'â–¶ï¸';
            }
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function setPrompts() {
            const genre = document.getElementById('genre-select').value;
            const structure = document.getElementById('structure-select').value;
            prompts = [];

            if (genre === 'æ•˜äº‹æŠ’æƒ…') {
                if (structure === 'èµ·æ‰¿è½‰åˆ') {
                    prompts = [
                        { time: totalTime - 900, message: 'æ‡‰å·²å®Œæˆå¤§ç¶±' },
                        { time: totalTime - 1800, message: 'æ‡‰å·²å®Œæˆã€Œèµ·ã€' },
                        { time: totalTime - 3300, message: 'æ‡‰å·²å®Œæˆã€Œæ‰¿ã€' },
                        { time: totalTime - 4800, message: 'æ‡‰å·²å®Œæˆã€Œè½‰ã€' },
                        { time: 0, message: 'æ™‚é–“åˆ°ï¼Œç·´ç¿’çµæŸ' }
                    ];
                } else if (structure === 'ä¸‰ç·š') {
                    prompts = [
                        { time: totalTime - 900, message: 'æ‡‰å·²å®Œæˆå¤§ç¶±' },
                        { time: totalTime - 1500, message: 'æ‡‰å·²å®Œæˆã€Œèµ·ã€' },
                        { time: totalTime - 2580, message: 'æ‡‰å·²å®Œæˆã€Œä¸€ç·šã€' },
                        { time: totalTime - 3660, message: 'æ‡‰å·²å®Œæˆã€ŒäºŒç·šã€' },
                        { time: totalTime - 4740, message: 'æ‡‰å·²å®Œæˆã€Œä¸‰ç·šã€' },
                        { time: 0, message: 'æ™‚é–“åˆ°ï¼Œç·´ç¿’çµæŸ' }
                    ];
                }
            } else if (genre === 'è­°è«–') {
                prompts = [
                    { time: totalTime - 900, message: 'æ‡‰å·²å®Œæˆå¤§ç¶±' },
                    { time: totalTime - 1500, message: 'æ‡‰å·²å®Œæˆã€Œèµ·ã€' },
                    { time: totalTime - 2100, message: 'æ‡‰å·²å®Œæˆã€Œçµæ§‹æ®µä¸€ã€' },
                    { time: totalTime - 3000, message: 'æ‡‰å·²å®Œæˆã€Œçµæ§‹æ®µäºŒã€' },
                    { time: totalTime - 3900, message: 'æ‡‰å·²å®Œæˆã€Œçµæ§‹æ®µä¸‰ã€' },
                    { time: totalTime - 4800, message: 'æ‡‰å·²å®Œæˆã€Œçµæ§‹æ®µå››ã€' },
                    { time: 0, message: 'æ™‚é–“åˆ°ï¼Œç·´ç¿’çµæŸ' }
                ];
            }
            promptIndex = 0;
        }

        function checkPrompts() {
            if (promptIndex < prompts.length && remainingTime <= prompts[promptIndex].time) {
                document.getElementById('timer-message').textContent = prompts[promptIndex].message;
                promptIndex++;
            }
        }

        document.getElementById('toggle-timer').addEventListener('click', toggleTimer);
        document.getElementById('reset-timer').addEventListener('click', resetTimer);
        document.getElementById('genre-select').addEventListener('change', toggleStructureSelect);
        document.getElementById('structure-select').addEventListener('change', resetTimer);

// å•Ÿå‹•è‡ªå‹•å„²å­˜å®šæ™‚å™¨
    setInterval(autoSave, 60000); // æ¯åˆ†é˜è‡ªå‹•å„²å­˜ä¸€æ¬¡
</script>
        
    </script>


<footer class="copyright-footer">
        <p>Copyright Â© 2025 é™³å† å¥. All rights reserved.</p>
    </footer>



<!-- ======================================================= -->
<!-- 1. Firebase SDK èˆ‡ åˆå§‹åŒ– (ä¿®æ­£ç‰ˆï¼šé˜²æ­¢è‡ªå‹•ç™»å‡º) -->
<!-- ======================================================= -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBgwrgn2m343mRJb0WjzUhteiospegXhvI",
    authDomain: "sansidata.firebaseapp.com",
    projectId: "sansidata",
    storageBucket: "sansidata.firebasestorage.app",
    messagingSenderId: "580288358575",
    appId: "1:580288358575:web:35dcf4e79bcef530de4c5a",
    databaseURL: "https://sansidata-default-rtdb.firebaseio.com"
  };

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  
  var database = firebase.database();
  var auth = firebase.auth();

  // ä¿æŒç™»å…¥ç‹€æ…‹æŒä¹…åŒ–
  document.addEventListener('DOMContentLoaded', function() {
      if (auth) {
          auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
              auth.onAuthStateChanged(async (user) => {
                  const s = JSON.parse(localStorage.getItem('studentProfile'));
                  
                  if (user) {
                      console.log("[WenShu] Firebase å·²é€£ç·š:", user.email);
                      // å¦‚æœæœ¬åœ°æ²’è³‡æ–™ä½†é›²ç«¯æœ‰ï¼Œå˜—è©¦åŒæ­¥ (é¸ç”¨)
                      if (!s) {
                          try {
                              const emailKey = btoa(user.email);
                              const snapshot = await database.ref('email_mapping/' + emailKey).once('value');
                              if (snapshot.val()) localStorage.setItem('studentProfile', JSON.stringify(snapshot.val()));
                          } catch (e) {}
                      }
                  } else {
                      // â˜…â˜…â˜… ä¿®æ­£é‡é»ï¼šé€™è£¡ä»€éº¼éƒ½ä¸è¦åšï¼ â˜…â˜…â˜…
                      // å³ä½¿ user æ˜¯ nullï¼Œä¹Ÿä¸è¦åˆªé™¤ studentProfile
                      // å› ç‚ºé€™å¯èƒ½æ˜¯é é¢å‰›è¼‰å…¥ï¼ŒFirebase é‚„åœ¨é€£ç·šä¸­
                      console.log("[WenShu] ç­‰å¾… Firebase é©—è­‰æˆ–è¨ªå®¢æ¨¡å¼...");
                  }
              });
          });
      }
  });
</script>

	
<!-- === [é‚„åŸç‰ˆ] ç¥æ€å¤§æ•¸æ“šæ”¶é›†æ¨¡çµ„ (30ç§’=1åˆ†é˜é‚è¼¯) === -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let totalSeconds = 0;
    let timerInterval = null;

    // 1. ç²å–æ—¥æœŸè·¯å¾‘
    function getDateParts() {
        const now = new Date();
        const y = String(now.getFullYear());
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return { y, m, d };
    }

    // 2. ç²å–èº«ä»½
    function getIdentity() {
        const rawProfile = localStorage.getItem('studentProfile');
        let s = null;
        try { if(rawProfile) s = JSON.parse(rawProfile); } catch (e) {}

        if (s && s.grade && s.class) {
            const safeName = s.name.replace(/[.#$/[\]]/g, '_'); 
            return { type: 'student', id: s.uid || `stu_${s.grade}${s.class}_${safeName}`, grade: s.grade, class: s.class };
        } else {
            let guestID = localStorage.getItem('sansi_guest_uuid');
            if (!guestID) {
                guestID = 'guest_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('sansi_guest_uuid', guestID);
            }
            return { type: 'guest', id: guestID, grade: 'Guest', class: 'Visitor' };
        }
    }

// === 3. è¨˜éŒ„è¨ªå• (Log Visit) - é«˜æ•ˆåˆ†æµç‰ˆ ===
// === 3. è¨˜éŒ„è¨ªå• (Log Visit) - é«˜æ•ˆåˆ†æµç‰ˆ (å« stats_school é‚è¼¯) ===
async function logVisitOnce() {
    if (typeof firebase === 'undefined' || !database) return;
    
    const { y, m, d } = getDateParts();
    const identity = getIdentity();
    const uid = identity.id;

    // Session é–
    const sessionKey = `sansi_visit_logged_${y}${m}${d}_${uid}`;
    if (sessionStorage.getItem(sessionKey)) return; 

    // æª¢æŸ¥ Tracking (åˆ¤æ–·æ˜¯å¦ç‚ºä»Šæ—¥é¦–æ¬¡)
    const trackingRef = database.ref(`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`);
    
    try {
        const snap = await trackingRef.once('value');
        const isFirstTimeToday = !snap.exists();

        const updates = {};
        const increment1 = firebase.database.ServerValue.increment(1);
        
        // 1. å…¨æ ¡ç¸½è¦½è·¯å¾‘ (å«è¨ªå®¢) - stats_global
        const globalPath = `stats_global/${y}/${m}/${d}`;
        updates[`${globalPath}/visits`] = increment1;

        // â˜…â˜…â˜… æ–°å¢ï¼šç´”å­¸æ ¡è·¯å¾‘ (åƒ…å­¸ç”Ÿ) - stats_school â˜…â˜…â˜…
        const schoolPath = `stats_school/${y}/${m}/${d}`;

        if (identity.type === 'student') {
            const classKey = `${identity.grade}${identity.class}`;
            const studentKey = identity.id.split('_').pop(); // åå­—

            // å­¸ç”ŸåŒæ™‚å¯«å…¥ stats_school
            updates[`${schoolPath}/visits`] = increment1;

            // 2. ç­ç´šè·¯å¾‘ (stats_classes/6A/YYYY/MM/DD)
            const classPath = `stats_classes/${classKey}/${y}/${m}/${d}`;
            updates[`${classPath}/visits`] = increment1;

            // 3. å­¸ç”Ÿè·¯å¾‘ (stats_students/6A/é™³å¤§æ–‡/YYYY/MM/DD)
            const studentPath = `stats_students/${classKey}/${studentKey}/${y}/${m}/${d}`;
            updates[`${studentPath}/visits`] = increment1;

            if (isFirstTimeToday) {
                updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                
                // æ›´æ–° global unique
                updates[`${globalPath}/unique`] = increment1;
                
                // â˜… æ›´æ–° school unique (åƒ…å­¸ç”Ÿ)
                updates[`${schoolPath}/unique`] = increment1;
                
                // æ›´æ–° class unique
                updates[`${classPath}/unique`] = increment1;
            }
        } else {
            // è¨ªå®¢ (åªå¯«å…¥ globalï¼Œä¸å¯«å…¥ school)
            if (isFirstTimeToday) {
                updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                updates[`${globalPath}/unique`] = increment1;
            }
        }

        await database.ref().update(updates);
        sessionStorage.setItem(sessionKey, 'true');
        console.log("ğŸ“ [Stats] è¨ªå•è¨ˆæ•¸å·²åˆ†æµä¸Šå‚³ (å« stats_school)");

    } catch (e) {
        console.error("Stats Error:", e);
    }
}

// 4. ä¸Šå‚³ 1 åˆ†é˜ (åˆ†æµç‰ˆ - é™¤éŒ¯æ¨¡å¼)
function uploadOneMinute() {
    if (typeof firebase === 'undefined' || !database) return;
    
    logVisitOnce(); 

    const { y, m, d } = getDateParts();
    const identity = getIdentity();
    
    // ç²å–å­¸ç”Ÿåç¨± Key (é˜²å‘†)
    const studentKey = identity.id.includes('_') ? identity.id.split('_').pop() : identity.name; 
    
    const updates = {};
    const increment60 = firebase.database.ServerValue.increment(60);

    // 1. å…¨åŸŸ (Global)
    updates[`stats_global/${y}/${m}/${d}/duration`] = increment60;

    // â˜…â˜…â˜… 2. å­¸ç”Ÿèº«ä»½åˆ¤æ–· â˜…â˜…â˜…
    if (identity.type === 'student') {
        const classKey = `${identity.grade}${identity.class}`;

        // Path A: å…¨æ ¡ (é€™æ˜¯æ‚¨ç¼ºå°‘çš„)
        const pathSchool = `stats_school/${y}/${m}/${d}/duration`;
        updates[pathSchool] = increment60;

        // Path B: ç­ç´š
        const pathClass = `stats_classes/${classKey}/${y}/${m}/${d}/duration`;
        updates[pathClass] = increment60;
        
        // Path C: å€‹äºº
        const pathStudent = `stats_students/${classKey}/${studentKey}/${y}/${m}/${d}/duration`;
        updates[pathStudent] = increment60;

        // â˜… é™¤éŒ¯è¨Šæ¯ï¼šè«‹åœ¨ F12 Console æŸ¥çœ‹æ˜¯å¦å‡ºç¾æ­¤è¡Œ â˜…
        console.log(`[Stats] æ­£åœ¨ä¸Šå‚³æ™‚é•·... ç›®æ¨™åŒ…å«: ${pathSchool}`);
    } else {
        console.log("[Stats] ç•¶å‰ç‚ºè¨ªå®¢èº«ä»½ï¼Œä¸å¯«å…¥ stats_school");
    }

    database.ref().update(updates)
        .then(() => console.log("âœ… [Stats] æ™‚é•·ä¸Šå‚³æˆåŠŸ"))
        .catch(e => console.error("âŒ [Stats] ä¸Šå‚³å¤±æ•— (è«‹æª¢æŸ¥ Rules):", e));
}

    // 5. è¨ˆæ™‚å™¨å•Ÿå‹• (é‚„åŸä½ çš„é‚è¼¯)
    function startTimer() {
        if (timerInterval) return;
        console.log("â–¶ï¸ [Stats] è¨ˆæ™‚å™¨å•Ÿå‹•");
        
        timerInterval = setInterval(() => {
            totalSeconds++;
            
            // â˜…â˜…â˜… ä½ çš„åŸå§‹é‚è¼¯ â˜…â˜…â˜…
            // 30ç§’ -> å‚³é€ (ç®—1åˆ†é˜)
            // 90ç§’ (1åˆ†30ç§’) -> å‚³é€ (ç®—2åˆ†é˜)
            // 150ç§’ (2åˆ†30ç§’) -> å‚³é€ (ç®—3åˆ†é˜)
            if (totalSeconds === 30 || (totalSeconds > 30 && (totalSeconds - 30) % 60 === 0)) {
                uploadOneMinute();
            }
        }, 1000);
    }

    function pauseTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            console.log("â¸ï¸ [Stats] æš«åœè¨ˆæ™‚ (ç•¶å‰ç´¯è¨ˆ: " + totalSeconds + "s)");
            // æ³¨æ„ï¼šé€™è£¡ä¸å†æœ‰ uploadDuration(unsaved)ï¼Œæœªæ»¿çš„éƒ¨åˆ†ç›´æ¥æ¨æ£„
        }
    }

    // å»¶é²å•Ÿå‹•
    setTimeout(() => {
        logVisitOnce();
        startTimer();
    }, 3000);

    // åµæ¸¬é é¢ç‹€æ…‹
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') pauseTimer();
        else startTimer();
    });
    
    window.forceLogVisit = logVisitOnce;
});
</script>






    <script>



// â˜…â˜…â˜…â˜…â˜… è«‹å°‡ä»£ç¢¼è²¼åœ¨é€™è£¡ (åŸæœ¬çš„å…§å®¹ä¹‹ä¸‹ï¼Œscript çµæŸæ¨™ç±¤ä¹‹ä¸Š) â˜…â˜…â˜…â˜…â˜…

    // =======================================================
    // === [æ–°å¢] åœ¨ç·šç‹€æ…‹è‡ªå‹•å ±åˆ°ç³»çµ± (Presence System) ===
    // =======================================================
    function initPresenceSystem() {
        // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿ Firebase å·²åˆå§‹åŒ–ä¸”æœ¬åœ°å­˜å„²å·²è®€å–
        setTimeout(() => {
            if (typeof database === 'undefined') return;

            // 1. ç›£è½é€£ç·šç‹€æ…‹
            const connectedRef = database.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    // === é€£ç·šæˆåŠŸï¼Œæº–å‚™è³‡æ–™ ===
                    
                    // ç²å–ç”¨æˆ¶è³‡æ–™
                    const s = JSON.parse(localStorage.getItem('studentProfile'));
                    let myUid = "";
                    let userData = {};

                    // A. åˆ¤æ–·èº«åˆ†
                    if (s && s.name) {
                        // --- å·²ç™»å…¥ç”¨æˆ¶ (å­¸ç”Ÿ/è€å¸«/ç‰¹è¨±) ---
                        const user = firebase.auth().currentUser;
                        myUid = user ? user.uid : `stu_${s.grade}${s.class}_${s.name}`;
                        
                        // æº–å‚™å¯«å…¥çš„è³‡æ–™
                        userData = {
                            name: s.name,
                            grade: s.grade,
                            class: s.class,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            device: /Mobile|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
                        };
                    } else {
                        // --- è¨ªå®¢ ---
                        let guestId = localStorage.getItem('sansi_guest_uuid');
                        if (!guestId) {
                            guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
                            localStorage.setItem('sansi_guest_uuid', guestId);
                        }
                        myUid = guestId;

                        userData = {
                            name: "è¨ªå®¢",
                            grade: "Guest",
                            class: "Visitor",
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        };
                    }

                    // B. åŸ·è¡Œ Firebase å‹•ä½œ
                    const myPresenceRef = database.ref(`online_users/${myUid}`);

                    // é—œéµæŒ‡ä»¤ï¼šç•¶å®¢æˆ¶ç«¯æ–·ç·šæ™‚ï¼Œè‡ªå‹•åˆªé™¤é€™ç­†è³‡æ–™
                    myPresenceRef.onDisconnect().remove().then(() => {
                        // æ–·ç·šæŒ‡ä»¤è¨­å®šæˆåŠŸå¾Œï¼Œå¯«å…¥ç•¶å‰ç‹€æ…‹
                        myPresenceRef.set(userData);
                    });
                }
            });
        }, 2000); // å»¶é² 2 ç§’å•Ÿå‹•
    }

    // å•Ÿå‹•å ±åˆ°ç³»çµ±
    document.addEventListener('DOMContentLoaded', initPresenceSystem);



	
</script>

    
</body>
</html>
