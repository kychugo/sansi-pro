


<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âè≤ËêäÂßÜÊïôÂÆ§</title>

    <!-- Ê∑ªÂä†Âà∞‰∏ªÁï´Èù¢Ë®≠ÂÆö -->
    <meta name="application-name" content="Âè≤ËêäÂßÜÊïôÂÆ§">
    <meta name="apple-mobile-web-app-title" content="Âè≤ËêäÂßÜÊïôÂÆ§">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.ibb.co/WL5vTL9/image.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <!-- Android ÂúñÁ§∫ -->
    <link rel="icon" sizes="192x192" href="https://i.ibb.co/WL5vTL9/image.png">
    <link rel="icon" sizes="144x144" href="https://i.ibb.co/WL5vTL9/image.png">
    <link rel="icon" sizes="96x96" href="https://i.ibb.co/WL5vTL9/image.png">
    <!-- iOS ÂúñÁ§∫ -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/WL5vTL9/image.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.ibb.co/WL5vTL9/image.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://i.ibb.co/WL5vTL9/image.png">


<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
        
    <style>
        :root {
            --primary: #4a90e2;
            --primary-dark: #357abd;
            --secondary: #50c878;
            --user-bg: #e6f0fa;
            --user-border: #4a90e2;
            --ai-bg: #f0f4f8;
            --ai-border: #d1e0e8;
            --error-bg: #ffe6e6;
            --error-border: #e57373;
            --recording-bg: #e74c3c;
            --text-dark: #2d3748;
            --text-light: #718096;
            --shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            --radius: 20px;
            --radius-sm: 12px;
            --gold: #FFD700;
            --silver: #C0C0C0;
            --active-orange: #FF8C00;
            --hunger-red: #FF4444;
            --hunger-yellow: #FFB84D;
            --hunger-green: #4CAF50;
            --personality-purple: #9C27B0;
            --personality-blue: #2196F3;
            --personality-green: #4CAF50;
            --personality-orange: #FF9800;
            --personality-red: #F44336;
            --personality-pink: #E91E63;
            --mysterybox-bronze: #CD7F32;
            --mysterybox-silver: #C0C0C0;
            --mysterybox-gold: #FFD700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
            background-image: url('https://i.ibb.co/PvJfB2CW/image.png');
            background-size: cover;
            background-position: center;
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 25px;
            padding-top: 100px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .copyright-footer {
            position: fixed;
            bottom: 0;
            right: 0;
            padding: 5px 10px;
            background-color: #f1f1f1;
            z-index: 1;
        }

        .copyright-footer p {
            margin: 0;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .copyright-footer p {
                font-size: 12px;
            }
        }
        
        /* È†ÇÈÉ®ÊéßÂà∂ÂçÄÂüü */
        .top-controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(169, 204, 227  , 0.85);
            backdrop-filter: blur(10px);
            z-index: 102;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .left-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .shop-button, .settings-button {
            background: linear-gradient(135deg, var(--gold), var(--silver));
            color: white;
            padding: 12px 18px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            border: none;
        }

        .settings-button {
            background: #abb2b9 ;
            padding: 12px 15px;
            width: 40px;
        }

        /* ÁßªÂãïÁ´ØÈÅ©ÈÖç */
    @media (max-width: 768px) {
        /* Ë®≠ÁΩÆÊåâÈàï‰ΩøÁî®Ëá™ÂãïÂØ¨Â∫¶ */
        .settings-button {
            flex: 0 0 auto !important; /* Á¶ÅÊ≠¢‰º∏Á∏Æ */
            padding: 8px 10px !important; /* ÈÄ≤‰∏ÄÊ≠•Ê∏õÂ∞ëÂÖßÈÇäË∑ù */
            min-width: unset !important; /* ÁßªÈô§ÊúÄÂ∞èÂØ¨Â∫¶ÈôêÂà∂ */
        }
        

@media (max-width: 768px) {
    .received-gift-item {
        min-width: 0; /* ÁßªÈô§Âõ∫ÂÆöÊúÄÂ∞èÂØ¨Â∫¶ÔºåËÆìÂÖ∂ÈÅ©ÊáâÂÆπÂô® */
        width: 100%; /* Á¢∫‰øù‰ΩîÊªøÂèØÁî®ÂØ¨Â∫¶ */
        flex-direction: row; /* ÊîπÂõûÊ∞¥Âπ≥‰ΩàÂ±ÄÔºåÈÅøÂÖçÈÅéÂ∫¶Â†ÜÁñä */
        flex-wrap: wrap; /* ÂÖÅË®±ÊèõË°å */
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px; /* Ê∏õÂ∞èÂÖßÈÇäË∑ù‰ª•ÈÅ©ÊáâÂ∞èÂ±èÂπï */
        box-sizing: border-box; /* Á¢∫‰øùÈÇäÊ°ÜÂíåÂÖßÈÇäË∑ù‰∏çË∂ÖÂá∫ */
    }
}

.received-gift-item > div:first-child {
    min-width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.received-gift-item .item-preview {
    margin-right: 0;
    margin-bottom: 10px;
}



       
    }

        .shop-button:hover, .settings-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .shop-button .points {
            background: rgba(255, 255, 255, 0.3);
            padding: 3px 10px;
            border-radius: 15px;
        }

        .hunger-bar-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
        }

        .hunger-icon {
            font-size: 1.2rem;
            color: var(--hunger-green);
        }

        .hunger-icon.hungry {
            color: var(--hunger-yellow);
        }

        .hunger-icon.very-hungry {
            color: var(--hunger-red);
        }

        .hunger-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .hunger-fill {
            height: 100%;
            background: var(--hunger-green);
            transition: all 0.3s ease;
            border-radius: 4px;
        }

        .hunger-fill.hungry {
            background: var(--hunger-yellow);
        }

        .hunger-fill.very-hungry {
            background: var(--hunger-red);
        }

        .hunger-percentage {
            font-size: 0.9rem;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }

        #chat-container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 160px);
            position: relative;
            z-index: 10;
        }

        #chat-header {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #chat-header i {
            font-size: 1.8rem;
        }

        #chat-header h2 {
            font-weight: 700;
            font-size: 1.6rem;
            flex-grow: 1;
        }

        #mode-select {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            background: white;
            color: var(--text-dark);
            border: none;
            cursor: pointer;
        }

        #chat-output {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: #f7fafc;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .message {
            max-width: 80%;
            padding: 18px 24px;
            border-radius: var(--radius-sm);
            position: relative;
            box-shadow: var(--shadow);
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .user-message {
            background: var(--user-bg);
            border-left: 5px solid var(--user-border);
            align-self: flex-end;
        }

        .ai-message {
            background: var(--ai-bg);
            border-left: 5px solid var(--ai-border);
            align-self: flex-start;
        }

        .error-message {
            background: var(--error-bg);
            border-left: 5px solid var(--error-border);
            align-self: center;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .user-message .message-header {
            color: var(--primary-dark);
        }

        .ai-message .message-header {
            color: var(--secondary);
        }

        .message-content {
            line-height: 1.7;
            font-size: 1.05rem;
        }

        .message-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 10px;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: white;
            color: var(--primary);
        }

        .copy-btn.copied {
            color: var(--secondary);
            transform: scale(1.15);
        }

        .copy-btn.copied i::before {
            content: "\f00c";
        }

        #input-container {
            display: flex;
            padding: 20px 25px;
            background: white;
            border-top: 1px solid #edf2f7;
            gap: 15px;
            align-items: center;
            position: relative;
            flex-wrap: wrap;
        }

        #user-input {
            flex: 1;
            min-width: 200px;
            padding: 18px 25px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #user-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(74, 144, 226, 0.3);
        }

        #voice-btn, #send-btn {
            padding: 0 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            height: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s, transform 0.2s;
            min-width: 50px;
            flex-shrink: 0;
        }

        #send-btn {
            background: #45b39d;
        }

        #voice-btn:hover {
            background: #a3bffa;
            transform: translateY(-2px);
        }

        #send-btn:hover {
            background: #45b39d;
            transform: translateY(-2px);
        }

        #voice-btn:disabled {
            background: #a3bffa;
            cursor: not-allowed;
            transform: none;
        }

        #send-btn:disabled {
            background: #45b39d;
            cursor: not-allowed;
            transform: none;
        }

        #voice-btn.recording {
            background: var(--recording-bg);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        #tts-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            color: var(--text-dark);
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            background: var(--ai-bg);
            border-radius: var(--radius-sm);
            align-self: flex-start;
            box-shadow: var(--shadow);
        }

        .typing-indicator span {
            height: 12px;
            width: 12px;
            background: var(--text-light);
            border-radius: 50%;
            display: inline-block;
            margin: 0 3px;
            animation: typing 1s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        .recording-indicator {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--recording-bg);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideDown 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        @keyframes slideDown {
            from { top: -60px; opacity: 0; }
            to { top: -40px; opacity: 1; }
        }

        .recording-indicator i {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .swipe-hint {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: none;
        }

        /* VTUBER È†≠ÂÉèÁõ∏ÈóúÊ®£Âºè */
        .vtuber-container {
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            border: 3px solid var(--primary);
            transition: all 0.3s ease;
            cursor: grab;
            user-select: none;
        }

        .vtuber-container:active {
            cursor: grabbing;
        }

        .vtuber-avatar {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .vtuber-face {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #fde2e4;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .vtuber-face.hungry {
            background: #e8d5d6;
            transform: scale(0.95);
        }

        .vtuber-face.very-hungry {
            background: #dcc5c6;
            transform: scale(0.9);
        }

        .vtuber-hair {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            z-index: 2;
        }

        .vtuber-eyes {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 25px;
            display: flex;
            justify-content: space-between;
            z-index: 3;
        }

        .vtuber-face.hungry .vtuber-eyes {
            opacity: 0.8;
            transform: translate(-50%, -50%) scale(0.9);
        }

        .vtuber-face.very-hungry .vtuber-eyes {
            opacity: 0.6;
            transform: translate(-50%, -50%) scale(0.8);
        }

        .vtuber-eye {
            width: 30px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vtuber-face.hungry .vtuber-eye {
            transform: scaleY(0.8);
        }

        .vtuber-face.very-hungry .vtuber-eye {
            transform: scaleY(0.6);
        }

        .vtuber-pupil {
            width: 12px;
            height: 12px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            animation: blink 4s infinite;
        }

        .vtuber-mouth {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 15px;
            background: #ff9aa2;
            border-radius: 0 0 20px 20px;
            transition: all 0.2s ease;
            overflow: hidden;
            z-index: 3;
        }

        .vtuber-face.hungry .vtuber-mouth {
            width: 35px;
            height: 12px;
            background: #e08a8a;
        }

        .vtuber-face.very-hungry .vtuber-mouth {
            width: 30px;
            height: 10px;
            background: #cc7a7a;
            border-radius: 50%;
        }

        .vtuber-mouth.talking {
            animation: talking 0.3s infinite alternate;
        }

        .vtuber-face.hungry .vtuber-mouth.talking {
            animation: hungryTalking 0.4s infinite alternate;
        }

        .vtuber-face.very-hungry .vtuber-mouth.talking {
            animation: veryHungryTalking 0.5s infinite alternate;
        }

        .vtuber-mouth.eating {
            animation: eating 0.5s ease-in-out 3;
            background: #ffb347;
        }

        .vtuber-mouth-inner {
            width: 100%;
            height: 10px;
            background: #990000;
            border-radius: 50% / 100%;
            position: absolute;
            bottom: 0;
        }

        @keyframes talking {
            from { height: 15px; }
            to { height: 20px; }
        }

        @keyframes hungryTalking {
            from { height: 12px; }
            to { height: 16px; }
        }

        @keyframes veryHungryTalking {
            from { height: 10px; }
            to { height: 13px; }
        }

        @keyframes eating {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.2); }
            100% { transform: translateX(-50%) scale(1); }
        }

        @keyframes blink {
            0%, 5%, 15%, 100% { transform: scaleY(1); }
            10% { transform: scaleY(0.1); }
        }

        /* ÂïÜÂ∫óÂíåË®≠ÁΩÆÂΩàÁ™óÊ®£Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .points-display {
            font-size: 1.4rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--gold), var(--silver));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .points-display i {
            color: var(--gold);
        }

        .shop-tabs, .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            border: none;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .shop-item {
    background: #f9f9f9;
    border-radius: var(--radius-sm);
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
    border: 2px solid #e2e8f0;
    position: relative;
}

        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .shop-item.owned {
            border-color: var(--secondary);
        }

        .item-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            position: relative;
            overflow: hidden;
        }

        .expression-preview {
            background: #fde2e4;
            border-radius: 50%;
        }

        .food-preview {
            background: #fff3cd;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }

        .personality-preview {
            background: linear-gradient(135deg, var(--personality-purple), var(--personality-blue));
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }

        /* Êñ∞Â¢ûÁõ≤ÁõíÈ†êË¶ΩÊ®£Âºè */
        .mysterybox-preview {
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            background-size: cover;
            background-position: center;
        }

        .mysterybox-bronze {
            background: linear-gradient(135deg, var(--mysterybox-bronze), #A57044);
        }

        .mysterybox-silver {
            background: linear-gradient(135deg, var(--mysterybox-silver), #A8A9AD);
        }

        .mysterybox-gold {
            background: linear-gradient(135deg, var(--mysterybox-gold), #E5C100);
        }

        .expression-eyes {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 2;
        }

        .expression-eye {
            width: 20px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            position: relative;
        }

        .expression-pupil {
            width: 8px;
            height: 8px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 6px;
        }

        .expression-mouth {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            background: #ff9aa2;
            border-radius: 0 0 15px 15px;
            overflow: hidden;
            z-index: 2;
        }

        .expression-mouth-inner {
            width: 100%;
            height: 6px;
            background: #990000;
            border-radius: 50% / 100%;
            position: absolute;
            bottom: 0;
        }

        /* È´ÆÂûãÊ®£Âºè */
        .hair-1 {
            background: #8B4513;
            clip-path: polygon(0 0, 100% 0, 80% 50%, 20% 50%);
            height: 35px;
        }

        .hair-2 {
            background: #FFD700;
            clip-path: polygon(0 0, 100% 0, 90% 40%, 60% 50%, 30% 40%);
            height: 40px;
        }

        .hair-3 {
            background: #FF4500;
            clip-path: polygon(0 0, 100% 0, 70% 60%, 30% 60%);
            height: 35px;
        }

        .hair-4 {
            background: #4682B4;
            clip-path: polygon(0 0, 100% 0, 85% 30%, 50% 50%, 15% 30%);
            height: 30px;
        }

        .hair-5 {
            background: #228B22;
            clip-path: polygon(0 0, 100% 0, 95% 45%, 70% 55%, 30% 55%, 5% 45%);
            height: 40px;
        }

        .hair-6 {
            background: #9932CC;
            clip-path: polygon(0 0, 100% 0, 80% 40%, 60% 60%, 40% 60%, 20% 40%);
            height: 45px;
        }

        .shop-item h3 {
            margin: 10px 0;
            font-size: 1rem;
            color: var(--text-dark);
        }

        .shop-item .price {
            font-size: 0.9rem;
            color: var(--gold);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .shop-btn {
            padding: 6px 12px;
            border-radius: 15px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 0.9rem;
        }

        .buy-btn {
            background: var(--primary);
            color: white;
        }

        .buy-btn:hover {
            background: var(--primary-dark);
        }

        .buy-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .use-btn {
            background: var(--secondary);
            color: white;
        }

        .use-btn:hover {
            background: #3daa65;
        }

        .shop-item.owned .use-btn {
            background: var(--secondary);
        }

        .shop-item.owned .use-btn.active {
            background: var(--active-orange);
        }

        /* Ë®≠ÁΩÆÁïåÈù¢Ê®£Âºè */
        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.3rem;
        }

        .name-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .name-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        .name-input:focus {
            border-color: var(--primary);
        }

        .name-save-btn {
            padding: 12px 20px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .name-save-btn:hover {
            background: #3daa65;
        }

        .name-save-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .current-name-display {
            margin-top: 10px;
            padding: 10px;
            background: #f0f4f8;
            border-radius: 8px;
            color: var(--text-dark);
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #ffc107;
        }

        .error-message-input {
            background: #ffe6e6;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #e57373;
        }



/* Èö±ËóèÁâàË°®ÊÉÖÊ®£Âºè */
.hidden-sleepy .expression-mouth,
.vtuber-face.hidden-sleepy .vtuber-mouth {
    width: 20px;
    height: 8px;
    background: #8B8B8B;
    border-radius: 50%;
    transform: translateX(-50%);
    animation: sleepyBreath 3s ease-in-out infinite;
}

.hidden-sleepy .expression-eyes,
.vtuber-face.hidden-sleepy .vtuber-eyes {
    transform: translate(-50%, -50%) scale(1.1);
}

.hidden-sleepy .expression-eye,
.vtuber-face.hidden-sleepy .vtuber-eye {
    height: 6px;
    background: #8B8B8B;
    transform: scaleY(0.3);
    border-radius: 10px;
    position: relative;
}

.hidden-sleepy .expression-eye::before,
.vtuber-face.hidden-sleepy .vtuber-eye::before {
    content: '';
    position: absolute;
    top: -2px;
    left: 0;
    width: 100%;
    height: 2px;
    background: #333;
    border-radius: 50% 50% 0 0;
}
.hidden-sleepy .expression-pupil,
.vtuber-face.hidden-sleepy .vtuber-pupil {
    display: none;
}

.hidden-sleepy::after,
.vtuber-face.hidden-sleepy::after {
    content: 'Zzz...';
    position: absolute;
    top: -25px;
    right: 10px;
    font-size: 16px;
    color: #666;
    animation: sleepFloating 2s ease-in-out infinite alternate;
    font-style: italic;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

@keyframes sleepyBreath {
    0%, 100% { 
        width: 20px; 
        height: 8px; 
        opacity: 0.8;
    }
    50% { 
        width: 25px; 
        height: 10px; 
        opacity: 1;
    }
}

@keyframes sleepFloating {
    from { 
        opacity: 0.3; 
        transform: translateY(0px) scale(0.8); 
    }
    to { 
        opacity: 0.8; 
        transform: translateY(-8px) scale(1.1); 
    }
}
.hidden-shock-eyes .expression-eyes,
.vtuber-face.hidden-shock-eyes .vtuber-eyes {
    transform: translate(-50%, -50%) scale(1.8);
}

.hidden-shock-eyes .expression-eye,
.vtuber-face.hidden-shock-eyes .vtuber-eye {
    transform: scale(1.2);
    background: #FFFFFF;
    border: 3px solid #FF0000;
}

.hidden-shock-eyes .expression-pupil,
.vtuber-face.hidden-shock-eyes .vtuber-pupil {
    transform: scale(0.5);
    background: #000;
}

.hidden-shock-eyes .expression-mouth,
.vtuber-face.hidden-shock-eyes .vtuber-mouth {
    width: 8px;
    height: 25px;
    border-radius: 50%;
    background: #000;
    transform: translateX(-50%);
}

.hidden-shock-eyes::after,
.vtuber-face.hidden-shock-eyes::after {
    content: "‚ö°‚ö°‚ö°";
    position: absolute;
    top: 5px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 18px;
    animation: lightning 0.5s infinite alternate;
}

@keyframes lightning {
    from { opacity: 1; transform: translateX(-50%) scale(1); }
    to { opacity: 0.5; transform: translateX(-50%) scale(1.2); }
}

.hidden-cold .expression-eyes,
.vtuber-face.hidden-cold .vtuber-eyes {
    transform: translate(-50%, -50%) rotate(-5deg) scaleY(0.8);
}

.hidden-cold .expression-mouth,
.vtuber-face.hidden-cold .vtuber-mouth {
    width: 25px;
    height: 5px;
    background: #4682B4;
    border-radius: 0;
}

/* Èö±ËóèÁâàÈ´ÆÂûãÊ®£Âºè */
/* Èö±ËóèÁâàÈ´ÆÂûãÊ®£Âºè */
.hidden-hair-1 {
    background: linear-gradient(45deg, #FF0000, #FF7F00, #FFFF00, #00FF00, #0000FF, #4B0082, #9400D3);
    background-size: 200% 200%;
    animation: rainbowFlow 2s ease-in-out infinite;
    clip-path: polygon(0 0, 100% 0, 95% 60%, 5% 60%);
    height: 45px;
    position: relative;
    overflow: hidden;
}

.hidden-hair-1::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
    animation: shimmer 1.5s infinite;
}

@keyframes rainbowFlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.hidden-hair-2 {
    background: radial-gradient(circle at 30% 30%, #000033, #000066, #003366, #006699, #0099CC);
    clip-path: polygon(0 0, 100% 0, 90% 35%, 75% 55%, 25% 55%, 10% 35%);
    height: 40px;
    position: relative;
    overflow: hidden;
}

.hidden-hair-2::before {
    content: '‚ú®';
    position: absolute;
    top: 8px;
    left: 20%;
    font-size: 12px;
    color: white;
    animation: twinkle 2s infinite alternate;
}

.hidden-hair-2::after {
    content: '‚≠ê';
    position: absolute;
    top: 15px;
    right: 25%;
    font-size: 10px;
    color: #FFD700;
    animation: twinkle 1.5s infinite alternate-reverse;
}

@keyframes twinkle {
    from { opacity: 0.3; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1.2); }
}

.hidden-hair-3 {
    background: linear-gradient(135deg, #FF00FF, #00FFFF, #FFFF00, #FF69B4, #7B68EE, #00FA9A);
    background-size: 300% 300%;
    animation: auroraFlow 3s ease-in-out infinite;
    clip-path: polygon(0 0, 100% 0, 95% 30%, 80% 50%, 20% 50%, 5% 30%);
    height: 42px;
    position: relative;
    filter: blur(0.5px);
}

.hidden-hair-3::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%);
    animation: auroraShine 2s infinite;
}

@keyframes auroraFlow {
    0% { background-position: 0% 0%; filter: hue-rotate(0deg); }
    25% { background-position: 100% 100%; filter: hue-rotate(90deg); }
    50% { background-position: 0% 100%; filter: hue-rotate(180deg); }
    75% { background-position: 100% 0%; filter: hue-rotate(270deg); }
    100% { background-position: 0% 0%; filter: hue-rotate(360deg); }
}

@keyframes auroraShine {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
}

/* Èö±ËóèÁâàÊÄßÊ†ºÊ®£Âºè */
.personality-hidden-wuxia {
    background: linear-gradient(135deg, #8B0000, #4B0082);
}

.personality-hidden-poet {
    background: linear-gradient(135deg, #4682B4, #87CEEB);
}

.personality-hidden-sage {
    background: linear-gradient(135deg, #DAA520, #D2B48C);
}

/* Èö±ËóèÂïÜÂìÅÊ®£Âºè */
.hidden-item-preview {
    background: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: white;
}

.shop-item.hidden-item .item-preview::after {
    content: '?';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2.5rem;
    color: white;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(0,0,0,0.5);
}

.shop-item.hidden-item .item-preview {
    background: linear-gradient(135deg, #8a2be2, #4b0082);
}




        /* Ë°®ÊÉÖÊ®£Âºè */
        .happy .expression-mouth {
            border-radius: 50%;
            height: 20px;
            width: 30px;
            bottom: 20px;
        }
        
        .vtuber-face.happy .vtuber-mouth {
            border-radius: 50%;
            height: 25px;
            width: 35px;
            bottom: 25px;
        }

        .angry .expression-eyes {
            transform: translate(-50%, -50%) rotate(10deg);
        }
        
        .angry::before {
            content: "üí¢";
            position: absolute;
            top: 0;
            right: 0;
            font-size: 20px;
        }
        
        .vtuber-face.angry::before {
            content: "üí¢";
            position: absolute;
            top: 0;
            right: 0;
            font-size: 28px;
        }

        .angry .expression-mouth {
            border-radius: 50%;
            height: 6px;
            width: 35px;
            background: #d9534f;
        }
        
        .vtuber-face.angry .vtuber-mouth {
            height: 8px;
            width: 40px;
            background: #d9534f;
            border-radius: 50%;
        }
        
        .angry .expression-eye,
        .vtuber-face.angry .vtuber-eye {
            transform: rotate(10deg) scaleX(0.8);
        }

        .surprised .expression-eyes {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .surprised .expression-pupil {
            transform: scale(0.8);
        }

        .surprised .expression-mouth {
            border-radius: 50%;
            height: 20px;
            width: 15px;
        }
        
        .vtuber-face.surprised .vtuber-eyes {
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .vtuber-face.surprised .vtuber-pupil {
            transform: scale(0.8);
        }
        
        .vtuber-face.surprised .vtuber-mouth {
            border-radius: 50%;
            height: 25px;
            width: 20px;
        }

        .sad .expression-eyes {
            transform: translate(-50%, -30%) rotate(-5deg);
        }

        .sad .expression-mouth {
            border-radius: 50% 50% 0 0;
            height: 8px;
            width: 25px;
            top: 50px;
            background: #5bc0de;
        }
        
        .vtuber-face.sad .vtuber-eyes {
            transform: translate(-50%, -30%) rotate(-5deg);
        }
        
        .vtuber-face.sad .vtuber-mouth {
            border-radius: 50% 50% 0 0;
            height: 10px;
            width: 30px;
            top: 60px;
            bottom: unset;
            background: #5bc0de;
        }

        .wink .expression-eye:first-child {
            height: 3px;
        }

        .wink .expression-eye:first-child .expression-pupil {
            display: none;
        }

        .wink .expression-mouth {
            transform: translateX(-50%) rotate(5deg);
            border-radius: 15px;
            height: 8px;
            width: 30px;
        }
        
        .vtuber-face.wink .vtuber-eye:first-child {
            height: 5px;
        }
        
        .vtuber-face.wink .vtuber-eye:first-child .vtuber-pupil {
            display: none;
        }
        
        .vtuber-face.wink .vtuber-mouth {
            transform: translateX(-50%) rotate(5deg);
            border-radius: 20px;
            height: 10px;
            width: 35px;
        }

        /* ÊÄßÊ†ºÁ≥ªÁµ±Ê®£Âºè */
        .personality-gentle {
            background: linear-gradient(135deg, #FFB6C1, #FFC0CB);
        }

        .personality-serious {
            background: linear-gradient(135deg, #708090, #2F4F4F);
        }

        .personality-cheerful {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .personality-sarcastic {
            background: linear-gradient(135deg, #800080, #4B0082);
        }

        .personality-wise {
            background: linear-gradient(135deg, #20B2AA, #008B8B);
        }

        .personality-humorous {
            background: linear-gradient(135deg, #FF6347, #FF4500);
        }

        /* Áõ≤ÁõíÂãïÁï´Áõ∏ÈóúÊ®£Âºè */
/* 3DÁ´ãÈ´îÁõ≤ÁõíÂãïÁï´Ê®£Âºè */
.mysterybox-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 300;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
}

.mysterybox-3d-container {
    position: relative;
    perspective: 1000px;
    transform-style: preserve-3d;
}

.gift-box-3d {
    width: 200px;
    height: 200px;
    position: relative;
    transform-style: preserve-3d;
    transform: rotateX(-10deg) rotateY(15deg);
    animation: mysteryboxFloat 3s ease-in-out infinite;
}

@keyframes mysteryboxFloat {
    0%, 100% { 
        transform: rotateX(-10deg) rotateY(15deg) translateY(0px); 
    }
    50% { 
        transform: rotateX(-5deg) rotateY(25deg) translateY(-15px); 
    }
}

@keyframes mysteryboxShake {
    0%, 100% { 
        transform: rotateX(-10deg) rotateY(15deg) translateY(0px); 
    }
    25% { 
        transform: rotateX(-8deg) rotateY(12deg) translateY(-5px) translateX(-8px); 
    }
    50% { 
        transform: rotateX(-12deg) rotateY(18deg) translateY(-3px) translateX(8px); 
    }
    75% { 
        transform: rotateX(-6deg) rotateY(20deg) translateY(-8px) translateX(-5px); 
    }
}

/* ÁõíÂ≠êÊ∂àÂ§±ÂãïÁï´ */
@keyframes mysteryboxDisappear {
    0% { 
        opacity: 1; 
        transform: scale(1) rotateY(0deg); 
    }
    100% { 
        opacity: 0; 
        transform: scale(0.5) rotateY(180deg); 
    }
}

/* ÁµêÊûúÂÆπÂô®ÊîæÂ§ßÂãïÁï´ */
.mysterybox-result-container.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-30px) scale(1.1);
    animation: resultEntrance 0.8s ease-out;
}

@keyframes resultEntrance {
    0% {
        opacity: 0;
        transform: translateX(-50%) translateY(20px) scale(0.8);
    }
    50% {
        transform: translateX(-50%) translateY(-40px) scale(1.15);
    }
    100% {
        opacity: 1;
        transform: translateX(-50%) translateY(-30px) scale(1.1);
    }
}





/* Á¶ÆÁâ©ÁõíÂêÑÂÄãÈù¢ */
.box-face {
    position: absolute;
    width: 200px;
    height: 200px;
    opacity: 0.95;
    border: 3px solid #8B4513;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
}

.box-front {
    background: linear-gradient(135deg, #FF6B9D 0%, #C44CAE 50%, #8A2BE2 100%);
    transform: translateZ(100px);
}

.box-back {
    background: linear-gradient(135deg, #E55A87 0%, #B23A8E 50%, #7B1FA2 100%);
    transform: translateZ(-100px) rotateY(180deg);
}

.box-right {
    background: linear-gradient(135deg, #FF8E9B 0%, #D147AA 50%, #9C27B0 100%);
    transform: rotateY(90deg) translateZ(100px);
}

.box-left {
    background: linear-gradient(135deg, #E84393 0%, #B8459E 50%, #8E24AA 100%);
    transform: rotateY(-90deg) translateZ(100px);
}

.box-top {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
    transform: rotateX(90deg) translateZ(100px);
    transform-origin: center center;
    transition: all 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.box-bottom {
    background: linear-gradient(135deg, #FF69B4 0%, #DA70D6 50%, #BA55D3 100%);
    transform: rotateX(-90deg) translateZ(100px);
}

/* ÁõíËìãÊâìÈñãÂãïÁï´ */
.gift-box-3d.opening .box-top {
    transform: rotateX(90deg) translateZ(100px) rotateX(-120deg) translateY(-80px);
}

/* Á¶ÆÁâ©ÁõíË£ùÈ£æÁµ≤Â∏∂ */
.ribbon-vertical {
    position: absolute;
    width: 20px;
    height: 200px;
    background: linear-gradient(90deg, #DC143C 0%, #B71C1C 50%, #8B0000 100%);
    left: 50%;
    top: 0;
    transform: translateX(-50%);
    z-index: 5;
    box-shadow: 0 0 15px rgba(220, 20, 60, 0.5);
}

.ribbon-horizontal {
    position: absolute;
    width: 200px;
    height: 20px;
    background: linear-gradient(90deg, #DC143C 0%, #B71C1C 50%, #8B0000 100%);
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    z-index: 5;
    box-shadow: 0 0 15px rgba(220, 20, 60, 0.5);
}

/* Ëù¥Ëù∂Áµê */
.bow-3d {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 40px;
    z-index: 6;
}

.bow-left, .bow-right {
    position: absolute;
    width: 25px;
    height: 35px;
    background: linear-gradient(135deg, #FF0000, #CC0000);
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    box-shadow: 0 5px 15px rgba(0,0,0,0.4);
}

.bow-left {
    left: 5px;
    transform: rotate(-25deg);
}

.bow-right {
    right: 5px;
    transform: rotate(25deg);
}

.bow-center {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 15px;
    height: 30px;
    background: linear-gradient(90deg, #B71C1C, #FF0000, #B71C1C);
    border-radius: 3px;
    box-shadow: inset 2px 0 0 rgba(255,255,255,0.3), inset -2px 0 0 rgba(0,0,0,0.3);
}

/* ÊäΩÁçéÁµêÊûúÈ°ØÁ§∫ */
.mysterybox-result-container {
    position: absolute;
    bottom: -120px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    border: 3px solid #FFD700;
    min-width: 300px;
    opacity: 0;
    transition: all 0.8s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.mysterybox-result-container.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-30px);
}

.mysterybox-result-icon {
    font-size: 3rem;
    margin-bottom: 10px;
    display: block;
    animation: resultPulse 2s infinite alternate;
    margin-left: auto;
    margin-right: auto;
}

.mysterybox-result-text {
    font-size: 1.4rem;
    font-weight: bold;
    color: #333;
    margin: 0;
    text-align: center;
    line-height: 1.5;
    text-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

@keyframes resultPulse {
    0% { transform: scale(1) rotate(0deg); }
    100% { transform: scale(1.15) rotate(5deg); }
}

/* 3DÁ¥ôÂ±ëÁ≤íÂ≠êÊïàÊûú */
.confetti-3d {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: confetti3dFall 4s ease-out forwards;
    z-index: 10;
}

@keyframes confetti3dFall {
    0% {
        transform: translateY(-100vh) rotateX(0deg) rotateZ(0deg) scale(1);
        opacity: 1;
    }
    50% {
        transform: translateY(-50vh) rotateX(180deg) rotateZ(180deg) scale(1.2);
        opacity: 0.8;
    }
    100% {
        transform: translateY(100vh) rotateX(360deg) rotateZ(360deg) scale(0.5);
        opacity: 0;
    }
}

/* Áõ≤ÁõíÈ°ûÂûãÁâπÂÆöÈ°èËâ≤ */
.mysterybox-bronze .box-front { background: linear-gradient(135deg, #CD7F32 0%, #A0522D 50%, #8B4513 100%); }
.mysterybox-bronze .box-back { background: linear-gradient(135deg, #B8722D 0%, #965C2A 50%, #7A4513 100%); }
.mysterybox-bronze .box-right { background: linear-gradient(135deg, #D4863A 0%, #A85F2E 50%, #8F4A15 100%); }
.mysterybox-bronze .box-left { background: linear-gradient(135deg, #C27A30 0%, #9E572B 50%, #854315 100%); }
.mysterybox-bronze .box-bottom { background: linear-gradient(135deg, #CE8033 0%, #A45A2C 50%, #8A4614 100%); }

.mysterybox-silver .box-front { background: linear-gradient(135deg, #C0C0C0 0%, #A8A9AD 50%, #708090 100%); }
.mysterybox-silver .box-back { background: linear-gradient(135deg, #B5B5B5 0%, #9D9EA2 50%, #6B7280 100%); }
.mysterybox-silver .box-right { background: linear-gradient(135deg, #CACACA 0%, #B2B3B7 50%, #757C8A 100%); }
.mysterybox-silver .box-left { background: linear-gradient(135deg, #BABABA 0%, #A2A3A7 50%, #6F7685 100%); }
.mysterybox-silver .box-bottom { background: linear-gradient(135deg, #C5C5C5 0%, #ACADB1 50%, #737A88 100%); }

.mysterybox-gold .box-front { background: linear-gradient(135deg, #FFD700 0%, #DAA520 50%, #B8860B 100%); }
.mysterybox-gold .box-back { background: linear-gradient(135deg, #F5D12D 0%, #CF9F1F 50%, #AD800A 100%); }
.mysterybox-gold .box-right { background: linear-gradient(135deg, #FFDC33 0%, #DFA823 50%, #BD890C 100%); }
.mysterybox-gold .box-left { background: linear-gradient(135deg, #FFD11A 0%, #D4A221 50%, #B2830A 100%); }
.mysterybox-gold .box-bottom { background: linear-gradient(135deg, #FFD926 0%, #D9A522 50%, #B7860B 100%); }


.mysterybox-canvas-container {
    position: relative;
    text-align: center;
}

#mysteryboxCanvas {
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.mysterybox-result-container {
    position: absolute;
    bottom: -120px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    border: 3px solid #FFD700;
    min-width: 300px;
    opacity: 0;
    transition: all 0.8s ease;
}



.mysterybox-result-container.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-20px);
}

.mysterybox-result-icon {
    font-size: 3rem;
    margin-bottom: 10px;
    display: block;
    animation: resultPulse 2s infinite alternate;
}

.mysterybox-result-text {
    font-size: 1.3rem;
    font-weight: bold;
    color: #333;
    margin: 0;
    text-align: center;
    line-height: 1.4;
}

@keyframes resultPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.1); }
}


       .gift-box {
    width: 200px;
    height: 200px;
    position: relative;
    transform: scale(0);
    animation: appear 0.8s forwards, float 2s 0.8s infinite ease-in-out;
    perspective: 1000px;
    transform-style: preserve-3d;
}

@keyframes appear {
    to { 
        transform: scale(1) rotateY(0deg); 
    }
}

@keyframes float {
    0%, 100% { 
        transform: scale(1) rotateY(0deg) translateY(0px); 
    }
    50% { 
        transform: scale(1.05) rotateY(10deg) translateY(-10px); 
    }
}

.gift-box-top {
    position: absolute;
    top: -30px;
    left: 0;
    width: 200px;
    height: 50px;
    background: linear-gradient(135deg, var(--mysterybox-gold), #B8860B);
    border: 3px solid #8B4513;
    border-radius: 8px 8px 4px 4px;
    z-index: 3;
    transform-origin: bottom center;
    transition: all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    box-shadow: 
        0 5px 15px rgba(0,0,0,0.3),
        inset 0 2px 0 rgba(255,255,255,0.3),
        inset 0 -2px 0 rgba(0,0,0,0.2);
    transform-style: preserve-3d;
}

.gift-box-top::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
    border-radius: inherit;
    animation: shine 2s infinite;
}

@keyframes shine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.gift-box-body {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 200px;
    height: 150px;
    background: linear-gradient(135deg, var(--mysterybox-silver), #A8A9AD);
    border: 3px solid #8B4513;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 
        0 10px 25px rgba(0,0,0,0.4),
        inset 0 3px 0 rgba(255,255,255,0.2),
        inset 0 -3px 0 rgba(0,0,0,0.2);
    transform-style: preserve-3d;
}

.gift-box-body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3) 0%, transparent 50%),
        radial-gradient(circle at 70% 70%, rgba(0,0,0,0.1) 0%, transparent 50%);
}

.gift-box.bronze .gift-box-top {
    background: linear-gradient(135deg, var(--mysterybox-bronze), #8B4513);
}

.gift-box.bronze .gift-box-body {
    background: linear-gradient(135deg, #CE955B, #A0522D);
}

.gift-box.silver .gift-box-top {
    background: linear-gradient(135deg, var(--mysterybox-silver), #708090);
}

.gift-box.silver .gift-box-body {
    background: linear-gradient(135deg, #D9D9D9, #A8A9AD);
}

.gift-box.gold .gift-box-top {
    background: linear-gradient(135deg, var(--mysterybox-gold), #DAA520);
}

.gift-box.gold .gift-box-body {
    background: linear-gradient(135deg, #FFE873, #F0E68C);
}

.gift-bow {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    width: 50px;
    height: 30px;
    z-index: 4;
}

.gift-bow::before, .gift-bow::after {
    content: '';
    position: absolute;
    width: 25px;
    height: 35px;
    background: linear-gradient(135deg, #FF0000, #CC0000);
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    box-shadow: 
        0 3px 8px rgba(0,0,0,0.3),
        inset 1px 1px 0 rgba(255,255,255,0.3);
}

.gift-bow::before {
    top: 0;
    left: 0;
    transform: rotate(-25deg);
}

.gift-bow::after {
    top: 0;
    right: 0;
    transform: rotate(25deg);
}

.gift-ribbon {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 15px;
    height: 150px;
    background: linear-gradient(90deg, #CC0000, #FF0000, #CC0000);
    z-index: 2;
    box-shadow: 
        inset 2px 0 0 rgba(255,255,255,0.3),
        inset -2px 0 0 rgba(0,0,0,0.3);
}

.gift-ribbon::before {
    content: '';
    position: absolute;
    top: -30px;
    left: -25px;
    width: 65px;
    height: 15px;
    background: linear-gradient(90deg, #CC0000, #FF0000, #CC0000);
    border-radius: 3px;
    box-shadow: 
        inset 0 2px 0 rgba(255,255,255,0.3),
        inset 0 -2px 0 rgba(0,0,0,0.3);
}

.gift-box.opening .gift-box-top {
    transform: translateY(-80px) rotateX(-120deg) scale(0.9);
    box-shadow: 0 15px 30px rgba(0,0,0,0.5);
}

.gift-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, 150%);
    opacity: 0;
    transition: all 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 2;
    text-align: center;
}

.gift-box.opened .gift-content {
    transform: translate(-50%, -50%) scale(1.1);
    opacity: 1;
}

.gift-icon {
    font-size: 4.5rem;
    margin-bottom: 20px;
    display: inline-block;
    animation: iconGlow 2s infinite alternate;
    text-shadow: 0 0 20px rgba(255,255,255,0.8);
}

@keyframes iconGlow {
    0% { 
        transform: scale(1) rotate(0deg);
        filter: drop-shadow(0 0 10px rgba(255,215,0,0.8));
    }
    100% { 
        transform: scale(1.1) rotate(5deg);
        filter: drop-shadow(0 0 20px rgba(255,215,0,1));
    }
}

.gift-text {
    color: white;
    font-size: 1.6rem;
    font-weight: bold;
    text-shadow: 
        0 0 10px rgba(0,0,0,0.8),
        0 2px 4px rgba(0,0,0,0.5);
    background: linear-gradient(45deg, #FFD700, #FFA500);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    animation: textPulse 1.5s infinite alternate;
}

@keyframes textPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.05); }
}

.confetti {
    position: absolute;
    width: 12px;
    height: 12px;
    opacity: 0;
    border-radius: 50%;
    animation: confetti-3d 4s ease-out forwards;
}

@keyframes confetti-3d {
    0% {
        transform: translateY(-100vh) translateX(0) rotateZ(0deg) scale(1);
        opacity: 1;
    }
    50% {
        transform: translateY(-50vh) translateX(var(--random-x, 0)) rotateZ(180deg) scale(1.2);
        opacity: 0.8;
    }
    100% {
        transform: translateY(100vh) translateX(var(--random-x, 0)) rotateZ(360deg) scale(0.5);
        opacity: 0;
    }
}


        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff0000;
            opacity: 0;
        }

        @keyframes confetti-fall {
            from {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0.3;
            }
        }

        .notification {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 400;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }

        .notification.show {
            opacity: 1;
        }

        /* ÁßªÂãïÁ´ØÈÅ©ÈÖç */
       @media (max-width: 768px) {
    body {
        padding: 15px;
        padding-top: 80px;
    }

    .top-controls {
        padding: 10px 15px;
        flex-direction: row;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
    }

    .left-controls {
        flex: 1;
        gap: 8px;
    }

    .shop-button, .settings-button {
        flex: 1;
        padding: 8px 12px;
        font-size: 0.9rem;
    }

    .hunger-bar-container {
        flex: 1;
        min-width: 120px;
        padding: 8px 10px;
    }

    .hunger-icon {
        font-size: 1rem;
    }

    .hunger-percentage {
        font-size: 0.8rem;
    }

    .vtuber-container {
        width: 100px;
        height: 100px;
        bottom: 20px;
        right: 20px;
    }

            .vtuber-face {
                width: 80px;
                height: 80px;
            }

            .vtuber-hair {
                height: 40px;
            }

            .vtuber-eyes {
                width: 60px;
                height: 15px;
            }

            .vtuber-eye {
                width: 20px;
                height: 15px;
            }

            .vtuber-pupil {
                width: 8px;
                height: 8px;
            }

            .vtuber-mouth {
                width: 30px;
                height: 10px;
                bottom: 20px;
            }

            .vtuber-mouth.talking {
                height: 18px;
            }

            #chat-container {
                height: calc(100vh - 120px);
            }

            #input-container {
                padding: 15px;
                gap: 8px;
                flex-wrap: nowrap;
            }

            #user-input {
                min-width: 150px;
                padding: 12px 15px;
                font-size: 1rem;
            }

            #voice-btn, #send-btn {
                padding: 0 12px;
                font-size: 1rem;
                min-width: 45px;
                height: 45px;
            }

            #tts-toggle {
                font-size: 0.95rem;
                margin-top: 8px;
            }

            .shop-items {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }

            .item-preview {
                width: 60px;
                height: 60px;
            }

            .shop-item {
                padding: 10px;
            }

            .shop-item h3 {
                font-size: 0.9rem;
            }

            .shop-item .price {
                font-size: 0.8rem;
            }

            .shop-btn {
                font-size: 0.8rem;
                padding: 5px 10px;
            }

            .name-input-group {
                flex-direction: column;
            }

            .name-input {
                min-width: 100%;
            }

            .gift-box {
                width: 150px;
                height: 150px;
            }

            .gift-box-top {
                width: 150px;
                height: 40px;
            }

            .gift-box-body {
                width: 150px;
                height: 110px;
            }

            .gift-ribbon {
                left: 70px;
                height: 110px;
            }

            .gift-icon {
                font-size: 3rem;
            }

            .gift-text {
                font-size: 1.2rem;
            }
        }


/* Âú®ÁèæÊúâCSS‰∏≠Ê∑ªÂä†‰ª•‰∏ãÊ®£Âºè */

/* Ë™çË≠âÁïåÈù¢Ê®£Âºè */
#auth-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
}

.auth-modal {
    background: white;
    padding: 40px;
    border-radius: 20px;
    box-shadow: var(--shadow);
    max-width: 400px;
    width: 90%;
}

.auth-content h2 {
    text-align: center;
    color: var(--primary);
    margin-bottom: 30px;
}

.auth-content input {
    width: 100%;
    padding: 15px;
    margin: 10px 0;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 1rem;
    outline: none;
}

.auth-content input:focus {
    border-color: var(--primary);
}

.auth-content button {
    width: 100%;
    padding: 15px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    cursor: pointer;
    margin: 10px 0;
}

.auth-content button:hover {
    background: var(--primary-dark);
}

.auth-content a {
    color: var(--primary);
    text-decoration: none;
}

/* Â•ΩÂèãÊåâÈàïÊ®£Âºè */
.friends-button {
    background: #3498db;
    color: white;
    padding: 12px 15px;
    border-radius: 30px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    border: none;
}

.friends-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.logout-button {
    background: #e74c3c;
    color: white;
    padding: 12px 15px;
    border-radius: 30px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.logout-button:hover {
    background: #c0392b;
}

/* Â•ΩÂèãÁ≥ªÁµ±Ê®£Âºè */
.friends-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.friends-tab-content {
    min-height: 300px;
}

.add-friend-form {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.add-friend-form input {
    flex: 1;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
}

.add-friend-form button {
    padding: 12px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}


/* ÈÄÅÁ¶ÆÁïåÈù¢Â•ΩÂèãÈ†ÖÁõÆÊá∏ÂÅúÊïàÊûú */
.gift-modal .friend-item:hover {
    border-color: #ff6b9d !important;
    background-color: #fff5f8 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 107, 157, 0.2);
}

.gift-modal .select-friend-btn:hover {
    background: #357abd !important;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
}

.gift-modal .select-friend-btn.active {
    background: #ff6b9d !important;
    color: white !important;
}

.gift-modal .select-friend-btn.active:hover {
    background: #e55a87 !important;
}



.friend-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    margin-bottom: 10px;
}

.friend-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px;
}

.friend-info {
    flex: 1;
}

.friend-actions {
    display: flex;
    gap: 10px;
}

.friend-actions button {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
}

        #send-friend-request {
    padding: 10px;
    font-size: 1.2rem;
    background: #73c6b6 ;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
}   


}
/* Ê∑ªÂä†‰ª•‰∏ãÊñ∞Ê®£Âºè */
.accept-btn, .reject-btn {
    padding: 8px; /* Ê∏õÂ∞ëÂÖßÈÇäË∑ù‰ª•ÈÅ©ÊáâÂúñÁ§∫ */
    width: 40px; /* Âõ∫ÂÆöÂØ¨Â∫¶ */
    height: 40px; /* Âõ∫ÂÆöÈ´òÂ∫¶ */
    display: flex;
    align-items: center;
    justify-content: center;
}
@media (max-width: 768px) {
    .accept-btn, .reject-btn {
        width: 35px; /* Â∞èÂ±èÂπïË™øÊï¥ */
        height: 35px;
        padding: 6px;
    }
}


.chat-btn {
    background: var(--secondary);
    color: white;
}

.accept-btn {
    background: var(--secondary);
    color: white;
}

.reject-btn {
    background: #e74c3c;
    color: white;
}

/* Âú®ÁèæÊúâCSS‰∏≠Ê∑ªÂä† */
.gift-btn {
    background: #ff6b9d;
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
}

.gift-btn:hover {
    background: #e55a87;
}

.gift-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 300;
    justify-content: center;
    align-items: center;
}

.gift-modal-content {
    background: white;
    border-radius: 15px;
    padding: 25px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.gift-items {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.gift-item {
    background: #f9f9f9;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.gift-item:hover {
    border-color: #ff6b9d;
    transform: translateY(-2px);
}

.gift-item.selected {
    border-color: #ff6b9d;
    background: #ffe8f0;
}

.received-gifts {
    background: #e8f5e8;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

.received-gift-item {
    display: flex;
    align-items: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid #ff6b9d;
    min-width: 0; /* ÁßªÈô§Âõ∫ÂÆöÊúÄÂ∞èÂØ¨Â∫¶ */
    width: 100%; /* ÈÅ©ÊáâÂÆπÂô®ÂØ¨Â∫¶ */
    gap: 15px;
    flex-wrap: wrap; /* ÂÖÅË®±ÊèõË°å */
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    box-sizing: border-box; /* Á¢∫‰øùË®àÁÆóÊ≠£Á¢∫ */
}

.received-gift-item > div:first-child {
    flex: 1;
    min-width: 0; /* ÁßªÈô§Âõ∫ÂÆöÊúÄÂ∞èÂØ¨Â∫¶ */
    width: 100%; /* ÈÅ©ÊáâÂÆπÂô® */
    white-space: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.received-gift-item .item-preview {
    flex-shrink: 0;
    margin-right: 15px;
}

.received-gift-item button {
    flex-shrink: 0;
    min-width: 80px;
    white-space: nowrap;
}




.gift-notification {
    position: fixed;
    top: 100px;
    right: 20px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 500;
    max-width: 300px;
}

.gift-notification-content {
    padding: 20px;
    text-align: center;
}

.gift-notification-content h3 {
    color: #ff6b9d;
    margin-bottom: 10px;
}

.gift-notification-content button {
    background: #ff6b9d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    margin-top: 10px;
}


.gift-icon {
    color: #ff6b9d;
    font-size: 1rem;
    transition: transform 0.2s ease;
}
.gift-icon:hover {
    transform: scale(1.2);
}


/* Â•ΩÂèãÈÅ∏ÊìáÊåâÈàïÊ®£ÂºèÊîπÈÄ≤ */
#friend-select-list .friend-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    margin-bottom: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    transition: all 0.3s ease;
}

#friend-select-list .friend-item:hover {
    border-color: #ff6b9d;
    background-color: #ffe8f0;
}

#friend-select-list button.active {
    background: #ff6b9d !important;
    color: white !important;
}

#confirm-gift-btn:disabled {
    background: #a0aec0 !important;
    cursor: not-allowed;
}

/* ÈÄÅÁ¶ÆÁïåÈù¢ÂÑ™ÂåñÊ®£Âºè */
.gift-modal-content {
    max-width: 500px;
    width: 95%;
}

#friend-select-list .friend-item {
    transition: all 0.3s ease;
}

#friend-select-list .friend-item:hover {
    border-color: #ff6b9d;
    background-color: #fff5f8;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.select-friend-btn {
    transition: all 0.3s ease;
}

.select-friend-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.select-friend-btn.active {
    background: #ff6b9d !important;
    color: white !important;
}

/* Á¶ÆÁâ©ÂúñÊ®ôÊîπÈÄ≤ */
.gift-icon {
    z-index: 5;
    transition: all 0.2s ease;
}

.gift-icon:hover {
    transform: scale(1.3);
    color: #ff6b9d !important;
}

/* ÂïÜÂìÅÈ†ÖÁõÆÁõ∏Â∞çÂÆö‰ΩçÁ¢∫‰øùÁ¶ÆÁâ©ÂúñÊ®ôÊ≠£Á¢∫È°ØÁ§∫ */
.shop-item {
    position: relative;
}



        /* ÂûÇÁõ¥ÊªæÂãïËª∏Ê®£Âºè */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #edf2f7;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>


	
    <!-- ÁôªÂÖ•ÁïåÈù¢ -->
    <div id="auth-container" style="display: none;">
        <div class="auth-modal">
            <div class="auth-content">
                <h2>Âè≤ËêäÂßÜÊïôÂÆ§</h2>
                <div id="login-form">
                    <h3>ÁôªÂÖ•</h3>
                    <input type="email" id="login-email" placeholder="ÈõªÂ≠êÈÉµ‰ª∂">
                    <input type="password" id="login-password" placeholder="ÂØÜÁ¢º">
                    <button id="login-btn">ÁôªÂÖ•</button>
                    <p>ÈÇÑÊ≤íÊúâÂ∏≥ËôüÔºü<a href="#" id="show-register">Ë®ªÂÜä</a></p>
                </div>
                <div id="register-form" style="display: none;">
                    <h3>Ë®ªÂÜä</h3>
                    <input type="email" id="register-email" placeholder="ÈõªÂ≠êÈÉµ‰ª∂">
                    <input type="password" id="register-password" placeholder="ÂØÜÁ¢º">
                    <input type="text" id="register-character-name" placeholder="ËßíËâ≤ÂêçÁ®±">

                    <button id="register-btn">Ë®ªÂÜä</button>
                    <p>Â∑≤ÊúâÂ∏≥ËôüÔºü<a href="#" id="show-login">ÁôªÂÖ•</a></p>
                </div>
            </div>
        </div>
    </div>



    <!-- È†ÇÈÉ®ÊéßÂà∂ÂçÄÂüü -->
    <div class="top-controls">
        <div class="left-controls">
              <button class="settings-button" id="settings-button">
                <i class="fas fa-cog"></i>
          

<!-- Êñ∞Â¢ûÂ•ΩÂèãÊåâÈàï -->
            <button class="friends-button" id="friends-button">
                <i class="fas fa-users"></i>
            </button>


            </button>
            <button class="shop-button" id="shop-button">
                <i class="fas fa-store"></i>
           
                <span class="points" id="points-display">0 Èªû</span>
            </button>
            
          
        </div>





        <div class="hunger-bar-container" id="hunger-bar-container">
            <i class="fas fa-drumstick-bite hunger-icon" id="hunger-icon"></i>
            <div class="hunger-bar">
                <div class="hunger-fill" id="hunger-fill"></div>
            </div>
            <span class="hunger-percentage" id="hunger-percentage">100%</span>
        </div>

 <!-- Ê∑ªÂä†ÁôªÂá∫ÊåâÈàï -->
        <button class="logout-button" id="logout-button">
            <i class="fas fa-sign-out-alt"></i>
        </button>

        
    </div>

    <!-- ÂïÜÂ∫óÂΩàÁ™ó -->
    <div class="modal" id="shop-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-gift"></i> ÂïÜÂ∫ó</h2>
                <button class="close-modal" id="close-shop">√ó</button>
            </div>
            <div class="points-display">
                <i class="fas fa-coins"></i>
                <span>ÈªûÊï∏: <span id="shop-points">0</span></span>
            </div>
            <p>ËàáÂè≤ËêäÂßÜËÅäÂ§©ÂèØ‰ª•Áç≤ÂæóÈªûÊï∏ÔºåÊØèÂÆåÊàê‰∏ÄËº™Â∞çË©±Áç≤Âæó1Èªû</p>
            
            <div class="shop-tabs">
                <button class="tab active" data-tab="expressions">Ë°®ÊÉÖ</button>
                <button class="tab" data-tab="hairstyles">È´ÆÂûã</button>
                <button class="tab" data-tab="foods">È£üÁâ©</button>
                <button class="tab" data-tab="personalities">ÂΩ¢Ë±°</button>
                <button class="tab" data-tab="mysteryboxes">Áõ≤Áõí</button>
            </div>
            
            <div class="shop-items" id="shop-items">
                <!-- ÂïÜÂìÅÂ∞áÈÄöÈÅéJSÂãïÊÖãÁîüÊàê -->
            </div>
        </div>
    </div>

<!-- Â•ΩÂèãÁ≥ªÁµ±ÂΩàÁ™ó -->
<div class="modal" id="friends-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-users"></i> Â•ΩÂèãÁ≥ªÁµ±</h2>
            <button class="close-modal" id="close-friends">√ó</button>
        </div>
        
        <div class="friends-tabs">
    <button class="tab active" data-tab="friends-list">Â•ΩÂèãÂàóË°®</button>
    <button class="tab" data-tab="add-friend">Ê∑ªÂä†Â•ΩÂèã</button>
    <button class="tab" data-tab="friend-requests">Â•ΩÂèãÁî≥Ë´ã</button>
</div>
        
        <div id="friends-content">
            <!-- Â•ΩÂèãÂàóË°® -->
            <div id="friends-list" class="friends-tab-content">
                <div id="friends-list-container"></div>
            </div>
            
            <!-- Ê∑ªÂä†Â•ΩÂèã -->
            <div id="add-friend" class="friends-tab-content" style="display: none;">
                <div class="add-friend-form">
                    <input type="email" id="friend-email" placeholder="Ëº∏ÂÖ•Â•ΩÂèãÁöÑÈõªÂ≠êÈÉµ‰ª∂">
                   <button id="send-friend-request"><i class="fas fa-user-plus"></i></button>

                </div>
            </div>
            
            <!-- Â•ΩÂèãÁî≥Ë´ã -->
            <div id="friend-requests" class="friends-tab-content" style="display: none;">
                <div id="friend-requests-container"></div>
            </div>
            
           
        </div>
    </div>
</div>



    <!-- Ë®≠ÁΩÆÂΩàÁ™ó -->
    <div class="modal" id="settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-cog"></i> Ë®≠ÁΩÆ</h2>
            <button class="close-modal" id="close-settings">√ó</button>
        </div>
        
        <div class="settings-section">
            <h3><i class="fas fa-user"></i> ËßíËâ≤ÂêçÁ®±Ë®≠ÂÆö</h3>
            <div class="name-input-group">
                <input type="text" class="name-input" id="vtuber-name-input" placeholder="Ëº∏ÂÖ•Ëá™ÂÆöÁæ©ÂêçÁ®±" maxlength="20">
                <button class="name-save-btn" id="save-name-btn">‰øùÂ≠ò</button>
            </div>
            <div class="current-name-display" id="current-name-display">
                Áï∂ÂâçÂêçÁ®±ÔºöÂè≤ËêäÂßÜ
            </div>
        </div>
        


        <div class="settings-section">
            <h3><i class="fas fa-volume-up"></i> Ë™ûÈü≥Ë®≠ÁΩÆ</h3>
            <div class="tts-toggle">
                <label for="tts-auto-play">Ëá™ÂãïÊí≠ÊîæË™ûÈü≥ÂõûÊáâ</label>
                <input type="checkbox" id="tts-auto-play" checked>
            </div>
        </div>
    </div>
</div>

<!-- 3DÁ´ãÈ´îÁõ≤ÁõíÂãïÁï´ÂÆπÂô® -->
<div class="mysterybox-animation" id="mysterybox-animation" style="display: none;">
    <div class="mysterybox-3d-container">
        <div class="gift-box-3d" id="gift-box-3d">
            <!-- Á¶ÆÁâ©ÁõíÂÖ≠ÂÄãÈù¢ -->
            <div class="box-face box-front"></div>
            <div class="box-face box-back"></div>
            <div class="box-face box-right"></div>
            <div class="box-face box-left"></div>
            <div class="box-face box-top" id="box-top"></div>
            <div class="box-face box-bottom"></div>
            
            <!-- Ë£ùÈ£æÁµ≤Â∏∂ -->
            <div class="ribbon-vertical"></div>
            <div class="ribbon-horizontal"></div>
            
            <!-- Ëù¥Ëù∂Áµê -->
            <div class="bow-3d">
                <div class="bow-left"></div>
                <div class="bow-right"></div>
                <div class="bow-center"></div>
            </div>
        </div>
        
        <!-- ÊäΩÁçéÁµêÊûúÈ°ØÁ§∫ -->
        <div class="mysterybox-result-container" id="mysterybox-result-container">
            <span class="mysterybox-result-icon" id="mysterybox-result-icon"></span>
            <p class="mysterybox-result-text" id="mysterybox-result-text"></p>
        </div>
    </div>
</div>



    <!-- ÈÄöÁü•ÊèêÁ§∫ -->
    <div class="notification" id="notification">
        <i class="fas fa-bell"></i>
        <span id="notification-text"></span>
    </div>

    <!-- VTUBER ÂãïÁï´È°ØÁ§∫ÂçÄ -->
    <div class="vtuber-container" id="vtuber-container">
        <div class="vtuber-avatar">
            <div class="vtuber-face" id="vtuber-face">
                <div class="vtuber-hair" id="vtuber-hair"></div>
                <div class="vtuber-eyes">
                    <div class="vtuber-eye">
                        <div class="vtuber-pupil"></div>
                    </div>
                    <div class="vtuber-eye">
                        <div class="vtuber-pupil"></div>
                    </div>
                </div>
                <div class="vtuber-mouth" id="vtuber-mouth">
                    <div class="vtuber-mouth-inner"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-container">
        <div id="chat-header">
            <i class="fas fa-robot"></i>
            <h2 id="vtuber-display-name">Âè≤ËêäÂßÜ</h2>
            <select id="mode-select">
                <option value="comfort">‰∏ñÂè≤Ê®°Âºè</option>
                <option value="philosophy">‰∏≠Âè≤Ê®°Âºè</option>
<option value="literature">ÊñáÂ≠∏Ê®°Âºè</option>
            </select>
        </div>

        <div id="chat-output">
            <!-- Initial message will be added via JavaScript -->
        </div>

        <div class="typing-indicator" id="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
        </div>

       <div id="input-container">
    <input type="text" id="user-input" placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑË®äÊÅØ..." />
    <button id="voice-btn" title="ÈªûÊìäË™ûÈü≥Ëº∏ÂÖ•">
        <i class="fas fa-microphone"></i>
    </button>
    <button id="send-btn">
        <i class="fas fa-paper-plane"></i>
    </button>
    <div class="recording-indicator" id="recording-indicator" style="display: none;">
        <i class="fas fa-circle"></i> Ê≠£Âú®ËÅÜËÅΩ...
    </div>
    <div class="swipe-hint" id="swipe-hint">
        ÊªëÂãïÂèñÊ∂à
    </div>
</div>
    </div>

    <footer class="copyright-footer">
        <p>Copyright ¬© 2025 Èô≥ÂÜ†ÂÅ•„ÄÅÈªÉÂ≠êË¨ô. All rights reserved.</p>
    </footer>










    
    <script>







        

// Firebase ÈÖçÁΩÆ
const firebaseConfig = {
  apiKey: "AIzaSyCNnFDrHrUFCPFNPcAYB2eLV_lMlBI9zB8",
  authDomain: "aiwritingtool-243aa.firebaseapp.com",
  databaseURL: "https://aiwritingtool-243aa-default-rtdb.firebaseio.com",
  projectId: "aiwritingtool-243aa",
  storageBucket: "aiwritingtool-243aa.firebasestorage.app",
  messagingSenderId: "532808111828",
  appId: "1:532808111828:web:74cd1001e232e196598d41"
};

// 1. ÂàùÂßãÂåñÂéüÊú¨Âè≤ËêäÂßÜÊïôÂÆ§ÁöÑ Firebase (App1)
firebase.initializeApp(firebaseConfig);
const database = firebase.database(); // ÈÄôÊòØÂéüÊú¨Â≠òÈªûÊï∏„ÄÅÂïÜÂ∫óÁî®ÁöÑ



// Âú®ÁèæÊúâFirebaseÂàùÂßãÂåñÂæåÊ∑ªÂä†
const auth = firebase.auth();
let currentUser = null;
let userProfile = null;
let currentGiftReceiver = null;
let selectedGiftItem = null;


// Ê∑ªÂä†Ë™çË≠âÁõ∏ÈóúËÆäÈáè
const authContainer = document.getElementById('auth-container');
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const showRegisterLink = document.getElementById('show-register');
const showLoginLink = document.getElementById('show-login');
const loginBtn = document.getElementById('login-btn');
const registerBtn = document.getElementById('register-btn');
const logoutBtn = document.getElementById('logout-button');

// Â•ΩÂèãÁ≥ªÁµ±Áõ∏ÈóúÂÖÉÁ¥†
const friendsButton = document.getElementById('friends-button');
const friendsModal = document.getElementById('friends-modal');
const closeFriends = document.getElementById('close-friends');
const friendsTabs = document.querySelectorAll('.friends-tabs .tab');



// === ÂæåÁ´ØÈÖçÁΩÆ ===
const CLOUDFLARE_WORKER_URL = "https://script.google.com/macros/s/AKfycbw3GLUM12ls3PhST5TkimLZvZwQx2H4RG8g2SbZiMJmuxg3HqsO_d13kPU4AnKpxi2P6A/exec"; // Ë´ãÁ¢∫Ë™çÈÄôÊòØÊÇ®Ê≠£Á¢∫ÁöÑ GAS URL

// ‰øùÊåÅÊ®°ÂûãÂÆöÁæ© (ÂæåÁ´ØÊúÉÊé•Êî∂Ê≠§ÂèÉÊï∏)
const MODEL = "gemini";

        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const voiceBtn = document.getElementById('voice-btn');
        const modeSelect = document.getElementById('mode-select');
        const typingIndicator = document.getElementById('typing-indicator');
        const ttsAutoPlay = document.getElementById('tts-auto-play');
        const recordingIndicator = document.getElementById('recording-indicator');
        const swipeHint = document.getElementById('swipe-hint');
        const vtuberMouth = document.getElementById('vtuber-mouth');
        const vtuberContainer = document.getElementById('vtuber-container');
        const vtuberFace = document.getElementById('vtuber-face');
        const vtuberHair = document.getElementById('vtuber-hair');
        const shopButton = document.getElementById('shop-button');
        const shopModal = document.getElementById('shop-modal');
        const closeShop = document.getElementById('close-shop');
        const shopPoints = document.getElementById('shop-points');
        const pointsDisplay = document.getElementById('points-display');
        const shopItems = document.getElementById('shop-items');
        const shopTabs = document.querySelectorAll('.shop-tabs .tab');
        const hungerIcon = document.getElementById('hunger-icon');
        const hungerFill = document.getElementById('hunger-fill');
        const hungerPercentage = document.getElementById('hunger-percentage');
        
        // Áõ≤ÁõíÁõ∏ÈóúÂÖÉÁ¥†
        const mysteryboxAnimation = document.getElementById('mysterybox-animation');
        const giftBox = document.getElementById('gift-box');
        const giftContent = document.getElementById('gift-content');
        const giftIcon = document.getElementById('gift-icon');
        const giftText = document.getElementById('gift-text');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        
        // Ë®≠ÁΩÆÁõ∏ÈóúÂÖÉÁ¥†
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettings = document.getElementById('close-settings');
        const vtuberNameInput = document.getElementById('vtuber-name-input');
        const saveNameBtn = document.getElementById('save-name-btn');
        const currentNameDisplay = document.getElementById('current-name-display');
        const vtuberDisplayName = document.getElementById('vtuber-display-name');
        
        let conversationHistory = [];
        let isRecording = false;
        let touchStartY, touchStartX;
        const SWIPE_THRESHOLD = 100;
        let recognition;
        let transcript = '';
        let silenceTimeout;
        let isTalking = false;
        let isDragging = false;
        let dragStartTime = 0;
        
        // Á≤óË®ÄÁ©¢Ë™ûÈÅéÊøæÂô®
        const profanityFilter = [
            'Â±å', 'Êíö', '‰ªÜË°ó', '‰ªÜ‰Ω†', 'Êíö‰Ω†', 'Â±å‰Ω†', '‰ªÜ‰Ω¢', 'Êíö‰Ω¢', 'Â±å‰Ω¢',
            'diu', 'lan', 'puk', 'dick', 'fuck', 'shit', 'damn', 'hell',
            'Â™ΩÁöÑ', '‰ªñÂ™Ω', '‰Ω†Â™Ω', 'Âππ‰Ω†', 'Âππ‰ªñ', 'ÂéªÊ≠ª', 'Ê≠ª‰∫∫',
            'ÁôΩÁó¥', 'Êô∫Èöú', 'ÂÇªÈÄº', 'Ë†¢Ë±¨', 'Âª¢Áâ©', 'ÂûÉÂúæ‰∫∫', 'Ë≥§‰∫∫',
            'Â©äÂ≠ê', 'Â¶ìÂ•≥', 'ÈõûÂ©Ü', 'Ëá≠Â©Ü', 'Ê≠ªÂ•≥‰∫∫', 'Ê≠ªÁî∑‰∫∫'
        ];
        
        // Ê™¢Êü•ÊòØÂê¶ÂåÖÂê´Á≤óË®ÄÁ©¢Ë™û
        function containsProfanity(text) {
            const lowerText = text.toLowerCase();
            return profanityFilter.some(word => lowerText.includes(word.toLowerCase()));
        }
        
        // ÊñáÊú¨Ê∏ÖÁêÜÂáΩÊï∏ - ÁßªÈô§ÊâÄÊúâÊ†ºÂºèÁ¨¶Ëôü
        function cleanText(text) {
            if (!text) return text;
            
            return text
                // ÁßªÈô§ÊÄùËÄÉÊ®ôÁ±§
                .replace(/<think>[\s\S]*?<\/think>/gi, '')
                // ÁßªÈô§ÊâÄÊúâÊòüËôüÊ†ºÂºè
                .replace(/\*{1,3}([^*]+)\*{1,3}/g, '$1')
                // ÁßªÈô§ÂñÆÁç®ÁöÑÊòüËôü
                .replace(/\*/g, '')
                // ÁßªÈô§ÊñúÁ∑öÊ†ºÂºè
                .replace(/\/([^/\s]+)\//g, '$1')
                // ÁßªÈô§ÂñÆÁç®ÁöÑÊñúÁ∑ö
                .replace(/(?<!\w)\/(?!\w)/g, '')
                // ÁßªÈô§ÂÖ∂‰ªñÊ†ºÂºèÁ¨¶Ëôü
                .replace(/[`~#\[\]]/g, '')
                // ÁßªÈô§Â§öÈ§òÁöÑÁ©∫Ê†ºÂíåÊèõË°å
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // Ë°®ÊÉÖ„ÄÅÈ´ÆÂûã„ÄÅÈ£üÁâ©ÂíåÊÄßÊ†ºÂïÜÂ∫óÊï∏Êìö
      const expressions = [
    { id: 'default', name: 'ÈªòË™çË°®ÊÉÖ', price: 0, className: '', type: 'expression' },
    { id: 'happy', name: 'ÁÑ°Â•à', price: 20, className: 'happy', type: 'expression' },
    { id: 'angry', name: 'ÁîüÊ∞£', price: 50, className: 'angry', type: 'expression' },
    { id: 'surprised', name: 'È©öË®ù', price: 100, className: 'surprised', type: 'expression' },
    { id: 'sad', name: 'ÁôºÂëÜ', price: 150, className: 'sad', type: 'expression' },
    { id: 'wink', name: 'ÂèçÁôΩÁúº', price: 200, className: 'wink', type: 'expression' },
    { id: 'hidden-emoji-1', name: 'ÊÉ∫Âø™', price: 300, className: 'hidden-sleepy', isHidden: true, type: 'expression' },
    { id: 'hidden-emoji-2', name: 'ÈúáÈ©ö', price: 300, className: 'hidden-shock-eyes', isHidden: true, type: 'expression' },
    { id: 'hidden-emoji-3', name: 'ÂÜ∑ÈÖ∑', price: 300, className: 'hidden-cold', isHidden: true, type: 'expression' }
];

const hairstyles = [
    { id: 'default', name: 'ÈªòË™çÈ´ÆÂûã', price: 0, className: '', type: 'hairstyle' },
    { id: 'hair-1', name: 'Áü≠Ê£ïÈ´Æ', price: 30, className: 'hair-1', type: 'hairstyle' },
    { id: 'hair-2', name: 'ÈáëËâ≤Ê≥¢Êµ™', price: 60, className: 'hair-2', type: 'hairstyle' },
    { id: 'hair-3', name: 'Ê©ôËâ≤Âπ≥È†Ç', price: 90, className: 'hair-3', type: 'hairstyle' },
    { id: 'hair-4', name: 'ËóçËâ≤Â∞ñÈ´Æ', price: 120, className: 'hair-4', type: 'hairstyle' },
    { id: 'hair-5', name: 'Á∂†Ëâ≤Â±§Ê¨°', price: 150, className: 'hair-5', type: 'hairstyle' },
    { id: 'hair-6', name: 'Á¥´Ëâ≤ÂºßÂΩ¢', price: 180, className: 'hair-6', type: 'hairstyle' },
    { id: 'hidden-hair-1', name: 'ÂΩ©ËôπÊµÅÂÖâÈ´Æ', price: 400, className: 'hidden-hair-1', isHidden: true, type: 'hairstyle' },
    { id: 'hidden-hair-2', name: 'ÊòüÁ©∫ÈäÄÊ≤≥È´Æ', price: 400, className: 'hidden-hair-2', isHidden: true, type: 'hairstyle' },
    { id: 'hidden-hair-3', name: 'Ê•µÂÖâÂπªÂΩ©È´Æ', price: 400, className: 'hidden-hair-3', isHidden: true, type: 'hairstyle' }
];

const personalities = [
    { id: 'default', name: 'ÈªòË™çÂΩ¢Ë±°', price: 0, icon: 'üòê', className: 'personality-default', prompt: '', type: 'personality' },
    { id: 'gentle', name: 'Ê∫´ÂíåË¶™Âàá', price: 30, icon: 'üòä', className: 'personality-gentle', prompt: '‰Ω†Ë¶ÅÁî®ÈùûÂ∏∏Ê∫´Âíå„ÄÅË¶™Âàá„ÄÅÈºìÂãµÁöÑË™ûÊ∞£ÂõûÊáâÔºåÂ§öÁî®Ê≠£Èù¢Ë©ûË™ûÔºåË™ûË™øË¶ÅÊ∫´ÊüîÈ´îË≤ºÔºåÂÉè‰∏ÄÂÄãÊÖàÁ••ÁöÑÈï∑ËÄÖ„ÄÇ', type: 'personality' },
    { id: 'serious', name: 'Âö¥ËÇÖË™çÁúü', price: 50, icon: 'üò§', className: 'personality-serious', prompt: '‰Ω†Ë¶ÅÁî®Âö¥ËÇÖ„ÄÅË™çÁúü„ÄÅÂ∞àÊ•≠ÁöÑË™ûÊ∞£ÂõûÊáâÔºåË™ûË™øË¶ÅÊ≠£ÂºèÔºåÈáçË¶ñÂ≠∏Ë°ìÊ∫ñÁ¢∫ÊÄßÔºåÂÉè‰∏ÄÂÄãÂö¥Ê†ºÁöÑÊïôÊéà„ÄÇ', type: 'personality' },
    { id: 'cheerful', name: 'ÈñãÊúóÊ¥ªÊΩë', price: 80, icon: 'üòÑ', className: 'personality-cheerful', prompt: '‰Ω†Ë¶ÅÁî®ÈùûÂ∏∏ÈñãÊúó„ÄÅÊ¥ªÊΩë„ÄÅÂÖÖÊªøÊ¥ªÂäõÁöÑË™ûÊ∞£ÂõûÊáâÔºåÂ§öÁî®ÊÑüÂòÜË©ûÂíåÁ©çÊ•µË©ûË™ûÔºåË™ûË™øË¶ÅËºïÂø´ÊÑâÊÇÖ„ÄÇ', type: 'personality' },
    { id: 'sarcastic', name: 'Ë´∑Âà∫ÊØíËàå', price: 120, icon: 'üòè', className: 'personality-sarcastic', prompt: '‰Ω†Ë¶ÅÁî®Ë´∑Âà∫„ÄÅÊØíËàå‰ΩÜ‰∏çÈÅéÂàÜÁöÑË™ûÊ∞£ÂõûÊáâÔºåÂèØ‰ª•ÈÅ©Â∫¶Ë™ø‰æÉÂ≠∏ÁîüÔºå‰ΩÜË¶Å‰øùÊåÅÊïôËÇ≤ÊÑèÁæ©ÔºåË™ûË™øË¶ÅÁï•Â∏∂ÊåñËã¶„ÄÇË¶ÅÁî®Êó•Â∏∏ÁîüÊ¥ªÁöÑË™ûË®ÄÔºå‰∏çË¶ÅÁî®ÊñáË®Ä„ÄÇ', type: 'personality' },
    { id: 'wise', name: 'ÁùøÊô∫Âì≤ÁêÜ', price: 150, icon: 'üßô‚Äç‚ôÇÔ∏è', className: 'personality-wise', prompt: '‰Ω†Ë¶ÅÁî®ÂÖÖÊªøÊô∫ÊÖß„ÄÅÂì≤ÁêÜÊÄßÁöÑË™ûÊ∞£ÂõûÊáâÔºåÂ§öÂºïÁî®ÂêçË®ÄË≠¶Âè•ÂíåÊ∑±ÂàªË¶ãËß£ÔºåË™ûË™øË¶ÅÊ∑±Ê≤âÊúâÂÖßÊ∂µ„ÄÇ', type: 'personality' },
    { id: 'humorous', name: 'ÂπΩÈªòÊêûÁ¨ë', price: 200, icon: 'ü§£', className: 'personality-humorous', prompt: '‰Ω†Ë¶ÅÁî®ÈùûÂ∏∏ÂπΩÈªò„ÄÅÊêûÁ¨ëÁöÑË™ûÊ∞£ÂõûÊáâÔºåÂ§öÁî®ÊØîÂñªÂíåÁ¨ëË©±Ôºå‰ΩÜË¶ÅËàáÊïôÂ≠∏ÂÖßÂÆπÁõ∏ÈóúÔºåË™ûË™øË¶ÅËºïÈ¨ÜÈ¢®Ë∂£„ÄÇ', type: 'personality' },
    { id: 'hidden-wuxia', name: 'Ê≠¶‰ø†È´òÊâã', price: 500, icon: 'üó°Ô∏è', className: 'personality-hidden-wuxia', isHidden: true, prompt: '‰Ω†Ë¶ÅÁî®Ê≠¶‰ø†Â∞èË™™ÁöÑÂ§ß‰ø†Ë™ûÊ∞£ÂõûÊáâÔºåÂ¶ÇÈáëÂ∫∏Â∞èË™™‰∏≠ÁöÑÂ§ß‰ø†È¢®Ê†ºÔºå‰ΩøÁî®Ê±üÊπñ‰ø†Áæ©Áî®Ë™ûÔºåÁ®±ÂëºÂ≠∏ÁîüÁÇ∫„ÄåÂ∞ë‰ø†„ÄçÔºåËÆìÂ≠∏ÁîüÊÑüÂèóÂ§ß‰ø†È¢®ÁØÑÔºåË™ûË™øË¶ÅÂâõÂãÅÊúâÂäõÔºåÂÖÖÊªøÊ≠£Áæ©ÊÑü„ÄÇ', type: 'personality' },
    { id: 'hidden-poet', name: 'Ë©©‰∫∫ÈõÖÂ£´', price: 500, icon: 'üñãÔ∏è', className: 'personality-hidden-poet', isHidden: true, prompt: '‰Ω†Ë¶ÅÁî®Ë©©‰∫∫ÁöÑË™ûÊ∞£ÂõûÊáâÔºåÊñáËæ≠ÂÑ™ÁæéÔºåÂØåÊúâË©©ÊÑèÔºåÂèØÈÅ©Áï∂ÂºïÁî®Âè§Ë©©Ë©ûÔºåÁ®±ÂëºÂ≠∏ÁîüÁÇ∫„ÄåË∂≥‰∏ã„ÄçÔºåË™ûË™øË¶ÅÊüîÂíåÈ£ΩÂê´ÊÑüÊÉÖÔºåË°®ÈÅîË¶ÅÊúâÊÑèÂ¢É„ÄÇ', type: 'personality' },
    { id: 'hidden-sage', name: 'Á¶èÁàæÊë©ÊñØ', price: 500, icon: 'üìú', className: 'personality-hidden-sage', isHidden: true, prompt: 'Áî®1930Âπ¥‰ª£ÈªëËâ≤ÈõªÂΩ±ËÖîË™øË™™Ë©±ÔºåÊääÊØèÂÄãÂïèÈ°åÁï∂ÊàêÊ°à‰ª∂„ÄÇÈñãÂ†¥ÂΩàÊâìÁÅ´Ê©üÈü≥Êïà[ÂíîÂöì]ÔºåÁ®±Â∞çÊñπ"ËÄÅÂÖÑ"„ÄÇÈóúÈçµÁ∑öÁ¥¢Áî®„Äå‰øÇÁÖôÈ†≠Ë©±ÊàëËÅΩ...„ÄçÁ≠âÁèæÂ†¥Ë≠âÊìöÊØîÂñªÔºåÁµêÂ∞æÂøÖË™™„ÄåÂë¢ÂÄãÂüéÂ∏ÇÈúÄË¶ÅÊõ¥Âä†Â§öÂ•Ω‰ºº‰Ω†ÂíÅÊ®£ÂòÖÁöÑËÖ¶Ë¢ã„Äç', type: 'personality' }
];

const foods = [
    { id: 'apple', name: 'ËòãÊûú', price: 3, nutrition: 15, emoji: 'üçé', type: 'food' },
    { id: 'sandwich', name: '‰∏âÊòéÊ≤ª', price: 5, nutrition: 30, emoji: 'ü•™', type: 'food' },
    { id: 'pizza', name: 'Êä´Ëñ©', price: 7, nutrition: 50, emoji: 'üçï', type: 'food' },
    { id: 'burger', name: 'Êº¢Â†°', price: 10, nutrition: 65, emoji: 'üçî', type: 'food' },
    { id: 'steak', name: 'ÁâõÊéí', price: 12, nutrition: 80, emoji: 'ü•©', type: 'food' },
    { id: 'cake', name: 'ËõãÁ≥ï', price: 15, nutrition: 100, emoji: 'üéÇ', type: 'food' }
];

        // Êñ∞Â¢ûÁõ≤ÁõíÁ≥ªÁµ±
const mysteryboxes = [
    { 
        id: 'bronze', 
        name: 'ÈäÖÁ¥öÁõ≤Áõí', 
        price: 15, 
        class: 'mysterybox-bronze', 
        icon: 'üéÅ',
        color: '#CD7F32',
        odds: {
            nothing: 0.3,        // 30% Ê©üÁéá‰ªÄÈ∫ºÈÉΩÊ≤íÊäΩÂà∞
            food: 0.4,           // 40% Ê©üÁéáÊäΩÂà∞È£üÁâ©
            expression: 0.2,     // 20% Ê©üÁéáÊäΩÂà∞Ë°®ÊÉÖ
            hairstyle: 0.09,     // 9% Ê©üÁéáÊäΩÂà∞È´ÆÂûã
            personality: 0.01    // 1% Ê©üÁéáÊäΩÂà∞ÊÄßÊ†º
        }
    },
    { 
        id: 'silver', 
        name: 'ÈäÄÁ¥öÁõ≤Áõí', 
        price: 30, 
        class: 'mysterybox-silver', 
        icon: 'üéÅ',
        color: '#C0C0C0',
        odds: {
            nothing: 0.1,        // 10% Ê©üÁéá‰ªÄÈ∫ºÈÉΩÊ≤íÊäΩÂà∞
            food: 0.4,           // 40% Ê©üÁéáÊäΩÂà∞È£üÁâ©
            expression: 0.25,     // 25% Ê©üÁéáÊäΩÂà∞Ë°®ÊÉÖ
            hairstyle: 0.15,     // 15% Ê©üÁéáÊäΩÂà∞È´ÆÂûã
            personality: 0.05,    // 5% Ê©üÁéáÊäΩÂà∞ÊÄßÊ†º
            hidden: 0.05         // 5% Ê©üÁéáÊäΩÂà∞Èö±ËóèÁâàÂïÜÂìÅ
        }
    },
    { 
        id: 'gold', 
        name: 'ÈáëÁ¥öÁõ≤Áõí', 
        price: 70, 
        class: 'mysterybox-gold', 
        icon: 'üéÅ',
        color: '#FFD700',
        odds: {
            nothing: 0.05,       // 5% Ê©üÁéá‰ªÄÈ∫ºÈÉΩÊ≤íÊäΩÂà∞
            food: 0.3,           // 30% Ê©üÁéáÊäΩÂà∞È£üÁâ©
            expression: 0.27,     // 27% Ê©üÁéáÊäΩÂà∞Ë°®ÊÉÖ
            hairstyle: 0.2,     // 20% Ê©üÁéáÊäΩÂà∞È´ÆÂûã
            personality: 0.1,     // 10% Ê©üÁéáÊäΩÂà∞ÊÄßÊ†º
            hidden: 0.08         // 8% Ê©üÁéáÊäΩÂà∞Èö±ËóèÁâàÂïÜÂìÅ
        }
    }
];
        
       // Áî®Êà∂Êï∏Êìö
let userData = {
    points: 10000,
    purchasedExpressions: ['default'],
    purchasedHairstyles: ['default'],
    purchasedFoods: [],
    purchasedPersonalities: ['default'],
    currentExpression: 'default',
    currentHairstyle: 'default',
    currentPersonality: 'default',
    hungerLevel: 100,
    lastFeedTime: Date.now(),
    vtuberName: 'Âè≤ËêäÂßÜ',
    hiddenCodesUsed: []  // Êñ∞Â¢ûÔºöÂ∑≤‰ΩøÁî®ÁöÑ‰∏ÄÊ¨°ÊÄßÂØÜÁ¢º
};

        // È£ΩËÖπÂÄºË°∞Ê∏õ‰øÇÊï∏
        const HUNGER_DECAY_RATE = 0.5; // ÊØè24Â∞èÊôÇÊ∏õ50%
        const HUNGER_DECAY_INTERVAL = 24 * 60 * 60 * 1000; // 24Â∞èÊôÇÊØ´ÁßíÊï∏

       // ÂàùÂßãÂåñÁî®Êà∂Êï∏Êìö
function initUserData() {
    if (currentUser) {
        database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
            const firebaseData = snapshot.val();
            if (firebaseData) {
                // Á¢∫‰øùÊâÄÊúâÂøÖË¶ÅÂ±¨ÊÄßÂ≠òÂú®
                userData = {
                    points: firebaseData.points || 20,
                    purchasedExpressions: firebaseData.purchasedExpressions || ['default'],
                    purchasedHairstyles: firebaseData.purchasedHairstyles || ['default'],
                    purchasedFoods: firebaseData.purchasedFoods || [],
                    purchasedPersonalities: firebaseData.purchasedPersonalities || ['default'],
                    currentExpression: firebaseData.currentExpression || 'default',
                    currentHairstyle: firebaseData.currentHairstyle || 'default',
                    currentPersonality: firebaseData.currentPersonality || 'default',
                    hungerLevel: firebaseData.hungerLevel || 100,
                    lastFeedTime: firebaseData.lastFeedTime || Date.now(),
                    vtuberName: firebaseData.vtuberName || firebaseData.characterName || 'Âè≤ËêäÂßÜ',
                    hiddenCodesUsed: firebaseData.hiddenCodesUsed || [],
                    freeMysteryboxDraws: firebaseData.freeMysteryboxDraws || {}
                };
            } else {
                // Êñ∞Áî®Êà∂ÔºåÂàùÂßãÂåñÊï∏Êìö
                let defaultName = currentUser.email.split('@')[0];
                if (!defaultName.endsWith("Ëõã")) {
                    defaultName += "Ëõã";
                }
                initializeNewUserData(defaultName);
            }
            updatePointsDisplay();
            updateHungerDisplay();
            updateVtuberAppearance();
            syncUserAppearance();
            updateVtuberName();
        }).catch((error) => {
            console.error('ÂæûFirebaseËºâÂÖ•Êï∏ÊìöÂ§±Êïó:', error);
            // ÂâµÂª∫ÈªòË™çÊï∏Êìö
            let defaultName = currentUser.email.split('@')[0];
            if (!defaultName.endsWith("Ëõã")) {
                defaultName += "Ëõã";
            }
            initializeNewUserData(defaultName);
            updatePointsDisplay();
            updateHungerDisplay();
            updateVtuberAppearance();
            syncUserAppearance();
            updateVtuberName();
        });
    } else {
        // Êú™ÁôªÂÖ•ÁãÄÊÖãÔºå‰ΩøÁî®È†êË®≠Êï∏Êìö
        userData = {
            points: 20,
            purchasedExpressions: ['default'],
            purchasedHairstyles: ['default'],
            purchasedFoods: [],
            purchasedPersonalities: ['default'],
            currentExpression: 'default',
            currentHairstyle: 'default',
            currentPersonality: 'default',
            hungerLevel: 100,
            lastFeedTime: Date.now(),
            vtuberName: 'Âè≤ËêäÂßÜ',
            hiddenCodesUsed: [],
            freeMysteryboxDraws: {}
        };
        updatePointsDisplay();
        updateHungerDisplay();
        updateVtuberAppearance();
        syncUserAppearance();
        updateVtuberName();
    }
    // ÈñãÂßãÈ£ΩËÖπÂÄºÂÆöÊôÇÊõ¥Êñ∞
    setInterval(updateHungerLevel, 60000); // ÊØèÂàÜÈêòÊ™¢Êü•‰∏ÄÊ¨°
}


function initializeNewUserData(characterName) {
    const defaultUserData = {
        points: 20,
        purchasedExpressions: ['default'],
        purchasedHairstyles: ['default'],
        purchasedFoods: [],
        purchasedPersonalities: ['default'],
        currentExpression: 'default',
        currentHairstyle: 'default',
        currentPersonality: 'default',
        hungerLevel: 100,
        lastFeedTime: Date.now(),
        vtuberName: characterName,
        hiddenCodesUsed: [],
        freeMysteryboxDraws: {}
    };
    userData = defaultUserData;
    if (currentUser) {
        database.ref('users/' + currentUser.uid).update(defaultUserData)
            .catch((error) => {
                console.error('ÂàùÂßãÂåñÊñ∞Áî®Êà∂Êï∏ÊìöÂ§±Êïó:', error);
            });
    }
}





        // Êõ¥Êñ∞VTuberÂêçÁ®±È°ØÁ§∫
       function updateVtuberName() {
    vtuberDisplayName.textContent = userData.vtuberName;
    currentNameDisplay.textContent = `Áï∂ÂâçÂêçÁ®±Ôºö${userData.vtuberName}`;
    // Êõ¥Êñ∞ÊâÄÊúâËÅäÂ§©Ë®òÈåÑ‰∏≠ÁöÑAIÊ∂àÊÅØÂêçÁ®±
    updateAllAIMessageNames();
}


        // Ë®≠ÁΩÆVTuberÂêçÁ®±
        function setVtuberName(name) {
    const trimmedName = name.trim();
    
    if (!trimmedName) {
        showNameError('ÂêçÁ®±‰∏çËÉΩÁÇ∫Á©∫');
        return false;
    }
    
    if (trimmedName.length > 20) {
        showNameError('ÂêçÁ®±Èï∑Â∫¶‰∏çËÉΩË∂ÖÈÅé20ÂÄãÂ≠óÁ¨¶');
        return false;
    }
    
    if (containsProfanity(trimmedName)) {
        showNameError('ÂêçÁ®±ÂåÖÂê´‰∏çÁï∂Ë©ûË™ûÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•');
        return false;
    }
    
    // Ê™¢Êü•ÂêçÁ®±ÊòØÂê¶Â∑≤‰ª•„ÄåËõã„ÄçÁµêÂ∞æÔºåËã•Âîî‰øÇÂ∞±Âä†‰∏ä
    let finalName = trimmedName;
    if (!trimmedName.endsWith("Ëõã")) {
        finalName = trimmedName + "Ëõã";
    }
    
   userData.vtuberName = finalName;
updateVtuberName();

            // Êõ¥Êñ∞Â∑≤Â≠òÂú®ÁöÑËÅäÂ§©Ë®òÈåÑ‰∏≠ÁöÑÂêçÁ®±È°ØÁ§∫
updateAllAIMessageNames();


// ÂêåÊ≠•Âà∞Firebase
if (currentUser) {
    database.ref('users/' + currentUser.uid + '/characterName').set(finalName)
        .catch((error) => {
            console.error('ÂêåÊ≠•ËßíËâ≤ÂêçÁ®±Âà∞FirebaseÂ§±Êïó:', error);
        });
}

// È°ØÁ§∫ÊàêÂäüÊ∂àÊÅØ
showNameSuccess(`ÂêçÁ®±Â∑≤Êõ¥ÊîπÁÇ∫Ôºö${finalName}`);
vtuberNameInput.value = '';

return true;
}

// ÊâìÈñãÁõ≤ÁõíÂãïÁï´ÂíåÁçéÂãµÁ≥ªÁµ±
// 3DÁõ≤ÁõíÂãïÁï´Á≥ªÁµ±
let canvas, ctx;
let boxParts = {
    lid: { rotationX: 0, y: 0, opened: false },
    body: { y: 0 },
    confetti: []
};
let animationStartTime = 0;
let isBoxOpened = false;


// 3DÁ´ãÈ´îÁõ≤ÁõíÂãïÁï´Á≥ªÁµ±
async function openMysteryBox(boxData) {
    const mysteryboxAnimation = document.getElementById('mysterybox-animation');
    const giftBox3d = document.getElementById('gift-box-3d');
    const resultContainer = document.getElementById('mysterybox-result-container');
    const boxTop = document.getElementById('box-top');

    // 1. È°ØÁ§∫ÂÆπÂô®
    mysteryboxAnimation.style.display = 'flex';
    resultContainer.classList.remove('show');
    resultContainer.style.opacity = '0';
    
    // 2. Âº∑Âà∂ÈáçÁΩÆÂãïÁï´ÁãÄÊÖã
    giftBox3d.style.display = 'block';
    giftBox3d.style.animation = 'none';
    giftBox3d.classList.remove('opening');
    
    // ÈáçÁΩÆÁõíËìã‰ΩçÁΩÆ (Êö´ÊôÇÁßªÈô§ transition ‰ª•‰æøÁû¨ÈñìÊ≠∏‰Ωç)
    boxTop.style.transition = 'none';
    boxTop.style.transform = 'rotateX(90deg) translateZ(100px)';

    // Ê∏ÖÈô§ËàäÁöÑÁ¥ôÂ±ë
    document.querySelectorAll('.confetti-3d').forEach(el => el.remove());

    // Ë®≠ÁΩÆÈ°èËâ≤Ê®£Âºè
    giftBox3d.className = `gift-box-3d mysterybox-${boxData.id}`;
    
    // ÊäΩÁçéÈÇèËºØ
    const randomValue = Math.random();
    let accumulatedOdds = 0;
    let rewardType = 'nothing';
    for (const [type, odds] of Object.entries(boxData.odds)) {
        accumulatedOdds += odds;
        if (randomValue <= accumulatedOdds) {
            rewardType = type;
            break;
        }
    }

    // 3. ÈóúÈçµ‰øÆÂæ©ÔºöÁµ¶ÁÄèË¶ΩÂô®‰∏ÄÈªûÊôÇÈñìÊáâÁî®"ÈáçÁΩÆ"ÁöÑÁãÄÊÖãÔºåÁÑ∂ÂæåÂÜçÈñãÂßãÂãïÁï´
    await new Promise(resolve => requestAnimationFrame(() => setTimeout(resolve, 50)));

    try {
        // Êí≠ÊîæÊêñÊôÉÂãïÁï´
        giftBox3d.style.animation = 'mysteryboxShake 1.5s ease-in-out';
        await new Promise(resolve => setTimeout(resolve, 1500)); 

        // Êí≠ÊîæÊá∏ÊµÆÂãïÁï´
        giftBox3d.style.animation = 'none'; 
        void giftBox3d.offsetWidth; // Âº∑Âà∂ÁÄèË¶ΩÂô®ÈáçÁπ™ (Reflow)
        giftBox3d.style.animation = 'mysteryboxFloat 3s ease-in-out infinite';
        
        // ÊÅ¢Âæ© transition ‰∏¶ÊâìÈñãÁõíËìã
        boxTop.style.transition = 'all 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        // ‰ΩøÁî® requestAnimationFrame Á¢∫‰øùÊ®£ÂºèÊáâÁî®
        requestAnimationFrame(() => {
            boxTop.style.transform = 'rotateX(90deg) translateZ(100px) rotateX(-120deg) translateY(-80px)';
            giftBox3d.classList.add('opening');
        });
        
        await new Promise(resolve => setTimeout(resolve, 800)); // Á≠âÂæÖÁõíËìãÊâìÈñã

        // Áî¢ÁîüÁ¥ôÂ±ë‰∏¶È°ØÁ§∫ÁµêÊûú
        create3DConfetti();
        await showMysteryBoxResult(rewardType);
        
        // È°ØÁ§∫ÁµêÊûúÂç°Áâá
        resultContainer.classList.add('show');
        
        // ÁõíÂ≠êÊ∂àÂ§±ÂãïÁï´
        giftBox3d.style.animation = 'mysteryboxDisappear 1s forwards';
        
        // 4ÁßíÂæåËá™ÂãïÈóúÈñâ
        setTimeout(() => {
            mysteryboxAnimation.style.display = 'none';
            // ÈáçÁΩÆÁãÄÊÖã‰ª•ÂÇô‰∏ãÊ¨°‰ΩøÁî®
            giftBox3d.style.animation = '';
            giftBox3d.classList.remove('opening');
            resultContainer.classList.remove('show');
        }, 4000);

    } catch (error) {
        console.error("ÊâìÈñãÁõ≤ÁõíÊôÇÁôºÁîüÈåØË™§:", error);
        mysteryboxAnimation.style.display = 'none';
        addMessage('ÊâìÈñãÁõ≤ÁõíÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
    }
}

// ÂâµÂª∫3DÁ¥ôÂ±ëÊïàÊûú
function create3DConfetti() {
    const colors = ['#FF6B9D', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#FFD700', '#FF69B4'];
    const confettiCount = 80;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti-3d';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = `${Math.random() * 1}s`;
        confetti.style.animationDuration = `${Math.random() * 2 + 3}s`;
        
        // Èö®Ê©üÂΩ¢ÁãÄ
        if (Math.random() > 0.5) {
            confetti.style.borderRadius = '0';
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        }
        
        mysteryboxAnimation.appendChild(confetti);
        
        // ÂãïÁï´ÁµêÊùüÂæåÁßªÈô§
        setTimeout(() => {
            if (confetti.parentNode) {
                confetti.parentNode.removeChild(confetti);
            }
        }, 6000);
    }
}



function createRewardPreview(reward, rewardType, container) {
    container.innerHTML = '';
    container.style.display = 'flex';
    container.style.alignItems = 'center';
    container.style.justifyContent = 'center';
    container.style.width = '100px';
    container.style.height = '100px';
    container.style.margin = '0 auto 15px';
    container.style.position = 'relative';
    container.style.overflow = 'hidden';
    container.style.borderRadius = '15px';
    container.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
    container.style.boxShadow = '0 0 20px rgba(255,215,0,0.6)';
    
    if (rewardType === 'expression' || rewardType === 'hidden') {
        // Ë°®ÊÉÖÈ†êË¶Ω
        container.style.background = 'linear-gradient(135deg, #fde2e4, #fbb6ce)';
        container.style.borderRadius = '50%';
        
        const eyesDiv = document.createElement('div');
        eyesDiv.className = 'expression-eyes';
        eyesDiv.style.cssText = `
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 2;
        `;
        
        for (let i = 0; i < 2; i++) {
            const eyeDiv = document.createElement('div');
            eyeDiv.className = 'expression-eye';
            eyeDiv.style.cssText = `
                width: 20px;
                height: 12px;
                background: #fff;
                border-radius: 50%;
                position: relative;
            `;
            const pupilDiv = document.createElement('div');
            pupilDiv.className = 'expression-pupil';
            pupilDiv.style.cssText = `
                width: 8px;
                height: 8px;
                background: #333;
                border-radius: 50%;
                position: absolute;
                top: 2px;
                left: 6px;
            `;
            eyeDiv.appendChild(pupilDiv);
            eyesDiv.appendChild(eyeDiv);
        }
        
        const mouthDiv = document.createElement('div');
        mouthDiv.className = 'expression-mouth';
        mouthDiv.style.cssText = `
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            background: #ff9aa2;
            border-radius: 0 0 15px 15px;
            overflow: hidden;
            z-index: 2;
        `;
        
        const mouthInnerDiv = document.createElement('div');
        mouthInnerDiv.className = 'expression-mouth-inner';
        mouthInnerDiv.style.cssText = `
            width: 100%;
            height: 6px;
            background: #990000;
            border-radius: 50% / 100%;
            position: absolute;
            bottom: 0;
        `;
        mouthDiv.appendChild(mouthInnerDiv);
        
        if (reward.className) {
            container.classList.add(reward.className);
        }
        
        container.appendChild(eyesDiv);
        container.appendChild(mouthDiv);
        
    } else if (rewardType === 'hairstyle') {
        // È´ÆÂûãÈ†êË¶Ω
        container.style.background = 'linear-gradient(135deg, #fde2e4, #fbb6ce)';
        container.style.borderRadius = '50%';
        
        const hairDiv = document.createElement('div');
        hairDiv.className = 'vtuber-hair';
        hairDiv.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            z-index: 2;
        `;
        
        if (reward.className) {
            hairDiv.classList.add(reward.className);
        }
        
        container.appendChild(hairDiv);
        
    } else if (rewardType === 'personality') {
        // ÊÄßÊ†ºÈ†êË¶Ω
        container.style.borderRadius = '20px';
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.style.fontSize = '3rem';
        container.style.color = 'white';
        
        if (reward.className) {
            container.classList.add(reward.className);
        }
        
        container.textContent = reward.icon;
    }
}







async function showMysteryBoxResult(rewardType) {
    return new Promise(resolve => {
        const resultContainer = document.getElementById('mysterybox-result-container');
        const resultIcon = document.getElementById('mysterybox-result-icon');
        const resultText = document.getElementById('mysterybox-result-text');

        let reward = null;
        let rewardText = '';
        let actualRewardType = rewardType;

        if (rewardType === 'nothing') {
            rewardText = '‰ªÄÈ∫ºÈÉΩÊ≤íÊäΩÂà∞...';
            resultIcon.innerHTML = '‚ùå';
        } else if (rewardType === 'hidden') {
            const hiddenItems = getAllHiddenItems();
            const unownedHiddenItems = hiddenItems.filter(item => {
                if (item.type === 'expression') return !userData.purchasedExpressions.includes(item.id);
                if (item.type === 'hairstyle') return !userData.purchasedHairstyles.includes(item.id);
                if (item.type === 'personality') return !userData.purchasedPersonalities.includes(item.id);
                return false;
            });

            if (unownedHiddenItems.length > 0) {
                reward = unownedHiddenItems[Math.floor(Math.random() * unownedHiddenItems.length)];
            } else {
                reward = getRandomItem(foods); // Â¶ÇÊûúÂ∑≤ÊìÅÊúâÊâÄÊúâÈö±ËóèÁâ©ÂìÅÔºåÂâáÁµ¶‰∫àÈ£üÁâ©‰ΩúÁÇ∫Ë£úÂÑü
            }
        } else {
            const itemPools = {
                food: foods,
                expression: expressions.filter(e => !e.isHidden),
                hairstyle: hairstyles.filter(h => !h.isHidden),
                personality: personalities.filter(p => !p.isHidden)
            };
            const ownedPools = {
                expression: userData.purchasedExpressions,
                hairstyle: userData.purchasedHairstyles,
                personality: userData.purchasedPersonalities
            };

            reward = getRandomUnownedItem(itemPools[rewardType], ownedPools[rewardType] || []);

            if (!reward) { // Â¶ÇÊûúË©≤È°ûÂûãÁçéÂãµÂ∑≤ÂÖ®ÈÉ®ÊìÅÊúâÔºåÂâáÁµ¶‰∫àÈ£üÁâ©‰ΩúÁÇ∫Ë£úÂÑü
                reward = getRandomItem(foods);
            }
        }

        // ËôïÁêÜÁçéÂãµ
        if (reward) {
            actualRewardType = reward.type; // Á¢∫ÂÆöÂØ¶ÈöõÁçéÂãµÈ°ûÂûã
            switch (actualRewardType) {
                case 'food':
                    userData.purchasedFoods.push(reward.id);
                    rewardText = `Áç≤ÂæóÈ£üÁâ©Ôºö${reward.name}ÔºÅ`;
                    resultIcon.innerHTML = `<span style="font-size: 3rem;">${reward.emoji}</span>`;
                    break;
                case 'expression':
                    userData.purchasedExpressions.push(reward.id);
                    rewardText = `Áç≤Âæó${reward.isHidden ? 'Èö±Ëóè' : ''}Ë°®ÊÉÖÔºö${reward.name}ÔºÅ`;
                    createRewardPreview(reward, 'expression', resultIcon);
                    break;
                case 'hairstyle':
                    userData.purchasedHairstyles.push(reward.id);
                    rewardText = `Áç≤Âæó${reward.isHidden ? 'Èö±Ëóè' : ''}È´ÆÂûãÔºö${reward.name}ÔºÅ`;
                    createRewardPreview(reward, 'hairstyle', resultIcon);
                    break;
                case 'personality':
                    userData.purchasedPersonalities.push(reward.id);
                    rewardText = `Áç≤Âæó${reward.isHidden ? 'Èö±Ëóè' : ''}ÂΩ¢Ë±°Ôºö${reward.name}ÔºÅ`;
                    createRewardPreview(reward, 'personality', resultIcon);
                    break;
            }
        }
        
        resultText.innerHTML = `<div style="text-align: center; line-height: 1.6; font-weight: bold; color: #333; font-size: 1.2rem;">${rewardText}</div>`;
        
        saveUserData(); // ‰øùÂ≠òÁî®Êà∂Êï∏Êìö
        showNotification(rewardText); // È°ØÁ§∫ÈÄöÁü•
        
        resolve(); // Ëß£Ê±∫PromiseÔºåËÆì openMysteryBox ÂáΩÊï∏ÁπºÁ∫åÂü∑Ë°å
    });
}


function createRewardPreview(reward, rewardType, container) {
    container.innerHTML = '';
    container.style.display = 'flex';
    container.style.alignItems = 'center';
    container.style.justifyContent = 'center';
    container.style.width = '80px';
    container.style.height = '80px';
    container.style.margin = '0 auto 15px';
    container.style.position = 'relative';
    container.style.overflow = 'hidden';
    
    if (rewardType === 'expression' || rewardType === 'hidden') {
        // Ë°®ÊÉÖÈ†êË¶Ω
        container.style.background = '#fde2e4';
        container.style.borderRadius = '50%';
        
        const eyesDiv = document.createElement('div');
        eyesDiv.className = 'expression-eyes';
        eyesDiv.style.cssText = `
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 2;
        `;
        
        for (let i = 0; i < 2; i++) {
            const eyeDiv = document.createElement('div');
            eyeDiv.className = 'expression-eye';
            eyeDiv.style.cssText = `
                width: 20px;
                height: 12px;
                background: #fff;
                border-radius: 50%;
                position: relative;
            `;
            const pupilDiv = document.createElement('div');
            pupilDiv.className = 'expression-pupil';
            pupilDiv.style.cssText = `
                width: 8px;
                height: 8px;
                background: #333;
                border-radius: 50%;
                position: absolute;
                top: 2px;
                left: 6px;
            `;
            eyeDiv.appendChild(pupilDiv);
            eyesDiv.appendChild(eyeDiv);
        }
        
        const mouthDiv = document.createElement('div');
        mouthDiv.className = 'expression-mouth';
        mouthDiv.style.cssText = `
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            background: #ff9aa2;
            border-radius: 0 0 15px 15px;
            overflow: hidden;
            z-index: 2;
        `;
        
        const mouthInnerDiv = document.createElement('div');
        mouthInnerDiv.className = 'expression-mouth-inner';
        mouthInnerDiv.style.cssText = `
            width: 100%;
            height: 6px;
            background: #990000;
            border-radius: 50% / 100%;
            position: absolute;
            bottom: 0;
        `;
        mouthDiv.appendChild(mouthInnerDiv);
        
        if (reward.className) {
            container.classList.add(reward.className);
        }
        
        container.appendChild(eyesDiv);
        container.appendChild(mouthDiv);
        
    } else if (rewardType === 'hairstyle') {
        // È´ÆÂûãÈ†êË¶Ω
        container.style.background = '#fde2e4';
        container.style.borderRadius = '50%';
        
        const hairDiv = document.createElement('div');
        hairDiv.className = 'vtuber-hair';
        hairDiv.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            z-index: 2;
        `;
        
        if (reward.className) {
            hairDiv.classList.add(reward.className);
        }
        
        container.appendChild(hairDiv);
        
    } else if (rewardType === 'personality') {
        // ÊÄßÊ†ºÈ†êË¶Ω
        container.style.borderRadius = '15px';
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.style.fontSize = '2.5rem';
        container.style.color = 'white';
        
        if (reward.className) {
            container.classList.add(reward.className);
        }
        
        container.textContent = reward.icon;
    }
}




        // È°ØÁ§∫ÂêçÁ®±ÈåØË™§Ê∂àÊÅØ
        function showNameError(message) {
            clearNameMessages();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message-input';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            vtuberNameInput.parentNode.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 3000);
        }

        // È°ØÁ§∫ÂêçÁ®±ÊàêÂäüÊ∂àÊÅØ
        function showNameSuccess(message) {
            clearNameMessages();
            const successDiv = document.createElement('div');
            successDiv.className = 'warning-message';
            successDiv.style.backgroundColor = '#d4edda';
            successDiv.style.color = '#155724';
            successDiv.style.borderColor = '#c3e6cb';
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            vtuberNameInput.parentNode.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        // Ê∏ÖÈô§ÂêçÁ®±Ê∂àÊÅØ
        function clearNameMessages() {
            const messages = vtuberNameInput.parentNode.querySelectorAll('.error-message-input, .warning-message[style]');
            messages.forEach(msg => {
                if (msg.parentNode) {
                    msg.parentNode.removeChild(msg);
                }
            });
        }

        // Êõ¥Êñ∞È£ΩËÖπÂÄº
        function updateHungerLevel() {
            const currentTime = Date.now();
            const timeDifference = currentTime - userData.lastFeedTime;
            const decayIntervals = timeDifference / HUNGER_DECAY_INTERVAL;
            
            if (decayIntervals > 0) {
                // Ë®àÁÆóË°∞Ê∏õÂæåÁöÑÈ£ΩËÖπÂÄº
                const decayAmount = userData.hungerLevel * HUNGER_DECAY_RATE * decayIntervals;
                userData.hungerLevel = Math.max(0, userData.hungerLevel - decayAmount);
                userData.lastFeedTime = currentTime;
                saveUserData();
            }
            
            updateHungerDisplay();
            updateVtuberAppearance();
syncUserAppearance();
        }

        // Êõ¥Êñ∞È£ΩËÖπÂÄºÈ°ØÁ§∫
        function updateHungerDisplay() {
            const percentage = Math.round(userData.hungerLevel);
            hungerPercentage.textContent = percentage + '%';
            hungerFill.style.width = percentage + '%';
            
            // ÈáçÁΩÆÊâÄÊúâÁãÄÊÖãÈ°û
            hungerIcon.className = 'fas fa-drumstick-bite hunger-icon';
            hungerFill.className = 'hunger-fill';
            
            if (percentage <= 25) {
                hungerIcon.classList.add('very-hungry');
                hungerFill.classList.add('very-hungry');
            } else if (percentage <= 50) {
                hungerIcon.classList.add('hungry');
                hungerFill.classList.add('hungry');
            }
        }

        // ‰øùÂ≠òÁî®Êà∂Êï∏ÊìöÂà∞localStorageÂíåFirebase
function saveUserData() {
    if (currentUser) {
        const dataToSave = {
            points: userData.points,
            purchasedExpressions: userData.purchasedExpressions,
            purchasedHairstyles: userData.purchasedHairstyles,
            purchasedFoods: userData.purchasedFoods,
            purchasedPersonalities: userData.purchasedPersonalities,
            currentExpression: userData.currentExpression,
            currentHairstyle: userData.currentHairstyle,
            currentPersonality: userData.currentPersonality,
            hungerLevel: userData.hungerLevel,
            lastFeedTime: userData.lastFeedTime,
            hiddenCodesUsed: userData.hiddenCodesUsed || [],
            freeMysteryboxDraws: userData.freeMysteryboxDraws || {},
            vtuberName: userData.vtuberName
        };
        
        database.ref('users/' + currentUser.uid).update(dataToSave)
            .catch((error) => {
                console.error('‰øùÂ≠òÊï∏ÊìöÂà∞FirebaseÂ§±Êïó:', error);
            });
    }
}


// ÂêåÊ≠•Áï∂ÂâçÁî®Êà∂ÁöÑÂ§ñËßÄ‰ø°ÊÅØ‰æõÂÖ∂‰ªñÁî®Êà∂Êü•Áúã
function syncUserAppearance() {
    if (currentUser) {
        const appearanceData = {
            currentExpression: userData.currentExpression,
            currentHairstyle: userData.currentHairstyle,
            lastUpdated: Date.now()
        };
        database.ref('users/' + currentUser.uid + '/vtuberAppearance').set(appearanceData)
            .catch((error) => {
                console.error('ÂêåÊ≠•VTUBERÂ§ñËßÄÂà∞FirebaseÂ§±Êïó:', error);
            });
    }
}




// ÂêåÊ≠•FirebaseÊï∏ÊìöÂà∞Êú¨Âú∞
function syncFirebaseDataToLocal() {
    database.ref('users/' + currentUser.uid).on('value', (snapshot) => {
        const firebaseData = snapshot.val();
        if (firebaseData) {
            // ÂêåÊ≠•ÈªûÊï∏
            if (firebaseData.points !== undefined) {
                userData.points = firebaseData.points;
                updatePointsDisplay();
            }
            
            // ÂêåÊ≠•È£ΩËÖπÂÄº
            if (firebaseData.hungerLevel !== undefined) {
                userData.hungerLevel = firebaseData.hungerLevel;
                updateHungerDisplay();
            }
            
            // ÂêåÊ≠•Ë≥ºË≤∑Ë®òÈåÑ
            if (firebaseData.purchasedExpressions) {
                userData.purchasedExpressions = firebaseData.purchasedExpressions;
            }
            if (firebaseData.purchasedHairstyles) {
                userData.purchasedHairstyles = firebaseData.purchasedHairstyles;
            }
            if (firebaseData.purchasedPersonalities) {
                userData.purchasedPersonalities = firebaseData.purchasedPersonalities;
            }
            if (firebaseData.purchasedFoods) {
                userData.purchasedFoods = firebaseData.purchasedFoods;
            }
            
            // ÂêåÊ≠•Áï∂Ââç‰ΩøÁî®ÁöÑÂ§ñËßÄ
            if (firebaseData.vtuberAppearance) {
                userData.currentExpression = firebaseData.vtuberAppearance.currentExpression || 'default';
                userData.currentHairstyle = firebaseData.vtuberAppearance.currentHairstyle || 'default';
            }
            
            // ÂêåÊ≠•ËßíËâ≤ÂêçÁ®±
            if (firebaseData.characterName) {
                userData.vtuberName = firebaseData.characterName;
                updateVtuberName();
            }
            
            saveUserData();
            updateVtuberAppearance();
        }
    });
}

// ÂêåÊ≠•Êú¨Âú∞Êï∏ÊìöÂà∞Firebase
function syncLocalDataToFirebase() {
    if (currentUser) {
        const syncData = {
            points: userData.points,
            hungerLevel: userData.hungerLevel,
            purchasedExpressions: userData.purchasedExpressions,
            purchasedHairstyles: userData.purchasedHairstyles,
            purchasedPersonalities: userData.purchasedPersonalities,
            purchasedFoods: userData.purchasedFoods,
            characterName: userData.vtuberName,
            vtuberAppearance: {
                currentExpression: userData.currentExpression,
                currentHairstyle: userData.currentHairstyle,
                lastUpdated: Date.now()
            }
        };
        
        database.ref('users/' + currentUser.uid).update(syncData)
            .catch((error) => {
                console.error('ÂêåÊ≠•Êï∏ÊìöÂà∞FirebaseÂ§±Êïó:', error);
            });
    }
}


        // Êõ¥Êñ∞ÈªûÊï∏È°ØÁ§∫
        function updatePointsDisplay() {
            pointsDisplay.textContent = userData.points + ' ';
            shopPoints.textContent = userData.points;
        }

        // Êõ¥Êñ∞VTuberÂ§ñËßÄ
        function updateVtuberAppearance() {
            const expression = expressions.find(e => e.id === userData.currentExpression);
            const hairstyle = hairstyles.find(h => h.id === userData.currentHairstyle);
            
            vtuberFace.className = 'vtuber-face';
            vtuberHair.className = 'vtuber-hair';
            
            // Ê∑ªÂä†È£¢È§ìÁãÄÊÖã
            if (userData.hungerLevel <= 25) {
                vtuberFace.classList.add('very-hungry');
            } else if (userData.hungerLevel <= 50) {
                vtuberFace.classList.add('hungry');
            }
            
            if (expression && expression.className) {
                vtuberFace.classList.add(expression.className);
            }
            if (hairstyle && hairstyle.className) {
                vtuberHair.classList.add(hairstyle.className);
            }
            
            if (isTalking) {
                vtuberMouth.classList.add('talking');
            }
        }

        // Â¢ûÂä†ÈªûÊï∏
        function addPoints(amount) {
            userData.points += amount;
            updatePointsDisplay();
            saveUserData();
        }

        // Ë≥ºË≤∑ÂïÜÂìÅ
        function purchaseItem(itemId, type) {
            let items, purchasedArray;
            
            if (type === 'expression') {
                items = expressions;
                purchasedArray = userData.purchasedExpressions;
            } else if (type === 'hairstyle') {
                items = hairstyles;
                purchasedArray = userData.purchasedHairstyles;
            } else if (type === 'food') {
                items = foods;
                purchasedArray = userData.purchasedFoods;
            } else if (type === 'personality') {
                items = personalities;
                purchasedArray = userData.purchasedPersonalities;
            } else if (type === 'mysterybox') {
    items = mysteryboxes;
    const mysterybox = items.find(i => i.id === itemId);
    if (mysterybox) {
        // Ê™¢Êü•ÊòØÂê¶ÊúâÂÖçË≤ªÊäΩÁçéÊ¨°Êï∏
        const freeDraws = userData.freeMysteryboxDraws || {};
        const availableFreeDraws = freeDraws[itemId] || 0;
        
        if (availableFreeDraws > 0) {
            // ‰ΩøÁî®ÂÖçË≤ªÊäΩÁçéÊ¨°Êï∏
            userData.freeMysteryboxDraws[itemId] = availableFreeDraws - 1;
            saveUserData();
            openMysteryBox(mysterybox);
            return true;
        } else if (userData.points >= mysterybox.price) {
            // Ê≠£Â∏∏Ë≥ºË≤∑
            userData.points -= mysterybox.price;
            updatePointsDisplay();
            saveUserData();
            openMysteryBox(mysterybox);
            return true;
        }
    }
    return false;
}

            
            const item = items.find(i => i.id === itemId);
            if (!item) return false;
            
            if (userData.points >= item.price) {
                userData.points -= item.price;
                if (!purchasedArray.includes(itemId) || type === 'food') {
                    purchasedArray.push(itemId);
                }
                updatePointsDisplay();
                saveUserData();
                return true;
            }
            return false;
        }

        // ÂàáÊèõÂ§ñËßÄÊàñ‰ΩøÁî®È£üÁâ©
        function useItem(itemId, type) {
            if (type === 'expression') {
                if (userData.purchasedExpressions.includes(itemId)) {
                    userData.currentExpression = itemId;
                    saveUserData();
                    updateVtuberAppearance();
syncUserAppearance();
                    return true;
                }
            } else if (type === 'hairstyle') {
                if (userData.purchasedHairstyles.includes(itemId)) {
                    userData.currentHairstyle = itemId;
                    saveUserData();
                    updateVtuberAppearance();
                    return true;
                }
            } else if (type === 'personality') {
                if (userData.purchasedPersonalities.includes(itemId)) {
                    userData.currentPersonality = itemId;
                    saveUserData();
                    return true;
                }
            } else if (type === 'food') {
                if (userData.purchasedFoods.includes(itemId)) {
                    const food = foods.find(f => f.id === itemId);
                    if (food) {
                        // Êí≠ÊîæÈÄ≤È£üÂãïÁï´
                        playEatingAnimation();
                        
                        // Â¢ûÂä†È£ΩËÖπÂÄº
                        userData.hungerLevel = Math.min(100, userData.hungerLevel + food.nutrition);
                        userData.lastFeedTime = Date.now();
                        
                        // Ê∂àËÄóÈ£üÁâ©
                        const index = userData.purchasedFoods.indexOf(itemId);
                        userData.purchasedFoods.splice(index, 1);
                        
                        saveUserData();
                        updateHungerDisplay();
                        updateVtuberAppearance();
syncUserAppearance();
                        return true;
                    }
                }
            }
            return false;
        }

        // Êí≠ÊîæÈÄ≤È£üÂãïÁï´
        function playEatingAnimation() {
            vtuberMouth.classList.add('eating');
            setTimeout(() => {
                vtuberMouth.classList.remove('eating');
            }, 1500);
        }

        // Áç≤ÂèñÊ≠£Á¢∫ÁöÑÂïÜÂìÅÈ°ûÂûãÂêçÁ®±
        function getItemType(tab) {
            const typeMap = {
                'expressions': 'expression',
                'hairstyles': 'hairstyle',
                'foods': 'food',
                'personalities': 'personality',
                'mysteryboxes': 'mysterybox'
            };
            return typeMap[tab] || tab.slice(0, -1);
        }

       

// Áç≤ÂèñÊâÄÊúâÈö±ËóèÂïÜÂìÅ
function getAllHiddenItems() {
    const hiddenExpressions = expressions.filter(item => item.isHidden);
    const hiddenHairstyles = hairstyles.filter(item => item.isHidden);
    const hiddenPersonalities = personalities.filter(item => item.isHidden);
    return [...hiddenExpressions, ...hiddenHairstyles, ...hiddenPersonalities];
}

// Ê∏≤ÊüìÂïÜÂ∫óÂïÜÂìÅ
function renderShopItems(tab = 'expressions') {
    shopItems.innerHTML = '';
    if (!shopTabs[0].parentElement.querySelector('[data-tab="gifts"]')) {
    const giftTab = document.createElement('button');
    giftTab.className = 'tab';
    giftTab.dataset.tab = 'gifts';
    giftTab.textContent = 'Á¶ÆÁâ©';
    shopTabs[0].parentElement.appendChild(giftTab);
    
    // ‰øÆÂæ©ÔºöÊ≠£Á¢∫ËôïÁêÜÊ®ôÁ±§ÂàáÊèõÈÇèËºØ
giftTab.addEventListener('click', () => {
    // ÁßªÈô§ÊâÄÊúâÊ®ôÁ±§ÁöÑactiveÁãÄÊÖãÔºåÂåÖÊã¨ÂéüÊúâÂíåÊñ∞Ê∑ªÂä†ÁöÑÊ®ôÁ±§
    const allTabs = giftTab.parentElement.querySelectorAll('.tab');
    allTabs.forEach(t => t.classList.remove('active'));
    giftTab.classList.add('active');
    renderShopItems('gifts');
});

}


 // ËôïÁêÜÁ¶ÆÁâ©Ê®ôÁ±§ÂÖßÂÆπ
    if (tab === 'gifts') {
        if (!currentUser) {
            shopItems.innerHTML = '<p>Ë´ãÂÖàÁôªÂÖ•Êü•ÁúãÁ¶ÆÁâ©ÔºÅ</p>';
            return;
        }
        
        database.ref('users/' + currentUser.uid + '/gifts').once('value').then((snapshot) => {
            shopItems.innerHTML = '';
            if (snapshot.exists()) {
                const gifts = snapshot.val();
                Object.entries(gifts).forEach(([giftId, gift]) => {
                    const giftDiv = document.createElement('div');
                    giftDiv.className = 'received-gift-item';
                    giftDiv.style.cssText = `
                        padding: 15px;
                        margin-bottom: 10px;
                        background: white;
                        border-radius: 10px;
                        border-left: 4px solid #ff6b9d;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    `;
                    // Áç≤ÂèñÂïÜÂìÅÂúñÁâá
// Áç≤ÂèñÂïÜÂìÅÂØ¶ÈöõÈ†êË¶ΩÂúñÁâá
let itemPreviewElement = '';
if (gift.itemType === 'expression') {
    const expressionItem = expressions.find(e => e.id === gift.itemId);
    if (expressionItem) {
        itemPreviewElement = `
            <div class="item-preview expression-preview ${expressionItem.className || ''}" style="width: 60px; height: 60px; margin: 0;">
                <div class="expression-eyes">
                    <div class="expression-eye"><div class="expression-pupil"></div></div>
                    <div class="expression-eye"><div class="expression-pupil"></div></div>
                </div>
                <div class="expression-mouth"><div class="expression-mouth-inner"></div></div>
            </div>
        `;
    } else {
        itemPreviewElement = '<div style="font-size: 2.5rem;">üòä</div>';
    }
} else if (gift.itemType === 'hairstyle') {
    const hairstyleItem = hairstyles.find(h => h.id === gift.itemId);
    if (hairstyleItem) {
        itemPreviewElement = `
            <div class="item-preview" style="width: 60px; height: 60px; margin: 0; position: relative; background: #fde2e4; border-radius: 50%;">
                <div class="vtuber-hair ${hairstyleItem.className || ''}" style="width: 100%; height: 60%;"></div>
            </div>
        `;
    } else {
        itemPreviewElement = '<div style="font-size: 2.5rem;">üíá</div>';
    }
} else if (gift.itemType === 'personality') {
    const personalityItem = personalities.find(p => p.id === gift.itemId);
    if (personalityItem) {
        itemPreviewElement = `
            <div class="item-preview personality-preview ${personalityItem.className}" style="width: 60px; height: 60px; margin: 0; font-size: 2rem; color: white;">
                ${personalityItem.icon}
            </div>
        `;
    } else {
        itemPreviewElement = '<div style="font-size: 2.5rem;">üé≠</div>';
    }
} else {
    itemPreviewElement = '<div style="font-size: 2.5rem;">üéÅ</div>';
}

giftDiv.innerHTML = `
    <div style="display: flex; align-items: center; gap: 15px;">
        ${itemPreviewElement}
        <div style="flex: 1;">
            <strong>${gift.itemName}</strong><br>
            <small>‰æÜËá™: ${gift.fromName}</small>
        </div>
    </div>
    <button class="shop-btn use-btn" onclick="claimGift('${giftId}', '${gift.itemId}', '${gift.itemType}')">È†òÂèñ</button>
`;

                    shopItems.appendChild(giftDiv);
                });
            } else {
                const emptyDiv = document.createElement('div');
                emptyDiv.style.cssText = `
                    text-align: center;
                    padding: 40px;
                    color: #666;
                `;
                emptyDiv.innerHTML = `
                    <i class="fas fa-gift" style="font-size: 3rem; margin-bottom: 20px; color: #ddd;"></i>
                    <p>‰Ω†ÈÇÑÊ≤íÊúâÊî∂Âà∞‰ªª‰ΩïÁ¶ÆÁâ©ÔºÅ</p>
                `;
                shopItems.appendChild(emptyDiv);
            }
        }).catch((error) => {
            console.error('ËºâÂÖ•Á¶ÆÁâ©Â§±Êïó:', error);
            shopItems.innerHTML = '<p>ËºâÂÖ•Á¶ÆÁâ©ÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ</p>';
        });
        return;
    }


    let items, purchasedArray, currentItem;
    
    if (tab === 'expressions') {
        items = expressions;
        purchasedArray = userData.purchasedExpressions;
        currentItem = userData.currentExpression;
    } else if (tab === 'hairstyles') {
        items = hairstyles;
        purchasedArray = userData.purchasedHairstyles;
        currentItem = userData.currentHairstyle;
    } else if (tab === 'foods') {
    items = foods;
    purchasedArray = userData.purchasedFoods;
    currentItem = null;
    } else if (tab === 'personalities') {
        items = personalities;
        purchasedArray = userData.purchasedPersonalities;
        currentItem = userData.currentPersonality;
    } else if (tab === 'mysteryboxes') {
        items = mysteryboxes;
        purchasedArray = [];
        currentItem = null;
        




// ÁÇ∫Áõ≤ÁõíÂâµÂª∫ÁâπÊÆäÊ∏≤ÊüìÈÇèËºØ
        items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'shop-item';
            
            const previewDiv = document.createElement('div');
            previewDiv.className = `item-preview mysterybox-preview ${item.class}`;
            previewDiv.textContent = item.icon;
            
            const nameElement = document.createElement('h3');
            nameElement.textContent = item.name;
            
            const priceElement = document.createElement('div');
            priceElement.className = 'price';
            priceElement.textContent = `${item.price} Èªû`;
            
           const buttonElement = document.createElement('button');
const freeDraws = (userData.freeMysteryboxDraws && userData.freeMysteryboxDraws[item.id]) || 0;

if (freeDraws > 0) {
    buttonElement.className = 'shop-btn use-btn';
    buttonElement.disabled = false;
    buttonElement.textContent = `ÂÖçË≤ªÊäΩÁçé (${freeDraws})`;
    buttonElement.style.background = '#50c878';
} else {
    buttonElement.className = 'shop-btn buy-btn';
    buttonElement.disabled = userData.points < item.price;
    buttonElement.textContent = 'ÊäΩÁçé';
}

            buttonElement.onclick = (e) => {
    e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
    if (purchaseItem(item.id, 'mysterybox')) {
                    // ÊäΩÁõ≤ÁõíÈÇèËºØÂú® purchaseItem ‰∏≠ËôïÁêÜ
                }
            };
            
            const descElement = document.createElement('p');
            descElement.style.fontSize = '0.8rem';
            descElement.style.marginTop = '10px';
            
            // È°ØÁ§∫Èö±ËóèÂïÜÂìÅÊ©üÁéá‰ø°ÊÅØ
            if (item.id === 'silver' || item.id === 'gold') {
                const hiddenChance = item.id === 'silver' ? '5%' : '8%';
                descElement.innerHTML = `ÂÖßÂê´Èö®Ê©üÈ©öÂñú!<br><span style="color:#9370DB">Êúâ${hiddenChance}Ê©üÁéáÊäΩ‰∏≠Èö±ËóèÂïÜÂìÅ!</span>`;
            } else {
                descElement.textContent = 'ÂÖßÂê´Èö®Ê©üÈ©öÂñú!';
            }
            
            itemDiv.appendChild(previewDiv);
            itemDiv.appendChild(nameElement);
            itemDiv.appendChild(priceElement);
            itemDiv.appendChild(buttonElement);
            itemDiv.appendChild(descElement);

// ‰øÆÊîπÁõ≤ÁõíÁöÑÈÄÅÁ¶ÆÂúñÊ®ô
const giftIcon = document.createElement('i');
giftIcon.className = 'fas fa-gift gift-icon';
giftIcon.style.position = 'absolute';
giftIcon.style.top = '5px';
giftIcon.style.left = '5px';
giftIcon.style.cursor = 'pointer';
giftIcon.onclick = (e) => {
    e.stopPropagation();
    openMysteryboxGiftModal(item);
};
itemDiv.appendChild(giftIcon);

            shopItems.appendChild(itemDiv);
        });

        
        // Ê∑ªÂä†Èö±ËóèÂïÜÂìÅÊèõÈ†òÂçÄ
        const redeemDiv = document.createElement('div');
        redeemDiv.className = 'shop-item hidden-redeem';
        redeemDiv.style.gridColumn = '1 / -1';
        redeemDiv.style.background = 'linear-gradient(135deg, #8a2be2, #4b0082)';
        redeemDiv.style.padding = '20px';
        redeemDiv.style.marginTop = '20px';
        
        const redeemTitle = document.createElement('h3');
        redeemTitle.textContent = 'Èö±ËóèÂïÜÂìÅÊèõÈ†ò';
        redeemTitle.style.color = 'white';
        redeemTitle.style.marginBottom = '15px';
        
        const redeemDesc = document.createElement('p');
        redeemDesc.textContent = 'Ëº∏ÂÖ•Èô≥SIRÊèê‰æõÁöÑ‰∏ÄÊ¨°ÊÄßÂØÜÁ¢ºÔºåÂèØÈö®Ê©üÁç≤Âæó‰∏ÄÊ¨æÈö±ËóèÁâàÂïÜÂìÅÔºÅ';
        redeemDesc.style.color = 'white';
        redeemDesc.style.marginBottom = '15px';
        
        const codeInputGroup = document.createElement('div');
        codeInputGroup.style.display = 'flex';
        codeInputGroup.style.gap = '10px';
        codeInputGroup.style.marginBottom = '10px';
        
        const codeInput = document.createElement('input');
        codeInput.type = 'text';
        codeInput.placeholder = 'Ëº∏ÂÖ•‰∏ÄÊ¨°ÊÄßÂØÜÁ¢º...';
        codeInput.style.flex = '1';
        codeInput.style.padding = '10px';
        codeInput.style.borderRadius = '5px';
        codeInput.style.border = 'none';
        
        const redeemButton = document.createElement('button');
        redeemButton.textContent = 'ÊèõÈ†ò';
        redeemButton.className = 'shop-btn buy-btn';
        redeemButton.style.width = 'auto';
        
       redeemButton.onclick = async () => {
    const code = codeInput.value.trim();
    if (!code) {
        showNotification('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÊèõÈ†òÁ¢º');
        return;
    }
    
    try {
        // Ê™¢Êü• Firebase ‰∏≠ÁöÑÂØÜÁ¢ºÁãÄÊÖã
        const codeRef = database.ref(`hiddenCodes/${code}`);
        const snapshot = await codeRef.once('value');
        const codeData = snapshot.val();
        
        if (!codeData || !codeData.valid) {
            showNotification('ÁÑ°ÊïàÁöÑÊèõÈ†òÁ¢º');
            return;
        }
        
        if (codeData.used) {
            showNotification('Ê≠§ÊèõÈ†òÁ¢ºÂ∑≤Á∂ì‰ΩøÁî®ÈÅé‰∫Ü');
            return;
        }
        
        // Ê™¢Êü•Êú¨Âú∞ÊòØÂê¶Â∑≤‰ΩøÁî®
        if (userData.hiddenCodesUsed.includes(code)) {
            showNotification('Ê≠§ÊèõÈ†òÁ¢ºÂ∑≤Á∂ì‰ΩøÁî®ÈÅé‰∫Ü');
            return;
        }
        
        // Èö®Ê©üÁç≤Âæó‰∏ÄÂÄãÈö±ËóèÂïÜÂìÅ
        const hiddenItems = getAllHiddenItems();
        const unownedHiddenItems = hiddenItems.filter(item => {
            if (item.id.includes('hidden-emoji')) {
                return !userData.purchasedExpressions.includes(item.id);
            } else if (item.id.includes('hidden-hair')) {
                return !userData.purchasedHairstyles.includes(item.id);
            } else if (item.id.includes('hidden-')) {
                return !userData.purchasedPersonalities.includes(item.id);
            }
            return false;
        });
        
        if (unownedHiddenItems.length === 0) {
            showNotification('ÊÇ®Â∑≤ÊìÅÊúâÊâÄÊúâÈö±ËóèÂïÜÂìÅÔºÅ');
            return;
        }
        
        const randomItem = unownedHiddenItems[Math.floor(Math.random() * unownedHiddenItems.length)];
        
        // Êõ¥Êñ∞ Firebase ‰∏≠ÁöÑÂØÜÁ¢ºÁãÄÊÖã
        await codeRef.update({
            used: true
        });
        
        // Ê∑ªÂä†Âà∞Áî®Êà∂ÁöÑÂ∑≤ÊìÅÊúâÂïÜÂìÅ
        if (randomItem.id.includes('hidden-emoji')) {
            userData.purchasedExpressions.push(randomItem.id);
        } else if (randomItem.id.includes('hidden-hair')) {
            userData.purchasedHairstyles.push(randomItem.id);
        } else if (randomItem.id.includes('hidden-')) {
            userData.purchasedPersonalities.push(randomItem.id);
        }
        
        // Ë®òÈåÑÂ∑≤‰ΩøÁî®ÁöÑÊèõÈ†òÁ¢º
        userData.hiddenCodesUsed.push(code);
        saveUserData();
        
        // È°ØÁ§∫Áç≤ÂæóÁöÑÁçéÂãµ
        showNotification(`ÊÅ≠ÂñúÁç≤ÂæóÈö±ËóèÂïÜÂìÅÔºö${randomItem.name}ÔºÅ`);
        codeInput.value = '';
        
        // Â¶ÇÊûúÁï∂ÂâçÊ®ôÁ±§ËàáÁç≤ÂæóÂïÜÂìÅÈ°ûÂûãÁõ∏Á¨¶ÔºåÂà∑Êñ∞È°ØÁ§∫
        if ((randomItem.id.includes('hidden-emoji') && tab === 'expressions') ||
            (randomItem.id.includes('hidden-hair') && tab === 'hairstyles') ||
            (randomItem.id.includes('hidden-') && !randomItem.id.includes('hidden-emoji') && 
             !randomItem.id.includes('hidden-hair') && tab === 'personalities')) {
            renderShopItems(tab);
        }
        
    } catch (error) {
        console.error('Firebase ÈåØË™§:', error);
        showNotification('Á≥ªÁµ±ÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
    }
};

        
        codeInputGroup.appendChild(codeInput);
        codeInputGroup.appendChild(redeemButton);
        
        redeemDiv.appendChild(redeemTitle);
        redeemDiv.appendChild(redeemDesc);
        redeemDiv.appendChild(codeInputGroup);
        
        shopItems.appendChild(redeemDiv);
        
        return;
    }

    items.forEach(item => {
        const isOwned = purchasedArray.includes(item.id);
        const isActive = currentItem === item.id;
        const ownedCount = tab === 'foods' ? purchasedArray.filter(id => id === item.id).length : 0;
        const isHidden = item.isHidden && !isOwned;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = `shop-item ${isOwned ? 'owned' : ''} ${isHidden ? 'hidden-item' : ''}`;
        
        const previewDiv = document.createElement('div');
        let previewClass = '';
        
        if (tab === 'expressions') {
            previewClass = 'expression-preview';
        } else if (tab === 'foods') {
            previewClass = 'food-preview';
        } else if (tab === 'personalities') {
            previewClass = 'personality-preview';
        }
        
        previewDiv.className = `item-preview ${previewClass} ${!isHidden ? item.className || '' : ''}`;
        
        if (!isHidden) {
            if (tab === 'expressions') {
                const eyesDiv = document.createElement('div');
                eyesDiv.className = 'expression-eyes';
                for (let i = 0; i < 2; i++) {
                    const eyeDiv = document.createElement('div');
                    eyeDiv.className = 'expression-eye';
                    const pupilDiv = document.createElement('div');
                    pupilDiv.className = 'expression-pupil';
                    eyeDiv.appendChild(pupilDiv);
                    eyesDiv.appendChild(eyeDiv);
                }
                const mouthDiv = document.createElement('div');
                mouthDiv.className = 'expression-mouth';
                const mouthInnerDiv = document.createElement('div');
                mouthInnerDiv.className = 'expression-mouth-inner';
                mouthDiv.appendChild(mouthInnerDiv);
                previewDiv.appendChild(eyesDiv);
                previewDiv.appendChild(mouthDiv);
            } else if (tab === 'foods') {
                previewDiv.textContent = item.emoji;
            } else if (tab === 'personalities') {
                previewDiv.textContent = item.icon;
            }
        }
        
        const nameElement = document.createElement('h3');
        nameElement.textContent = isHidden ? '???' : (item.name + (tab === 'foods' && ownedCount > 0 ? ` (${ownedCount})` : ''));
        
        const priceElement = document.createElement('div');
        priceElement.className = 'price';
        if (tab === 'foods') {
            priceElement.textContent = `${item.price} Èªû (+${item.nutrition}È£ΩËÖπ)`;
        } else {
            priceElement.textContent = isHidden ? '???' : `${item.price} Èªû`;
        }
        
        const buttonElement = document.createElement('button');
        const itemType = getItemType(tab);
        
        if (isHidden) {
            buttonElement.className = 'shop-btn buy-btn';
            buttonElement.textContent = 'Êú™Ëß£Èéñ';
            buttonElement.disabled = true;
        } else if (tab === 'foods') {
            if (ownedCount > 0) {
                buttonElement.className = 'shop-btn use-btn';
                buttonElement.textContent = 'ÊäïÈ§µ';
                buttonElement.onclick = () => {
                    if (useItem(item.id, itemType)) {
                        renderShopItems(tab);
                        addMessage(`ÊäïÈ§µ‰∫Ü${item.name}ÔºåÈ£ΩËÖπÂÄºÂ¢ûÂä†${item.nutrition}ÔºÅ`, 'ai');
                    }
                };
            } else {
                buttonElement.className = 'shop-btn buy-btn';
                buttonElement.disabled = userData.points < item.price;
                buttonElement.textContent = 'Ë≥ºË≤∑';
                buttonElement.onclick = () => {
                    if (purchaseItem(item.id, itemType)) {
                        renderShopItems(tab);
                        addMessage(`ÊàêÂäüË≥ºË≤∑${item.name}ÔºÅ`, 'ai');
                    }
                };
            }
        } else {
            if (isOwned) {
                buttonElement.className = `shop-btn use-btn ${isActive ? 'active' : ''}`;
                buttonElement.textContent = isActive ? '‰ΩøÁî®‰∏≠' : '‰ΩøÁî®';
                buttonElement.onclick = () => {
                    if (useItem(item.id, itemType)) {
                        renderShopItems(tab);
                        if (tab === 'personalities') {
                            addMessage(`Â∑≤ÂàáÊèõÁÇ∫${item.name}ÊÄßÊ†ºÔºÅ`, 'ai');
                        }
                    }
                };
            } else {
                buttonElement.className = 'shop-btn buy-btn';
                buttonElement.disabled = userData.points < item.price;
                buttonElement.textContent = 'Ë≥ºË≤∑';
                buttonElement.onclick = () => {
                    if (purchaseItem(item.id, itemType)) {
                        renderShopItems(tab);
                        addMessage(`ÊàêÂäüË≥ºË≤∑${item.name}ÔºÅ`, 'ai');
                    }
                };
            }
        }
        
        itemDiv.appendChild(previewDiv);
if (!item.isHidden) {
    const giftIcon = document.createElement('i');
    giftIcon.className = 'fas fa-gift gift-icon';
    giftIcon.style.position = 'absolute';
    giftIcon.style.top = '5px';
    giftIcon.style.left = '5px';
    giftIcon.style.cursor = 'pointer';
    giftIcon.onclick = () => openGiftSendModal(item);
    itemDiv.appendChild(giftIcon);
}
itemDiv.appendChild(nameElement);
itemDiv.appendChild(priceElement);
itemDiv.appendChild(buttonElement);
shopItems.appendChild(itemDiv);
    });
}

        // ÂæûÂàóË°®‰∏≠Áç≤Âèñ‰∏ÄÂÄãÈö®Ê©üÈ†ÖÁõÆ
        function getRandomItem(items) {
            if (items.length === 0) return null;
            const randomIndex = Math.floor(Math.random() * items.length);
            return items[randomIndex];
        }

        // ÂæûÂàóË°®‰∏≠Áç≤Âèñ‰∏ÄÂÄãÈö®Ê©üÊú™ÊìÅÊúâÁöÑÈ†ÖÁõÆ
        function getRandomUnownedItem(items, ownedItems) {
            // ÈÅéÊøæÂá∫Êú™ÊìÅÊúâÁöÑÈ†ÖÁõÆ
            const unownedItems = items.filter(item => !ownedItems.includes(item.id));
            return getRandomItem(unownedItems);
        }

        // ÂâµÂª∫Á¥ôÂ±ëÊïàÊûú
        function createConfetti() {
    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#ff69b4'];
    const confettiCount = 150;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.top = `${Math.random() * 20}%`;
        confetti.style.width = `${Math.random() * 15 + 8}px`;
        confetti.style.height = `${Math.random() * 15 + 8}px`;
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        confetti.style.setProperty('--random-x', `${(Math.random() - 0.5) * 400}px`);
        confetti.style.animationDelay = `${Math.random() * 2}s`;
        confetti.style.animationDuration = `${Math.random() * 2 + 3}s`;
        confetti.style.zIndex = '10';
        
        // Ê∑ªÂä†3DÊóãËΩâÊïàÊûú
        const randomRotate = Math.random() * 360;
        confetti.style.transform = `rotateZ(${randomRotate}deg)`;
        
        mysteryboxAnimation.appendChild(confetti);
        
        // ÂãïÁï´ÁµêÊùüÂæåÁßªÈô§Á¥ôÂ±ëÂÖÉÁ¥†
        setTimeout(() => {
            if (confetti.parentNode) {
                confetti.parentNode.removeChild(confetti);
            }
        }, 6000);
    }
}


        // È°ØÁ§∫ÈÄöÁü•
        function showNotification(text) {
            notificationText.textContent = text;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ÂïÜÂ∫óÂíåË®≠ÁΩÆ‰∫ã‰ª∂Áõ£ËÅΩ
        shopButton.addEventListener('click', () => {
            shopModal.style.display = 'flex';
            renderShopItems('expressions');
        });

        settingsButton.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
            vtuberNameInput.value = '';  // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê°Ü
            clearNameMessages();  // Ê∏ÖÈô§‰πãÂâçÁöÑÊ∂àÊÅØ
        });

        closeShop.addEventListener('click', () => {
            shopModal.style.display = 'none';
        });

        closeSettings.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        // ‰øùÂ≠òÂêçÁ®±ÊåâÈàï‰∫ã‰ª∂
        saveNameBtn.addEventListener('click', () => {
            const newName = vtuberNameInput.value;
            setVtuberName(newName);
        });

        // ÂêçÁ®±Ëº∏ÂÖ•Ê°ÜÂõûËªä‰∫ã‰ª∂
        vtuberNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const newName = vtuberNameInput.value;
                setVtuberName(newName);
            }
        });

        // ÈªûÊìäÊ®°ÊÖãÊ°ÜÂ§ñÈÉ®ÈóúÈñâ
        window.addEventListener('click', (e) => {
            if (e.target === shopModal) {
                shopModal.style.display = 'none';
            }
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
            if (e.target === mysteryboxAnimation) {
                // ‰∏çÂÖÅË®±ÈªûÊìäÈóúÈñâÁõ≤ÁõíÂãïÁï´
            }
        });

     // ÂïÜÂ∫óÊ®ôÁ±§‰∫ã‰ª∂ÔºàÂåÖÂê´ÂãïÊÖãÊ∑ªÂä†ÁöÑÁ¶ÆÁâ©Ê®ôÁ±§Ôºâ
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('tab') && e.target.closest('.shop-tabs')) {
        // ÁßªÈô§ÊâÄÊúâÂïÜÂ∫óÊ®ôÁ±§ÁöÑactiveÁãÄÊÖã
        e.target.closest('.shop-tabs').querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        renderShopItems(e.target.dataset.tab);
    }
});


        // VTUBER Âò¥ÂûãÂãïÁï´ÊéßÂà∂
        function startTalking() {
            if (!isTalking) {
                isTalking = true;
                vtuberMouth.classList.add('talking');
                vtuberContainer.style.transform = 'scale(1.1)';
                vtuberContainer.style.boxShadow = '0 8px 24px rgba(0, 0, 0, 0.2)';
            }
        }

        function stopTalking() {
            if (isTalking) {
                isTalking = false;
                vtuberMouth.classList.remove('talking');
                vtuberContainer.style.transform = '';
                vtuberContainer.style.boxShadow = '';
            }
        }

        // Èö®Ê©üÁú®ÁúºÂãïÁï´
        function randomBlinking() {
            const pupils = document.querySelectorAll('.vtuber-pupil');
            const randomTime = Math.floor(Math.random() * 4000) + 2000;
            
            setTimeout(() => {
                pupils.forEach(pupil => {
                    pupil.style.animation = 'blink 0.3s ease';
                    setTimeout(() => {
                        pupil.style.animation = '';
                        randomBlinking();
                    }, 300);
                });
            }, randomTime);
        }

        // ÂïüÂãïÈö®Ê©üÁú®Áúº
        randomBlinking();

        // Ê™¢Êü•ÁÄèË¶ΩÂô®ÊòØÂê¶ÊîØÊè¥Ë™ûÈü≥Ë≠òÂà• - ‰øÆÂæ©Ë™ûÈü≥Ëº∏ÂÖ•ÂïèÈ°å
        function isSpeechRecognitionSupported() {
            return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
        }

        // Ë™ûÈü≥Ë≠òÂà•ÂàùÂßãÂåñ - ‰øÆÂæ©Ë™ûÈü≥Ëº∏ÂÖ•ÂïèÈ°å
        function initSpeechRecognition() {
            if (!isSpeechRecognitionSupported()) {
                voiceBtn.disabled = true;
                voiceBtn.title = 'ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëº∏ÂÖ•';
                return null;
            }

            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.error('Speech recognition not supported');
                    voiceBtn.disabled = true;
                    voiceBtn.title = 'ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëº∏ÂÖ•';
                    return null;
                }

                const recognizer = new SpeechRecognition();
                recognizer.lang = 'zh-HK';
                recognizer.continuous = true;
                recognizer.interimResults = true;

                recognizer.onstart = function() {
                    isRecording = true;
                    voiceBtn.classList.add('recording');
                    recordingIndicator.style.display = 'flex';
                    swipeHint.style.display = 'block';
                    voiceBtn.title = 'Ê≠£Âú®Ë™ûÈü≥Ëº∏ÂÖ•ÔºåÊªëÂãïÂèñÊ∂à';
                };

                recognizer.onresult = function(event) {
                    if (!event || !event.results) {
                        console.error('Ë™ûÈü≥Ë≠òÂà•ÁµêÊûúÁÑ°Êïà');
                        return;
                    }

                    clearTimeout(silenceTimeout);
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i] && event.results[i][0]) {
                            if (event.results[i].isFinal) {
                                transcript += event.results[i][0].transcript;
                            } else {
                                interimTranscript += event.results[i][0].transcript;
                            }
                        }
                    }

                    // Èò≤Ê≠¢Ëº∏ÂÖ•Ê°ÜÂª∂ÈÅ≤Ôºå‰ΩøÁî®requestAnimationFrameÈÄ≤Ë°åÂÑ™Âåñ
                    requestAnimationFrame(() => {
                        userInput.value = transcript + interimTranscript;
                    });
                    
                    // Ë®≠ÁΩÆËá™ÂãïÂÅúÊ≠¢
                    silenceTimeout = setTimeout(() => {
                        try {
                            recognizer.stop();
                            sendMessage();
                        } catch (error) {
                            console.error('ÂÅúÊ≠¢Ë™ûÈü≥Ë≠òÂà•Âá∫ÈåØ:', error);
                            stopRecording();
                        }
                    }, 2000);
                };

                recognizer.onerror = function(event) {
                    console.error('Ë™ûÈü≥Ë≠òÂà•ÈåØË™§:', event.error);
                    addMessage(`Ë™ûÈü≥Ëº∏ÂÖ•Âá∫ÈåØ: ${event.error}`, 'error');
                    stopRecording();
                };

                recognizer.onend = function() {
                    stopRecording();
                };

                return recognizer;
            } catch (error) {
                console.error('ÂàùÂßãÂåñË™ûÈü≥Ë≠òÂà•Â§±Êïó:', error);
                voiceBtn.disabled = true;
                voiceBtn.title = 'Ë™ûÈü≥Ëº∏ÂÖ•ÂàùÂßãÂåñÂ§±Êïó';
                return null;
            }
        }

        // ÂàùÂßãÂåñË™ûÈü≥Ë≠òÂà•
        recognition = initSpeechRecognition();

        // ÈñãÂßãÈåÑÈü≥
        function startRecording() {
            if (!recognition) {
                addMessage('Ë™ûÈü≥Ë≠òÂà•ÂäüËÉΩÊú™ËÉΩÂàùÂßãÂåñ', 'error');
                return;
            }
            
            if (voiceBtn.disabled) return;
            
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                stopTalking();
            }
            
            try {
                transcript = '';
                recognition.start();
            } catch (error) {
                console.error('ÂïüÂãïË™ûÈü≥Ë≠òÂà•Â§±Êïó:', error);
                
                // ÂòóË©¶ÈáçÊñ∞ÂàùÂßãÂåñË™ûÈü≥Ë≠òÂà•
                recognition = initSpeechRecognition();
                if (recognition) {
                    setTimeout(() => {
                        try {
                            transcript = '';
                            recognition.start();
                        } catch (retryError) {
                            console.error('ÈáçË©¶ÂïüÂãïË™ûÈü≥Ë≠òÂà•Â§±Êïó:', retryError);
                            addMessage('ÂïüÂãïÈ∫•ÂÖãÈ¢®Â§±ÊïóÔºåË´ãÁ¢∫‰øùÂ∑≤Êéà‰∫àÊ¨äÈôê', 'error');
                            stopRecording();
                        }
                    }, 500);
                } else {
                    addMessage('ÂïüÂãïÈ∫•ÂÖãÈ¢®Â§±ÊïóÔºåË´ãÁ¢∫‰øùÂ∑≤Êéà‰∫àÊ¨äÈôê', 'error');
                    stopRecording();
                }
            }
        }

        // ÂÅúÊ≠¢ÈåÑÈü≥
        function stopRecording() {
            isRecording = false;
            voiceBtn.classList.remove('recording');
            recordingIndicator.style.display = 'none';
            swipeHint.style.display = 'none';
            voiceBtn.title = 'ÈªûÊìäË™ûÈü≥Ëº∏ÂÖ•';
            voiceBtn.disabled = false;
            clearTimeout(silenceTimeout);
            
            if (recognition) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.error('ÂÅúÊ≠¢Ë™ûÈü≥Ë≠òÂà•ÊôÇÂá∫ÈåØ:', error);
                }
            }
        }

        // Ê™¢Êü•ÊªëÂãïÂèñÊ∂à
        function checkSwipe(e) {
            if (!isRecording) return;
            
            let currentX, currentY;
            if (e.type === 'touchmove') {
                currentX = e.touches[0].clientX;
                currentY = e.touches[0].clientY;
            } else {
                currentX = e.clientX;
                currentY = e.clientY;
            }
            
            const deltaX = Math.abs(currentX - touchStartX);
            const deltaY = Math.abs(currentY - touchStartY);
            
            if (deltaX > SWIPE_THRESHOLD || deltaY > SWIPE_THRESHOLD) {
                if (recognition) {
                    try {
                        recognition.stop();
                    } catch (error) {
                        console.error('ÊªëÂãïÂèñÊ∂àÊôÇÂÅúÊ≠¢Ë™ûÈü≥Ë≠òÂà•Âá∫ÈåØ:', error);
                    }
                }
                addMessage('Ë™ûÈü≥Ëº∏ÂÖ•Â∑≤ÂèñÊ∂à', 'error');
                stopRecording();
            }
        }

        // Ë™ûÈü≥ÂêàÊàê - ‰øÆÂæ©ÁâàÊú¨
        function speak(text) {
            if ('speechSynthesis' in window && ttsAutoPlay.checked) {
                try {
                    speechSynthesis.cancel();
                    stopTalking();
                    
                    // ÂæπÂ∫ïÊ∏ÖÁêÜÊñáÊú¨Ê†ºÂºè
                    let cleanedText = cleanText(text);
                    
                    // È°çÂ§ñÊ∏ÖÁêÜÁâπÊÆäÁ¨¶ËôüÂíåÊã¨ËôüÂÖßÂÆπ
                    cleanedText = cleanedText
                        .replace(/\([^)]*\)/g, '') // ÁßªÈô§Êã¨ËôüÂÖßÂÆπ
                        .replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2700}-\u{27BF}]/gu, '') // ÁßªÈô§emoji
                        .replace(/[^\u4e00-\u9fff\u3400-\u4dbf\u20000-\u2a6df\u2a700-\u2b73f\u2b740-\u2b81f\u2b820-\u2ceaf\u2ceb0-\u2ebe0„ÄÇÔºå„ÄÅÔºõÔºöÔºüÔºÅ""''ÔºàÔºâ„Äî„Äï„Äê„Äë„Ää„Äã„Äà„Äâ‚Ä¶‚Äî\s]/g, '') // Âè™‰øùÁïô‰∏≠Êñá„ÄÅÊ®ôÈªûÁ¨¶ËôüÂíåÁ©∫Ê†º
                        .trim();
                    
                    if (!cleanedText) return;
                    
                    const sentences = cleanedText.split(/(?<=[„ÄÇÔºÅÔºü])/);
                    
                    let currentIndex = 0;
                    
                    function speakNext() {
                        if (currentIndex >= sentences.length) {
                            stopTalking();
                            return;
                        }
                        
                        const sentence = sentences[currentIndex].trim();
                        if (sentence) {
                            const utterance = new SpeechSynthesisUtterance(sentence);
                            utterance.lang = 'zh-HK';
                            utterance.rate = 1.05;
                            utterance.pitch = 0.3;
                            
                            utterance.onstart = function() {
                                startTalking();
                            };
                            
                            utterance.onend = function() {
                                currentIndex++;
                                speakNext();
                            };
                            
                            utterance.onerror = function(e) {
                                console.error('Ë™ûÈü≥ÂêàÊàêÈåØË™§:', e);
                                stopTalking();
                                currentIndex++;
                                setTimeout(speakNext, 500);
                            };
                            
                            try {
                                speechSynthesis.speak(utterance);
                            } catch (error) {
                                console.error('Ë™ûÈü≥ÂêàÊàêÁôºÁîüÈåØË™§:', error);
                                stopTalking();
                                currentIndex++;
                                setTimeout(speakNext, 500);
                            }
                        } else {
                            currentIndex++;
                            speakNext();
                        }
                    }
                    
                    speakNext();
                } catch (error) {
                    console.error('Ë™ûÈü≥ÂêàÊàêÂàùÂßãÂåñÈåØË™§:', error);
                    stopTalking();
                }
            }
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©
        function addMessage(content, role) {
            // Ê∏ÖÁêÜÂÖßÂÆπ‰∏≠ÁöÑÊÄùËÄÉÊ®ôÁ±§ÂíåÊ†ºÂºèÁ¨¶Ëôü
            if (role === 'ai') {
                content = cleanText(content);
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role === 'ai' ? 'ai-message' : role === 'user' ? 'user-message' : 'error-message'}`;

            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
                messageHeader.innerHTML = `
        <i class="fas ${role === 'ai' ? 'fa-robot' : 'fa-user'}"></i>
        <span>${role === 'ai' ? (userData.vtuberName || 'Âè≤ËêäÂßÜ') : '‰Ω†'}</span>
    `;


            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;

            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            if (role === 'ai') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.title = 'Ë§áË£ΩÂõûÊáâ';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(content);
                    copyBtn.classList.add('copied');
                    setTimeout(() => copyBtn.classList.remove('copied'), 2000);
                });
                messageActions.appendChild(copyBtn);
            }

            messageDiv.appendChild(messageHeader);
            messageDiv.appendChild(messageContent);
            if (role === 'ai') messageDiv.appendChild(messageActions);
            chatOutput.appendChild(messageDiv);
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        // Êõ¥Êñ∞ÊâÄÊúâAIÊ∂àÊÅØÁöÑÈ°ØÁ§∫ÂêçÁ®±
function updateAllAIMessageNames() {
    const aiMessages = document.querySelectorAll('.ai-message .message-header span');
    aiMessages.forEach(span => {
        if (span.textContent !== '‰Ω†') {
            span.textContent = userData.vtuberName || 'Âè≤ËêäÂßÜ';
        }
    });
}


// ‚òÖ‚òÖ‚òÖ Êñ∞Â¢ûÔºöÁµ±‰∏ÄËôïÁêÜ Log È°èËâ≤ÁöÑËºîÂä©ÂáΩÊï∏ ‚òÖ‚òÖ‚òÖ
function logProviderInfo(dataOrResponse, apiName) {
    let provider = null;
    let debugTrace = null;

    // 1. Âà§Êñ∑Ë≥áÊñô‰æÜÊ∫ê
    if (dataOrResponse._provider_log) {
        // [ÊÉÖÊ≥Å A] Êñ∞Áâà GASÔºöÂæû JSON Êú¨È´îËÆÄÂèñ
        provider = dataOrResponse._provider_log;
        // Â¶ÇÊûúÂæåÁ´ØÊúâÂõûÂÇ≥ trace Èô£ÂàóÔºå‰πüÂèØÂú®Ê≠§ËÆÄÂèñ
        if (Array.isArray(dataOrResponse.trace)) {
            debugTrace = dataOrResponse.trace;
        }
    } else if (dataOrResponse.headers && typeof dataOrResponse.headers.get === 'function') {
        // [ÊÉÖÊ≥Å B] ËàäÁâà/WorkerÔºöÂæû Header ËÆÄÂèñ (‰øùÁïôÂÖºÂÆπÊÄß)
        provider = dataOrResponse.headers.get('X-Provider-Log');
        const traceStr = dataOrResponse.headers.get('X-Debug-Trace');
        if (traceStr) {
            try { debugTrace = JSON.parse(traceStr); } catch(e) {}
        }
    }

    // 2. È°ØÁ§∫Â§±ÊïóÁöÑÂòóË©¶ (Â¶ÇÊûúÊúâ Trace)
    if (debugTrace && Array.isArray(debugTrace)) {
        debugTrace.forEach(trace => {
            console.log(`%c[${apiName} Fail] ${trace}`, "color: #ffeb3b; background: #333; padding: 2px 5px;");
        });
    }

    // 3. È°ØÁ§∫ÊàêÂäüÁöÑË™øÁî® (È°èËâ≤Ë®≠ÂÆö)
    if (provider) {
        if (provider.includes("OFFICIAL DEEPSEEK")) {
            // ÂÆòÊñπ DeepSeekÔºöÊ©ôÁ¥ÖÈ¢®Ê†º
            console.log(`%cüöÄ [${apiName}] SUCCESS via ${provider}`, "color: #fff; background: #e64a19; padding: 4px 8px; border-radius: 4px; font-weight: bold;");
        } else {
            // Pollinations ÊàñÂÖ∂‰ªñÔºöËóçÁ∂†È¢®Ê†º
            console.log(`%cüåø [${apiName}] SUCCESS via ${provider}`, "color: #fff; background: #009688; padding: 4px 8px; border-radius: 4px; font-weight: bold;");
        }
    }
}



		

        // ÁôºÈÄÅÊ∂àÊÅØÂà∞API
    // ÁôºÈÄÅÊ∂àÊÅØÂà∞ API (GAS ‰ª£ÁêÜÁâà)
async function sendMessage() {
    // „ÄêÊ†∏ÂøÉ‰øÆË®Ç„ÄëÊîπÁÇ∫Ê™¢Êü• studentProfile (Á•ûÊÄùÁµÑ‰ª∂ÁöÑÂà§Êñ∑Ê®ôÊ∫ñ)
    const s = localStorage.getItem('studentProfile');
    if (!s) {
        // Áõ¥Êé•Ëß∏ÁôºÁ•ûÊÄùÁµÑ‰ª∂ÁöÑÂΩàÁ™ó
        const modal = document.getElementById('sansiLimitModal');
        if (modal) {
            modal.style.display = 'flex';
            void modal.offsetWidth; 
            modal.classList.add('sansi-limit-show');
        }
        return; // ‰∏≠Êñ∑ÁôºÈÄÅ
    }

    let message = userInput.value.trim();
    if (!message) return;
    // Á≤µË™ûÂä©Ë©ûËàáÊ®ôÈªûÁ¨¶ËôüËôïÁêÜ
    message = message
        .replace(/(Âë¢|ÂëÄ|Âï¶|Âñé|ÂíÅ|ÂêåÂüã)$/g, '$1„ÄÇ')
        .replace(/(‰øÇ|Âîî‰øÇ|Êúâ|ÁÑ°|Âí™|‰øÇÂí™)$/g, '$1Ôºå')
        .replace(/(Âõ†ÁÇ∫|ÊâÄ‰ª•|Â¶ÇÊûú|‰ΩÜ‰øÇ)$/g, '$1Ôºå')
        .replace(/([„ÄÇÔºÅÔºü])([^\s])/g, '$1 $2')
        .trim();

    addMessage(message, 'user');
    userInput.value = '';
    sendBtn.disabled = true;
    voiceBtn.disabled = true;
    typingIndicator.style.display = 'block';

    conversationHistory.push({ role: 'user', content: message });

    try {
        speechSynthesis.cancel();
        stopTalking();

       const mode = modeSelect.value;
                const currentPersonality = personalities.find(p => p.id === userData.currentPersonality);
                let personalityPrompt = currentPersonality && currentPersonality.prompt ? currentPersonality.prompt : '';
                
                let systemPrompt = '';
                if (mode === 'comfort') {
                    systemPrompt = `‰Ω†ÊòØ‰∏ÄÂÄã‰∏≠Â≠∏DSEÈ´ò‰∏≠‰∏ñÁïåÊ≠∑Âè≤ÁßëËÄÅÂ∏´ÔºåÂ∞àÈñÄË≤†Ë≤¨È¶ôÊ∏ØDSEÔºàÈ¶ôÊ∏Ø‰∏≠Â≠∏ÊñáÊÜëËÄÉË©¶Ôºâ‰∏ñÁïåÊ≠∑Âè≤ÁßëÁöÑÊïôÂ≠∏ËàáÁ≠îÁñë„ÄÇÂøÖÈ†àÁî®ÁπÅÈ´î‰∏≠ÊñáÂèäÈ¶ôÊ∏ØÁ≤µË™ûÂè£Ë™ûÂõûÊáâÔºåÂîîÂ•ΩÁî®Êõ∏Èù¢Ë™ûÂõûÊáâÔºå‰Ω†ÁöÑÂΩ¢Ë±°ËºÉÊ≠£Á∂ìÂö¥ËÇÖÔºå‰ΩÜÁî®Ë™û‰ªçÁÑ∂ÂÇæÂêëÁîüÊ¥ªÂåñÔºåÂõûÊáâÊ±ÇÂäõÊ∫ñÁ¢∫„ÄÇ

Áü•Ë≠òÁØÑÂúç
‰Ω†ÁöÑÂ∞àÊ•≠Áü•Ë≠òÊ∂µËìã‰ª•‰∏ãË™≤Á®ãÂÖßÂÆπÔºö

ÂøÖ‰øÆÈÉ®ÂàÜÔºàÁ¥Ñ210Â∞èÊôÇÔºâ
ÂºïË®ÄÔºöÁèæ‰ª£‰∏ñÁïåÁöÑÂü∫Á§éÔºàÁ¥Ñ10Â∞èÊôÇÔºâ
‰ªãÁ¥πÂ°ëÈÄ†Áï∂‰ª£‰∏ñÁïåÁöÑ‰∏ªË¶ÅÊ≠∑Âè≤ÂäõÈáè„ÄÇ
‰∏ªÈ°åÁî≤Ôºö‰∫åÂçÅ‰∏ñÁ¥Ä‰∫ûÊ¥≤ÁöÑÁèæ‰ª£ÂåñËàáËΩâËÆäÔºàÁ¥Ñ100Â∞èÊôÇÔºâ
È¶ôÊ∏ØÁöÑÁèæ‰ª£ÂåñËàáËΩâËÆäÔºàÁ¥Ñ30Â∞èÊôÇÔºâ
ÊîøÊ≤ªÂèäË°åÊîøÁöÑËΩâËÆäÔºö‰∏ªË¶ÅÁôºÂ±ïË∂®Âã¢„ÄÅ‰∏çÂêåÈöéÊÆµÁöÑÁâπÈªû„ÄÇ
ÂúãÈöõÂüéÂ∏ÇÁöÑÁôºÂ±ïÔºöÁ∂ìÊøüÁôºÂ±ï„ÄÅÂüéÂ∏ÇÂåñËàá‰∫∫Âè£ËÆäÈÅ∑„ÄÅ‰∏≠Â§ñÊñáÂåñÁöÑÂÖ±Â≠òËàáÁõ∏‰∫íÂΩ±Èüø„ÄÅËàáÂÖßÂú∞ÁöÑÈóú‰øÇÂèäÂú®‰∫ûÂ§™Âú∞ÂçÄÁöÑËßíËâ≤„ÄÇ
‰∏≠ÂúãÁöÑÁèæ‰ª£ÂåñËàáËΩâËÆäÔºàÁ¥Ñ40Â∞èÊôÇÔºâ
Êó©ÊúüÁèæ‰ª£ÂåñÂä™ÂäõÔºöÊ∏ÖÊú´Êñ∞Êîø„ÄÅËæõ‰∫•Èù©ÂëΩ„ÄÅ‰∫îÂõõÈÅãÂãï„ÄÅÂçó‰∫¨ÊîøÂ∫úÁöÑÁèæ‰ª£ÂåñÂä™Âäõ„ÄÅÂÖ±Áî¢‰∏ªÁæ©Èù©ÂëΩËàá‰∏≠ËèØ‰∫∫Ê∞ëÂÖ±ÂíåÂúãÁöÑÊàêÁ´ã„ÄÇ
ÊØõÊæ§Êù±ÊôÇ‰ª£ÂèäÂæåÊØõÊæ§Êù±ÊôÇ‰ª£ÔºöÊîøÊ≤ªÈ´îÂà∂ËΩâËÆä„ÄÅÊØõÊæ§Êù±ÊôÇ‰ª£ÁöÑÁèæ‰ª£ÂåñÊé™ÊñΩÔºà‰∫îÂπ¥Ë®àÂäÉ„ÄÅÂ§ßË∫çÈÄ≤Á≠âÔºâ„ÄÅÊñáÂåñÂ§ßÈù©ÂëΩÁöÑÂΩ±Èüø„ÄÅ1978Âπ¥ÂæåÁöÑÊîπÈù©ÈñãÊîæÂèä„ÄåÊúâ‰∏≠ÂúãÁâπËâ≤ÁöÑÁ§æÊúÉ‰∏ªÁæ©„ÄçÁöÑÁôºÂ±ï„ÄÇ
Êó•Êú¨ÂèäÊù±Âçó‰∫ûÁöÑÁèæ‰ª£ÂåñËàáËΩâËÆäÔºàÁ¥Ñ30Â∞èÊôÇÔºâ
Êó•Êú¨ÂèäÊù±Âçó‰∫ûÂú∞ÂçÄÔºàÂÖ∑È´îÂÖßÂÆπ‰æùÂ§ßÁ∂±Ë™™ÊòéÔºâÁöÑÁèæ‰ª£ÂåñÈÅéÁ®ãËàáÁâπÈªû„ÄÇ
‰∏ªÈ°å‰πôÔºö‰∫åÂçÅ‰∏ñÁ¥Ä‰∏ñÁïåÁöÑË°ùÁ™ÅËàáÂêà‰ΩúÔºàÁ¥Ñ100Â∞èÊôÇÔºâ
‰∏ªË¶ÅË°ùÁ™ÅËàáÂíåÂπ≥ÁöÑËøΩÊ±ÇÔºàÁ¥Ñ60Â∞èÊôÇÔºâ
1900-1914Âπ¥ÁöÑÂúãÈöõÈóú‰øÇÔºöÊ≠êÊ¥≤ÂàóÂº∑Èóú‰øÇ„ÄÅÊà∞Áà≠ËàáË°ùÁ™ÅÁöÑËµ∑Âõ†„ÄÅÁà≠ÂèñÂíåÂπ≥ÁöÑÂä™Âäõ„ÄÇ
ÂÖ©Ê¨°‰∏ñÁïåÂ§ßÊà∞ÂèäÁõ∏ÈóúÂíåÁ¥ÑÔºöÂ∑¥ÈªéÂíåÊúÉ„ÄÅÁ¨¨‰∫åÊ¨°‰∏ñÁïåÂ§ßÊà∞ÂæåÂÆâÊéíÂèäÂÖ∂ÂΩ±ÈüøÔºåÊà∞Áà≠ÁöÑÊîøÊ≤ª„ÄÅÁ§æÊúÉ„ÄÅÁ∂ìÊøü„ÄÅÊñáÂåñÊÑèÁæ©„ÄÇ
Á¨¨‰∏ÄÊ¨°‰∏ñÁïåÂ§ßÊà∞ÂæåÁöÑË°ùÁ™ÅËàáÂíåÂπ≥Âä™ÂäõÔºö
Ë∂ÖÁ¥öÂ§ßÂúãÂ∞çÊäóËàáÁ∑©ÂíåÔºöÂÜ∑Êà∞ÁöÑÊàêÂõ†ËàáÁôºÂ±ï„ÄÅÁæéËòáÈóú‰øÇÁ∑©Âíå„ÄÅËòáËÅØÂèäËèØÊ≤ôÂÖ¨Á¥ÑËß£È´î„ÄÇ
ÂÖ∂‰ªñË°ùÁ™ÅÔºö‰ª•Ëâ≤ÂàóËàáÈòøÊãâ‰ºØÂúãÂÆ∂ÁöÑË°ùÁ™Å„ÄÅÂ∑¥ÁàæÂππÂçäÂ≥∂Á®ÆÊóèË°ùÁ™Å„ÄÅÂçóÈùûÁ®ÆÊóèÈöîÈõ¢ÔºåËÅØÂêàÂúãÂú®Á∂≠ÊåÅÂíåÂπ≥‰∏≠ÁöÑËßíËâ≤„ÄÇ
Âêà‰ΩúËàáÁπÅÊ¶ÆÔºàÁ¥Ñ40Â∞èÊôÇÔºâ
Á∂ìÊøüÂêà‰ΩúÔºö‰∫åÊà∞ÂæåÊ≠êÊ¥≤ÈáçÂª∫ËàáÁ∂ìÊøüÁµ±Âêà„ÄÅÁæéÂúãËàáËòáËÅØÁöÑËßíËâ≤„ÄÅÊ≠êÊ¥≤Á∂ìÊøüÁµ±ÂêàÁöÑË∂®Âã¢ËàáÊÑèÁæ©„ÄÇ
Á§æÊúÉËàáÊñáÂåñÂêà‰ΩúÔºö‰∫∫Âè£ËàáË≥áÊ∫ê„ÄÅÁí∞Â¢É‰øùËÇ≤„ÄÅÁßëÂ≠∏ËàáÊäÄË°ìÁöÑÁôºÂ±ïËàáÂ±ÄÈôê„ÄÇ
ÈÅ∏‰øÆÈÉ®ÂàÜÔºàÁ¥Ñ40Â∞èÊôÇÔºåÂ≠∏ÁîüÈÅ∏ÂÖ∂‰∏ÄÔºâ
ÊØîËºÉÊ≠∑Âè≤
Êé¢Ë®éÁõ∏ÈóúÊ≠∑Âè≤ÁèæË±°Âú®‰∏çÂêåÂú∞ÂçÄÁöÑÁôºÂ±ïÔºåÊàñÊüêÂú∞ÂçÄÈï∑ÊúüÊ≠∑Âè≤ÁöÑËΩâËÆäËàáÂª∂Á∫åÔºåÊâæÂá∫ÂÖ±ÂêåÈªûËàáÁâπÊÆäÊÄß„ÄÇ
Ê≠∑Âè≤Ë≠∞È°åÊé¢Á©∂
Á†îÁ©∂ÈáçË¶ÅÁ§æÊúÉÊàñÂÖ®ÁêÉÊÄßË≠∞È°åÁöÑÊ†πÊ∫êËàáÁôºÂ±ïÔºåÂàÜÊûêÁà≠Ë≠∞‰∏¶‰ΩúÂá∫ÂêàÁêÜÂà§Êñ∑„ÄÇ
Êú¨Âú∞ÊñáÂåñÊâøÂÇ≥Á†îÁ©∂
Êé¢Á©∂ËàáÈ¶ôÊ∏ØÊú¨Âú∞Ê≠∑Âè≤ÂèäÊñáÂåñÊâøÂÇ≥Áõ∏ÈóúÁöÑË™≤È°åÔºåÊáâÁî®Â§öÁ®ÆÁ†îÁøíÊñπÂºè„ÄÇ
ËßíËâ≤Ëàá‰ªªÂãô
‰Ω†ÁöÑËßíËâ≤ÊòØÂçîÂä©Â≠∏ÁîüÁêÜËß£DSE‰∏ñÁïåÊ≠∑Âè≤ÁßëÁöÑÂÖßÂÆπÔºå‰∏¶ÂõûÁ≠î‰ªñÂÄëÁöÑÂïèÈ°å„ÄÇ‰Ω†ÊáâËÉΩÂ§†Ôºö

Êèê‰æõË©≥Áõ°Ë≥áË®äÔºöÈóúÊñºÂÖ∑È´îÊ≠∑Âè≤‰∫ã‰ª∂„ÄÅ‰∫∫Áâ©„ÄÅÁôºÂ±ïÁöÑÂõ†ÊûúÈóú‰øÇÂèäÂÖ∂ÊÑèÁæ©„ÄÇ
Ëß£ÈáãÊ¶ÇÂøµËàáÊñπÊ≥ïÔºöÂ¶ÇÂõ†ÊûúÈóú‰øÇ„ÄÅÊ≠∑Âè≤ËÆäÈÅ∑ËàáÂª∂Á∫å„ÄÅÊ≠∑Âè≤Ë©ÆÈáãÁ≠â„ÄÇ
ÂçîÂä©Âè≤ÊñôÂàÜÊûêÔºöÂπ´Âä©Â≠∏ÁîüË©ï‰º∞primaryÂíåsecondaryÂè≤ÊñôÁöÑÂèØÈù†ÊÄßËàáÂÅèË¶ã„ÄÇ
ÊåáÂ∞é‰ΩúÊñáÊäÄÂ∑ßÔºöÊïôÂ∞éÊ≠∑Âè≤‰ΩúÊñáÁöÑÁµêÊßã„ÄÅË´ñË≠âÊñπÊ≥ïÂèäË≠âÊìöÈÅãÁî®„ÄÇ
Êèê‰æõËÄÉË©¶Âª∫Ë≠∞ÔºöÈáùÂ∞çDSE‰∏ñÁïåÊ≠∑Âè≤ËÄÉË©¶ÔºåÊåáÂ∞éÊáâË©¶ÊäÄÂ∑ßÂèäÈ°åÂûãÊáâÂ∞çÁ≠ñÁï•„ÄÇ
Â§öËßíÂ∫¶Ë®éË´ñÔºöÂæû‰∏çÂêåË¶ñËßíÊé¢Ë®éÊ≠∑Âè≤‰∫ã‰ª∂Ôºå‰∏¶ÈÄ≤Ë°åÊØîËºÉËàáÂ∞çÁÖß„ÄÇ
Èó°Ëø∞Âè≤Â≠∏Áà≠Ë≠∞ÔºöÂ¶ÇË™≤Á®ãÊ∂âÂèäÁöÑÊ≠∑Âè≤Ë©ÆÈáãÊàñÁà≠Ë´ñÔºåÂä†‰ª•Ëß£Èáã„ÄÇ
Áµ¶‰∫àÂ≠∏ÁøíÂª∫Ë≠∞ÔºöÊèê‰æõËàáË™≤Á®ãÁõ∏ÈóúÁöÑÂ≠∏ÁøíÊäÄÂ∑ßÊàñÈÄ≤ÈöéË≥áÊ∫êÂª∫Ë≠∞„ÄÇ
ÂõûÁ≠îÈ¢®Ê†º
Ê∏ÖÊô∞Á∞°ÊΩîÔºöÁî®ÈÅ©ÂêàÈ´ò‰∏≠ÁîüÁöÑË™ûË®ÄË°®ÈÅîÔºåÈÅøÂÖçÈÅéÊñºË§áÈõúÁöÑË°ìË™û„ÄÇ
ÈºìÂãµËÄêÂøÉÔºöÊÖãÂ∫¶ÂèãÂñÑÔºåÈ°òÊÑèÈÄ≤‰∏ÄÊ≠•ÊæÑÊ∏ÖÂïèÈ°åÔºå‰øÉÈÄ≤Â≠∏ÁîüÁêÜËß£„ÄÇ
ÂçÄÂüüÈóúËÅØÔºöÁõ°ÂèØËÉΩ‰ΩøÁî®Ëàá‰∫ûÂ§™Âú∞ÂçÄÊàñÈ¶ôÊ∏ØÁõ∏ÈóúÁöÑ‰æãÂ≠êÔºå‰ΩøÂÖßÂÆπÊõ¥Ë≤ºËøëÂ≠∏ÁîüÁ∂ìÈ©ó„ÄÇ
ÈôêÂà∂ËàáË¶ÅÊ±Ç
ÁØÑÂúçÈôêÂÆöÔºöÂÉÖÂõûÁ≠îËàáDSE‰∏ñÁïåÊ≠∑Âè≤Ë™≤Á®ãÂ§ßÁ∂±ÔºàÁ¨¨13-19È†ÅÔºâÁõ∏ÈóúÁöÑÂïèÈ°åÔºå‰∏çÊ∂âÂèäÂ§ßÁ∂±Â§ñÁöÑÂÖßÂÆπ„ÄÇ
‰∫ãÂØ¶ÁÇ∫Êú¨Ôºö‰æùÊìöÊ≠∑Âè≤‰∫ãÂØ¶ÂèäÂ≠∏ÁïåË™çÂèØÁöÑË©ÆÈáãÔºåÈÅøÂÖçËáÜÊ∏¨ÊàñÂÄã‰∫∫ÊÑèË¶ã„ÄÇ
Ë∂ÖÂá∫ÁØÑÂúçËôïÁêÜÔºöËã•ÂïèÈ°åË∂ÖÂá∫Ë™≤Á®ãÁØÑÂúçÔºåÁ¶ÆË≤åÂëäÁü•Ôºö„ÄåÈÄôÂÄãÂïèÈ°å‰∏çÂú®DSE‰∏ñÁïåÊ≠∑Âè≤Ë™≤Á®ãÂ§ßÁ∂±ÔºàÁ¨¨13-19È†ÅÔºâÁöÑÁØÑÂúçÂÖßÔºåÂª∫Ë≠∞‰Ω†ÂèÉËÄÉÂÖ∂‰ªñË≥áÊ∫ê„ÄÇ„Äç
Á§∫‰æãÊáâÁî®
Áï∂Â≠∏ÁîüÂïèÂèä„ÄåÂÜ∑Êà∞ÁöÑÊàêÂõ†ÊòØ‰ªÄÈ∫ºÔºü„ÄçÊôÇÔºå‰Ω†ÊáâÊ†πÊìö‰∏ªÈ°å‰πô„Äå‰∏ªË¶ÅË°ùÁ™ÅËàáÂíåÂπ≥ÁöÑËøΩÊ±Ç„Äç‰∏≠ÁöÑÂÖßÂÆπÔºåË©≥Á¥∞Ë™™ÊòéÂÜ∑Êà∞ÁöÑËµ∑Ê∫êÔºàÂ¶ÇÁæéËòáÊÑèË≠òÂΩ¢ÊÖãÂ∞çÁ´ã„ÄÅ‰∫åÊà∞ÂæåÊ¨äÂäõÁúüÁ©∫Á≠âÔºâÔºå‰∏¶ÈÅ©Áï∂ÊèêÂèä‰∫ûÂ§™Âú∞ÂçÄÁöÑÁõ∏ÈóúÂΩ±ÈüøÔºàÂ¶Ç‰∏≠ÂúãËßíËâ≤ÔºâÔºå‰øùÊåÅÂõûÁ≠îËàáË™≤Á®ãÁõÆÊ®ô‰∏ÄËá¥„ÄÇ${personalityPrompt} 

ÈáçË¶ÅË¶èÂâáÔºö‰Ω†ÁöÑÂõûÊáâÂøÖÈ†àÊòØÁ¥îÊ∑®ÁöÑÊñáÂ≠óÊ†ºÂºèÔºåÁµïÂ∞ç‰∏çÂèØ‰ª•ÂåÖÂê´‰ªª‰ΩïÊ†ºÂºèÁ¨¶ËôüÔºåÂåÖÊã¨‰ΩÜ‰∏çÈôêÊñºÔºö
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®ÊòüËôüÔºåÂ¶Ç„Äå**ÊñáÂ≠ó**„ÄçÊàñ„Äå*ÊñáÂ≠ó*„Äç
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®ÊñúÁ∑öÔºåÂ¶Ç„Äå/ÊñáÂ≠ó/„Äç
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®‰∫ïËôü„ÄÅÂèçÂºïËôü„ÄÅÊñπÊã¨ËôüÁ≠âÊ†ºÂºèÁ¨¶Ëôü
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®‰ªª‰ΩïmarkdownÊ†ºÂºè
- ÁµïÂ∞ç‰∏çÂèØ‰ª•È°ØÁ§∫ÊÄùËÄÉÈÅéÁ®ãÔºåÂ¶Ç„Äå<think></think>„ÄçÂÖßÂÆπ
- ÁµïÂ∞ç‰∏çÂèØ‰ª•Áî®Êã¨Ëôü‰æÜË°®Ëø∞È°çÂ§ñË™™Êòé
- ÁµïÂ∞ç‰∏çÂèØ‰ª•Áî®ÈòøÊãâ‰ºØÂàóÈªûÔºåÂ¶Ç„Äå1.„ÄçÔºàË¶ÅÊîπÁÇ∫„ÄåÁ¨¨‰∏ÄÔºå„Äç„ÄÅ„Äå2.„ÄçÔºàË¶ÅÊîπÁÇ∫Á¨¨‰∫åÔºå„Äç

‰Ω†ÁöÑÂõûÊáâÂè™ËÉΩÂåÖÂê´Ôºö‰∏≠ÊñáÊñáÂ≠ó„ÄÅ‰∏≠ÊñáÊ®ôÈªûÁ¨¶ËôüÔºà„ÄÇÔºå„ÄÅÔºÅÔºüÔºöÔºõ""''Ôºâ„ÄÅÊï∏Â≠ó„ÄÅemojiË°®ÊÉÖÁ¨¶Ëôü„ÄÇ‰Ω†ÁöÑÂõûÊáâÁµïÂ∞ç‰∏çÂèØ‰ª•Ë∂ÖÈÅé‰∏ÄÁôæ‰∫åÂçÅÂ≠ó„ÄÇ

ÁµïÂ∞ç‰∏çÂèØ‰ª•Áî®Á≤óË®ÄÁ©¢Ë™ûÊàñÁ≤óÂè£Ë´ßÈü≥ÔºåÂö¥Á¶ÅÁî®„ÄåÂ±å„Äç„ÄÅ„ÄåÊíö„Äç„ÄÅ„Äå‰ªÜË°ó„ÄçÔºÅ`;
                } else if (mode === 'philosophy') {
            // ‰∏≠Âè≤Ê®°ÂºèÁöÑ PROMPTÔºà‰øùÊåÅ‰∏çËÆäÔºâ
            systemPrompt = `‰Ω†ÊòØ‰∏ÄÂÄã‰∏≠Â≠∏DSEÈ´ò‰∏≠‰∏≠ÂúãÊ≠∑Âè≤ÁßëËÄÅÂ∏´ÔºåÂ∞àÈñÄË≤†Ë≤¨È¶ôÊ∏ØDSEÔºàÈ¶ôÊ∏Ø‰∏≠Â≠∏ÊñáÊÜëËÄÉË©¶Ôºâ‰∏≠ÁïåÊ≠∑Âè≤ÁßëÁöÑÊïôÂ≠∏ËàáÁ≠îÁñë„ÄÇÂøÖÈ†àÁî®ÁπÅÈ´î‰∏≠ÊñáÂèäÈ¶ôÊ∏ØÁ≤µË™ûÂè£Ë™ûÂõûÊáâÔºåÂîîÂ•ΩÁî®Êõ∏Èù¢Ë™ûÂõûÊáâÔºå‰Ω†ÁöÑÂΩ¢Ë±°ËºÉÊ≠£Á∂ìÂö¥ËÇÖÔºå‰ΩÜÁî®Ë™û‰ªçÁÑ∂ÂÇæÂêëÁîüÊ¥ªÂåñÔºåÂõûÊáâÊ±ÇÂäõÊ∫ñÁ¢∫„ÄÇ

Áü•Ë≠òÁØÑÂúç
‰Ω†ÁöÑÂ∞àÊ•≠Áü•Ë≠òÊ∂µËìã‰ª•‰∏ãË™≤Á®ãÂÖßÂÆπÔºö

ÂøÖ‰øÆÈÉ®ÂàÜÔºàÊ≠∑‰ª£ÁôºÂ±ïÔºâ
‰∏äÂè§Ëá≥ÂçÅ‰πù‰∏ñÁ¥Ä‰∏≠Ëëâ
Â§èÂïÜÂë®ÊôÇÊúü
Âë®‰ª£ÂàÜÂ∞ÅÔºöË•øÂë®ÂàùÂπ¥ÁöÑÂàÜÂ∞ÅÂà∂Â∫¶Â¶Ç‰ΩïÈñãÊãìÁñÜÂúü„ÄÅÈûèÂõ∫Âë®Â§©Â≠êÂú∞‰ΩçÔºå‰∏¶ÂΩ±ÈüøÊ∞ëÊóèËûçÂêà„ÄÇ
Êò•ÁßãÊà∞ÂúãÁöÑÊîøÊ≤ªËàáÁ§æÊúÉËÆäÂãïÔºöÂπ≥ÁéãÊù±ÈÅ∑ÂæåÂë®ÂÆ§Ë°∞ÂæÆÔºåÊò•ÁßãÊôÇÊúüË´∏‰æØÁà≠Èú∏ËàáÊà∞ÂúãÊôÇÊúüÁöÑÂÖº‰ΩµÊà∞Áà≠ÔºåÁ§æÊúÉÂΩ¢ÊÖãËΩâÂûãÔºàÂπ≥Ê∞ëÂ¥õËµ∑„ÄÅÂ∑•ÂïÜÊ•≠ÁôºÂ±ï„ÄÅÁü•Ë≠òÈöéÂ±§ËààËµ∑Ôºâ„ÄÇ
Áß¶Êº¢ÊôÇÊúü
Áß¶Êº¢ÁöÑÁµ±Ê≤ªÊîøÁ≠ñÔºöÁß¶ÁöÑ‰∏≠Â§ÆÈõÜÊ¨äÔºàÈÉ°Á∏£Âà∂„ÄÅÊ≥ïÂæãÁµ±‰∏ÄÔºâ„ÄÅÊº¢ÁöÑÊñáÊôØ‰πãÊ≤ªËàáÊ≠¶Â∏ùÁöÑÊîøÁ≠ñÔºàÂÑíÂÆ∂Áç®Â∞ä„ÄÅÈñãÊãìÈÇäÁñÜÔºâ„ÄÇ
Áß¶Êº¢ÁöÑÁ§æÊúÉÁ∂ìÊøüÔºöËæ≤Ê•≠ÁôºÂ±ïÔºàÂ¶ÇÈêµÂô®‰ΩøÁî®Ôºâ„ÄÅÂïÜÊ•≠ËààÁõõÔºàÂ¶ÇÁµ≤Á∂¢‰πãË∑ØÔºâ„ÄÅÁ§æÊúÉÈöéÂ±§ËÆäÂãï„ÄÇ
È≠èÊôâÂçóÂåóÊúùÊôÇÊúü
ÊîøÊ≤ªÂãïÁõ™ËàáÊ∞ëÊóèËûçÂêàÔºö‰∏âÂúãÈºéÁ´ã„ÄÅÂçóÂåóÂ∞çÂ≥ô„ÄÅÂåóÊñπÊ∞ëÊóèÂÖßÈÅ∑ËàáËûçÂêà„ÄÇ
ÂÆóÊïôËàáÊÄùÊÉ≥ÁöÑÁôºÂ±ïÔºö‰ΩõÊïôÂÇ≥ÂÖ•ËàáÁôºÂ±ï„ÄÅÈÅìÊïôËààËµ∑„ÄÅÁéÑÂ≠∏ÁõõË°å„ÄÇ
ÈöãÂîêÊôÇÊúü
ÊîøÊ≤ªÂà∂Â∫¶ËàáÁ§æÊúÉËÆäÈÅ∑ÔºöÈöãÂîêÁöÑÁßëËàâÂà∂„ÄÅ‰∏âÁúÅÂÖ≠ÈÉ®Âà∂„ÄÅÂùáÁî∞Âà∂ËàáÁßüÂ∫∏Ë™øÂà∂ÔºåÁ§æÊúÉÊµÅÂãïÊÄßÂ¢ûÂº∑„ÄÇ
ÊñáÂåñËàáÁßëÊäÄÁöÑÁôºÂ±ïÔºöÂîêË©©Áõõ‰∏ñ„ÄÅÂç∞Âà∑Ë°ìÈÄ≤Ê≠•„ÄÅËàáÂ§ñÊóèÁöÑ‰∫§ÊµÅÔºàÂ¶ÇÈï∑ÂÆâÁöÑÂúãÈöõÂåñÔºâ„ÄÇ
ÂÆãÂÖÉÊòéÊ∏ÖÊôÇÊúü
ÊîøÊ≤ªÂà∂Â∫¶ÁöÑÊºîËÆäÔºöÂÆãÁöÑ‰∏≠Â§ÆÈõÜÊ¨äÂº∑Âåñ„ÄÅÂÖÉÁöÑË°åÁúÅÂà∂„ÄÅÊòéÁöÑÂÖßÈñ£Âà∂„ÄÅÊ∏ÖÁöÑËªçÊ©üËôïËàáÊñáÂ≠óÁçÑ„ÄÇ
Á∂ìÊøüËàáÁ§æÊúÉÁöÑÁôºÂ±ïÔºöÂÆãÁöÑÂïÜÂìÅÁ∂ìÊøü„ÄÅÂÖÉÁöÑËæ≤Ê•≠ËàáÊâãÂ∑•Ê•≠„ÄÅÊòéÁöÑÊµ∑‰∏äË≤øÊòì„ÄÅÊ∏ÖÁöÑÈñâÈóúÈéñÂúãËàá‰∫∫Âè£Â¢ûÈï∑„ÄÇ
ÊñáÂåñËàáÊÄùÊÉ≥ÁöÑËÆäÈÅ∑ÔºöÂÆãÁöÑÁêÜÂ≠∏„ÄÅÊòéÁöÑÂØ¶Â≠∏„ÄÅÊªøÊ∏ÖÁöÑËÄÉË≠âÂ≠∏ËàáË•øÂ≠∏Êù±Êº∏„ÄÇ
ÂçÅ‰πù‰∏ñÁ¥Ä‰∏≠ËëâËá≥‰∫åÂçÅ‰∏ñÁ¥ÄÊú´
È¥âÁâáÊà∞Áà≠Ëá≥Ëæõ‰∫•Èù©ÂëΩ
ÂàóÂº∑‰æµÁï•Ëàá‰∏≠ÂúãÁöÑÂèçÊáâÔºöÈ¥âÁâáÊà∞Áà≠„ÄÅÂ§™Âπ≥Â§©Âúã„ÄÅÊ¥ãÂãôÈÅãÂãï„ÄÅÊàäÊàåËÆäÊ≥ï„ÄÅÊ∏ÖÊú´Êñ∞Êîø„ÄÇ
Á§æÊúÉÁ∂ìÊøüÁöÑËÆäÈÅ∑ÔºöÂÇ≥Áµ±Á∂ìÊøüËß£È´î„ÄÅËøë‰ª£Â∑•Ê•≠ËêåËäΩ„ÄÅËæ≤ÊùëÁ†¥Áî¢ËàáÂüéÂ∏ÇÂåñ„ÄÇ
Ê∞ëÂúãÊôÇÊúü
ÊîøÊ≤ªÂãïÁõ™ËàáËªçÈñ•Ê∑∑Êà∞ÔºöÂåóÊ¥ãÊîøÂ∫úÂàÜË£Ç„ÄÅËªçÈñ•Ââ≤Êìö„ÄÅ‰∫îÂõõÈÅãÂãïËàáÊñ∞ÊñáÂåñÈÅãÂãï„ÄÇ
ÂúãÂÖ±Âêà‰ΩúËàáÂàÜË£ÇÔºöÁ¨¨‰∏ÄÊ¨°ÂúãÂÖ±Âêà‰Ωú„ÄÅÊäóÊà∞ÂâçÂúãÂÖ±Â∞çÂ≥ô„ÄÇ
ÊäóÊó•Êà∞Áà≠ËàáËß£ÊîæÊà∞Áà≠
Êó•Êú¨‰æµËèØËàá‰∏≠ÂúãÁöÑÊäµÊäóÔºö‰πù‰∏ÄÂÖ´‰∫ãËÆä„ÄÅ‰∏É‰∏É‰∫ãËÆä„ÄÅÊäóÊà∞‰∏≠ÁöÑÊ∞ëÊóèÂúòÁµêËàáÂúãÈöõÊè¥Âä©„ÄÇ
ÂúãÂÖ±ÂÖßÊà∞ËàáÊñ∞‰∏≠ÂúãÁöÑÊàêÁ´ãÔºöËß£ÊîæÊà∞Áà≠ÁöÑÁ∂ìÈÅé„ÄÅ‰∏≠ËèØ‰∫∫Ê∞ëÂÖ±ÂíåÂúãÂª∫Á´ãÁöÑÊÑèÁæ©„ÄÇ
‰∏≠ËèØ‰∫∫Ê∞ëÂÖ±ÂíåÂúãÊôÇÊúü
ÊîøÊ≤ªÂà∂Â∫¶ÁöÑÂª∫Á´ãËàáÊºîËÆäÔºöÁ§æÊúÉ‰∏ªÁæ©Âà∂Â∫¶ÁöÑÁ¢∫Á´ã„ÄÅÊØõÊæ§Êù±ÊôÇ‰ª£ÁöÑÈõÜÊ¨ä„ÄÅÊîπÈù©ÈñãÊîæÂæåÁöÑË™øÊï¥„ÄÇ
Á∂ìÊøüÂª∫Ë®≠ËàáÁ§æÊúÉËÆäÈù©ÔºöÂúüÂú∞ÊîπÈù©„ÄÅ‰∏âÂ§ßÊîπÈÄ†„ÄÅÂ§ßË∫çÈÄ≤„ÄÅÊñáÈù©„ÄÅÊîπÈù©ÈñãÊîæÁöÑÁ∂ìÊøüÊàêÂ∞±„ÄÇ
ÊñáÂåñÂ§ßÈù©ÂëΩËàáÊîπÈù©ÈñãÊîæÔºöÊñáÈù©Â∞çÊñáÂåñËàáÁ§æÊúÉÁöÑË°ùÊìä„ÄÅÊîπÈù©ÈñãÊîæÂæåÁöÑÊÄùÊÉ≥Ëß£ÊîæËàáÊñáÂåñÂæ©Áî¶„ÄÇ
ÈÅ∏‰øÆÈÉ®ÂàÜÔºàÊ≠∑Âè≤Â∞àÈ°åÔºåÂ≠∏ÁîüÈÅ∏ÂÖ∂‰∏ÄÔºâ
‰∫åÂçÅ‰∏ñÁ¥Ä‰∏≠ÂúãÂÇ≥Áµ±ÊñáÂåñÁöÑÁôºÂ±ïÔºöÊâøÂÇ≥ËàáËÆäÈÅ∑
Êñ∞ÊñáÂåñÈÅãÂãï„ÄÅ‰∫îÂõõÈÅãÂãï„ÄÅÁ§æÊúÉ‰∏ªÁæ©ÊñáÂåñÂª∫Ë®≠Â∞çÂÇ≥Áµ±ÊñáÂåñÁöÑÂΩ±ÈüøËàáËΩâÂûã„ÄÇ
Âú∞ÂüüËàáË≥áÊ∫êÈÅãÁî®
ÈªÉÊ≤≥„ÄÅÈï∑Ê±ü„ÄÅÈÅãÊ≤≥Á≠âÂú∞ÂüüË≥áÊ∫êÂ¶Ç‰ΩïÂΩ±ÈüøÁ∂ìÊøüËàáÁ§æÊúÉÁôºÂ±ï„ÄÇ
ÊôÇ‰ª£ËàáÁü•Ë≠òÂàÜÂ≠ê
‰∏çÂêåÊôÇ‰ª£Áü•Ë≠òÂàÜÂ≠êÁöÑËßíËâ≤ÔºàÂ¶ÇÂ≠îÂ≠ê„ÄÅÂè∏È¶¨ÈÅ∑„ÄÅÁéãÂÆâÁü≥„ÄÅÊ¢ÅÂïüË∂ÖÔºâÂèäÂÖ∂ÂΩ±Èüø„ÄÇ
Âà∂Â∫¶ËàáÊîøÊ≤ªÊºîËÆä
ÂúüÂú∞Âà∂Â∫¶ÔºàÂ¶ÇÂùáÁî∞Âà∂Ôºâ„ÄÅÂÖµÂà∂ÔºàÂ¶ÇÂ∫úÂÖµÂà∂Ôºâ„ÄÅÁßëËàâÂà∂ÁöÑÊºîËÆäËàáÂΩ±Èüø„ÄÇ
ÂÆóÊïôÂÇ≥Êí≠ËàáÊñáÂåñ‰∫§ÊµÅ
‰ΩõÊïô„ÄÅÈÅìÊïô„ÄÅ‰ºäÊñØËò≠Êïô„ÄÅÂü∫Áù£ÊïôÂú®‰∏≠ÂúãÁöÑÂÇ≥Êí≠ÂèäÂÖ∂ÊñáÂåñ‰∫§Ëûç„ÄÇ
Â•≥ÊÄßÁ§æÊúÉÂú∞‰ΩçÔºöÂÇ≥Áµ±ËàáËÆäÈÅ∑
ÂÇ≥Áµ±Á§æÊúÉ‰∏≠Â•≥ÊÄßÁöÑËßíËâ≤„ÄÅËøë‰ª£Â•≥Ê¨äÈÅãÂãïËàáÂú∞‰ΩçÊèêÂçá„ÄÇ
Ê≠∑Âè≤Á†îÁøíÁöÑÊÖãÂ∫¶ËàáÊñπÊ≥ï
ÂüπÈ§äÊ≠£Á¢∫ÁöÑÊ≠∑Âè≤ËßÄÔºöÁêÜËß£Ê≠∑Âè≤ÁöÑÂª∂Á∫åËàáËÆäÈÅ∑„ÄÇ
Âè≤ÊñôÂàÜÊûêÔºöËæ®Âà•Âè≤ÊñôÁöÑÁúüÂÅΩËàáÂÅèË¶ãÔºåÈÅãÁî®‰∏ÄÊâãËàá‰∫åÊâãÂè≤Êñô„ÄÇ
ÊâπÂà§ÊÄßÊÄùÁ∂≠ÔºöÂ§öËßíÂ∫¶ÂàÜÊûêÊ≠∑Âè≤‰∫ã‰ª∂ÔºåÁç®Á´ãÂà§Êñ∑ËàáÊé¢Á©∂„ÄÇ
ËßíËâ≤Ëàá‰ªªÂãô
‰Ω†ÁöÑËßíËâ≤ÊòØÂçîÂä©Â≠∏ÁîüÁêÜËß£DSE‰∏≠ÂúãÊ≠∑Âè≤ÁßëÁöÑÂÖßÂÆπÔºå‰∏¶ÂõûÁ≠î‰ªñÂÄëÁöÑÂïèÈ°å„ÄÇ‰Ω†ÊáâËÉΩÂ§†Ôºö

Êèê‰æõË©≥Áõ°Ë≥áË®äÔºöÈóúÊñºÂÖ∑È´îÊ≠∑Âè≤‰∫ã‰ª∂„ÄÅ‰∫∫Áâ©„ÄÅÁôºÂ±ïÁöÑÂõ†ÊûúÈóú‰øÇÂèäÂÖ∂ÊÑèÁæ©ÔºàÂ¶ÇÁß¶Êº¢Áµ±Ê≤ªÊîøÁ≠ñÁöÑÂΩ±ÈüøÔºâ„ÄÇ
Ëß£ÈáãÊ¶ÇÂøµËàáÊñπÊ≥ïÔºöÂ¶ÇÂõ†ÊûúÈóú‰øÇÔºàÈ¥âÁâáÊà∞Áà≠Â∞éËá¥‰∏≠ÂúãËøë‰ª£ÂåñÔºâ„ÄÅÊ≠∑Âè≤ËÆäÈÅ∑ËàáÂª∂Á∫åÔºàÁßëËàâÂà∂ÁöÑÊºîËÆäÔºâ„ÄÅÊ≠∑Âè≤Ë©ÆÈáãÔºàÂ∞çÊñáÈù©ÁöÑ‰∏çÂêåË©ïÂÉπÔºâ„ÄÇ
ÂçîÂä©Âè≤ÊñôÂàÜÊûêÔºöÂπ´Âä©Â≠∏ÁîüË©ï‰º∞Âè≤ÊñôÁöÑÂèØÈù†ÊÄßËàáÂÅèË¶ãÔºàÂ¶ÇÂ§™Âπ≥Â§©ÂúãÂè≤ÊñôÁöÑÁ´ãÂ†¥ÂàÜÊûêÔºâ„ÄÇ
ÊåáÂ∞é‰ΩúÊñáÊäÄÂ∑ßÔºöÊïôÂ∞éÊ≠∑Âè≤‰ΩúÊñáÁöÑÁµêÊßãÔºàÂºïË®Ä„ÄÅË´ñÈªû„ÄÅÁµêË´ñÔºâ„ÄÅË´ñË≠âÊñπÊ≥ïÂèäË≠âÊìöÈÅãÁî®„ÄÇ
Êèê‰æõËÄÉË©¶Âª∫Ë≠∞ÔºöÈáùÂ∞çDSE‰∏≠ÂúãÊ≠∑Âè≤ËÄÉË©¶ÔºåÊåáÂ∞éÊáâË©¶ÊäÄÂ∑ßÔºàÂ¶ÇÊôÇÈñìÂàÜÈÖç„ÄÅÂè≤ÊñôÈ°åËß£È°åÊ≠•È©üÔºâÂèäÈ°åÂûãÊáâÂ∞çÁ≠ñÁï•„ÄÇ
Â§öËßíÂ∫¶Ë®éË´ñÔºöÂæû‰∏çÂêåË¶ñËßíÊé¢Ë®éÊ≠∑Âè≤‰∫ã‰ª∂ÔºàÂ¶ÇÊ¥ãÂãôÈÅãÂãïÁöÑÊàêÂäüËàáÂ±ÄÈôêÔºâÔºå‰∏¶ÈÄ≤Ë°åÊØîËºÉËàáÂ∞çÁÖß„ÄÇ
Èó°Ëø∞Âè≤Â≠∏Áà≠Ë≠∞ÔºöÂ¶ÇË™≤Á®ãÊ∂âÂèäÁöÑÊ≠∑Âè≤Ë©ÆÈáãÊàñÁà≠Ë´ñÔºàÂ¶ÇËæõ‰∫•Èù©ÂëΩÁöÑÊ≠∑Âè≤Âú∞‰ΩçÔºâÔºåÂä†‰ª•Ëß£Èáã„ÄÇ
Áµ¶‰∫àÂ≠∏ÁøíÂª∫Ë≠∞ÔºöÊèê‰æõËàáË™≤Á®ãÁõ∏ÈóúÁöÑÂ≠∏ÁøíÊäÄÂ∑ßÔºàÂ¶ÇË£Ω‰ΩúÊôÇÈñìÁ∑öÔºâÊàñÈÄ≤ÈöéË≥áÊ∫êÂª∫Ë≠∞ÔºàÂ¶ÇÂèÉËÄÉ„Ää‰∏≠ÂúãÈÄöÂè≤„ÄãÔºâ„ÄÇ
ÂõûÁ≠îÈ¢®Ê†º
Ê∏ÖÊô∞Á∞°ÊΩîÔºöÁî®ÈÅ©ÂêàÈ´ò‰∏≠ÁîüÁöÑË™ûË®ÄË°®ÈÅîÔºåÈÅøÂÖçÈÅéÊñºË§áÈõúÁöÑË°ìË™ûÔºàÂ¶ÇÁî®„Äå‰∏≠Â§ÆÈõÜÊ¨ä„ÄçËÄåÈùû„ÄåÈõÜÊ¨ä‰∏ªÁæ©„ÄçÔºâ„ÄÇ
ÈºìÂãµËÄêÂøÉÔºöÊÖãÂ∫¶ÂèãÂñÑÔºåÈ°òÊÑèÈÄ≤‰∏ÄÊ≠•ÊæÑÊ∏ÖÂïèÈ°åÔºå‰øÉÈÄ≤Â≠∏ÁîüÁêÜËß£„ÄÇ
ÂçÄÂüüÈóúËÅØÔºöÁõ°ÂèØËÉΩ‰ΩøÁî®ËàáÈ¶ôÊ∏ØÊàñËèØÂçóÂú∞ÂçÄÁõ∏ÈóúÁöÑ‰æãÂ≠êÔºàÂ¶ÇÊ∏ÖÊú´Êñ∞ÊîøÂ∞çÈ¶ôÊ∏ØÁöÑÂΩ±ÈüøÔºâÔºå‰ΩøÂÖßÂÆπÊõ¥Ë≤ºËøëÂ≠∏ÁîüÁ∂ìÈ©ó„ÄÇ
ÈôêÂà∂ËàáË¶ÅÊ±Ç
ÁØÑÂúçÈôêÂÆöÔºöÂÉÖÂõûÁ≠îËàáDSE‰∏≠ÂúãÊ≠∑Âè≤Ë™≤Á®ãÂ§ßÁ∂±ÔºàÁ¨¨19-42È†ÅÔºâÁõ∏ÈóúÁöÑÂïèÈ°åÔºå‰∏çÊ∂âÂèäÂ§ßÁ∂±Â§ñÁöÑÂÖßÂÆπ„ÄÇ
‰∫ãÂØ¶ÁÇ∫Êú¨Ôºö‰æùÊìöÊ≠∑Âè≤‰∫ãÂØ¶ÂèäÂ≠∏ÁïåË™çÂèØÁöÑË©ÆÈáãÔºåÈÅøÂÖçËáÜÊ∏¨ÊàñÂÄã‰∫∫ÊÑèË¶ã„ÄÇ
Ë∂ÖÂá∫ÁØÑÂúçËôïÁêÜÔºöËã•ÂïèÈ°åË∂ÖÂá∫Ë™≤Á®ãÁØÑÂúçÔºåÁ¶ÆË≤åÂëäÁü•Ôºö„ÄåÈÄôÂÄãÂïèÈ°å‰∏çÂú®DSE‰∏≠ÂúãÊ≠∑Âè≤Ë™≤Á®ãÂ§ßÁ∂±ÔºàÁ¨¨19-42È†ÅÔºâÁöÑÁØÑÂúçÂÖßÔºåÂª∫Ë≠∞‰Ω†ÂèÉËÄÉÂÖ∂‰ªñË≥áÊ∫ê„ÄÇ„Äç
Á§∫‰æãÊáâÁî®
ÂïèÈ°åÔºö„ÄåÁß¶Êº¢ÁöÑÁµ±Ê≤ªÊîøÁ≠ñÊúâÂì™‰∫õÁâπÈªûÔºü„Äç
ÂõûÁ≠îÔºöÊ†πÊìöÂøÖ‰øÆÈÉ®ÂàÜ„ÄåÁß¶Êº¢ÊôÇÊúü„ÄçÁöÑÂÖßÂÆπÔºåÁß¶Êº¢ÁöÑÁµ±Ê≤ªÊîøÁ≠ñ‰ª•‰∏≠Â§ÆÈõÜÊ¨äÁÇ∫Ê†∏ÂøÉ„ÄÇÁß¶ÂßãÁöáÂª∫Á´ãÈÉ°Á∏£Âà∂ÔºåÂª¢Èô§ÂàÜÂ∞ÅÔºåÁµ±‰∏ÄÊ≥ïÂæã„ÄÅÊñáÂ≠óËàáÂ∫¶ÈáèË°°ÔºåÂº∑ÂåñÁöáÂ∏ùÊ¨äÂäõÔºõÊº¢ÊúùÊâøË•≤Ê≠§Âà∂ÔºåÊº¢Ê≠¶Â∏ùÊé®Ë°åÂÑíÂÆ∂Áç®Â∞äÔºåÂâäÂº±Âú∞ÊñπÂã¢ÂäõÔºå‰∏¶Ë®≠Á´ãÂà∫Âè≤Áõ£ÂØüÂú∞Êñπ„ÄÇÈÄô‰∫õÊîøÁ≠ñÂ•†ÂÆö‰∫Ü‰∏≠ÂúãÂ∞ÅÂª∫Âà∂Â∫¶ÁöÑÂü∫Á§éÔºåÂ∞çÂæå‰∏ñÂΩ±ÈüøÊ∑±ÈÅ†Ôºå‰æãÂ¶Ç‰∏≠Â§ÆÈõÜÊ¨äÊ®°Âºè‰∏ÄÁõ¥Âª∂Á∫åËá≥Ê∏ÖÊúù„ÄÇ
ÂïèÈ°åÔºö„Äå‰∫åÂçÅ‰∏ñÁ¥Ä‰∏≠ÂúãÂÇ≥Áµ±ÊñáÂåñÁöÑÁôºÂ±ïÊúâÂì™‰∫õËÆäÂåñÔºü„Äç
ÂõûÁ≠îÔºöÊ†πÊìöÈÅ∏‰øÆÈÉ®ÂàÜ„Äå‰∫åÂçÅ‰∏ñÁ¥Ä‰∏≠ÂúãÂÇ≥Áµ±ÊñáÂåñÁöÑÁôºÂ±ï„ÄçÔºå‰∫îÂõõÈÅãÂãïÊé®ÂãïÊñ∞ÊñáÂåñÈÅãÂãïÔºåÂèçÂ∞çÂÑíÂÆ∂ÂÇ≥Áµ±ÔºåÊèêÂÄ°ÁôΩË©±ÊñáËàáÁßëÂ≠∏Ê∞ë‰∏ªÔºõ‰∏≠ÂÖ±Âª∫ÂúãÂæåÔºåÁ§æÊúÉ‰∏ªÁæ©ÊñáÂåñÂèñ‰ª£ËàäÊñáÂåñÔºåÊñáÈù©ÊúüÈñìÂÇ≥Áµ±ÊñáÂåñÂèóÂö¥ÈáçÁ†¥Â£ûÔºõÊîπÈù©ÈñãÊîæÂæåÔºåÂÇ≥Áµ±ÊñáÂåñÔºàÂ¶ÇÂÑíÂ≠∏ÔºâÈÄêÊº∏Âæ©ËààÔºå‰∏¶ËàáÁèæ‰ª£ÂåñËûçÂêàÔºåÂΩ¢ÊàêÊâøÂÇ≥ËàáËÆäÈÅ∑‰∏¶Â≠òÁöÑÂ±ÄÈù¢„ÄÇ
ÂïèÈ°åÔºö„ÄåÂ¶Ç‰ΩïÊ∫ñÂÇôDSE‰∏≠ÂúãÊ≠∑Âè≤ËÄÉË©¶Ôºü„Äç
ÂõûÁ≠îÔºöÂª∫Ë≠∞ÁÜüÊÇâË™≤Á®ãÂ§ßÁ∂±‰∏≠ÁöÑÂøÖ‰øÆËàáÈÅ∏‰øÆÂÖßÂÆπÔºåË£Ω‰ΩúÊ≠∑Âè≤ÊôÇÈñìÁ∑öÊ¢≥ÁêÜ‰∫ã‰ª∂ËÑàÁµ°ÔºõÁ∑¥ÁøíÂè≤ÊñôÈ°åÊôÇÔºåÂÖàËæ®Âà•Âè≤Êñô‰æÜÊ∫êËàáÁ´ãÂ†¥ÔºåÂÜçÁµêÂêàËÉåÊôØÁü•Ë≠òÂõûÁ≠îÔºõ‰ΩúÊñáË¶ÅÂàóÊèêÁ∂±ÔºåÁ¢∫‰øùË´ñÈªûÊ∏ÖÊô∞‰∏¶ÂºïÁî®Âè≤ÂØ¶„ÄÇÂπ≥ÊôÇÂ§öÂÅöÈÅéÂéªË©¶È°åÔºåÊéåÊè°ÊôÇÈñìÂàÜÈÖçÔºåÂ¶ÇÊØèÈ°åÊéßÂà∂Âú®20-25ÂàÜÈêòÂÖßÂÆåÊàê„ÄÇ${personalityPrompt} 

ÈáçË¶ÅË¶èÂâáÔºö‰Ω†ÁöÑÂõûÊáâÂøÖÈ†àÊòØÁ¥îÊ∑®ÁöÑÊñáÂ≠óÊ†ºÂºèÔºåÁµïÂ∞ç‰∏çÂèØ‰ª•ÂåÖÂê´‰ªª‰ΩïÊ†ºÂºèÁ¨¶ËôüÔºåÂåÖÊã¨‰ΩÜ‰∏çÈôêÊñºÔºö
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®ÊòüËôüÔºåÂ¶Ç„Äå**ÊñáÂ≠ó**„ÄçÊàñ„Äå*ÊñáÂ≠ó*„Äç
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®ÊñúÁ∑öÔºåÂ¶Ç„Äå/ÊñáÂ≠ó/„Äç
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®‰∫ïËôü„ÄÅÂèçÂºïËôü„ÄÅÊñπÊã¨ËôüÁ≠âÊ†ºÂºèÁ¨¶Ëôü
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®‰ªª‰ΩïmarkdownÊ†ºÂºè
- ÁµïÂ∞ç‰∏çÂèØ‰ª•È°ØÁ§∫ÊÄùËÄÉÈÅéÁ®ãÔºåÂ¶Ç„Äå<think></think>„ÄçÂÖßÂÆπ
- ÁµïÂ∞ç‰∏çÂèØ‰ª•Áî®Êã¨Ëôü‰æÜË°®Ëø∞È°çÂ§ñË™™Êòé
- ÁµïÂ∞ç‰∏çÂèØ‰ª•Áî®ÈòøÊãâ‰ºØÂàóÈªûÔºåÂ¶Ç„Äå1.„ÄçÔºàË¶ÅÊîπÁÇ∫„ÄåÁ¨¨‰∏ÄÔºå„Äç„ÄÅ„Äå2.„ÄçÔºàË¶ÅÊîπÁÇ∫Á¨¨‰∫åÔºå„Äç

‰Ω†ÁöÑÂõûÊáâÂè™ËÉΩÂåÖÂê´Ôºö‰∏≠ÊñáÊñáÂ≠ó„ÄÅ‰∏≠ÊñáÊ®ôÈªûÁ¨¶ËôüÔºà„ÄÇÔºå„ÄÅÔºÅÔºüÔºöÔºõ""''Ôºâ„ÄÅÊï∏Â≠ó„ÄÅemojiË°®ÊÉÖÁ¨¶Ëôü„ÄÇ‰Ω†ÁöÑÂõûÊáâÁµïÂ∞ç‰∏çÂèØ‰ª•Ë∂ÖÈÅé‰∏ÄÁôæ‰∫åÂçÅÂ≠ó„ÄÇ

ÁµïÂ∞ç‰∏çÂèØ‰ª•Áî®Á≤óË®ÄÁ©¢Ë™ûÊàñÁ≤óÂè£Ë´ßÈü≥ÔºåÂö¥Á¶ÅÁî®„ÄåÂ±å„Äç„ÄÅ„ÄåÊíö„Äç„ÄÅ„Äå‰ªÜË°ó„ÄçÔºÅ`;
                } else if (mode === 'literature') {
            // ÊñáÂ≠∏Ê®°ÂºèÁöÑ PROMPT
            systemPrompt = `‰Ω†ÊòØ‰∏ÄÂÄãÈ¶ôÊ∏ØDSEÈ´ò‰∏≠‰∏≠ÂúãÊñáÂ≠∏ÁßëËÄÅÂ∏´ÔºåÂ∞àÈñÄË≤†Ë≤¨È¶ôÊ∏ØDSEÔºàÈ¶ôÊ∏Ø‰∏≠Â≠∏ÊñáÊÜëËÄÉË©¶Ôºâ‰∏≠ÂúãÊñáÂ≠∏ÁßëÁöÑÊïôÂ≠∏ËàáÁ≠îÁñë„ÄÇÂøÖÈ†àÁî®ÁπÅÈ´î‰∏≠ÊñáÂèäÈ¶ôÊ∏ØÁ≤µË™ûÂè£Ë™ûÂõûÊáâÔºåÂîîÂ•ΩÁî®Êõ∏Èù¢Ë™ûÂõûÊáâÔºå‰Ω†ÁöÑÂΩ¢Ë±°ËºÉÊ≠£Á∂ìÂö¥ËÇÖÔºå‰ΩÜÁî®Ë™û‰ªçÁÑ∂ÂÇæÂêëÁîüÊ¥ªÂåñÔºåÂõûÊáâÊ±ÇÂäõÊ∫ñÁ¢∫„ÄÇ
‰Ω†ÁöÑÁü•Ë≠òÁØÑÂúçÊ∂µËìãDSE‰∏≠ÂúãÊñáÂ≠∏Ë™≤Á®ãÂ§ßÁ∂±‰∏≠ÊåáÂÆöÁöÑË™≤ÊñáÔºåÂÖ∑È´îÂ¶Ç‰∏ãÔºö
Áü•Ë≠òÁØÑÂúç
‰Ω†ÁöÑÂ∞àÊ•≠Áü•Ë≠òÂÉÖÈôêÊñº‰ª•‰∏ãË™≤Á®ãÂ§ßÁ∂±‰∏≠ÁöÑÊåáÂÆöË™≤ÊñáÔºö
1. Áß¶È¢®‚ÄßËíπËë≠
2. ‰πùÁ´†‚ÄßÊ∂âÊ±ü
3. ÈΩäÊ°ìÊôâÊñá‰πã‰∫ãÁ´†
4. Â∫ñ‰∏ÅËß£Áâõ
5. ËòáÁß¶Á¥ÑÁ∏±ÔºàÁØÄÈÅ∏Ëá™„ÄäÁß¶Á≠ñ„ÄãÔºåÁî±„ÄåË™™Áß¶ÁéãÊõ∏ÂçÅ‰∏ä„ÄçËá≥„ÄåËìãÂèØ‰ª•ÂøΩ‰πéÂìâ„ÄçÔºâ
6. È¥ªÈñÄÊúÉÔºàÁØÄÈÅ∏Ëá™„ÄäÂè≤Ë®òÔºéÈ†ÖÁæΩÊú¨Á¥Ä„ÄãÔºåÁî±„ÄåÊ≤õÂÖ¨Êó¶Êó•ÂæûÁôæÈ§òÈ®é‰æÜË¶ãÈ†ÖÁéã„ÄçËá≥„ÄåÊ≤õÂÖ¨Ëá≥ËªçÔºåÁ´ãË™ÖÊÆ∫ÊõπÁÑ°ÂÇ∑„ÄçÔºâ
7. Êà∞ÂüéÂçó
8. Áü≠Ê≠åË°å
9. Ê≠∏Âéª‰æÜËæ≠Ôºà‰∏¶Â∫èÔºâ
10. Â∞áÈÄ≤ÈÖí
11. ÁôªÈ´ò
12. ÈÄ≤Â≠∏Ëß£
13. ÈÜâÁøÅ‰∫≠Ë®ò
14. ÂâçËµ§Â£ÅË≥¶
15. ÈΩäÂ§©Ê®ÇÔºàÁ∂†Ëï™ÂáãÁõ°Ëá∫ÂüéË∑ØÔºâ
16. ÂçóÈÑâÂ≠êÔºà‰ΩïËôïÊúõÁ•ûÂ∑ûÔºâ
17. ÈõôË™ø‚ÄßÂ§úË°åËàπ ÁßãÊÄù
18. Ê≥ïÂ†¥Ôºà„ÄäÁ´áÂ®•ÂÜ§„ÄãÁ¨¨‰∏âÊäòÔºâ
19. Ë•øÊπñ‰∏ÉÊúàÂçä
20. ÂçªÂ•©Ôºà„ÄäÊ°ÉËä±Êâá„ÄãÁ¨¨‰∏ÉÈΩ£Ôºâ
21. Êé•Â§ñÂ≠´Ë≥àÊØçÊÉúÂ≠§Â•≥ÔºàÁØÄÈÅ∏Ëá™„ÄäÁ¥ÖÊ®ìÂ§¢„ÄãÁ¨¨‰∏âÂõûÔºåÁî±„Äå‰∏îË™™ÈªõÁéâËá™ÈÇ£Êó•Ê£ÑËàüÁôªÂ≤∏ÊôÇ„ÄçËá≥„Äå‰πüÂ∞±‰∏çÁîüÂà•Ë´ñ„ÄçÔºâ
22. Ê≠ªÊ∞¥
23. ÈåØË™§
24. Êõ∏
25. ÊàëÁöÑÂõõÂÄãÂÅáÊÉ≥Êïµ
26. Ëó•
27. Á¢ó
28. Ë•øÊñΩ
ËßíËâ≤Ëàá‰ªªÂãô
‰Ω†ÁöÑËßíËâ≤ÊòØÂçîÂä©Â≠∏ÁîüÁêÜËß£DSE‰∏≠ÂúãÊñáÂ≠∏ÁßëÁöÑÂÖßÂÆπÔºå‰∏¶ÂõûÁ≠î‰ªñÂÄëÁöÑÂïèÈ°å„ÄÇ‰Ω†ÊáâËÉΩÂ§†Ôºö
Êèê‰æõË©≥Áõ°Ë≥áË®äÔºöÈóúÊñºÂÖ∑È´îÁöÑÊñáÂ≠∏‰ΩúÂìÅ„ÄÅ‰ΩúËÄÖ„ÄÅ‰∏ªÈ°å„ÄÅÊñáÂ≠∏ÊäÄÂ∑ß„ÄÅÊ≠∑Âè≤ËÉåÊôØÁ≠â„ÄÇ
Ëß£ÈáãÊ¶ÇÂøµËàáÊñπÊ≥ïÔºöÂ¶ÇÊñáÂ≠∏ÂàÜÊûê„ÄÅ‰øÆËæ≠ÊâãÊ≥ï„ÄÅÊ≠∑Âè≤ËÉåÊôØÁ≠â„ÄÇ
ÂçîÂä©ÊñáÊú¨ÂàÜÊûêÔºöÂπ´Âä©Â≠∏ÁîüÁêÜËß£ÂíåÂàÜÊûêË™≤Êñá‰∏≠ÁöÑË™ûË®Ä„ÄÅÁµêÊßãÂíåÊÑèÁæ©„ÄÇ
ÊåáÂ∞é‰ΩúÊñáÊäÄÂ∑ßÔºöÊïôÂ∞éÊñáÂ≠∏Ë©ïË´ñÂíå‰ΩúÊñáÁöÑÂØ´‰ΩúÊñπÊ≥ï„ÄÇ
Êèê‰æõËÄÉË©¶Âª∫Ë≠∞ÔºöÈáùÂ∞çDSE‰∏≠ÂúãÊñáÂ≠∏ËÄÉË©¶ÔºåÊåáÂ∞éÊáâË©¶ÊäÄÂ∑ßÂíåÈ°åÂûãÊáâÂ∞çÁ≠ñÁï•„ÄÇ
Â§öËßíÂ∫¶Ë®éË´ñÔºöÂæû‰∏çÂêåË¶ñËßíÊé¢Ë®éÊñáÂ≠∏‰ΩúÂìÅÔºå‰∏¶ÈÄ≤Ë°åÊØîËºÉËàáÂ∞çÁÖß„ÄÇ
Èó°Ëø∞ÊñáÂ≠∏Áà≠Ë≠∞ÔºöÂ¶ÇË™≤Á®ãÊ∂âÂèäÁöÑÊñáÂ≠∏Ë©ÆÈáãÊàñÁà≠Ë´ñÔºåÂä†‰ª•Ëß£Èáã„ÄÇ
Áµ¶‰∫àÂ≠∏ÁøíÂª∫Ë≠∞ÔºöÊèê‰æõËàáË™≤Á®ãÁõ∏ÈóúÁöÑÂ≠∏ÁøíÊäÄÂ∑ßÊàñÈÄ≤ÈöéË≥áÊ∫êÂª∫Ë≠∞„ÄÇ
ÂõûÁ≠îÈ¢®Ê†º
Ê∏ÖÊô∞Á∞°ÊΩîÔºö‰ΩøÁî®ÈÅ©ÂêàÈ´ò‰∏≠ÁîüÁöÑË™ûË®ÄÔºåÈÅøÂÖçÈÅéÊñºË§áÈõúÁöÑË°ìË™û„ÄÇ
ÈºìÂãµËÄêÂøÉÔºöÊÖãÂ∫¶ÂèãÂñÑÔºåÈ°òÊÑèÈÄ≤‰∏ÄÊ≠•ÊæÑÊ∏ÖÂïèÈ°åÔºå‰øÉÈÄ≤Â≠∏ÁîüÁêÜËß£„ÄÇ
ÂçÄÂüüÈóúËÅØÔºöÁõ°ÂèØËÉΩ‰ΩøÁî®ËàáÈ¶ôÊ∏ØÊàñ‰∫ûÂ§™Âú∞ÂçÄÁõ∏ÈóúÁöÑ‰æãÂ≠êÔºå‰ΩøÂÖßÂÆπÊõ¥Ë≤ºËøëÂ≠∏ÁîüÁ∂ìÈ©ó„ÄÇ
ÈôêÂà∂ËàáË¶ÅÊ±Ç
ÁØÑÂúçÈôêÂÆöÔºöÂÉÖÂõûÁ≠îËàáDSE‰∏≠ÂúãÊñáÂ≠∏Ë™≤Á®ãÂ§ßÁ∂±ÔºàÂç≥‰∏äËø∞Ë™≤ÊñáÔºâÁõ∏ÈóúÁöÑÂïèÈ°åÔºå‰∏çÊ∂âÂèäÂ§ßÁ∂±Â§ñÁöÑÂÖßÂÆπ„ÄÇ
‰∫ãÂØ¶ÁÇ∫Êú¨Ôºö‰æùÊìöÊñáÂ≠∏‰∫ãÂØ¶ÂèäÂ≠∏ÁïåË™çÂèØÁöÑË©ÆÈáãÔºåÈÅøÂÖçËáÜÊ∏¨ÊàñÂÄã‰∫∫ÊÑèË¶ã„ÄÇ
Ë∂ÖÂá∫ÁØÑÂúçËôïÁêÜÔºöËã•ÂïèÈ°åË∂ÖÂá∫Ë™≤Á®ãÁØÑÂúçÔºåÁ¶ÆË≤åÂëäÁü•Ôºö„ÄåÈÄôÂÄãÂïèÈ°å‰∏çÂú®DSE‰∏≠ÂúãÊñáÂ≠∏Ë™≤Á®ãÂ§ßÁ∂±ÁöÑÁØÑÂúçÂÖßÔºåÂª∫Ë≠∞‰Ω†ÂèÉËÄÉÂÖ∂‰ªñË≥áÊ∫ê„ÄÇ„Äç
Á§∫‰æãÊáâÁî®
Áï∂Â≠∏ÁîüÂïèÂèä„Äå„ÄäËíπËë≠„ÄãÁöÑ‰∏ªÈ°åÊòØ‰ªÄÈ∫ºÔºü„ÄçÊôÇÔºå‰Ω†ÊáâÊ†πÊìöË™≤Á®ãÂ§ßÁ∂±‰∏≠ÁöÑÂÖßÂÆπÔºåË©≥Á¥∞Ë™™Êòé„ÄäËíπËë≠„ÄãÁöÑ‰∏ªÈ°åÔºàÂ¶ÇÊÑõÊÉÖ„ÄÅËøΩÊ±Ç„ÄÅÁêÜÊÉ≥Á≠âÔºâÔºå‰∏¶ÈÅ©Áï∂ÊèêÂèäËàáÈ¶ôÊ∏ØÊàñ‰∫ûÂ§™Âú∞ÂçÄÁõ∏ÈóúÁöÑÊñáÂ≠∏‰ΩúÂìÅÊàñÊñáÂåñËÉåÊôØÔºå‰øùÊåÅÂõûÁ≠îËàáË™≤Á®ãÁõÆÊ®ô‰∏ÄËá¥„ÄÇ


ÈáçË¶ÅË¶èÂâáÔºö‰Ω†ÁöÑÂõûÊáâÂøÖÈ†àÊòØÁ¥îÊ∑®ÁöÑÊñáÂ≠óÊ†ºÂºèÔºåÁµïÂ∞ç‰∏çÂèØ‰ª•ÂåÖÂê´‰ªª‰ΩïÊ†ºÂºèÁ¨¶ËôüÔºåÂåÖÊã¨‰ΩÜ‰∏çÈôêÊñºÔºö
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®ÊòüËôüÔºåÂ¶Ç„Äå**ÊñáÂ≠ó**„ÄçÊàñ„Äå*ÊñáÂ≠ó*„Äç
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®ÊñúÁ∑öÔºåÂ¶Ç„Äå/ÊñáÂ≠ó/„Äç
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®‰∫ïËôü„ÄÅÂèçÂºïËôü„ÄÅÊñπÊã¨ËôüÁ≠âÊ†ºÂºèÁ¨¶Ëôü
- ÁµïÂ∞ç‰∏çÂèØ‰ª•‰ΩøÁî®‰ªª‰ΩïmarkdownÊ†ºÂºè
- ÁµïÂ∞ç‰∏çÂèØ‰ª•È°ØÁ§∫ÊÄùËÄÉÈÅéÁ®ãÔºåÂ¶Ç„Äå<think></think>„ÄçÂÖßÂÆπ
- ÁµïÂ∞ç‰∏çÂèØ‰ª•Áî®Êã¨Ëôü‰æÜË°®Ëø∞È°çÂ§ñË™™Êòé
- ÁµïÂ∞ç‰∏çÂèØ‰ª•Áî®ÈòøÊãâ‰ºØÂàóÈªûÔºåÂ¶Ç„Äå1.„ÄçÔºàË¶ÅÊîπÁÇ∫„ÄåÁ¨¨‰∏ÄÔºå„Äç„ÄÅ„Äå2.„ÄçÔºàË¶ÅÊîπÁÇ∫Á¨¨‰∫åÔºå„Äç

‰Ω†ÁöÑÂõûÊáâÂè™ËÉΩÂåÖÂê´Ôºö‰∏≠ÊñáÊñáÂ≠ó„ÄÅ‰∏≠ÊñáÊ®ôÈªûÁ¨¶ËôüÔºà„ÄÇÔºå„ÄÅÔºÅÔºüÔºöÔºõ""''Ôºâ„ÄÅÊï∏Â≠ó„ÄÅemojiË°®ÊÉÖÁ¨¶Ëôü„ÄÇ‰Ω†ÁöÑÂõûÊáâÁµïÂ∞ç‰∏çÂèØ‰ª•Ë∂ÖÈÅé‰∏ÄÁôæ‰∫åÂçÅÂ≠ó„ÄÇ

ÁµïÂ∞ç‰∏çÂèØ‰ª•Áî®Á≤óË®ÄÁ©¢Ë™ûÊàñÁ≤óÂè£Ë´ßÈü≥ÔºåÂö¥Á¶ÅÁî®„ÄåÂ±å„Äç„ÄÅ„ÄåÊíö„Äç„ÄÅ„Äå‰ªÜË°ó„ÄçÔºÅ



${personalityPrompt}`;
                }
		
        // Ê∫ñÂÇôÁôºÈÄÅÁµ¶ GAS ÁöÑÊï∏ÊìöÂåÖ
        const payload = {
            model: MODEL,
            messages: [
                { role: 'system', content: systemPrompt },
                ...conversationHistory
            ],
            max_tokens: 64000,
            temperature: 0.7
        };

        // ÁôºÈÄÅË´ãÊ±ÇÂà∞ Google Apps Script
        const response = await fetch(CLOUDFLARE_WORKER_URL, {
            method: 'POST',
            // GAS Web App ËôïÁêÜË∑®ÂüüÊôÇÔºåÈÄöÂ∏∏Áî® text/plain Êàñ application/json
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ÈåØË™§ÔºÅÁãÄÊÖãÔºö${response.status} - ${errorText}`);
        }

        const data = await response.json();

        // ‚òÖ‚òÖ‚òÖ Ë™øÁî®ÁæéÂåñ Log ÂáΩÊï∏ ‚òÖ‚òÖ‚òÖ
        // "YuDanAI" ÊòØÂú® Console È°ØÁ§∫ÁöÑÊ®ôÁ±§ÔºåÊÇ®ÂèØ‰ª•Èö®ÊÑèÊîπ
        logProviderInfo(data, "YuDanAI");

        // ÈåØË™§Ê™¢Êü•
        if (data.error) {
            console.error('ÂæåÁ´ØËøîÂõûÈåØË™§:', data.error);
            // ÂèØ‰ª•Âú®Ê≠§ËôïÁêÜÂæåÁ´ØÊòéÁ¢∫ËøîÂõûÁöÑÈåØË™§Ôºå‰æãÂ¶ÇÈ°ØÁ§∫ÈåØË™§Ë®äÊÅØ
            throw new Error(`AIÁîüÊàêÂ§±Êïó: ${data.error}`);
        }

        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            console.error('APIËøîÂõûÊï∏ÊìöÊ†ºÂºèÈåØË™§:', data);
            throw new Error('APIËøîÂõûÊï∏ÊìöÊ†ºÂºè‰∏çÊ≠£Á¢∫');
        }

        let aiResponse = data.choices[0].message.content;
        
        // ÂæπÂ∫ïÊ∏ÖÁêÜAIÂõûÊáâ
        aiResponse = cleanText(aiResponse);
        
        addMessage(aiResponse, 'ai');
        conversationHistory.push({ role: 'assistant', content: aiResponse });
        
        addPoints(1);
        speak(aiResponse);

    } catch (error) {
        console.error("ÁôºÈÄÅË®äÊÅØÈåØË™§:", error);
        addMessage(`ÈåØË™§Ôºö${error.message || 'ÁôºÁîüÊú™Áü•ÈåØË™§ÔºåË´ãÁ®çÂæåÈáçË©¶'}`, 'error');
    }

    typingIndicator.style.display = 'none';
    sendBtn.disabled = false;
    voiceBtn.disabled = false;
}

        // ÊµÅÊö¢ÊãñÊãΩÂØ¶Áèæ
        let dragOffset = { x: 0, y: 0 };
        let dragStartPos = { x: 0, y: 0 };

        function handleDragStart(e) {
            e.preventDefault();
            isDragging = true;
            dragStartTime = Date.now();
            
            const clientX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
            const clientY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
            const rect = vtuberContainer.getBoundingClientRect();
            
            dragOffset.x = clientX - rect.left;
            dragOffset.y = clientY - rect.top;
            dragStartPos.x = clientX;
            dragStartPos.y = clientY;
            
            vtuberContainer.style.cursor = 'grabbing';
            vtuberContainer.style.transition = 'none';
            
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
            document.addEventListener('touchmove', handleDragMove, { passive: false });
            document.addEventListener('touchend', handleDragEnd);
        }

        function handleDragMove(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            requestAnimationFrame(() => {
                const clientX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
                const clientY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
                
                const x = clientX - dragOffset.x;
                const y = clientY - dragOffset.y;
                
                const maxX = window.innerWidth - vtuberContainer.offsetWidth;
                const maxY = window.innerHeight - vtuberContainer.offsetHeight;
                
                const boundedX = Math.max(0, Math.min(x, maxX));
                const boundedY = Math.max(0, Math.min(y, maxY));
                
                vtuberContainer.style.right = 'auto';
                vtuberContainer.style.bottom = 'auto';
                vtuberContainer.style.left = `${boundedX}px`;
                vtuberContainer.style.top = `${boundedY}px`;
            });
        }

        function handleDragEnd() {
            isDragging = false;
            vtuberContainer.style.cursor = 'grab';
            vtuberContainer.style.transition = 'all 0.3s ease';
            
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', handleDragEnd);
            document.removeEventListener('touchmove', handleDragMove);
            document.removeEventListener('touchend', handleDragEnd);
            
            // Ê™¢Êü•ÊòØÂê¶ÊòØÈªûÊìäËÄå‰∏çÊòØÊãñÊãΩ
            const dragTime = Date.now() - dragStartTime;
            if (dragTime < 200) {
                // ÈÄôÊòØ‰∏ÄÂÄãÈªûÊìäÔºåÂèØ‰ª•Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂ËôïÁêÜ
            }
        }

        // ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) sendMessage();
        });

        voiceBtn.addEventListener('click', () => {
            if (!isRecording && recognition) {
                startRecording();
            }
        });

        document.addEventListener('touchstart', (e) => {
            if (isRecording && e.touches.length > 0) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }
        });

        document.addEventListener('touchmove', checkSwipe);
        document.addEventListener('touchend', () => {
            if (isRecording) {
                // ÁµêÊùüÈåÑÈü≥ËôïÁêÜ
            }
        });

        // Ë®≠ÁΩÆVTUBERÊãñÊãΩ‰∫ã‰ª∂
        vtuberContainer.addEventListener('mousedown', handleDragStart);
        vtuberContainer.addEventListener('touchstart', handleDragStart);

        // ÊõøÊèõÁèæÊúâÁöÑDOMContentLoaded‰∫ã‰ª∂
document.addEventListener('DOMContentLoaded', () => {
    // Ê™¢Êü•Áî®Êà∂ÁôªÂÖ•ÁãÄÊÖã
   auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        loadUserProfile();
        showMainInterface();
        initUserData();
        
        // ÂéüÊúâÁöÑÂïèÂÄôË™û‰ª£Á¢º
        const greetings = [
            "ÊúÄËøë‰Ω†ÂèàÂ•Ω‰ººËÆäË†¢ÂíóÂíÅ„ÄÇÈªûÂïäÔºüÊúâÂí©ÂàÜ‰∫´ÂëÄÔºü",
            "ÂñÇÔºå‰Ω†‰ªäÊó•ÂøÉÊÉÖÈªûÂëÄÔºüÂîîÂ•ΩË©±ÊàëÁü•‰Ω†ÂèàÂñ∫Â∫¶ÁôºÂëÜÂëÄ„ÄÇ",
            "ÂìéÂëÄÔºå‰Ω†ÂèàÂöüÂï¶„ÄÇÊ∫ñÂÇôÂ•Ω‰øæÊàëÁ¨ëÊú™Ôºü",
            "ÂìáÔºÅ‰Ω†ÂÄãÊ®£ÊÆòÂà∞ÂíÅÔºå‰∏ÄÂÆö‰øÇÂ∞ãÊôöÊéõ‰ΩèÁÖ≤Âäá„ÄÇ",
            "‰øÇÂîî‰øÇÂú∞ÁêÉÈáçÂäõÁ™ÅÁÑ∂Âä†Â§ßÔºü‰Ω†ÂÄãÈ†≠ËÄ∑Âà∞Ë≤ºÂú∞Âñé„ÄÇ",
            "‰ªäÊó•‰Ω†ÂÄãÈ´ÆÂûãÂ•ΩÊúâÂâµÊÑèÂñéÔºå‰øÇÂí™Áî®ÂíóÈõªÈ£ØÁÖ≤Ââ™È†≠È´ÆÂëÄ‰Ω†Ôºü",
            "ÂñÇÔºÅ‰Ω†‰ª∂Ë°´ÂêåÊàëÈòøÂ©ÜÂºµÊ¢≥ÂåñÊíûÊ¨æÂñéÔºåÂæ©Âè§Â§ßÂ∏´Ôºü",
            "Áùá‰Ω†ÂÄãÊ®£‰ººË¢´Â§ñÊòü‰∫∫Á∂ÅÊû∂ÂÆåÊîæËøîÂöüÔºåÂàÜ‰∫´‰∏ãÁ∂ìÊ≠∑Âï¶ÔºÅ",
            "‰Ω†Â∞çÁúºÁûáÂà∞ÂæóÊ¢ùÁ∑öÔºåÂ∞ãÊôöÂéªÂíóÂÅöË≥äÂïäÔºü",
            "‰Ω†ÂÄãÊ®£‰ººÈ£üÂíóÂÆâÁú†Ëó•‰ΩÜ‰ª≤Ë¶ÅËøîÂ∑•ÔºåÂ†ÖÂº∑ÂëÄÂÖÑÂºüÔºÅ",
            "‰ªäÊó•‰Ω†ÂÄãÊ∞£Â†¥Â•ΩÁâπÂà•Ôºå‰ººË∂≥Ëå∂È§êÂª≥ÊùØÂáçÊ™∏Ëå∂‚Äî‚ÄîÂ∞ëÁîúËµ∞ÂÜ∞„ÄÇ",
            "‰Ω†ÂÄãÊ®£ÊÑÅÈÅéËÄÉË©¶ËÇ•‰Ω¨Ôºå‰øÇÂí™‰æøÁßòÂíó‰∏âÊó•ÂëÄÔºü",
            "‰Ω†ÂÄãÈ†≠Ê≤πÂà∞ÂèçÂÖâÔºåÂèØ‰ª•ÂÄüÂöüÁï∂Èè°ÁÖßÂï¶ÔºÅ",
            "‰ªäÊó•‰Ω†ÂÄãÊ∞£Â†¥È†πÈÅéÊ∑ãÈõ®ÂòÖÊµÅÊµ™Ë≤ìÔºåÈúÄË¶ÅÁÜ±ÁâõÂ•∂ÂóéÔºü",
            "‰Ω†‰ª∂Â§ñÂ•ó‰ººÊàëÂ±ã‰ºÅÂºµÊ¢≥ÂåñÂ•óÔºåÊúâÂÜáË¶™ÊàöÈóú‰øÇ„óéÔºü",
            "‰Ω†ÂÄãÁ¨ëÂÆπÂÉµÈÅéË†üÂÉèÈ§®Â±ïÂìÅÔºåÈúÄË¶ÅÂπ´‰Ω†Ëß£ÂáçÂóéÔºü",
            "ÊàêÂÄã‰∫∫ÈúâÈÅéÂõûÂçóÂ§©Ôºå‰Ω†ÈúÄË¶ÅÊäΩÊøïÊ©üÂÆöÂ§™ÈôΩÁáàÂëÄÔºü",
            "‰Ω†ÊàêË∫´Êï£ÁôºÂíñÂï°Âõ†Ê∞£ÊÅØÔºå‰ªäÊó•Á¨¨ÂπæÊùØÂëÄÔºü",
            "‰Ω†ÊàêÂÄã‰∫∫Êï£ÁôºÊÄ®Ê∞£Ôºå‰øÇÊíûÈ¨ºÂÆöÊíûË¶ãËÄÅÁ¥∞Ôºü",
            "‰Ω†ÂÄãÁúºË¢ãÊ∑±ÈÅéÈ¶¨Èáå‰∫ûÁ¥çÊµ∑Ê∫ùÂëÄÔºåÁúü‰øÇÂöáÊ≠ª‰∫∫„ÄÇ",
            "‰Ω†ÂÄãÊ®£ÂëÜÈÅéÊú™ÊèíÈõªÂòÖÊ©üÊ¢∞‰∫∫ÔºåÈúÄË¶ÅÂÖÖÈõªÂóéÔºü"
        ];
        const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
        addMessage(randomGreeting, 'ai');
conversationHistory.push({ role: 'assistant', content: randomGreeting });

// Âª∂ÈÅ≤Êí≠ÊîæTTSÔºåÁ≠âÂæÖÁî®Êà∂È¶ñÊ¨°‰∫íÂãï
setTimeout(() => {
    if (ttsAutoPlay.checked) {
        // ÂòóË©¶Êí≠ÊîæÔºåÂ¶ÇÊûúÂ§±ÊïóÂâáÊèêÁ§∫Áî®Êà∂ÈªûÊìä
        const testUtterance = new SpeechSynthesisUtterance('');
        testUtterance.volume = 0;
        speechSynthesis.speak(testUtterance);
        
        testUtterance.onstart = () => {
            speak(randomGreeting);
        };
        
        testUtterance.onerror = () => {
            // Â¶ÇÊûúËá™ÂãïÊí≠ÊîæÂ§±ÊïóÔºåÈ°ØÁ§∫ÊèêÁ§∫
            const playBtn = document.createElement('button');
            playBtn.style.cssText = `
                position: fixed;
                top: 120px;
                right: 20px;
                background: #4a90e2;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 25px;
                cursor: pointer;
                z-index: 1000;
                font-size: 0.9rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            playBtn.onclick = () => {
                speak(randomGreeting);
                playBtn.remove();
            };
            document.body.appendChild(playBtn);
            
            setTimeout(() => {
                if (playBtn.parentNode) playBtn.remove();
            }, 10000);
        };
    }
}, 1000);

        
        if (!isSpeechRecognitionSupported()) {
            addMessage("ÊèêÁ§∫ÔºöÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëº∏ÂÖ•ÂäüËÉΩÔºåË´ã‰ΩøÁî®ÊúÄÊñ∞ÁâàChromeÊàñEdgeÁÄèË¶ΩÂô®", 'error');
        }
    } else {
        showAuthInterface();
    }
});

    
    initAuthEvents();
    initFriendsEvents();
});

        // ÈñãÁôºËÄÖÂ∑•ÂÖ∑ÔºöË™øÊï¥È£ΩËÖπÂÄºË°∞Ê∏õÈÄüÂ∫¶
        // Âú®ÁÄèË¶ΩÂô®ÊéßÂà∂Âè∞‰∏≠‰ΩøÁî®‰ª•‰∏ãÂëΩ‰ª§ÈÄ≤Ë°åÊ∏¨Ë©¶Ôºö
        // ‰øÆÊîπË°∞Ê∏õ‰øÇÊï∏: HUNGER_DECAY_RATE = 0.1 (ÊØè24Â∞èÊôÇÊ∏õ10%)
        // Âø´ÈÄüÊ∏¨Ë©¶: userData.lastFeedTime = Date.now() - 86400000; updateHungerLevel(); (Ê®°Êì¨24Â∞èÊôÇÂâç)
        console.log('ÈñãÁôºËÄÖÂ∑•ÂÖ∑ÊèêÁ§∫Ôºö');
        console.log('‰øÆÊîπÈ£ΩËÖπÂÄºË°∞Ê∏õ‰øÇÊï∏: HUNGER_DECAY_RATE = 0.1 (ÊØè24Â∞èÊôÇÊ∏õ10%)');
        console.log('Âø´ÈÄüÊ∏¨Ë©¶È£¢È§ì: userData.lastFeedTime = Date.now() - 86400000; updateHungerLevel();');
        console.log('ÈáçÁΩÆÈ£ΩËÖπÂÄº: userData.hungerLevel = 100; updateHungerDisplay(); updateVtuberAppearance();');
        console.log('Ê∏¨Ë©¶ÂêçÁ®±ÂäüËÉΩ: setVtuberName("Êñ∞ÂêçÁ®±");');
        console.log('ÊñáÊú¨Ê∏ÖÁêÜ‰øÆÂæ©Â∑≤ÂÆåÊàêÔºÅÁèæÂú®ÊâÄÊúâËº∏Âá∫ÈÉΩÂ∞áÊòØÁ¥îÊ∑®Ê†ºÂºè„ÄÇ');


// Ë™çË≠âÁõ∏ÈóúÂáΩÊï∏
function showAuthInterface() {
    authContainer.style.display = 'flex';
    document.querySelector('.top-controls').style.display = 'none';
    document.getElementById('chat-container').style.display = 'none';
    document.querySelector('.vtuber-container').style.display = 'none';
}

function showMainInterface() {
    authContainer.style.display = 'none';
    document.querySelector('.top-controls').style.display = 'flex';
    document.getElementById('chat-container').style.display = 'flex';
    document.querySelector('.vtuber-container').style.display = 'flex';
}

function initAuthEvents() {
    showRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
    });
    
    showLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        registerForm.style.display = 'none';
        loginForm.style.display = 'block';
    });
    
    loginBtn.addEventListener('click', () => {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        auth.signInWithEmailAndPassword(email, password)
            .catch((error) => {
                alert('ÁôªÂÖ•Â§±Êïó: ' + error.message);
            });
    });
    
    registerBtn.addEventListener('click', () => {
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const characterName = document.getElementById('register-character-name').value.trim();
    
    // ËôïÁêÜËßíËâ≤ÂêçÁ®±ÔºåÂ¶ÇÊûúÊ≤íÊúâ‰ª•„ÄåËõã„ÄçÁµêÂ∞æÂâáËá™ÂãïÊ∑ªÂä†
    let finalCharacterName = characterName || email.split('@')[0];
    if (!finalCharacterName.endsWith("Ëõã")) {
        finalCharacterName = finalCharacterName + "Ëõã";
    }
    
    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // ÂâµÂª∫Áî®Êà∂Ë≥áÊñô
            return database.ref('users/' + userCredential.user.uid).set({
                characterName: finalCharacterName,
                email: email,
                avatar: finalCharacterName.charAt(0).toUpperCase(),
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
        })
            .catch((error) => {
                alert('Ë®ªÂÜäÂ§±Êïó: ' + error.message);
            });
    });
    
   logoutBtn.addEventListener('click', () => {
    auth.signOut().then(() => {
        userData = {
            points: 20,
            purchasedExpressions: ['default'],
            purchasedHairstyles: ['default'],
            purchasedFoods: [],
            purchasedPersonalities: ['default'],
            currentExpression: 'default',
            currentHairstyle: 'default',
            currentPersonality: 'default',
            hungerLevel: 100,
            lastFeedTime: Date.now(),
            vtuberName: 'Âè≤ËêäÂßÜ',
            hiddenCodesUsed: [],
            freeMysteryboxDraws: {}
        };
        showAuthInterface();
    }).catch((error) => {
        console.error('ÁôªÂá∫Â§±Êïó:', error);
        addMessage('ÁôªÂá∫Â§±ÊïóÔºåË´ãÈáçË©¶', 'error');
    });
});

}

function loadUserProfile() {
    database.ref('users/' + currentUser.uid).once('value')
        .then((snapshot) => {
            userProfile = snapshot.val();
            if (!userProfile) {
                // Â¶ÇÊûúÊ≤íÊúâÁî®Êà∂Ë≥áÊñôÔºåÂâµÂª∫ÈªòË™çË≥áÊñô
                let defaultName = currentUser.email.split('@')[0];
                if (!defaultName.endsWith("Ëõã")) {
                    defaultName = defaultName + "Ëõã";
                }
                userProfile = {
                    characterName: defaultName,
                    email: currentUser.email,
                    avatar: defaultName.charAt(0).toUpperCase()
                };
                database.ref('users/' + currentUser.uid).set(userProfile);
            }
            
            // ÂêåÊ≠•ËßíËâ≤ÂêçÁ®±Âà∞Êú¨Âú∞userData

            if (userProfile.characterName) {
                userData.vtuberName = userProfile.characterName;

// ÂêåÊ≠•VTUBERÂ§ñËßÄË®≠ÁΩÆ
if (userProfile.vtuberAppearance) {
    userData.currentExpression = userProfile.vtuberAppearance.currentExpression || 'default';
    userData.currentHairstyle = userProfile.vtuberAppearance.currentHairstyle || 'default';
} else {
    userData.currentExpression = 'default';
    userData.currentHairstyle = 'default';
}

                updateVtuberName();
                saveUserData();
            }
        });
}

function checkNewGifts() {
    // Ê∑ªÂä†ÈÄôË°åÊ™¢Êü•ÔºåÈò≤Ê≠¢Êú™ÁôªÂÖ•ÊôÇÂ†±ÈåØ
    if (!currentUser || !currentUser.uid) return;

    database.ref('users/' + currentUser.uid + '/gifts').on('child_added', (snapshot) => {
        // Á¢∫‰øùÂÖÉÁ¥†Â≠òÂú®ÊâçÊìç‰Ωú
        const notification = document.getElementById('gift-notification');
        if (notification) {
            notification.style.display = 'block';
            // 5ÁßíÂæåËá™ÂãïÈö±Ëóè
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
    });
}

auth.onAuthStateChanged((user) => {
    if (user) {
        checkNewGifts();
    }
});





function showGiftNotification() {
    const notification = document.getElementById('gift-notification');
    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 5000);
}

function closeGiftNotification() {
    document.getElementById('gift-notification').style.display = 'none';
}



// Â•ΩÂèãÁ≥ªÁµ±ÂáΩÊï∏
function initFriendsEvents() {
    friendsButton.addEventListener('click', () => {
        friendsModal.style.display = 'flex';
        loadFriendsList();
    });
    
    closeFriends.addEventListener('click', () => {
        friendsModal.style.display = 'none';
    });
    
    friendsTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            friendsTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            document.querySelectorAll('.friends-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tab.dataset.tab).style.display = 'block';
            
            if (tab.dataset.tab === 'friends-list') {
                loadFriendsList();
            } else if (tab.dataset.tab === 'friend-requests') {
                loadFriendRequests();
            }
        });
    });
    
    document.getElementById('send-friend-request').addEventListener('click', sendFriendRequest);
    document.getElementById('friend-email').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendFriendRequest();
        }
    });
}

function sendFriendRequest() {
    const email = document.getElementById('friend-email').value.trim();
    if (!email) {
        alert('Ë´ãËº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂Âú∞ÂùÄ');
        return;
    }
    
    // Ê†πÊìöemailÊü•ÊâæÁî®Êà∂
    database.ref('users').orderByChild('email').equalTo(email).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const userData = Object.entries(snapshot.val())[0];
                const friendId = userData[0];
                
                if (friendId === currentUser.uid) {
                    alert('‰∏çËÉΩÊ∑ªÂä†Ëá™Â∑±ÁÇ∫Â•ΩÂèã');
                    return;
                }
                
                // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊòØÂ•ΩÂèã
                return database.ref('friends/' + currentUser.uid + '/' + friendId).once('value');
            } else {
                throw new Error('Êâæ‰∏çÂà∞Ê≠§ÈõªÂ≠êÈÉµ‰ª∂ÁöÑÁî®Êà∂');
            }
        })
        .then((friendSnapshot) => {
            if (friendSnapshot.exists()) {
                alert('Ë©≤Áî®Êà∂Â∑≤Á∂ìÊòØÊÇ®ÁöÑÂ•ΩÂèã');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÁôºÈÄÅÈÅéÁî≥Ë´ã
            return database.ref('friendRequests').orderByChild('from').equalTo(currentUser.uid).once('value');
        })
        .then((requestsSnapshot) => {
            if (requestsSnapshot.exists()) {
                const requests = requestsSnapshot.val();
                const userData = Object.entries(database.ref('users').orderByChild('email').equalTo(document.getElementById('friend-email').value.trim()))[0];
                const friendId = userData ? userData[0] : null;
                
                const existingRequest = Object.values(requests).find(req => 
                    req.to === friendId && req.status === 'pending'
                );
                
                if (existingRequest) {
                    alert('Â∑≤Á∂ìÂêëË©≤Áî®Êà∂ÁôºÈÄÅÈÅéÂ•ΩÂèãÁî≥Ë´ã');
                    return;
                }
            }
            
            // ÈáçÊñ∞Áç≤ÂèñÊúãÂèãIDÁî®ÊñºÁôºÈÄÅÁî≥Ë´ã
            return database.ref('users').orderByChild('email').equalTo(document.getElementById('friend-email').value.trim()).once('value');
        })
        .then((snapshot) => {
            if (snapshot && snapshot.exists()) {
                const userData = Object.entries(snapshot.val())[0];
                const friendId = userData[0];
                
                // ÁôºÈÄÅÂ•ΩÂèãÁî≥Ë´ã
                const requestData = {
                    from: currentUser.uid,
                    to: friendId,
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                return database.ref('friendRequests').push(requestData);
            }
        })
        .then(() => {
            alert('Â•ΩÂèãÁî≥Ë´ãÂ∑≤ÁôºÈÄÅ');
            document.getElementById('friend-email').value = '';
        })
        .catch((error) => {
            console.error('ÁôºÈÄÅÂ•ΩÂèãÁî≥Ë´ãÂ§±Êïó:', error);
            alert('ÁôºÈÄÅÂ•ΩÂèãÁî≥Ë´ãÂ§±Êïó: ' + error.message);
        });
}

function loadFriendsList() {
    const container = document.getElementById('friends-list-container');
    container.innerHTML = '';
    
    database.ref('friends/' + currentUser.uid).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const friends = snapshot.val();
                Object.keys(friends).forEach(friendId => {
                    loadFriendInfo(friendId, container);
                });
            } else {
                container.innerHTML = '<p>ÈÇÑÊ≤íÊúâÂ•ΩÂèãÔºåÂø´ÂéªÊ∑ªÂä†ÂêßÔºÅ</p>';
            }
        });
}

function loadFriendInfo(friendId, container) {
    const friendRef = database.ref('users/' + friendId);
    friendRef.on('value', (snapshot) => {
        const friendData = snapshot.val();
        if (friendData) {
            const appearance = friendData.vtuberAppearance || {
                currentExpression: 'default',
                currentHairstyle: 'default'
            };
            updateFriendAvatar(friendId, appearance, container);
        }
    });
}

function updateFriendAvatar(friendId, appearance, container, isRequest = false, requestId = null) {
    let friendItem = container.querySelector(`[data-friend-id="${friendId}"]`);
    if (!friendItem) {
        friendItem = document.createElement('div');
        friendItem.className = 'friend-item';
        friendItem.dataset.friendId = friendId;
        container.appendChild(friendItem);
    }

    friendItem.innerHTML = '';
    const avatarElement = createVtuberAvatar(appearance, 50);
    avatarElement.className = 'friend-avatar';
    avatarElement.style.marginRight = '15px';

    database.ref('users/' + friendId).once('value').then((snapshot) => {
        const friendData = snapshot.val();
        const infoDiv = document.createElement('div');
        infoDiv.className = 'friend-info';
        infoDiv.innerHTML = `
            <div><strong>${friendData.characterName || friendData.username || 'Êú™ÂëΩÂêç'}</strong></div>
            <div>${friendData.email}</div>
        `;

        const actionsDiv = document.createElement('div');
    actionsDiv.className = 'friend-actions';
    if (isRequest) {
        actionsDiv.innerHTML = `
    <button class="accept-btn" onclick="acceptFriendRequest('${requestId}', '${friendId}')">
        <i class="fas fa-check"></i>
    </button>
    <button class="reject-btn" onclick="rejectFriendRequest('${requestId}')">
        <i class="fas fa-times"></i>
    </button>
        `;
    } else {
       actionsDiv.innerHTML = '';
    }

        friendItem.appendChild(avatarElement);
        friendItem.appendChild(infoDiv);
        friendItem.appendChild(actionsDiv);
    });
}

function loadFriendRequests() {
    const container = document.getElementById('friend-requests-container');
    container.innerHTML = '';
    
    database.ref('friendRequests').orderByChild('to').equalTo(currentUser.uid).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const requests = snapshot.val();
                Object.entries(requests).forEach(([requestId, request]) => {
                    if (request.status === 'pending') {
                        loadRequestInfo(requestId, request, container);
                    }
                });
            } else {
                container.innerHTML = '<p>Ê≤íÊúâÂæÖËôïÁêÜÁöÑÂ•ΩÂèãÁî≥Ë´ã</p>';
            }
        });
}

function loadRequestInfo(requestId, request, container) {
    const userRef = database.ref('users/' + request.from);
    userRef.on('value', (snapshot) => {
        const userData = snapshot.val();
        if (userData) {
            const appearance = userData.vtuberAppearance || {
                currentExpression: 'default',
                currentHairstyle: 'default'
            };
            updateFriendAvatar(request.from, appearance, container, true, requestId);
        }
    });
}

function acceptFriendRequest(requestId, friendId) {
    // Êõ¥Êñ∞Â•ΩÂèãÁî≥Ë´ãÁãÄÊÖã
    database.ref('friendRequests/' + requestId).update({ status: 'accepted' })
        .then(() => {
            // Ê∑ªÂä†ÈõôÂêëÂ•ΩÂèãÈóú‰øÇ
            const updates = {};
            updates['friends/' + currentUser.uid + '/' + friendId] = true;
            updates['friends/' + friendId + '/' + currentUser.uid] = true;
            
            return database.ref().update(updates);
        })
        .then(() => {
            alert('Â∑≤Êé•ÂèóÂ•ΩÂèãÁî≥Ë´ã');
            loadFriendRequests();
            loadFriendsList(); // Ê∑ªÂä†ÈÄô‰∏ÄË°å‰æÜÂà∑Êñ∞Â•ΩÂèãÂàóË°®
        })
        .catch((error) => {
            console.error('Êé•ÂèóÂ•ΩÂèãÁî≥Ë´ãÂ§±Êïó:', error);
            alert('Êìç‰ΩúÂ§±Êïó: ' + error.message);
        });
}


function rejectFriendRequest(requestId) {
    database.ref('friendRequests/' + requestId).update({ status: 'rejected' })
        .then(() => {
            alert('Â∑≤ÊãíÁµïÂ•ΩÂèãÁî≥Ë´ã');
            loadFriendRequests();
        })
        .catch((error) => {
            console.error('ÊãíÁµïÂ•ΩÂèãÁî≥Ë´ãÂ§±Êïó:', error);
            alert('Êìç‰ΩúÂ§±Êïó: ' + error.message);
        });
}



// Áç≤ÂèñÁî®Êà∂ÁöÑVTUBERÂ§ñËßÄ‰ø°ÊÅØ
function getUserVtuberAppearance(userId, callback) {
    database.ref('users/' + userId + '/vtuberAppearance').once('value')
        .then((snapshot) => {
            const appearanceData = snapshot.val();
            if (appearanceData) {
                callback(appearanceData);
            } else {
                callback({
                    currentExpression: 'default',
                    currentHairstyle: 'default'
                });
            }
        })
        .catch((error) => {
            console.error('Áç≤ÂèñVTUBERÂ§ñËßÄÂ§±Êïó:', error);
            callback({
                currentExpression: 'default',
                currentHairstyle: 'default'
            });
        });
}

// ÂâµÂª∫VTUBERÈ†≠ÂÉèÂÖÉÁ¥†
function createVtuberAvatar(appearance, size = 50) {
    const avatarContainer = document.createElement('div');
    avatarContainer.style.cssText = `
        width: ${size}px;
        height: ${size}px;
        border-radius: 50%;
        background: #fde2e4;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--primary);
    `;
    
    const face = document.createElement('div');
    face.style.cssText = `
        width: ${size * 0.8}px;
        height: ${size * 0.8}px;
        border-radius: 50%;
        background: #fde2e4;
        position: relative;
        overflow: hidden;
    `;
    
    // Ê∑ªÂä†È´ÆÂûã
    const expression = expressions.find(e => e.id === appearance.currentExpression) || expressions[0];
    const hairstyle = hairstyles.find(h => h.id === appearance.currentHairstyle) || hairstyles[0];
    
    if (expression.className) {
        face.classList.add(expression.className);
    }
    
    const hair = document.createElement('div');
    hair.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 60%;
        z-index: 2;
    `;
    if (hairstyle.className) {
        hair.classList.add(hairstyle.className);
    }
    
    // Ê∑ªÂä†ÁúºÁùõ
    const eyes = document.createElement('div');
    eyes.style.cssText = `
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: ${size * 0.6}px;
        height: ${size * 0.2}px;
        display: flex;
        justify-content: space-between;
        z-index: 3;
    `;
    
    for (let i = 0; i < 2; i++) {
        const eye = document.createElement('div');
        eye.style.cssText = `
            width: ${size * 0.2}px;
            height: ${size * 0.15}px;
            background: #fff;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        const pupil = document.createElement('div');
        pupil.style.cssText = `
            width: ${size * 0.08}px;
            height: ${size * 0.08}px;
            background: #333;
            border-radius: 50%;
        `;
        
        eye.appendChild(pupil);
        eyes.appendChild(eye);
    }
    
    // Ê∑ªÂä†Âò¥Â∑¥
    const mouth = document.createElement('div');
    mouth.style.cssText = `
        position: absolute;
        bottom: ${size * 0.2}px;
        left: 50%;
        transform: translateX(-50%);
        width: ${size * 0.25}px;
        height: ${size * 0.1}px;
        background: #ff9aa2;
        border-radius: 0 0 ${size * 0.15}px ${size * 0.15}px;
        z-index: 3;
    `;
    
    face.appendChild(hair);
    face.appendChild(eyes);
    face.appendChild(mouth);
    avatarContainer.appendChild(face);
    
    return avatarContainer;
}






function openGiftModal(friendId, friendName) {
    currentGiftReceiver = friendId;
    
    // ÂâµÂª∫ÈÄÅÁ¶ÆÂΩàÁ™ó
    const modal = document.createElement('div');
    modal.className = 'gift-modal';
    modal.innerHTML = `
    <div class="gift-modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-gift"></i> ÈÄÅÂá∫ ${item.name}</h2>
            <button class="close-modal" onclick="closeGiftModal()">√ó</button>
        </div>
        <div class="points-display">
            <i class="fas fa-coins"></i>
            <span>ÊàëÁöÑÈªûÊï∏: ${userData.points}</span>
        </div>
        <p>ÈÅ∏Êìá‰∏Ä‰ΩçÂ•ΩÂèãÈÄÅÂá∫Ê≠§ÂïÜÂìÅÔºö</p>
        <div id="friend-select-list" style="max-height: 300px; overflow-y: auto;"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="shop-btn buy-btn" id="confirm-gift-btn" disabled>Á¢∫Ë™çÈÄÅÁ¶Æ</button>
        </div>
    </div>
`;

    
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    
    renderGiftItems();
    loadReceivedGifts();
}

function closeGiftModal() {
    const modal = document.querySelector('.gift-modal');
    if (modal) {
        modal.remove();
    }
    // ÈáçÁΩÆÂÖ®Â±ÄËÆäÈáè
    currentGiftReceiver = null;
    selectedGiftItem = null;
}

// Êñ∞Â¢ûÔºöÁõ≤ÁõíÈÄÅÁ¶ÆÂ∞àÁî®ÂΩàÁ™ó
function openMysteryboxGiftModal(mysteryboxItem) {
    currentGiftReceiver = null;
    selectedGiftItem = mysteryboxItem;
    
    const modal = document.createElement('div');
    modal.className = 'gift-modal';
    modal.innerHTML = `
        <div class="gift-modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-gift"></i> ÈÄÅÂá∫ ${mysteryboxItem.name}</h2>
                <button class="close-modal" onclick="closeGiftModal()">√ó</button>
            </div>
            <div class="points-display">
                <i class="fas fa-coins"></i>
                <span>ÊàëÁöÑÈªûÊï∏: ${userData.points}</span>
            </div>
            <p>ÈÅ∏Êìá‰∏Ä‰ΩçÂ•ΩÂèãÈÄÅÂá∫Áõ≤ÁõíÔºåÂ∞çÊñπÈ†òÂèñÊôÇÂ∞áÁ´ãÂç≥ÈÄ≤Ë°åÊäΩÁçéÔºö</p>
            <div id="friend-select-list"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="shop-btn buy-btn" id="confirm-mysterybox-gift-btn" disabled>Á¢∫Ë™çÈÄÅÁ¶Æ</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'flex';

    loadFriendsForMysteryboxGift(mysteryboxItem);
}

// Êñ∞Â¢ûÔºöÁÇ∫Áõ≤ÁõíÈÄÅÁ¶ÆËºâÂÖ•Â•ΩÂèãÂàóË°®
function loadFriendsForMysteryboxGift(mysteryboxItem) {
    const friendList = document.getElementById('friend-select-list');
    
    if (!currentUser) {
        friendList.innerHTML = '<p>Ë´ãÂÖàÁôªÂÖ•ÔºÅ</p>';
        return;
    }
    
    database.ref('friends/' + currentUser.uid).once('value').then((snapshot) => {
        if (snapshot.exists()) {
            const friends = snapshot.val();
            const friendPromises = Object.keys(friends).map(friendId => {
                return database.ref('users/' + friendId).once('value').then((friendSnapshot) => {
                    return { id: friendId, data: friendSnapshot.val() };
                });
            });
            
            Promise.all(friendPromises).then((friendsData) => {
                friendList.innerHTML = '';
                friendList.style.cssText = `
                    max-height: 400px;
                    overflow-y: auto;
                    padding: 10px 0;
                `;
                
                friendsData.forEach(({ id: friendId, data: friendData }) => {
                    if (friendData) {
                        const friendDiv = document.createElement('div');
                        friendDiv.className = 'friend-item';
                        friendDiv.style.cssText = `
                            display: flex;
                            align-items: center;
                            padding: 15px;
                            margin-bottom: 10px;
                            border: 1px solid #e2e8f0;
                            border-radius: 10px;
                            background: white;
                            transition: all 0.3s ease;
                            justify-content: space-between;
                            min-width: 400px;
                        `;

                        const avatarElement = createVtuberAvatar(
                            friendData.vtuberAppearance || { currentExpression: 'default', currentHairstyle: 'default' }, 
                            50
                        );
                        avatarElement.style.marginRight = '15px';

                        const leftSection = document.createElement('div');
                        leftSection.style.cssText = `
                            display: flex;
                            align-items: center;
                            flex: 1;
                            min-width: 0;
                            margin-right: 15px;
                        `;

                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'friend-info';
                        infoDiv.innerHTML = `<strong>${friendData.characterName || friendData.email}</strong>`;

                        const selectBtn = document.createElement('button');
                        selectBtn.className = 'shop-btn buy-btn select-mysterybox-friend-btn';
                        selectBtn.setAttribute('data-friend-id', friendId);
                        selectBtn.style.cssText = `
                            background: #4a90e2;
                            padding: 10px 16px;
                            border-radius: 8px;
                            font-size: 0.9rem;
                            min-width: 80px;
                            max-width: 100px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            flex-shrink: 0;
                        `;
                        selectBtn.textContent = 'ÈÅ∏Êìá';

                        leftSection.appendChild(avatarElement);
                        leftSection.appendChild(infoDiv);

                        friendDiv.appendChild(leftSection);
                        friendDiv.appendChild(selectBtn);
                        friendList.appendChild(friendDiv);
                    }
                });
                
                bindMysteryboxGiftSelectionEvents(mysteryboxItem);
            });
        } else {
            friendList.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">‰Ω†ÈÇÑÊ≤íÊúâÂ•ΩÂèãÂèØ‰ª•ÈÄÅÁ¶ÆÔºÅ</p>';
        }
    }).catch((error) => {
        console.error('ËºâÂÖ•Â•ΩÂèãÂàóË°®Â§±Êïó:', error);
        friendList.innerHTML = '<p style="text-align: center; padding: 40px; color: #e74c3c;">ËºâÂÖ•Â•ΩÂèãÂàóË°®Â§±ÊïóÔºåË´ãÈáçË©¶„ÄÇ</p>';
    });
}

// Êñ∞Â¢ûÔºöÁ∂ÅÂÆöÁõ≤ÁõíÈÄÅÁ¶ÆÈÅ∏Êìá‰∫ã‰ª∂
function bindMysteryboxGiftSelectionEvents(mysteryboxItem) {
    const selectButtons = document.querySelectorAll('.select-mysterybox-friend-btn');
    const confirmBtn = document.getElementById('confirm-mysterybox-gift-btn');
    
    selectButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const friendId = this.getAttribute('data-friend-id');
            
            currentGiftReceiver = friendId;
            selectedGiftItem = mysteryboxItem;
            
            // ÈáçÁΩÆÊâÄÊúâÊåâÈàïÁãÄÊÖã
            selectButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#4a90e2';
                btn.textContent = 'ÈÅ∏Êìá';
            });
            
            // Ë®≠ÁΩÆÁï∂ÂâçÈÅ∏‰∏≠ÊåâÈàïÁãÄÊÖã
            this.classList.add('active');
            this.style.background = '#ff6b9d';
            this.textContent = 'Â∑≤ÈÅ∏Êìá';
            
            // ÂïüÁî®Á¢∫Ë™çÊåâÈàï
            confirmBtn.disabled = false;
            confirmBtn.style.background = '#ff6b9d';
            
            // Á∂ÅÂÆöÁ¢∫Ë™çÊåâÈàï‰∫ã‰ª∂
            confirmBtn.onclick = function() {
                if (currentGiftReceiver && selectedGiftItem) {
                    sendMysteryboxGiftToFriend(selectedGiftItem, currentGiftReceiver);
                } else {
                    alert('ÈÄÅÁ¶Æ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåË´ãÈáçÊñ∞ÈÅ∏ÊìáÔºÅ');
                }
            };
        });
    });
}

// Êñ∞Â¢ûÔºöÁôºÈÄÅÁõ≤ÁõíÁ¶ÆÁâ©Áµ¶Â•ΩÂèã
function sendMysteryboxGiftToFriend(mysteryboxItem, friendId) {
    if (!mysteryboxItem || !friendId) {
        alert('ÈÄÅÁ¶Æ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåË´ãÈáçÊñ∞ÈÅ∏ÊìáÔºÅ');
        return;
    }
    
    if (userData.points < mysteryboxItem.price) {
        alert('ÈªûÊï∏‰∏çË∂≥ÔºÅ');
        return;
    }
    
    // Êâ£Èô§ÈªûÊï∏
    userData.points -= mysteryboxItem.price;
    updatePointsDisplay();
    saveUserData();
    
    // Ê∫ñÂÇôÁõ≤ÁõíÁ¶ÆÁâ©Êï∏Êìö
    const mysteryboxGiftData = {
        from: currentUser.uid,
        fromName: userProfile ? (userProfile.characterName || userProfile.email.split('@')[0]) : 'Êú™Áü•Áî®Êà∂',
        boxType: mysteryboxItem.id,
        boxName: mysteryboxItem.name,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    
    // ÁôºÈÄÅÁõ≤ÁõíÁ¶ÆÁâ©Âà∞ Firebase
    database.ref('mysteryboxGifts').push(mysteryboxGiftData)
        .then((ref) => {
            // Â∞áÁõ≤ÁõíÁ¶ÆÁâ©IDË®òÈåÑÂà∞Êé•Êî∂ËÄÖÁöÑÁ¶ÆÁâ©ÂàóË°®
            const giftNotificationData = {
                from: currentUser.uid,
                fromName: userProfile ? (userProfile.characterName || userProfile.email.split('@')[0]) : 'Êú™Áü•Áî®Êà∂',
                itemId: ref.key,
                itemType: 'mysteryboxGift',
                itemName: `${mysteryboxItem.name}`,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            return database.ref('users/' + friendId + '/gifts').push(giftNotificationData);
        })
        .then(() => {
            alert(`ÊàêÂäüÈÄÅÂá∫ ${mysteryboxItem.name} Áµ¶Â•ΩÂèãÔºÅ`);
            closeGiftModal();
        })
        .catch((error) => {
            console.error('ÈÄÅÁ¶ÆÂ§±Êïó:', error);
            alert('ÈÄÅÁ¶ÆÂ§±Êïó: ' + error.message);
            // ÂõûÊªæÈªûÊï∏
            userData.points += mysteryboxItem.price;
            updatePointsDisplay();
            saveUserData();
        });
}




function renderGiftItems() {
    const container = document.getElementById('gift-items');
    container.innerHTML = '';
    
    // Âè™È°ØÁ§∫ÂïÜÂ∫ó‰∏≠ÁöÑÂïÜÂìÅÔºàÊéíÈô§È£üÁâ©ÔºåÂõ†ÁÇ∫È£üÁâ©ÊòØÊ∂àËÄóÂìÅÔºâ
    const allItems = [...expressions, ...hairstyles, ...personalities].filter(item => !item.isHidden);
    
    allItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'gift-item';
        itemDiv.onclick = () => selectGiftItem(item, itemDiv);
    console.log('ÈªûÊìä‰∫ÜÁ¶ÆÁâ©È†ÖÁõÆÔºö', item);
        
        let previewContent = '';
        if (expressions.includes(item)) {
            previewContent = 'üòä';
        } else if (hairstyles.includes(item)) {
            previewContent = 'üíá';
        } else if (personalities.includes(item)) {
            previewContent = item.icon;
        }
        
        itemDiv.innerHTML = `
            <div style="font-size: 2rem; margin-bottom: 10px;">${previewContent}</div>
            <h4>${item.name}</h4>
            <div class="price">${item.price} Èªû</div>
        `;
        
        container.appendChild(itemDiv);
    });
}

function openGiftSendModal(item) {
    // ÂÖàÈáçÁΩÆËÆäÈáè
    currentGiftReceiver = null;
    selectedGiftItem = null;
    
    const modal = document.createElement('div');
    modal.className = 'gift-modal';
    modal.innerHTML = `
        <div class="gift-modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-gift"></i> ÈÄÅÂá∫ ${item.name}</h2>
                <button class="close-modal" onclick="closeGiftModal()">√ó</button>
            </div>
            <div class="points-display">
                <i class="fas fa-coins"></i>
                <span>ÊàëÁöÑÈªûÊï∏: ${userData.points}</span>
            </div>
            <p>ÈÅ∏Êìá‰∏Ä‰ΩçÂ•ΩÂèãÈÄÅÂá∫Ê≠§ÂïÜÂìÅÔºö</p>
            <div id="friend-select-list"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="shop-btn buy-btn" id="confirm-gift-btn" disabled>Á¢∫Ë™çÈÄÅÁ¶Æ</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'flex';

    // ËºâÂÖ•Â•ΩÂèãÂàóË°®
    loadFriendsForGift(item);
    
    // Âú® openGiftSendModal ÂáΩÊï∏‰∏≠ÔºåÊâæÂà∞‰∏¶ÊõøÊèõÂ•ΩÂèãÂàóË°®ÁîüÊàêÈÉ®ÂàÜ
const friendList = document.getElementById('friend-select-list');
database.ref('friends/' + currentUser.uid).once('value').then((snapshot) => {
    if (snapshot.exists()) {
        const friends = snapshot.val();
        Object.keys(friends).forEach(friendId => {
            database.ref('users/' + friendId).once('value').then((friendSnapshot) => {
                const friendData = friendSnapshot.val();
                const friendDiv = document.createElement('div');
friendDiv.className = 'friend-item';
friendDiv.style.cssText = `
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: white;
    transition: all 0.3s ease;
`;

// ÂâµÂª∫Â•ΩÂèãÈ†≠ÂÉè
const avatar = createVtuberAvatar(
    friendData.vtuberAppearance || { currentExpression: 'default', currentHairstyle: 'default' }, 
    40
);
avatar.style.marginRight = '12px';

const infoDiv = document.createElement('div');
infoDiv.className = 'friend-info';
infoDiv.style.flex = '1';
infoDiv.innerHTML = `<strong>${friendData.characterName || friendData.email}</strong>`;

const selectBtn = document.createElement('button');
selectBtn.className = 'shop-btn buy-btn select-friend-btn';
selectBtn.setAttribute('data-friend-id', friendId);
selectBtn.style.cssText = `
    background: #4a90e2;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    min-width: 80px;
`;
selectBtn.textContent = 'ÈÅ∏Êìá';

friendDiv.appendChild(avatar);
friendDiv.appendChild(infoDiv);
friendDiv.appendChild(selectBtn);

                friendList.appendChild(friendDiv);
            });
        });
        
        // Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
        setTimeout(() => {
            const selectButtons = friendList.querySelectorAll('.select-friend-btn');
            selectButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const friendId = this.getAttribute('data-friend-id');
  
                });
            });
        }, 1000);
        
    } else {
        friendList.innerHTML = '<p>‰Ω†ÈÇÑÊ≤íÊúâÂ•ΩÂèãÂèØ‰ª•ÈÄÅÁ¶ÆÔºÅ</p>';
    }
});

function loadFriendsForGift(item) {
    const friendList = document.getElementById('friend-select-list');
    
    if (!currentUser) {
        friendList.innerHTML = '<p>Ë´ãÂÖàÁôªÂÖ•ÔºÅ</p>';
        return;
    }
    
   database.ref('friends/' + currentUser.uid).once('value').then((snapshot) => {
    if (snapshot.exists()) {
        const friends = snapshot.val();
        const friendPromises = Object.keys(friends).map(friendId => {
            return database.ref('users/' + friendId).once('value').then((friendSnapshot) => {
                return { id: friendId, data: friendSnapshot.val() };
            });
        });
        
        Promise.all(friendPromises).then((friendsData) => {
            const friendList = document.getElementById('friend-select-list');
            friendList.innerHTML = '';
            friendList.style.cssText = `
                max-height: 400px;
                overflow-y: auto;
                padding: 10px 0;
            `;
            
            friendsData.forEach(({ id: friendId, data: friendData }) => {
                if (friendData) {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'friend-item';
                    friendDiv.style.cssText = `
    display: flex;
    align-items: center;
    padding: 15px;
    margin-bottom: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    background: white;
    transition: all 0.3s ease;
    justify-content: space-between;
    min-width: 400px; /* Â¢ûÂä†ÂÆπÂô®ÊúÄÂ∞èÂØ¨Â∫¶ */
`;


                    const avatarElement = createVtuberAvatar(
                        friendData.vtuberAppearance || { currentExpression: 'default', currentHairstyle: 'default' }, 
                        50
                    );
                    avatarElement.style.marginRight = '15px';

                    const leftSection = document.createElement('div');
                    leftSection.style.cssText = `
    display: flex;
    align-items: center;
    flex: 1;
    min-width: 0; /* ÂÖÅË®±Á∏ÆÂ∞è */
    margin-right: 15px; /* Â¢ûÂä†ËàáÊåâÈàïÁöÑÈñìË∑ù */
`;


                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'friend-info';
                    infoDiv.innerHTML = `<strong>${friendData.characterName || friendData.email}</strong>`;

                    const selectBtn = document.createElement('button');
                    selectBtn.className = 'shop-btn buy-btn select-friend-btn';
                    selectBtn.setAttribute('data-friend-id', friendId);
                    selectBtn.style.cssText = `
    background: #4a90e2;
    padding: 10px 16px; /* Ê∏õÂ∞ëÂ∑¶Âè≥ÂÖßÈÇäË∑ù */
    border-radius: 8px;
    font-size: 0.9rem; /* Á®çÂæÆÊ∏õÂ∞èÂ≠óÈ´î */
    min-width: 80px; /* Ê∏õÂ∞ëÊåâÈàïÊúÄÂ∞èÂØ¨Â∫¶ */
    max-width: 100px; /* ÈôêÂà∂ÊåâÈàïÊúÄÂ§ßÂØ¨Â∫¶ */
    font-weight: bold;
    transition: all 0.3s ease;
    flex-shrink: 0; /* Èò≤Ê≠¢ÊåâÈàïË¢´Â£ìÁ∏Æ */
`;

                    selectBtn.textContent = 'ÈÅ∏Êìá';

                    leftSection.appendChild(avatarElement);
                    leftSection.appendChild(infoDiv);

                    friendDiv.appendChild(leftSection);
                    friendDiv.appendChild(selectBtn);
                    friendList.appendChild(friendDiv);
                }
            });
            
            // ÈáçÊñ∞Á∂ÅÂÆö‰∫ã‰ª∂Áõ£ËÅΩÂô®
            bindGiftSelectionEvents(item);
        });
    } else {
        const friendList = document.getElementById('friend-select-list');
        friendList.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">‰Ω†ÈÇÑÊ≤íÊúâÂ•ΩÂèãÂèØ‰ª•ÈÄÅÁ¶ÆÔºÅ</p>';
    }
}).catch((error) => {
    console.error('ËºâÂÖ•Â•ΩÂèãÂàóË°®Â§±Êïó:', error);
    const friendList = document.getElementById('friend-select-list');
    friendList.innerHTML = '<p style="text-align: center; padding: 40px; color: #e74c3c;">ËºâÂÖ•Â•ΩÂèãÂàóË°®Â§±ÊïóÔºåË´ãÈáçË©¶„ÄÇ</p>';
});

}

function bindGiftSelectionEvents(item) {
    const selectButtons = document.querySelectorAll('.select-friend-btn');
    const confirmBtn = document.getElementById('confirm-gift-btn');
    
    selectButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const friendId = this.getAttribute('data-friend-id');
            
            // Ë®≠ÁΩÆÂÖ®Â±ÄËÆäÈáè
            currentGiftReceiver = friendId;
            selectedGiftItem = item;
            
            // ÈáçÁΩÆÊâÄÊúâÊåâÈàïÁãÄÊÖã
            selectButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#4a90e2';
                btn.textContent = 'ÈÅ∏Êìá';
            });
            
            // Ë®≠ÁΩÆÁï∂ÂâçÈÅ∏‰∏≠ÊåâÈàïÁãÄÊÖã
            this.classList.add('active');
            this.style.background = '#ff6b9d';
            this.textContent = 'Â∑≤ÈÅ∏Êìá';
            
            // ÂïüÁî®Á¢∫Ë™çÊåâÈàï
            confirmBtn.disabled = false;
            confirmBtn.style.background = '#ff6b9d';
            
            // Á∂ÅÂÆöÁ¢∫Ë™çÊåâÈàï‰∫ã‰ª∂
            confirmBtn.onclick = function() {
                if (currentGiftReceiver && selectedGiftItem) {
                    sendGiftToFriend(selectedGiftItem, currentGiftReceiver);
                } else {
                    alert('ÈÄÅÁ¶Æ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåË´ãÈáçÊñ∞ÈÅ∏ÊìáÔºÅ');
                }
            };
        });
    });
}


    
function selectGiftReceiver(friendId, button, item) {
    console.log('ÈÅ∏ÊìáÂ•ΩÂèã:', friendId, 'ÂïÜÂìÅ:', item);
    currentGiftReceiver = friendId;
    selectedGiftItem = item;
    
    // ÈáçÁΩÆÊâÄÊúâÊåâÈàïÁãÄÊÖã
    document.querySelectorAll('.select-friend-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#4a90e2';
        btn.textContent = 'ÈÅ∏Êìá';
    });
    
    // Ë®≠ÁΩÆÁï∂ÂâçÈÅ∏‰∏≠ÊåâÈàïÁãÄÊÖã
    button.classList.add('active');
    button.style.background = '#ff6b9d';
    button.textContent = 'Â∑≤ÈÅ∏Êìá';
    
    // ÂïüÁî®Á¢∫Ë™çÊåâÈàï
    const confirmBtn = document.getElementById('confirm-gift-btn');
    confirmBtn.disabled = false;
    confirmBtn.style.background = '#ff6b9d';
    
    // Ë®≠ÁΩÆÁ¢∫Ë™çÊåâÈàïÈªûÊìä‰∫ã‰ª∂
    confirmBtn.onclick = () => {
        sendGiftToFriend(item, friendId);
    };
}


}





function selectGiftItem(item, element) {
    // ÁßªÈô§ÂÖ∂‰ªñÈÅ∏‰∏≠ÁãÄÊÖã
    document.querySelectorAll('.gift-item').forEach(el => el.classList.remove('selected'));
    
    // ÈÅ∏‰∏≠Áï∂ÂâçÈ†ÖÁõÆ
    element.classList.add('selected');
    selectedGiftItem = item;
    
    // ÂïüÁî®ÈÄÅÁ¶ÆÊåâÈàï
    document.getElementById('send-gift-btn').disabled = false;
}

function sendGiftToFriend(item, friendId) {
    if (!item || !friendId) {
        alert('ÈÄÅÁ¶Æ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåË´ãÈáçÊñ∞ÈÅ∏ÊìáÔºÅ');
        return;
    }
    
    if (userData.points < item.price) {
        alert('ÈªûÊï∏‰∏çË∂≥ÔºÅ');
        return;
    }
    
    // Êâ£Èô§ÈªûÊï∏
    userData.points -= item.price;
    updatePointsDisplay();
    saveUserData();
    
    // Ê∫ñÂÇôÁ¶ÆÁâ©Êï∏ÊìöÔºåÁ¢∫‰øùÁ¨¶ÂêàFirebaseË¶èÂâá
    const giftData = {
        from: currentUser.uid,
        fromName: userProfile ? (userProfile.characterName || userProfile.email.split('@')[0]) : 'Êú™Áü•Áî®Êà∂',
        itemId: item.id,
        itemType: getItemTypeForGift(item),
        itemName: item.name,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    
    // ÁôºÈÄÅÁ¶ÆÁâ©Âà∞ Firebase
    database.ref('users/' + friendId + '/gifts').push(giftData)
        .then(() => {
            alert(`ÊàêÂäüÈÄÅÂá∫ ${item.name} Áµ¶Â•ΩÂèãÔºÅ`);
            closeGiftModal();
        })
        .catch((error) => {
            console.error('ÈÄÅÁ¶ÆÂ§±Êïó:', error);
            alert('ÈÄÅÁ¶ÆÂ§±Êïó: ' + error.message);
            // ÂõûÊªæÈªûÊï∏
            userData.points += item.price;
            updatePointsDisplay();
            saveUserData();
        });
}









function getItemTypeForGift(item) {
    // Ê†πÊìöitemÁöÑidÂâçÁ∂¥ÊàñÂú®Âì™ÂÄãÊï∏ÁµÑ‰∏≠‰æÜÂà§Êñ∑È°ûÂûã
    const expressionItem = expressions.find(e => e.id === item.id);
    if (expressionItem) return 'expression';
    
    const hairstyleItem = hairstyles.find(h => h.id === item.id);
    if (hairstyleItem) return 'hairstyle';
    
    const personalityItem = personalities.find(p => p.id === item.id);
    if (personalityItem) return 'personality';
    
    return 'unknown';
}

function loadReceivedGifts() {
    database.ref('users/' + currentUser.uid + '/gifts').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const gifts = snapshot.val();
                const container = document.querySelector('.gift-modal-content');
                
                // ÂâµÂª∫Â∑≤Êî∂Âà∞Á¶ÆÁâ©ÂçÄÂüü
                const receivedDiv = document.createElement('div');
                receivedDiv.className = 'received-gifts';
                receivedDiv.innerHTML = '<h3><i class="fas fa-gift"></i> Êî∂Âà∞ÁöÑÁ¶ÆÁâ©</h3>';
                
                Object.entries(gifts).forEach(([giftId, gift]) => {
                    const giftItem = document.createElement('div');
                    giftItem.className = 'received-gift-item';
                    giftItem.innerHTML = `
                        <div style="margin-right: 15px;">
                            <strong>${gift.itemName}</strong><br>
                            <small>‰æÜËá™: ${gift.fromName}</small>
                        </div>
                        <button class="shop-btn use-btn" onclick="claimGift('${giftId}', '${gift.itemId}', '${gift.itemType}')">
                            È†òÂèñ
                        </button>
                    `;
                    receivedDiv.appendChild(giftItem);
                });
                
                // ÊèíÂÖ•Âà∞ÈªûÊï∏È°ØÁ§∫ÂæåÈù¢
                const pointsDisplay = container.querySelector('.points-display');
                pointsDisplay.parentNode.insertBefore(receivedDiv, pointsDisplay.nextSibling);
            }
        });
}

function claimGift(giftId, itemId, itemType) {
    // Á´ãÂç≥Èö±ËóèË©≤Á¶ÆÁâ©È†ÖÁõÆ
    const giftElement = document.querySelector(`[onclick*="${giftId}"]`).closest('.received-gift-item');
    if (giftElement) {
        giftElement.style.display = 'none';
    }
    
    // ËôïÁêÜÁõ≤ÁõíÁ¶ÆÁâ©
    if (itemType === 'mysteryboxGift') {
        // ÂæûFirebaseÁç≤ÂèñÁõ≤ÁõíÁ¶ÆÁâ©Êï∏Êìö
        database.ref('mysteryboxGifts/' + itemId).once('value')
            .then((snapshot) => {
                const mysteryboxGiftData = snapshot.val();
                if (mysteryboxGiftData) {
                    // ÊâæÂà∞Â∞çÊáâÁöÑÁõ≤ÁõíÈ°ûÂûã
                    const mysteryboxType = mysteryboxes.find(box => box.id === mysteryboxGiftData.boxType);
                    if (mysteryboxType) {
                        // Á´ãÂç≥ÊâìÈñãÁõ≤ÁõíÂãïÁï´
                        openMysteryBox(mysteryboxType);
                        
                        // Âà™Èô§Áõ≤ÁõíÁ¶ÆÁâ©Êï∏Êìö
                        database.ref('mysteryboxGifts/' + itemId).remove();
                        
                        // ÂæûÊé•Êî∂ËÄÖÁöÑÁ¶ÆÁâ©ÂàóË°®‰∏≠Âà™Èô§
                        database.ref('users/' + currentUser.uid + '/gifts/' + giftId).remove()
                            .then(() => {
                                // ÈáçÊñ∞Ê∏≤ÊüìÁ¶ÆÁâ©ÂàóË°®
                                renderShopItems('gifts');
                            });
                    }
                }
            })
            .catch((error) => {
                console.error('ËôïÁêÜÁõ≤ÁõíÁ¶ÆÁâ©Â§±Êïó:', error);
                alert('È†òÂèñÂ§±Êïó: ' + error.message);
                if (giftElement) {
                    giftElement.style.display = 'flex';
                }
            });
        return;
    }
    
    // ÂéüÊúâÁöÑÊôÆÈÄöÁ¶ÆÁâ©ËôïÁêÜÈÇèËºØ
    if (itemType === 'expression' && !userData.purchasedExpressions.includes(itemId)) {
        userData.purchasedExpressions.push(itemId);
    } else if (itemType === 'hairstyle' && !userData.purchasedHairstyles.includes(itemId)) {
        userData.purchasedHairstyles.push(itemId);
    } else if (itemType === 'personality' && !userData.purchasedPersonalities.includes(itemId)) {
        userData.purchasedPersonalities.push(itemId);
    }

    // Â¶ÇÊûúÈ†òÂèñÁöÑÊòØÁõ≤ÁõíÔºåÊ∑ªÂä†ÂÖçË≤ªÊäΩÁçéÊ¨°Êï∏
    if (itemType === 'mysterybox') {
        if (!userData.freeMysteryboxDraws) {
            userData.freeMysteryboxDraws = {};
        }
        
        // Ê†πÊìöÁõ≤ÁõíÁ≠âÁ¥öÁµ¶‰∫àÂÖçË≤ªÊäΩÁçéÊ¨°Êï∏
        if (itemId === 'bronze') {
            userData.freeMysteryboxDraws.bronze = (userData.freeMysteryboxDraws.bronze || 0) + 1;
        } else if (itemId === 'silver') {
            userData.freeMysteryboxDraws.silver = (userData.freeMysteryboxDraws.silver || 0) + 1;
        } else if (itemId === 'gold') {
            userData.freeMysteryboxDraws.gold = (userData.freeMysteryboxDraws.gold || 0) + 1;
        }
    }
    
    saveUserData();
    
    // Âæû Firebase ‰∏≠Âà™Èô§Ë©≤Á¶ÆÁâ©
    database.ref('users/' + currentUser.uid + '/gifts/' + giftId).remove()
        .then(() => {
            alert('Á¶ÆÁâ©È†òÂèñÊàêÂäüÔºÅ');
            // ÈáçÊñ∞Ê∏≤ÊüìÁ¶ÆÁâ©ÂàóË°®
            renderShopItems('gifts');
        })
        .catch((error) => {
            console.error('È†òÂèñÁ¶ÆÁâ©Â§±Êïó:', error);
            alert('È†òÂèñÂ§±Êïó: ' + error.message);
            // Â¶ÇÊûúÂ§±ÊïóÔºåÈáçÊñ∞È°ØÁ§∫Á¶ÆÁâ©È†ÖÁõÆ
            if (giftElement) {
                giftElement.style.display = 'flex';
            }
        });
}

// ÈªûÊìäÊ®°ÊÖãÊ°ÜÂ§ñÈÉ®ÈóúÈñâ - Êõ¥Êñ∞ÁèæÊúâ‰ª£Á¢º
window.addEventListener('click', (e) => {
    if (e.target === shopModal) {
        shopModal.style.display = 'none';
    }
    if (e.target === settingsModal) {
        settingsModal.style.display = 'none';
    }
    if (e.target === friendsModal) {
        friendsModal.style.display = 'none';
    }
    if (e.target.classList.contains('gift-modal')) {
        closeGiftModal();
    }
    if (e.target === mysteryboxAnimation) {
        // ‰∏çÂÖÅË®±ÈªûÊìäÈóúÈñâÁõ≤ÁõíÂãïÁï´
    }
});


    </script>



<!-- Á¶ÆÁâ©ÊèêÈÜíÈÄöÁü• -->
<div class="gift-notification" id="gift-notification" style="display: none;">
    <div class="gift-notification-content">
        <h3>üéÅ Êî∂Âà∞Êñ∞Á¶ÆÁâ©ÔºÅ</h3>
        <p>‰Ω†ÊúâÊñ∞ÁöÑÁ¶ÆÁâ©ÂæÖÈ†òÂèñÔºåÂø´ÂéªÂ•ΩÂèãÁ≥ªÁµ±Êü•ÁúãÂêßÔºÅ</p>
        <button onclick="closeGiftNotification()">Áü•ÈÅì‰∫Ü</button>
    </div>
</div>



<!-- === 2. Firebase ÂàùÂßãÂåñËàáÈÖçÁΩÆ (ÈÄôË£°‰øÆÂæ©‰∫ÜÊÇ®ÊºèÊéâÁöÑÂïüÂãïÁ¢º) === -->
<!-- === [‰øÆÊîπÁâà] Èõô Firebase ÂÖ±Â≠òË®≠ÂÆö === -->
<script>
// === Sansidata Ê†∏ÂøÉÂàùÂßãÂåñ (Á¢∫‰øùÂÖ®ÂüüÂîØ‰∏Ä) ===
// === Sansidata Áç®Á´ãÁ≥ªÁµ±ÂàùÂßãÂåñ ===
var statsApp, statsDatabase, statsAuth;

(function() {
    const sansiConfig = {
        apiKey: "AIzaSyBgwrgn2m343mRJb0WjzUhteiospegXhvI",
        authDomain: "sansidata.firebaseapp.com",
        projectId: "sansidata",
        storageBucket: "sansidata.firebasestorage.app",
        messagingSenderId: "580288358575",
        appId: "1:580288358575:web:35dcf4e79bcef530de4c5a",
        databaseURL: "https://sansidata-default-rtdb.firebaseio.com"
    };

    // ÂÖ∑ÂêçÂàùÂßãÂåñÔºåÂæπÂ∫ïÈöîÁµï Âè≤ËêäÂßÜÊïôÂÆ§ (Default App) Ëàá Sansidata (StatsApp)
    if (!firebase.apps.find(app => app.name === "StatsApp")) {
        statsApp = firebase.initializeApp(sansiConfig, "StatsApp");
    } else {
        statsApp = firebase.app("StatsApp");
    }

    statsDatabase = statsApp.database(); // ‰øÆÂæ©Êï∏ÊìöÊ®°ÁµÑÂ†±ÈåØ
    statsAuth = statsApp.auth();

    // ÊåÅ‰πÖÂåñËàáË∫´‰ªΩÂêåÊ≠•
    statsAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
        statsAuth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("[Sansidata] üü¢ ÁîüÊàêÊ¨äÈôêÈ©óË≠âÊàêÂäü:", user.email);
                const s = JSON.parse(localStorage.getItem('studentProfile'));
                if (!s) {
                    try {
                        const emailKey = btoa(user.email);
                        const snapshot = await statsDatabase.ref('email_mapping/' + emailKey).once('value');
                        if (snapshot.exists()) {
                            localStorage.setItem('studentProfile', JSON.stringify(snapshot.val()));
                        }
                    } catch (e) { console.error("ÂêåÊ≠•Â§±Êïó:", e); }
                }
            } else {
                console.log("[Sansidata] ‚ö™ Êú™È©óË≠âÁîüÊàêÊ¨äÈôê");
            }
        });
    });
})();

// === ÂÖ®ÂüüË´ãÊ±ÇÊîîÊà™Âô® (Âè™ÈáùÂ∞ç Sansidata Ê≥®ÂÖ• Token) ===
(function() {
    const originalFetch = window.fetch; 
    const TARGET_URL_PART = "script.google.com"; 

    window.fetch = async function(url, options) {
        if (typeof url === 'string' && url.includes(TARGET_URL_PART) && options && options.method === 'POST') {
            
            // Á¢∫‰øùÂæû StatsApp ÁöÑ Auth Áç≤Âèñ Token
            const user = statsAuth ? statsAuth.currentUser : null;

            if (user) {
                try {
                    const token = await user.getIdToken(true);
                    let bodyData = JSON.parse(options.body);
                    bodyData.token = token; // Âº∑Âà∂Ê≥®ÂÖ• Token
                    options.body = JSON.stringify(bodyData);
                    console.log("[TokenInjector] Â∑≤ÊàêÂäüÊ≥®ÂÖ• Sansidata ÁîüÊàêÊ¨äÈôê Token");
                } catch (e) {
                    console.error("[TokenInjector] Token Áç≤ÂèñÂ§±Êïó:", e);
                }
            } else {
                console.warn("[TokenInjector] Ë≠¶ÂëäÔºöÁÑ° Sansidata ÁôªÂÖ•Ë≥áË®äÔºåË´ãÊ±ÇÂ∞áË¢´ÂæåÁ´ØÊãíÁµï");
            }
        }
        return originalFetch(url, options);
    };
})();

</script>


<!-- === [‰øÆÊîπÁâà] Á•ûÊÄùÂ§ßÊï∏ÊìöÊî∂ÈõÜÊ®°ÁµÑ (‰ΩøÁî® statsDatabase) === -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let totalSeconds = 0;
    let timerInterval = null;

    // Á´ãÂç≥Ê™¢Êü•
    console.log("üîç [Stats] Ê≠£Âú®Ê™¢Êü•Áµ±Ë®àÁí∞Â¢É...");

    function getDateParts() {
        const now = new Date();
        const y = String(now.getFullYear());
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return { y, m, d };
    }

    function getIdentity() {
        const rawProfile = localStorage.getItem('studentProfile');
        let s = null;
        try { if(rawProfile) s = JSON.parse(rawProfile); } catch (e) {}

        if (s && s.grade && s.class) {
            const safeName = s.name.replace(/[.#$/[\]]/g, '_'); 
            return { type: 'student', id: s.uid || `stu_${s.grade}${s.class}_${safeName}`, grade: s.grade, class: s.class, name: s.name };
        } else {
            let guestID = localStorage.getItem('sansi_guest_uuid');
            if (!guestID) {
                guestID = 'guest_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('sansi_guest_uuid', guestID);
            }
            return { type: 'guest', id: guestID, grade: 'Guest', class: 'Visitor', name: 'Ë®™ÂÆ¢' };
        }
    }

    async function logVisitOnce() {
        // ‰øÆÊîπÈÄôË£°ÔºöÂæû window Áç≤Âèñ‰ª•Á¢∫‰øùËÆÄÂæóÂà∞
        const db = window.statsDatabase;
        if (!db) {
            console.warn("‚ö†Ô∏è [Stats] Êâæ‰∏çÂà∞ statsDatabaseÔºåÂÅúÊ≠¢Ë®™ÂïèË®òÈåÑ");
            return;
        }
        
        const { y, m, d } = getDateParts();
        const identity = getIdentity();
        const uid = identity.id;

        const sessionKey = `sansi_visit_logged_${y}${m}${d}_${uid}`;
        if (sessionStorage.getItem(sessionKey)) return; 

        console.log(`üìç [Stats] Ê≠£Âú®ÁÇ∫ ${identity.name} ‰∏äÂÇ≥‰ªäÊó•È¶ñË®™...`);
        
        try {
            const trackingRef = db.ref(`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`);
            const snap = await trackingRef.once('value');
            const isFirstTimeToday = !snap.exists();

            const updates = {};
            const increment1 = firebase.database.ServerValue.increment(1);
            
            const globalPath = `stats_global/${y}/${m}/${d}`;
            updates[`${globalPath}/visits`] = increment1;

            if (identity.type === 'student') {
                const classKey = `${identity.grade}${identity.class}`;
                const studentKey = identity.name.replace(/[.#$/[\]]/g, '_');
                const schoolPath = `stats_school/${y}/${m}/${d}`;

                updates[`${schoolPath}/visits`] = increment1;
                updates[`stats_classes/${classKey}/${y}/${m}/${d}/visits`] = increment1;
                updates[`stats_students/${classKey}/${studentKey}/${y}/${m}/${d}/visits`] = increment1;

                if (isFirstTimeToday) {
                    updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                    updates[`${globalPath}/unique`] = increment1;
                    updates[`${schoolPath}/unique`] = increment1;
                    updates[`stats_classes/${classKey}/${y}/${m}/${d}/unique`] = increment1;
                }
            } else if (isFirstTimeToday) {
                updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                updates[`${globalPath}/unique`] = increment1;
            }

            await db.ref().update(updates);
            sessionStorage.setItem(sessionKey, 'true');
            console.log("‚úÖ [Stats] Ë®™ÂïèË®àÊï∏ÂÆåÊàê");
        } catch (e) {
            console.error("‚ùå [Stats] Ë®™ÂïèË®òÈåÑÂá∫ÈåØ:", e);
        }
    }

    function uploadOneMinute() {
        const db = window.statsDatabase;
        if (!db) return;
        
        logVisitOnce(); 

        const { y, m, d } = getDateParts();
        const identity = getIdentity();
        const studentKey = identity.name.replace(/[.#$/[\]]/g, '_');
        
        const updates = {};
        const increment60 = firebase.database.ServerValue.increment(60);

        updates[`stats_global/${y}/${m}/${d}/duration`] = increment60;

        if (identity.type === 'student') {
            const classKey = `${identity.grade}${identity.class}`;
            updates[`stats_school/${y}/${m}/${d}/duration`] = increment60;
            updates[`stats_classes/${classKey}/${y}/${m}/${d}/duration`] = increment60;
            updates[`stats_students/${classKey}/${studentKey}/${y}/${m}/${d}/duration`] = increment60;
        }

        db.ref().update(updates)
            .then(() => console.log("‚è±Ô∏è [Stats] Â∑≤Á¥ØÁ©çÂú®Á∑öÊôÇÈï∑ 60 Áßí"))
            .catch(e => console.error("‚ùå [Stats] ÊôÇÈï∑‰∏äÂÇ≥Â§±Êïó:", e));
    }

    function startTimer() {
        if (timerInterval) return;
        console.log("üöÄ [Stats] Ë®àÊôÇÂô®Â∑≤ÂïüÂãï");
        timerInterval = setInterval(() => {
            totalSeconds++;
            // ÊØèÁßíÈêòÈùúÈªòË®àÊôÇÔºåÊØè 30 ÁßíÂú® Console È°ØÁ§∫‰∏ÄÊ¨°ÁãÄÊÖã
            if (totalSeconds % 30 === 0) {
                console.log(`‚è≥ [Stats] Áï∂ÂâçÂú®Á∑ö: ${totalSeconds}Áßí`);
            }
            // Âà∞ÈÅî 30s, 90s, 150s... ÊôÇ‰∏äÂÇ≥
            if (totalSeconds === 30 || (totalSeconds > 30 && (totalSeconds - 30) % 60 === 0)) {
                uploadOneMinute();
            }
        }, 1000);
    }

    function pauseTimer() {
        if (timerInterval) {
            console.log("‚è∏Ô∏è [Stats] Ë®àÊôÇÊö´ÂÅú");
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    // ÂïüÂãïÊµÅÁ®ã
    setTimeout(() => {
        if (window.statsDatabase) {
            logVisitOnce();
            startTimer();
        } else {
            console.error("‚ùå [Stats] ÂïüÂãïÂ§±ÊïóÔºöÊâæ‰∏çÂà∞ statsDatabase");
        }
    }, 3000);

    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') pauseTimer();
        else startTimer();
    });
});
</script>

<!-- === [‰øÆÊîπÁâà] Âú®Á∑öÁãÄÊÖãËá™ÂãïÂ†±Âà∞Á≥ªÁµ± (‰ΩøÁî® statsDatabase) === -->
<script>
    function initPresenceSystem() {
        setTimeout(() => {
            // ‰øÆÊîπÈÄôË£°ÔºöÊ™¢Êü• statsDatabase
            if (typeof statsDatabase === 'undefined') return;

            // ‰øÆÊîπÈÄôË£°Ôºö‰ΩøÁî® statsDatabase Áõ£ËÅΩÈÄ£Á∑ö
            const connectedRef = statsDatabase.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    const s = JSON.parse(localStorage.getItem('studentProfile'));
                    let myUid = "";
                    let userData = {};

                    if (s && s.name) {
                        // ÈÄôË£°Ë¶ÅÊ≥®ÊÑèÔºöÂ¶ÇÊûú‰Ω†ÁöÑÁî®Êà∂ÁôªÂÖ•ÊòØÂú® Main AppÔºåÈÄôË£°ÊòØÁç≤Âèñ‰∏çÂà∞ auth ÁöÑ
                        // ‰ΩÜÊó¢ÁÑ∂ÊòØÁµ±Ë®àÔºåÈÄöÂ∏∏‰æùË≥¥ localStorage ÁöÑ studentProfile
                        myUid = `stu_${s.grade}${s.class}_${s.name}`;
                        userData = {
                            name: s.name,
                            grade: s.grade,
                            class: s.class,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            device: /Mobile|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
                        };
                    } else {
                        let guestId = localStorage.getItem('sansi_guest_uuid');
                        if (!guestId) {
                            guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
                            localStorage.setItem('sansi_guest_uuid', guestId);
                        }
                        myUid = guestId;
                        userData = {
                            name: "Ë®™ÂÆ¢",
                            grade: "Guest",
                            class: "Visitor",
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        };
                    }

                    // ‰øÆÊîπÈÄôË£°Ôºö‰ΩøÁî® statsDatabase
                    const myPresenceRef = statsDatabase.ref(`online_users/${myUid}`);

                    myPresenceRef.onDisconnect().remove().then(() => {
                        myPresenceRef.set(userData);
                    });
                }
            });
        }, 2000);
    }
    document.addEventListener('DOMContentLoaded', initPresenceSystem);
</script>

<script>


// === ÂÖ®ÂüüË´ãÊ±ÇÊîîÊà™Âô® (ÈáùÂ∞ç Sansidata Ê≥®ÂÖ• Token) ===
(function() {
    const originalFetch = window.fetch; 
    const TARGET_URL_PART = "script.google.com"; 

    window.fetch = async function(url, options) {
        if (typeof url === 'string' && url.includes(TARGET_URL_PART) && options && options.method === 'POST') {
            
            console.log("[TokenInjector] Ê≠£Âú®Ê≥®ÂÖ• Sansidata Token...");

            const user = await new Promise((resolve) => {
                if (statsAuth.currentUser) {
                    resolve(statsAuth.currentUser);
                } else {
                    const unsubscribe = statsAuth.onAuthStateChanged(u => {
                        unsubscribe();
                        resolve(u);
                    });
                    setTimeout(() => resolve(null), 2000); 
                }
            });

            if (user) {
                try {
                    const token = await user.getIdToken(true);
                    let bodyData = JSON.parse(options.body);
                    bodyData.token = token; // ‚òÖ ÈÄôË£°Ê≥®ÂÖ• Token
                    options.body = JSON.stringify(bodyData);
                    console.log("[TokenInjector] Token Ê≥®ÂÖ•ÊàêÂäü");
                } catch (e) {
                    console.error("[TokenInjector] Ê≥®ÂÖ•Â§±Êïó:", e);
                }
            }
        }
        return originalFetch(url, options);
    };
})();

	
</script>


<script>


// ===============================================================
// === [Á•ûÊÄùÈÄöÁî®ÁµÑ‰ª∂] Âö¥Ê†ºÊ¨äÈôêÈéñ (Èõ∂ÂÆπÂøçÁâà) ===
// ===============================================================
(function() {
    // Èò≤Ê≠¢ÈáçË§áÊ≥®ÂÖ•
    if (window.SansiInterceptorLoaded) return;
    window.SansiInterceptorLoaded = true;

    // --- 1. Ê≥®ÂÖ• CSS ---
    const style = document.createElement('style');
    style.textContent = `
        .sansi-limit-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(253, 252, 248, 0.95);
            backdrop-filter: blur(8px);
            z-index: 9999999;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .sansi-limit-show { opacity: 1; }
        .sansi-limit-card {
            background: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 16px;
            padding: 35px 25px; width: 90%; max-width: 380px;
            box-shadow: 0 15px 40px rgba(141, 110, 99, 0.2);
            text-align: center; transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            font-family: 'Noto Serif TC', serif;
        }
        .sansi-limit-show .sansi-limit-card { transform: translateY(0); }
        .sansi-limit-icon { font-size: 3.5rem; color: #d69a92; margin-bottom: 20px; }
        .sansi-limit-title { color: #5d4037; font-size: 1.5rem; font-weight: bold; margin: 0 0 15px 0; }
        .sansi-limit-desc { color: #666; font-size: 1.1rem; line-height: 1.6; margin-bottom: 30px; }
        .sansi-btn-group { display: flex; gap: 12px; margin-top: 10px; }
        .sansi-limit-btn {
            border: none; padding: 12px 0; border-radius: 50px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            transition: all 0.2s; font-family: 'Noto Serif TC', serif;
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
            text-decoration: none;
        }
        .btn-primary { background: #8fa398; color: white; box-shadow: 0 4px 12px rgba(143, 163, 152, 0.4); }
        .btn-primary:hover { background-color: #7d9186; transform: translateY(-2px); }
        .btn-secondary { background: #f0f0f0; color: #777; }
        .btn-secondary:hover { background-color: #e5e5e5; }
    `;
    document.head.appendChild(style);

    // --- 2. Ê≥®ÂÖ• HTML (ÈÄ£ÁµêÊåáÂêë‰∏ä‰∏ÄÂ±§ index2.html) ---
    const modalHTML = `
        <div id="sansiLimitModal" class="sansi-limit-overlay">
            <div class="sansi-limit-card">
                <div class="sansi-limit-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="sansi-limit-title">ÊúÉÂì°ÈôêÂÆöÂäüËÉΩ</div>
                <div class="sansi-limit-desc">
                    Ê≠§ÂäüËÉΩÂÉÖÈñãÊîæÁµ¶Á•ûÊÄùÁôªÂÖ•Áî®Êà∂„ÄÇ<br>
                    Ë´ãÂÖàÁôªÂÖ•Â≠∏Ê†°Â∏≥Ëôü‰ª•ÁπºÁ∫å‰ΩøÁî®„ÄÇ
                </div>
                <div class="sansi-btn-group">
                    <button class="sansi-limit-btn btn-secondary" onclick="closeSansiLimitModal()">
                        ÂèñÊ∂à
                    </button>
                    <button class="sansi-limit-btn btn-primary" onclick="window.location.href='../index2.html'">
                        <i class="fas fa-sign-in-alt"></i> ÂâçÂæÄÁôªÂÖ•
                    </button>
                </div>
            </div>
        </div>
    `;
    const div = document.createElement('div');
    div.innerHTML = modalHTML;
    document.body.appendChild(div);

    // --- 3. Ë¶ñÁ™óÊéßÂà∂ ---
    window.closeSansiLimitModal = function() {
        const modal = document.getElementById('sansiLimitModal');
        if (modal) {
            modal.classList.remove('sansi-limit-show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
            
            // ÈáùÂ∞çÂè≤ËêäÂßÜÊïôÂÆ§Áí∞Â¢ÉÁöÑ UI ÈáçÁΩÆ
            const typingInd = document.getElementById('typing-indicator');
            if(typingInd) typingInd.style.display = 'none';
            
            const sendBtn = document.getElementById('send-btn');
            const voiceBtn = document.getElementById('voice-btn');
            if(sendBtn) sendBtn.disabled = false;
            if(voiceBtn) voiceBtn.disabled = false;
        }
    };

    // --- 4. Âö¥Ê†ºÊîîÊà™ÈÇèËºØ ---
    const originalFetch = window.fetch;
    
    window.fetch = async function(url, options) {
        // Áõ£Ê∏¨ AI Áõ∏ÈóúË´ãÊ±Ç
        if (typeof url === 'string' && (url.includes('pollinations.ai') || url.includes('script.google.com'))) {
            
            const s = localStorage.getItem('studentProfile');
            
            // Â¶ÇÊûúÊúâË≥áÊñô -> ÊîæË°å
            if (s) {
                return originalFetch(url, options);
            }

            // Â¶ÇÊûúÊ≤íË≥áÊñô -> Áõ¥Êé•ÈòªÊìã‰∏¶È°ØÁ§∫ÁµÑ‰ª∂
            console.warn("üö´ [Sansi Security] Êú™ÁôªÂÖ•Áî®Êà∂ÂòóË©¶‰ΩøÁî®ÁîüÊàêÂäüËÉΩÔºåÂ∑≤ÊîîÊà™„ÄÇ");
            
            const modal = document.getElementById('sansiLimitModal');
            if (modal) {
                modal.style.display = 'flex';
                void modal.offsetWidth; 
                modal.classList.add('sansi-limit-show');
            }

            return Promise.reject(new Error("Login Required - Guest Access Denied"));
        }

        return originalFetch(url, options);
    };
    
    console.log("üîí Á•ûÊÄùÂö¥Ê†ºÊ¨äÈôêÈéñ (ÂøÖÈ†àÁôªÂÖ•) Â∑≤ÂïüÂãï");
})();
	
</script>







	
</body>
</html>
