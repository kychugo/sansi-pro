<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–‡æ¨</title>
<link rel="manifest" href="manifest.json">


<!-- å¼•å…¥ Font Awesome åœ–ç¤ºåº« -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">


<!-- å¼•å…¥ Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;500;600&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
--primary-color: #7fb3d5;
--secondary-color: #a2d9ce;
--accent-color: #a9cce3;
--highlight-color: #7dcea0;
--soft-color: #76d7c4;
--light-accent: #aed6f1;
--background-color: #f8fafa;
--text-color: #2c3e50;
--light-color: #ffffff;
--dark-color: #34495e;
--error-color: #e74c3c;
--success-color: #2ecc71;
--warning-color: #f1c40f;
--hidden-bg: #ecf0f1;
--shadow-light: 0 2px 12px rgba(127, 179, 213, 0.15);
--shadow-medium: 0 4px 24px rgba(127, 179, 213, 0.2);
--shadow-heavy: 0 8px 36px rgba(127, 179, 213, 0.25);
--gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
--gradient-accent: linear-gradient(135deg, var(--highlight-color), var(--soft-color));
--border-radius: 12px;
--border-radius-small: 6px;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
--overlay-bg: rgba(44, 62, 80, 0.7);
}
* {
box-sizing: border-box;
margin: 0;
padding: 0;
}
body {
font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
background: linear-gradient(to bottom right, #f8fafa 0%, #f0f8ff 100%);
color: var(--text-color);
line-height: 1.6;
padding: 20px;
min-height: 100vh;
}
.container {
max-width: 1400px;
margin: 0 auto;
padding: 20px;
display: grid;
grid-template-columns: 1fr 2fr;
gap: 30px;
}
.copyright-footer {
position: fixed;
bottom: 0;
right: 0;
padding: 5px 10px;
background-color: #f1f1f1;
}
.copyright-footer p {
margin: 0;
font-size: 14px;
}
/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 1024px) {
.container {
grid-template-columns: 1fr;
width: 95%;
margin: 0 auto;
}
}
@media (max-width: 768px) {
.container {
width: 95%;
padding: 10px;
}
body {
padding: 10px;
}
.copyright-footer p {
font-size: 12px;
}
}
header {
text-align: center;
margin-bottom: 40px;
padding: 40px 20px;
background: var(--gradient-primary);
color: var(--light-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-medium);
position: relative;
overflow: hidden;
grid-column: 1 / -1;
}
header::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="30" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
pointer-events: none;
}
h1 {
margin-bottom: 15px;
font-size: clamp(2rem, 4vw, 3rem);
font-weight: 300;
letter-spacing: 3px;
font-family: 'Noto Serif TC', serif;
position: relative;
z-index: 1;
}
.input-section {
background: var(--light-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-light);
padding: 30px;
border: 2px solid rgba(127, 179, 213, 0.1);
transition: var(--transition);
position: relative;
overflow: hidden;
grid-column: 1;
}
@media (max-width: 1024px) {
.input-section {
position: static;
}
}
@media (max-width: 768px) {
.input-section {
padding: 20px;
}
}
.input-section::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
background: var(--gradient-primary);
}
.input-section:hover {
box-shadow: var(--shadow-medium);
transform: translateY(-2px);
}
.section-title {
color: var(--primary-color);
margin-bottom: 25px;
padding-bottom: 15px;
border-bottom: 2px solid var(--light-accent);
font-size: 1.4rem;
font-weight: 500;
font-family: 'Noto Serif TC', serif;
display: flex;
align-items: center;
gap: 10px;
}
.section-title::before {
content: '';
width: 8px;
height: 8px;
background: var(--secondary-color);
border-radius: 50%;
}
textarea {
width: 100%;
padding: 20px;
border: 2px solid var(--light-accent);
border-radius: var(--border-radius-small);
font-size: 18px;
line-height: 1.8;
transition: var(--transition);
background: linear-gradient(to bottom, #fafafa, #ffffff);
font-family: 'Noto Serif TC', serif;
resize: none;
/* Disable manual resize */
overflow-y: hidden;
/* Hide scrollbar, JS will handle height */
}
@media (max-width: 768px) {

textarea {
font-size: 16px;
padding: 15px;
}
}
textarea:focus {
outline: none;
border-color: var(--primary-color);
background: var(--light-color);
box-shadow: 0 0 0 4px rgba(127, 179, 213, 0.1);
}
#classical-text {
min-height: 250px;
/* Specific initial height for the main textarea */
}
#ai-prompt {
min-height: 80px;
/* Smaller initial height for the prompt textarea */
font-size: 16px;
/* Slightly smaller font for prompt */
}
.button-group {
display: flex;
gap: 15px;
margin-top: 25px;
flex-wrap: wrap;
}
button {
padding: 14px 28px;
background: var(--gradient-primary);
color: var(--light-color);
border: none;
border-radius: var(--border-radius-small);
cursor: pointer;
font-size: 16px;
font-weight: 500;
transition: var(--transition);
flex: 1;
min-width: 130px;
box-shadow: var(--shadow-light);
position: relative;
overflow: hidden;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
}
@media (max-width: 768px) {
button {
padding: 12px 20px;
font-size: 13px;
min-width: 100px;
}
}
button::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
transition: left 0.5s;
}
button:hover::before {
left: 100%;
}
button:hover {
transform: translateY(-3px);
box-shadow: var(--shadow-medium);
}
button:active {
transform: translateY(-1px);
}
button:disabled {
background: #bdc3c7;
cursor: not-allowed;
transform: none;
box-shadow: none;
}
.clear-btn {
background: linear-gradient(135deg, #e74c3c, #c0392b);
}
.history-btn {
background: linear-gradient(135deg, #015F78, #3886A8);
}
.ai-search-btn {
width: 100%;
margin-bottom: 20px;
background: var(--gradient-accent);
}
.toggle-translations-btn {
background: linear-gradient(135deg, #1F7A55, #0B4F4A);
margin-top: -15px; /* Adjust position */
width: auto;
min-width: 50px;
flex: 0;
padding: 10px 12px;
align-self: flex-start;
}
.section-divider {
border: 0;
height: 1px;
background-color: var(--light-accent);
margin: 30px 0;
}
.form-group {
margin-bottom: 20px;
}
.form-group label {
display: block;
margin-bottom: 10px;
font-weight: 500;
color: var(--dark-color);
}
.rating-dots {
display: flex;
gap: 12px;
cursor: pointer;
}
.rating-dot {
width: 28px;
height: 28px;
border-radius: 50%;
border: 2px solid #ccc;
transition: all 0.2s ease-in-out;
}
.rating-dots:hover .rating-dot,
.rating-dots .rating-dot.selected {
border-color: var(--primary-color);
background-color: var(--primary-color);
transform: scale(1.1);
}
.rating-dots:hover .rating-dot:hover~.rating-dot {
background-color: transparent;
border-color: #ccc;
}
.loader {
width: 20px;
height: 20px;
border: 3px solid rgba(255, 255, 255, 0.3);
border-radius: 50%;
border-top-color: #fff;
animation: spin 1s ease-in-out infinite;
margin-right: 8px;
/* Add margin to separate from text */
}
.btn-text {
transition: opacity 0.2s;
}
.output-section {
background: var(--light-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-light);
padding: 30px;
border: 2px solid rgba(127, 179, 213, 0.1);
transition: var(--transition);
position: relative;
overflow: hidden;
grid-column: 2;
display: flex;
flex-direction: column;
}
@media (max-width: 1024px) {
.output-section {
grid-column: 1;
}
}
@media (max-width: 768px) {
.output-section {
padding: 20px;
}
}
.output-section::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
background: var(--gradient-primary);
}
.output-section:hover {
box-shadow: var(--shadow-medium);
transform: translateY(-2px);
}
.output-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
}
.output-header .section-title {
flex-grow: 1;
}
.output-content {
min-height: 200px;
flex-grow: 1;
}
.content-group-container {
padding: 20px;
border-radius: var(--border-radius-small);
border: 1px solid transparent;
}
.content-group-container:not(:empty) {
border-color: var(--light-accent);
background: linear-gradient(to bottom, #fafafa, #ffffff);
}
.content-group-container+.content-group-container:not(:empty) {
margin-top: 30px;
}
@media (max-width: 768px) {
.output-content {
padding: 0;
}
.content-group-container {
padding: 15px;
}
}
@media (min-width: 1025px) {
.container {
height: calc(100vh - 10px);
grid-template-rows: auto 1fr;
}
.input-section,
.output-section {
min-height: 0;
overflow-y: auto;
}
.output-content {
overflow-y: visible;
}
}
.loading {
display: none;
text-align: center;
padding: 50px;
color: var(--primary-color);
}
.spinner {
border: 4px solid rgba(127, 179, 213, 0.2);
border-radius: 50%;
border-top: 4px solid var(--primary-color);
width: 50px;
height: 50px;
animation: spin 1s linear infinite;
margin: 0 auto 20px;
}
@keyframes spin {
0% {
transform: rotate(0deg);
}
100% {
transform: rotate(360deg);
}
}
.error-message {
color: var(--error-color);
margin-top: 20px;
display: none;
padding: 15px;
background: #fadbd8;
border: 2px solid #f1948a;
border-radius: var(--border-radius-small);
}
.introduction-section {
margin-bottom: 25px;
padding: 20px;
background: linear-gradient(135deg, #f8f9f9, #eef5f9);
border-left: 5px solid var(--highlight-color);
border-radius: var(--border-radius-small);
}
.introduction-wrapper .introduction-section:last-child {
margin-bottom: 0;
}
.introduction-title {
font-weight: 600;
color: var(--primary-color);
margin-bottom: 10px;
font-size: 1.2rem;
font-family: 'Noto Serif TC', serif;
display: flex;
align-items: center;
gap: 8px;
}
.introduction-content {
font-size: 16px;
line-height: 1.7;
color: var(--dark-color);
}
.translation-block {
margin-bottom: 35px;
border-bottom: 2px dashed var(--light-accent);
padding-bottom: 25px;
}
.translation-block:last-child {
border-bottom: none;
margin-bottom: 0;
padding-bottom: 0;
}
.original-title,
.translation-title {
font-weight: 600;
color: var(--primary-color);
margin-bottom: 15px;
font-size: 1.3rem;
font-family: 'Noto Serif TC', serif;
}
.original-text {
font-size: 18px;
line-height: 2;
margin-bottom: 25px;
padding: 20px;
background: linear-gradient(135deg, var(--light-accent), rgba(173, 214, 241, 0.3));
border-left: 5px solid var(--primary-color);
border-radius: var(--border-radius-small);
font-family: 'Noto Serif TC', serif;
}
@media (max-width: 768px) {
.original-text {
font-size: 16px;
padding: 15px;
}
}
.translation-text {
padding: 20px;
border-radius: var(--border-radius-small);
line-height: 1.8;
font-size: 16px;
border-left: 5px solid var(--secondary-color);
background: linear-gradient(135deg, rgba(255,255,255,0.5), rgba(245,245,245,0.5));
}
@media (max-width: 768px) {
.translation-text {
padding: 15px;
font-size: 14px;
}
}
.character-breakdown {
margin-top: 20px;
padding: 20px;
background: linear-gradient(135deg, rgba(169, 204, 227, 0.2), rgba(125, 206, 160, 0.1));
border-radius: var(--border-radius-small);
font-size: 15px;
border-left: 5px solid var(--highlight-color);
}
@media (max-width: 768px) {
.character-breakdown {
padding: 15px;
font-size: 14px;
}
}
.character-item {
margin-bottom: 12px;
display: flex;
align-items: flex-start;
padding: 8px 0;
border-bottom: 1px solid rgba(127, 179, 213, 0.1);
}
.character-item:last-child {
border-bottom: none;
}
.floating-original {
display: none;
position: fixed;
background: var(--light-color);
border: 2px solid var(--primary-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-heavy);
z-index: 1000;
}
@media (min-width: 1025px) {
.floating-original {
top: 50%;
right: 20px;
transform: translateY(-50%);
width: 350px;
max-height: 70vh;
overflow-y: auto;
}
}
@media (max-width: 768px) {
.floating-original {
top: 0;
left: 0;
right: 0;
width: 100%;
max-width: none;
border-radius: 0 0 var(--border-radius) var(--border-radius);
border-top: none;
overflow: hidden;
min-height: 150px;
resize: vertical;
}
.floating-original.resizable {
height: 33.33vh;
}
}
.floating-original.show {
display: block;
animation: fadeIn 0.3s ease-out;
}
@keyframes fadeIn {
from {
opacity: 0;
transform: translateY(-50%) scale(0.9);
}
to {
opacity: 1;
transform: translateY(-50%) scale(1);
}
}
@media (max-width: 768px) {
@keyframes fadeIn {
from {
opacity: 0;
transform: translateY(-20px);
}
to {
opacity: 1;
transform: translateY(0);
}
}
}
.floating-header {
background: var(--gradient-primary);
color: var(--light-color);
padding: 15px 20px;
display: flex;
justify-content: space-between;
align-items: center;
border-radius: var(--border-radius) var(--border-radius) 0 0;
}
@media (max-width: 768px) {
.floating-header {
border-radius: 0;
}
}
.floating-title {
font-weight: 600;
font-size: 1.1rem;
}
.floating-controls {
display: flex;
gap: 10px;
align-items: center;
}
.floating-toggle {
background: none;
border: none;
color: var(--light-color);
font-size: 1.2rem;
cursor: pointer;
padding: 5px;
border-radius: 50%;
transition: var(--transition);
width: 30px;
height: 30px;
display: flex;
align-items: center;
justify-content: center;
}
.floating-toggle:hover {
background: rgba(255, 255, 255, 0.2);
transform: scale(1.1);
}
.floating-content {
padding: 20px;
overflow-y: auto;
}
@media (max-width: 768px) {
.floating-content {
padding: 15px;
font-size: 16px;
height: calc(100% - 55px);
}
}
.floating-original-text {
font-size: 16px;
line-height: 1.8;
color: var(--text-color);
font-family: 'Noto Serif TC', serif;
}
@media (max-width: 768px) {
.floating-original-text {
font-size: 17px;
line-height: 1.9;
}
}
.reopen-floating {
position: fixed;
top: 20px;
left: 20px;
background: var(--gradient-primary);
color: var(--light-color);
border: none;
border-radius: 50%;
width: 50px;
height: 50px;
font-size: 1.2rem;
cursor: pointer;
box-shadow: var(--shadow-medium);
z-index: 999;
display: none;
transition: var(--transition);
}
.reopen-floating:hover {
transform: scale(1.1);
box-shadow: var(--shadow-heavy);
}
@media (max-width: 768px) {
.reopen-floating.show {
display: flex;
align-items: center;
justify-content: center;
}
}
.word-with-explanation {
position: relative;
display: inline;
color: var(--primary-color);
font-weight: 600;
cursor: pointer;
border-bottom: 2px dotted var(--primary-color);
margin: 0 2px;
padding: 2px 4px;
border-radius: 3px;
transition: var(--transition);
}
.word-with-explanation:hover {
background: rgba(127, 179, 213, 0.1);
}
.explanation-icon {
color: var(--secondary-color);
font-size: 0.9em;
margin-left: 4px;
cursor: pointer;
opacity: 0.8;
transition: var(--transition);
padding: 2px;
border-radius: 50%;
}
.explanation-icon:hover {
opacity: 1;
background: rgba(162, 217, 206, 0.3);
transform: scale(1.1);
}
.word-explanation {
display: none;
position: absolute;
bottom: 120%;
left: 50%;
transform: translateX(-50%);
background: var(--dark-color);
color: var(--light-color);
padding: 12px 16px;
border-radius: var(--border-radius-small);
font-size: 14px;
white-space: nowrap;
z-index: 1001;
box-shadow: var(--shadow-medium);
max-width: 300px;
white-space: normal;
}
.word-explanation::after {
content: '';
position: absolute;
top: 100%;
left: 50%;
transform: translateX(-50%);
border: 6px solid transparent;
border-top-color: var(--dark-color);
}
.word-explanation.show {
display: block;
animation: fadeInUp 0.3s ease-out;
}
@keyframes fadeInUp {
from {
opacity: 0;
transform: translateX(-50%) translateY(10px);
}
to {
opacity: 1;
transform: translateX(-50%) translateY(0);
}
}
.hidden-text {
background: var(--hidden-bg);
color: transparent;
border-radius: 4px;
padding: 4px 8px;
transition: var(--transition);
user-select: none;
cursor: pointer;
}
.hidden-text:hover {
background: rgba(127, 179, 213, 0.2);
}
.hidden-text.revealed {
background: transparent;
color: inherit;
cursor: default;
}
.test-mode .hidden-text {
cursor: not-allowed;
}
.test-mode .hidden-text:hover {
background: var(--hidden-bg);
}
.sentence-container {
margin-bottom: 15px;
}
.character {
color: var(--primary-color);
font-weight: 600;
cursor: pointer;
border-bottom: 2px dotted var(--primary-color);
padding: 2px 4px;
border-radius: 3px;
transition: var(--transition);
}
.character:hover {
background: rgba(127, 179, 213, 0.1);
}
.explanation {
display: none;
padding-left: 20px;
color: var(--dark-color);
font-style: italic;
margin-top: 8px;
border-left: 3px solid var(--secondary-color);
padding: 8px 0 8px 15px;
}
.explanation.revealed {
display: block;
animation: slideDown 0.3s ease-out;
}
@keyframes slideDown {
from {
opacity: 0;
max-height: 0;
}
to {
opacity: 1;
max-height: 100px;
}
}
.common-word {
background: linear-gradient(135deg, rgba(127, 179, 213, 0.2), rgba(162, 217, 206, 0.2));
padding: 2px 6px;
border-radius: 4px;
font-weight: 600;
}
.history-modal {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: var(--overlay-bg);
display: flex;
justify-content: center;
align-items: center;
z-index: 2000;
opacity: 0;
visibility: hidden;
transition: opacity 0.3s, visibility 0s 0.3s;
}
.history-modal.is-visible {
opacity: 1;
visibility: visible;
transition-delay: 0s;
}
.history-container {
width: 90%;
max-width: 700px;
max-height: 80vh;
border-radius: var(--border-radius);
padding: 1.5rem 2rem;
display: flex;
flex-direction: column;
box-shadow: var(--shadow-heavy);
transform: scale(0.95);
transition: transform 0.3s, background-color 0.4s;
background-color: var(--light-color);
border: 2px solid var(--primary-color);
}
.history-modal.is-visible .history-container {
transform: scale(1);
}
.history-header {
display: flex;
justify-content: space-between;
align-items: center;
padding-bottom: 1rem;
margin-bottom: 1rem;
border-bottom: 1px solid var(--light-accent);
}
.history-header h2 {
font-size: 1.5rem;
font-weight: 500;
color: var(--primary-color);
}
.history-controls {
display: flex;
gap: 1rem;
margin-bottom: 1rem;
}
#history-search,
#history-sort {
flex-grow: 1;
padding: 0.5rem 0.75rem;
border-radius: var(--border-radius-small);
font-size: 1rem;
font-family: 'Noto Sans TC', sans-serif;
background-color: #f8fafa;
border: 1px solid var(--light-accent);
color: var(--text-color);
}
#history-search:focus,
#history-sort:focus {
outline: none;
border-color: var(--primary-color);
}
.history-list {
list-style: none;
overflow-y: auto;
flex-grow: 1;
}
.history-list li {
display: flex;
justify-content: space-between;
align-items: center;
gap: 1rem;
padding: 1rem;
border-radius: 5px;
transition: background-color 0.2s;
border-bottom: 1px solid var(--light-accent);
}
.history-list li:hover {
background-color: #f0f8ff;
}
.history-list li:last-child {
border-bottom: none;
}
.history-item-content {
flex-grow: 1;
cursor: pointer;
min-width: 0; /* Fix for flexbox overflow */
}
.history-list-item-title {
font-family: 'Noto Serif TC', serif;
font-size: 1.2rem;
font-weight: 600;
color: var(--dark-color);
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
display: flex;
align-items: center;
}
.history-title-edit {
width: 100%;
font-family: 'Noto Serif TC', serif;
font-size: 1.2rem;
padding: 4px 6px;
border: 1px solid var(--primary-color);
border-radius: 4px;
outline: none;
}
.history-list-item-meta {
font-family: 'Noto Sans TC', sans-serif;
font-size: 0.9rem;
margin-top: 0.25rem;
color: #7f8c8d;
}
.no-history-msg {
padding: 2rem;
text-align: center;
justify-content: center;
color: #7f8c8d;
cursor: default;
}
.no-history-msg:hover {
background-color: transparent;
}
.history-item-actions {
display: flex;
align-items: center;
gap: 0.5rem;
flex-shrink: 0;
}
.icon-btn {
min-width: unset;
flex: none;
background: transparent;
border: none;
cursor: pointer;
padding: 6px;
border-radius: 50%;
display: inline-flex;
justify-content: center;
align-items: center;
transition: background-color 0.2s, transform 0.2s;
opacity: 0.8;
line-height: 1;
color: var(--dark-color);
}
.icon-btn:hover {
background-color: var(--hidden-bg);
opacity: 1;
}
.icon-btn:active {
transform: scale(0.95);
}
#history-close-btn, .regenerate-history-btn, .edit-history-btn, .delete-history-btn,
#mode-selection-close-btn {
/* Inherits from .icon-btn */
}
.regenerate-history-btn .fas { color: var(--highlight-color); }
.edit-history-btn .fas { color: var(--primary-color); }
.delete-history-btn .fas { color: var(--error-color); }
#delete-all-history-btn {
min-width: unset;
flex: none;
width: auto;
padding: 6px 12px;
border-radius: var(--border-radius-small);
gap: 0.5rem;
color: var(--error-color);
opacity: 0.8;
background: transparent;
border: 1px solid transparent;
transition: all 0.2s ease;
}
#delete-all-history-btn:hover {
opacity: 1;
background-color: rgba(231, 76, 60, 0.1);
color: var(--error-color);
transform: none;
}
#delete-all-history-btn .fas {
color: var(--error-color);
}
@media (max-width: 768px) {
.floating-original::after {
content: '';
position: absolute;
bottom: 0;
left: 50%;
transform: translateX(-50%);
width: 50px;
height: 5px;
background: var(--primary-color);
border-radius: 3px 3px 0 0;
cursor: ns-resize;
}
.history-controls {
flex-direction: column;
}
}
::-webkit-scrollbar {
width: 10px;
}
::-webkit-scrollbar-track {
background: rgba(127, 179, 213, 0.1);
border-radius: 5px;
}
::-webkit-scrollbar-thumb {
background: var(--primary-color);
border-radius: 5px;
}
::-webkit-scrollbar-thumb:hover {
background: var(--secondary-color);
}
.test-mode .character-breakdown {
border-left-color: var(--warning-color);
padding-bottom: 10px;
}
.test-mode .character-item {
cursor: pointer;
transition: background-color 0.2s, border-left-color 0.3s;
border-radius: var(--border-radius-small);
padding: 10px;
border-left: 3px solid transparent;
margin-bottom: 8px;
}
.test-mode .character-item:hover {
background-color: rgba(241, 196, 15, 0.1);
border-left-color: var(--warning-color);
}
.test-mode .character-item.found-correctly {
background-color: rgba(46, 204, 113, 0.1);
border-left-color: var(--success-color);
cursor: not-allowed;
}
.test-mode .character-item.answered-incorrectly {
background-color: rgba(231, 76, 60, 0.1);
border-left-color: var(--error-color);
cursor: not-allowed;
}
.test-mode .character-item.reveal-correct {
background-color: rgba(46, 204, 113, 0.1);
border-left-color: var(--success-color);
cursor: default;
}
.test-mode .character-item.reveal-user-error {
background-color: rgba(231, 76, 60, 0.1);
border-left-color: var(--error-color);
cursor: default;
}
.test-chances-counter {
text-align: center;
font-size: 1.2rem;
font-weight: 500;
margin-top: -15px;
margin-bottom: 25px;
padding: 10px;
background: rgba(169, 204, 227, 0.1);
border-radius: var(--border-radius-small);
color: var(--dark-color);
}
.test-chances-counter span {
font-weight: 700;
color: var(--primary-color);
margin: 0 5px;
font-size: 1.5rem;
}
#test-result-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: var(--overlay-bg);
z-index: 3000;
display: none;
flex-direction: column;
justify-content: center;
align-items: center;
color: white;
text-align: center;
padding: 20px;
opacity: 0;
transition: opacity 0.3s ease;
cursor: pointer;
}
#test-result-overlay.is-visible {
display: flex;
opacity: 1;
}
#test-result-content {
background: var(--light-color);
color: var(--text-color);
padding: 40px;
border-radius: var(--border-radius);
box-shadow: var(--shadow-heavy);
width: 90%;
max-width: 500px;
cursor: default;
}
#test-result-content h2 {
font-size: 2.2rem;
margin-bottom: 15px;
font-family: 'Noto Serif TC', serif;
}
#test-result-content p {
font-size: 1.1rem;
line-height: 1.7;
margin-bottom: 1.5rem;
}
#test-result-content .success-icon { color: var(--success-color); }
#test-result-content .failure-icon { color: var(--error-color); }
#test-result-content .success-icon,
#test-result-content .failure-icon {
font-size: 4rem;
margin-bottom: 20px;
}
.failure-answer-key {
margin-top: 25px;
text-align: left;
font-size: 1rem;
}
.failure-answer-key .original-mistake {
color: var(--error-color);
text-decoration: line-through;
}
.failure-answer-key .correct-answer {
color: var(--success-color);
font-weight: bold;
}
.title-with-icon-wrapper {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 25px;
padding-bottom: 15px;
border-bottom: 2px solid var(--light-accent);
}
.title-with-icon-wrapper .section-title {
margin-bottom: 0;
padding-bottom: 0;
border-bottom: none;
}
#history-icon-btn {
color: #015F78;
font-size: 1.3rem;
padding: 8px;
}
#history-icon-btn:hover {
background-color: transparent;
transform: none;
opacity: 0.8;
}
/* ===== æ–°å¢åŠä¿®è¨‚ï¼šéŠæˆ²æ¨¡å¼å°ˆç”¨æ¨£å¼ ===== */
#game-modal {
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    /* Desktop Background - default */
    background-image: linear-gradient(rgba(240, 248, 255, 0.92), rgba(240, 248, 255, 0.7)), url('https://i.ibb.co/SDhgHzTF/Whats-App-Image-2025-08-05-at-07-31-58.jpg');
}
@media (max-width: 1024px) {
    #game-modal {
        /* Tablet Background */
        background-image: linear-gradient(rgba(240, 248, 255, 0.92), rgba(240, 248, 255, 0.7)), url('https://i.ibb.co/23d32t1Y/Whats-App-Image-2025-08-05-at-07-33-22.jpg');
    }
}
@media (max-width: 768px) {
    #game-modal {
        /* Mobile Background */
        background-image: linear-gradient(rgba(240, 248, 255, 0.92), rgba(240, 248, 255, 0.7)), url('https://i.ibb.co/5XJLyN9S/Whats-App-Image-2025-08-05-at-07-32-15.jpg');
    }
}
.game-touch-panel-container {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 25vh; /* Responsive height */
    max-height: 200px;
    display: flex;
    z-index: 4001;
    pointer-events: none;
}
.game-touch-panel {
    width: 50%;
    height: 100%;
    background-color: rgba(153, 161, 175, 0.15);
    border-top: 2px solid rgba(153, 161, 175, 0.3);
    pointer-events: auto;
    /*ä¿®è¨‚ä¸‰ï¼šå¢åŠ  flex å±¬æ€§ä»¥ç½®ä¸­åœ–ç¤º*/
    display: flex;
    justify-content: center;
    align-items: center;
}
/*ä¿®è¨‚ä¸‰ï¼šç‚ºè§¸æ§æç¤ºåœ–ç¤ºå¢åŠ æ¨£å¼*/
.game-touch-panel > i {
    font-size: 3rem;
    color: rgba(44, 62, 80, 0.3);
    user-select: none; /* é˜²æ­¢ç”¨æˆ¶é¸å–åœ–ç¤º */
}

/* Hide on non-touch (hover-capable) desktop devices */
@media (hover: hover) and (pointer: fine) {
    .game-touch-panel-container {
        display: none;
    }
}
.game-answer-brick {
width: 180px; /* å¯¬åº¦èª¿æ•´ç‚ºé©åˆå®¹ç´æ–‡å­— */
height: 45px; /* é«˜åº¦èª¿æ•´ */
color: var(--text-color);
text-align: center;
line-height: 45px; /* èˆ‡é«˜åº¦ä¸€è‡´ä»¥å‚ç›´å±…ä¸­ */
font-size: 18px; /* å­—é«”å¤§å°èª¿æ•´ */
font-family: 'Noto Sans TC', sans-serif;
font-weight: 500;
border-radius: 8px;
padding: 0 10px; /* å¢åŠ å…§é‚Šè·é˜²æ­¢æ–‡å­—è²¼é‚Š */
overflow: hidden; /* è¶…å‡ºéƒ¨åˆ†éš±è— */
text-overflow: ellipsis; /* è¶…å‡ºéƒ¨åˆ†é¡¯ç¤ºçœç•¥è™Ÿ */
white-space: nowrap; /* ä¸æ›è¡Œ */
}


@media (max-width: 768px) {
.game-answer-brick {
font-size: 14px; /* æ‰‹æ©Ÿç‰ˆçš„æ–‡å­—å¤§å° */
}
}

#game-close-icon-btn {
pointer-events: auto;
background: transparent;
border: none;
font-size: clamp(20px, 2.5vw, 26px);
cursor: pointer;
color: var(--text-color);
padding: 0 15px;
opacity: 0.7;
transition: opacity 0.2s, transform 0.2s;
}
#game-close-icon-btn:hover {
opacity: 1;
transform: scale(1.1);
}

/* ===== æ–°å¢ï¼šæ–‡è¨€æ–‡è¼¸å…¥æ‡¸æµ®è¦–çª—ç¨ç«‹ CSS ===== */
.ocr-modal-overlay {
    display: none; /* é è¨­éš±è— */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(44, 62, 80, 0.75); /* ä½¿ç”¨èˆ‡æ–‡æ¨ä¸€è‡´çš„ overlay èƒŒæ™¯è‰² */
    z-index: 2500; /* è¨­å®šä¸€å€‹è¼ƒé«˜çš„ z-index */
    justify-content: center;
    align-items: center;
    padding: 1rem;
    box-sizing: border-box;
    backdrop-filter: blur(4px);
}

.ocr-modal-content {
    background-color: #fdfdfd;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.25);
    width: 90%;
    max-width: 750px; /* è¦–çª—æœ€å¤§å¯¬åº¦ */
    height: 85vh; /* è¦–çª—é«˜åº¦ä½”è¦–çª—çš„ 85% */
    max-height: 800px;
    position: relative;
    animation: ocrModalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column; /* è®“å…§éƒ¨å…ƒç´ å‚ç›´æ’åˆ— */
}

@keyframes ocrModalFadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.ocr-modal-content h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: var(--dark-color);
    font-size: 1.5rem;
    font-family: 'Noto Serif TC', serif;
    font-weight: 600;
    border-bottom: 2px solid var(--light-accent);
    padding-bottom: 15px;
}

#ocr-modal-textarea {
    width: 100%;
    box-sizing: border-box;
    font-size: 1.2em; /* ç¨å¤§çš„å­—é«”ï¼Œæ–¹ä¾¿é–±è®€ */
    line-height: 1.8;
    border: 2px solid var(--light-accent);
    border-radius: 8px;
    padding: 15px;
    flex-grow: 1; /* ä½”æ“šæ‰€æœ‰å‰©é¤˜ç©ºé–“ */
    resize: none; /* ç¦æ­¢æ‰‹å‹•èª¿æ•´å¤§å° */
    font-family: 'Noto Serif TC', serif;
    background-color: #fcfdff;
    transition: all 0.3s ease;
}

#ocr-modal-textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(127, 179, 213, 0.15);
}

/* ===== æœ€çµ‚ä¿®è¨‚ï¼šæ–‡è¨€æ–‡è¼¸å…¥æ‡¸æµ®è¦–çª—æŒ‰éˆ• (å®Œå…¨éš”é›¢æ¨£å¼) ===== */

.ocr-modal-buttons {
    /* ç§»é™¤æ‰€æœ‰ display: flex ç›¸é—œå±¬æ€§ */
    text-align: right; /* æ ¸å¿ƒï¼šé€™æœƒè®“æ‰€æœ‰ inline-block çš„å­å…ƒç´ é å³å°é½Š */
    margin-top: 20px;
}

/* 2. æŒ‰éˆ•æœ¬èº« */
.ocr-modal-btn {
    /* --- ä½ˆå±€èˆ‡å¤–è§€ --- */
    display: inline-block; /* å¿…é ˆæ˜¯ inline æˆ– inline-block æ‰èƒ½è¢« text-align å½±éŸ¿ */
    vertical-align: middle; /* ç¢ºä¿å‚ç›´å°é½Šä¸€è‡´ */
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    border: none;
    box-shadow: var(--shadow-light);
    text-decoration: none; /* ç§»é™¤å¯èƒ½çš„ä¸‹åŠƒç·š */
    
    /* --- ç‚ºæŒ‰éˆ•ä¹‹é–“æ·»åŠ é–“è· --- */
    margin-left: 10px; /* ç‚ºæ¯å€‹æŒ‰éˆ•å·¦å´æ·»åŠ é–“è· */

    /* --- å¼·åˆ¶å°ºå¯¸éš”é›¢ (ä½¿ç”¨ !important) --- */
    /* é€™äº›è¦å‰‡ç¢ºä¿æŒ‰éˆ•å¤§å°ä¸å—ä»»ä½•é€šç”¨æ¨£å¼å½±éŸ¿ */
    padding: 10px 20px !important;
    font-size: 14px !important;
    min-width: 0 !important;
    width: auto !important;
    flex: none !important; /* ç¢ºä¿ flex å±¬æ€§è¢«é‡ç½® */
}

/* è®“ç¬¬ä¸€å€‹æŒ‰éˆ•æ²’æœ‰å·¦é‚Šè·ï¼Œæ›´ç¾è§€ */
.ocr-modal-btn:first-child {
    margin-left: 0;
}

.ocr-modal-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    filter: brightness(110%);
}

/* 3. æŒ‰éˆ•çš„åœ–ç¤º (éœ€è¦æ‰‹å‹•æ·»åŠ ) */
.ocr-modal-btn .fas {
    margin-right: 8px; /* è®“åœ–ç¤ºå’Œæ–‡å­—ä¹‹é–“æœ‰ç©ºéš™ */
}


/* 4. æŒ‰éˆ•é¡è‰² (ä¿æŒä¸è®Š) */
.ocr-btn-confirm {
    background: var(--gradient-primary);
    color: white;
}

.ocr-btn-special {
    background: linear-gradient(135deg, #1abc9c, #16a085);
    color: white;
}


/* 5. ç°¡åŒ–æ‰‹æ©Ÿç‰ˆ CSS */
@media (max-width: 768px) {
    .ocr-modal-content {
        height: 90vh;
        padding: 20px;
    }
    #ocr-modal-textarea {
        font-size: 1.1em;
    }
    /* æŒ‰éˆ•å®¹å™¨å’ŒæŒ‰éˆ•çš„æ¨£å¼å·²åœ¨ä¸Šæ–¹å…¨å±€å®šç¾©ï¼Œæ­¤è™•ç„¡éœ€å†åšä»»ä½•ä¿®æ”¹ï¼Œ
       å®ƒå€‘æœƒè‡ªç„¶åœ°é©æ‡‰ä¸¦ä¿æŒåœ¨å³ä¸Šè§’ã€‚*/
}

.ocr-modal-close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    background: transparent;
    border: none;
    font-size: 2rem;
    color: #999;
    cursor: pointer;
    line-height: 1;
    transition: color 0.2s, transform 0.2s;
}

.ocr-modal-close-btn:hover {
    color: var(--dark-color);
    transform: rotate(90deg);
}

@media (max-width: 768px) {
    .ocr-modal-content {
        height: 90vh;
        padding: 20px;
    }
    #ocr-modal-textarea {
        font-size: 1.1em;
    }
    .ocr-modal-buttons {
        flex-direction: column;
        gap: 10px;
    }
    .ocr-modal-btn {
        width: 100%;
        padding: 14px;
    }
}

	
</style>
</head>
<body>
<!-- å¼•å…¥ Three.js å‡½å¼åº« -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<!-- å¼•å…¥ Three.js CSS2DRendererï¼Œç”¨æ–¼åœ¨ 3D å ´æ™¯ä¸­é¡¯ç¤º HTML æ¨™ç±¤ -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS2DRenderer.js"></script>


<div class="container">
<div class="input-section">
<div class="title-with-icon-wrapper">
<h2 class="section-title">å°‹æ‰¾ç¯‡ç« </h2>
<button id="history-icon-btn" class="icon-btn" title="é–±è®€ç´€éŒ„">
<i class="fas fa-history"></i>
</button>
</div>
<div class="form-group">
<label>é›£åº¦</label>
<div class="rating-dots" id="difficulty-rating" data-rating="3">
<div class="rating-dot" data-value="1"></div>
<div class="rating-dot" data-value="2"></div>
<div class="rating-dot" data-value="3"></div>
<div class="rating-dot" data-value="4"></div>
<div class="rating-dot" data-value="5"></div>
</div>
</div>
<div class="form-group">
<label for="ai-prompt">ä¸»é¡Œ</label>
<textarea id="ai-prompt" placeholder="å¯è¼¸å…¥ä¸»é¡Œï¼Œç•™ç©ºå‰‡éš¨æ©Ÿæ¨è–¦..."></textarea>
</div>
<button id="ai-search-btn" class="ai-search-btn">
<span class="btn-text">å°‹æ‰¾ç¯‡ç« </span>
</button>
<hr class="section-divider">
<h2 class="section-title">æˆ– æ‰‹å‹•è¼¸å…¥æ–‡è¨€ç¯‡ç« </h2>
<textarea id="classical-text" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ–‡è¨€æ–‡ç¯‡ç« å…§å®¹..."></textarea>
<div class="button-group">
<button id="translate-btn">
<i class="fas fa-language"></i> ç¿»è­¯
</button>
<button id="clear-btn" class="clear-btn">
<i class="fas fa-eraser"></i> æ¸…é™¤
</button>
</div>
<div class="error-message" id="error-message"></div>
</div>
<div class="output-section">
<div class="output-header">
<h2 class="section-title">ç¿»è­¯çµæœ</h2>
<button id="toggle-translations-btn" class="toggle-translations-btn" style="display: none;" title="é¡¯ç¤ºæ‰€æœ‰ç¿»è­¯åŠè§£é‡‹">
<i class="fas fa-eye"></i>
</button>
</div>
<div class="loading" id="loading">
<div class="spinner"></div>
<p>æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...</p>
</div>
<div id="output-content">
<div id="introduction-area" class="content-group-container"></div>
<div id="translation-area" class="content-group-container"></div>
</div>
</div>
<footer>
<div class="copyright-footer">
<p>Copyright Â© 2025 é»ƒå­è¬™ã€é™³å† å¥. All rights reserved</p>
</div>
</footer>
</div>
<!-- æ‡¸æµ®å¼åŸæ–‡é¡¯ç¤º -->
<div id="floating-original" class="floating-original resizable">
<div class="floating-header">
<div class="floating-title">åŸæ–‡</div>
<div class="floating-controls">
<button id="floating-toggle" class="floating-toggle" title="é—œé–‰æ‡¸æµ®çª—">
<i class="fas fa-times"></i>
</button>
</div>
</div>
<div class="floating-content">
<div id="floating-original-text" class="floating-original-text"></div>
</div>
</div>
<!-- é‡æ–°é–‹å•Ÿæ‡¸æµ®çª—æŒ‰éˆ• -->
<button id="reopen-floating" class="reopen-floating" title="é–‹å•ŸåŸæ–‡æ‡¸æµ®çª—">
<i class="fas fa-scroll"></i>
</button>
<!-- æ­·å²ç´€éŒ„å½ˆå‡ºå±¤ (Modal) -->
<div class="history-modal" id="history-modal">
<div class="history-container">
<div class="history-header">
<h2>é–±è®€ç´€éŒ„</h2>
<button class="icon-btn" id="history-close-btn" title="é—œé–‰">
<i class="fas fa-times"></i>
</button>
</div>
<div class="history-controls">
<input type="search" id="history-search" placeholder="æœå°‹æ¨™é¡Œæˆ–ä½œè€…...">
<select id="history-sort">
<option value="date_desc">æŒ‰ç”Ÿæˆæ—¥æœŸ (æ–°åˆ°èˆŠ)</option>
<option value="date_asc">æŒ‰ç”Ÿæˆæ—¥æœŸ (èˆŠåˆ°æ–°)</option>
</select>
</div>
<ul class="history-list" id="history-list"></ul>
<button class="icon-btn" id="delete-all-history-btn" title="åˆªé™¤å…¨éƒ¨ç´€éŒ„" style="margin-top: 1rem; align-self: flex-end;">
<i class="fas fa-trash-alt"></i> åˆªé™¤å…¨éƒ¨
</button>
</div>
</div>

<!-- æ¨¡å¼é¸æ“‡å½ˆå‡ºå±¤ (Modal) -->
<div id="mode-selection-modal" class="history-modal">
<div class="history-container" style="max-width: 400px; text-align: center;">
<div class="history-header">
<h2 id="mode-selection-title">é¸æ“‡æ¨¡å¼</h2>
<button class="icon-btn" id="mode-selection-close-btn" title="é—œé–‰">
<i class="fas fa-times"></i>
</button>
</div>
<p style="margin: 20px 0 30px;">è«‹é¸æ“‡æ¨¡å¼ï¼š</p>
<div class="button-group" style="flex-direction: column; gap: 20px;">
<button id="read-mode-btn" style="width: 100%;"><i class="fas fa-book-open"></i> é–±è®€æ¨¡å¼</button>
<button id="test-mode-btn" style="width: 100%; background: var(--gradient-accent);"><i class="fas fa-vial"></i> æ¸¬é©—æ¨¡å¼</button>
<button id="game-mode-btn" style="width: 100%; background: linear-gradient(135deg, #A3B3FF, #7C86FF);"><i class="fas fa-gamepad"></i> éŠæˆ²æ¨¡å¼</button>
</div>
</div>
</div>

<!-- æ¸¬è©¦çµæœè¦†è“‹å±¤ -->
<div id="test-result-overlay">
<div id="test-result-content">
<!-- å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
</div>
</div>

<!-- ===== 3D æ‰“ç£šå¡ŠéŠæˆ²æ¨¡å¼ Modal ===== -->
<div id="game-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 4000; color: var(--text-color); cursor: default;">
<div id="game-canvas-container" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></div>

<div style="position: absolute; top: 0; left: 0; right: 0; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-start; align-items: center;">
<!-- é é¢é ‚éƒ¨ (Top of Page) -->
<!--ä¿®è¨‚ï¼šæ¸›å°‘ padding-top ä»¥ä¾¿å°‡å®¹å™¨ä¸Šç§»ï¼Œä½¿å…¶ä¸è¶…å‡ºé ‚éƒ¨ç‰†ç•Œ-->
<div id="game-top-area" style="width: 100%; text-align: center; padding: 15px 20px;">
<div id="game-hud" style="display: flex; justify-content: space-between; align-items: center; font-size: clamp(16px, 2vw, 24px); font-weight: bold; max-width: 800px; margin: 0 auto 5px; color: var(--text-color);">
<div id="game-score" style="flex: 1; text-align: left;">åˆ†æ•¸: 0</div>
<button id="game-close-icon-btn" title="é—œé–‰éŠæˆ²">
<i class="fas fa-times"></i>
</button>
<div id="game-lives" style="flex: 1; text-align: right;">ç”Ÿå‘½: â™¥ â™¥ â™¥</div>
</div>
<!--ä¿®è¨‚ï¼šå¢åŠ  max-width å’Œ widthï¼Œä½¿å®¹å™¨å¯¬åº¦èˆ‡é é¢ï¼ˆéŠæˆ²å€åŸŸï¼‰æ›´ç›¸ç¬¦-->
<div id="game-question-container" style="background: rgba(255, 255, 255, 0.5); border-radius: var(--border-radius-small); padding: 10px 20px; box-shadow: var(--shadow-light); max-width: 800px; width: 95%; margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(127, 179, 213, 0.2);">
    <div id="game-question" style="font-size: clamp(26px, 2.5vw, 32px); text-align: left; font-family: 'Noto Serif TC', serif; line-height: 1.5; color: var(--text-color); width: 100%;"></div>
</div>
</div>

<div id="game-loader" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: auto;">
<div class="spinner" style="width: 80px; height: 80px; border-top-color: var(--primary-color); margin: 0 auto 20px;"></div>
<p style="font-size: 24px; color: var(--text-color);">æ­£åœ¨æº–å‚™éŠæˆ²ï¼Œè«‹ç¨å€™...</p>
</div>

<div id="game-over-screen" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #2c3e50; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: default; pointer-events: auto; color: white;">
<h2 style="font-size: clamp(32px, 5vw, 48px); font-family: 'Noto Serif TC', serif;">éŠæˆ²çµæŸ</h2>
<p id="game-final-score" style="font-size: clamp(24px, 3.5vw, 32px); margin: 20px 0;">æœ€çµ‚å¾—åˆ†: 0</p>
<div class="button-group" style="flex-direction: row; justify-content: center; gap: 20px;">
<button id="game-restart-btn">é‡æ–°é–‹å§‹</button>
<button id="game-close-btn" class="clear-btn">é—œé–‰éŠæˆ²</button>
</div>
</div>
</div>

<!-- åŠé€æ˜è§¸æ§é¢æ¿ï¼Œå¢åŠ æç¤ºåœ–ç¤º -->
<div class="game-touch-panel-container">
	<div id="game-touch-left" class="game-touch-panel">
        <i class="fas fa-chevron-left"></i>
    </div>
	<div id="game-touch-right" class="game-touch-panel">
        <i class="fas fa-chevron-right"></i>
    </div>
</div>
</div>



<!-- =============================================================== -->
<!-- 2. ç¥æ€åš´æ ¼æ¬Šé™é– (ç­‰å¾…æ©Ÿåˆ¶ä¿®å¾©ç‰ˆ) -->
<!-- =============================================================== -->
<script>
(function() {
    if (window.SansiInterceptorLoaded) return;
    window.SansiInterceptorLoaded = true;

    // --- æ³¨å…¥ CSS ---
    const style = document.createElement('style');
    style.textContent = `
        .sansi-limit-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(253, 252, 248, 0.95); backdrop-filter: blur(8px); z-index: 9999999; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .sansi-limit-show { opacity: 1; }
        .sansi-limit-card { background: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 16px; padding: 35px 25px; width: 90%; max-width: 380px; box-shadow: 0 15px 40px rgba(141, 110, 99, 0.2); text-align: center; transform: translateY(20px); transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); font-family: 'Noto Serif TC', serif; }
        .sansi-limit-show .sansi-limit-card { transform: translateY(0); }
        .sansi-limit-icon { font-size: 3.5rem; color: #d69a92; margin-bottom: 20px; }
        .sansi-limit-title { color: #5d4037; font-size: 1.5rem; font-weight: bold; margin: 0 0 15px 0; }
        .sansi-limit-desc { color: #666; font-size: 1.1rem; line-height: 1.6; margin-bottom: 30px; }
        .sansi-btn-group { display: flex; gap: 12px; margin-top: 10px; }
        .sansi-limit-btn { border: none; padding: 12px 0; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; font-family: 'Noto Serif TC', serif; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; }
        .btn-primary { background: #8fa398; color: white; box-shadow: 0 4px 12px rgba(143, 163, 152, 0.4); }
        .btn-primary:hover { background-color: #7d9186; transform: translateY(-2px); }
        .btn-secondary { background: #f0f0f0; color: #777; }
        .btn-secondary:hover { background-color: #e5e5e5; }
    `;
    document.head.appendChild(style);

    // --- æ³¨å…¥ HTML ---
    const modalHTML = `
        <div id="sansiLimitModal" class="sansi-limit-overlay">
            <div class="sansi-limit-card">
                <div class="sansi-limit-icon"><i class="fas fa-lock"></i></div>
                <div class="sansi-limit-title">æœƒå“¡é™å®šåŠŸèƒ½</div>
                <div class="sansi-limit-desc">
                    æ­¤åŠŸèƒ½åƒ…é–‹æ”¾çµ¦ç¥æ€ç™»å…¥ç”¨æˆ¶ã€‚<br>è«‹å…ˆç™»å…¥å­¸æ ¡å¸³è™Ÿä»¥ç¹¼çºŒä½¿ç”¨ã€‚
                </div>
                <div class="sansi-btn-group">
                    <button class="sansi-limit-btn btn-secondary" onclick="closeSansiLimitModal()">å–æ¶ˆ</button>
                    <button class="sansi-limit-btn btn-primary" onclick="window.location.href='../index2.html'">
                        <i class="fas fa-sign-in-alt"></i> å‰å¾€ç™»å…¥
                    </button>
                </div>
            </div>
        </div>
    `;
    const div = document.createElement('div');
    div.innerHTML = modalHTML;
    document.body.appendChild(div);

    window.closeSansiLimitModal = function() {
        const modal = document.getElementById('sansiLimitModal');
        if (modal) {
            modal.classList.remove('sansi-limit-show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
            if (typeof loading !== 'undefined') loading.style.display = 'none';
        }
    };

    // --- â˜…â˜…â˜… æ ¸å¿ƒæ””æˆªå™¨ (Waiting Logic Added) â˜…â˜…â˜… ---
    const originalFetch = window.fetch;
    
    window.fetch = async function(url, options) {
        if (typeof url === 'string' && url.includes('script.google.com') && options && options.method === 'POST') {
            
            console.log("[WenShu] æ””æˆªè«‹æ±‚ï¼Œæº–å‚™æª¢æŸ¥æ¬Šé™...");

            // 1. ç­‰å¾… Firebase åˆå§‹åŒ– (æœ€å¤šç­‰ 2 ç§’)
            // é€™ä¸€æ­¥æ˜¯è§£æ±ºå•é¡Œçš„é—œéµï¼
            const user = await new Promise((resolve) => {
                if (firebase.auth().currentUser) {
                    resolve(firebase.auth().currentUser);
                } else {
                    const unsubscribe = firebase.auth().onAuthStateChanged(u => {
                        unsubscribe();
                        resolve(u);
                    });
                    // 2ç§’è¶…æ™‚æ©Ÿåˆ¶ï¼Œé¿å…ç„¡é™ç­‰å¾…
                    setTimeout(() => resolve(null), 2000);
                }
            });

            // 2. å†æ¬¡æª¢æŸ¥ LocalStorage (é›™é‡é©—è­‰)
            const s = localStorage.getItem('studentProfile');

            if (!s) {
                console.warn("ğŸš« é˜»æ“‹ï¼šæœ¬åœ°ç„¡å­¸ç”Ÿè³‡æ–™");
                const modal = document.getElementById('sansiLimitModal');
                modal.style.display = 'flex';
                void modal.offsetWidth; 
                modal.classList.add('sansi-limit-show');
                
                const loadingEl = document.getElementById('loading');
                if(loadingEl) loadingEl.style.display = 'none';

                return Promise.reject(new Error("Login Required"));
            }

            // 3. æ³¨å…¥ Token (å¦‚æœ User å­˜åœ¨)
            if (user) {
                try {
                    const token = await user.getIdToken();
                    let bodyData = JSON.parse(options.body);
                    bodyData.token = token; 
                    options.body = JSON.stringify(bodyData);
                    console.log("âœ… Token æ³¨å…¥æˆåŠŸ");
                } catch (e) {
                    console.error("Token ç²å–å¤±æ•— (å¯èƒ½æ†‘è­‰å·²éæœŸ):", e);
                    // é€™è£¡ä¸é˜»æ“‹ï¼Œå˜—è©¦ç™¼é€ï¼Œè®“å¾Œç«¯æ±ºå®šæ˜¯å¦æ‹’çµ•
                }
            } else {
                console.warn("âš ï¸ æ³¨æ„ï¼šæœ‰å­¸ç”Ÿè³‡æ–™ä½† Firebase æœªé€£ç·š (Token æœªæ³¨å…¥)");
            }
        }
        
        return originalFetch(url, options);
    };
    
    console.log("ğŸ”’ æ–‡æ¨æ™ºèƒ½æ¬Šé™é–å·²å•Ÿå‹•");
})();

</script>


	
<script>
// ===============================================================
// API é…ç½®ä¿¡æ¯ (å·²æ›´æ–°ç‚ºå‰ç«¯ç›´æ¥å‘¼å«)
// ===============================================================
 
// å®šç¾© API é‡‘é‘°åˆ—è¡¨
const API_KEYS = ["friend1"];
 
// å®šç¾© API ç«¯é»
const API_URL = "https://api-fawn-chi.vercel.app/api/v1/chat/completions";
 
// å®šç¾©æ¨¡å‹åç¨±
const MODEL = "qwen-3-235b-a22b-instruct-2507";
 
// æ‡¸æµ®çª—ç‹€æ…‹ç®¡ç† (ä¿æŒä¸è®Š)
let isFloatingEnabled = true;
let currentOriginalTexts = [];
// App ç‹€æ…‹ç®¡ç†
const HISTORY_KEY = 'wenshu_history_v3';
let state = {
difficulty: 3,
history: [],
};

// æ¸¬è©¦æ¨¡å¼ç‹€æ…‹è®Šæ•¸
let testState = {
isActive: false,
chances: 7,
mistakesFound: 0,
totalMistakes: 5,
currentItemId: null,
wronglyClickedItems: [],
mistakeItems: [],
};

// ===== éŠæˆ²æ¨¡å¼ç‹€æ…‹è®Šæ•¸ =====
let gameState = {
isActive: false,
isBallLaunched: false,
lives: 3,
score: 0,
baseSpeed: 0.22, // MODIFIED: é è¨­é€Ÿåº¦ç¨ç‚ºåŠ å¿«
speedMultiplier: 1.0, 
currentItemId: null,
};


document.addEventListener('DOMContentLoaded', function() {
// --- DOM Elements ---
const translateBtn = document.getElementById('translate-btn');
const clearBtn = document.getElementById('clear-btn');
const toggleTranslationsBtn = document.getElementById('toggle-translations-btn');
const classicalText = document.getElementById('classical-text');
const loading = document.getElementById('loading');
const errorMessage = document.getElementById('error-message');
const introductionArea = document.getElementById('introduction-area');
const translationArea = document.getElementById('translation-area');
const floatingOriginal = document.getElementById('floating-original');
const floatingToggle = document.getElementById('floating-toggle');
const floatingOriginalText = document.getElementById('floating-original-text');
const reopenFloating = document.getElementById('reopen-floating');
const aiSearchBtn = document.getElementById('ai-search-btn');
const difficultyRating = document.getElementById('difficulty-rating');
const ratingDots = difficultyRating.querySelectorAll('.rating-dot');
const aiPromptTextarea = document.getElementById('ai-prompt');
const historyModal = document.getElementById('history-modal');
const historyCloseBtn = document.getElementById('history-close-btn');
const historyList = document.getElementById('history-list');
const historySearch = document.getElementById('history-search');
const historySort = document.getElementById('history-sort');
const deleteAllHistoryBtn = document.getElementById('delete-all-history-btn');
const historyIconBtn = document.getElementById('history-icon-btn');

// --- æ¨¡å¼é¸æ“‡ DOM Elements ---
const modeSelectionModal = document.getElementById('mode-selection-modal');
const modeSelectionCloseBtn = document.getElementById('mode-selection-close-btn');
const modeSelectionTitle = document.getElementById('mode-selection-title');
const readModeBtn = document.getElementById('read-mode-btn');
const testModeBtn = document.getElementById('test-mode-btn');
const testResultOverlay = document.getElementById('test-result-overlay');

// --- éŠæˆ²æ¨¡å¼ DOM Elements ---
const gameModeBtn = document.getElementById('game-mode-btn');
const gameModal = document.getElementById('game-modal');
const gameCanvasContainer = document.getElementById('game-canvas-container');
const gameLoader = document.getElementById('game-loader');
const gameOverScreen = document.getElementById('game-over-screen');
const gameQuestion = document.getElementById('game-question');
const gameLives = document.getElementById('game-lives');
const gameScore = document.getElementById('game-score');
const gameFinalScore = document.getElementById('game-final-score');
const gameRestartBtn = document.getElementById('game-restart-btn');
const gameCloseBtn = document.getElementById('game-close-btn');
const gameCloseIconBtn = document.getElementById('game-close-icon-btn');


// --- Initialization ---
initializeApp();

// --- Main App Initializer ---
function initializeApp() {
loadHistory();
initFloatingWindow();
updateRatingDots();
setupEventListeners();
autoResizeTextarea.call(classicalText);
autoResizeTextarea.call(aiPromptTextarea);
}

function setupEventListeners() {
translateBtn.addEventListener('click', handleManualTranslateClick);
clearBtn.addEventListener('click', handleClearClick);
toggleTranslationsBtn.addEventListener('click', handleToggleTranslations);
window.addEventListener('resize', handleWindowResize);
classicalText.addEventListener('input', autoResizeTextarea);
aiPromptTextarea.addEventListener('input', autoResizeTextarea);
floatingToggle.addEventListener('click', handleFloatingToggle);
reopenFloating.addEventListener('click', handleReopenFloating);
if (getDeviceType() === 'mobile') {
floatingOriginal.addEventListener('mousedown', startResize);
floatingOriginal.addEventListener('touchstart', startResize);
}
aiSearchBtn.addEventListener('click', handleAiSearch);
ratingDots.forEach(dot => {
dot.addEventListener('click', () => {
state.difficulty = parseInt(dot.dataset.value);
difficultyRating.dataset.rating = state.difficulty;
updateRatingDots();
});
dot.addEventListener('mouseover', () => {
const hoverValue = parseInt(dot.dataset.value);
ratingDots.forEach(d => d.classList.toggle('selected', d.dataset.value <= hoverValue));
});
});
difficultyRating.addEventListener('mouseout', updateRatingDots);
historyIconBtn.addEventListener('click', showHistory); 
historyCloseBtn.addEventListener('click', hideHistory);
deleteAllHistoryBtn.addEventListener('click', handleDeleteAllHistory);
historyModal.addEventListener('click', (e) => {
if (e.target === historyModal) hideHistory();
});
historyList.addEventListener('click', handleHistoryListClick);
historySearch.addEventListener('input', renderHistory);
historySort.addEventListener('change', renderHistory);

// --- æ¨¡å¼é¸æ“‡äº‹ä»¶ç›£è½ ---
modeSelectionCloseBtn.addEventListener('click', hideModeSelection);
modeSelectionModal.addEventListener('click', (e) => {
if (e.target === modeSelectionModal) hideModeSelection();
});
readModeBtn.addEventListener('click', handleReadMode);
testModeBtn.addEventListener('click', handleTestMode);
testResultOverlay.addEventListener('click', () => {
testResultOverlay.classList.remove('is-visible');
});
translationArea.addEventListener('click', handleTestAnswer);

// --- éŠæˆ²æ¨¡å¼äº‹ä»¶ç›£è½ ---
gameModeBtn.addEventListener('click', prepareGame);
gameCloseBtn.addEventListener('click', closeGame);
gameCloseIconBtn.addEventListener('click', closeGame);
gameRestartBtn.addEventListener('click', () => {
gameOverScreen.style.display = 'none';
prepareGame();
});

// ===== æ–°å¢ï¼šæ–‡è¨€æ–‡è¼¸å…¥æ‡¸æµ®è¦–çª—èˆ‡ OCR é‚è¼¯ =====

// 1. ç²å–ç›¸é—œ DOM å…ƒç´ 
const classicalTextInput = document.getElementById('classical-text');
const ocrModal = document.getElementById('ocr-input-modal');
const ocrModalTextarea = document.getElementById('ocr-modal-textarea');
const ocrModalSaveBtn = document.getElementById('ocr-modal-save-btn');
const ocrModalCloseBtn = document.getElementById('ocr-modal-close-btn');
const ocrModalOcrBtn = document.getElementById('ocr-modal-ocr-btn');

let ocrWindow = null; // ç”¨æ–¼å­˜æ”¾ OCR å­è¦–çª—çš„åƒç…§
const OCR_TOOL_URL = 'https://gemini-ocr-proxy.vercel.app/'; // æ‚¨çš„ OCR å·¥å…· URL

// 2. ç‚ºåŸæ–‡è¼¸å…¥æ¡†æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½
classicalTextInput.addEventListener('click', (event) => {
    event.preventDefault(); // é˜²æ­¢å¯èƒ½çš„é è¨­è¡Œç‚º
    openOcrModal();
});

// 3. å®šç¾©é–‹å•Ÿæ‡¸æµ®è¦–çª—çš„å‡½æ•¸
function openOcrModal() {
    // å°‡åŸæ–‡è¼¸å…¥æ¡†çš„ç¾æœ‰å…§å®¹ï¼Œè¤‡è£½åˆ°æ‡¸æµ®è¦–çª—çš„ textaera ä¸­
    ocrModalTextarea.value = classicalTextInput.value;
    
    // é¡¯ç¤ºæ‡¸æµ®è¦–çª—
    ocrModal.style.display = 'flex';
    ocrModalTextarea.focus(); // è‡ªå‹•èšç„¦ï¼Œæ–¹ä¾¿ç”¨æˆ¶ç«‹å³è¼¸å…¥
}

// 4. å®šç¾©é—œé–‰æ‡¸æµ®è¦–çª—çš„å‡½æ•¸
function closeOcrModal() {
    ocrModal.style.display = 'none';
}

// 5. å®šç¾©ä¿å­˜ä¸¦é—œé–‰çš„å‡½æ•¸
function saveAndCloseOcrModal() {
    // å°‡æ‡¸æµ®è¦–çª— textaera çš„å…§å®¹ï¼Œå›å¯«åˆ°åŸæ–‡è¼¸å…¥æ¡†
    classicalTextInput.value = ocrModalTextarea.value;
    
    // æ‰‹å‹•è§¸ç™¼ input äº‹ä»¶ï¼Œä»¥ç¢ºä¿ autoResizeTextarea ç­‰ç›¸é—œç›£è½å™¨èƒ½å¤ è¢«è§¸ç™¼
    classicalTextInput.dispatchEvent(new Event('input', { bubbles: true }));
    
    closeOcrModal();
}

// 6. ç‚ºæ‡¸æµ®è¦–çª—çš„å„å€‹æŒ‰éˆ•ç¶å®šäº‹ä»¶
ocrModalSaveBtn.addEventListener('click', saveAndCloseOcrModal);
ocrModalCloseBtn.addEventListener('click', closeOcrModal);
ocrModal.addEventListener('click', (event) => {
    // å¦‚æœé»æ“Šçš„æ˜¯åŠé€æ˜çš„èƒŒæ™¯å±¤ï¼Œå‰‡é—œé–‰è¦–çª—
    if (event.target === ocrModal) {
        closeOcrModal();
    }
});

// 7. OCR åŠŸèƒ½é‚è¼¯
ocrModalOcrBtn.addEventListener('click', () => {
    if (ocrWindow && !ocrWindow.closed) {
        ocrWindow.focus();
        return;
    }
    // æ‰“é–‹ä¸€å€‹æ–°çš„å­è¦–çª—ä¾†è¼‰å…¥ OCR å·¥å…·
    ocrWindow = window.open(OCR_TOOL_URL, 'OCRWindow', 'width=650,height=850,scrollbars=yes,resizable=yes');
});

// 8. ç›£è½ä¾†è‡ª OCR å­è¦–çª—çš„è¨Šæ¯
window.addEventListener('message', (event) => {
    // å®‰å…¨æ€§æª¢æŸ¥ï¼šç¢ºä¿è¨Šæ¯ä¾†è‡ªæ–¼æˆ‘å€‘ä¿¡ä»»çš„ OCR å·¥å…·æº
    if (event.origin !== new URL(OCR_TOOL_URL).origin) {
        return;
    }

    // æª¢æŸ¥è¨Šæ¯æ ¼å¼æ˜¯å¦ç‚ºæˆ‘å€‘å®šç¾©çš„ OCR çµæœ
    if (event.data && event.data.type === 'ocrResult') {
        const ocrText = event.data.text;
        
        // å°‡è¾¨è­˜çµæœé™„åŠ åˆ°æ‡¸æµ®è¦–çª—çš„ textarea ä¸­
        ocrModalTextarea.value += (ocrModalTextarea.value.trim() ? '\n\n' : '') + ocrText;
        
        // æ”¶åˆ°çµæœå¾Œï¼Œè‡ªå‹•é—œé–‰ OCR å­è¦–çª—
        if (ocrWindow) {
            ocrWindow.close();
        }
        
        // å°‡ç„¦é»ç§»å›è¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿ç”¨æˆ¶ç¹¼çºŒç·¨è¼¯
        ocrModalTextarea.focus();
    }
});

	
}





// --- Event Handlers & Core Logic ---
function autoResizeTextarea() {
this.style.height = 'auto';
this.style.height = (this.scrollHeight) + 'px';
}

function handleManualTranslateClick() {
const text = classicalText.value.trim();
if (!text) {
showError('è«‹è¼¸å…¥æ–‡è¨€æ–‡å…§å®¹');
return;
}
const articleInfo = {
title: `æ‰‹å‹•è¼¸å…¥: ${text.substring(0, 15)}...`,
author: 'N/A',
content: text,
isManual: true,
id: new Date().toISOString()
};
processAndDisplay(articleInfo);
}

async function handleAiSearch() {
setAiSearchLoading(true);
hideError();
try {
const article = await generateProse();
if (article && article.title && article.content) {
await processAndDisplay(article);
} else {
showError("AI æœªèƒ½è¿”å›æœ‰æ•ˆçš„ç¯‡ç« ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
}
} catch (error) {
console.error('AI å°‹æ‰¾ç¯‡ç« æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
showError(`AI å°‹æ‰¾ç¯‡ç« æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
} finally {
setAiSearchLoading(false);
}
}

function handleClearClick() {
classicalText.value = '';
aiPromptTextarea.value = '';
introductionArea.innerHTML = '';
translationArea.innerHTML = '';
currentOriginalTexts = [];
hideFloatingOriginal();
hideError();
toggleTranslationsBtn.style.display = 'none';
translationArea.classList.remove('test-mode');
const counter = document.querySelector('.test-chances-counter');
if (counter) counter.remove();
autoResizeTextarea.call(classicalText);
autoResizeTextarea.call(aiPromptTextarea);
}

function handleToggleTranslations() {
if (testState.isActive) return;

const sentences = document.querySelectorAll('.hidden-text');
const explanations = document.querySelectorAll('.explanation');
if (sentences.length === 0 && explanations.length === 0) return;

const areRevealed = sentences.length > 0 ? sentences[0].classList.contains('revealed') : explanations[0].classList.contains('revealed');

sentences.forEach(s => s.classList.toggle('revealed', !areRevealed));
explanations.forEach(e => e.classList.toggle('revealed', !areRevealed));

const icon = toggleTranslationsBtn.querySelector('i');
if (!areRevealed) {
icon.className = 'fas fa-eye-slash';
toggleTranslationsBtn.title = 'éš±è—æ‰€æœ‰ç¿»è­¯åŠè§£é‡‹';
} else {
icon.className = 'fas fa-eye';
toggleTranslationsBtn.title = 'é¡¯ç¤ºæ‰€æœ‰ç¿»è­¯åŠè§£é‡‹';
}
}


function handleWindowResize() {
initFloatingWindow();
if (currentOriginalTexts.length > 0) {
showFloatingOriginal();
}
// Handle game resize if active
if (gameState.isActive && game.camera) {
const width = gameCanvasContainer.clientWidth;
const height = gameCanvasContainer.clientHeight;
const isMobile = window.innerWidth <= 768;

game.camera.aspect = width / height;
// ä¿®æ”¹ï¼šå°‡æ‰‹æ©Ÿçš„æ”å½±æ©Ÿæ‹‰å¾—æ›´é ï¼Œå¾ 55 æ”¹ç‚º 68
game.camera.position.z = isMobile ? 80 : 35; // Adjust camera on resize
game.camera.updateProjectionMatrix();

game.renderer.setSize(width, height);
game.labelRenderer.setSize(width, height);
}
}


async function processAndDisplay(articleInfo) {
loading.style.display = 'block';
introductionArea.innerHTML = '';
translationArea.innerHTML = '';
hideError();
translateBtn.disabled = true;
aiSearchBtn.disabled = true;

classicalText.value = articleInfo.content;
autoResizeTextarea.call(classicalText);

let introContent = '';
let translationContent = '';

if (!articleInfo.isManual) {
try {
const intros = await generateIntroductions(articleInfo.title, articleInfo.author);
introContent = formatIntroHtml(intros);
} catch (introError) {
console.error('ç”Ÿæˆç°¡ä»‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', introError);
introContent = formatIntroHtml({
authorIntro: 'ï¼ˆä½œè€…ç°¡ä»‹ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚ï¼‰',
articleIntro: 'ï¼ˆæ–‡ç« ç°¡ä»‹ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚ï¼‰'
});
}
}
introductionArea.innerHTML = introContent;

try {
const translationData = await fetchTranslationData(articleInfo.content);
translationContent = formatTranslationResult(translationData);
} catch (translationError) {
console.error('ç”Ÿæˆç¿»è­¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', translationError);
showError(`ç¿»è­¯éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${translationError.message}`);
translationContent = `<div class="error-message" style="display: block; margin-top: 0;"><i class="fas fa-exclamation-triangle"></i> ç¿»è­¯å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦æˆ–é‡æ–°ç”Ÿæˆã€‚</div>`;
}
translationArea.innerHTML = translationContent;

setupDynamicContent();
addToHistory({
...articleInfo,
id: articleInfo.id || new Date().toISOString(),
introHtml: introContent,
translationHtml: translationContent,
testSuccess: articleInfo.testSuccess || false,
});

loading.style.display = 'none';
translateBtn.disabled = false;
aiSearchBtn.disabled = false;
}

// === ä¿®æ”¹å¾Œçš„ callApi å‡½å¼ ===
// ===============================================================
// ä¿®æ”¹å¾Œçš„ callApi å‡½å¼ (å‰ç«¯ç›´æ¥å‘¼å«ç‰ˆ)
// ===============================================================
async function callApi(prompt) {
    // ç°¡å–®çš„é˜²å‘†ï¼Œæª¢æ¸¬æ˜¯å¦ç™»å…¥ (ä¿ç•™åŸæœ‰é‚è¼¯)
    if (!localStorage.getItem('studentProfile')) {
        console.log("å‘¼å« API æ™‚æª¢æ¸¬åˆ°æœªç™»å…¥ï¼Œè¨ªå®¢é™åˆ¶å°‡ç”±æ””æˆªå™¨è™•ç†...");
    }
 
    try {
        // å¾åˆ—è¡¨ä¸­éš¨æ©Ÿé¸å–ä¸€å€‹ Key (ç›®å‰åªæœ‰ friend1)
        const apiKey = API_KEYS[Math.floor(Math.random() * API_KEYS.length)];
 
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}` // åŠ å…¥ Bearer Token
            },
            body: JSON.stringify({
                model: MODEL,
                messages: [{
                    role: "user",
                    content: prompt
                }],
                temperature: 0.7,
                max_tokens: 4096,
                stream: false // ç¢ºä¿ä¸ä½¿ç”¨ä¸²æµæ¨¡å¼ï¼Œä»¥ä¾¿èˆ‡ç¾æœ‰ JSON è§£æé‚è¼¯å…¼å®¹
            })
        });
 
        if (!response.ok) {
            let errorDetails = "";
            try {
                errorDetails = await response.text();
            } catch (e) {
                errorDetails = "ç„¡æ³•è®€å–éŒ¯èª¤è©³ç´°è³‡è¨Š";
            }
            console.error(`API è«‹æ±‚å¤±æ•—è©³ç´°è³‡è¨Š (Status ${response.status}):`, errorDetails);
            throw new Error(`API è«‹æ±‚å¤±æ•— (${response.status}): ${errorDetails}`);
        }
 
        const data = await response.json();
        
        // è¨˜éŒ„ä½¿ç”¨çš„æ¨¡å‹è³‡è¨Š
        console.log(`%cğŸš€ [API æˆåŠŸ] Model: ${MODEL}`, "color: #00bcd4; font-weight: bold; font-size: 14px; background: #333; padding: 4px; border-radius: 4px;");
 
        if (data.error) {
            throw new Error(`API è¿”å›éŒ¯èª¤: ${data.error.message || data.error}`);
        }
        
        return data;
        
    } catch (error) {
        console.error('API èª¿ç”¨ç™¼ç”Ÿç•°å¸¸:', error);
        throw error;
    }
}

// ===============================================================
// 1. å¼·åŠ› JSON æå–èˆ‡æ¸…æ´—å‡½æ•¸ (ä¿®è¨‚ç‰ˆï¼šé˜²æ­¢å´©æ½°æ ¸å¿ƒ)
// ===============================================================
function extractJson(text) {
    if (!text) throw new Error("API å›æ‡‰ç‚ºç©º");
    let cleanText = text;
 
    // --- æ­¥é©Ÿ 1: ç§»é™¤ <think>...</think> æ€è€ƒéç¨‹ ---
    // DeepSeek ç¶“å¸¸æœƒè¼¸å‡ºæ€è€ƒéç¨‹ï¼Œå¿…é ˆå…ˆç§»é™¤
    cleanText = cleanText.replace(/<think>[\s\S]*?<\/think>/gi, '');
 
    // --- æ­¥é©Ÿ 2: ç§»é™¤ Markdown æ¨™è¨˜ ---
    cleanText = cleanText.replace(/```json/gi, '').replace(/```/g, '');
 
    // --- æ­¥é©Ÿ 3: é–å®š JSON ç¯„åœ ({ ... }) ---
    const startIndex = cleanText.indexOf('{');
    const endIndex = cleanText.lastIndexOf('}');
    
    if (startIndex === -1 || endIndex === -1 || endIndex <= startIndex) {
        console.warn("æ¸…æ´—å¾Œæœªç™¼ç¾ JSON çµæ§‹ï¼Œå˜—è©¦å¾åŸå§‹æ–‡æœ¬æå–...");
        // å…œåº•ï¼šå¦‚æœæ¸…æ´—éé ­ï¼Œå˜—è©¦å›åŸæœ¬çš„ text æ‰¾
        const rawStart = text.indexOf('{');
        const rawEnd = text.lastIndexOf('}');
        if (rawStart === -1) {
            throw new Error("API å›æ‡‰ä¸­æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ JSON ç‰©ä»¶ç¯„åœã€‚");
        }
        cleanText = text.substring(rawStart, rawEnd + 1);
    } else {
        cleanText = cleanText.substring(startIndex, endIndex + 1);
    }
    
    try {
        // --- æ­¥é©Ÿ 4: æ¸…é™¤å¯èƒ½çš„ JS è¨»é‡‹ (// æˆ– /* */) ---
        // é€™æ˜¯å°è‡´ JSON.parse å´©æ½°çš„ä¸»å› ä¹‹ä¸€
        cleanText = cleanText.replace(/\/\/.*$/gm, ''); // ç§»é™¤å–®è¡Œè¨»é‡‹
        cleanText = cleanText.replace(/\/\*[\s\S]*?\*\//g, ''); // ç§»é™¤å¤šè¡Œè¨»é‡‹
        // --- æ­¥é©Ÿ 5: ä¿®å¾©å¸¸è¦‹çš„ JSON æ ¼å¼éŒ¯èª¤ ---
        // ç§»é™¤å°¾éƒ¨é€—è™Ÿ (Trailing Commas)ï¼Œä¾‹å¦‚: {"a":1,} -> {"a":1}
        cleanText = cleanText.replace(/,(\s*[}\]])/g, '$1');
 
        // å°‡éæ¨™æº–å¼•è™Ÿæ›¿æ›ç‚ºé›™å¼•è™Ÿ
        cleanText = cleanText.replace(/[\u201C\u201D]/g, '"');
        // è§£æ
        return JSON.parse(cleanText);
        
    } catch (e) {
        console.error("JSON æœ€çµ‚è§£æå¤±æ•—ã€‚\næ¸…æ´—å¾Œæ–‡æœ¬:", cleanText);
        throw new Error(`JSON è§£æå¤±æ•—: ${e.message}`);
    }
}
// ===============================================================
// 2. API èª¿ç”¨é‡è©¦æ©Ÿåˆ¶ (é…åˆ extractJson ä½¿ç”¨)
// ===============================================================
async function callApiWithRetry(prompt, retries = 2) { // é™ä½é‡è©¦æ¬¡æ•¸ä»¥ç¯€çœæ™‚é–“
    let lastError = null;
    for (let i = 0; i < retries; i++) {
        try {
            // console.log(`API å‘¼å«å˜—è©¦ ${i + 1}/${retries}...`);
            const response = await callApi(prompt);
            
            if (response && response.choices && response.choices[0].message.content) {
                const content = response.choices[0].message.content;
                // ä½¿ç”¨å¼·åŒ–ç‰ˆçš„ extractJson
                return extractJson(content);
            } else {
                throw new Error("API å›æ‡‰çµæ§‹ç•°å¸¸æˆ–å…§å®¹ç‚ºç©ºã€‚");
            }
        } catch (error) {
            lastError = error;
            console.warn(`å˜—è©¦ ${i + 1} å¤±æ•—: ${error.message}`);
            
            if (i < retries - 1) {
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
    }
    throw lastError || new Error("API é‡è©¦æ¬¡æ•¸è€—ç›¡ï¼Œç„¡æ³•ç²å–æœ‰æ•ˆ JSONã€‚");
}
// ===============================================================
// 3. å°‹æ‰¾ç¯‡ç« å‡½æ•¸ (Prompt å„ªåŒ–ï¼šå¼·åˆ¶æ ¼å¼)
// ===============================================================
async function generateProse() {
    const userPromptText = aiPromptTextarea.value.trim();
    const historyTitles = state.history.map(item => item.title).filter(t => !t.startsWith('æ‰‹å‹•è¼¸å…¥'));
    
    let selectionInstruction = userPromptText
        ? `ç”¨æˆ¶ä¸»é¡Œï¼šã€Œ${userPromptText}ã€ã€‚è«‹æŒ‘é¸æœ€ç›¸é—œç¯‡ç« ã€‚`
        : `è«‹éš¨æ©Ÿæ¨è–¦ä¸€ç¯‡ç¶“å…¸æ–‡ç« ã€‚`;
    // Prompt ç¡¬æ€§è¦å®š
    const systemPrompt = `ä½ æ˜¯ä¸€å€‹åš´æ ¼åªè¼¸å‡º JSON çš„è³‡æ–™åº« APIã€‚
ã€ä»»å‹™ã€‘ï¼šå¾æ¸…å–®ä¸­é¸ä¸€ç¯‡ã€Šå¤æ–‡è§€æ­¢ã€‹æ–‡ç« ã€‚
ã€æ¸…å–®ã€‘ï¼š${JSON.stringify(GUWEN_LIST)}
ã€è¦æ±‚ã€‘ï¼š
1. é›£åº¦ï¼š${state.difficulty}æ˜Ÿã€‚
2. ${selectionInstruction}
3. å·²è®€æ’é™¤ï¼š[${historyTitles.join(', ')}]
4. **è¼¸å‡ºå¿…é ˆæ˜¯ 100% ç¹é«”ä¸­æ–‡**ã€‚
5. **æ ¼å¼åš´æ ¼é™åˆ¶**ï¼šåªå›å‚³ç´” JSON ç‰©ä»¶ï¼Œ**ä¸è¦ä½¿ç”¨ markdownï¼Œä¸è¦æœ‰ <think> æ¨™ç±¤ï¼Œä¸è¦æœ‰ // è¨»é‡‹**ã€‚
ã€JSON æ ¼å¼ç¯„ä¾‹ã€‘ï¼š
{
"title": "ä½œå“æ¨™é¡Œ",
"author": "ä½œè€…(ç¹é«”)",
"content": "æ–‡è¨€æ–‡å…§å®¹(ç¹é«”ï¼Œå®Œæ•´åŸæ–‡)"
}`;
    const article = await callApiWithRetry(systemPrompt, 3);
    
    if (article && article.title && article.content) {
        // æ ¡æ­£æ¨™é¡Œ
        const matchedTitle = GUWEN_LIST.find(t => article.title.includes(t) || t.includes(article.title));
        if (matchedTitle) article.title = matchedTitle;
        return { ...article, isManual: false };
    }
    throw new Error("API è¿”å› JSON ç¼ºå°‘å¿…è¦æ¬„ä½ (title æˆ– content)ã€‚");
}
// ===============================================================
// 4. ç”Ÿæˆç°¡ä»‹å‡½æ•¸ (Prompt å„ªåŒ–ï¼šå¼·åˆ¶æ ¼å¼)
// ===============================================================
async function generateIntroductions(title, author) {
    const prompt = `ä½ æ˜¯ä¸€å€‹åš´æ ¼åªè¼¸å‡º JSON çš„è³‡æ–™åº« APIã€‚
ä»»å‹™ï¼šç”Ÿæˆ "${title}" (${author}) çš„ç°¡ä»‹ã€‚
ã€åš´æ ¼è¦å‰‡ã€‘ï¼š
1. **å…¨éƒ¨ä½¿ç”¨ç¹é«”ä¸­æ–‡**ã€‚
2. åªå›å‚³ JSONï¼Œ**åš´ç¦ä»»ä½• Markdown æˆ– è¨»é‡‹**ã€‚
3. ç°¡ä»‹ç´„ 50-100 å­—ã€‚
ã€JSON æ ¼å¼ã€‘ï¼š
{
"authorIntro": "ä½œè€…ç°¡ä»‹(ç¹é«”)",
"articleIntro": "æ–‡ç« ç°¡ä»‹(ç¹é«”)"
}`;
    try {
        const intros = await callApiWithRetry(prompt, 2); // ç°¡ä»‹å¤±æ•—å®¹å¿åº¦è¼ƒé«˜
        if (intros && (intros.authorIntro || intros.articleIntro)) {
            return intros;
        }
        return { authorIntro: "æš«ç„¡ç°¡ä»‹", articleIntro: "æš«ç„¡ç°¡ä»‹" };
    } catch (e) {
        console.error("ç°¡ä»‹ç”Ÿæˆå¤±æ•—", e);
        // å¤±æ•—æ™‚ä¸å´©æ½°ï¼Œè¿”å›ç©ºå…§å®¹
        return { authorIntro: "", articleIntro: "" };
    }
}
// ===============================================================
// 5. ç²å–ç¿»è­¯æ•¸æ“šå‡½æ•¸ (Prompt å„ªåŒ–ï¼šé˜²æ­¢çµæ§‹å´©æ½°)
// ===============================================================
async function fetchTranslationData(text) {
    // é™åˆ¶å‚³é€æ–‡æœ¬é•·åº¦ï¼Œé¿å… Token è¶…å‡ºæˆ– AI æ··äº‚
    const truncatedText = text.length > 2000 ? text.substring(0, 2000) + "..." : text;
 
    const prompt = `ä½ æ˜¯ä¸€å€‹æ–‡è¨€æ–‡æ•™å­¸ APIã€‚è«‹åˆ†æä»¥ä¸‹æ–‡æœ¬ä¸¦è¼¸å‡º JSONã€‚
ã€æ–‡æœ¬ã€‘ï¼š
${truncatedText}
ã€è¦å‰‡ã€‘ï¼š
1. **å¿…é ˆè¼¸å‡ºç¹é«”ä¸­æ–‡ (Traditional Chinese)**ã€‚
2. **çµ•å°ç¦æ­¢**è¼¸å‡º markdown code block (å¦‚ \`\`\`json)ã€‚
3. **çµ•å°ç¦æ­¢**è¼¸å‡ºä»»ä½• // æˆ– /* */ è¨»é‡‹ã€‚
4. "breakdown" é™£åˆ—ä¸­ï¼Œå°‡å¸¸è¦‹å¯¦è©/è™›è©ç”¨ markdown ç²—é«”æ¨™ç¤º (å¦‚ **ä¹‹**)ã€‚
ã€JSON æ ¼å¼ç¯„ä¾‹ (è«‹åš´æ ¼éµå®ˆ)ã€‘ï¼š
{
  "translations": [
    {
      "original": "åŸæ–‡å¥å­",
      "translation": "ç™½è©±ç¿»è­¯(ç¹é«”)",
      "breakdown": [
        "è©ï¼šè§£é‡‹1ã€‚",
        "**é—œéµè©**ï¼šè§£é‡‹2ã€‚"
      ]
    }
  ]
}`;
    const translationJson = await callApiWithRetry(prompt, 3);
    
    if (!translationJson || !Array.isArray(translationJson.translations)) {
        throw new Error("ç¿»è­¯ JSON æ ¼å¼éŒ¯èª¤ (ç¼ºå°‘ translations é™£åˆ—)ã€‚");
    }
    return translationJson;
}
 
// --- History Feature ---
function loadHistory() {
state.history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
}

function saveHistory() {
localStorage.setItem(HISTORY_KEY, JSON.stringify(state.history));
}

function addToHistory(item) {
const existingIndex = state.history.findIndex(h => h.id === item.id);
if (existingIndex > -1) {
state.history[existingIndex] = item;
} else {
state.history.unshift(item);
}
if (state.history.length > 50) state.history.pop();
saveHistory();
}


function showHistory() {
renderHistory();
historyModal.classList.add('is-visible');
}

function hideHistory() {
historyModal.classList.remove('is-visible');
}

function renderHistory() {
let items = [...state.history];
const term = historySearch.value.toLowerCase();
if (term) {
items = items.filter(i => i.title.toLowerCase().includes(term) || (i.author && i.author.toLowerCase().includes(term)));
}
items.sort((a, b) => {
const dateA = new Date(a.id);
const dateB = new Date(b.id);
return historySort.value === 'date_asc' ? dateA - dateB : dateB - a;
});
historyList.innerHTML = items.length === 0 ?
`<li class="no-history-msg">${term ? 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„ã€‚' : 'ç›®å‰æ²’æœ‰é–±è®€ç´€éŒ„ã€‚'}</li>` :
items.map(item => `
<li data-history-id="${item.id}">
<div class="history-item-content">
<div class="history-list-item-title">
<span>${item.title}</span>
${item.testSuccess ? '<i class="fas fa-medal" title="æŒ‘æˆ°æˆåŠŸ" style="color: #f1c40f; margin-left: 8px; font-size: 1.1rem;"></i>' : ''}
</div>
<div class="history-list-item-meta">
<span>${item.author === 'N/A' ? 'æ‰‹å‹•è¼¸å…¥' : item.author}</span> | <span>${new Date(item.id).toLocaleDateString('zh-TW')}</span>
</div>
</div>
<div class="history-item-actions">
<button class="icon-btn regenerate-history-btn" title="é‡æ–°ç”Ÿæˆ">
<i class="fas fa-sync-alt"></i>
</button>
<button class="icon-btn edit-history-btn" title="ä¿®è¨‚æ¨™é¡Œ">
<i class="fas fa-pencil-alt"></i>
</button>
<button class="icon-btn delete-history-btn" title="åˆªé™¤æ­¤ç´€éŒ„">
<i class="fas fa-trash-alt"></i>
</button>
</div>
</li>`).join('');
}

function handleHistoryListClick(e) {
const li = e.target.closest('li[data-history-id]');
if (!li) return;

const id = li.dataset.historyId;
const item = state.history.find(h => h.id === id);
if (!item) return;

const deleteBtn = e.target.closest('.delete-history-btn');
const regenerateBtn = e.target.closest('.regenerate-history-btn');
const editBtn = e.target.closest('.edit-history-btn');
const contentArea = e.target.closest('.history-item-content');

if (deleteBtn) {
if (confirm(`æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${item.title}ã€é€™ç¯‡ç´€éŒ„å—ï¼Ÿ`)) {
state.history = state.history.filter(h => h.id !== id);
saveHistory();
renderHistory();
}
return;
}

if (regenerateBtn) {
if (confirm(`æ‚¨ç¢ºå®šè¦é‡æ–°ç”Ÿæˆã€Œ${item.title}ã€çš„ç¿»è­¯çµæœå—ï¼Ÿé€™å°‡æœƒç™¼èµ·æ–°çš„è«‹æ±‚ã€‚`)) {
hideHistory();
processAndDisplay({...item, testSuccess: item.testSuccess || false});
}
return;
}

if (editBtn) {
const titleSpan = li.querySelector('.history-list-item-title > span');
const currentTitle = titleSpan.textContent;
const input = document.createElement('input');
input.type = 'text';
input.className = 'history-title-edit';
input.value = currentTitle;

const saveChanges = () => {
const newTitle = input.value.trim();
if (newTitle && newTitle !== item.title) {
item.title = newTitle;
saveHistory();
}
renderHistory();
};

input.addEventListener('blur', saveChanges);
input.addEventListener('keydown', (e) => {
if (e.key === 'Enter') {
input.blur();
} else if (e.key === 'Escape') {
renderHistory();
}
});

titleSpan.replaceWith(input);
input.focus();
input.select();
return;
}

if (contentArea) {
showModeSelection(id);
}
}


function handleDeleteAllHistory() {
if (state.history.length === 0) return;
if (confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰é–±è®€ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
state.history = [];
saveHistory();
renderHistory();
}
}

// --- æ¨¡å¼é¸æ“‡åŠŸèƒ½ ---
function showModeSelection(itemId) {
const item = state.history.find(h => h.id === itemId);
if (!item) return;
modeSelectionModal.dataset.currentItemId = itemId;
modeSelectionTitle.textContent = item.title;
modeSelectionModal.classList.add('is-visible');
}

function hideModeSelection() {
modeSelectionModal.classList.remove('is-visible');
}

function handleReadMode() {
const itemId = modeSelectionModal.dataset.currentItemId;
const item = state.history.find(h => h.id === itemId);
if(item) {
hideModeSelection();
loadContent(item);
}
}

function handleTestMode() {
const itemId = modeSelectionModal.dataset.currentItemId;
const item = state.history.find(h => h.id === itemId);
if(item) {
hideModeSelection();
startTestMode(item);
}
}

function loadContent(item, callback) {
hideHistory();
loading.style.display = 'block';
introductionArea.innerHTML = '';
translationArea.innerHTML = '';
translationArea.classList.remove('test-mode');

const existingCounter = document.querySelector('.test-chances-counter');
if (existingCounter) existingCounter.remove();
testState.isActive = false;

setTimeout(() => {
classicalText.value = item.content;
autoResizeTextarea.call(classicalText);
introductionArea.innerHTML = item.introHtml || '';
translationArea.innerHTML = item.translationHtml || '';
currentOriginalTexts = [];
const originalTextElements = translationArea.querySelectorAll('.original-text');
originalTextElements.forEach(el => {
currentOriginalTexts.push(el.innerHTML);
});
setupDynamicContent();
loading.style.display = 'none';
if(typeof callback === 'function') {
callback();
}
}, 200);
}

// --- æ¸¬è©¦æ¨¡å¼æ ¸å¿ƒåŠŸèƒ½ ---
function startTestMode(item) {
loadContent(item, () => {
prepareTestEnvironment(item.id);
});
}

function prepareTestEnvironment(itemId) {
translationArea.classList.add('test-mode');
testState = {
isActive: true,
chances: 7,
mistakesFound: 0,
totalMistakes: 5,
currentItemId: itemId,
wronglyClickedItems: [],
mistakeItems: [],
};
document.querySelectorAll('.explanation').forEach(el => el.classList.add('revealed'));
const toggleIcon = toggleTranslationsBtn.querySelector('i');
toggleIcon.className = 'fas fa-eye-slash';
toggleTranslationsBtn.title = 'åœ¨æ¸¬é©—æ¨¡å¼ä¸­ï¼Œæ­¤åŠŸèƒ½å·²åœç”¨';

const allItems = Array.from(document.querySelectorAll('.character-item'));
if (allItems.length < testState.totalMistakes) {
showError("æ­¤ç¯‡ç« è§£é‡‹æ•¸é‡ä¸è¶³ï¼Œç„¡æ³•é–‹å•Ÿæ¸¬é©—æ¨¡å¼ã€‚");
translationArea.classList.remove('test-mode');
return;
}

const counterDiv = document.createElement('div');
counterDiv.className = 'test-chances-counter';
const firstChild = translationArea.firstChild;
translationArea.insertBefore(counterDiv, firstChild);
updateChancesCounter();

const allExplanations = allItems.map(item => {
const explanationSpan = item.querySelector('.explanation');
return explanationSpan ? explanationSpan.textContent.trim() : '';
});

const shuffledIndices = [...Array(allItems.length).keys()].sort(() => 0.5 - Math.random());
const mistakeIndices = shuffledIndices.slice(0, testState.totalMistakes);

mistakeIndices.forEach(index => {
const itemToCorrupt = allItems[index];
const explanationSpan = itemToCorrupt.querySelector('.explanation');
const originalText = explanationSpan.textContent;

let newExplanation;
let randomIndex;
do {
randomIndex = Math.floor(Math.random() * allExplanations.length);
newExplanation = allExplanations[randomIndex];
} while (newExplanation === originalText || !newExplanation);

itemToCorrupt.dataset.isMistake = 'true';
itemToCorrupt.dataset.originalExplanation = originalText;
itemToCorrupt.dataset.corruptedExplanation = newExplanation;
explanationSpan.textContent = newExplanation;
testState.mistakeItems.push(itemToCorrupt);
});
}

function handleTestAnswer(event) {
if (!testState.isActive) return;
const clickedItem = event.target.closest('.character-item');
if (!clickedItem || clickedItem.dataset.answered) return;

clickedItem.dataset.answered = 'true';
const isMistake = clickedItem.dataset.isMistake === 'true';

if (isMistake) {
testState.mistakesFound++;
clickedItem.classList.add('found-correctly');
const explanationSpan = clickedItem.querySelector('.explanation');
const correctText = clickedItem.dataset.originalExplanation;
explanationSpan.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success-color);"></i> <strong>æ­£ç¢ºè§£é‡‹ï¼š</strong> ${correctText}`;
if (testState.mistakesFound === testState.totalMistakes) {
handleTestSuccess();
}
} else {
testState.chances--;
clickedItem.classList.add('answered-incorrectly');
testState.wronglyClickedItems.push(clickedItem);
updateChancesCounter();
if (testState.chances < (testState.totalMistakes - testState.mistakesFound)) {
handleTestFailure();
} else if (testState.chances === 0) {
handleTestFailure();
} else {
const explanationSpan = clickedItem.querySelector('.explanation');
explanationSpan.innerHTML = `<i class="fas fa-times-circle" style="color:var(--error-color);"></i> ${explanationSpan.textContent}`;
}
}
}

function updateChancesCounter() {
const counterDiv = document.querySelector('.test-chances-counter');
if (counterDiv) {
counterDiv.innerHTML = `å°šæœ‰ <strong>${testState.totalMistakes - testState.mistakesFound}</strong> å€‹éŒ¯èª¤ï¼Œå‰©é¤˜æ©Ÿæœƒ: <span>${testState.chances}</span>`;
}
}

function endTest() {
testState.isActive = false;
document.querySelectorAll('.character-item').forEach(item => item.dataset.answered = 'true');
}

function handleTestSuccess() {
endTest();
const item = state.history.find(h => h.id === testState.currentItemId);
if(item) {
item.testSuccess = true;
addToHistory(item);
renderHistory();
}
const resultDiv = document.getElementById('test-result-content');
resultDiv.innerHTML = `
<div class="success-icon"><i class="fas fa-trophy"></i></div>
<h2>æŒ‘æˆ°æˆåŠŸï¼</h2>
<p>æ­å–œæ‚¨æ‰¾å‡ºæ‰€æœ‰éŒ¯èª¤è§£é‡‹ï¼<br><small style="color: #7f8c8d;">(é»æ“Šä»»æ„è™•é—œé–‰)</small></p>
`;
testResultOverlay.classList.add('is-visible');
}

function handleTestFailure() {
endTest();
testState.mistakeItems.forEach(item => {
if (item.classList.contains('found-correctly')) {
item.classList.add('reveal-correct');
return;
}
item.classList.add('reveal-correct');
const explanationSpan = item.querySelector('.explanation');
const corrupted = item.dataset.corruptedExplanation;
const original = item.dataset.originalExplanation;
explanationSpan.innerHTML = `åŸé¡¯ç¤ºéŒ¯èª¤è§£é‡‹ï¼š<span class="original-mistake">${corrupted}</span><br><strong>æ­£ç¢ºè§£é‡‹æ‡‰ç‚ºï¼š<span class="correct-answer">${original}</span></strong>`;
});
testState.wronglyClickedItems.forEach(item => {
item.classList.add('reveal-user-error');
});
const resultDiv = document.getElementById('test-result-content');
resultDiv.innerHTML = `
<div class="failure-icon"><i class="fas fa-times-circle"></i></div>
<h2>æŒ‘æˆ°å¤±æ•—</h2>
<p>åˆ¥æ°£é¤’ï¼Œå†æ¥å†å²ï¼<br><small style="color: #7f8c8d;">(é»æ“Šä»»æ„è™•é—œé–‰)</small></p>
`;
setTimeout(() => {
testResultOverlay.classList.add('is-visible');
}, 500);
}


// --- UI & Display Formatting ---
function setAiSearchLoading(isLoading) {
aiSearchBtn.disabled = isLoading;
const btnText = aiSearchBtn.querySelector('.btn-text');
let loader = aiSearchBtn.querySelector('.loader');
if (isLoading) {
if (!loader) {
loader = document.createElement('div');
loader.className = 'loader';
aiSearchBtn.insertBefore(loader, btnText);
}
btnText.textContent = 'å°‹æ‰¾ä¸­...';
} else {
if (loader) loader.remove();
btnText.textContent = 'å°‹æ‰¾ç¯‡ç« ';
}
}

function showError(message) {
errorMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
errorMessage.style.display = 'block';
}

function hideError() {
errorMessage.style.display = 'none';
}

function updateRatingDots() {
ratingDots.forEach(dot => {
dot.classList.toggle('selected', dot.dataset.value <= state.difficulty);
});
}

function setupDynamicContent() {
setupWordExplanationToggle();
setupSentenceReveal();

const hasContentToToggle = document.querySelector('.hidden-text, .explanation');
if (hasContentToToggle) {
toggleTranslationsBtn.style.display = 'inline-flex';
toggleTranslationsBtn.querySelector('i').className = 'fas fa-eye';
toggleTranslationsBtn.title = 'é¡¯ç¤ºæ‰€æœ‰ç¿»è­¯åŠè§£é‡‹';
} else {
toggleTranslationsBtn.style.display = 'none';
}
showFloatingOriginal();
}

function setupWordExplanationToggle() {
document.querySelectorAll('.character').forEach(character => {
character.addEventListener('click', function(e) {
if (translationArea.classList.contains('test-mode')) {
e.stopPropagation();
return;
}
this.nextElementSibling?.classList.toggle('revealed');
});
});
}

function setupSentenceReveal() {
document.querySelectorAll('#translation-area .hidden-text').forEach(sentence => {
sentence.addEventListener('click', function() {
if (testState.isActive) return;
this.classList.toggle('revealed');
});
});
}


function formatIntroHtml(intros) {
if (!intros || (!intros.authorIntro && !intros.articleIntro)) return '';
const authorHtml = intros.authorIntro ? `
<div class="introduction-section">
<div class="introduction-title"><i class="fas fa-user-edit"></i> ä½œè€…ç°¡ä»‹</div>
<div class="introduction-content">${intros.authorIntro.replace(/\n/g, '<br>')}</div>
</div>` : '';
const articleHtml = intros.articleIntro ? `
<div class="introduction-section">
<div class="introduction-title"><i class="fas fa-file-alt"></i> æ–‡ç« ç°¡ä»‹</div>
<div class="introduction-content">${intros.articleIntro.replace(/\n/g, '<br>')}</div>
</div>` : '';
return `<div class="introduction-wrapper">${authorHtml}${articleHtml}</div>`;
}

function formatTranslationResult(data) {
if (!data || !data.translations || !Array.isArray(data.translations) || data.translations.length === 0) {
return `<div class="error-message" style="display: block; margin-top: 0;"><i class="fas fa-exclamation-triangle"></i> ç¿»è­¯çµæœç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚</div>`;
}

currentOriginalTexts = [];
let htmlOutput = '';

data.translations.forEach(block => {
if (!block.original || !block.translation || !block.breakdown) {
console.warn('Skipping malformed translation block:', block);
return;
}

currentOriginalTexts.push(block.original);

const breakdownHtml = block.breakdown.map(line => {
const parts = line.replace(/^\*+/, '').trim().split(/:|ï¼š/);
if (parts.length >= 2) {
const charPart = parts[0].trim().replace(/\*\*(.*?)\*\*/g, '$1');
const explanationPart = parts.slice(1).join(':').trim();
return `<div class="character-item">
<span class="character">${charPart}</span><span class="explanation">ï¼š${explanationPart}</span>
</div>`;
}
return `<div>${line}</div>`;
}).join('');

const translationSentences = block.translation.replace(/\n/g, '<br>').split('<br>').filter(s => s.trim());
const translationHtml = translationSentences.map(sentence =>
`<div class="sentence-container"><span class="hidden-text">${sentence.trim()}</span></div>`
).join('');

htmlOutput += `
<div class="translation-block">
<div class="original-title"><i class="fas fa-scroll"></i> åŸæ–‡</div>
<div class="original-text">${block.original.replace(/\n/g, '<br>')}</div>

<div class="translation-title"><i class="fas fa-language"></i> èªè­¯</div>
<div class="translation-text">${translationHtml}</div>

<div class="character-breakdown">
<strong><i class="fas fa-search"></i> é€å­—è§£é‡‹</strong>
${breakdownHtml}
</div>
</div>`;
});

return htmlOutput;
}

// --- Floating Window ---
function getDeviceType() {
return window.innerWidth <= 768 ? 'mobile' : 'desktop';
}

function initFloatingWindow() {
if (getDeviceType() === 'mobile') {
isFloatingEnabled = localStorage.getItem('floatingEnabled') !== 'false';
updateFloatingToggleIcon();
updateReopenButton();
} else {
isFloatingEnabled = false;
reopenFloating.style.display = 'none';
}
}

function updateFloatingToggleIcon() {
const icon = floatingToggle.querySelector('i');
icon.className = isFloatingEnabled ? 'fas fa-times' : 'fas fa-expand';
floatingToggle.title = isFloatingEnabled ? 'é—œé–‰æ‡¸æµ®çª—' : 'é–‹å•Ÿæ‡¸æµ®çª—';
}

function updateReopenButton() {
if (getDeviceType() === 'mobile') {
reopenFloating.classList.toggle('show', !isFloatingEnabled && currentOriginalTexts.length > 0);
}
}

function showFloatingOriginal() {
if (getDeviceType() !== 'mobile' || !isFloatingEnabled || currentOriginalTexts.length === 0) {
hideFloatingOriginal();
return;
}
floatingOriginalText.innerHTML = currentOriginalTexts.join('<br><br>');
floatingOriginal.classList.add('show');
updateReopenButton();
}

function hideFloatingOriginal() {
floatingOriginal.classList.remove('show');
updateReopenButton();
}

function handleFloatingToggle() {
if (getDeviceType() === 'mobile') {
isFloatingEnabled = !isFloatingEnabled;
localStorage.setItem('floatingEnabled', isFloatingEnabled);
updateFloatingToggleIcon();
isFloatingEnabled && currentOriginalTexts.length > 0 ? showFloatingOriginal() : hideFloatingOriginal();
} else {
hideFloatingOriginal();
}
}

function handleReopenFloating() {
isFloatingEnabled = true;
localStorage.setItem('floatingEnabled', true);
updateFloatingToggleIcon();
showFloatingOriginal();
}

let isResizing = false,
startY = 0,
startHeight = 0;

function startResize(e) {
if (getDeviceType() !== 'mobile') return;
const rect = floatingOriginal.getBoundingClientRect();
const clientY = e.touches ? e.touches[0].clientY : e.clientY;
if (clientY > rect.bottom - 20) {
isResizing = true;
startY = clientY;
startHeight = floatingOriginal.offsetHeight;
document.addEventListener('mousemove', resize);
document.addEventListener('touchmove', resize, {
passive: false
});
document.addEventListener('mouseup', stopResize);
document.addEventListener('touchend', stopResize);
e.preventDefault();
}
}

function resize(e) {
if (!isResizing) return;
e.preventDefault();
const clientY = e.touches ? e.touches[0].clientY : e.clientY;
const newHeight = startHeight + (clientY - startY);
if (newHeight >= 150 && newHeight <= window.innerHeight * 0.8) {
floatingOriginal.style.height = newHeight + 'px';
}
}

function stopResize() {
isResizing = false;
document.removeEventListener('mousemove', resize);
document.removeEventListener('touchmove', resize);
document.addEventListener('mouseup', stopResize);
document.removeEventListener('touchend', stopResize);
}

// =================================================================
// ===== 3D GAME MODE LOGIC (REVISED) ==============================
// =================================================================

let game = {}; // å…¨å±€éŠæˆ²ç‰©ä»¶
let animationFrameId; // å‹•ç•«å¾ªç’°ID

function prepareGame() {
const itemId = modeSelectionModal.dataset.currentItemId;
if (!itemId) {
alert("æ‰¾ä¸åˆ°ç¯‡ç« å…§å®¹ï¼Œç„¡æ³•é–‹å§‹éŠæˆ²ã€‚");
return;
}

gameState.currentItemId = itemId;
hideModeSelection();
hideHistory();

gameLoader.style.display = 'flex';
gameQuestion.textContent = ''; // Clear previous text

// ä½¿ç”¨ setTimeout ç¢ºä¿ UI æ›´æ–°ï¼Œä¸¦é–‹å§‹æº–å‚™è³‡æ–™
setTimeout(() => {
const gameData = prepareGameData(itemId);

if (!gameData) {
gameLoader.style.display = 'none';
alert("æ­¤ç¯‡ç« ç„¡è¶³å¤ çš„ã€Œé€å­—è§£é‡‹ã€å…§å®¹ä¾†ç”ŸæˆéŠæˆ²ï¼ˆè‡³å°‘éœ€è¦4å€‹ä¸åŒè§£é‡‹ï¼‰ï¼Œè«‹é¸æ“‡å…¶ä»–ç¯‡ç« ã€‚");
return;
}

// å°‡æº–å‚™å¥½çš„è³‡æ–™å­˜åˆ°å…¨åŸŸéŠæˆ²ç‰©ä»¶ä¸­
game.questionQueue = gameData.questionQueue;
game.allAnswers = gameData.allAnswers;

gameLoader.style.display = 'none';
gameModal.style.display = 'block';
document.body.style.overflow = 'hidden'; 
initGame();
}, 100);
}

// ä¸€æ¬¡æ€§æº–å‚™æ‰€æœ‰éŠæˆ²è³‡æ–™çš„å‡½æ•¸
function prepareGameData(itemId) {
const item = state.history.find(h => h.id === itemId);
if (!item || !item.translationHtml) return null;

const tempDiv = document.createElement('div');
tempDiv.innerHTML = item.translationHtml;

const allBreakdowns = [];
tempDiv.querySelectorAll('.character-item').forEach(b_item => {
const character = b_item.querySelector('.character')?.textContent.trim();
const explanation = b_item.querySelector('.explanation')?.textContent.replace(/ï¼š|:/, '').trim().replace(/[ã€‚ï¼Ÿï¼ï¼›ï¼š.,?!;:]/g, '');
const originalSentence = b_item.closest('.translation-block')?.querySelector('.original-text')?.textContent.trim().replace(/\*/g, '');

// ç¢ºä¿å•é¡Œå’Œç­”æ¡ˆä¸æœƒå¤ªé•·
if (character && explanation && originalSentence && explanation.length < 10) {
allBreakdowns.push({
question: `åœ¨ã€Œ${originalSentence}ã€ä¸­ï¼Œã€Œ${character}ã€çš„æ„æ€æ˜¯ï¼Ÿ`,
answer: explanation
});
}
});

// è‡³å°‘éœ€è¦1å€‹æ­£ç¢ºç­”æ¡ˆå’Œ3å€‹ä¸åŒçš„éŒ¯èª¤ç­”æ¡ˆ
if (allBreakdowns.length < 4) return null; 

// æå–æ‰€æœ‰ä¸é‡è¤‡çš„ç­”æ¡ˆä½œç‚ºç­”æ¡ˆæ± 
const allAnswers = [...new Set(allBreakdowns.map(b => b.answer))];

// å¦‚æœå»é‡å¾Œç­”æ¡ˆå°‘äº4å€‹ï¼Œä¹Ÿç„¡æ³•é€²è¡Œ
if (allAnswers.length < 4) return null;

// æ‰“äº‚å•é¡Œé †åº
const questionQueue = [...allBreakdowns].sort(() => Math.random() - 0.5);

return { questionQueue, allAnswers };
}

function initGame() {
if (typeof THREE === 'undefined') {
alert("Three.js å‡½å¼åº«æœªæˆåŠŸè¼‰å…¥ï¼Œç„¡æ³•å•Ÿå‹•éŠæˆ²ã€‚");
return;
}

// æ¸…ç†èˆŠå ´æ™¯
if (game.renderer) {
while(gameCanvasContainer.firstChild){
gameCanvasContainer.removeChild(gameCanvasContainer.firstChild);
}
}
if (animationFrameId) {
cancelAnimationFrame(animationFrameId);
}

const isMobile = window.innerWidth <= 768;

game.scene = new THREE.Scene();
game.camera = new THREE.PerspectiveCamera(75, gameCanvasContainer.clientWidth / gameCanvasContainer.clientHeight, 0.1, 1000);
game.camera.position.z = isMobile ? 80 : 35;

game.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
game.renderer.setSize(gameCanvasContainer.clientWidth, gameCanvasContainer.clientHeight);
game.renderer.setClearColor(0x000000, 0); 
gameCanvasContainer.appendChild(game.renderer.domElement);

game.labelRenderer = new THREE.CSS2DRenderer();
game.labelRenderer.setSize(gameCanvasContainer.clientWidth, gameCanvasContainer.clientHeight);
game.labelRenderer.domElement.style.position = 'absolute';
game.labelRenderer.domElement.style.top = '0px';
game.labelRenderer.domElement.style.pointerEvents = 'none';
gameCanvasContainer.appendChild(game.labelRenderer.domElement);

const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
game.scene.add(ambientLight);
const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
directionalLight.position.set(5, 10, 7.5);
game.scene.add(directionalLight);

game.audioContext = new (window.AudioContext || window.webkitAudioContext)();

game.bricksGroup = new THREE.Group();
game.scene.add(game.bricksGroup);
game.particles = new THREE.Group();
game.scene.add(game.particles);

createWalls();
createPaddle();
createBall();

const moveHandler = (e) => onPointerMove(e.touches ? e.touches[0] : e);
window.addEventListener('mousemove', moveHandler, false);
window.addEventListener('touchmove', moveHandler, false);

startGame();
}

function startGame() {
gameState.isActive = true;
gameState.lives = 3;
gameState.score = 0;
gameState.speedMultiplier = 1.0;
updateHUD();

clearBricks();
loadNextQuestionAndBricks(); // Show first question immediately
resetBallAndPaddle();

gameOverScreen.style.display = 'none';

if (animationFrameId) cancelAnimationFrame(animationFrameId);
animate();
}

function launchBallOnClick() {
if (!gameState.isActive || gameState.isBallLaunched) return;

gameState.isBallLaunched = true;

const initialAngle = (Math.random() * 0.6 - 0.3) * Math.PI;
const speed = gameState.baseSpeed * gameState.speedMultiplier;
game.ball.velocity = new THREE.Vector3(Math.sin(initialAngle) * speed, Math.cos(initialAngle) * speed, 0);

playCollisionSound('paddle');
}

function closeGame() {
gameState.isActive = false;
if (animationFrameId) {
cancelAnimationFrame(animationFrameId);
}
gameModal.style.display = 'none';
gameOverScreen.style.display = 'none';
document.body.style.overflow = 'auto'; 
}


function createWalls() {
const wallMaterial = new THREE.MeshStandardMaterial({ color: 0x733E0A, transparent: true, opacity: 0.5 });
const worldWidth = 60; 
const worldHeight = 45; 

game.leftWall = new THREE.Mesh(new THREE.BoxGeometry(1, worldHeight, 5), wallMaterial);
game.leftWall.position.set(-worldWidth / 2, 0, 0);
game.scene.add(game.leftWall);

game.rightWall = new THREE.Mesh(new THREE.BoxGeometry(1, worldHeight, 5), wallMaterial);
game.rightWall.position.set(worldWidth / 2, 0, 0);
game.scene.add(game.rightWall);

game.topWall = new THREE.Mesh(new THREE.BoxGeometry(worldWidth, 1, 5), wallMaterial);
game.topWall.position.set(0, worldHeight / 2, 0);
game.scene.add(game.topWall);

game.bottomBoundary = -worldHeight/2 + 2;
}

function createPaddle() {
const geometry = new THREE.BoxGeometry(12, 1.2, 3);
const material = new THREE.MeshStandardMaterial({ color: 0x7fb3d5, metalness: 0.5, roughness: 0.2 });
game.paddle = new THREE.Mesh(geometry, material);
game.scene.add(game.paddle);
}

function createBall() {
const geometry = new THREE.SphereGeometry(1, 32, 32);
// MODIFIED: Changed ball color to the requested teal.
const material = new THREE.MeshStandardMaterial({ color: 0x006400, emissive: 0x566573, metalness: 0.2, roughness: 0.1 });
game.ball = new THREE.Mesh(geometry, material);

const pointLight = new THREE.PointLight(0xffffff, 1.2, 100);
game.ball.add(pointLight);

game.scene.add(game.ball);
}

function resetBallAndPaddle() {
gameState.isBallLaunched = false;
game.paddle.position.set(0, game.bottomBoundary + 2, 0);
game.ball.position.set(0, game.paddle.position.y + 1.5, 0);
game.ball.velocity = new THREE.Vector3(0, 0, 0);

gameModal.addEventListener('click', launchBallOnClick, { once: true });
}

function onPointerMove(event) {
if (!gameState.isActive) return;
const pointerX = (event.clientX / window.innerWidth) * 2 - 1;
const paddleLimit = game.rightWall.position.x - game.paddle.geometry.parameters.width / 2 - 1;
game.paddle.position.x = THREE.MathUtils.clamp(pointerX * paddleLimit * 1.5, -paddleLimit, paddleLimit);

if (!gameState.isBallLaunched) {
game.ball.position.x = game.paddle.position.x;
}
}

function clearBricks() {
for (let i = game.bricksGroup.children.length - 1; i >= 0; i--) {
const obj = game.bricksGroup.children[i];
if (obj.isCSS2DObject && obj.element) {
obj.element.remove();
}
game.bricksGroup.remove(obj);
}
}

function loadNextQuestionAndBricks() {
clearBricks();

if (game.questionQueue.length === 0) {
gameQuestion.textContent = "æ­å–œï¼å·²å®Œæˆæ‰€æœ‰é¡Œç›®ï¼";
setTimeout(triggerGameOver, 2000);
return;
}

const currentQA = game.questionQueue.shift();
gameQuestion.textContent = currentQA.question;

const correctAnswer = currentQA.answer;
const wrongAnswerPool = game.allAnswers.filter(ans => ans !== correctAnswer);
const incorrectAnswers = wrongAnswerPool.sort(() => Math.random() - 0.5).slice(0, 3);

let brickData = [];
brickData.push({ text: correctAnswer, isCorrect: true });
incorrectAnswers.forEach(ans => {
brickData.push({ text: ans, isCorrect: false });
});

const isMobile = window.innerWidth <= 768;
const cols = isMobile ? 4 : 5;
const rows = isMobile ? 5 : 4;
const totalBricks = cols * rows;
const answerBrickCount = brickData.length;

for (let i = 0; i < totalBricks - answerBrickCount; i++) {
brickData.push({ text: '', isCorrect: null }); // null for blank bricks
}
brickData.sort(() => Math.random() - 0.5);

const brickWidth = 11;
const brickHeight = 4;
const colGap = 1;
const rowGap = 1;
const totalGridWidth = cols * brickWidth + (cols - 1) * colGap;
const startX = -totalGridWidth / 2 + brickWidth / 2;
const startY = game.topWall.position.y - 12;

brickData.forEach((data, index) => {
const r = Math.floor(index / cols);
const c = index % cols;
const x = startX + c * (brickWidth + colGap);
const y = startY - r * (brickHeight + rowGap);
createBrick(x, y, data.text, data.isCorrect);
});
}

function createBrick(x, y, text, isCorrect) {
const geometry = new THREE.BoxGeometry(10, 3, 2); 
let material;

if (isCorrect !== null) { // Answer bricks (correct or incorrect)
material = new THREE.MeshStandardMaterial({ 
color: 0xa9cce3, // Unified color for all answer bricks
metalness: 0.3, 
roughness: 0.4 
});
} else { // Blank bricks
material = new THREE.MeshStandardMaterial({ 
color: 0x566573, 
metalness: 0.1, 
roughness: 0.7, 
transparent: true, 
opacity: 0.7
});
}

const brickMesh = new THREE.Mesh(geometry, material);
brickMesh.position.set(x, y, 0);
brickMesh.isBrick = true;
brickMesh.isCorrect = isCorrect;
brickMesh.hit = false;

game.bricksGroup.add(brickMesh);

if (isCorrect !== null) {
const el = document.createElement('div');
el.className = 'game-answer-brick';
el.textContent = text;

const label = new THREE.CSS2DObject(el);
label.position.set(x, y, 1.01); // Slightly in front of the brick

brickMesh.label = label;
game.bricksGroup.add(label);
}
}

function updateHUD() {
gameScore.textContent = `åˆ†æ•¸: ${gameState.score}`;
// â–¼â–¼â–¼ ä¿®æ”¹å¾Œçš„ç¨‹å¼ç¢¼ â–¼â–¼â–¼
gameLives.innerHTML = `ç”Ÿå‘½: <span style="color: #e74c3c;">${'â™¥ '.repeat(Math.max(0, gameState.lives))}</span>`;
}

function handleBallBrickCollision(brick) {
if (brick.hit) return; 
brick.hit = true;

if (brick.label) {
brick.label.element.style.transition = 'opacity 0.3s';
brick.label.element.style.opacity = '0';
setTimeout(() => {
if (brick.label) {
game.bricksGroup.remove(brick.label);
brick.label.element.remove();
}
}, 300);
}

if (brick.isCorrect === true) {
// MODIFIED: Handle correct answer hit
playCollisionSound('correct');
gameState.score += 100;
// Increase speed multiplier for the next launch
gameState.speedMultiplier = Math.min(2.5, gameState.speedMultiplier * 1.05);
createParticleExplosion(brick.position, 0x2ecc71);
updateHUD();
game.bricksGroup.remove(brick);

// Stop the ball's movement immediately
game.ball.velocity.set(0, 0, 0);

// After a delay, load next question and reset ball for a new serve
setTimeout(() => {
loadNextQuestionAndBricks();
resetBallAndPaddle();
}, 500);

} else if (brick.isCorrect === false) { // Incorrect answer
playCollisionSound('lose');
createParticleExplosion(brick.position, 0xe74c3c); // Red explosion for error
game.bricksGroup.remove(brick);
loseLife(); 
} else { // Blank bricks
playCollisionSound('wall');
gameState.score += 10;
createParticleExplosion(brick.position, 0xaaaaaa);
updateHUD();
game.bricksGroup.remove(brick);
}
}


function loseLife() {
gameState.lives--;
updateHUD();
playCollisionSound('lose');
if (gameState.lives <= 0) {
triggerGameOver();
} else {
resetBallAndPaddle();
}
}

function triggerGameOver() {
gameState.isActive = false;
game.ball.velocity.set(0,0,0);
gameFinalScore.textContent = `æœ€çµ‚å¾—åˆ†: ${gameState.score}`;
gameOverScreen.style.display = 'flex';
}

function animate() {
animationFrameId = requestAnimationFrame(animate);
if (!gameState.isActive) return;

game.particles.children.forEach(p => {
p.position.add(p.velocity);
p.material.opacity -= 0.02;
});
game.particles.children = game.particles.children.filter(p => p.material.opacity > 0);

if (gameState.isBallLaunched) {
game.ball.position.add(game.ball.velocity);
}

const ballBox = new THREE.Box3().setFromObject(game.ball);

// Wall collisions
if (game.ball.position.x < game.leftWall.position.x + 1 || game.ball.position.x > game.rightWall.position.x - 1) {
game.ball.velocity.x *= -1;
playCollisionSound('wall');
}
if (game.ball.position.y > game.topWall.position.y - 1) {
game.ball.velocity.y *= -1;
playCollisionSound('wall');
}

// Bottom boundary (lose life)
if (game.ball.position.y < game.bottomBoundary) {
if(gameState.isBallLaunched) loseLife();
}

// Paddle collision
const paddleBox = new THREE.Box3().setFromObject(game.paddle);
if (ballBox.intersectsBox(paddleBox) && game.ball.velocity.y < 0) {
game.ball.velocity.y *= -1;
let offset = (game.ball.position.x - game.paddle.position.x) / (game.paddle.geometry.parameters.width / 2);
game.ball.velocity.x = offset * gameState.baseSpeed * gameState.speedMultiplier;
playCollisionSound('paddle');
}

// Brick collisions
for (let i = game.bricksGroup.children.length - 1; i >= 0; i--) {
const brick = game.bricksGroup.children[i];
if (!brick.isBrick || brick.hit) continue;

const brickBox = new THREE.Box3().setFromObject(brick);
if (ballBox.intersectsBox(brickBox)) {
const ballCenter = game.ball.position.clone();
const brickCenter = brick.position.clone();
const dx = ballCenter.x - brickCenter.x;
const dy = ballCenter.y - brickCenter.y;
const combinedHalfWidths = game.ball.geometry.parameters.radius + brick.geometry.parameters.width / 2;
const combinedHalfHeights = game.ball.geometry.parameters.radius + brick.geometry.parameters.height / 2;

if (Math.abs(dx) / combinedHalfWidths > Math.abs(dy) / combinedHalfHeights) {
game.ball.velocity.x *= -1; 
} else {
game.ball.velocity.y *= -1;
}

handleBallBrickCollision(brick);
break; 
}
}

game.renderer.render(game.scene, game.camera);
game.labelRenderer.render(game.scene, game.camera);
}

// --- ç‰¹æ•ˆèˆ‡éŸ³æ•ˆ ---
function createParticleExplosion(position, color) {
const particleCount = 50;
const particleMaterial = new THREE.PointsMaterial({ color: color, size: 0.5, transparent: true, blending: THREE.AdditiveBlending });

for (let i = 0; i < particleCount; i++) {
const geometry = new THREE.BufferGeometry();
geometry.setAttribute('position', new THREE.Float32BufferAttribute([0,0,0], 3));
let p = new THREE.Points(geometry, particleMaterial.clone());
p.position.copy(position);
p.velocity = new THREE.Vector3(
(Math.random() - 0.5) * 0.2,
(Math.random() - 0.5) * 0.2,
(Math.random() - 0.5) * 0.2
);
game.particles.add(p);
}
}

function playCollisionSound(type) {
if (!game.audioContext || game.audioContext.state === 'suspended') {
game.audioContext.resume().catch(e => console.error("Audio resume failed:", e));
}
if (!game.audioContext) return;
const oscillator = game.audioContext.createOscillator();
const gainNode = game.audioContext.createGain();
oscillator.connect(gainNode);
gainNode.connect(game.audioContext.destination);

const now = game.audioContext.currentTime;
gainNode.gain.setValueAtTime(0.3, now);

switch (type) {
case 'paddle':
oscillator.frequency.setValueAtTime(200, now);
gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
break;
case 'wall':
oscillator.frequency.setValueAtTime(150, now);
gainNode.gain.setValueAtTime(0.1, now);
gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
break;
case 'correct':
oscillator.type = 'square';
oscillator.frequency.setValueAtTime(440, now);
oscillator.frequency.linearRampToValueAtTime(880, now + 0.1);
gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
break;
case 'lose':
oscillator.type = 'sawtooth';
oscillator.frequency.setValueAtTime(120, now);
oscillator.frequency.linearRampToValueAtTime(60, now + 0.3);
gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
break;
}
oscillator.start(now);
oscillator.stop(now + 0.4);
}

});
</script>

<!-- ===== æ–°å¢ï¼šæ–‡è¨€æ–‡è¼¸å…¥æ‡¸æµ®è¦–çª— ===== -->
<div id="ocr-input-modal" class="ocr-modal-overlay">
    <div class="ocr-modal-content">
        <h3 id="ocr-modal-title">æ‰‹å‹•è¼¸å…¥æ–‡è¨€ç¯‡ç« </h3>
        <textarea id="ocr-modal-textarea"></textarea>
        <div class="ocr-modal-buttons">
            <button id="ocr-modal-ocr-btn" class="ocr-modal-btn ocr-btn-special">
                <i class="fas fa-camera"></i> OCR
            </button>
            <button id="ocr-modal-save-btn" class="ocr-modal-btn ocr-btn-confirm">
                <i class="fas fa-check"></i> è¼¸å…¥
            </button>
        </div>
        <button id="ocr-modal-close-btn" class="ocr-modal-close-btn" title="é—œé–‰">&times;</button>
    </div>
</div>





    <script>



// === æ–°å¢ï¼šå¤æ–‡è§€æ­¢ç¯‡ç« æ¸…å–® (å·²éæ¿¾æ‰å·ç›®èˆ‡åºè¨€) ===
const GUWEN_LIST = [
    "é„­ä¼¯å…‹æ®µäºé„¢", "å‘¨é„­äº¤è³ª", "çŸ³ç¢è««å¯µå·å", "è‡§åƒ–ä¼¯è««è§€é­š", "é„­èŠå…¬æˆ’é£­å®ˆè‡£",
    "è‡§å“€ä¼¯è««ç´éƒœé¼", "å­£æ¢è««è¿½æ¥šå¸«", "æ›¹åŠŒè«–æˆ°", "é½Šæ¡“å…¬ä¼æ¥šç›Ÿå±ˆå®Œ", "å®®ä¹‹å¥‡è««å‡é“",
    "é½Šæ¡“ä¸‹æ‹œå—èƒ™", "é™°é£´ç”¥å°ç§¦ä¼¯", "å­é­šè«–æˆ°", "å¯ºäººæŠ«è¦‹æ–‡å…¬", "ä»‹ä¹‹æ¨ä¸è¨€ç¥¿",
    "å±•å–œçŠ’å¸«", "ç‡­ä¹‹æ­¦é€€ç§¦å¸«", "è¹‡å”å“­å¸«", "é„­å­å®¶å‘Šè¶™å®£å­", "ç‹å­«æ»¿å°æ¥šå­",
    "é½Šåœ‹ä½ä¸è¾±å‘½", "æ¥šæ­¸æ™‰çŸ¥ç½ƒ", "å‘‚ç›¸çµ•ç§¦", "é§’æ”¯ä¸å±ˆäºæ™‰", "ç¥å¥šè«‹å…å”å‘",
    "å­ç”¢å‘ŠèŒƒå®£å­è¼•å¹£", "æ™å­ä¸æ­»å›é›£", "å­£æœ­è§€å‘¨æ¨‚", "å­ç”¢å£æ™‰é¤¨å£", "å­ç”¢è«–å°¹ä½•ç‚ºé‚‘",
    "å­ç”¢å»æ¥šé€†å¥³ä»¥å…µ", "å­é©å°éˆç‹", "å­ç”¢è«–æ”¿å¯¬çŒ›", "å³è¨±è¶Šæˆ", "ç¥­å…¬è««å¾çŠ¬æˆ",
    "å¬å…¬è««å²ç‹æ­¢è¬—", "è¥„ç‹ä¸è¨±è«‹éš§", "å–®å­çŸ¥é™³å¿…äº¡", "å±•ç¦½è«–ç¥€çˆ°å±…", "é‡Œé©æ–·ç½ŸåŒ¡å›",
    "æ•¬å§œè«–å‹é€¸", "å”å‘è³€è²§", "ç‹å­«åœ‰è«–æ¥šå¯¶", "è«¸ç¨½éƒ¢è¡Œæˆäºå³", "ç”³èƒ¥è««è¨±è¶Šæˆ",
    "æ˜¥ç‹æ­£æœˆ", "å®‹äººåŠæ¥šäººå¹³", "å³å­ä½¿æœ­ä¾†è˜", "è™å¸«æ™‰å¸«æ»…å¤é™½", "æ™‰ç»å…¬æ®ºä¸–å­ç”³ç”Ÿ",
    "æ›¾å­æ˜“ç°€", "æœ‰å­ä¹‹è¨€ä¼¼å¤«å­", "å…¬å­é‡è€³å°ç§¦å®¢", "æœè•¢æšè§¶", "æ™‰ç»æ–‡å­æˆå®¤",
    "è˜‡ç§¦ä»¥é€£æ©«èªªç§¦", "å¸é¦¬éŒ¯è«–ä¼èœ€", "èŒƒé›èªªç§¦ç‹", "é„’å¿Œè«·é½Šç‹ç´è««", "é¡æ–¶èªªé½Šç‹",
    "é¦®ç…–å®¢å­Ÿå˜—å›", "è¶™å¨åå•é½Šä½¿", "èŠè¾›è«–å¹¸è‡£", "è§¸è®‹èªªè¶™å¤ªå", "é­¯ä»²é€£ç¾©ä¸å¸ç§¦",
    "é­¯å…±å…¬æ“‡è¨€", "å”é›èªªä¿¡é™µå›", "å”é›ä¸è¾±ä½¿å‘½", "æ¨‚æ¯…å ±ç‡•ç‹æ›¸", "ææ–¯è««é€å®¢æ›¸",
    "åœå±…", "å®‹ç‰å°æ¥šç‹å•", "äº”å¸æœ¬ç´€è´Š", "é …ç¾½æœ¬ç´€è´Š", "ç§¦æ¥šä¹‹éš›æœˆè¡¨",
    "é«˜ç¥–åŠŸè‡£ä¾¯å¹´è¡¨", "å­”å­ä¸–å®¶è´Š", "å¤–æˆšä¸–å®¶åº", "ä¼¯å¤·åˆ—å‚³", "ç®¡æ™åˆ—å‚³",
    "å±ˆåŸåˆ—å‚³", "é…·ååˆ—å‚³åº", "æ¸¸ä¿ åˆ—å‚³åº", "æ»‘ç¨½åˆ—å‚³", "è²¨æ®–åˆ—å‚³åº",
    "å¤ªå²å…¬è‡ªåº", "å ±ä»»å®‰æ›¸", "é«˜å¸æ±‚è³¢è©”", "æ–‡å¸è­°ä½ç™¾å§“è©”", "æ™¯å¸ä»¤äºŒåƒçŸ³ä¿®è·è©”",
    "æ­¦å¸æ±‚èŒ‚æç•°ç­‰è©”", "è³ˆèª¼éç§¦è«–ä¸Š", "è³ˆèª¼æ²»å®‰ç­–ä¸€", "é¼‚éŒ¯è«–è²´ç²Ÿç–", "é„’é™½ç„ä¸­ä¸Šæ¢ç‹æ›¸",
    "å¸é¦¬ç›¸å¦‚ä¸Šæ›¸è««çµ", "æé™µç­”è˜‡æ­¦æ›¸", "è·¯æº«èˆ’å°šå¾·ç·©åˆ‘æ›¸", "æ¥Šæƒ²å ±å­«æœƒå®—æ›¸", "å…‰æ­¦å¸è‡¨æ·„å‹è€¿å¼‡",
    "é¦¬æ´æˆ’å…„å­åš´æ•¦æ›¸", "è«¸è‘›äº®å‰å‡ºå¸«è¡¨", "è«¸è‘›äº®å¾Œå‡ºå¸«è¡¨", "é™³æƒ…è¡¨", "è˜­äº­é›†åº",
    "æ­¸å»ä¾†è¾­", "æ¡ƒèŠ±æºè¨˜", "äº”æŸ³å…ˆç”Ÿå‚³", "åŒ—å±±ç§»æ–‡", "è««å¤ªå®—åæ€ç–",
    "ç‚ºå¾æ•¬æ¥­è¨æ­¦æ›Œæª„", "æ»•ç‹é–£åº", "èˆ‡éŸ“èŠå·æ›¸", "æ˜¥å¤œå®´æ¡ƒæåœ’åº", "å¼”å¤æˆ°å ´æ–‡",
    "é™‹å®¤éŠ˜", "é˜¿æˆ¿å®®è³¦", "åŸé“", "åŸæ¯€", "ç²éºŸè§£",
    "é›œèªªä¸€", "é›œèªªå››", "å¸«èªª", "é€²å­¸è§£", "åœ¬è€…ç‹æ‰¿ç¦å‚³",
    "è«±è¾¯", "çˆ­è‡£è«–", "å¾Œåä¹æ—¥å¾©ä¸Šå®°ç›¸æ›¸", "å¾Œå»¿ä¹æ—¥å¾©ä¸Šå®°ç›¸æ›¸", "èˆ‡äºè¥„é™½æ›¸",
    "èˆ‡é™³çµ¦äº‹æ›¸", "æ‡‰ç§‘ç›®æ™‚èˆ‡äººæ›¸", "é€å­Ÿæ±é‡åº", "é€ææ„¿æ­¸ç›¤è°·åº", "é€è‘£é‚µå—åº",
    "é€æ¥Šå°‘å°¹åº", "é€çŸ³è™•å£«åº", "é€æº«è™•å£«èµ´æ²³é™½è»åº", "ç¥­åäºŒéƒæ–‡", "ç¥­é±·é­šæ–‡",
    "æŸ³å­åšå¢“èªŒéŠ˜", "é§å¾©è®è­°", "æ¡è‘‰å°å¼Ÿè¾¨", "ç®•å­ç¢‘", "æ•è›‡è€…èªª",
    "ç¨®æ¨¹éƒ­æ©é§å‚³", "æ¢“äººå‚³", "æ„šæºªè©©åº", "æ°¸å·éŸ‹ä½¿å›æ–°å ‚è¨˜", "éˆ·é‰§æ½­è¥¿å°ä¸˜è¨˜",
    "å°çŸ³åŸå±±è¨˜", "è³€é€²å£«ç‹åƒå…ƒå¤±ç«æ›¸", "å¾…æ¼é™¢è¨˜", "é»ƒå²¡ç«¹æ¨“è¨˜", "æ›¸æ´›é™½ååœ’è¨˜å¾Œ",
    "åš´å…ˆç”Ÿç¥ å ‚è¨˜", "å²³é™½æ¨“è¨˜", "è««é™¢é¡Œåè¨˜", "ç¾©ç”°è¨˜", "è¢å·å·å­¸è¨˜",
    "æœ‹é»¨è«–", "ç¸±å›šè«–", "é‡‹ç¥•æ¼”è©©é›†åº", "æ¢…è–ä¿è©©é›†åº", "é€æ¥Šå¯˜åº",
    "äº”ä»£å²ä¼¶å®˜å‚³åº", "äº”ä»£å²å®¦è€…å‚³è«–", "ç›¸å·æ™éŒ¦å ‚è¨˜", "è±æ¨‚äº­è¨˜", "é†‰ç¿äº­è¨˜",
    "ç§‹è²è³¦", "ç¥­çŸ³æ›¼å¿æ–‡", "ç€§å²¡é˜¡è¡¨", "ç®¡ä»²è«–", "è¾¨å¥¸è«–",
    "å¿ƒè¡“", "å¼µç›Šå·ç•«åƒè¨˜", "åˆ‘è³å¿ åšä¹‹è‡³è«–", "èŒƒå¢è«–", "ç•™ä¾¯è«–",
    "è³ˆèª¼è«–", "é¼‚éŒ¯è«–", "ä¸Šæ¢…ç›´è¬›æ›¸", "å–œé›¨äº­è¨˜", "å‡Œè™›è‡ºè¨˜",
    "è¶…ç„¶è‡ºè¨˜", "æ”¾é¶´äº­è¨˜", "çŸ³é˜å±±è¨˜", "æ½®å·éŸ“æ–‡å…¬å»Ÿç¢‘", "ä¹æ ¡æ­£é™¸è´„å¥è­°é€²å¾¡åŠ„å­",
    "å‰èµ¤å£è³¦", "å¾Œèµ¤å£è³¦", "ä¸‰æ§å ‚éŠ˜", "æ–¹å±±å­å‚³", "å…­åœ‹è«–",
    "ä¸Šæ¨å¯†éŸ“å¤ªå°‰æ›¸", "é»ƒå·å¿«å“‰äº­è¨˜", "å¯„æ­é™½èˆäººæ›¸", "è´ˆé»å®‰äºŒç”Ÿåº", "è®€å­Ÿå˜—å›å‚³",
    "åŒå­¸ä¸€é¦–åˆ¥å­å›º", "éŠè¤’ç¦ªå±±è¨˜", "æ³°å·æµ·é™µç¸£ä¸»ç°¿è¨±å›å¢“èªŒéŠ˜", "é€å¤©å°é™³åº­å­¸åº", "é–±æ±Ÿæ¨“è¨˜",
    "å¸é¦¬å­£ä¸»è«–åœ", "è³£æŸ‘è€…è¨€", "æ·±æ…®è«–", "è±«è®“è«–", "è¦ªæ”¿ç¯‡",
    "å°Šç¶“é–£è¨˜", "è±¡ç¥ è¨˜", "ç˜æ—…æ–‡", "ä¿¡é™µå›æ•‘è¶™è«–", "å ±åŠ‰ä¸€ä¸ˆæ›¸",
    "å³å±±åœ–è¨˜", "æ»„æµªäº­è¨˜", "é’éœå…ˆç”Ÿæ–‡é›†åº", "è—ºç›¸å¦‚å®Œç’§æ­¸è¶™è«–", "å¾æ–‡é•·å‚³",
    "äº”äººå¢“ç¢‘è¨˜"
];


		

        // ===============================================================
// === [ç¥æ€é€šç”¨çµ„ä»¶] æ¬Šé™æ””æˆªå™¨ & è«è˜­è¿ªæç¤ºçª— (å«ç™»å…¥é€£çµ) ===
// ===============================================================
(function() {
    // é˜²æ­¢é‡è¤‡æ³¨å…¥
    if (window.SansiInterceptorLoaded) return;
    window.SansiInterceptorLoaded = true;

    // --- 1. è‡ªå‹•æ³¨å…¥è«è˜­è¿ª CSS ---
    const style = document.createElement('style');
    style.textContent = `
        /* è«è˜­è¿ªé®ç½© */
        .sansi-limit-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(253, 252, 248, 0.88); /* ç±³ç™½é«˜æ¨¡ç³Š */
            backdrop-filter: blur(6px);
            z-index: 9999999; /* æœ€é«˜å±¤ç´š */
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .sansi-limit-show { opacity: 1; }

        /* è¦–çª—å¡ç‰‡ */
        .sansi-limit-card {
            background: #fdfcf8;
            border: 1px solid #e0ddd7;
            border-radius: 16px;
            padding: 30px 25px;
            width: 90%; max-width: 380px;
            box-shadow: 0 15px 40px rgba(141, 110, 99, 0.15);
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            font-family: 'Noto Serif TC', serif;
        }
        .sansi-limit-show .sansi-limit-card { transform: translateY(0); }

        /* åœ–ç¤ºèˆ‡æ–‡å­— */
        .sansi-limit-icon { font-size: 3rem; color: #d69a92; margin-bottom: 15px; } /* è±†æ²™ç´… */
        .sansi-limit-title { color: #5d4037; font-size: 1.4rem; font-weight: bold; margin: 0 0 10px 0; }
        .sansi-limit-desc { color: #888; font-size: 1rem; line-height: 1.6; margin-bottom: 25px; text-align: justify; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .sansi-btn-group { display: flex; gap: 12px; margin-top: 20px; }

        .sansi-limit-btn {
            border: none; padding: 10px 0; border-radius: 50px;
            font-size: 0.95rem; font-weight: bold; cursor: pointer;
            transition: all 0.2s; font-family: 'Noto Serif TC', serif;
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px;
            text-decoration: none;
        }

        /* ä¸»æŒ‰éˆ• (å‰å¾€ç™»å…¥) - è«è˜­è¿ªç¶  */
        .btn-primary { 
            background: #8fa398; color: white; 
            box-shadow: 0 4px 12px rgba(143, 163, 152, 0.4);
        }
        .btn-primary:hover { background-color: #7d9186; transform: translateY(-2px); }

        /* æ¬¡æŒ‰éˆ• (é—œé–‰) - æ·ºç° */
        .btn-secondary { 
            background: #f0f0f0; color: #777; 
        }
        .btn-secondary:hover { background-color: #e5e5e5; }
    `;
    document.head.appendChild(style);

    // --- 2. è‡ªå‹•æ³¨å…¥ HTML (å½ˆå‡ºè¦–çª—) ---
    const modalHTML = `
        <div id="sansiLimitModal" class="sansi-limit-overlay">
            <div class="sansi-limit-card">
                <div class="sansi-limit-icon">
                    <i class="fas fa-user-lock"></i>
                </div>
                <div class="sansi-limit-title">éœ€è¦ç™»å…¥</div>
                <div class="sansi-limit-desc">
                    è¨ªå®¢æ¯æ—¥é«”é©—é¡åº¦å·²è€—ç›¡ã€‚<br>
                    è«‹å‰å¾€ã€Œç¥æ€ã€ä¸»é ç™»å…¥å­¸æ ¡å¸³è™Ÿï¼Œå³å¯è§£é–ç„¡é™ä½¿ç”¨æ¬Šé™ã€‚
                </div>
                <div class="sansi-btn-group">
                    <button class="sansi-limit-btn btn-secondary" onclick="closeSansiLimitModal()">
                        ç¨å¾Œ
                    </button>
                    <!-- é»æ“Šç›´æ¥è·³è½‰è‡³ç¥æ€ä¸»é  -->
                    <button class="sansi-limit-btn btn-primary" onclick="window.location.href='https://kenchan20141.github.io/AIChinese/'">
                        <i class="fas fa-sign-in-alt"></i> å‰å¾€ç™»å…¥
                    </button>
                </div>
            </div>
        </div>
    `;
    const div = document.createElement('div');
    div.innerHTML = modalHTML;
    document.body.appendChild(div);

    // --- 3. å®šç¾©é—œé–‰è¦–çª—èˆ‡æ¸…ç†å‡½å¼ ---
    window.closeSansiLimitModal = function() {
        const modal = document.getElementById('sansiLimitModal');
        if (modal) {
            modal.classList.remove('sansi-limit-show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
            
            // è‡ªå‹•å˜—è©¦é—œé–‰å„ç¨®å·¥å…·çš„ Loading ç‹€æ…‹ï¼Œé˜²æ­¢ç•«é¢å¡æ­»
            if (typeof hideProgress === 'function') hideProgress(); // é¡Œå­³
            if (typeof hideLoading === 'function') hideLoading();   // ç¿»æ°´/å¯«ä½œ
            
            // å¦‚æœæŒ‰éˆ•è¢«ç¦ç”¨ï¼Œå˜—è©¦è§£é– (é‡å°é€šç”¨æŒ‰éˆ• class)
            const disabledBtns = document.querySelectorAll('button:disabled');
            disabledBtns.forEach(btn => btn.disabled = false);
        }
    };

    // --- 4. æ””æˆªå™¨æ ¸å¿ƒé‚è¼¯ ---
    const originalFetch = window.fetch;
    
    window.fetch = async function(url, options) {
        // åƒ…æ””æˆª AI è«‹æ±‚
        if (typeof url === 'string' && url.includes('pollinations.ai')) {
            
            // A. å³æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹ (æ¯æ¬¡è«‹æ±‚éƒ½æœƒé‡æ–°è®€å–ï¼Œé˜²æ­¢ç™»å‡ºå¾Œä»èƒ½ä½¿ç”¨)
            const s = localStorage.getItem('studentProfile');
            
            if (s) {
                // å·²ç™»å…¥ï¼šæ”¾è¡Œ
                return originalFetch(url, options);
            }

            // B. æœªç™»å…¥ï¼šæª¢æŸ¥é¡åº¦
            const today = new Date().toLocaleDateString('zh-HK');
            const toolName = document.title || "UnknownTool"; 
            const storageKey = `sansi_guest_usage_${toolName}_${today}`;
            
            let currentCount = parseInt(localStorage.getItem(storageKey) || "0");

            // C. è¶…éé¡åº¦ -> é˜»æ“‹ä¸¦å½ˆçª—
            if (currentCount >= 1) {
                // é¡¯ç¤ºè¦–çª—
                const modal = document.getElementById('sansiLimitModal');
                modal.style.display = 'flex';
                // å¼·åˆ¶é‡ç¹ªä»¥è§¸ç™¼éæ¸¡å‹•ç•«
                void modal.offsetWidth; 
                modal.classList.add('sansi-limit-show');

                // å›å‚³éŒ¯èª¤ä»¥ä¸­æ–·åŸæœ¬ç¨‹å¼çš„åŸ·è¡Œ
                return Promise.reject(new Error("Guest Limit Exceeded"));
            }

            // D. æœªè¶…é -> è¨˜éŒ„ä¸¦æ”¾è¡Œ
            localStorage.setItem(storageKey, currentCount + 1);
            console.log(`[è¨ªå®¢] ${toolName} ä½¿ç”¨ç¬¬ ${currentCount + 1} æ¬¡`);
        }

        return originalFetch(url, options);
    };
    
    console.log("âœ… ç¥æ€é€šç”¨æ¬Šé™é– (å«ç™»å…¥é€£çµ) å·²å•Ÿå‹•");
})();
</script>




	
<!-- ======================================================= -->
<!-- 1. Firebase SDK èˆ‡ åˆå§‹åŒ– (ä¿®æ­£ç‰ˆï¼šé˜²æ­¢è‡ªå‹•ç™»å‡º) -->
<!-- ======================================================= -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBgwrgn2m343mRJb0WjzUhteiospegXhvI",
    authDomain: "sansidata.firebaseapp.com",
    projectId: "sansidata",
    storageBucket: "sansidata.firebasestorage.app",
    messagingSenderId: "580288358575",
    appId: "1:580288358575:web:35dcf4e79bcef530de4c5a",
    databaseURL: "https://sansidata-default-rtdb.firebaseio.com"
  };

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  
  var database = firebase.database();
  var auth = firebase.auth();

  // ä¿æŒç™»å…¥ç‹€æ…‹æŒä¹…åŒ–
  document.addEventListener('DOMContentLoaded', function() {
      if (auth) {
          auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
              auth.onAuthStateChanged(async (user) => {
                  const s = JSON.parse(localStorage.getItem('studentProfile'));
                  
                  if (user) {
                      console.log("[WenShu] Firebase å·²é€£ç·š:", user.email);
                      // å¦‚æœæœ¬åœ°æ²’è³‡æ–™ä½†é›²ç«¯æœ‰ï¼Œå˜—è©¦åŒæ­¥ (é¸ç”¨)
                      if (!s) {
                          try {
                              const emailKey = btoa(user.email);
                              const snapshot = await database.ref('email_mapping/' + emailKey).once('value');
                              if (snapshot.val()) localStorage.setItem('studentProfile', JSON.stringify(snapshot.val()));
                          } catch (e) {}
                      }
                  } else {
                      // â˜…â˜…â˜… ä¿®æ­£é‡é»ï¼šé€™è£¡ä»€éº¼éƒ½ä¸è¦åšï¼ â˜…â˜…â˜…
                      // å³ä½¿ user æ˜¯ nullï¼Œä¹Ÿä¸è¦åˆªé™¤ studentProfile
                      // å› ç‚ºé€™å¯èƒ½æ˜¯é é¢å‰›è¼‰å…¥ï¼ŒFirebase é‚„åœ¨é€£ç·šä¸­
                      console.log("[WenShu] ç­‰å¾… Firebase é©—è­‰æˆ–è¨ªå®¢æ¨¡å¼...");
                  }
              });
          });
      }
  });
</script>


<!-- === [é‚„åŸç‰ˆ] ç¥æ€å¤§æ•¸æ“šæ”¶é›†æ¨¡çµ„ (30ç§’=1åˆ†é˜é‚è¼¯) === -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let totalSeconds = 0;
    let timerInterval = null;

    // 1. ç²å–æ—¥æœŸè·¯å¾‘
    function getDateParts() {
        const now = new Date();
        const y = String(now.getFullYear());
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return { y, m, d };
    }

    // 2. ç²å–èº«ä»½
    function getIdentity() {
        const rawProfile = localStorage.getItem('studentProfile');
        let s = null;
        try { if(rawProfile) s = JSON.parse(rawProfile); } catch (e) {}

        if (s && s.grade && s.class) {
            const safeName = s.name.replace(/[.#$/[\]]/g, '_'); 
            return { type: 'student', id: s.uid || `stu_${s.grade}${s.class}_${safeName}`, grade: s.grade, class: s.class };
        } else {
            let guestID = localStorage.getItem('sansi_guest_uuid');
            if (!guestID) {
                guestID = 'guest_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('sansi_guest_uuid', guestID);
            }
            return { type: 'guest', id: guestID, grade: 'Guest', class: 'Visitor' };
        }
    }

// === 3. è¨˜éŒ„è¨ªå• (Log Visit) - é«˜æ•ˆåˆ†æµç‰ˆ ===
// === 3. è¨˜éŒ„è¨ªå• (Log Visit) - é«˜æ•ˆåˆ†æµç‰ˆ (å« stats_school é‚è¼¯) ===
async function logVisitOnce() {
    if (typeof firebase === 'undefined' || !database) return;
    
    const { y, m, d } = getDateParts();
    const identity = getIdentity();
    const uid = identity.id;

    // Session é–
    const sessionKey = `sansi_visit_logged_${y}${m}${d}_${uid}`;
    if (sessionStorage.getItem(sessionKey)) return; 

    // æª¢æŸ¥ Tracking (åˆ¤æ–·æ˜¯å¦ç‚ºä»Šæ—¥é¦–æ¬¡)
    const trackingRef = database.ref(`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`);
    
    try {
        const snap = await trackingRef.once('value');
        const isFirstTimeToday = !snap.exists();

        const updates = {};
        const increment1 = firebase.database.ServerValue.increment(1);
        
        // 1. å…¨æ ¡ç¸½è¦½è·¯å¾‘ (å«è¨ªå®¢) - stats_global
        const globalPath = `stats_global/${y}/${m}/${d}`;
        updates[`${globalPath}/visits`] = increment1;

        // â˜…â˜…â˜… æ–°å¢ï¼šç´”å­¸æ ¡è·¯å¾‘ (åƒ…å­¸ç”Ÿ) - stats_school â˜…â˜…â˜…
        const schoolPath = `stats_school/${y}/${m}/${d}`;

        if (identity.type === 'student') {
            const classKey = `${identity.grade}${identity.class}`;
            const studentKey = identity.id.split('_').pop(); // åå­—

            // å­¸ç”ŸåŒæ™‚å¯«å…¥ stats_school
            updates[`${schoolPath}/visits`] = increment1;

            // 2. ç­ç´šè·¯å¾‘ (stats_classes/6A/YYYY/MM/DD)
            const classPath = `stats_classes/${classKey}/${y}/${m}/${d}`;
            updates[`${classPath}/visits`] = increment1;

            // 3. å­¸ç”Ÿè·¯å¾‘ (stats_students/6A/é™³å¤§æ–‡/YYYY/MM/DD)
            const studentPath = `stats_students/${classKey}/${studentKey}/${y}/${m}/${d}`;
            updates[`${studentPath}/visits`] = increment1;

            if (isFirstTimeToday) {
                updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                
                // æ›´æ–° global unique
                updates[`${globalPath}/unique`] = increment1;
                
                // â˜… æ›´æ–° school unique (åƒ…å­¸ç”Ÿ)
                updates[`${schoolPath}/unique`] = increment1;
                
                // æ›´æ–° class unique
                updates[`${classPath}/unique`] = increment1;
            }
        } else {
            // è¨ªå®¢ (åªå¯«å…¥ globalï¼Œä¸å¯«å…¥ school)
            if (isFirstTimeToday) {
                updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                updates[`${globalPath}/unique`] = increment1;
            }
        }

        await database.ref().update(updates);
        sessionStorage.setItem(sessionKey, 'true');
        console.log("ğŸ“ [Stats] è¨ªå•è¨ˆæ•¸å·²åˆ†æµä¸Šå‚³ (å« stats_school)");

    } catch (e) {
        console.error("Stats Error:", e);
    }
}

// 4. ä¸Šå‚³ 1 åˆ†é˜ (åˆ†æµç‰ˆ - é™¤éŒ¯æ¨¡å¼)
function uploadOneMinute() {
    if (typeof firebase === 'undefined' || !database) return;
    
    logVisitOnce(); 

    const { y, m, d } = getDateParts();
    const identity = getIdentity();
    
    // ç²å–å­¸ç”Ÿåç¨± Key (é˜²å‘†)
    const studentKey = identity.id.includes('_') ? identity.id.split('_').pop() : identity.name; 
    
    const updates = {};
    const increment60 = firebase.database.ServerValue.increment(60);

    // 1. å…¨åŸŸ (Global)
    updates[`stats_global/${y}/${m}/${d}/duration`] = increment60;

    // â˜…â˜…â˜… 2. å­¸ç”Ÿèº«ä»½åˆ¤æ–· â˜…â˜…â˜…
    if (identity.type === 'student') {
        const classKey = `${identity.grade}${identity.class}`;

        // Path A: å…¨æ ¡ (é€™æ˜¯æ‚¨ç¼ºå°‘çš„)
        const pathSchool = `stats_school/${y}/${m}/${d}/duration`;
        updates[pathSchool] = increment60;

        // Path B: ç­ç´š
        const pathClass = `stats_classes/${classKey}/${y}/${m}/${d}/duration`;
        updates[pathClass] = increment60;
        
        // Path C: å€‹äºº
        const pathStudent = `stats_students/${classKey}/${studentKey}/${y}/${m}/${d}/duration`;
        updates[pathStudent] = increment60;

        // â˜… é™¤éŒ¯è¨Šæ¯ï¼šè«‹åœ¨ F12 Console æŸ¥çœ‹æ˜¯å¦å‡ºç¾æ­¤è¡Œ â˜…
        console.log(`[Stats] æ­£åœ¨ä¸Šå‚³æ™‚é•·... ç›®æ¨™åŒ…å«: ${pathSchool}`);
    } else {
        console.log("[Stats] ç•¶å‰ç‚ºè¨ªå®¢èº«ä»½ï¼Œä¸å¯«å…¥ stats_school");
    }

    database.ref().update(updates)
        .then(() => console.log("âœ… [Stats] æ™‚é•·ä¸Šå‚³æˆåŠŸ"))
        .catch(e => console.error("âŒ [Stats] ä¸Šå‚³å¤±æ•— (è«‹æª¢æŸ¥ Rules):", e));
}

    // 5. è¨ˆæ™‚å™¨å•Ÿå‹• (é‚„åŸä½ çš„é‚è¼¯)
    function startTimer() {
        if (timerInterval) return;
        console.log("â–¶ï¸ [Stats] è¨ˆæ™‚å™¨å•Ÿå‹•");
        
        timerInterval = setInterval(() => {
            totalSeconds++;
            
            // â˜…â˜…â˜… ä½ çš„åŸå§‹é‚è¼¯ â˜…â˜…â˜…
            // 30ç§’ -> å‚³é€ (ç®—1åˆ†é˜)
            // 90ç§’ (1åˆ†30ç§’) -> å‚³é€ (ç®—2åˆ†é˜)
            // 150ç§’ (2åˆ†30ç§’) -> å‚³é€ (ç®—3åˆ†é˜)
            if (totalSeconds === 30 || (totalSeconds > 30 && (totalSeconds - 30) % 60 === 0)) {
                uploadOneMinute();
            }
        }, 1000);
    }

    function pauseTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            console.log("â¸ï¸ [Stats] æš«åœè¨ˆæ™‚ (ç•¶å‰ç´¯è¨ˆ: " + totalSeconds + "s)");
            // æ³¨æ„ï¼šé€™è£¡ä¸å†æœ‰ uploadDuration(unsaved)ï¼Œæœªæ»¿çš„éƒ¨åˆ†ç›´æ¥æ¨æ£„
        }
    }

    // å»¶é²å•Ÿå‹•
    setTimeout(() => {
        logVisitOnce();
        startTimer();
    }, 3000);

    // åµæ¸¬é é¢ç‹€æ…‹
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') pauseTimer();
        else startTimer();
    });
    
    window.forceLogVisit = logVisitOnce;
});
</script>

	<script>



// â˜…â˜…â˜…â˜…â˜… è«‹å°‡ä»£ç¢¼è²¼åœ¨é€™è£¡ (åŸæœ¬çš„å…§å®¹ä¹‹ä¸‹ï¼Œscript çµæŸæ¨™ç±¤ä¹‹ä¸Š) â˜…â˜…â˜…â˜…â˜…

    // =======================================================
    // === [æ–°å¢] åœ¨ç·šç‹€æ…‹è‡ªå‹•å ±åˆ°ç³»çµ± (Presence System) ===
    // =======================================================
    function initPresenceSystem() {
        // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿ Firebase å·²åˆå§‹åŒ–ä¸”æœ¬åœ°å­˜å„²å·²è®€å–
        setTimeout(() => {
            if (typeof database === 'undefined') return;

            // 1. ç›£è½é€£ç·šç‹€æ…‹
            const connectedRef = database.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    // === é€£ç·šæˆåŠŸï¼Œæº–å‚™è³‡æ–™ ===
                    
                    // ç²å–ç”¨æˆ¶è³‡æ–™
                    const s = JSON.parse(localStorage.getItem('studentProfile'));
                    let myUid = "";
                    let userData = {};

                    // A. åˆ¤æ–·èº«åˆ†
                    if (s && s.name) {
                        // --- å·²ç™»å…¥ç”¨æˆ¶ (å­¸ç”Ÿ/è€å¸«/ç‰¹è¨±) ---
                        const user = firebase.auth().currentUser;
                        myUid = user ? user.uid : `stu_${s.grade}${s.class}_${s.name}`;
                        
                        // æº–å‚™å¯«å…¥çš„è³‡æ–™
                        userData = {
                            name: s.name,
                            grade: s.grade,
                            class: s.class,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            device: /Mobile|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
                        };
                    } else {
                        // --- è¨ªå®¢ ---
                        let guestId = localStorage.getItem('sansi_guest_uuid');
                        if (!guestId) {
                            guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
                            localStorage.setItem('sansi_guest_uuid', guestId);
                        }
                        myUid = guestId;

                        userData = {
                            name: "è¨ªå®¢",
                            grade: "Guest",
                            class: "Visitor",
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        };
                    }

                    // B. åŸ·è¡Œ Firebase å‹•ä½œ
                    const myPresenceRef = database.ref(`online_users/${myUid}`);

                    // é—œéµæŒ‡ä»¤ï¼šç•¶å®¢æˆ¶ç«¯æ–·ç·šæ™‚ï¼Œè‡ªå‹•åˆªé™¤é€™ç­†è³‡æ–™
                    myPresenceRef.onDisconnect().remove().then(() => {
                        // æ–·ç·šæŒ‡ä»¤è¨­å®šæˆåŠŸå¾Œï¼Œå¯«å…¥ç•¶å‰ç‹€æ…‹
                        myPresenceRef.set(userData);
                    });
                }
            });
        }, 2000); // å»¶é² 2 ç§’å•Ÿå‹•
    }

    // å•Ÿå‹•å ±åˆ°ç³»çµ±
    document.addEventListener('DOMContentLoaded', initPresenceSystem);



	
</script>
	
	
</body>
</html>
